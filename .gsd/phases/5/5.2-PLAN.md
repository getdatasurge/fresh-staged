---
phase: 5
plan: 2
wave: 2
---

# Plan 5.2: Address Remaining Supabase Calls in Specialized Functionality

## Objective

Identify and address the remaining 79 Supabase calls in specialized functionality that haven't been refactored yet.

## Context

The remaining Supabase calls are primarily in:

- TTN (The Things Network) integration hooks
- Dashboard layout system
- Health check system
- Soft delete functionality

## Tasks

<task type="auto">
  <name>Review and document remaining Supabase calls</name>
  <files>src/hooks/useTTN*.ts, src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts, src/lib/health/healthChecks.ts, src/hooks/useSoftDelete.ts</files>
  <action>
    Document all remaining Supabase calls:
    1. For each file, list the Supabase operations being used
    2. Identify if they should be refactored to tRPC or if they're temporary
    3. Determine the priority for each
  </action>
  <verify>
    Create a comprehensive list of remaining Supabase calls
    with their locations and purposes
  </verify>
  <done>All remaining Supabase calls documented.</done>
</task>

<task type="auto">
  <name>Refactor high-priority TTN integration calls</name>
  <files>src/hooks/useTTNDeprovision.ts, src/hooks/useTTNWebhook.ts, src/hooks/useTTNOperations.ts</files>
  <action>
    Refactor high-priority TTN integration calls to tRPC:
    1. Identify which operations should be moved to backend procedures
    2. Create new tRPC routers or add to existing ones
    3. Update frontend hooks to use tRPC instead of direct Supabase calls
  </action>
  <verify>
    Run TTN integration tests and verify functionality
  </verify>
  <done>High-priority TTN integration calls refactored to tRPC.</done>
</task>

<task type="auto">
  <name>Refactor dashboard layout system calls</name>
  <files>src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts, src/lib/observability/widgetHealthMetrics.ts</files>
  <action>
    Refactor dashboard layout system calls to tRPC:
    1. Create procedures for managing entity dashboard layouts
    2. Refactor widget health metrics tracking
    3. Update frontend hooks to use tRPC
  </action>
  <verify>
    Verify dashboard customization and widget functionality
  </verify>
  <done>Dashboard layout system calls refactored to tRPC.</done>
</task>

<task type="auto">
  <name>Refactor health check system calls</name>
  <files>src/lib/health/healthChecks.ts</files>
  <action>
    Refactor health check system calls to tRPC:
    1. Create procedures for health check operations
    2. Update health check logic to use tRPC
    3. Ensure health check functionality works correctly
  </action>
  <verify>
    Run health check tests and verify system health monitoring
  </verify>
  <done>Health check system calls refactored to tRPC.</done>
</task>

<task type="auto">
  <name>Refactor soft delete functionality calls</name>
  <files>src/hooks/useSoftDelete.ts</files>
  <action>
    Refactor soft delete functionality calls to tRPC:
    1. Create procedures for soft delete operations
    2. Update frontend hook to use tRPC
    3. Verify soft delete functionality works correctly
  </action>
  <verify>
    Test soft delete functionality for all entity types
  </verify>
  <done>Soft delete functionality calls refactored to tRPC.</done>
</task>

## Success Criteria

- [ ] All remaining Supabase calls are documented
- [ ] High-priority calls are refactored to tRPC
- [ ] All specialized functionality works correctly with tRPC
- [ ] Project builds without errors
- [ ] All tests pass

## Notes

- Some calls may be temporary and marked as "TEMPORARY" in comments
- Prioritize calls based on usage frequency and importance
- Ensure backward compatibility when refactoring
