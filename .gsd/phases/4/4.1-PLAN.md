---
phase: 4
plan: 1
wave: 1
---

# Plan 4.1: Backend Admin Procedures

## Objective
Add tRPC procedures to support platform administration views. These procedures will be used by Super Admins to manage organizations and users across the entire platform.

## Context
- `.gsd/SPEC.md`
- `backend/src/routers/admin.router.ts`
- `backend/src/db/schema/tenancy.ts`
- `backend/src/db/schema/users.ts`

## Tasks

<task type="auto">
  <name>Add listOrganizations procedure</name>
  <files>backend/src/routers/admin.router.ts</files>
  <action>
    Add a new `listOrganizations` procedure to `adminRouter`.
    It should return a list of organizations with:
    - id, name, slug, timezone, complianceMode, createdAt
    - userCount (count from user_roles)
    - siteCount (count from sites)
    Use a left join on `user_roles` and `sites` with grouping to get counts, or use a separate subquery if needed.
    Ensure it filters out deleted organizations (`deleted_at IS NULL`).
  </action>
  <verify>Check backend build and verify procedure exists in appRouter.</verify>
  <done>listOrganizations procedure implemented and returns expected data structure.</done>
</task>

<task type="auto">
  <name>Add listUsers procedure</name>
  <files>backend/src/routers/admin.router.ts</files>
  <action>
    Add a new `listUsers` procedure to `adminRouter`.
    It should return a list of users with:
    - userId, email, fullName, phone, organizationId, createdAt (from profiles)
    - organizationName (joined from organizations)
    - role (from user_roles)
    - isSuperAdmin (boolean, check platform_roles for 'SUPER_ADMIN')
    Use left joins to gather all information in a single query if possible.
  </action>
  <verify>Check backend build and verify procedure exists in appRouter.</verify>
  <done>listUsers procedure implemented and returns expected data structure.</done>
</task>

## Success Criteria
- [ ] `admin.listOrganizations` returns organizations with member and site counts.
- [ ] `admin.listUsers` returns users with their organization context and roles.
- [ ] Backend builds without errors.
