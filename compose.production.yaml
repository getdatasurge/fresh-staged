# FreshTrack Pro Production Overrides
# Usage: docker compose -f docker-compose.yml -f compose.production.yaml up -d
#
# This file layers production-specific configuration over the base docker-compose.yml:
# - Resource limits and reservations
# - Production build targets
# - File-based secrets
# - Health checks
# - Restart policies
# - Security hardening

services:
  # ===========================================
  # Backend API
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    volumes: []  # Remove dev hot-reload volumes
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: 3000
      HOST: 0.0.0.0
      # Database connection - password injected from secret file
      DATABASE_URL: postgresql://frostguard:${POSTGRES_PASSWORD}@postgres:5432/frostguard
      REDIS_URL: redis://redis:6379
      # Stack Auth config - REQUIRED: set in .env.production
      STACK_AUTH_PROJECT_ID: ${STACK_AUTH_PROJECT_ID:?STACK_AUTH_PROJECT_ID is required}
      STACK_AUTH_PUBLISHABLE_KEY: ${STACK_AUTH_PUBLISHABLE_KEY:?STACK_AUTH_PUBLISHABLE_KEY is required}
      # Optional external services (gracefully disabled if not set)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-noreply@freshtrackpro.com}
      TELNYX_API_KEY: ${TELNYX_API_KEY:-}
      TELNYX_PHONE_NUMBER: ${TELNYX_PHONE_NUMBER:-}
      TELNYX_MESSAGING_PROFILE_ID: ${TELNYX_MESSAGING_PROFILE_ID:-}
      TTN_API_URL: ${TTN_API_URL:-}
      TTN_APPLICATION_ID: ${TTN_APPLICATION_ID:-}
      TTN_API_KEY: ${TTN_API_KEY:-}
      # MinIO credentials (from secrets)
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-}
      MINIO_BUCKET_ASSETS: ${MINIO_BUCKET_ASSETS:-assets}
      # URLs
      FRONTEND_URL: ${FRONTEND_URL:-https://app.freshtrackpro.com}
      APP_URL: ${APP_URL:-https://app.freshtrackpro.com}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://app.freshtrackpro.com}
      # Monitoring
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_ENVIRONMENT: production
    ports:
      - "127.0.0.1:3000:3000"  # Bind localhost only (reverse proxy handles external access)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    secrets:
      - postgres_password
      - jwt_secret
      - stack_auth_secret
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    ports: []  # Remove external port exposure in production (internal network only)
    environment:
      # Override dev password with production password
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # ===========================================
  # Redis Cache
  # ===========================================
  redis:
    ports: []  # Remove external port exposure in production (internal network only)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # ===========================================
  # MinIO Object Storage
  # ===========================================
  minio:
    ports:
      - "127.0.0.1:9000:9000"  # Bind localhost only, accessed via backend only
      # Console port (9001) removed in production for security
    environment:
      # Use file-based secrets instead of plain env vars
      MINIO_ROOT_USER_FILE: /run/secrets/minio_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_password
    secrets:
      - minio_user
      - minio_password
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  # ===========================================
  # MinIO Setup (one-time initialization)
  # ===========================================
  minio-setup:
    # Inherits from base - no production changes needed
    # This service exits after bucket creation, no resource limits needed
    restart: "no"

  # ===========================================
  # Background Job Worker
  # ===========================================
  worker:
    environment:
      NODE_ENV: production
      REDIS_URL: redis://redis:6379
      DATABASE_URL: postgresql://frostguard:${POSTGRES_PASSWORD}@postgres:5432/frostguard
      # Email service for digest jobs
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-noreply@freshtrackpro.com}
      APP_URL: ${APP_URL:-https://app.freshtrackpro.com}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # ===========================================
  # Uptime Kuma Status Page
  # ===========================================
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: frostguard-uptime-kuma
    volumes:
      - uptime_kuma_data:/app/data
    ports:
      - "127.0.0.1:3002:3001"  # Bind localhost only (Caddy reverse proxy handles external access)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # ===========================================
  # Observability Stack
  # ===========================================
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: frostguard-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.0
    container_name: frostguard-loki
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./docker/loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    ports:
      - "127.0.0.1:3100:3100"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.0
    container_name: frostguard-promtail
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./docker/promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.0
    container_name: frostguard-grafana
    environment:
      # IMPORTANT: Set GF_SECURITY_ADMIN_PASSWORD in .env.production
      # Grafana cannot use file-based secrets directly (runs as non-root)
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:?GF_SECURITY_ADMIN_PASSWORD is required}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${MONITORING_URL:-https://monitoring.freshtrackpro.com}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SECURITY_DISABLE_GRAVATAR: "true"
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "127.0.0.1:3001:3000"
    depends_on:
      - prometheus
      - loki
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.6.0
    container_name: frostguard-node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "127.0.0.1:9100:9100"
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    restart: unless-stopped

  # ===========================================
  # Blackbox Exporter (SSL/HTTP Probing)
  # ===========================================
  blackbox:
    image: prom/blackbox-exporter:v0.24.0
    container_name: frostguard-blackbox
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./docker/blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    ports:
      - "127.0.0.1:9115:9115"
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9115/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================
  # Caddy Reverse Proxy (HTTPS Termination)
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: frostguard-caddy
    environment:
      DOMAIN: ${DOMAIN:-localhost}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@freshtrackpro.com}
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:2019/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# ===========================================
# Volumes
# ===========================================
volumes:
  uptime_kuma_data:
    driver: local
  prometheus_data:
    name: frostguard_prometheus_data
  loki_data:
    name: frostguard_loki_data
  grafana_data:
    name: frostguard_grafana_data
  caddy_data:
    name: frostguard_caddy_data
  caddy_config:
    name: frostguard_caddy_config

# ===========================================
# Secrets (file-based)
# ===========================================
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  stack_auth_secret:
    file: ./secrets/stack_auth_secret.txt
  minio_user:
    file: ./secrets/minio_user.txt
  minio_password:
    file: ./secrets/minio_password.txt
  grafana_password:
    file: ./secrets/grafana_password.txt

# ===========================================
# Production excludes admin tools
# ===========================================
# pgadmin and redis-commander are in the "admin" profile
# and won't run in production unless explicitly enabled
