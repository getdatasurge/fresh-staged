# ServiceWorker Registration Analysis: Self-Signed SSL Failure

Generated: 2026-01-29

## Summary

The ServiceWorker registration is handled automatically by the `vite-plugin-pwa` package. The registration code has NO error handling, which causes the uncaught promise rejection when running on self-signed SSL certificates. The registration happens in a generated file that cannot be easily customized.

---

## ServiceWorker Registration Location

**File:** `/dist/registerSW.js` (auto-generated by vite-plugin-pwa)

**Code:**

```javascript
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js', { scope: '/' });
  });
}
```

**Problems:**

1. No `.catch()` handler on the promise
2. No error handling for SSL failures
3. File is auto-generated - changes would be overwritten on build
4. Loaded via `<script>` tag in index.html, not imported in application code

---

## How It's Loaded

**File:** `/dist/index.html`

```html
<script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script>
```

The script is automatically injected by the vite-plugin-pwa plugin during build.

---

## PWA Configuration

**File:** `vite.config.ts`

```typescript
VitePWA({
  registerType: 'autoUpdate',
  includeAssets: ['favicon.ico', 'robots.txt', 'icon.svg'],
  manifest: {
    /* ... */
  },
  workbox: {
    /* ... */
  },
});
```

**Key Setting:** `registerType: "autoUpdate"`

This setting controls how the ServiceWorker is registered. Current value causes automatic registration with no error handling.

---

## Current Error

**Browser Console:**

```
Uncaught (in promise) DOMException: Failed to register a ServiceWorker for scope
('https://localhost:8080/') with script ('https://localhost:8080/sw.js'):
An SSL certificate error occurred when fetching the script.
```

**Cause:** ServiceWorkers require HTTPS with valid certificates. Self-signed certificates are rejected.

---

## Solutions

### Option 1: Disable ServiceWorker Registration (Simplest)

**Modify:** `vite.config.ts`

```typescript
VitePWA({
  registerType: 'autoUpdate',
  injectRegister: false, // ← Add this line
  // ... rest of config
});
```

This prevents vite-plugin-pwa from injecting the registration script entirely.

**Pros:**

- Simple one-line change
- No runtime overhead
- Works for development with self-signed certs

**Cons:**

- No PWA functionality in development
- Must remember to remove for production

---

### Option 2: Custom Registration with Error Handling

**Modify:** `vite.config.ts`

```typescript
VitePWA({
  registerType: false, // ← Disable auto-registration
  injectRegister: false,
  // ... rest of config
});
```

**Add:** `src/registerServiceWorker.ts`

```typescript
export function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/sw.js', { scope: '/' })
        .then((registration) => {
          console.log('SW registered:', registration);
        })
        .catch((error) => {
          // Gracefully handle SSL errors in development
          if (error.message?.includes('SSL certificate error')) {
            console.warn('ServiceWorker not registered: Self-signed certificate detected');
          } else {
            console.error('SW registration failed:', error);
          }
        });
    });
  }
}
```

**Import in:** `src/main.tsx`

```typescript
import { createRoot } from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import { registerServiceWorker } from "./registerServiceWorker";

// Only register in production or with valid SSL
if (import.meta.env.PROD || window.location.protocol === 'http:') {
  registerServiceWorker();
}

createRoot(document.getElementById("root")!).render(<App />);
```

**Pros:**

- Full control over registration
- Proper error handling
- Can conditionally register based on environment
- Works for both dev and prod

**Cons:**

- More code to maintain
- Need to handle ServiceWorker updates manually

---

### Option 3: Environment-Based Registration

**Modify:** `vite.config.ts`

```typescript
export default defineConfig(({ mode }) => ({
  plugins: [
    react(),
    mode === 'development' && componentTagger(),
    mode === 'production' &&
      VitePWA({
        /* config */
      }), // ← Only in production
  ].filter(Boolean),
  // ... rest of config
}));
```

**Pros:**

- No ServiceWorker in development at all
- Clean separation of concerns
- No runtime errors

**Cons:**

- Can't test PWA features in development
- Different behavior between dev and prod

---

## Recommended Solution

**For immediate fix:** Use Option 1 (disable with `injectRegister: false`)

**For production-ready solution:** Use Option 2 (custom registration with error handling)

**Rationale:**

- Option 2 provides the most flexibility
- Allows testing PWA features in development with valid certs
- Gracefully degrades with self-signed certs
- Production-ready error handling

---

## Implementation Steps

1. **Disable auto-registration** in `vite.config.ts`:

   ```typescript
   VitePWA({
     registerType: false,
     injectRegister: false,
     // ... rest
   });
   ```

2. **Create** `src/registerServiceWorker.ts` with error handling

3. **Import and conditionally call** in `src/main.tsx`

4. **Test** with both self-signed and valid certificates

5. **Rebuild** to generate new dist files without auto-injected script

---

## Related Files

| File                 | Purpose                               | Can Modify       |
| -------------------- | ------------------------------------- | ---------------- |
| `vite.config.ts`     | PWA plugin configuration              | YES              |
| `dist/registerSW.js` | Auto-generated registration (current) | NO (overwritten) |
| `dist/sw.js`         | ServiceWorker script                  | NO (overwritten) |
| `src/main.tsx`       | Application entry point               | YES              |
| `index.html`         | HTML template                         | YES              |

---

## Testing Checklist

After implementing fix:

- [ ] Development with self-signed cert: No console errors
- [ ] Development with valid cert: SW registers successfully
- [ ] Production build: SW registers and updates
- [ ] Offline functionality works (if enabled)
- [ ] No uncaught promise rejections in any environment
