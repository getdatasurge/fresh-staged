---
phase: 07-production-deployment-cutover
plan: 06
type: execute
wave: 3
depends_on: ['07-01', '07-02', '07-03', '07-04', '07-05']
files_modified: []
autonomous: false

must_haves:
  truths:
    - 'Staging rehearsal validates complete cutover procedure'
    - 'All production services start and pass health checks'
    - 'User can log in and see migrated data'
    - 'Sensor data flows from TTN to new system'
  artifacts: []
  key_links: []
---

<objective>
Execute staging rehearsal and production cutover with human verification checkpoints.

Purpose: Validate the complete cutover procedure on staging before production, then execute production cutover with verification.
Output: Successfully running production system serving live traffic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-production-deployment-cutover/07-CONTEXT.md
@docs/CUTOVER_CHECKLIST.md
@docs/PRODUCTION_DEPLOYMENT.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 1: Staging Rehearsal Complete</name>
  <what-built>
Complete production infrastructure:
- compose.production.yaml with resource limits, secrets, health checks
- Backend Dockerfile with multi-stage build
- Caddy reverse proxy with auto-HTTPS
- Observability stack (Prometheus, Loki, Grafana)
- Deployment and rollback scripts
- Uptime Kuma status page
- Complete documentation (cutover checklist, user notice, deployment guide)
  </what-built>
  <how-to-verify>
**Before production cutover, complete a full staging rehearsal:**

1. **Deploy to staging environment:**

   ```bash
   # On staging server
   ./scripts/health-check.sh
   ./scripts/deploy.sh
   ```

2. **Verify all services running:**

   ```bash
   docker compose -f docker-compose.yml -f compose.production.yaml ps
   # All services should show "healthy" or "running"
   ```

3. **Test health endpoints:**

   ```bash
   curl http://localhost:3000/health
   # Should return JSON with status: "healthy"
   ```

4. **Verify observability:**
   - Access Grafana at http://localhost:3001
   - Login with admin / (secret from secrets/grafana_password.txt)
   - Check "FreshTrack Overview" dashboard loads
   - Verify metrics from Prometheus
   - Verify logs from Loki

5. **Run migration with test data:**

   ```bash
   # Export from Supabase (test/staging project)
   pnpm --prefix scripts/migration run export --dry-run

   # Import to staging
   pnpm --prefix scripts/migration run import --dry-run
   ```

6. **Test rollback procedure:**

   ```bash
   ./scripts/rollback.sh --yes
   # Verify it exports data and stops services
   ```

7. **Re-deploy after rollback test:**
   ```bash
   ./scripts/deploy.sh
   ```

**Staging rehearsal checklist:**

- [ ] All services start successfully
- [ ] Health checks pass
- [ ] Grafana dashboards work
- [ ] Migration scripts run without errors
- [ ] Rollback script works correctly
- [ ] Frontend accessible (if deployed)
      </how-to-verify>
      <resume-signal>Type "staging-verified" when staging rehearsal is complete and successful</resume-signal>
      </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 2: Pre-Production Readiness</name>
  <what-built>Staging rehearsal complete, ready for production deployment.</what-built>
  <how-to-verify>
**Verify production readiness:**

1. **Production infrastructure provisioned:**
   - [ ] DigitalOcean Droplet (or equivalent) running
   - [ ] Managed PostgreSQL accessible
   - [ ] Domain DNS configured (TTL lowered 48h ago)
   - [ ] SSL certificates will auto-provision via Caddy

2. **Secrets prepared:**
   - [ ] All secrets in `secrets/` directory
   - [ ] Stack Auth credentials configured
   - [ ] Managed database connection string ready

3. **Communication sent:**
   - [ ] User notice sent 24-48 hours before cutover
   - [ ] Support team notified
   - [ ] Status page ready

4. **Cutover checklist reviewed:**
   - [ ] docs/CUTOVER_CHECKLIST.md reviewed
   - [ ] Emergency contacts documented
   - [ ] Rollback criteria understood

**Final pre-flight on production server:**

```bash
./scripts/health-check.sh
```

All checks should pass before proceeding.
</how-to-verify>
<resume-signal>Type "production-ready" when all pre-production checks pass</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 3: Production Cutover Execution</name>
  <what-built>Pre-production readiness verified.</what-built>
  <how-to-verify>
**Execute production cutover following docs/CUTOVER_CHECKLIST.md:**

1. **Freeze Supabase:**
   - Set Supabase to read-only
   - Note timestamp: \***\*\_\_\_\*\***

2. **Export and migrate data:**

   ```bash
   # Export from Supabase
   pnpm --prefix scripts/migration run export

   # Migrate users
   pnpm --prefix scripts/migration run migrate-users

   # Import data
   pnpm --prefix scripts/migration run import

   # Verify migration
   pnpm --prefix scripts/migration run verify
   ```

3. **Deploy application:**

   ```bash
   ./scripts/deploy.sh
   ```

4. **Update DNS:**
   - Update A records to new server IP
   - Wait for propagation (check with `dig`)

5. **Validate cutover:**
   - [ ] https://freshtrackpro.com loads
   - [ ] Login works (user prompted for password reset)
   - [ ] Historical data visible
   - [ ] Test alert triggers correctly
   - [ ] Sensor data flowing (if test sensor available)

6. **Monitor:**
   - Watch Grafana dashboards
   - Check Uptime Kuma status
   - Monitor error logs

**If any critical issues:**

```bash
./scripts/rollback.sh
```

  </how-to-verify>
  <resume-signal>Type "cutover-complete" when production cutover is successful and verified</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 4: Post-Cutover Stabilization</name>
  <what-built>Production cutover executed.</what-built>
  <how-to-verify>
**Post-cutover verification (T+0 to T+24h):**

1. **First 2 hours - Critical monitoring:**
   - [ ] Check error rates in Grafana every 15 min
   - [ ] Monitor login success rate
   - [ ] Verify sensor data accumulating
   - [ ] Check Uptime Kuma status page

2. **First 24 hours:**
   - [ ] Review all error logs
   - [ ] Check data reconciliation (row counts match)
   - [ ] Verify all scheduled jobs running
   - [ ] Address any non-critical issues

3. **User feedback:**
   - [ ] Monitor support email
   - [ ] Check for login problems
   - [ ] Verify data access working

4. **Send confirmation:**
   - [ ] Send "cutover successful" email to users
   - [ ] Update status page with success message

**If rollback needed at any point:**

```bash
./scripts/rollback.sh
```

Supabase remains available for 7 days post-cutover.
</how-to-verify>
<resume-signal>Type "stabilized" when 24-hour stabilization period complete with no critical issues</resume-signal>
</task>

</tasks>

<verification>
This plan consists entirely of human verification checkpoints. Success is determined by:
1. Staging rehearsal completed successfully
2. Production cutover executed following checklist
3. All critical functions verified working
4. 24-hour stabilization period passed without rollback
</verification>

<success_criteria>

- Staging rehearsal validates complete deployment
- Production services start and pass health checks
- Users can log in via Stack Auth with password reset
- Historical data visible in dashboard
- Sensor data flows through new system
- Monitoring dashboards operational
- 24-hour post-cutover period stable
  </success_criteria>

<output>
After completion, create `.planning/phases/07-production-deployment-cutover/07-06-SUMMARY.md` documenting:
- Staging rehearsal results
- Production cutover timeline
- Any issues encountered and resolutions
- Final verification results
</output>
