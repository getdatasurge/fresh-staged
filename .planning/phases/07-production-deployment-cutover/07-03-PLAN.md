---
phase: 07-production-deployment-cutover
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - docker/prometheus/prometheus.yml
  - docker/loki/loki.yml
  - docker/promtail/promtail.yml
  - docker/grafana/provisioning/datasources/datasources.yml
  - docker/grafana/provisioning/dashboards/dashboards.yml
  - docker/grafana/dashboards/freshtrack-overview.json
  - compose.production.yaml
autonomous: true

must_haves:
  truths:
    - "Prometheus scrapes metrics from backend and node exporter"
    - "Loki collects logs from all Docker containers via Promtail"
    - "Grafana shows system dashboard with key metrics"
    - "All observability services start with health checks"
  artifacts:
    - path: "docker/prometheus/prometheus.yml"
      provides: "Metrics scrape configuration"
      contains: "scrape_configs"
    - path: "docker/loki/loki.yml"
      provides: "Log aggregation configuration"
      contains: "schema_config"
    - path: "docker/grafana/dashboards/freshtrack-overview.json"
      provides: "System overview dashboard"
      contains: "dashboard"
  key_links:
    - from: "compose.production.yaml"
      to: "docker/prometheus/"
      via: "volume mounts"
      pattern: "prometheus.yml"
    - from: "grafana"
      to: "prometheus"
      via: "datasource"
      pattern: "prometheus:9090"
---

<objective>
Set up Prometheus, Loki, Grafana, and Promtail observability stack for production monitoring.

Purpose: Provide metrics collection, log aggregation, and visualization dashboards for production operations.
Output: Complete observability stack configuration, integrated with compose.production.yaml.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-production-deployment-cutover/07-RESEARCH.md
@compose.production.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prometheus and Loki configurations</name>
  <files>docker/prometheus/prometheus.yml, docker/loki/loki.yml, docker/promtail/promtail.yml</files>
  <action>
Create the observability configuration files:

**docker/prometheus/prometheus.yml:**
```yaml
# FreshTrack Pro Prometheus Configuration
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Node exporter (host metrics)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']

  # Backend application metrics
  - job_name: 'backend'
    static_configs:
      - targets: ['backend:3000']
    metrics_path: '/metrics'
    # Fallback to health if metrics endpoint not implemented
    # scrape_timeout: 10s

  # Redis metrics (if using redis_exporter)
  # - job_name: 'redis'
  #   static_configs:
  #     - targets: ['redis-exporter:9121']

  # Caddy metrics
  - job_name: 'caddy'
    static_configs:
      - targets: ['caddy:2019']
```

**docker/loki/loki.yml:**
```yaml
# FreshTrack Pro Loki Configuration
auth_enabled: false

server:
  http_listen_port: 3100

ingester:
  lifecycler:
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
  chunk_idle_period: 5m
  chunk_retain_period: 30s
  max_transfer_retries: 0

schema_config:
  configs:
    - from: 2024-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h  # 7 days
  max_entries_limit_per_query: 5000

chunk_store_config:
  max_look_back_period: 720h  # 30 days

table_manager:
  retention_deletes_enabled: true
  retention_period: 720h  # 30 days

compactor:
  working_directory: /loki/compactor
  shared_store: filesystem
```

**docker/promtail/promtail.yml:**
```yaml
# FreshTrack Pro Promtail Configuration
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker container logs
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Keep only containers with specific labels
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'logstream'
      # Add service name from container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/frostguard-(.*)'
        target_label: 'service'
      # Add compose service label if available
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'
    pipeline_stages:
      # Parse JSON logs from backend
      - json:
          expressions:
            level: level
            msg: msg
            time: time
        if: '{ .logstream == "stdout" }'
      # Add parsed labels
      - labels:
          level:
```
  </action>
  <verify>ls -la docker/prometheus/ docker/loki/ docker/promtail/ shows config files</verify>
  <done>Prometheus, Loki, and Promtail configurations created with proper scrape targets and log collection</done>
</task>

<task type="auto">
  <name>Task 2: Create Grafana provisioning and dashboard</name>
  <files>docker/grafana/provisioning/datasources/datasources.yml, docker/grafana/provisioning/dashboards/dashboards.yml, docker/grafana/dashboards/freshtrack-overview.json</files>
  <action>
Create Grafana auto-provisioning configuration:

**docker/grafana/provisioning/datasources/datasources.yml:**
```yaml
# Grafana Datasource Provisioning
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    editable: false
    jsonData:
      maxLines: 1000
```

**docker/grafana/provisioning/dashboards/dashboards.yml:**
```yaml
# Grafana Dashboard Provisioning
apiVersion: 1

providers:
  - name: 'FreshTrack Pro'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    editable: true
    options:
      path: /var/lib/grafana/dashboards
```

**docker/grafana/dashboards/freshtrack-overview.json:**
Create a basic overview dashboard with:
```json
{
  "annotations": {
    "list": []
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 80 }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": { "h": 8, "w": 6, "x": 0, "y": 0 },
      "id": 1,
      "options": {
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
          "legendFormat": "CPU Usage",
          "refId": "A"
        }
      ],
      "title": "CPU Usage",
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 70 },
              { "color": "red", "value": 85 }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": { "h": 8, "w": 6, "x": 6, "y": 0 },
      "id": 2,
      "options": {
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
          "legendFormat": "Memory Usage",
          "refId": "A"
        }
      ],
      "title": "Memory Usage",
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "id": 3,
      "options": {
        "legend": { "calcs": [], "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "single", "sort": "none" }
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "up",
          "legendFormat": "{{job}}",
          "refId": "A"
        }
      ],
      "title": "Service Health",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "loki"
      },
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 8 },
      "id": 4,
      "options": {
        "dedupStrategy": "none",
        "enableLogDetails": true,
        "prettifyLogMessage": false,
        "showCommonLabels": false,
        "showLabels": false,
        "showTime": true,
        "sortOrder": "Descending",
        "wrapLogMessage": false
      },
      "targets": [
        {
          "datasource": { "type": "loki", "uid": "loki" },
          "expr": "{compose_service=~\".+\"} |= ``",
          "refId": "A"
        }
      ],
      "title": "Recent Logs",
      "type": "logs"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["freshtrack", "overview"],
  "templating": { "list": [] },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "title": "FreshTrack Pro Overview",
  "uid": "freshtrack-overview",
  "version": 1,
  "weekStart": ""
}
```

This dashboard shows:
- CPU usage gauge
- Memory usage gauge
- Service health (up/down) timeline
- Recent logs from all services
  </action>
  <verify>ls -la docker/grafana/provisioning/ docker/grafana/dashboards/ shows files</verify>
  <done>Grafana provisioning and overview dashboard created with metrics and logs panels</done>
</task>

<task type="auto">
  <name>Task 3: Add observability services to compose.production.yaml</name>
  <files>compose.production.yaml</files>
  <action>
Append observability services to compose.production.yaml:

```yaml
  # ===========================================
  # Observability Stack
  # ===========================================
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: frostguard-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.0
    container_name: frostguard-loki
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./docker/loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    ports:
      - "127.0.0.1:3100:3100"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.0
    container_name: frostguard-promtail
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./docker/promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.0
    container_name: frostguard-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_password
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${MONITORING_URL:-http://localhost:3001}
    secrets:
      - grafana_password
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "127.0.0.1:3001:3000"
    depends_on:
      - prometheus
      - loki
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.6.0
    container_name: frostguard-node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "127.0.0.1:9100:9100"
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    restart: unless-stopped
```

Add volumes at the end:
```yaml
volumes:
  prometheus_data:
    name: frostguard_prometheus_data
  loki_data:
    name: frostguard_loki_data
  grafana_data:
    name: frostguard_grafana_data
```

Add secret for Grafana:
```yaml
secrets:
  grafana_password:
    file: ./secrets/grafana_password.txt
```
  </action>
  <verify>grep -A5 "prometheus:" compose.production.yaml shows service definition</verify>
  <done>Observability services added to compose.production.yaml with resource limits</done>
</task>

</tasks>

<verification>
Run all verification commands:
1. `ls docker/prometheus/ docker/loki/ docker/promtail/ docker/grafana/` - All dirs exist
2. `cat docker/prometheus/prometheus.yml | grep scrape_configs` - Prometheus config valid
3. `cat docker/loki/loki.yml | grep schema_config` - Loki config valid
4. `grep prometheus compose.production.yaml` - Services added to compose
5. `docker compose -f docker-compose.yml -f compose.production.yaml config | grep grafana` - Config validates
</verification>

<success_criteria>
- Prometheus configured to scrape backend and node-exporter
- Loki configured for 30-day log retention
- Promtail configured to collect Docker container logs
- Grafana auto-provisions datasources and dashboard
- Overview dashboard shows CPU, memory, health, and logs
- All observability services have resource limits
</success_criteria>

<output>
After completion, create `.planning/phases/07-production-deployment-cutover/07-03-SUMMARY.md`
</output>
