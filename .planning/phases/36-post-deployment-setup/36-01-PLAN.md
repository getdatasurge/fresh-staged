---
phase: 36-post-deployment-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/verify-lib.sh
  - scripts/lib/post-deploy-lib.sh
autonomous: true

must_haves:
  truths:
    - "User sees complete URL summary including Bull Board"
    - "User sees credential summary with masked passwords in terminal only"
    - "Credentials never appear in log files"
  artifacts:
    - path: "scripts/lib/post-deploy-lib.sh"
      provides: "Credential display and next steps functions"
      exports: ["display_credential_summary", "display_next_steps"]
    - path: "scripts/lib/verify-lib.sh"
      provides: "Extended URL summary with Bull Board"
      contains: "Bull Board"
  key_links:
    - from: "scripts/lib/post-deploy-lib.sh"
      to: "scripts/lib/preflight-lib.sh"
      via: "source statement"
      pattern: "source.*preflight-lib\\.sh"
---

<objective>
Extend URL summary and create credential display functions for post-deployment

Purpose: POST-01 and POST-02 requirements - users need to see all service URLs and credentials securely displayed after deployment
Output: Extended verify-lib.sh with Bull Board URL, new post-deploy-lib.sh with credential display functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key existing files
@scripts/lib/verify-lib.sh
@scripts/lib/preflight-lib.sh
@scripts/lib/config-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend display_url_summary with Bull Board</name>
  <files>scripts/lib/verify-lib.sh</files>
  <action>
Extend the existing display_url_summary() function (lines 258-286) to include Bull Board URL.

Add after line 277 (Prometheus):
```bash
echo -e "  ðŸš€ Bull Board:${BLUE}https://${domain}/api/admin/queues${NC}"
```

The Bull Board URL is /api/admin/queues based on the backend routing pattern.

Verify the emoji and color formatting matches existing entries.
  </action>
  <verify>grep -q "Bull Board" scripts/lib/verify-lib.sh && echo "Bull Board added"</verify>
  <done>display_url_summary() includes Bull Board URL at /api/admin/queues</done>
</task>

<task type="auto">
  <name>Task 2: Create post-deploy-lib.sh with credential display</name>
  <files>scripts/lib/post-deploy-lib.sh</files>
  <action>
Create new library file scripts/lib/post-deploy-lib.sh with:

1. Header comment block matching preflight-lib.sh style
2. Source preflight-lib.sh for colors and helpers
3. LIB_VERSION="1.0.0"

4. display_credential_summary() function:
   - Takes no arguments (reads from secrets/ directory)
   - Displays credentials WITH MASKED VALUES in terminal
   - Pattern: show first 4 chars + "..." + last 4 chars for secrets
   - CRITICAL: Use /dev/tty for terminal output to prevent log capture
   - Show:
     - PostgreSQL password (masked)
     - JWT Secret (masked, show length only: "[48 chars]")
     - Grafana admin password (masked)
     - MinIO credentials (user full, password masked)
     - Stack Auth keys (masked from .env.production)

5. display_next_steps() function:
   - Takes $1 = domain
   - Shows numbered list of next steps:
     1. Sign up at https://${domain}/signup to create first admin
     2. Create organization in dashboard
     3. Invite team members
     4. Configure TTN integration (link to docs)
     5. Set up alerting rules

6. Read credentials from:
   - secrets/postgres_password.txt
   - secrets/jwt_secret.txt
   - secrets/grafana_password.txt
   - secrets/minio_user.txt
   - secrets/minio_password.txt

Example masked output:
```
PostgreSQL: abcd...wxyz
JWT Secret: [48 chars - stored in secrets/jwt_secret.txt]
Grafana:    efgh...uvwx
```

CRITICAL SECURITY:
- Use `echo "..." > /dev/tty` for credential display
- This ensures credentials go to terminal but NOT to any log redirect
- Add a warning that credentials are displayed to terminal only
  </action>
  <verify>
bash -c "source scripts/lib/post-deploy-lib.sh && type display_credential_summary && type display_next_steps && echo 'Functions exist'"
  </verify>
  <done>post-deploy-lib.sh exists with display_credential_summary() that masks secrets and outputs to /dev/tty only</done>
</task>

<task type="auto">
  <name>Task 3: Add self-test to post-deploy-lib.sh</name>
  <files>scripts/lib/post-deploy-lib.sh</files>
  <action>
Add self-test section at end of post-deploy-lib.sh following preflight-lib.sh pattern:

```bash
# ===========================================
# Self-test when run directly
# ===========================================
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Testing post-deploy-lib.sh v${LIB_VERSION}..."
    echo ""

    # Test display_next_steps function exists and runs
    echo "1. Testing display_next_steps..."
    if display_next_steps "test.example.com" >/dev/null 2>&1; then
        echo "PASS: display_next_steps function works"
    else
        echo "FAIL: display_next_steps function failed"
        exit 1
    fi

    # Test display_credential_summary exists
    echo "2. Testing display_credential_summary exists..."
    if type display_credential_summary &>/dev/null; then
        echo "PASS: display_credential_summary function defined"
    else
        echo "FAIL: display_credential_summary function not defined"
        exit 1
    fi

    # Test that credential display doesn't leak secrets to stdout
    echo "3. Testing credential display doesn't leak to stdout..."
    # Create temporary mock secrets for testing
    TEMP_SECRETS=$(mktemp -d)
    echo "test_postgres_password_1234" > "$TEMP_SECRETS/postgres_password.txt"
    echo "test_jwt_secret_abcdef1234567890" > "$TEMP_SECRETS/jwt_secret.txt"
    echo "test_grafana_pass" > "$TEMP_SECRETS/grafana_password.txt"
    echo "minioadmin" > "$TEMP_SECRETS/minio_user.txt"
    echo "test_minio_password" > "$TEMP_SECRETS/minio_password.txt"

    # Capture stdout only (credential display goes to /dev/tty)
    CAPTURED_OUTPUT=$(SECRETS_DIR="$TEMP_SECRETS" display_credential_summary 2>&1 || true)

    # Check that actual secret values don't appear in captured output
    if echo "$CAPTURED_OUTPUT" | grep -q "test_postgres_password_1234"; then
        echo "FAIL: PostgreSQL password leaked to stdout"
        rm -rf "$TEMP_SECRETS"
        exit 1
    fi
    if echo "$CAPTURED_OUTPUT" | grep -q "test_jwt_secret_abcdef1234567890"; then
        echo "FAIL: JWT secret leaked to stdout"
        rm -rf "$TEMP_SECRETS"
        exit 1
    fi
    rm -rf "$TEMP_SECRETS"
    echo "PASS: Secrets do not leak to stdout"

    # Note: actual credential display test requires secrets/ directory
    # which is deployment-specific

    echo "========================================"
    echo "All post-deploy-lib tests passed!"
    echo "========================================"
fi
```

IMPORTANT: The credential display function must support SECRETS_DIR environment variable override
for testing. Update display_credential_summary to use:
```bash
local secrets_dir="${SECRETS_DIR:-${PROJECT_ROOT}/secrets}"
```
  </action>
  <verify>scripts/lib/post-deploy-lib.sh && echo "Self-test passed"</verify>
  <done>post-deploy-lib.sh self-test passes including verification that secrets don't leak to stdout</done>
</task>

</tasks>

<verification>
1. scripts/lib/verify-lib.sh contains Bull Board URL in display_url_summary
2. scripts/lib/post-deploy-lib.sh exists and sources correctly
3. display_credential_summary outputs to /dev/tty (check function body)
4. display_next_steps shows numbered list with domain placeholder
5. Self-test passes: ./scripts/lib/post-deploy-lib.sh
6. Self-test confirms secrets don't leak to stdout when output is captured
</verification>

<success_criteria>
1. display_url_summary() includes Bull Board URL at /api/admin/queues
2. display_credential_summary() masks passwords showing only first/last 4 chars
3. display_credential_summary() outputs to /dev/tty preventing log capture
4. display_next_steps() shows clear 5-step onboarding guide
5. Both functions can be sourced and called by other scripts
6. Self-test verifies no secret leakage to stdout
</success_criteria>

<output>
After completion, create `.planning/phases/36-post-deployment-setup/36-01-SUMMARY.md`
</output>
