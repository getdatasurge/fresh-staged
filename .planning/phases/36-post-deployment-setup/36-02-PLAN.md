---
phase: 36-post-deployment-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/grafana/dashboards/freshtrack-sensors.json
autonomous: true

must_haves:
  truths:
    - "User sees Grafana dashboard configured for sensor metrics (displays data when available)"
    - "Dashboard shows current temperature, min, max, and trend over time"
    - "Dashboard displays alert counts and status"
  artifacts:
    - path: "docker/grafana/dashboards/freshtrack-sensors.json"
      provides: "Sensor metrics dashboard"
      contains: "sensor_readings"
  key_links:
    - from: "docker/grafana/dashboards/freshtrack-sensors.json"
      to: "docker/grafana/provisioning/dashboards/dashboards.yml"
      via: "file system co-location in docker/grafana/dashboards/"
      pattern: "freshtrack-sensors\\.json"
---

<objective>
Create Grafana dashboard for sensor metrics visualization

Purpose: POST-04 requirement - users need pre-configured dashboards to monitor temperature readings and alerts
Output: freshtrack-sensors.json dashboard with temperature panels, alert counts, and sensor health
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing Grafana setup
@docker/grafana/dashboards/freshtrack-overview.json
@docker/grafana/provisioning/dashboards/dashboards.yml

# Database schema for reference
@backend/src/db/schema/telemetry.ts
@backend/src/db/schema/reading-metrics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sensor metrics Grafana dashboard</name>
  <files>docker/grafana/dashboards/freshtrack-sensors.json</files>
  <action>
Create docker/grafana/dashboards/freshtrack-sensors.json with the following panels:

NOTE: Since FreshTrack stores sensor readings in PostgreSQL (not Prometheus), the dashboard will use the PostgreSQL datasource. However, for a simpler initial implementation, create panels that query the backend /metrics endpoint which exposes Prometheus-format metrics.

Dashboard structure:
1. **Title:** "FreshTrack Sensor Metrics"
2. **UID:** "freshtrack-sensors"
3. **Tags:** ["freshtrack", "sensors", "temperature"]
4. **Refresh:** 30s
5. **Time range:** now-6h to now

Panels (use datasource: prometheus):

Row 1 (Stats - y:0):
1. **Current Readings** (stat panel, gridPos h:8, w:8, x:0)
   - Title: "Active Sensors"
   - Query: `sum(freshtrack_sensors_active)` or fallback to `up{job="backend"}`
   - Unit: short

2. **Readings Today** (stat panel, h:8, w:8, x:8)
   - Title: "Readings Today"
   - Query: `sum(increase(freshtrack_sensor_readings_total[24h]))` or backend_requests_total as fallback
   - Unit: short

3. **Alerts Active** (stat panel, h:8, w:8, x:16)
   - Title: "Active Alerts"
   - Query: `sum(freshtrack_alerts_active)` or `0`
   - Unit: short
   - Thresholds: 0=green, 1=yellow, 5=red

Row 2 (Temperature Chart - y:8):
4. **Temperature Over Time** (timeseries panel, h:10, w:24, x:0)
   - Title: "Temperature Readings (Last 6 Hours)"
   - Query: `freshtrack_temperature_celsius` or `rate(backend_requests_total[5m])` as activity indicator
   - Unit: celsius
   - Legend: bottom
   - Thresholds: -20=blue, 0=green, 4=yellow, 10=red

Row 3 (Details - y:18):
5. **Reading Rate** (timeseries panel, h:8, w:12, x:0)
   - Title: "Sensor Reading Rate"
   - Query: `rate(freshtrack_sensor_readings_total[5m])` or `rate(backend_requests_total{handler="/api/ttn/webhook"}[5m])`
   - Unit: ops (operations/sec)

6. **Battery Status** (gauge panel, h:8, w:12, x:12)
   - Title: "Average Sensor Battery"
   - Query: `avg(freshtrack_sensor_battery_percent)` or static value
   - Unit: percent
   - Thresholds: 0=red, 20=yellow, 50=green

Use the same JSON structure as freshtrack-overview.json for consistency. Key fields:
- datasource.type: "prometheus"
- datasource.uid: "prometheus"

The dashboard will gracefully show "No data" for FreshTrack-specific metrics if the backend doesn't expose them yet, while still providing a useful template.
  </action>
  <verify>
cat docker/grafana/dashboards/freshtrack-sensors.json | jq '.uid' 2>/dev/null && echo "Valid JSON with uid"
  </verify>
  <done>freshtrack-sensors.json exists with temperature, reading rate, battery, and alert panels</done>
</task>

<task type="auto">
  <name>Task 2: Validate dashboard JSON structure</name>
  <files>docker/grafana/dashboards/freshtrack-sensors.json</files>
  <action>
Validate the created dashboard JSON:

1. Ensure valid JSON structure (jq validation)
2. Verify required fields exist:
   - uid: "freshtrack-sensors"
   - title: "FreshTrack Sensor Metrics"
   - panels: array with 6 panels
   - schemaVersion: 38 (matches existing dashboard)

3. Verify each panel has:
   - id: unique integer
   - gridPos: {h, w, x, y}
   - datasource: {type: "prometheus", uid: "prometheus"}
   - targets: at least one query

4. Check no duplicate panel IDs

Fix any issues found.
  </action>
  <verify>
jq -e '.uid == "freshtrack-sensors" and (.panels | length) >= 6' docker/grafana/dashboards/freshtrack-sensors.json && echo "Dashboard structure valid"
  </verify>
  <done>Dashboard JSON is valid, has correct uid, and contains 6 panels</done>
</task>

<task type="auto">
  <name>Task 3: Verify dashboard provisioning path</name>
  <files>docker/grafana/provisioning/dashboards/dashboards.yml</files>
  <action>
Verify that dashboards.yml is configured to auto-discover dashboards from the correct path:

1. Read docker/grafana/provisioning/dashboards/dashboards.yml
2. Confirm it has a provider pointing to /var/lib/grafana/dashboards (or the path used in docker-compose)
3. Confirm the path matches where freshtrack-sensors.json will be mounted

If dashboards.yml doesn't exist or doesn't include the dashboards folder, this is a configuration issue that should be noted but doesn't need to be fixed in this plan (it would be infrastructure setup).

The key verification is that freshtrack-sensors.json is placed in the same directory as freshtrack-overview.json, which is already being provisioned.
  </action>
  <verify>
ls -la docker/grafana/dashboards/*.json | wc -l | xargs -I {} test {} -ge 2 && echo "Multiple dashboards in provisioned directory"
  </verify>
  <done>freshtrack-sensors.json is in same directory as other provisioned dashboards</done>
</task>

</tasks>

<verification>
1. docker/grafana/dashboards/freshtrack-sensors.json exists
2. JSON is valid (jq parses without error)
3. Dashboard has uid "freshtrack-sensors"
4. Dashboard has 6 panels for sensor visualization
5. All panels reference prometheus datasource
6. Dashboard is in same directory as freshtrack-overview.json (will be auto-discovered)
</verification>

<success_criteria>
1. freshtrack-sensors.json is valid Grafana dashboard JSON
2. Dashboard includes temperature time-series panel
3. Dashboard includes sensor count/activity stats
4. Dashboard includes alert count panel
5. Dashboard will appear in Grafana automatically (co-located with existing dashboards)
</success_criteria>

<output>
After completion, create `.planning/phases/36-post-deployment-setup/36-02-SUMMARY.md`
</output>
