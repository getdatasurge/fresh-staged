---
phase: 36-post-deployment-setup
plan: 03
type: execute
wave: 2
depends_on: ['36-01']
files_modified:
  - scripts/post-deploy.sh
  - scripts/seed-demo-data.sh
autonomous: true

must_haves:
  truths:
    - 'User can run post-deploy.sh after verification passes'
    - 'Demo organization and site are created with idempotent SQL'
    - 'User sees URL summary, credentials, and next steps'
  artifacts:
    - path: 'scripts/post-deploy.sh'
      provides: 'Post-deployment orchestration script'
      exports: ['main workflow']
    - path: 'scripts/seed-demo-data.sh'
      provides: 'Demo data seeding'
      contains: 'Demo Foods'
  key_links:
    - from: 'scripts/post-deploy.sh'
      to: 'scripts/lib/post-deploy-lib.sh'
      via: 'source statement'
      pattern: "source.*post-deploy-lib\\.sh"
    - from: 'scripts/post-deploy.sh'
      to: 'scripts/seed-demo-data.sh'
      via: 'script invocation'
      pattern: "seed-demo-data\\.sh"
---

<objective>
Create post-deployment orchestration script integrating demo seeding and summaries

Purpose: POST-03 and POST-05 integration - single script runs after verification to seed demo data and show user all deployment information
Output: post-deploy.sh that orchestrates demo seeding, URL display, credential summary, and next steps
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies from 36-01

@scripts/lib/post-deploy-lib.sh

# Existing scripts

@scripts/lib/verify-lib.sh
@scripts/seed-demo-data.sh
@scripts/seed/demo-data.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post-deploy.sh orchestration script</name>
  <files>scripts/post-deploy.sh</files>
  <action>
Create scripts/post-deploy.sh following the pattern of verify-deployment.sh:

```bash
#!/usr/bin/env bash
# ===========================================
# FreshTrack Pro Post-Deployment Setup
# Runs after verification to complete deployment
# ===========================================
# Usage: ./scripts/post-deploy.sh [domain]
#
# Performs:
#   POST-01: Display URL summary (dashboard, API, monitoring, Bull Board)
#   POST-02: Display credential summary (secure terminal output)
#   POST-03: Seed demo data (organization, site, sensor readings)
#   POST-04: Note about Grafana dashboards (auto-provisioned)
#   POST-05: Display next steps for first admin setup
# ===========================================

set -o errexit
set -o nounset
set -o pipefail

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
STATE_DIR="${PROJECT_ROOT}/.deploy-state"

# Source libraries
source "${LIB_DIR}/preflight-lib.sh"
source "${LIB_DIR}/verify-lib.sh"
source "${LIB_DIR}/post-deploy-lib.sh"

# Load config
CONFIG_FILE="${STATE_DIR}/config.env"
DOMAIN=""

if [[ -f "$CONFIG_FILE" ]]; then
    DOMAIN=$(grep "^DOMAIN=" "$CONFIG_FILE" | cut -d= -f2 | tr -d '"' | tr -d "'" || echo "")
fi

if [[ -n "${1:-}" ]]; then
    DOMAIN="$1"
fi

if [[ -z "$DOMAIN" ]]; then
    error "Domain not found. Usage: ./post-deploy.sh <domain>"
    echo "Or ensure .deploy-state/config.env exists"
    exit 1
fi

echo ""
echo "========================================"
echo "FreshTrack Pro Post-Deployment Setup"
echo "========================================"
echo "Domain: $DOMAIN"
echo ""

# POST-01: URL Summary
step "POST-01: Displaying service URLs..."
display_url_summary "$DOMAIN"

# POST-02: Credential Summary
step "POST-02: Displaying credentials (terminal only)..."
display_credential_summary

# POST-03: Seed Demo Data
step "POST-03: Seeding demo data..."
SEED_SCRIPT="${SCRIPT_DIR}/seed-demo-data.sh"
if [[ -x "$SEED_SCRIPT" ]]; then
    "$SEED_SCRIPT"
else
    warning "Demo seed script not found: $SEED_SCRIPT"
fi

# POST-04: Grafana Note
step "POST-04: Grafana dashboards..."
echo "  Pre-configured dashboards are automatically provisioned:"
echo "    - FreshTrack Pro Overview (system metrics)"
echo "    - FreshTrack Sensor Metrics (temperature, alerts)"
echo ""
echo "  Access at: https://${DOMAIN}/grafana"
echo "  Login with credentials shown above."
echo ""

# POST-05: Next Steps
step "POST-05: Next steps..."
display_next_steps "$DOMAIN"

echo ""
success "Post-deployment setup complete!"
echo ""
```

Make executable: chmod +x scripts/post-deploy.sh
</action>
<verify>
test -x scripts/post-deploy.sh && head -20 scripts/post-deploy.sh | grep -q "POST-01" && echo "Script created and executable"
</verify>
<done>post-deploy.sh exists, is executable, and orchestrates POST-01 through POST-05</done>
</task>

<task type="auto">
  <name>Task 2: Enhance seed-demo-data.sh with better output</name>
  <files>scripts/seed-demo-data.sh</files>
  <action>
Update scripts/seed-demo-data.sh to improve output and handle edge cases:

1. Add check for database availability (wait up to 30s for postgres to be ready)
2. Improve success message with sample data details including alert creation
3. Add --skip-if-exists flag handling (check if demo org already exists)

Updates to make:

After line 26 (check postgres running), add:

```bash
# Wait for postgres to be accepting connections
step "Waiting for database to be ready..."
for i in {1..30}; do
    if docker compose exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
        success "Database is ready"
        break
    fi
    if [[ $i -eq 30 ]]; then
        error "Database not ready after 30 seconds"
        exit 1
    fi
    sleep 1
done
```

Update the success message at the end to be more informative (include alert creation):

```bash
success "Demo data seeded successfully!"
echo ""
echo "  Demo Organization: Demo Foods Inc."
echo "  Demo Site:         Downtown Kitchen"
echo "  Demo Unit:         Freezer 01 (Walk-in Freezer)"
echo "  Demo Sensor:       Sensor-F01"
echo "  Sample Data:       96 temperature readings (24h history)"
echo "  Demo Alert:        1 active temperature alert (temperature_high)"
echo ""
echo "  Login and navigate to the Dashboard to see the demo data."
echo ""
```

  </action>
  <verify>
grep -q "Demo Organization" scripts/seed-demo-data.sh && grep -q "pg_isready" scripts/seed-demo-data.sh && grep -q "Demo Alert" scripts/seed-demo-data.sh && echo "Script enhanced with alert info"
  </verify>
  <done>seed-demo-data.sh has database readiness check and detailed output including alert information</done>
</task>

</tasks>

<verification>
1. scripts/post-deploy.sh exists and is executable
2. post-deploy.sh sources all required libraries
3. post-deploy.sh calls display_url_summary, display_credential_summary, seed-demo-data.sh, display_next_steps
4. seed-demo-data.sh includes database readiness check
5. seed-demo-data.sh output includes alert creation info
6. Both scripts have proper error handling (set -e)
</verification>

<success_criteria>

1. post-deploy.sh orchestrates all POST requirements in order
2. Running post-deploy.sh seeds demo data and displays all summaries
3. Demo data includes organization, site, unit, sensor, readings, and alert
4. seed-demo-data.sh output mentions "Demo Alert: 1 active temperature alert (temperature_high)"
5. Credential summary outputs to terminal only (via /dev/tty from post-deploy-lib.sh)
6. Next steps guide is displayed at the end
   </success_criteria>

<output>
After completion, create `.planning/phases/36-post-deployment-setup/36-03-SUMMARY.md`
</output>
