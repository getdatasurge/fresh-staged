---
phase: 35-verification
plan: 02
type: execute
wave: 2
depends_on: ['35-01']
files_modified:
  - scripts/verify-deployment.sh
autonomous: true

must_haves:
  truths:
    - 'User sees verification check all service endpoints including monitoring'
    - 'User sees E2E test integrated into verification workflow'
    - 'User sees 3-consecutive-pass verification for dashboard endpoint'
  artifacts:
    - path: 'scripts/verify-deployment.sh'
      provides: 'Complete verification entry point'
      contains: 'verify_monitoring_stack'
  key_links:
    - from: 'scripts/verify-deployment.sh'
      to: 'scripts/test/e2e-sensor-pipeline.sh'
      via: 'script invocation'
      pattern: 'e2e-sensor-pipeline'
    - from: 'scripts/verify-deployment.sh'
      to: 'scripts/lib/verify-lib.sh'
      via: 'source import'
      pattern: 'verify_consecutive_health'
---

<objective>
Integrate comprehensive verification into verify-deployment.sh: all service endpoints, monitoring stack, E2E pipeline test, and 3-consecutive-pass validation for dashboard.

Purpose: verify-deployment.sh is the entry point for VERIFY-01 through VERIFY-06. Currently it only does basic checks. This plan integrates all verification requirements into a cohesive workflow.

Output: Enhanced verify-deployment.sh that validates complete deployment health.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-verification/35-01-SUMMARY.md
@scripts/verify-deployment.sh
@scripts/lib/verify-lib.sh
@scripts/test/e2e-sensor-pipeline.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure verify-deployment.sh with comprehensive checks</name>
  <files>scripts/verify-deployment.sh</files>
  <action>
Rewrite verify-deployment.sh to implement complete verification workflow.

**Scope note:** This is a comprehensive rewrite (~115 lines to ~180 lines) but the script is self-contained with clear structure. The rewrite is straightforward - mostly reorganizing existing patterns with new function calls.

**VERIFY-03 implementation note:** "Dashboard accessible via HTTPS" is verified using curl to check HTTP 200 response. This is a network-level check validating HTTPS connectivity and valid HTML response. For full browser rendering verification, users can run E2E tests separately.

**VERIFY-06 scope:** The 3-consecutive-pass requirement applies ONLY to the dashboard check (the most critical user-facing endpoint). Other endpoints (backend API, worker, monitoring) use standard single-check with built-in retries via verify_endpoint_health(). This matches Phase 34 pattern.

Structure:

```bash
#!/usr/bin/env bash
# ===========================================
# FreshTrack Pro Deployment Verification
# Complete multi-layer deployment validation
# ===========================================
# Usage: ./scripts/verify-deployment.sh [domain]
#
# Verifies:
#   VERIFY-01: All service health endpoints (backend, frontend, worker)
#   VERIFY-02: SSL certificate validity
#   VERIFY-03: Dashboard accessible via HTTPS (curl 200 OK check)
#   VERIFY-04: E2E sensor pipeline test (if TTN_WEBHOOK_SECRET set)
#   VERIFY-05: Monitoring stack (Prometheus, Grafana)
#   VERIFY-06: 3 consecutive health passes (dashboard only)
# ===========================================

set -o errexit
set -o nounset
set -o pipefail

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
STATE_DIR="${PROJECT_ROOT}/.deploy-state"

# Source libraries
source "${LIB_DIR}/preflight-lib.sh"
source "${LIB_DIR}/verify-lib.sh"

# ===========================================
# Configuration
# ===========================================

# Load config from state if available
CONFIG_FILE="${STATE_DIR}/config.env"
DOMAIN=""

if [[ -f "$CONFIG_FILE" ]]; then
    DOMAIN=$(grep "^DOMAIN=" "$CONFIG_FILE" | cut -d= -f2 | tr -d '"' | tr -d "'" || echo "")
fi

# Override from argument if provided
if [[ -n "${1:-}" ]]; then
    DOMAIN="$1"
fi

if [[ -z "$DOMAIN" ]]; then
    error "Domain not found. Usage: ./verify-deployment.sh <domain>"
    echo "Or ensure .deploy-state/config.env exists"
    exit 1
fi

# E2E test configuration (optional)
RUN_E2E_TEST="${RUN_E2E_TEST:-auto}"  # auto, yes, no
TTN_WEBHOOK_SECRET="${TTN_WEBHOOK_SECRET:-}"
TEST_JWT="${TEST_JWT:-}"

echo "========================================"
echo "FreshTrack Pro Deployment Verification"
echo "========================================"
echo "Domain: $DOMAIN"
echo ""

# Track overall status
VERIFICATION_FAILED=0

# ===========================================
# 1. Container Status (if Docker accessible)
# ===========================================

if docker compose ps >/dev/null 2>&1; then
    step "Checking container status..."
    services=("backend" "postgres" "redis" "caddy")
    for svc in "${services[@]}"; do
        if ! verify_service_status "$svc"; then
            VERIFICATION_FAILED=1
        fi
    done
    if [[ $VERIFICATION_FAILED -eq 0 ]]; then
        success "All core containers running"
    fi
else
    warning "Docker Compose not accessible, skipping container checks"
fi

# ===========================================
# 2. VERIFY-01: All Service Health Endpoints
# ===========================================

step "VERIFY-01: Checking all service endpoints..."
if ! verify_all_services "$DOMAIN"; then
    VERIFICATION_FAILED=1
fi
echo ""

# ===========================================
# 3. VERIFY-02: SSL Certificate Validation
# ===========================================

step "VERIFY-02: Validating SSL certificate..."
if ! verify_ssl_cert "$DOMAIN"; then
    VERIFICATION_FAILED=1
fi
echo ""

# ===========================================
# 4. VERIFY-03 + VERIFY-06: Dashboard with 3 Consecutive Passes
# Note: curl 200 OK serves as network-level browser accessibility check
# The 3-pass requirement applies to dashboard only (most critical endpoint)
# ===========================================

step "VERIFY-03 + VERIFY-06: Dashboard accessibility (3 consecutive passes)..."
if ! verify_consecutive_health "Dashboard" "https://${DOMAIN}"; then
    VERIFICATION_FAILED=1
fi
echo ""

# ===========================================
# 5. VERIFY-05: Monitoring Stack
# ===========================================

step "VERIFY-05: Checking monitoring stack..."
if ! verify_monitoring_stack "$DOMAIN"; then
    # Monitoring failures are warnings, not blockers
    warning "Monitoring stack not fully accessible (may require auth)"
fi
echo ""

# ===========================================
# 6. VERIFY-04: E2E Sensor Pipeline Test
# ===========================================

step "VERIFY-04: E2E sensor pipeline test..."

# Determine if we should run E2E test
run_e2e=false
if [[ "$RUN_E2E_TEST" == "yes" ]]; then
    run_e2e=true
elif [[ "$RUN_E2E_TEST" == "auto" ]] && [[ -n "$TTN_WEBHOOK_SECRET" ]]; then
    run_e2e=true
fi

if [[ "$run_e2e" == "true" ]]; then
    if [[ -z "$TTN_WEBHOOK_SECRET" ]]; then
        warning "E2E test requested but TTN_WEBHOOK_SECRET not set"
    else
        E2E_SCRIPT="${SCRIPT_DIR}/test/e2e-sensor-pipeline.sh"
        if [[ -x "$E2E_SCRIPT" ]]; then
            echo "Running E2E sensor pipeline test..."
            export BASE_URL="https://${DOMAIN}"
            export TTN_WEBHOOK_SECRET
            export TEST_JWT

            if "$E2E_SCRIPT"; then
                success "E2E sensor pipeline test passed"
            else
                error "E2E sensor pipeline test failed"
                VERIFICATION_FAILED=1
            fi
        else
            warning "E2E test script not found or not executable: $E2E_SCRIPT"
        fi
    fi
else
    echo "  Skipped (set RUN_E2E_TEST=yes or provide TTN_WEBHOOK_SECRET to enable)"
fi
echo ""

# ===========================================
# Results
# ===========================================

if [[ $VERIFICATION_FAILED -eq 0 ]]; then
    display_url_summary "$DOMAIN"
    exit 0
else
    echo ""
    error "========================================="
    error "      VERIFICATION FAILED"
    error "========================================="
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check service logs: docker compose logs"
    echo "  2. Check container status: docker compose ps"
    echo "  3. Test endpoints manually: curl -v https://${DOMAIN}/api/health"
    echo ""
    exit 1
fi
```

Replace entire verify-deployment.sh with this structure. E2E test logic is inline (not calling a wrapper function) matching the existing pattern in e2e-sensor-pipeline.sh.
</action>
<verify>bash -n scripts/verify-deployment.sh && grep -q "VERIFY-01" scripts/verify-deployment.sh && grep -q "verify_all_services" scripts/verify-deployment.sh && grep -q "VERIFY-03 + VERIFY-06" scripts/verify-deployment.sh && echo "Script valid"</verify>
<done>verify-deployment.sh implements all VERIFY requirements with comprehensive checks</done>
</task>

</tasks>

<verification>
Test verification script:
```bash
# Syntax check
bash -n scripts/verify-deployment.sh

# Check all VERIFY requirements are mentioned

grep -c "VERIFY-0" scripts/verify-deployment.sh # Should be 6+ mentions

# Source library and verify functions

source scripts/lib/verify-lib.sh
type verify_all_services
type verify_monitoring_stack
type verify_consecutive_health

# Run against a test domain (will fail but validates script structure)

./scripts/verify-deployment.sh example.com 2>&1 | head -20

```
</verification>

<success_criteria>
1. verify-deployment.sh implements VERIFY-01 through VERIFY-06
2. E2E test is conditionally run based on environment variables (inline logic)
3. 3-consecutive-pass verification applied to dashboard check only
4. Monitoring stack verification included (warning, not blocker)
5. Clear error messages and troubleshooting guidance on failure
6. URL summary displayed on successful verification
</success_criteria>

<output>
After completion, create `.planning/phases/35-verification/35-02-SUMMARY.md`
</output>
```
