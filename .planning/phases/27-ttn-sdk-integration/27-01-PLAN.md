---
phase: 27
plan: 01
wave: 1
gap_closure: false
---

# Plan 27-01: TTN Backend Foundation

## Goal

Create the foundational TTN service layer in the backend, porting core logic from Supabase Edge Functions.

## Requirements

- Port `ttnBase.ts`, `ttnConfig.ts`, and `ttnPermissions.ts` to backend services.
- Implement `TtnClient` class for standard HTTP interactions.
- Ensure strict NAM1-only cluster locking is preserved.
- Implement permission checking logic (Main Key vs Personal Key validation).

## Tasks

<task>
<name>Create TTN Service Directory</name>
<description>
Create directory structure `backend/src/services/ttn` and common types.
</description>
<file>backend/src/services/ttn/types.ts</file>
<instruction>
Define `TtnConfig`, `TtnTestResult`, `PermissionReport` interfaces matching existing ones.
</instruction>
<verify>
test -f backend/src/services/ttn/types.ts
</verify>
</task>

<task>
<name>Implement TTN Base & Client</name>
<description>
Create `backend/src/services/ttn/client.ts`:
- Constants (`CLUSTER_BASE_URL`).
- `TtnClient` class with methods for `fetch` wrapping (auth headers, error handling).
- Logging helpers.
</description>
<file>backend/src/services/ttn/client.ts</file>
<verify>
grep "CLUSTER_BASE_URL" backend/src/services/ttn/client.ts
</verify>
</task>

<task>
<name>Implement TTN Permissions Service</name>
<description>
Create `backend/src/services/ttn/permissions.ts`:
- Port `validateMainUserApiKey`, `fetchTtnRights`, `computePermissionReport`.
- Port `MAIN_USER_KEY_REQUIRED_RIGHTS` constants.
</description>
<file>backend/src/services/ttn/permissions.ts</file>
<verify>
grep "validateMainUserApiKey" backend/src/services/ttn/permissions.ts
</verify>
</task>
