---
phase: 22-foundation-pre-flight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/preflight-lib.sh
autonomous: true

must_haves:
  truths:
    - "Any script failure shows line number, command, and error category"
    - "Credentials never appear in error output (password, secret, key, token redacted)"
    - "Error categories (transient, recoverable, critical, fatal) guide recovery actions"
    - "Recovery guidance displayed for each error category"
  artifacts:
    - path: "scripts/lib/preflight-lib.sh"
      provides: "Error handling infrastructure and credential sanitization"
      exports: ["error_handler", "categorize_error", "recovery_guidance", "sanitize_output"]
      min_lines: 80
  key_links:
    - from: "scripts/lib/preflight-lib.sh"
      to: "bash trap mechanism"
      via: "trap error_handler ERR"
      pattern: "trap.*error_handler.*ERR"
---

<objective>
Create error handling infrastructure library for automated deployment scripts.

Purpose: Establishes the foundational error handling that all v2.1 deployment scripts will source, providing consistent diagnostics without exposing credentials.

Output: `scripts/lib/preflight-lib.sh` with error handler, categorization, and recovery guidance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-foundation-pre-flight/22-RESEARCH.md
@scripts/deploy-selfhosted.sh (lines 9-31 for color helpers pattern)
@scripts/health-check.sh (for check counter pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preflight-lib.sh with strict mode and error handler</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Create `scripts/lib/preflight-lib.sh` with:

1. **Strict mode header** (lines 1-15):
   - Shebang: `#!/usr/bin/env bash`
   - `set -o errexit` (exit on error)
   - `set -o errtrace` (inherit ERR trap in functions)
   - `set -o nounset` (error on unset variables)
   - `set -o pipefail` (pipe fails on first error)
   - `SCRIPT_DIR` detection for portable paths
   - `LIB_VERSION="1.0.0"` for tracking

2. **Color output helpers** (lines 16-45):
   - Match existing pattern from deploy-selfhosted.sh
   - `step()`, `success()`, `error()`, `warning()` functions
   - Use same color codes: RED, GREEN, YELLOW, BLUE, NC

3. **Credential sanitization** (lines 46-60):
   - `SENSITIVE_PATTERNS='password|secret|key|token|credential|api_key|auth'`
   - `sanitize_output()` function using sed to replace `pattern=value` with `pattern=[REDACTED]`
   - Handle both `=value` and `='value'` formats

4. **Error categorization** (lines 61-100):
   - `categorize_error()` function accepting exit code
   - Return categories based on exit code ranges:
     - 6,7,28,35,52,56 -> "transient:network" (curl/wget network errors)
     - 1,126,127 -> "recoverable:permission" (permission/command not found)
     - 137,139 -> "recoverable:resource" (OOM, segfault)
     - 128,129,130,131 -> "fatal:signal" (SIGINT, SIGKILL, etc.)
     - * -> "critical:unknown"

5. **Recovery guidance** (lines 101-140):
   - `recovery_guidance()` function accepting category
   - Case statement returning actionable advice:
     - transient:* -> "Retry: temporary network issue, run script again"
     - recoverable:permission -> "Check sudo access, verify file permissions"
     - recoverable:resource -> "Free up memory/disk, run docker system prune -f"
     - fatal:* -> "Manual intervention, check journalctl -xe"
     - critical:* -> "Review failed command, check docker compose logs"

6. **Comprehensive error handler** (lines 141-180):
   - `error_handler()` function capturing:
     - `exit_code=$?`
     - `line_number=${BASH_LINENO[0]}`
     - `command="${BASH_COMMAND}"`
     - `func_name="${FUNCNAME[1]:-main}"`
   - Sanitize command before display
   - Print structured error block to stderr:
     ```
     ========================================
     DEPLOYMENT ERROR
     ========================================
     Line:     {line_number}
     Function: {func_name}
     Command:  {sanitized_command}
     Exit:     {exit_code}
     Category: {category}
     ========================================
     ```
   - Call `recovery_guidance` with category
   - Exit with original exit code

7. **Trap registration** (line 181):
   - `trap error_handler ERR`
   - Comment explaining this must be called AFTER sourcing

Do NOT add validation functions yet (those are Plan 22-02).
Do NOT add checkpoint functions yet (those are Plan 22-03).
  </action>
  <verify>
Run shellcheck on the file:
```bash
shellcheck scripts/lib/preflight-lib.sh
```
Verify no errors (warnings about `source` are acceptable).

Test error handler by sourcing and triggering error:
```bash
bash -c 'source scripts/lib/preflight-lib.sh; false'
```
Should show formatted error with line number and "critical:unknown" category.
  </verify>
  <done>
- preflight-lib.sh exists with ~180 lines
- Strict mode header present
- Color helpers match existing deploy-selfhosted.sh pattern
- sanitize_output redacts sensitive patterns
- categorize_error returns correct categories for test codes
- recovery_guidance provides actionable advice
- error_handler displays formatted diagnostic without credentials
- shellcheck passes (no errors)
  </done>
</task>

<task type="auto">
  <name>Task 2: Test credential sanitization</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Add a test block at the end of preflight-lib.sh (guarded by `if [[ "${BASH_SOURCE[0]}" == "${0}" ]]`):

```bash
# Self-test when run directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Testing preflight-lib.sh..."

    # Test sanitize_output
    test_cmd='curl -u user:password=secret123 https://api.example.com --header "Authorization: Bearer token=abc123"'
    sanitized=$(echo "$test_cmd" | sanitize_output)

    if echo "$sanitized" | grep -q "secret123"; then
        echo "FAIL: password not redacted"
        exit 1
    fi
    if echo "$sanitized" | grep -q "abc123"; then
        echo "FAIL: token not redacted"
        exit 1
    fi
    echo "PASS: Credential sanitization working"

    # Test categorize_error
    if [[ "$(categorize_error 28)" != "transient:network" ]]; then
        echo "FAIL: Exit code 28 should be transient:network"
        exit 1
    fi
    if [[ "$(categorize_error 127)" != "recoverable:permission" ]]; then
        echo "FAIL: Exit code 127 should be recoverable:permission"
        exit 1
    fi
    echo "PASS: Error categorization working"

    echo ""
    echo "All tests passed!"
fi
```

Run the self-test:
```bash
bash scripts/lib/preflight-lib.sh
```
  </action>
  <verify>
```bash
bash scripts/lib/preflight-lib.sh
```
Should output:
- "PASS: Credential sanitization working"
- "PASS: Error categorization working"
- "All tests passed!"
  </verify>
  <done>
- Self-test block present and guarded
- Running script directly executes tests
- All tests pass
- Tests cover sanitize_output and categorize_error
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls -la scripts/lib/preflight-lib.sh`
2. Shellcheck passes: `shellcheck scripts/lib/preflight-lib.sh`
3. Self-tests pass: `bash scripts/lib/preflight-lib.sh`
4. Error handler works: `bash -c 'source scripts/lib/preflight-lib.sh; false' 2>&1 | grep -q "DEPLOYMENT ERROR"`
5. Credentials redacted: `bash -c 'source scripts/lib/preflight-lib.sh; echo "password=test123" | sanitize_output' | grep -q "REDACTED"`
</verification>

<success_criteria>
- ERROR-01: trap ERR captures command failures (verified by error handler test)
- ERROR-02: Diagnostic context includes line number and command (verified by error handler output)
- ERROR-03: Error categorization returns transient/recoverable/critical/fatal (verified by self-test)
- ERROR-06: Recovery guidance displayed on failure (verified by error handler output)
- ERROR-07: Credentials never exposed (verified by sanitization test)
</success_criteria>

<output>
After completion, create `.planning/phases/22-foundation-pre-flight/22-01-SUMMARY.md`
</output>
