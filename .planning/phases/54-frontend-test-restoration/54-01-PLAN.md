---
phase: 54-frontend-test-restoration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/__tests__/TTNCredentialsPanel.test.tsx
autonomous: true
must_haves:
  truths:
    - "TTNCredentialsPanel test suite has ~21 tests covering rendering, data loading, mutations, and error handling"
    - "All 5 existing tests still pass after mock restructuring"
    - "New tests cover deferred scenarios: async data loading, mutation success/failure, credential display states, error handling"
    - "pnpm test runs with TTNCredentialsPanel.test.tsx passing all tests"
  artifacts:
    - path: "src/components/settings/__tests__/TTNCredentialsPanel.test.tsx"
      provides: "Full TTNCredentialsPanel test coverage (~21 tests)"
      contains: "mockUseTRPC"
  key_links:
    - from: "src/components/settings/__tests__/TTNCredentialsPanel.test.tsx"
      to: "src/test/trpc-test-utils.ts"
      via: "import createQueryOptionsMock"
      pattern: "createQueryOptionsMock"
    - from: "src/components/settings/__tests__/TTNCredentialsPanel.test.tsx"
      to: "src/components/settings/TTNCredentialsPanel.tsx"
      via: "component under test"
      pattern: "TTNCredentialsPanel"
---

<objective>
Restore TTNCredentialsPanel test coverage from 5 to ~21 tests by restructuring the mock approach and implementing all deferred test scenarios (async data loading, mutations, error handling, credential display).

Purpose: Fulfill FE-01 and FE-02 — restore the test coverage that was deliberately deferred during the tRPC migration (v2.4), covering the component's complex async behaviors.
Output: `TTNCredentialsPanel.test.tsx` with ~21 passing tests across 5 describe groups.
</objective>

<execution_context>
Read file: .planning/phases/54-frontend-test-restoration/54-RESEARCH.md
</execution_context>

<context>
Read file: .planning/PROJECT.md
Read file: .planning/ROADMAP.md
Read file: .planning/STATE.md
Read file: .planning/phases/54-frontend-test-restoration/54-RESEARCH.md

**Key decisions from research:**
- Replace the `vi.mock('@tanstack/react-query')` approach with the established `mockUseTRPC` + `createQueryOptionsMock` pattern
- The component uses `enabled: false` + manual `refetch()` via `getCredentialsRefetchRef.current()`. The useQuery mock must return a controllable `refetch` function.
- Toast mock must use `vi.hoisted()` (already in file)
- Reference patterns: `src/hooks/__tests__/useAlerts.test.tsx`, `src/hooks/__tests__/useSites.test.tsx`

**Component analysis (TTNCredentialsPanel.tsx, 500+ lines):**
- 2 queries: `getCredentials` (enabled:false, manual refetch), `getStatus` (enabled:false, manual refetch)
- 3 mutations: `provision` (retry), `startFresh`, `deepClean`
- State: credentials, isLoading, fetchError, isRetrying, isStartingFresh, isDeepCleaning, dialog states
- Key behaviors: fetchCredentials callback (handles refetch result, sets credentials or fetchError), handleRetryProvisioning, handleStartFresh, handleDeepClean
- UI states: loading skeleton, fetch error banner with retry button, credential fields with status badges, provisioning status badges

Relevant source files:
Read file: src/components/settings/__tests__/TTNCredentialsPanel.test.tsx
Read file: src/components/settings/TTNCredentialsPanel.tsx
Read file: src/test/trpc-test-utils.ts
Read file: src/hooks/__tests__/useAlerts.test.tsx
Read file: src/test/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure test mocks from react-query override to mockUseTRPC pattern</name>
  <files>src/components/settings/__tests__/TTNCredentialsPanel.test.tsx</files>
  <action>
Rewrite the mock setup in TTNCredentialsPanel.test.tsx to replace the `vi.mock('@tanstack/react-query')` block with the established `mockUseTRPC` pattern. Keep the existing 5 tests intact and passing.

**Step-by-step changes:**

1. **Remove** the entire `vi.mock('@tanstack/react-query', ...)` block (lines 74-90). This mock overrides useQuery/useMutation globally and prevents testing async behavior because refetch is a never-resolving promise.

2. **Add** `import { createQueryOptionsMock } from '@/test/trpc-test-utils'` at the top.

3. **Replace** the static `vi.mock('@/lib/trpc', ...)` block (lines 34-71) with the dynamic `mockUseTRPC` pattern:
   ```typescript
   const mockUseTRPC = vi.fn()

   vi.mock('@/lib/trpc', () => ({
     useTRPC: () => mockUseTRPC(),
   }))
   ```

4. **Add mock data and mock functions** before the describe block:
   ```typescript
   const mockProvisionFn = vi.fn()
   const mockStartFreshFn = vi.fn()
   const mockDeepCleanFn = vi.fn()

   const MOCK_CREDENTIALS = {
     organization_name: 'Test Org',
     organization_id: 'org-123',
     ttn_application_id: 'app-test',
     ttn_region: 'nam1',
     org_api_secret: null,
     org_api_secret_last4: 'ab12',
     org_api_secret_status: 'decrypted' as const,
     app_api_secret: null,
     app_api_secret_last4: 'cd34',
     app_api_secret_status: 'decrypted' as const,
     webhook_secret: null,
     webhook_secret_last4: 'ef56',
     webhook_secret_status: 'decrypted' as const,
     webhook_url: 'https://example.com/webhook',
     provisioning_status: 'ready',
     provisioning_step: null,
     provisioning_step_details: null,
     provisioning_error: null,
     provisioning_attempt_count: 1,
     last_http_status: null,
     last_http_body: null,
     credentials_last_rotated_at: null,
     app_rights_check_status: null,
     last_ttn_correlation_id: null,
     last_ttn_error_name: null,
   }
   ```

5. **Configure** `mockUseTRPC` in `beforeEach` to return the tRPC structure with `createQueryOptionsMock` for queries and mutation mock functions:
   ```typescript
   beforeEach(() => {
     vi.clearAllMocks()
     queryClient = new QueryClient({ defaultOptions: { queries: { retry: false }, mutations: { retry: false } } })

     mockProvisionFn.mockResolvedValue({ success: true })
     mockStartFreshFn.mockResolvedValue({ success: true })
     mockDeepCleanFn.mockResolvedValue({ success: true })

     mockUseTRPC.mockReturnValue({
       ttnSettings: {
         getCredentials: {
           queryOptions: createQueryOptionsMock(MOCK_CREDENTIALS, {
             queryKey: ['ttnSettings', 'getCredentials', { organizationId: 'test-org' }],
           }),
         },
         getStatus: {
           queryOptions: createQueryOptionsMock(null, {
             queryKey: ['ttnSettings', 'getStatus', { organizationId: 'test-org' }],
           }),
         },
         provision: {
           mutationOptions: vi.fn().mockReturnValue({
             mutationKey: ['ttnSettings', 'provision'],
             mutationFn: mockProvisionFn,
           }),
         },
         startFresh: {
           mutationOptions: vi.fn().mockReturnValue({
             mutationKey: ['ttnSettings', 'startFresh'],
             mutationFn: mockStartFreshFn,
           }),
         },
         deepClean: {
           mutationOptions: vi.fn().mockReturnValue({
             mutationKey: ['ttnSettings', 'deepClean'],
             mutationFn: mockDeepCleanFn,
           }),
         },
       },
     })

     toastMock.success.mockClear()
     toastMock.error.mockClear()
   })
   ```

6. **Verify the 5 existing tests still pass.** The null org test, loading skeleton test, renders without crashing test, card header test, and card description test must all continue passing. Some assertions may need minor adjustment since useQuery now runs the real queryFn (the mock returns MOCK_CREDENTIALS instead of null). The loading skeleton test should work because the component sets `isLoading: true` in `fetchCredentials` and the async nature means the initial render shows the loading state.

**Critical detail about the component's `enabled: false` + refetch pattern:**
The component calls `useQuery(trpc.ttnSettings.getCredentials.queryOptions({ organizationId }, { enabled: false }))`. With the `createQueryOptionsMock` pattern, `queryOptions()` returns `{ queryKey, queryFn, enabled: false }` and the real `useQuery` processes this. Since `enabled: false`, TanStack Query will NOT auto-fetch. The component's `fetchCredentials` callback calls `getCredentialsRefetchRef.current()` which triggers `refetch()` on the real useQuery. The `refetch()` call executes the `queryFn` from the mock, which returns `Promise.resolve(MOCK_CREDENTIALS)`. This means the component's data flow works naturally through the real React Query — no need to mock useQuery itself.

**Important:** Keep the `vi.mock('@stackframe/react')`, `vi.mock('sonner')`, and `vi.mock('@/components/ttn/TTNDiagnosticsPanel')` blocks unchanged. Also add `vi.mock('@/components/settings/SecretField', ...)` to avoid coupling to SecretField internals — mock it to render the label and last4 value.

Add this mock:
```typescript
vi.mock('../SecretField', () => ({
  SecretField: ({ label, last4, status }: { label: string; last4: string | null; status: string }) => (
    <div data-testid={`secret-field-${label.toLowerCase().replace(/\s+/g, '-')}`}>
      <span>{label}</span>
      {last4 && <span data-testid="last4">...{last4}</span>}
      <span data-testid="status">{status}</span>
    </div>
  ),
}))
```
  </action>
  <verify>
1. `cd /home/swoop/swoop-claude-projects/fresh-staged && pnpm test -- --run src/components/settings/__tests__/TTNCredentialsPanel.test.tsx` — all 5 existing tests pass
2. No `vi.mock('@tanstack/react-query')` in the file (grep returns empty)
3. `mockUseTRPC` pattern is present (grep confirms)
4. `createQueryOptionsMock` is imported from `@/test/trpc-test-utils`
  </verify>
  <done>Mock restructuring complete: vi.mock('@tanstack/react-query') removed, mockUseTRPC pattern in place, all 5 existing tests still pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement ~16 new tests across 4 behavior groups</name>
  <files>src/components/settings/__tests__/TTNCredentialsPanel.test.tsx</files>
  <action>
Add ~16 new tests to TTNCredentialsPanel.test.tsx organized into 4 new describe groups alongside the existing "Initial Rendering" group. Use `waitFor` from `@testing-library/react` for async assertions and `fireEvent` for user interactions.

Add import: `import { render, screen, cleanup, waitFor, fireEvent } from '@testing-library/react'`

**Group 1: Data Loading States (4 tests)**

```
describe('Data Loading States', () => {
```

1. **"displays credentials after successful fetch"** — Render with `organizationId="test-org"`, `await waitFor(() => expect(screen.getByText('Test Org')).toBeInTheDocument())`. Verify org name and org ID are displayed.

2. **"shows loading skeleton while fetching"** — Before the fetchCredentials promise resolves, the component shows Skeleton elements with `animate-pulse`. Render the component and check that skeleton elements are present in the initial synchronous render.

3. **"shows fetch error banner when refetch fails"** — Override `mockUseTRPC` for this test to make `getCredentials.queryOptions` return an error-throwing queryFn:
   ```typescript
   mockUseTRPC.mockReturnValue({
     ttnSettings: {
       getCredentials: {
         queryOptions: vi.fn().mockReturnValue({
           queryKey: ['ttnSettings', 'getCredentials'],
           queryFn: () => Promise.reject(new Error('Network error')),
           enabled: false,
         }),
       },
       // ... same getStatus and mutations as beforeEach
     },
   })
   ```
   Wait for the error banner to appear: `await waitFor(() => expect(screen.getByText('Network error')).toBeInTheDocument())`.

4. **"shows retry button in error banner"** — Same error setup as test 3, then verify the Retry button is present: `expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument()`.

**Group 2: Credential Display (4 tests)**

```
describe('Credential Display', () => {
```

5. **"shows Fully Provisioned badge when all credentials present"** — Render with default mock (all credentials have last4 + webhook_url). Wait for loading to finish, verify `screen.getByText('Fully Provisioned')`.

6. **"shows Partially Configured badge when some credentials missing"** — Override mock data with `webhook_url: null, webhook_secret_last4: null`. Verify `screen.getByText('Partially Configured')`.

7. **"shows Not Configured badge when no credentials"** — Override mock data with all secrets null, webhook null. Verify `screen.getByText('Not Configured')`.

8. **"displays secret field last4 values"** — Render with default mock. Wait for loading. Verify the SecretField mocks rendered with last4 values visible (via testids from the SecretField mock): `screen.getByTestId('secret-field-organization-api-secret')` exists and contains `...ab12`.

**Group 3: Mutation Actions (4 tests)**

```
describe('Mutation Actions', () => {
```

For mutation tests, the component needs `credentials.provisioning_status === 'failed'` to show the Retry button. Override MOCK_CREDENTIALS with `provisioning_status: 'failed', provisioning_error: 'Step failed'`.

9. **"retry provisioning calls provision mutation and shows success toast"** — Render component with failed provisioning status. Wait for credentials to load. Find the retry button (it shows "Retry Provisioning" text or a RefreshCw icon button). Click it with `fireEvent.click()`. Verify `mockProvisionFn` was called with `{ organizationId: 'test-org', action: 'retry' }`. Verify `toastMock.success` was called with "Provisioning retry initiated".

10. **"retry provisioning shows error toast on failure"** — Set `mockProvisionFn.mockRejectedValueOnce(new Error('Provision failed'))`. Click retry. Verify `toastMock.error` was called.

11. **"start fresh shows confirmation dialog"** — Render with failed provisioning. Find and click the "Start Fresh" button. Verify the AlertDialog content appears (text like "Start Fresh" or "This will delete").

12. **"deep clean shows confirmation dialog"** — Render with failed provisioning. Find and click "Deep Clean" button. Verify the deep clean dialog content appears.

**Group 4: Error Handling (4 tests)**

```
describe('Error Handling', () => {
```

13. **"shows session expired message when user is null"** — Mock `useUser` to return `null` for this test:
    ```typescript
    const useUserModule = await import('@stackframe/react')
    vi.mocked(useUserModule.useUser).mockReturnValueOnce(null as any)
    ```
    Render. Wait for error. Verify "Session expired" text appears or toast.error was called with session expired message.

14. **"does not show error toast on repeated fetch failures (spam prevention)"** — Set up failing queryFn. Render component, wait for first error. Clear the toast mock. Trigger another fetch by unmounting and remounting. The second error should NOT call toast.error again (due to hasShownErrorToastRef). Verify `toastMock.error` call count.

15. **"handles structured error response from provision mutation"** — Set `mockProvisionFn.mockResolvedValueOnce({ success: false, error: 'Unowned app', use_start_fresh: true, message: 'Application is owned by different account' })`. Click retry. Verify toast.error was called with "Cannot retry - use Start Fresh".

16. **"shows no organization selected when orgId is null"** — (This already exists as test 1, but if you hit the target of ~21 tests total, it naturally combines with the existing 5). Alternatively, add: **"handles org switch by clearing old credentials"** — Render with orgId "org-1", wait for credentials. Re-render with orgId "org-2". Verify old credentials are cleared and new fetch is triggered.

**Test count summary:**
- Existing: 5 (Initial Rendering)
- New Group 1: 4 (Data Loading States)
- New Group 2: 4 (Credential Display)
- New Group 3: 4 (Mutation Actions)
- New Group 4: 4 (Error Handling)
- Total: 21

**Important implementation notes:**
- Use `await waitFor(() => ...)` for all assertions that depend on async state updates
- Use `await act(async () => { ... })` when triggering mutations
- Some tests will need to override `mockUseTRPC.mockReturnValue(...)` within the test itself before rendering
- The component's `useEffect` triggers `fetchCredentials` on mount, which calls `refetch()`. In tests with the real useQuery + mock queryFn, this means data flows through naturally.
- For mutation button tests: the Retry/Start Fresh/Deep Clean buttons only appear when `credentials.provisioning_status === 'failed'`. The mock data must reflect this.
- If any button text is hard to match, use `screen.getAllByRole('button')` and filter by accessible name or contained icon.
  </action>
  <verify>
1. `cd /home/swoop/swoop-claude-projects/fresh-staged && pnpm test -- --run src/components/settings/__tests__/TTNCredentialsPanel.test.tsx` — all ~21 tests pass
2. Zero skipped tests in the output
3. Test groups cover: Initial Rendering (5), Data Loading States (4), Credential Display (4), Mutation Actions (4), Error Handling (4)
4. `pnpm test -- --run` (all frontend tests) — no regressions in other test files
  </verify>
  <done>TTNCredentialsPanel test suite has ~21 passing tests across 5 describe groups. Covers: rendering, async data loading, credential display states, mutation actions (retry/start fresh/deep clean), and error handling (session expired, structured errors, toast spam prevention). Zero skipped tests.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm test -- --run src/components/settings/__tests__/TTNCredentialsPanel.test.tsx` — ~21 passed, 0 skipped, 0 failed
- [ ] No `vi.mock('@tanstack/react-query')` override in the file
- [ ] `createQueryOptionsMock` imported from `@/test/trpc-test-utils`
- [ ] `mockUseTRPC` pattern matches established project convention
- [ ] `pnpm test -- --run` (all frontend tests) — no regressions
- [ ] Test file header comment updated to reflect full coverage (remove "Deferred" note)
</verification>

<success_criteria>
- TTNCredentialsPanel test suite has ~21 tests (target: 18-24)
- All deferred scenarios implemented: async data loading, mutations, error handling
- Mock strategy uses established mockUseTRPC + createQueryOptionsMock pattern
- Zero skipped tests in TTNCredentialsPanel.test.tsx
- No regression in other frontend test files
</success_criteria>

<must_haves>
- `createQueryOptionsMock` from `@/test/trpc-test-utils` is used (not hand-rolled query mocks)
- No `vi.mock('@tanstack/react-query')` override in the file
- Tests cover: data loading success, data loading error, credential display badges (3 states), mutation success/failure toasts, session expired handling
- All tests pass with `pnpm test -- --run`
- Test count is 18-24 (approximately 21)
</must_haves>

<output>
After completion, create `.planning/phases/54-frontend-test-restoration/54-01-SUMMARY.md`
</output>
