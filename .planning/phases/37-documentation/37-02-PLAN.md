---
phase: 37-documentation
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - docs/SELFHOSTED_DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "User can follow deployment from fresh VM to running application"
    - "User understands what each deployment phase does"
    - "User knows what to expect during each phase"
    - "User can verify each phase completed successfully"
  artifacts:
    - path: "docs/SELFHOSTED_DEPLOYMENT.md"
      provides: "Step-by-step deployment walkthrough"
      contains: "deploy-automated.sh"
  key_links:
    - from: "docs/SELFHOSTED_DEPLOYMENT.md"
      to: "scripts/deploy-automated.sh"
      via: "documentation reference"
      pattern: "deploy-automated.sh"
---

<objective>
Update step-by-step deployment walkthrough (DOCS-02) so users can deploy from fresh VM to running FreshTrack Pro.

Purpose: Users need a clear walkthrough of the automated deployment process with expected output at each phase. The existing docs reference old manual steps instead of the new checkpoint-based orchestration.

Output: Updated Deployment and Verification sections in SELFHOSTED_DEPLOYMENT.md

Note: This plan modifies SELFHOSTED_DEPLOYMENT.md (Deployment section, lines 195-267) which is separate from the Prerequisites section modified in Plan 37-01 (lines 42-103). The sections do not overlap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/SELFHOSTED_DEPLOYMENT.md
@scripts/deploy-automated.sh
@scripts/verify-deployment.sh
@scripts/post-deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Deployment Section with Automated Workflow</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Replace the Deployment section (lines 195-267) of docs/SELFHOSTED_DEPLOYMENT.md with a comprehensive step-by-step for the new automated workflow:

```markdown
## Deployment

### Step 1: Clone Repository

```bash
ssh root@YOUR_SERVER_IP
git clone https://github.com/your-org/freshtrack-pro.git /opt/freshtrack-pro
cd /opt/freshtrack-pro
```

### Step 2: Run Automated Deployment

```bash
chmod +x scripts/deploy-automated.sh
sudo ./scripts/deploy-automated.sh
```

The script orchestrates 5 phases with checkpoint-based recovery:

| Phase | Name | What It Does | Duration |
|-------|------|--------------|----------|
| 1 | Pre-flight | Validates RAM, disk, network, OS | ~10 sec |
| 2 | Prerequisites | Installs Docker, UFW, fail2ban, jq | 2-5 min |
| 3 | Configuration | Prompts for domain, email, Stack Auth | Interactive |
| 4 | Deployment | Calls deploy.sh (builds, migrates, starts) | 5-15 min |
| 5 | Health Verification | Waits for services to report healthy | 1-5 min |

**Total time:** 15-30 minutes for first deployment

### Step 3: Follow Interactive Prompts

During the Configuration phase, you'll be prompted for:

```
Enter your domain name (e.g., app.freshtrack.io): _
Enter admin email (for SSL certificates): _
Enter Stack Auth Project ID: _
Enter Stack Auth Publishable Key: _
Enter Stack Auth Secret Key: _
```

**Tip:** Have your Stack Auth credentials ready before starting.

### Step 4: Monitor Progress

The script provides real-time progress output:

```
========================================
FreshTrack Pro Automated Deployment
========================================

Start time: 2026-01-29 10:00:00

[1/5] Pre-flight checks...
  ✓ RAM: 8GB (minimum: 4GB)
  ✓ Disk: 100GB free (minimum: 10GB)
  ✓ OS: Ubuntu 24.04 LTS
  ✓ Network: Can reach docker.com

[2/5] Installing prerequisites...
  ✓ Docker installed
  ✓ UFW firewall configured
  ✓ fail2ban installed

[3/5] Configuration...
  ✓ Domain configured: app.example.com
  ✓ Secrets generated

[4/5] Deploying services...
  ✓ Building images...
  ✓ Running migrations...
  ✓ Starting services...

[5/5] Verifying health...
  Waiting for backend... (attempt 1/60)
  Waiting for backend... (attempt 2/60)
  ✓ All services healthy
```

### Checkpoint-Based Recovery

If deployment fails or is interrupted, simply re-run the script:

```bash
sudo ./scripts/deploy-automated.sh
```

The script automatically resumes from the last successful checkpoint. Completed phases are skipped.

**Example recovery output:**
```
[1/5] Pre-flight checks... SKIPPED (checkpoint exists)
[2/5] Installing prerequisites... SKIPPED (checkpoint exists)
[3/5] Configuration... SKIPPED (checkpoint exists)
[4/5] Deploying services... Resuming...
```

**To start fresh (clear all checkpoints):**
```bash
sudo ./scripts/deploy-automated.sh --reset
```
```

Also update the Deployment Output subsection to match the actual output from deploy-automated.sh (current lines 214-244).
  </action>
  <verify>
Verify deployment walkthrough is complete:
- grep "Checkpoint-Based Recovery" docs/SELFHOSTED_DEPLOYMENT.md (should find section)
- grep "5 phases" docs/SELFHOSTED_DEPLOYMENT.md OR grep "Phase | Name" docs/SELFHOSTED_DEPLOYMENT.md (should find table)
- grep "\-\-reset" docs/SELFHOSTED_DEPLOYMENT.md (should find reset option)
  </verify>
  <done>Deployment section documents the 5-phase automated workflow with expected output and recovery instructions</done>
</task>

<task type="auto">
  <name>Task 2: Update Verification and Post-Deployment Sections</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Update the Verification section (lines 269-329) and Post-Deployment section (lines 331-396) to document the new scripts:

**Verification Section:**

```markdown
## Verification

After deployment completes, run the verification script to validate all components:

```bash
./scripts/verify-deployment.sh your-domain.com
```

The script performs 6 verification checks:

| Check | Code | What It Validates |
|-------|------|-------------------|
| Service Health | VERIFY-01 | Backend, frontend, worker endpoints return 200 |
| SSL Certificate | VERIFY-02 | Certificate valid, trusted, >30 days until expiry |
| Dashboard Access | VERIFY-03 | Dashboard accessible via HTTPS (curl 200 OK) |
| E2E Pipeline | VERIFY-04 | Sensor data flows through system (if TTN configured) |
| Monitoring Stack | VERIFY-05 | Prometheus and Grafana accessible |
| Consecutive Health | VERIFY-06 | Dashboard passes 3 consecutive health checks |

**Expected output:**
```
========================================
FreshTrack Pro Deployment Verification
========================================
Domain: app.example.com

==> Checking container status...
  ✓ backend: running
  ✓ postgres: running
  ✓ redis: running
  ✓ caddy: running

==> VERIFY-01: Checking all service endpoints...
  ✓ Backend API is healthy (HTTP 200)
  ✓ Frontend is healthy (HTTP 200)

==> VERIFY-02: Validating SSL certificate...
  ✓ SSL Certificate valid (87 days remaining)

==> VERIFY-03 + VERIFY-06: Dashboard accessibility (3 consecutive passes)...
  [PASS] Attempt 1: consecutive 1/3
  [PASS] Attempt 2: consecutive 2/3
  [PASS] Attempt 3: consecutive 3/3
  ✓ Dashboard verified (3 consecutive passes)

==> VERIFY-05: Checking monitoring stack...
  ✓ Prometheus is healthy (HTTP 200)
  ✓ Grafana is healthy (HTTP 200)

========================================
       DEPLOYMENT VERIFIED & LIVE
========================================
```

### Manual Verification

You can also verify manually:

```bash
# Check service health
curl https://your-domain.com/api/health

# Check SSL certificate
echo | openssl s_client -connect your-domain.com:443 2>/dev/null | openssl x509 -noout -dates

# Check container status
docker compose ps
```
```

**Post-Deployment Section:**

```markdown
## Post-Deployment

Run the post-deployment script to complete setup:

```bash
./scripts/post-deploy.sh your-domain.com
```

The script performs 5 setup steps:

| Step | Code | What It Does |
|------|------|--------------|
| URL Summary | POST-01 | Displays all service URLs |
| Credentials | POST-02 | Shows credentials (terminal only, not logged) |
| Demo Data | POST-03 | Seeds sample organization and sensor data |
| Grafana Note | POST-04 | Confirms dashboards are provisioned |
| Next Steps | POST-05 | Displays 5-step onboarding guide |

**Expected output:**
```
========================================
FreshTrack Pro Post-Deployment Setup
========================================
Domain: app.example.com

==> POST-01: Displaying service URLs...

  Dashboard:  https://app.example.com
  API:        https://app.example.com/api/health
  Grafana:    https://app.example.com/grafana
  Prometheus: https://app.example.com/prometheus
  Bull Board: https://app.example.com/api/admin/queues

==> POST-02: Displaying credentials (terminal only)...
========================================
  CREDENTIAL SUMMARY (Terminal Only)
========================================
PostgreSQL: abcd...wxyz
Grafana:    efgh...uvwx
...

==> POST-03: Seeding demo data...
  ✓ Demo organization created
  ✓ Sample site created
  ✓ Sensor readings seeded

==> POST-04: Grafana dashboards...
  Pre-configured dashboards automatically provisioned:
    - FreshTrack Pro Overview
    - FreshTrack Sensor Metrics

==> POST-05: Next steps...
========================================
       NEXT STEPS
========================================
  1. Sign up at https://app.example.com/signup
  2. Create organization in dashboard
  3. Invite team members
  4. Configure TTN integration
  5. Set up alerting rules
```

### Access Your Application

After post-deployment completes:

| Service | URL | Credentials |
|---------|-----|-------------|
| Dashboard | https://your-domain.com | Sign up to create admin |
| Grafana | https://your-domain.com/grafana | admin / (from secrets) |
| Prometheus | https://your-domain.com/prometheus | None (internal) |
| Bull Board | https://your-domain.com/api/admin/queues | None (admin only) |
```

Preserve the existing subsections for "Access Monitoring", "SSH Tunnel for Prometheus", "Set Up Backups", etc. but ensure they reference the correct URLs and scripts.
  </action>
  <verify>
Verify verification and post-deployment sections are complete:
- grep "VERIFY-01" docs/SELFHOSTED_DEPLOYMENT.md (should find verification codes)
- grep "POST-01" docs/SELFHOSTED_DEPLOYMENT.md (should find post-deploy codes)
- grep "verify-deployment.sh" docs/SELFHOSTED_DEPLOYMENT.md (should find script reference)
- grep "post-deploy.sh" docs/SELFHOSTED_DEPLOYMENT.md (should find script reference)
  </verify>
  <done>Verification and Post-Deployment sections document the new scripts with expected output</done>
</task>

</tasks>

<verification>
1. Deployment walkthrough is complete:
   - 5-phase process documented with table
   - Expected output shown for each phase
   - Checkpoint recovery explained
   - --reset option documented

2. Verification section documents verify-deployment.sh:
   - 6 verification checks explained (VERIFY-01 to VERIFY-06)
   - Expected output shown

3. Post-deployment section documents post-deploy.sh:
   - 5 setup steps explained (POST-01 to POST-05)
   - Expected output shown
   - Service URLs and access documented
</verification>

<success_criteria>
- User can follow step-by-step from `git clone` to running application
- User understands what each deployment phase does
- User knows what output to expect during deployment
- User can verify deployment succeeded using verify-deployment.sh
- User can complete setup using post-deploy.sh
</success_criteria>

<output>
After completion, create `.planning/phases/37-documentation/37-02-SUMMARY.md`
</output>
