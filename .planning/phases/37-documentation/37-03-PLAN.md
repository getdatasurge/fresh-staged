---
phase: 37-documentation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/SELFHOSTED_DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - 'User can identify and fix all pre-flight failures (RAM below 8GB, disk below 10GB, network unreachable)'
    - 'User can identify and fix all checkpoint recovery failures (corrupted state, permission issues, hung resume)'
    - 'User can identify and fix all VERIFY-* failures using error reference table (VERIFY-01 through VERIFY-06)'
    - 'User can recover from checkpoint failures using --reset or manual cleanup'
  artifacts:
    - path: 'docs/SELFHOSTED_DEPLOYMENT.md'
      provides: 'Comprehensive troubleshooting playbook'
      contains: 'Checkpoint'
  key_links:
    - from: 'docs/SELFHOSTED_DEPLOYMENT.md troubleshooting'
      to: 'scripts/deploy-automated.sh'
      via: 'error resolution steps'
      pattern: 'deploy-automated.sh'
---

<objective>
Enhance troubleshooting documentation (DOCS-03) so users can diagnose and fix common deployment failures.

Purpose: Users need a comprehensive playbook to self-diagnose issues. The existing troubleshooting section covers basics but doesn't document checkpoint failures, preflight failures, or the new verification error codes.

Output: Enhanced Troubleshooting section in SELFHOSTED_DEPLOYMENT.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/SELFHOSTED_DEPLOYMENT.md
@scripts/deploy-automated.sh
@scripts/lib/preflight-lib.sh
@scripts/verify-deployment.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pre-flight and Checkpoint Failure Sections</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Enhance the Troubleshooting section (starting at line 515) of docs/SELFHOSTED_DEPLOYMENT.md. Add new subsections BEFORE the existing "DNS Check Fails" subsection:

````markdown
## Troubleshooting

This section covers common deployment issues and their solutions, organized by deployment phase.

### Quick Diagnosis

Before diving into specific issues, gather diagnostic information:

```bash
# Check deployment checkpoint state
cat .deploy-state/checkpoints.txt 2>/dev/null || echo "No checkpoints found"

# Check which phase failed (look for last successful checkpoint)
ls -la .deploy-state/

# Check service status
docker compose ps

# Check recent logs
docker compose logs --tail=50
```
````

### Pre-flight Failures

Pre-flight checks validate your system meets minimum requirements before deployment begins.

#### "Insufficient RAM" Error

**Symptom:** `Pre-flight failed: RAM 4GB is below minimum 8GB`

**Cause:** System has less than 8GB RAM (FreshTrack Pro requires 8GB minimum)

**Solution:**

1. Check current RAM: `free -h`
2. Either:
   - Upgrade server to 8GB+ RAM, or
   - Set override (not recommended): `PREFLIGHT_SKIP_RAM=true ./scripts/deploy-automated.sh`

**Warning:** Running with less than 8GB RAM may cause OOM kills during deployment.

#### "Insufficient Disk Space" Error

**Symptom:** `Pre-flight failed: Disk space 8GB is below minimum 10GB`

**Cause:** Less than 10GB free disk space

**Solution:**

```bash
# Check disk usage
df -h

# Clean up Docker (if previous failed deployments)
docker system prune -a

# Clean up apt cache
sudo apt clean

# Retry deployment
sudo ./scripts/deploy-automated.sh
```

#### "Network Unreachable" Error

**Symptom:** `Pre-flight failed: Cannot reach docker.com`

**Cause:** Server cannot reach external networks (required for Docker install, apt packages)

**Solution:**

1. Check DNS resolution: `dig docker.com`
2. Check firewall outbound rules: `sudo ufw status`
3. Check if behind proxy: configure `HTTP_PROXY` if needed
4. Test connectivity: `curl -I https://docker.com`

### Checkpoint Recovery Failures

The deployment script uses checkpoints to track progress. If a checkpoint is corrupted or stale, deployment may fail to resume correctly.

#### "Checkpoint exists but state is invalid"

**Symptom:** Script says checkpoint exists but deployment state is inconsistent

**Solution:**

```bash
# View checkpoint state
cat .deploy-state/checkpoints.txt

# Clear specific checkpoint (e.g., deploy-deployment)
rm .deploy-state/checkpoints.txt  # Clears all checkpoints

# Or reset completely
sudo ./scripts/deploy-automated.sh --reset
```

#### Script Hangs at "Resuming from checkpoint"

**Symptom:** Script appears stuck after detecting checkpoint

**Cause:** Previous deployment left services in partial state

**Solution:**

```bash
# Stop all containers
docker compose down --timeout 30

# Clear checkpoints
rm -rf .deploy-state/checkpoints.txt

# Retry
sudo ./scripts/deploy-automated.sh
```

#### "Checkpoint file not writable"

**Symptom:** `Error: Cannot write to .deploy-state/checkpoints.txt`

**Cause:** Permission issues (usually when script was run as different user)

**Solution:**

```bash
# Fix ownership
sudo chown -R $(whoami):$(whoami) .deploy-state/

# Or remove and let script recreate
sudo rm -rf .deploy-state/
sudo ./scripts/deploy-automated.sh
```

````
  </action>
  <verify>
Verify pre-flight and checkpoint sections exist:
- grep "Pre-flight Failures" docs/SELFHOSTED_DEPLOYMENT.md (should find section)
- grep "Checkpoint Recovery" docs/SELFHOSTED_DEPLOYMENT.md (should find section)
- grep "Insufficient RAM" docs/SELFHOSTED_DEPLOYMENT.md (should find subsection)
  </verify>
  <done>Pre-flight failures and checkpoint recovery troubleshooting documented</done>
</task>

<task type="auto">
  <name>Task 2: Add Verification Failure Troubleshooting</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Add verification failure troubleshooting after the existing "Health Check Fails" section (around line 555-606). Insert a new section for verify-deployment.sh failures:

```markdown
### Verification Script Failures

The `verify-deployment.sh` script performs 6 checks. Here's how to troubleshoot each:

#### VERIFY-01: Service Health Endpoint Failures

**Symptom:** `Backend API verification failed after 3 attempts (Last status: 000)`

**Cause:** Backend not responding or unreachable

**Solution:**
```bash
# Check if backend container is running
docker compose ps backend

# Check backend logs for errors
docker compose logs --tail=100 backend

# Common issues:
# - Database not ready: wait 30 seconds, retry
# - Missing env vars: check .env.production
# - Port conflict: check `lsof -i :3000`
````

#### VERIFY-02: SSL Certificate Failures

**Symptom:** `SSL Certificate EXPIRED` or `Cannot connect to https://domain`

**Causes and solutions:**

1. **Certificate not issued yet:**

   ```bash
   # Check Caddy logs
   docker compose logs caddy | grep -i "certificate"

   # Wait for Let's Encrypt (can take 1-2 minutes on first deploy)
   sleep 120
   ./scripts/verify-deployment.sh your-domain.com
   ```

2. **DNS not pointing to server:**

   ```bash
   # Check DNS resolution
   dig your-domain.com +short

   # Should return your server IP
   curl -s ifconfig.me
   ```

3. **Port 80 blocked (Let's Encrypt needs HTTP-01 challenge):**

   ```bash
   # Check firewall
   sudo ufw status | grep 80

   # Should show: 80/tcp ALLOW Anywhere
   ```

#### VERIFY-03/VERIFY-06: Dashboard Accessibility Failures

**Symptom:** `Dashboard failed to achieve 3 consecutive passes`

**Cause:** Dashboard returning non-200 responses intermittently

**Solution:**

```bash
# Check what status code is returned
curl -I https://your-domain.com

# Check Caddy proxy logs
docker compose logs caddy

# Check frontend container
docker compose logs frontend

# Common issues:
# - Frontend build failed: check for npm errors in logs
# - Caddy misconfigured: check Caddyfile syntax
```

#### VERIFY-04: E2E Pipeline Test Failures

**Symptom:** `E2E sensor pipeline test failed`

**Note:** This test only runs if `TTN_WEBHOOK_SECRET` is set.

**Solution:**

```bash
# Check if TTN is configured
grep TTN_WEBHOOK_SECRET .env.production

# If not using TTN, this test is skipped (normal)
# If using TTN, check webhook endpoint:
curl -X POST https://your-domain.com/api/webhooks/ttn \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

#### VERIFY-05: Monitoring Stack Failures

**Symptom:** `Prometheus verification failed` or `Grafana verification failed`

**Note:** Monitoring failures are warnings, not blockers.

**Solution:**

```bash
# Check Prometheus
docker compose logs prometheus

# Check Grafana
docker compose logs grafana

# Verify monitoring URLs (may require auth)
curl -I https://your-domain.com/prometheus/-/healthy
curl -I https://your-domain.com/grafana/api/health
```

````
  </action>
  <verify>
Verify verification troubleshooting exists:
- grep "VERIFY-01" docs/SELFHOSTED_DEPLOYMENT.md (should find in troubleshooting)
- grep "VERIFY-02" docs/SELFHOSTED_DEPLOYMENT.md (should find SSL troubleshooting)
- grep "VERIFY-05" docs/SELFHOSTED_DEPLOYMENT.md (should find monitoring troubleshooting)
  </verify>
  <done>Verification failures documented with specific solutions for each VERIFY-* code</done>
</task>

<task type="auto">
  <name>Task 3: Add Error Reference Table and Quick Fixes</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Add an error reference table at the END of the Troubleshooting section (before the Maintenance section). This provides quick lookup:

```markdown
### Error Quick Reference

| Error Message | Phase | Likely Cause | Quick Fix |
|---------------|-------|--------------|-----------|
| `Pre-flight failed: RAM below minimum` | 1 | Insufficient RAM | Upgrade to 8GB+ |
| `Pre-flight failed: Disk below minimum` | 1 | Insufficient disk | Run `docker system prune -a` |
| `Cannot reach docker.com` | 1 | Network blocked | Check firewall outbound |
| `Docker install failed` | 2 | apt lock or network | Wait 5 min, retry |
| `UFW configuration failed` | 2 | UFW not installed | `apt install ufw` |
| `Domain validation failed` | 3 | Invalid domain format | Use FQDN like app.example.com |
| `DNS resolution failed` | 4 | DNS not propagated | Wait, check `dig domain` |
| `Health check failed after N attempts` | 5 | Service not starting | Check `docker compose logs` |
| `VERIFY-01: Backend unhealthy` | Verify | Backend error | `docker compose logs backend` |
| `VERIFY-02: SSL invalid` | Verify | Cert not issued | Check Caddy logs, port 80 |
| `VERIFY-03: Dashboard 502` | Verify | Frontend not ready | Wait 60s, retry |
| `POST-03: Seed failed` | Post | DB not ready | `./scripts/seed-demo-data.sh` |

### Getting Help

If you cannot resolve an issue:

1. **Gather diagnostics:**
   ```bash
   # Create diagnostic bundle
   mkdir -p /tmp/freshtrack-diag
   docker compose ps > /tmp/freshtrack-diag/containers.txt
   docker compose logs --tail=200 > /tmp/freshtrack-diag/logs.txt
   cat .deploy-state/checkpoints.txt > /tmp/freshtrack-diag/checkpoints.txt 2>/dev/null
   cat /etc/os-release > /tmp/freshtrack-diag/os.txt
   free -h > /tmp/freshtrack-diag/memory.txt
   df -h > /tmp/freshtrack-diag/disk.txt
````

2. **Check documentation:**
   - [SSL Certificates](SSL_CERTIFICATES.md) - Certificate troubleshooting
   - [Database Operations](DATABASE.md) - Database issues
   - [Production Deployment](PRODUCTION_DEPLOYMENT.md) - Advanced configuration

3. **Report issue:**
   - GitHub Issues: Include diagnostic bundle
   - Email: admin@yourdomain.com

```
  </action>
  <verify>
Verify error reference exists:
- grep "Error Quick Reference" docs/SELFHOSTED_DEPLOYMENT.md (should find table)
- grep "Getting Help" docs/SELFHOSTED_DEPLOYMENT.md (should find section)
- grep "diagnostic bundle" docs/SELFHOSTED_DEPLOYMENT.md (should find instructions)
  </verify>
  <done>Error reference table and help section provide quick lookup for all common errors</done>
</task>

</tasks>

<verification>
1. Pre-flight failures documented:
   - RAM, disk, network issues covered
   - Solutions provided with commands

2. Checkpoint failures documented:
   - Recovery steps clear
   - --reset option explained

3. Verification failures documented:
   - All VERIFY-* codes explained
   - Specific solutions for each

4. Error reference table provides quick lookup:
   - Error message to cause mapping
   - Quick fix for each error
</verification>

<success_criteria>
- User can identify failure type from error message
- User can find specific solution for each failure
- User can run diagnostic commands to gather information
- User can recover from any common failure without external help
</success_criteria>

<output>
After completion, create `.planning/phases/37-documentation/37-03-SUMMARY.md`
</output>
```
