---
wave: 1
depends_on: []
files_modified:
  - backend/tests/api/ttn-devices.test.ts
autonomous: true
---

# Plan 44-01: Mock Subscription Middleware in TTN Device Tests

## Objective

Fix 15 failing tests in `ttn-devices.test.ts` by mocking the `requireSensorCapacity` middleware that currently throws unhandled database errors.

## Context

- Tests mock auth (JWT, user service) but not subscription middleware
- `requireSensorCapacity` middleware makes database queries
- Without database mocking, queries fail â†’ 500 errors
- Tests expect 201/400 but get 500

## Tasks

<task id="1">
Add subscription middleware mock to test file

Add to the mock section near the top of the file (after line 36):

```typescript
// Mock subscription middleware (no-op for unit tests)
vi.mock('../../src/middleware/subscription.js', () => ({
  requireSensorCapacity: vi.fn((_req, _reply, done) => {
    if (typeof done === 'function') done();
  }),
  requireActiveSubscription: vi.fn((_req, _reply, done) => {
    if (typeof done === 'function') done();
  }),
}));
```

This follows the same pattern as the JWT and user service mocks.
</task>

<task id="2">
Run tests to verify all 45 pass

```bash
cd backend && npm test -- ttn-devices
```

Expected: 45/45 tests passing
</task>

## Verification

```bash
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npm test -- ttn-devices 2>&1 | tail -20
```

**Success criteria:**

- [ ] No 500 status code errors in test output
- [ ] All 45 tests pass (currently 30/45)
- [ ] Test output shows `45 tests | 0 failed`

## must_haves

1. All 15 previously failing tests now pass
2. No regression in the 30 tests that were passing
3. Mock follows existing patterns in the test file
