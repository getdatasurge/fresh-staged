---
phase: 02-authentication-rbac
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/plugins/auth.plugin.ts
  - backend/src/middleware/auth.ts
  - backend/src/middleware/index.ts
autonomous: true

must_haves:
  truths:
    - "Protected routes reject requests without Authorization header"
    - "Invalid or expired tokens return 401 Unauthorized"
    - "Valid tokens populate request.user with user info"
  artifacts:
    - path: "backend/src/plugins/auth.plugin.ts"
      provides: "Fastify plugin that decorates request with user property"
      exports: ["default (fp wrapped plugin)"]
    - path: "backend/src/middleware/auth.ts"
      provides: "requireAuth preHandler hook for JWT validation"
      exports: ["requireAuth"]
    - path: "backend/src/middleware/index.ts"
      provides: "Barrel export for all middleware"
      exports: ["requireAuth"]
  key_links:
    - from: "backend/src/middleware/auth.ts"
      to: "backend/src/utils/jwt.ts"
      via: "verifyAccessToken import"
      pattern: "import.*verifyAccessToken.*from.*jwt"
    - from: "backend/src/plugins/auth.plugin.ts"
      to: "fastify-plugin"
      via: "fp wrapper"
      pattern: "fp\\(.*\\)"
---

<objective>
Create the auth plugin and requireAuth middleware for JWT-based authentication.

Purpose: Enable routes to require authentication by adding a preHandler hook that validates JWT tokens and populates request.user context.

Output: A Fastify plugin that decorates requests, and a requireAuth middleware that validates tokens and returns 401 for invalid/missing tokens.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-rbac/02-RESEARCH.md

# Type and utility context
@backend/src/types/auth.ts (from 02-01 or create if running parallel)
@backend/src/utils/jwt.ts (from 02-01 or create if running parallel)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth plugin with request decoration</name>
  <files>backend/src/plugins/auth.plugin.ts</files>
  <action>
Create `backend/src/plugins/` directory if it doesn't exist.

Create `backend/src/plugins/auth.plugin.ts`:

1. Import fp from 'fastify-plugin'
2. Import FastifyInstance from 'fastify'

3. Create async authPlugin function:
   - Takes fastify: FastifyInstance parameter
   - Decorates request with user property: `fastify.decorateRequest('user', null)`
   - The null decoration preserves V8 object shape optimization (per research)

4. Export default fp wrapped plugin:
   ```typescript
   export default fp(authPlugin, {
     name: 'auth-plugin',
     dependencies: [],
   });
   ```

IMPORTANT: This plugin ONLY decorates the request. It does NOT validate tokens - that's the middleware's job.

The decoration must happen via plugin so it runs once at app startup, not on every request.
  </action>
  <verify>
Run `pnpm tsc --noEmit` in backend directory - no type errors.
File exports default fp-wrapped plugin.
Plugin calls decorateRequest with null for user.
  </verify>
  <done>
Auth plugin exists that decorates request.user with null at startup.
Plugin is wrapped with fastify-plugin for proper encapsulation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create requireAuth middleware</name>
  <files>backend/src/middleware/auth.ts</files>
  <action>
Create `backend/src/middleware/` directory if it doesn't exist.

Create `backend/src/middleware/auth.ts`:

1. Import types:
   - FastifyRequest, FastifyReply from 'fastify'
   - AuthUser from '../types/auth.js'
   - verifyAccessToken from '../utils/jwt.js'
   - jose (for error type checking)

2. Create requireAuth async function (preHandler hook signature):
   ```typescript
   export async function requireAuth(
     request: FastifyRequest,
     reply: FastifyReply
   ): Promise<void>
   ```

3. Implementation:
   a. Extract Authorization header
   b. Check for "Bearer " prefix:
      - If missing/invalid: return 401 with `{ error: 'Unauthorized', message: 'Missing or invalid Authorization header' }`

   c. Extract token (slice off "Bearer ")

   d. Try to verify token:
      - Call verifyAccessToken(token)
      - On success: Set request.user with id, email, name from payload

   e. Catch errors:
      - Check if jose.errors.JWTExpired: message = 'Token expired'
      - Otherwise: message = 'Invalid token'
      - Return 401 with `{ error: 'Unauthorized', message }`

4. The middleware sets basic user info only (id, email, name).
   Profile lookup and org context are handled by separate middleware.

Use named export, NOT default export.
  </action>
  <verify>
Run `pnpm tsc --noEmit` in backend directory - no type errors.
Function signature matches preHandler hook pattern.
Error responses use consistent format: { error, message }.
  </verify>
  <done>
requireAuth middleware validates JWT tokens and populates request.user.
Returns 401 for missing/invalid/expired tokens.
Uses jose error types to provide specific error messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update middleware barrel export with auth export</name>
  <files>backend/src/middleware/index.ts</files>
  <action>
Update `backend/src/middleware/index.ts` (created by 02-01) to add the auth export:

Replace the placeholder content with:
```typescript
// Middleware barrel export
export { requireAuth } from './auth.js';
```

This barrel export allows clean imports:
`import { requireAuth } from './middleware/index.js'`

As more middleware is added by 02-03 (rbac) and 02-04 (org-context), they will append to this file.

IMPORTANT: Use .js extensions for ESM compatibility.

Note: The file already exists from 02-01. This task updates it, not creates it.
  </action>
  <verify>
File exports requireAuth.
Import statement uses .js extension.
  </verify>
  <done>
Middleware barrel export updated with requireAuth.
requireAuth is re-exported for clean imports.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. `cd backend && pnpm tsc --noEmit` - no TypeScript errors
2. Files exist: src/plugins/auth.plugin.ts, src/middleware/auth.ts, src/middleware/index.ts
3. Plugin uses decorateRequest('user', null) pattern
4. Middleware returns proper 401 responses with { error, message } format
5. All imports use .js extensions
</verification>

<success_criteria>
- Auth plugin decorates request.user at app startup
- requireAuth middleware validates Bearer tokens
- 401 returned for missing/invalid/expired tokens
- Valid tokens populate request.user with basic info
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-rbac/02-02-SUMMARY.md`
</output>
