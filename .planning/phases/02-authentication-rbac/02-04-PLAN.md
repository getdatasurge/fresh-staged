---
phase: 02-authentication-rbac
plan: 04
type: execute
wave: 2
depends_on: ['02-01']
files_modified:
  - backend/src/middleware/org-context.ts
  - backend/src/services/user.service.ts
  - backend/src/services/index.ts
  - backend/src/middleware/index.ts
autonomous: true

must_haves:
  truths:
    - 'Organization context is validated from request path'
    - "User's role in organization is looked up from database"
    - 'Cross-organization access is blocked with 403'
    - 'Users without any org membership get 403 (must be invited first)'
    - 'Profile is auto-created when user accesses an org they are already a member of'
  artifacts:
    - path: 'backend/src/middleware/org-context.ts'
      provides: 'Organization context validation and role lookup'
      exports: ['requireOrgContext']
    - path: 'backend/src/services/user.service.ts'
      provides: 'Profile lookup and auto-creation service'
      exports: ['getOrCreateProfile', 'getUserRoleInOrg']
  key_links:
    - from: 'backend/src/middleware/org-context.ts'
      to: 'backend/src/services/user.service.ts'
      via: 'getUserRoleInOrg call'
      pattern: 'getUserRoleInOrg'
    - from: 'backend/src/services/user.service.ts'
      to: 'backend/src/db/schema/users.ts'
      via: 'profiles and userRoles tables'
      pattern: 'profiles|userRoles'
---

<objective>
Create organization context middleware and user profile service for tenant isolation.

Purpose: Ensure every multi-tenant request validates that the user has access to the requested organization, and provide profile lookup/creation for users who are already organization members.

Output: Organization context middleware that sets request.user.organizationId and role, plus a user service for profile management.

**Important Flow Clarification:**

- Users MUST be invited to an organization first (via invitation flow, which creates a userRoles record)
- When a user accesses an org endpoint, requireOrgContext checks userRoles for membership
- If userRoles exists (user is a member), getOrCreateProfile is called to ensure a local profile exists
- If userRoles does NOT exist (user is not a member), the request is rejected with 403
- This means: No "first-login creates profile in random org" - users must be invited first
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-rbac/02-RESEARCH.md

# Database schema context

@backend/src/db/schema/users.ts (profiles, userRoles tables)
@backend/src/db/client.ts (db export)
@backend/src/types/auth.ts (AuthUser, AppRole)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user service for profile and role lookups</name>
  <files>backend/src/services/user.service.ts, backend/src/services/index.ts</files>
  <action>
Create `backend/src/services/` directory if it doesn't exist.

Create `backend/src/services/user.service.ts`:

1. Import dependencies:
   - db from '../db/client.js'
   - profiles, userRoles from '../db/schema/users.js'
   - eq, and from 'drizzle-orm'
   - AppRole from '../types/auth.js'

2. Create getOrCreateProfile function:

   ```typescript
   export async function getOrCreateProfile(
     stackAuthUserId: string,
     organizationId: string,
     email?: string,
     name?: string,
   ): Promise<{ id: string; isNew: boolean }>;
   ```

   **Precondition:** This function is ONLY called after requireOrgContext has verified
   that the user has a userRoles record for this organization (i.e., they were invited
   and accepted). It is NOT called for users who have no org membership.

   Implementation:
   a. Query for existing profile by userId (Stack Auth ID):

   ```typescript
   const [existing] = await db
     .select({ id: profiles.id })
     .from(profiles)
     .where(eq(profiles.userId, stackAuthUserId))
     .limit(1);
   ```

   b. If exists: return { id: existing.id, isNew: false }

   c. If not exists: Insert new profile with:
   - userId: stackAuthUserId
   - organizationId (the org they are accessing - they are already a member via userRoles)
   - email: email || ''
   - fullName: name

   ```typescript
   const [created] = await db
     .insert(profiles)
     .values({
       userId: stackAuthUserId,
       organizationId,
       email: email || '',
       fullName: name,
     })
     .returning({ id: profiles.id });
   ```

   Return { id: created.id, isNew: true }

   **Note:** The organizationId here is the org the user is accessing via the API.
   The user MUST already have a userRoles record for this org (checked by requireOrgContext).
   Users without any org membership are rejected with 403 before this function is ever called.

3. Create getUserRoleInOrg function:

   ```typescript
   export async function getUserRoleInOrg(
     stackAuthUserId: string,
     organizationId: string,
   ): Promise<AppRole | null>;
   ```

   Implementation:
   a. Query userRoles for this user + org:

   ```typescript
   const [role] = await db
     .select({ role: userRoles.role })
     .from(userRoles)
     .where(
       and(eq(userRoles.userId, stackAuthUserId), eq(userRoles.organizationId, organizationId)),
     )
     .limit(1);
   ```

   b. Return role?.role or null if not found

4. Create getProfileByUserId function (helper for auth middleware):

   ```typescript
   export async function getProfileByUserId(
     stackAuthUserId: string,
   ): Promise<{ id: string; organizationId: string } | null>;
   ```

   Query profiles by userId, return id and organizationId, or null.

Create `backend/src/services/index.ts` barrel export:

```typescript
export { getOrCreateProfile, getUserRoleInOrg, getProfileByUserId } from './user.service.js';
```

  </action>
  <verify>
Run `pnpm tsc --noEmit` in backend directory - no type errors.
Functions use Drizzle ORM query patterns correctly.
Service does not import from middleware (no circular deps).
  </verify>
  <done>
User service exists with profile lookup and auto-creation.
getUserRoleInOrg returns user's role in a specific organization.
Services use .js extensions for ESM compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create organization context middleware</name>
  <files>backend/src/middleware/org-context.ts</files>
  <action>
Create `backend/src/middleware/org-context.ts`:

1. Import types and dependencies:
   - FastifyRequest, FastifyReply from 'fastify'
   - getUserRoleInOrg from '../services/user.service.js'
   - AppRole from '../types/auth.js'

2. Define generic params interface for routes with orgId:

   ```typescript
   interface OrgParams {
     organizationId: string;
   }
   ```

3. Create requireOrgContext function:

   ```typescript
   export async function requireOrgContext(
     request: FastifyRequest<{ Params: OrgParams }>,
     reply: FastifyReply,
   ): Promise<void>;
   ```

4. Implementation:
   a. Check request.user exists:
   - If not: return 401 with { error: 'Unauthorized', message: 'Authentication required' }

   b. Extract organizationId from params:

   ```typescript
   const { organizationId } = request.params;
   ```

   c. Validate organizationId exists:
   - If missing: return 400 with { error: 'Bad Request', message: 'Organization ID required in path' }

   d. Validate UUID format (optional but good practice):
   - Simple regex: /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i
   - If invalid: return 400 with { error: 'Bad Request', message: 'Invalid organization ID format' }

   e. Look up user's role in this organization:

   ```typescript
   const role = await getUserRoleInOrg(request.user.id, organizationId);
   ```

   f. If role is null (user not in org):
   - return 403 with { error: 'Forbidden', message: 'No access to this organization' }

   g. Attach org context to request.user:

   ```typescript
   request.user.organizationId = organizationId;
   request.user.role = role;
   ```

5. Note: This middleware is designed for routes like:
   - /api/orgs/:organizationId/units
   - /api/orgs/:organizationId/sites

   The preHandler order should be: [requireAuth, requireOrgContext]
   After this runs, request.user.organizationId and request.user.role are populated.
   </action>
   <verify>
   Run `pnpm tsc --noEmit` in backend directory - no type errors.
   Middleware uses generic FastifyRequest type with OrgParams.
   Returns 403 when user lacks organization access.
   Sets both organizationId and role on request.user.
   </verify>
   <done>
   Organization context middleware validates user's org membership.
   Sets request.user.organizationId and request.user.role.
   Returns 403 for cross-organization access attempts.
   </done>
   </task>

<task type="auto">
  <name>Task 3: Update middleware barrel export</name>
  <files>backend/src/middleware/index.ts</files>
  <action>
Update `backend/src/middleware/index.ts` to include org context:

```typescript
export { requireAuth } from './auth.js';
export {
  ROLE_HIERARCHY,
  requireRole,
  requireViewer,
  requireStaff,
  requireManager,
  requireAdmin,
  requireOwner,
} from './rbac.js';
export { requireOrgContext } from './org-context.js';

// Re-export types for convenience
export type { AppRole } from './rbac.js';
```

This allows routes to import the complete middleware stack:

```typescript
import { requireAuth, requireOrgContext, requireAdmin } from './middleware/index.js';

// Route usage:
fastify.delete(
  '/orgs/:organizationId/users/:userId',
  {
    preHandler: [requireAuth, requireOrgContext, requireAdmin],
  },
  handler,
);
```

  </action>
  <verify>
File exports requireOrgContext.
All imports use .js extensions.
Clean import pattern available for routes.
  </verify>
  <done>
Middleware barrel export includes all auth middleware.
Complete middleware stack available via single import.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. `cd backend && pnpm tsc --noEmit` - no TypeScript errors
2. User service functions query database correctly
3. Org context middleware sets request.user.organizationId and role
4. Returns 403 for users not in the requested organization
5. No circular dependencies between middleware and services
</verification>

<success_criteria>

- User service provides profile lookup and auto-creation
- getUserRoleInOrg queries userRoles table correctly
- Organization context middleware validates org membership
- Cross-org access blocked with 403
- All TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-rbac/02-04-SUMMARY.md`
</output>
