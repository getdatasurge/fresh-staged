---
phase: 02-authentication-rbac
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/middleware/rbac.ts
  - backend/src/middleware/index.ts
autonomous: true

must_haves:
  truths:
    - "Role hierarchy is enforced (owner > admin > manager > staff > viewer)"
    - "Insufficient role returns 403 Forbidden with clear message"
    - "Missing role returns 403 with 'No role assigned' message"
  artifacts:
    - path: "backend/src/middleware/rbac.ts"
      provides: "Role hierarchy constants and requireRole middleware factory"
      exports: ["ROLE_HIERARCHY", "AppRole", "requireRole", "requireViewer", "requireStaff", "requireManager", "requireAdmin", "requireOwner"]
  key_links:
    - from: "backend/src/middleware/rbac.ts"
      to: "backend/src/types/auth.ts"
      via: "AppRole import"
      pattern: "import.*AppRole.*from"
    - from: "backend/src/middleware/rbac.ts"
      to: "request.user.role"
      via: "role hierarchy comparison"
      pattern: "ROLE_HIERARCHY\\[request\\.user\\.role"
---

<objective>
Create RBAC middleware with role hierarchy enforcement.

Purpose: Enable routes to require specific roles, enforcing the hierarchy where higher roles (owner) have all permissions of lower roles (admin, manager, etc.).

Output: A requireRole middleware factory that checks user's role against the required minimum role using numeric hierarchy comparison.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-rbac/02-RESEARCH.md

# Existing code context
@backend/src/db/schema/enums.ts (appRoleEnum definition)
@backend/src/types/auth.ts (AuthUser with role property)
@backend/src/middleware/auth.ts (requireAuth for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create role hierarchy and requireRole middleware</name>
  <files>backend/src/middleware/rbac.ts</files>
  <action>
Create `backend/src/middleware/rbac.ts`:

1. Import types:
   - FastifyRequest, FastifyReply, preHandlerHookHandler from 'fastify'
   - AppRole from '../types/auth.js'

2. Define ROLE_HIERARCHY as const record (higher number = more permissions):
   ```typescript
   export const ROLE_HIERARCHY = {
     viewer: 1,
     staff: 2,
     manager: 3,
     admin: 4,
     owner: 5,
   } as const;
   ```

3. Re-export AppRole type from here for convenience (single import location).

4. Create requireRole factory function:
   ```typescript
   export function requireRole(minimumRole: AppRole): preHandlerHookHandler {
     return async function (
       request: FastifyRequest,
       reply: FastifyReply
     ): Promise<void> {
       // Implementation
     };
   }
   ```

5. requireRole implementation:
   a. Check request.user exists:
      - If not: return 401 with { error: 'Unauthorized', message: 'Authentication required' }

   b. Check request.user.organizationId AND request.user.role exist:
      - If either missing: return 403 with { error: 'Forbidden', message: 'Organization context required' }
      - This ensures org-context middleware ran first

   c. Get user's role level (default to 0 if not found):
      ```typescript
      const userLevel = ROLE_HIERARCHY[request.user.role as AppRole] ?? 0;
      ```

   d. Get required role level:
      ```typescript
      const requiredLevel = ROLE_HIERARCHY[minimumRole];
      ```

   e. Compare levels:
      - If userLevel < requiredLevel:
        return 403 with { error: 'Forbidden', message: `This action requires ${minimumRole} role or higher` }

6. Create convenience exports for common role checks:
   ```typescript
   export const requireViewer = requireRole('viewer');
   export const requireStaff = requireRole('staff');
   export const requireManager = requireRole('manager');
   export const requireAdmin = requireRole('admin');
   export const requireOwner = requireRole('owner');
   ```

Note: The RBAC middleware assumes org-context has already set request.user.role.
The preHandler order should be: requireAuth -> requireOrgContext -> requireRole.
  </action>
  <verify>
Run `pnpm tsc --noEmit` in backend directory - no type errors.
ROLE_HIERARCHY matches enum order in schema/enums.ts.
Function returns preHandlerHookHandler type.
Error messages include the required role name.
  </verify>
  <done>
RBAC middleware with role hierarchy enforcement exists.
requireRole factory and convenience exports (requireAdmin, etc.) are available.
Returns 403 with clear message when role is insufficient.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update middleware barrel export</name>
  <files>backend/src/middleware/index.ts</files>
  <action>
Update `backend/src/middleware/index.ts` to include RBAC exports:

```typescript
export { requireAuth } from './auth.js';
export {
  ROLE_HIERARCHY,
  requireRole,
  requireViewer,
  requireStaff,
  requireManager,
  requireAdmin,
  requireOwner,
} from './rbac.js';
```

Also re-export AppRole type for convenience:
```typescript
export type { AppRole } from './rbac.js';
```

This allows routes to import everything from one place:
`import { requireAuth, requireAdmin } from './middleware/index.js'`
  </action>
  <verify>
File exports all RBAC middleware and types.
Import paths use .js extensions.
  </verify>
  <done>
Middleware barrel export updated with all RBAC exports.
Clean single-import pattern available for routes.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. `cd backend && pnpm tsc --noEmit` - no TypeScript errors
2. ROLE_HIERARCHY values match: viewer=1, staff=2, manager=3, admin=4, owner=5
3. Error responses follow { error, message } format
4. requireRole('admin') allows owner (5 >= 4) but blocks manager (3 < 4)
5. All imports use .js extensions
</verification>

<success_criteria>
- Role hierarchy constants define 5 levels (viewer through owner)
- requireRole factory creates preHandler hooks
- Insufficient role returns 403 with descriptive message
- Convenience exports available (requireAdmin, requireOwner, etc.)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-rbac/02-03-SUMMARY.md`
</output>
