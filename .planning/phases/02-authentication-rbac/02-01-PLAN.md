---
phase: 02-authentication-rbac
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/types/auth.ts
  - backend/src/types/fastify.d.ts
  - backend/src/utils/jwt.ts
  - backend/src/utils/env-check.ts
  - backend/src/middleware/index.ts
autonomous: false # Has checkpoint for Stack Auth configuration verification

must_haves:
  truths:
    - 'STACK_AUTH_PROJECT_ID environment variable is validated at startup'
    - 'JWT tokens from Stack Auth can be verified'
    - 'JWKS keys are cached and auto-refreshed'
    - 'Invalid tokens are rejected with proper error types'
  artifacts:
    - path: 'backend/src/types/auth.ts'
      provides: 'AuthUser and StackAuthJWTPayload interfaces'
      exports: ['AuthUser', 'StackAuthJWTPayload', 'AppRole']
    - path: 'backend/src/types/fastify.d.ts'
      provides: 'FastifyRequest augmentation with user property'
      contains: "declare module 'fastify'"
    - path: 'backend/src/utils/jwt.ts'
      provides: 'JWT verification against Stack Auth JWKS'
      exports: ['verifyAccessToken', 'jwks']
  key_links:
    - from: 'backend/src/utils/jwt.ts'
      to: 'jose library'
      via: 'createRemoteJWKSet and jwtVerify'
      pattern: "jose\\.createRemoteJWKSet|jose\\.jwtVerify"
---

<objective>
Set up authentication foundation with JWT verification utilities and TypeScript types for the auth system.

Purpose: Establish the core building blocks for Stack Auth integration - type definitions for auth context and JWT verification utility that other middleware will use.

Output: Installed dependencies (jose, fastify-plugin), TypeScript interfaces for auth context, and a JWT verification utility using jose library.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-rbac/02-RESEARCH.md

# Existing code context

@backend/package.json
@backend/src/db/schema/enums.ts (for appRoleEnum reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install auth dependencies</name>
  <files>backend/package.json</files>
  <action>
Install jose and fastify-plugin packages:

```bash
cd backend && pnpm add jose fastify-plugin
```

jose 5.x is the standard for JWT verification with JWKS support (per research).
fastify-plugin is required for proper plugin encapsulation.

Do NOT install @fastify/jwt - we use jose directly for Stack Auth integration control.
</action>
<verify>
Run `pnpm list jose fastify-plugin` in backend directory - both packages should appear in output.
Check package.json contains jose and fastify-plugin in dependencies.
</verify>
<done>jose and fastify-plugin are installed in backend/package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create auth type definitions</name>
  <files>backend/src/types/auth.ts, backend/src/types/fastify.d.ts</files>
  <action>
Create `backend/src/types/` directory if it doesn't exist.

Create `backend/src/types/auth.ts` with:

- StackAuthJWTPayload interface matching Stack Auth JWT claims:
  - sub: string (user ID)
  - iss: string (issuer)
  - aud: string (audience/project ID)
  - exp: number (expiration)
  - iat: number (issued at)
  - email?: string
  - email_verified?: boolean
  - name?: string
  - selected_team_id?: string
  - is_anonymous?: boolean

- AuthUser interface for request context:
  - id: string (Stack Auth user ID from sub claim)
  - profileId?: string (local profile.id UUID)
  - email?: string
  - name?: string
  - organizationId?: string (current org context)
  - role?: AppRole (role in current org)

- AppRole type: 'owner' | 'admin' | 'manager' | 'staff' | 'viewer'

Create `backend/src/types/fastify.d.ts` with FastifyRequest module augmentation:

- Add user?: AuthUser to FastifyRequest interface
- Import AuthUser from './auth.js'

IMPORTANT: Use .js extensions in imports for ESM compatibility (established pattern in 01-05).
</action>
<verify>
Run `pnpm tsc --noEmit` in backend directory - no type errors related to auth types.
Files exist at expected paths.
</verify>
<done>
Auth type definitions exist with AuthUser interface and FastifyRequest augmentation.
TypeScript compiles without errors.
</done>
</task>

<task type="auto">
  <name>Task 3: Create JWT verification utility</name>
  <files>backend/src/utils/jwt.ts</files>
  <action>
Create `backend/src/utils/` directory if it doesn't exist.

Create `backend/src/utils/jwt.ts` with:

1. Environment config:
   - STACK_AUTH_PROJECT_ID from process.env (throw if missing)
   - JWKS_URL constructed as: `https://api.stack-auth.com/api/v1/projects/${STACK_AUTH_PROJECT_ID}/.well-known/jwks.json`

2. JWKS setup using jose.createRemoteJWKSet:
   - cooldownDuration: 30_000 (30 seconds between refreshes)
   - cacheMaxAge: 600_000 (cache for 10 minutes)
   - Export as const jwks for testing

3. verifyAccessToken async function:
   - Input: accessToken string
   - Uses jose.jwtVerify with:
     - audience validation against STACK_AUTH_PROJECT_ID
     - clockTolerance: 30 seconds (for clock skew)
   - Returns: { payload: StackAuthJWTPayload, userId: string }
   - Throws jose errors on failure (JWTExpired, JWTInvalid, etc.)

4. Export named exports (not default).

Import jose as namespace: `import * as jose from 'jose';`
Import StackAuthJWTPayload from '../types/auth.js'

Note: This utility only verifies tokens. It does NOT look up profiles or roles - that's middleware's job.
</action>
<verify>
Run `pnpm tsc --noEmit` in backend directory - compiles without errors.
File exports verifyAccessToken and jwks.
Check that jose import uses namespace pattern.
</verify>
<done>
JWT verification utility exists with JWKS caching and token verification.
TypeScript compiles without errors.
verifyAccessToken function validates audience and clock tolerance.
</done>
</task>

<task type="auto">
  <name>Task 4: Create environment validation utility</name>
  <files>backend/src/utils/env-check.ts</files>
  <action>
Create `backend/src/utils/env-check.ts` with:

1. validateStackAuthConfig function:

   ```typescript
   export interface StackAuthEnvConfig {
     projectId: string;
     jwksUrl: string;
   }

   export function validateStackAuthConfig(): StackAuthEnvConfig {
     const projectId = process.env.STACK_AUTH_PROJECT_ID;

     if (!projectId) {
       throw new Error(
         'STACK_AUTH_PROJECT_ID environment variable is required. ' +
           'Get this from Stack Auth Dashboard -> Project Settings -> Project ID',
       );
     }

     if (!/^[a-zA-Z0-9_-]+$/.test(projectId)) {
       throw new Error(
         'STACK_AUTH_PROJECT_ID has invalid format. ' +
           'Expected alphanumeric characters, underscores, or hyphens.',
       );
     }

     const jwksUrl = `https://api.stack-auth.com/api/v1/projects/${projectId}/.well-known/jwks.json`;

     return { projectId, jwksUrl };
   }
   ```

2. Optional JWKS reachability check (async):
   ```typescript
   export async function checkJwksReachable(jwksUrl: string): Promise<boolean> {
     try {
       const response = await fetch(jwksUrl, { method: 'GET' });
       if (!response.ok) {
         console.warn(
           `JWKS endpoint returned ${response.status}. Stack Auth may not be configured correctly.`,
         );
         return false;
       }
       const data = await response.json();
       if (!data.keys || !Array.isArray(data.keys)) {
         console.warn('JWKS response missing keys array');
         return false;
       }
       return true;
     } catch (error) {
       console.warn(`Could not reach JWKS endpoint: ${error}`);
       return false;
     }
   }
   ```

This utility will be called at app startup to fail fast with a clear error message if Stack Auth is not configured.
</action>
<verify>
Run `pnpm tsc --noEmit` in backend directory - compiles without errors.
File exports validateStackAuthConfig and checkJwksReachable.
</verify>
<done>
Environment validation utility created.
validateStackAuthConfig throws clear error if STACK_AUTH_PROJECT_ID is missing.
checkJwksReachable provides optional runtime JWKS endpoint verification.
</done>
</task>

<task type="auto">
  <name>Task 5: Create middleware barrel export placeholder</name>
  <files>backend/src/middleware/index.ts</files>
  <action>
Create `backend/src/middleware/` directory if it doesn't exist.

Create `backend/src/middleware/index.ts` as a placeholder barrel export file:

```typescript
// Middleware barrel export
// Wave 2 plans (02-02, 02-03, 02-04) will add their exports here

// Placeholder - will be populated by subsequent plans
export {};
```

This file MUST exist before Wave 2 plans run because:

- 02-02 adds requireAuth export
- 02-03 adds RBAC exports
- 02-04 adds requireOrgContext export

All three plans run in parallel (Wave 2), so the file must exist beforehand.
</action>
<verify>
File exists at backend/src/middleware/index.ts.
Directory backend/src/middleware/ exists.
</verify>
<done>
Middleware barrel export file exists as placeholder.
Wave 2 plans can now safely append their exports.
</done>
</task>

<task type="checkpoint:manual">
  <name>Task 6: Verify Stack Auth project is configured</name>
  <what-built>
Stack Auth integration foundation including:
- STACK_AUTH_PROJECT_ID environment validation
- JWKS endpoint URL construction
- Optional reachability check
  </what-built>
  <how-to-verify>
1. Ensure STACK_AUTH_PROJECT_ID is set in your .env file:
   ```
   STACK_AUTH_PROJECT_ID=your_project_id_here
   ```

2. Verify the project ID by visiting the Stack Auth JWKS endpoint:

   ```
   https://api.stack-auth.com/api/v1/projects/{YOUR_PROJECT_ID}/.well-known/jwks.json
   ```

   Should return JSON with a `keys` array.

3. If you don't have a Stack Auth project yet:
   - Go to https://app.stack-auth.com
   - Create a new project
   - Copy the Project ID from Project Settings
   - Add it to your .env file
     </how-to-verify>
     <resume-signal>Type "configured" once STACK_AUTH_PROJECT_ID is set and JWKS endpoint is reachable, or describe any issues.</resume-signal>
     </task>

</tasks>

<verification>
Overall phase checks:
1. `cd backend && pnpm tsc --noEmit` - no TypeScript errors
2. `pnpm list jose fastify-plugin` - packages installed
3. Files exist: src/types/auth.ts, src/types/fastify.d.ts, src/utils/jwt.ts, src/utils/env-check.ts
4. Verify imports use .js extensions for ESM compatibility
5. STACK_AUTH_PROJECT_ID is set in environment
6. JWKS endpoint is reachable (optional but recommended)
</verification>

<success_criteria>

- jose and fastify-plugin installed
- AuthUser and StackAuthJWTPayload types defined
- FastifyRequest augmented with user property
- verifyAccessToken function ready for use by auth middleware
- validateStackAuthConfig utility validates STACK_AUTH_PROJECT_ID at startup
- STACK_AUTH_PROJECT_ID environment variable is set (verified by checkpoint)
- All TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-rbac/02-01-SUMMARY.md`
</output>
