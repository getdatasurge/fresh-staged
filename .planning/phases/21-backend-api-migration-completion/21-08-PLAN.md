---
phase: 21-backend-api-migration-completion
plan: 08
type: execute
wave: 5
depends_on: ["21-06", "21-07"]
files_modified:
  - src/hooks/useTTNSettings.ts
  - src/hooks/useTTNOperations.ts
  - src/hooks/useEscalationContacts.ts
autonomous: true

must_haves:
  truths:
    - "useTTNSettings hook uses tRPC instead of Supabase edge function"
    - "useTTNOperations hook uses tRPC instead of Supabase edge function"
    - "useEscalationContacts hook uses tRPC instead of direct Supabase queries"
  artifacts:
    - path: "src/hooks/useTTNSettings.ts"
      provides: "tRPC-based TTN settings hooks"
      contains: "useTRPC"
    - path: "src/hooks/useTTNOperations.ts"
      provides: "tRPC-based TTN operations hooks"
      contains: "useTRPC"
    - path: "src/hooks/useEscalationContacts.ts"
      provides: "tRPC-based escalation contacts hooks"
      contains: "useTRPC"
  key_links:
    - from: "src/hooks/useTTNSettings.ts"
      to: "trpc.ttnSettings"
      via: "useTRPC import"
      pattern: "trpc\\.ttnSettings\\.(get|update|test)"
    - from: "src/hooks/useEscalationContacts.ts"
      to: "trpc.escalationContacts"
      via: "useTRPC import"
      pattern: "trpc\\.escalationContacts\\.(list|create|update|delete)"
---

<objective>
Migrate first batch of frontend hooks from Supabase to tRPC.

Purpose: Remove Supabase edge function calls and direct queries from useTTNSettings, useTTNOperations, and useEscalationContacts.

Output: 3 hooks migrated to tRPC, no Supabase imports in these files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-VERIFICATION.md

Reference tRPC hook patterns from Phase 20:
@src/hooks/useSites.ts
@src/hooks/useAlerts.ts

Reference hooks to migrate:
@src/hooks/useTTNSettings.ts
@src/hooks/useTTNOperations.ts
@src/hooks/useEscalationContacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useTTNSettings hook to tRPC</name>
  <files>src/hooks/useTTNSettings.ts</files>
  <action>
Migrate src/hooks/useTTNSettings.ts to use tRPC instead of Supabase edge function:

1. Remove Supabase import:
```typescript
- import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
```

2. Add tRPC import:
```typescript
+ import { useTRPC } from "@/lib/trpc";
```

3. Update file header comment to remove TODO:
```typescript
/**
 * TTN Settings Hooks
 *
 * Migrated to tRPC in Phase 21
 * Uses ttnSettings router for settings management
 */
```

4. Rewrite loadSettings function using tRPC:

Replace the entire loadSettings callback:
```typescript
const loadSettings = useCallback(async () => {
  if (!organizationId || !user) return;

  setIsLoading(true);
  try {
    // Query via tRPC
    const data = await trpc.ttnSettings.get.query({
      organizationId: organizationId,
    });

    if (data) {
      // Map legacy status values (already handled by backend)
      const loadedSettings: TTNSettings = {
        exists: true,
        is_enabled: data.is_enabled ?? false,
        ttn_region: data.ttn_region ?? null,
        ttn_application_id: data.ttn_application_id ?? null,
        provisioning_status: data.provisioning_status as TTNSettings['provisioning_status'],
        provisioning_step: data.provisioning_step ?? null,
        provisioning_started_at: data.provisioning_started_at ?? null,
        provisioning_last_heartbeat_at: data.provisioning_last_heartbeat_at ?? null,
        provisioning_attempt_count: data.provisioning_attempt_count ?? 0,
        provisioning_error: data.provisioning_error ?? null,
        last_http_status: data.last_http_status ?? null,
        last_http_body: data.last_http_body ?? null,
        provisioning_last_step: data.provisioning_last_step ?? null,
        provisioning_can_retry: data.provisioning_can_retry ?? true,
        provisioned_at: data.provisioned_at ?? null,
        has_api_key: data.has_api_key ?? false,
        api_key_last4: data.api_key_last4 ?? null,
        api_key_updated_at: data.api_key_updated_at ?? null,
        has_webhook_secret: data.has_webhook_secret ?? false,
        webhook_secret_last4: data.webhook_secret_last4 ?? null,
        webhook_url: data.webhook_url ?? WEBHOOK_URL,
        webhook_id: data.webhook_id ?? null,
        webhook_events: data.webhook_events ?? null,
        last_connection_test_at: data.last_connection_test_at ?? null,
        last_connection_test_result: data.last_connection_test_result ?? null,
        last_updated_source: data.last_updated_source ?? null,
        last_test_source: data.last_test_source ?? null,
      };

      setSettings(loadedSettings);
      setIsEnabled(data.is_enabled ?? false);

      // Mark context as canonical if we have valid settings from DB
      if (data.ttn_application_id && data.has_api_key) {
        const hash = hashConfigValues({
          cluster: 'nam1',
          application_id: data.ttn_application_id,
          api_key_last4: data.api_key_last4,
          is_enabled: data.is_enabled,
        });
        setCanonical(hash);
      } else {
        resetToDraft();
      }
    } else {
      // No settings exist yet
      setSettings(null);
      setIsEnabled(false);
      resetToDraft();
    }
  } catch (err) {
    console.error("Error loading TTN settings:", err);
    toast.error("Failed to load TTN settings");
    setInvalid("Failed to load TTN settings");
  } finally {
    setIsLoading(false);
  }
}, [organizationId, user, setCanonical, setInvalid, resetToDraft]);
```

5. Add trpc instance at top of hook:
```typescript
export function useTTNSettings({ organizationId }: UseTTNSettingsOptions): UseTTNSettingsReturn {
  const trpc = useTRPC();
  const [settings, setSettings] = useState<TTNSettings | null>(null);
  // ... rest of state ...
```

Note: Keep checkBootstrapHealth as-is for now (direct fetch to edge function health endpoint).
  </action>
  <verify>
File no longer imports from @/integrations/supabase/client
File imports useTRPC from @/lib/trpc
loadSettings uses trpc.ttnSettings.get.query
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useTTNSettings hook migrated to tRPC, no Supabase edge function calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate useTTNOperations hook to tRPC</name>
  <files>src/hooks/useTTNOperations.ts</files>
  <action>
Migrate src/hooks/useTTNOperations.ts to use tRPC instead of Supabase edge function:

1. Remove Supabase import:
```typescript
- import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
```

2. Add tRPC imports:
```typescript
+ import { useTRPC, useTRPCClient } from "@/lib/trpc";
```

3. Update file header comment:
```typescript
/**
 * TTN Operations Hooks
 *
 * Migrated to tRPC in Phase 21
 * Uses ttnSettings router for toggle and test operations
 *
 * Note: Provisioning operations still use edge functions (to be migrated in future phase)
 */
```

4. Remove invokeEdgeFunction helper (no longer needed for toggle/test)

5. Rewrite handleTest using tRPC:
```typescript
const handleTest = useCallback(async () => {
  if (!organizationId || !user) return;

  setIsTesting(true);
  try {
    const result = await client.ttnSettings.test.mutate({
      organizationId: organizationId,
    });

    if (result.success) {
      toast.success("Connection successful!");
    } else {
      toast.error(result.error || "Connection test failed");
    }
    await onSettingsRefresh();
  } catch (err: unknown) {
    const errMessage = err instanceof Error ? err.message : "Unknown error";
    console.error("Test error:", err);
    toast.error(errMessage || "Connection test failed");
  } finally {
    setIsTesting(false);
  }
}, [organizationId, user, client, onSettingsRefresh]);
```

6. Rewrite handleToggleEnabled using tRPC:
```typescript
const handleToggleEnabled = useCallback(async (enabled: boolean) => {
  if (!organizationId || !user) return;

  setIsSaving(true);
  try {
    await client.ttnSettings.update.mutate({
      organizationId: organizationId,
      data: { is_enabled: enabled },
    });

    setIsEnabled(enabled);
    toast.success(enabled ? "TTN integration enabled" : "TTN integration disabled");

    const hash = hashConfigValues({
      cluster: region,
      application_id: settings?.ttn_application_id,
      api_key_last4: settings?.api_key_last4,
      is_enabled: enabled,
    });
    setCanonical(hash);
  } catch (err: unknown) {
    const errMessage = err instanceof Error ? err.message : "Unknown error";
    console.error("Toggle error:", err);
    toast.error(errMessage || "Failed to update settings");
    setInvalid(errMessage || "Failed to update settings");
  } finally {
    setIsSaving(false);
  }
}, [organizationId, region, settings?.ttn_application_id, settings?.api_key_last4, user, client, setIsEnabled, setCanonical, setInvalid]);
```

7. Add trpc client at top of hook:
```typescript
export function useTTNOperations({
  organizationId,
  region,
  settings,
  isEnabled,
  setIsEnabled,
  onSettingsRefresh,
}: UseTTNOperationsOptions): UseTTNOperationsReturn {
  const client = useTRPCClient();
  const [isProvisioning, setIsProvisioning] = useState(false);
  // ... rest of state ...
```

8. Keep handleProvision as-is for now (edge function call to ttn-provision-org - will migrate in future phase)

Add comment above handleProvision:
```typescript
// TODO: Migrate to backend BullMQ job when ttn-provision-org edge function is replaced
const handleProvision = useCallback(async (isRetry: boolean = false, fromStep?: string) => {
  // ... existing implementation using invokeEdgeFunction ...
```
  </action>
  <verify>
File no longer imports supabase for toggle/test operations
File imports useTRPCClient from @/lib/trpc
handleTest uses client.ttnSettings.test.mutate
handleToggleEnabled uses client.ttnSettings.update.mutate
handleProvision still uses edge function (future migration)
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useTTNOperations hook partially migrated to tRPC (toggle/test), provisioning deferred to future phase
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate useEscalationContacts hook to tRPC</name>
  <files>src/hooks/useEscalationContacts.ts</files>
  <action>
Migrate src/hooks/useEscalationContacts.ts to use tRPC instead of direct Supabase queries:

1. Remove Supabase import:
```typescript
- import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
```

2. Add tRPC imports:
```typescript
+ import { useTRPC, useTRPCClient } from "@/lib/trpc";
```

3. Update file header comment:
```typescript
/**
 * Escalation Contacts Domain Hooks
 *
 * Migrated to tRPC in Phase 21
 * Uses escalationContacts router for CRUD operations
 */
```

4. Rewrite useEscalationContacts query hook:
```typescript
export function useEscalationContacts() {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();
  const trpc = useTRPC();

  return trpc.escalationContacts.list.useQuery(
    { organizationId: orgId! },
    { enabled: isReady && !!user && !!orgId }
  );
}
```

5. Rewrite useCreateEscalationContact mutation hook:
```typescript
export function useCreateEscalationContact() {
  const queryClient = useQueryClient();
  const { orgId } = useOrgScope();
  const user = useUser();
  const client = useTRPCClient();

  return useMutation({
    mutationFn: async (contact: Omit<EscalationContact, "id" | "created_at">) => {
      if (!orgId || !user) throw new Error('Not authenticated');

      return client.escalationContacts.create.mutate({
        organizationId: orgId,
        data: contact,
      });
    },
    onSuccess: async () => {
      if (orgId) {
        await invalidateEscalationContacts(queryClient, orgId);
      }
    },
  });
}
```

6. Rewrite useUpdateEscalationContact mutation hook:
```typescript
export function useUpdateEscalationContact() {
  const queryClient = useQueryClient();
  const { orgId } = useOrgScope();
  const user = useUser();
  const client = useTRPCClient();

  return useMutation({
    mutationFn: async ({ id, ...updates }: Partial<EscalationContact> & { id: string }) => {
      if (!orgId || !user) throw new Error('Not authenticated');

      return client.escalationContacts.update.mutate({
        organizationId: orgId,
        contactId: id,
        data: updates,
      });
    },
    onSuccess: async () => {
      if (orgId) {
        await invalidateEscalationContacts(queryClient, orgId);
      }
    },
  });
}
```

7. Rewrite useDeleteEscalationContact mutation hook:
```typescript
export function useDeleteEscalationContact() {
  const queryClient = useQueryClient();
  const { orgId } = useOrgScope();
  const user = useUser();
  const client = useTRPCClient();

  return useMutation({
    mutationFn: async (id: string) => {
      if (!orgId || !user) throw new Error('Not authenticated');

      return client.escalationContacts.delete.mutate({
        organizationId: orgId,
        contactId: id,
      });
    },
    onSuccess: async () => {
      if (orgId) {
        await invalidateEscalationContacts(queryClient, orgId);
      }
    },
  });
}
```
  </action>
  <verify>
File no longer imports from @/integrations/supabase/client
File imports useTRPC and useTRPCClient from @/lib/trpc
All hooks use trpc.escalationContacts procedures
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useEscalationContacts hook fully migrated to tRPC, no direct Supabase queries
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npm run typecheck`
2. No Supabase imports in migrated hook files
3. All migrated hooks use useTRPC or useTRPCClient
4. Frontend builds successfully: `npm run build`
</verification>

<success_criteria>
- useTTNSettings migrated to use trpc.ttnSettings.get
- useTTNOperations partially migrated (toggle/test use tRPC, provisioning deferred)
- useEscalationContacts fully migrated to use trpc.escalationContacts CRUD
- No Supabase imports in these 3 hook files
- TypeScript compilation passes for frontend
- All hooks follow established tRPC patterns from Phase 20
</success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-08-SUMMARY.md`
</output>
