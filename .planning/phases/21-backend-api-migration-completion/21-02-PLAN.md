---
phase: 21-backend-api-migration-completion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/ttn-gateways.router.ts
  - backend/src/routers/ttn-devices.router.ts
  - backend/src/trpc/procedures.ts
  - backend/src/trpc/router.ts
  - backend/tests/trpc/ttn-gateways.router.test.ts
  - backend/tests/trpc/ttn-devices.router.test.ts
autonomous: true

must_haves:
  truths:
    - 'Manager can register, update, and deregister TTN gateways via tRPC'
    - 'Manager can provision, bootstrap, update, and deprovision TTN devices via tRPC'
    - 'Device provisioning checks sensor capacity from subscription'
  artifacts:
    - path: 'backend/src/routers/ttn-gateways.router.ts'
      provides: 'TTN gateway CRUD'
      exports: ['ttnGatewaysRouter']
    - path: 'backend/src/routers/ttn-devices.router.ts'
      provides: 'TTN device provisioning and management'
      exports: ['ttnDevicesRouter']
    - path: 'backend/src/trpc/procedures.ts'
      provides: 'sensorCapacityProcedure middleware'
      contains: 'checkSensorCapacity'
  key_links:
    - from: 'backend/src/trpc/router.ts'
      to: 'ttnGateways, ttnDevices routers'
      via: 'router composition'
      pattern: 'ttnGateways: ttnGatewaysRouter'
---

<objective>
Create tRPC routers for TTN domain: gateway registration/management and device provisioning/management with sensor capacity middleware.

Purpose: Enable frontend to migrate from REST endpoints to type-safe tRPC procedures for IoT device management.

Output: Two new tRPC routers with sensor capacity middleware, registered in appRouter with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-RESEARCH.md

Reference existing patterns:
@backend/src/routers/units.router.ts
@backend/src/trpc/procedures.ts
@backend/tests/trpc/units.router.test.ts

Reference REST routes being replaced:
@backend/src/routes/ttn-gateways.ts
@backend/src/routes/ttn-devices.ts
@backend/src/middleware/subscription.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sensorCapacityProcedure middleware</name>
  <files>
    backend/src/trpc/procedures.ts
  </files>
  <action>
Add a new procedure to backend/src/trpc/procedures.ts:

```typescript
import { checkSensorCapacity } from '../services/checkout.service.js';

/**
 * Sensor capacity procedure
 * Extends orgProcedure to check subscription sensor capacity before mutations
 * Use for device provisioning operations that add new sensors
 */
export const sensorCapacityProcedure = orgProcedure.use(async (opts) => {
  const hasCapacity = await checkSensorCapacity(opts.ctx.user.organizationId);
  if (!hasCapacity) {
    throw new TRPCError({
      code: 'FORBIDDEN',
      message: 'Sensor capacity exceeded. Upgrade your plan to add more sensors.',
    });
  }
  return opts.next();
});
```

This replicates the REST middleware requireSensorCapacity from subscription.ts for tRPC procedures.
</action>
<verify>
npx tsc --noEmit -p backend/tsconfig.json
grep -q "sensorCapacityProcedure" backend/src/trpc/procedures.ts
</verify>
<done>
sensorCapacityProcedure exported from procedures.ts and compiles
</done>
</task>

<task type="auto">
  <name>Task 2: Create TTN gateways and devices tRPC routers</name>
  <files>
    backend/src/routers/ttn-gateways.router.ts
    backend/src/routers/ttn-devices.router.ts
    backend/src/trpc/router.ts
  </files>
  <action>
Create backend/src/routers/ttn-gateways.router.ts with 6 procedures:

1. `list` - orgProcedure
   - Call ttnGatewayService.listTTNGateways(ctx.user.organizationId)

2. `get` - orgProcedure
   - Input: { organizationId, gatewayId }
   - Call ttnGatewayService.getTTNGateway(gatewayId, orgId)
   - Return NOT_FOUND if null

3. `register` - orgProcedure (manager/admin/owner role check)
   - Input: { organizationId, data: RegisterTTNGatewaySchema }
   - Call ttnGatewayService.registerTTNGateway
   - Handle TTNConfigError/TTNRegistrationError as BAD_REQUEST

4. `update` - orgProcedure (manager/admin/owner role check)
   - Input: { organizationId, gatewayId, data: UpdateTTNGatewaySchema }
   - Call ttnGatewayService.updateTTNGateway
   - Return NOT_FOUND if null

5. `deregister` - orgProcedure (manager/admin/owner role check)
   - Input: { organizationId, gatewayId }
   - Call ttnGatewayService.deregisterTTNGateway
   - Return NOT_FOUND if false

6. `refreshStatus` - orgProcedure
   - Input: { organizationId, gatewayId }
   - Call ttnGatewayService.updateGatewayStatus
   - Return NOT_FOUND if null

Create backend/src/routers/ttn-devices.router.ts with 6 procedures:

1. `list` - orgProcedure
   - Call ttnDeviceService.listTTNDevices(ctx.user.organizationId)

2. `get` - orgProcedure
   - Input: { organizationId, deviceId }
   - Call ttnDeviceService.getTTNDevice(deviceId, orgId)

3. `provision` - sensorCapacityProcedure (manager/admin/owner role check)
   - Input: { organizationId, data: ProvisionTTNDeviceSchema }
   - Call ttnDeviceService.provisionTTNDevice
   - Handle TTNConfigError/TTNProvisioningError as BAD_REQUEST

4. `bootstrap` - sensorCapacityProcedure (manager/admin/owner role check)
   - Input: { organizationId, data: BootstrapTTNDeviceSchema }
   - Call ttnDeviceService.bootstrapTTNDevice
   - Handle errors as BAD_REQUEST

5. `update` - orgProcedure (manager/admin/owner role check)
   - Input: { organizationId, deviceId, data: UpdateTTNDeviceSchema }
   - Call ttnDeviceService.updateTTNDevice
   - Return NOT_FOUND if null

6. `deprovision` - orgProcedure (manager/admin/owner role check)
   - Input: { organizationId, deviceId }
   - Call ttnDeviceService.deprovisionTTNDevice
   - Return NOT_FOUND if false

Register both in router.ts:

- `ttnGateways: ttnGatewaysRouter`
- `ttnDevices: ttnDevicesRouter`
  </action>
  <verify>
  npx tsc --noEmit -p backend/tsconfig.json
  grep -q "ttnGatewaysRouter" backend/src/trpc/router.ts
  grep -q "ttnDevicesRouter" backend/src/trpc/router.ts
  </verify>
  <done>
  Both TTN routers compile and are registered in appRouter
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add unit tests for TTN routers</name>
  <files>
    backend/tests/trpc/ttn-gateways.router.test.ts
    backend/tests/trpc/ttn-devices.router.test.ts
  </files>
  <action>
Create backend/tests/trpc/ttn-gateways.router.test.ts:
- Mock ttnGatewayService
- Test list: returns gateways array
- Test get: returns gateway, handles not found
- Test register: success for manager, FORBIDDEN for viewer
- Test update: success, handles not found
- Test deregister: success, handles not found
- Test refreshStatus: updates gateway status

Create backend/tests/trpc/ttn-devices.router.test.ts:

- Mock ttnDeviceService and checkSensorCapacity
- Test list: returns devices array
- Test get: returns device, handles not found
- Test provision: success for manager with capacity, FORBIDDEN without capacity
- Test bootstrap: success for manager with capacity
- Test update: success, handles not found
- Test deprovision: success, handles not found

Each test file should have ~15-20 test cases covering:

- Happy path for each procedure
- Role-based access (manager/admin/owner vs viewer/staff)
- Sensor capacity enforcement for provision/bootstrap
- Error handling (NOT_FOUND, BAD_REQUEST from service errors)
  </action>
  <verify>
  npm run test -- backend/tests/trpc/ttn-gateways.router.test.ts backend/tests/trpc/ttn-devices.router.test.ts --run
  </verify>
  <done>
  All TTN router tests pass with comprehensive coverage
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p backend/tsconfig.json`
2. sensorCapacityProcedure exported from procedures.ts
3. Both TTN routers registered in appRouter
4. All new tests pass: `npm run test -- backend/tests/trpc/ttn-*.router.test.ts --run`
5. REST routes still work (parallel operation until frontend migrates)
</verification>

<success_criteria>

- ttnGatewaysRouter and ttnDevicesRouter exported and registered
- sensorCapacityProcedure available for device provisioning
- 12 total procedures across 2 routers
- ~35 new tests passing
- Backend builds without type errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-02-SUMMARY.md`
</output>
