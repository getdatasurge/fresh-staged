---
phase: 21-backend-api-migration-completion
plan: 06
type: execute
wave: 3
depends_on: ["21-01", "21-02", "21-03", "21-04", "21-05"]
files_modified:
  - backend/src/routers/ttn-settings.router.ts
  - backend/src/schemas/ttn-settings.ts
  - backend/tests/trpc/ttn-settings.router.test.ts
autonomous: true

must_haves:
  truths:
    - "TTN settings can be retrieved via tRPC"
    - "TTN settings can be updated via tRPC"
    - "TTN connection can be tested via tRPC"
  artifacts:
    - path: "backend/src/routers/ttn-settings.router.ts"
      provides: "TTN settings router with CRUD operations"
      min_lines: 150
      exports: ["ttnSettingsRouter"]
    - path: "backend/src/schemas/ttn-settings.ts"
      provides: "Zod schemas for TTN settings"
      contains: "TTNSettingsSchema"
    - path: "backend/tests/trpc/ttn-settings.router.test.ts"
      provides: "Test coverage for TTN settings procedures"
      min_lines: 50
  key_links:
    - from: "backend/src/trpc/router.ts"
      to: "ttnSettingsRouter"
      via: "router composition"
      pattern: "ttnSettings.*ttnSettingsRouter"
---

<objective>
Create TTN settings backend router for settings management and connection testing.

Purpose: Enable migration of useTTNSettings, useTTNApiKey, useTTNWebhook, and useTTNOperations hooks from edge functions to tRPC.

Output: ttnSettingsRouter with procedures for get, update, test, and webhook configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-VERIFICATION.md
@.planning/phases/21-backend-api-migration-completion/21-RESEARCH.md

Reference existing TTN routers for patterns:
@backend/src/routers/ttn-gateways.router.ts
@backend/src/routers/ttn-devices.router.ts

Reference hooks that need this router:
@src/hooks/useTTNSettings.ts
@src/hooks/useTTNApiKey.ts
@src/hooks/useTTNWebhook.ts
@src/hooks/useTTNOperations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TTN settings Zod schemas</name>
  <files>backend/src/schemas/ttn-settings.ts</files>
  <action>
Create backend/src/schemas/ttn-settings.ts with Zod validation schemas:

1. Import dependencies:
```typescript
import { z } from 'zod';
```

2. Create TTNSettingsSchema for database row shape:
```typescript
export const TTNSettingsSchema = z.object({
  organization_id: z.string().uuid(),
  ttn_region: z.string().nullable(),
  ttn_application_id: z.string().nullable(),
  is_enabled: z.boolean(),
  provisioning_status: z.enum(['idle', 'provisioning', 'ready', 'failed']),
  provisioning_step: z.string().nullable(),
  provisioning_started_at: z.string().nullable(),
  provisioning_last_heartbeat_at: z.string().nullable(),
  provisioning_attempt_count: z.number(),
  provisioning_error: z.string().nullable(),
  last_http_status: z.number().nullable(),
  last_http_body: z.string().nullable(),
  provisioning_last_step: z.string().nullable(),
  provisioning_can_retry: z.boolean(),
  provisioned_at: z.string().nullable(),
  has_api_key: z.boolean(),
  api_key_last4: z.string().nullable(),
  api_key_updated_at: z.string().nullable(),
  has_webhook_secret: z.boolean(),
  webhook_secret_last4: z.string().nullable(),
  webhook_url: z.string().nullable(),
  webhook_id: z.string().nullable(),
  webhook_events: z.array(z.string()).nullable(),
  last_connection_test_at: z.string().nullable(),
  last_connection_test_result: z.any().nullable(),
  last_updated_source: z.string().nullable(),
  last_test_source: z.string().nullable(),
});
```

3. Create UpdateTTNSettingsSchema for update operations:
```typescript
export const UpdateTTNSettingsSchema = z.object({
  is_enabled: z.boolean().optional(),
  ttn_region: z.string().optional(),
  webhook_url: z.string().url().optional(),
  webhook_events: z.array(z.string()).optional(),
});
```

4. Create TestConnectionInputSchema:
```typescript
export const TestConnectionInputSchema = z.object({
  organizationId: z.string().uuid(),
});
```

5. Create TestConnectionResultSchema:
```typescript
export const TestConnectionResultSchema = z.object({
  success: z.boolean(),
  error: z.string().optional(),
  hint: z.string().optional(),
  applicationName: z.string().optional(),
  statusCode: z.number().optional(),
  testedAt: z.string().optional(),
  clusterTested: z.string().optional(),
  effectiveApplicationId: z.string().optional(),
  apiKeyLast4: z.string().optional(),
  request_id: z.string().optional(),
  message: z.string().optional(),
});
```

6. Export type aliases:
```typescript
export type TTNSettings = z.infer<typeof TTNSettingsSchema>;
export type UpdateTTNSettings = z.infer<typeof UpdateTTNSettingsSchema>;
export type TestConnectionResult = z.infer<typeof TestConnectionResultSchema>;
```
  </action>
  <verify>
File exists at backend/src/schemas/ttn-settings.ts
TypeScript compilation passes: `cd backend && npm run typecheck`
  </verify>
  <done>
Zod schemas created for TTN settings validation, all schemas export type aliases
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TTN settings tRPC router with procedures</name>
  <files>backend/src/routers/ttn-settings.router.ts</files>
  <action>
Create backend/src/routers/ttn-settings.router.ts following established patterns from ttn-gateways.router.ts:

1. Import dependencies:
```typescript
import { z } from 'zod';
import { TRPCError } from '@trpc/server';
import { router } from '../trpc/index.js';
import { orgProcedure } from '../trpc/procedures.js';
import {
  TTNSettingsSchema,
  UpdateTTNSettingsSchema,
  TestConnectionInputSchema,
  TestConnectionResultSchema,
} from '../schemas/ttn-settings.js';
```

2. Define input schemas:
```typescript
const OrgInput = z.object({
  organizationId: z.string().uuid(),
});

const UpdateInput = z.object({
  organizationId: z.string().uuid(),
  data: UpdateTTNSettingsSchema,
});
```

3. Implement `get` procedure:
```typescript
export const ttnSettingsRouter = router({
  get: orgProcedure
    .input(OrgInput)
    .output(TTNSettingsSchema.nullable())
    .query(async ({ input, ctx }) => {
      const { db } = ctx;

      const result = await db
        .selectFrom('ttn_settings')
        .selectAll()
        .where('organization_id', '=', input.organizationId)
        .executeTakeFirst();

      if (!result) {
        return null;
      }

      return {
        ...result,
        // Map legacy status values
        provisioning_status: result.provisioning_status === 'not_started'
          ? 'idle'
          : result.provisioning_status === 'completed'
          ? 'ready'
          : result.provisioning_status,
      };
    }),
```

4. Implement `update` procedure (admin/owner only):
```typescript
  update: orgProcedure
    .input(UpdateInput)
    .mutation(async ({ input, ctx }) => {
      const { db, user } = ctx;

      // Admin/owner check
      if (!['admin', 'owner'].includes(user.role)) {
        throw new TRPCError({
          code: 'FORBIDDEN',
          message: 'Only administrators can update TTN settings',
        });
      }

      await db
        .updateTable('ttn_settings')
        .set({
          ...input.data,
          last_updated_source: 'api',
        })
        .where('organization_id', '=', input.organizationId)
        .execute();

      return { success: true };
    }),
```

5. Implement `test` procedure:
```typescript
  test: orgProcedure
    .input(TestConnectionInputSchema)
    .output(TestConnectionResultSchema)
    .mutation(async ({ input, ctx }) => {
      const { db } = ctx;

      // Fetch settings
      const settings = await db
        .selectFrom('ttn_settings')
        .selectAll()
        .where('organization_id', '=', input.organizationId)
        .executeTakeFirst();

      if (!settings || !settings.has_api_key) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'TTN not configured for this organization',
        });
      }

      // TODO: Implement actual TTN API connection test
      // For now, return a mock success result
      const testResult = {
        success: true,
        testedAt: new Date().toISOString(),
        clusterTested: settings.ttn_region || 'nam1',
        effectiveApplicationId: settings.ttn_application_id || undefined,
        apiKeyLast4: settings.api_key_last4 || undefined,
        request_id: crypto.randomUUID(),
      };

      // Update last test result
      await db
        .updateTable('ttn_settings')
        .set({
          last_connection_test_at: testResult.testedAt,
          last_connection_test_result: JSON.stringify(testResult),
          last_test_source: 'api',
        })
        .where('organization_id', '=', input.organizationId)
        .execute();

      return testResult;
    }),
});
```

Note: The actual TTN API integration (bootstrap, validation, webhook configuration) will be implemented in Plan 21-07 after this router structure is established.
  </action>
  <verify>
File exists at backend/src/routers/ttn-settings.router.ts
Exports ttnSettingsRouter constant
Contains 3 procedures: get, update, test
TypeScript compilation passes: `cd backend && npm run typecheck`
  </verify>
  <done>
TTN settings router created with get, update, and test procedures, admin/owner role checks enforced
  </done>
</task>

<task type="auto">
  <name>Task 3: Register router and create tests</name>
  <files>
    backend/src/trpc/router.ts
    backend/tests/trpc/ttn-settings.router.test.ts
  </files>
  <action>
1. Register router in backend/src/trpc/router.ts:

Add import (alphabetical order):
```typescript
import { ttnSettingsRouter } from '../routers/ttn-settings.router.js';
```

Add to appRouter (after ttnDevices):
```typescript
export const appRouter = router({
  // ... existing routers ...
  ttnDevices: ttnDevicesRouter,
  ttnSettings: ttnSettingsRouter,
  // ... rest ...
});
```

2. Create backend/tests/trpc/ttn-settings.router.test.ts following established test patterns:

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { mockContext, mockOrgProcedureContext } from '../helpers/trpc-test-helpers.js';
import { ttnSettingsRouter } from '../../src/routers/ttn-settings.router.js';

describe('ttnSettingsRouter', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('get', () => {
    it('returns null when settings do not exist', async () => {
      const ctx = mockOrgProcedureContext({
        dbResults: {
          ttn_settings: [],
        },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      const result = await caller.get({
        organizationId: 'org-123',
      });

      expect(result).toBeNull();
    });

    it('returns settings when they exist', async () => {
      const mockSettings = {
        organization_id: 'org-123',
        ttn_region: 'nam1',
        ttn_application_id: 'app-123',
        is_enabled: true,
        provisioning_status: 'ready',
        provisioning_step: null,
        provisioning_started_at: null,
        provisioning_last_heartbeat_at: null,
        provisioning_attempt_count: 0,
        provisioning_error: null,
        last_http_status: null,
        last_http_body: null,
        provisioning_last_step: null,
        provisioning_can_retry: true,
        provisioned_at: '2024-01-01T00:00:00Z',
        has_api_key: true,
        api_key_last4: 'abcd',
        api_key_updated_at: '2024-01-01T00:00:00Z',
        has_webhook_secret: false,
        webhook_secret_last4: null,
        webhook_url: null,
        webhook_id: null,
        webhook_events: null,
        last_connection_test_at: null,
        last_connection_test_result: null,
        last_updated_source: null,
        last_test_source: null,
      };

      const ctx = mockOrgProcedureContext({
        dbResults: {
          ttn_settings: [mockSettings],
        },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      const result = await caller.get({
        organizationId: 'org-123',
      });

      expect(result).toEqual(mockSettings);
    });

    it('maps legacy status values', async () => {
      const mockSettings = {
        organization_id: 'org-123',
        provisioning_status: 'not_started',
        // ... other fields ...
      };

      const ctx = mockOrgProcedureContext({
        dbResults: {
          ttn_settings: [mockSettings],
        },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      const result = await caller.get({
        organizationId: 'org-123',
      });

      expect(result?.provisioning_status).toBe('idle');
    });
  });

  describe('update', () => {
    it('updates settings when user is admin', async () => {
      const ctx = mockOrgProcedureContext({
        user: { role: 'admin' },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      await caller.update({
        organizationId: 'org-123',
        data: { is_enabled: false },
      });

      expect(ctx.db.updateTable).toHaveBeenCalledWith('ttn_settings');
    });

    it('throws FORBIDDEN when user is staff', async () => {
      const ctx = mockOrgProcedureContext({
        user: { role: 'staff' },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      await expect(
        caller.update({
          organizationId: 'org-123',
          data: { is_enabled: false },
        })
      ).rejects.toThrow('Only administrators');
    });
  });

  describe('test', () => {
    it('throws BAD_REQUEST when TTN not configured', async () => {
      const ctx = mockOrgProcedureContext({
        dbResults: {
          ttn_settings: [],
        },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      await expect(
        caller.test({
          organizationId: 'org-123',
        })
      ).rejects.toThrow('TTN not configured');
    });

    it('returns test result when configured', async () => {
      const mockSettings = {
        organization_id: 'org-123',
        has_api_key: true,
        ttn_region: 'nam1',
        ttn_application_id: 'app-123',
        api_key_last4: 'abcd',
        // ... other fields ...
      };

      const ctx = mockOrgProcedureContext({
        dbResults: {
          ttn_settings: [mockSettings],
        },
      });

      const caller = ttnSettingsRouter.createCaller(ctx);
      const result = await caller.test({
        organizationId: 'org-123',
      });

      expect(result.success).toBe(true);
      expect(result.clusterTested).toBe('nam1');
      expect(result.effectiveApplicationId).toBe('app-123');
    });
  });
});
```

3. Run tests:
```bash
cd backend && npm test -- ttn-settings.router.test.ts
```
  </action>
  <verify>
Router registered in backend/src/trpc/router.ts
Test file exists at backend/tests/trpc/ttn-settings.router.test.ts
All tests pass: `cd backend && npm test -- ttn-settings.router.test.ts`
TypeScript compilation passes for entire backend
  </verify>
  <done>
TTN settings router registered in appRouter, 10+ tests passing covering get, update, test procedures
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for backend
2. Tests pass: `cd backend && npm test -- ttn-settings.router.test.ts`
3. Router exports ttnSettingsRouter and is registered in appRouter
4. Schemas validate TTN settings structure with proper types
</verification>

<success_criteria>
- TTN settings router created with 3 procedures (get, update, test)
- Zod schemas define TTN settings shape and validation
- Router registered in appRouter at `ttnSettings` namespace
- 10+ tests passing covering all procedures and error cases
- Admin/owner role checks enforced for mutations
- TypeScript compilation passes for backend
</success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-06-SUMMARY.md`
</output>
