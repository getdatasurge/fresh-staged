---
phase: 21-backend-api-migration-completion
plan: 09
type: execute
wave: 5
depends_on: ["21-06", "21-07"]
files_modified:
  - src/hooks/useTTNApiKey.ts
  - src/hooks/useTTNWebhook.ts
  - src/hooks/useTTNSetupWizard.ts
  - src/hooks/useCheckTtnProvisioningState.ts
  - src/hooks/useGatewayProvisioningPreflight.ts
  - src/hooks/useTTNDeprovision.ts
autonomous: true

must_haves:
  truths:
    - "TTN hooks marked with clear TODO comments for future migration"
    - "Edge function dependencies documented in hook headers"
    - "No unmigrated hooks claim to be tRPC-based"
  artifacts:
    - path: "src/hooks/useTTNApiKey.ts"
      provides: "TTN API key hooks with migration notes"
      contains: "TODO.*ttn-bootstrap"
    - path: "src/hooks/useTTNWebhook.ts"
      provides: "TTN webhook hooks with migration notes"
      contains: "TODO.*update-ttn-webhook"
    - path: "src/hooks/useTTNDeprovision.ts"
      provides: "TTN deprovision hooks with migration notes"
      contains: "TODO.*ttn_deprovision_jobs"
  key_links:
    - from: "src/hooks/useTTN*.ts"
      to: "edge functions"
      via: "documented dependencies"
      pattern: "TODO.*edge function"
---

<objective>
Document remaining TTN hooks that require additional backend work before migration.

Purpose: Clearly mark hooks that still use edge functions or direct DB access as future work, preventing confusion about migration status.

Output: 6 hooks with updated TODO comments explaining why they're not yet migrated and what backend work is needed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-VERIFICATION.md

Reference hooks that need documentation:
@src/hooks/useTTNApiKey.ts
@src/hooks/useTTNWebhook.ts
@src/hooks/useTTNSetupWizard.ts
@src/hooks/useCheckTtnProvisioningState.ts
@src/hooks/useGatewayProvisioningPreflight.ts
@src/hooks/useTTNDeprovision.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document TTN API key and webhook hooks</name>
  <files>
    src/hooks/useTTNApiKey.ts
    src/hooks/useTTNWebhook.ts
  </files>
  <action>
Update file headers to clearly document edge function dependencies and migration blockers:

1. Update src/hooks/useTTNApiKey.ts header:
```typescript
/**
 * TTN API Key Hooks
 *
 * Status: BLOCKED - Requires backend implementation
 *
 * Current implementation:
 * - Uses ttn-bootstrap edge function for API key validation and webhook setup
 * - Edge function performs: TTN API key validation, permissions check, webhook configuration
 *
 * Migration blockers:
 * - Backend needs TTN SDK integration (@ttn-lw/grpc-web-api-client)
 * - Backend needs TTN API key validation procedures
 * - Backend needs webhook configuration procedures (create/update webhook in TTN)
 * - Backend needs bootstrap service/job for provisioning workflow
 *
 * Edge functions used:
 * - ttn-bootstrap (validate_only, save_and_configure actions)
 *
 * Migration path:
 * 1. Add TTN SDK to backend dependencies
 * 2. Create ttn-bootstrap.service.ts with validation and webhook config logic
 * 3. Create procedures in ttnSettings router (validateApiKey, configureWebhook)
 * 4. Migrate this hook to use tRPC procedures
 *
 * Estimated effort: Medium (requires external API integration)
 * Priority: Medium (affects TTN setup wizard UX)
 */
```

2. Update src/hooks/useTTNWebhook.ts header:
```typescript
/**
 * TTN Webhook Hooks
 *
 * Status: BLOCKED - Requires backend implementation
 *
 * Current implementation:
 * - Uses update-ttn-webhook edge function to update webhook configuration in TTN
 * - Uses ttn-provision-org edge function to regenerate webhook secret
 *
 * Migration blockers:
 * - Backend needs TTN SDK integration (@ttn-lw/grpc-web-api-client)
 * - Backend needs webhook update procedures (call TTN API to update webhook events/URL)
 * - Backend needs webhook secret regeneration procedures
 *
 * Edge functions used:
 * - update-ttn-webhook (updates webhook events and URL in TTN)
 * - ttn-provision-org (regenerate_webhook_secret action)
 *
 * Migration path:
 * 1. Add TTN SDK to backend dependencies
 * 2. Create webhook service with TTN API integration
 * 3. Add procedures to ttnSettings router (updateWebhook, regenerateWebhookSecret)
 * 4. Migrate this hook to use tRPC procedures
 *
 * Estimated effort: Medium (requires external API integration)
 * Priority: Low (webhook config is one-time setup)
 */
```

3. Keep existing implementations unchanged (still use edge functions)

4. Add inline TODO comments before edge function calls:
```typescript
// TODO: Replace with tRPC when backend TTN SDK integration is available
const { data, error } = await supabase.functions.invoke("ttn-bootstrap", {
```
  </action>
  <verify>
File headers clearly state "BLOCKED - Requires backend implementation"
Edge function dependencies documented
Migration path outlined
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useTTNApiKey and useTTNWebhook hooks documented with migration blockers and paths
  </done>
</task>

<task type="auto">
  <name>Task 2: Document TTN wizard and provisioning hooks</name>
  <files>
    src/hooks/useTTNSetupWizard.ts
    src/hooks/useCheckTtnProvisioningState.ts
    src/hooks/useGatewayProvisioningPreflight.ts
  </files>
  <action>
Update file headers for remaining TTN hooks:

1. Update src/hooks/useTTNSetupWizard.ts header:
```typescript
/**
 * TTN Setup Wizard Hooks
 *
 * Status: BLOCKED - Requires backend implementation
 *
 * Current implementation:
 * - Uses manage-ttn-settings edge function for wizard state management
 * - Edge function handles: get settings, update region, save API key, test connection
 *
 * Migration blockers:
 * - Depends on useTTNApiKey migration (API key validation)
 * - Depends on useTTNSettings migration (settings CRUD) ✓ DONE in Plan 21-08
 * - Depends on backend TTN connection testing
 *
 * Edge functions used:
 * - manage-ttn-settings (get, update, test actions)
 *
 * Migration path:
 * 1. Partially migrate to use ttnSettings.get from Plan 21-06 ✓
 * 2. Use ttnSettings.update for region/enabled toggle ✓
 * 3. Wait for API key validation backend implementation
 * 4. Migrate remaining wizard steps to tRPC
 *
 * Estimated effort: Small (mostly uses already-migrated procedures)
 * Priority: High (blocks wizard UX improvements)
 */
```

2. Update src/hooks/useCheckTtnProvisioningState.ts header:
```typescript
/**
 * TTN Provisioning State Check Hooks
 *
 * Status: BLOCKED - Requires backend implementation
 *
 * Current implementation:
 * - Uses check-ttn-device-exists edge function to verify device in TTN
 * - Updates sensor provisioning_state in database after check
 *
 * Migration blockers:
 * - Backend needs TTN SDK integration to query device existence
 * - Backend needs procedure to check device in TTN and update sensor state
 *
 * Edge functions used:
 * - check-ttn-device-exists (queries TTN API, updates sensors table)
 *
 * Migration path:
 * 1. Add TTN SDK to backend
 * 2. Create ttnDevices.checkExistence procedure
 * 3. Migrate this hook to use tRPC procedure
 *
 * Estimated effort: Medium (requires TTN API integration)
 * Priority: Medium (used for sensor status validation)
 */
```

3. Update src/hooks/useGatewayProvisioningPreflight.ts header:
```typescript
/**
 * Gateway Provisioning Preflight Hooks
 *
 * Status: BLOCKED - Requires backend implementation
 *
 * Current implementation:
 * - Uses ttn-gateway-preflight edge function to validate API key permissions
 * - Checks if API key has gateway provisioning rights (personal/org key vs app key)
 *
 * Migration blockers:
 * - Backend needs TTN SDK integration to validate API key type and permissions
 * - Backend needs procedure to inspect API key rights
 *
 * Edge functions used:
 * - ttn-gateway-preflight (validates API key type and gateway rights)
 *
 * Migration path:
 * 1. Add TTN SDK to backend
 * 2. Create ttnSettings.validateGatewayRights procedure
 * 3. Migrate this hook to use tRPC procedure
 *
 * Estimated effort: Medium (requires TTN API integration)
 * Priority: Low (only used for gateway provisioning validation)
 */
```

4. Keep existing implementations unchanged
  </action>
  <verify>
All file headers clearly state migration status and blockers
Edge function dependencies documented
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useTTNSetupWizard, useCheckTtnProvisioningState, useGatewayProvisioningPreflight hooks documented
  </done>
</task>

<task type="auto">
  <name>Task 3: Document TTN deprovision hooks</name>
  <files>src/hooks/useTTNDeprovision.ts</files>
  <action>
Update src/hooks/useTTNDeprovision.ts header:

```typescript
/**
 * TTN Deprovision Hooks
 *
 * Status: BLOCKED - Requires backend job queue implementation
 *
 * Current implementation:
 * - Queries ttn_deprovision_jobs table directly via Supabase
 * - Uses ttn-list-devices edge function to scan for orphaned devices
 * - Inserts jobs directly into ttn_deprovision_jobs table
 *
 * Migration blockers:
 * - Backend needs BullMQ job queue integration for deprovision workflow
 * - Backend needs TTN SDK integration to list devices and delete devices
 * - Backend needs procedures to manage deprovision jobs (list, create, retry)
 *
 * Edge functions used:
 * - ttn-list-devices (scans TTN for devices, identifies orphans)
 *
 * Direct DB access:
 * - ttn_deprovision_jobs table (read/write)
 * - get_deprovision_job_stats RPC function
 *
 * Migration path:
 * 1. Add TTN SDK to backend
 * 2. Create ttn-deprovision.service.ts with BullMQ job management
 * 3. Create ttnDeprovision router with procedures (listJobs, createJob, retryJob, scanOrphans)
 * 4. Migrate this hook to use tRPC procedures
 *
 * Estimated effort: Large (requires BullMQ job queue + TTN SDK integration)
 * Priority: Low (deprovision is infrequent admin operation)
 */
```

Add inline comments before direct DB queries:
```typescript
// TODO: Replace with tRPC when backend deprovision job queue is implemented
let query = supabase
  .from("ttn_deprovision_jobs")
```

Keep existing implementations unchanged.
  </action>
  <verify>
File header clearly states migration blockers
Direct DB access documented
Edge function dependencies documented
TypeScript compilation passes: `npm run typecheck`
  </verify>
  <done>
useTTNDeprovision hook documented with migration path and blockers
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npm run typecheck`
2. All 6 hook files have updated headers with migration status
3. Edge function dependencies clearly documented
4. Migration paths outlined for future work
5. No hooks falsely claim to be migrated
</verification>

<success_criteria>
- 6 hook files have clear "BLOCKED - Requires backend implementation" headers
- Edge function dependencies documented in each hook
- Migration blockers and paths clearly stated
- Inline TODO comments added before edge function calls
- TypeScript compilation passes
- No code behavior changes (documentation only)
</success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-09-SUMMARY.md`
</output>
