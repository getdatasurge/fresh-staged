---
phase: 21-backend-api-migration-completion
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/notification-policy.service.ts
  - backend/src/routers/notification-policies.router.ts
  - backend/src/trpc/router.ts
  - backend/tests/trpc/notification-policies.router.test.ts
  - backend/tests/services/notification-policy.service.test.ts
autonomous: true

must_haves:
  truths:
    - "User can list notification policies at org, site, and unit levels via tRPC"
    - "User can get effective notification policy for unit+alert type via tRPC"
    - "Admin can create, update, and delete notification policies via tRPC"
  artifacts:
    - path: "backend/src/services/notification-policy.service.ts"
      provides: "Notification policy CRUD and effective policy lookup"
      exports: ["getEffectiveNotificationPolicy", "listNotificationPolicies", "upsertNotificationPolicy", "deleteNotificationPolicy"]
    - path: "backend/src/routers/notification-policies.router.ts"
      provides: "Notification policy management"
      exports: ["notificationPoliciesRouter"]
  key_links:
    - from: "backend/src/routers/notification-policies.router.ts"
      to: "notification-policy.service.ts"
      via: "service calls"
      pattern: "getEffectiveNotificationPolicy"
    - from: "backend/src/trpc/router.ts"
      to: "notificationPolicies router"
      via: "router composition"
      pattern: "notificationPolicies: notificationPoliciesRouter"
---

<objective>
Create notification policy service and tRPC router to replace Supabase RPC function `get_effective_notification_policy` and direct table queries.

Purpose: Enable frontend notification policy hooks to migrate from Supabase to tRPC with full CRUD and effective policy resolution.

Output: New service with effective policy logic, tRPC router with 6+ procedures, comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-RESEARCH.md

Reference frontend usage being replaced:
@src/hooks/useNotificationPolicies.ts

Reference database schema:
@backend/src/db/schema/alerts.ts

Reference existing router patterns:
@backend/src/routers/alerts.router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification policy service with effective policy logic</name>
  <files>
    backend/src/services/notification-policy.service.ts
  </files>
  <action>
Create backend/src/services/notification-policy.service.ts with the following functions:

1. `listNotificationPolicies(scope: { organizationId?: string, siteId?: string, unitId?: string })`
   - Query notification_policies table based on scope
   - Return array of NotificationPolicy objects
   - Parse escalation_steps from JSON if stored as text

2. `getNotificationPolicy(id: string, organizationId: string)`
   - Get single policy by ID, verify org membership
   - Return NotificationPolicy or null

3. `upsertNotificationPolicy(scope, alertType, policy)`
   - Upsert notification policy using conflict on unique index
   - Handle the three unique constraints: (organization_id, alert_type), (site_id, alert_type), (unit_id, alert_type)
   - Store escalation_steps as JSON

4. `deleteNotificationPolicy(scope, alertType)`
   - Delete policy matching scope and alert type
   - Return true if deleted, false if not found

5. `getEffectiveNotificationPolicy(unitId: string, alertType: string)`
   - This replaces the Supabase RPC function
   - Implement inheritance chain: unit -> site -> org
   - Logic:
     a. First, get the unit to find its area_id, then area to find site_id, site to find organization_id
     b. Look for policy at unit level for this alert type
     c. If not found, look at site level
     d. If not found, look at org level
     e. If not found, return null (or default policy)
   - Return EffectiveNotificationPolicy with source flags (source_unit, source_site, source_org)

Use Drizzle ORM for all queries. Reference the notification_policies table schema.

Export types:
- NotificationPolicy
- EffectiveNotificationPolicy
- NotificationChannel
- EscalationStep
  </action>
  <verify>
npx tsc --noEmit -p backend/tsconfig.json
grep -q "getEffectiveNotificationPolicy" backend/src/services/notification-policy.service.ts
  </verify>
  <done>
Notification policy service compiles with effective policy logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification policies tRPC router</name>
  <files>
    backend/src/routers/notification-policies.router.ts
    backend/src/trpc/router.ts
  </files>
  <action>
Create backend/src/routers/notification-policies.router.ts with 6 procedures:

1. `listByOrg` - orgProcedure
   - Input: { organizationId }
   - Call listNotificationPolicies({ organizationId })
   - Return array of policies at org level

2. `listBySite` - orgProcedure
   - Input: { organizationId, siteId }
   - Call listNotificationPolicies({ siteId })
   - Return array of policies at site level

3. `listByUnit` - orgProcedure
   - Input: { organizationId, unitId }
   - Call listNotificationPolicies({ unitId })
   - Return array of policies at unit level

4. `getEffective` - orgProcedure
   - Input: { organizationId, unitId, alertType }
   - Call getEffectiveNotificationPolicy(unitId, alertType)
   - Return effective policy with source flags, or null

5. `upsert` - orgProcedure (admin/owner role check)
   - Input: { organizationId, scope: { organization_id?, site_id?, unit_id? }, alertType, policy }
   - Call upsertNotificationPolicy(scope, alertType, policy)
   - Return upserted policy

6. `delete` - orgProcedure (admin/owner role check)
   - Input: { organizationId, scope: { organization_id?, site_id?, unit_id? }, alertType }
   - Call deleteNotificationPolicy(scope, alertType)
   - Return { success: boolean }

Define input/output schemas using Zod:
- NotificationPolicySchema
- EffectiveNotificationPolicySchema
- EscalationStepSchema

Register in router.ts:
- `notificationPolicies: notificationPoliciesRouter`
  </action>
  <verify>
npx tsc --noEmit -p backend/tsconfig.json
grep -q "notificationPoliciesRouter" backend/src/trpc/router.ts
  </verify>
  <done>
Notification policies router compiles and is registered in appRouter
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for service and router</name>
  <files>
    backend/tests/services/notification-policy.service.test.ts
    backend/tests/trpc/notification-policies.router.test.ts
  </files>
  <action>
Create backend/tests/services/notification-policy.service.test.ts:
- Test listNotificationPolicies: returns policies for each scope type
- Test getEffectiveNotificationPolicy:
  - Returns unit-level policy when exists (source_unit: true)
  - Falls back to site-level when no unit policy (source_site: true)
  - Falls back to org-level when no site/unit policy (source_org: true)
  - Returns null when no policy at any level
- Test upsertNotificationPolicy: creates new, updates existing
- Test deleteNotificationPolicy: deletes existing, returns false for non-existent

Create backend/tests/trpc/notification-policies.router.test.ts:
- Mock notification-policy.service
- Test listByOrg: returns org-level policies
- Test listBySite: returns site-level policies
- Test listByUnit: returns unit-level policies
- Test getEffective: returns effective policy with source flags
- Test upsert: success for admin, FORBIDDEN for non-admin
- Test delete: success for admin, FORBIDDEN for non-admin

Aim for ~15-20 test cases total across both files.
  </action>
  <verify>
npm run test -- backend/tests/services/notification-policy.service.test.ts backend/tests/trpc/notification-policies.router.test.ts --run
  </verify>
  <done>
All notification policy tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p backend/tsconfig.json`
2. Service implements effective policy inheritance chain
3. Router registered in appRouter
4. All new tests pass
5. Effective policy logic matches Supabase RPC behavior
</verification>

<success_criteria>
- notificationPoliciesRouter exported and registered
- getEffectiveNotificationPolicy service implements unit->site->org inheritance
- 6 procedures covering all frontend hook use cases
- ~30 new tests passing (service + router)
- Backend builds without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-04-SUMMARY.md`
</output>
