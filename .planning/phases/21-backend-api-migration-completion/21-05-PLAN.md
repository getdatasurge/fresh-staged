---
phase: 21-backend-api-migration-completion
plan: 05
type: execute
wave: 2
depends_on: ['21-01', '21-02', '21-03', '21-04']
files_modified:
  - src/hooks/useNotificationPolicies.ts
  - src/hooks/useTTNSettings.ts
  - src/hooks/useTTNApiKey.ts
  - src/hooks/useTTNWebhook.ts
  - src/hooks/useTTNOperations.ts
  - src/hooks/useTTNSetupWizard.ts
  - src/hooks/useTTNDeprovision.ts
  - src/hooks/useGateways.ts
  - src/hooks/useLoraSensors.ts
  - src/hooks/useGatewayProvisioningPreflight.ts
  - src/hooks/useCheckTtnProvisioningState.ts
  - src/hooks/useEscalationContacts.ts
  - src/hooks/usePreferences.ts
  - src/hooks/useSmsConfig.ts
  - src/hooks/usePayments.ts
autonomous: true

must_haves:
  truths:
    - 'All TTN hooks use tRPC instead of Supabase'
    - 'Notification policy hooks use tRPC getEffective procedure'
    - 'Settings hooks (preferences, SMS, payments) use tRPC'
  artifacts:
    - path: 'src/hooks/useNotificationPolicies.ts'
      provides: 'tRPC-based notification policy hooks'
      contains: 'useTRPC'
    - path: 'src/hooks/useTTNSettings.ts'
      provides: 'tRPC-based TTN settings hooks'
      contains: 'useTRPC'
  key_links:
    - from: 'src/hooks/*'
      to: '@/lib/trpc'
      via: 'useTRPC import'
      pattern: 'from.*@/lib/trpc'
---

<objective>
Migrate TTN, notification policy, and settings frontend hooks from Supabase to tRPC.

Purpose: Remove direct Supabase usage from the first batch of frontend hooks, enabling eventual @supabase/supabase-js removal.

Output: ~15 hook files migrated to use tRPC, no Supabase imports in these files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-RESEARCH.md

Reference tRPC hook patterns from Phase 20:
@src/hooks/useSites.ts
@src/hooks/useAlerts.ts

Reference hooks to migrate:
@src/hooks/useNotificationPolicies.ts
@src/hooks/useTTNSettings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate notification policy hooks to tRPC</name>
  <files>
    src/hooks/useNotificationPolicies.ts
    src/hooks/useEscalationContacts.ts
  </files>
  <action>
Migrate src/hooks/useNotificationPolicies.ts:

1. Remove: `import { supabase } from "@/integrations/supabase/client"`
2. Add: `import { useTRPC, useTRPCClient } from "@/lib/trpc"`

3. Rewrite `useOrgNotificationPolicies`:

```typescript
export function useOrgNotificationPolicies(orgId: string | null) {
  const trpc = useTRPC();

  return trpc.notificationPolicies.listByOrg.useQuery(
    { organizationId: orgId! },
    { enabled: !!orgId },
  );
}
```

4. Rewrite `useSiteNotificationPolicies`:

```typescript
export function useSiteNotificationPolicies(siteId: string | null, orgId?: string) {
  const trpc = useTRPC();

  return trpc.notificationPolicies.listBySite.useQuery(
    { organizationId: orgId!, siteId: siteId! },
    { enabled: !!siteId && !!orgId },
  );
}
```

5. Rewrite `useUnitNotificationPolicies` similarly

6. Rewrite `useEffectiveNotificationPolicy`:

```typescript
export function useEffectiveNotificationPolicy(
  unitId: string | null,
  alertType: string | null,
  orgId?: string,
) {
  const trpc = useTRPC();

  return trpc.notificationPolicies.getEffective.useQuery(
    { organizationId: orgId!, unitId: unitId!, alertType: alertType! },
    { enabled: !!unitId && !!alertType && !!orgId },
  );
}
```

7. Rewrite `useUpsertNotificationPolicy` and `useDeleteNotificationPolicy` as mutations:

```typescript
export function useUpsertNotificationPolicy() {
  const client = useTRPCClient();
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ scope, alertType, policy, orgId }) => {
      return client.notificationPolicies.upsert.mutate({
        organizationId: orgId,
        scope,
        alertType,
        policy,
      });
    },
    onSuccess: () => {
      // Invalidate notification policy queries
    },
  });
}
```

8. Keep helper functions (getPolicyForAlertType, mapDbRowToPolicy) if still needed for type mapping

Migrate src/hooks/useEscalationContacts.ts similarly if it uses Supabase.
</action>
<verify>
npx tsc --noEmit -p tsconfig.json
grep -L "supabase" src/hooks/useNotificationPolicies.ts || echo "Still has supabase"
</verify>
<done>
Notification policy hooks compile and don't import supabase
</done>
</task>

<task type="auto">
  <name>Task 2: Migrate TTN hooks to tRPC</name>
  <files>
    src/hooks/useTTNSettings.ts
    src/hooks/useTTNApiKey.ts
    src/hooks/useTTNWebhook.ts
    src/hooks/useTTNOperations.ts
    src/hooks/useTTNSetupWizard.ts
    src/hooks/useTTNDeprovision.ts
    src/hooks/useGateways.ts
    src/hooks/useLoraSensors.ts
    src/hooks/useGatewayProvisioningPreflight.ts
    src/hooks/useCheckTtnProvisioningState.ts
  </files>
  <action>
For each TTN-related hook file:

1. Remove Supabase imports
2. Add tRPC imports: `import { useTRPC, useTRPCClient } from "@/lib/trpc"`

3. Convert Supabase queries to tRPC:
   - `supabase.from('ttn_devices').select(...)` -> `trpc.ttnDevices.list.useQuery(...)`
   - `supabase.from('ttn_gateways').select(...)` -> `trpc.ttnGateways.list.useQuery(...)`

4. Convert Supabase edge function calls to tRPC mutations:
   - `supabase.functions.invoke('ttn-bootstrap', ...)` -> `client.ttnDevices.bootstrap.mutate(...)`
   - `supabase.functions.invoke('manage-ttn-settings', ...)` -> equivalent tRPC procedure

5. For useTTNSettings.ts specifically:
   - Query hooks should use tRPC queries
   - Mutation hooks should use tRPC mutations
   - Keep the same hook signatures for backward compatibility

6. For useLoraSensors.ts:
   - Convert device queries to use ttnDevices.list

7. For useGateways.ts:
   - Use ttnGateways.list, ttnGateways.register, etc.

8. For provision/deprovision hooks:
   - Use ttnDevices.provision, ttnDevices.bootstrap, ttnDevices.deprovision

Note: Some edge function equivalents may need to be added to the backend routers if not already covered. In that case, add TODO comments and continue with available procedures.
</action>
<verify>
npx tsc --noEmit -p tsconfig.json
for f in src/hooks/useTTN\*.ts src/hooks/useGateways.ts src/hooks/useLoraSensors.ts; do grep -L "supabase" "$f" || echo "$f still has supabase"; done
</verify>
<done>
All TTN hooks compile and don't import supabase
</done>
</task>

<task type="auto">
  <name>Task 3: Create settings hooks (preferences, SMS, payments)</name>
  <files>
    src/hooks/usePreferences.ts
    src/hooks/useSmsConfig.ts
    src/hooks/usePayments.ts
  </files>
  <action>
Create new hook files following the established tRPC patterns:

Create src/hooks/usePreferences.ts:

```typescript
import { useTRPC, useTRPCClient } from "@/lib/trpc";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

export function useDigestPreferences(options?: { enabled?: boolean }) {
  const trpc = useTRPC();

  return trpc.preferences.getDigest.useQuery(undefined, {
    enabled: options?.enabled !== false,
  });
}

export function useUpdateDigestPreferences() {
  const client = useTRPCClient();
  const queryClient = useQueryClient();
  const trpc = useTRPC();

  return useMutation({
    mutationFn: async (preferences: {...}) => {
      return client.preferences.updateDigest.mutate(preferences);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({
        queryKey: trpc.preferences.getDigest.queryOptions().queryKey
      });
    },
  });
}

export function useDisableAllDigests() {
  const client = useTRPCClient();
  const queryClient = useQueryClient();
  const trpc = useTRPC();

  return useMutation({
    mutationFn: async () => {
      return client.preferences.disableAllDigests.mutate();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({
        queryKey: trpc.preferences.getDigest.queryOptions().queryKey
      });
    },
  });
}
```

Create src/hooks/useSmsConfig.ts:

- useSmsConfig(organizationId) - query
- useUpsertSmsConfig() - mutation

Create src/hooks/usePayments.ts:

- useSubscription(organizationId) - query
- useCreateCheckoutSession() - mutation
- useCreatePortalSession() - mutation

Follow the patterns from useSites.ts and useAlerts.ts for query options and cache invalidation.
</action>
<verify>
npx tsc --noEmit -p tsconfig.json
ls src/hooks/usePreferences.ts src/hooks/useSmsConfig.ts src/hooks/usePayments.ts
</verify>
<done>
New settings hooks created and compile
</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p tsconfig.json`
2. No Supabase imports in migrated files: `grep -l "supabase" src/hooks/use{NotificationPolicies,TTN*,Gateways,LoraSensors,Preferences,SmsConfig,Payments}.ts` returns empty
3. All hooks export correctly
4. Frontend builds: `npm run build`
</verification>

<success_criteria>

- ~15 hook files migrated to tRPC
- No Supabase imports in migrated hooks
- New settings hooks created (preferences, SMS, payments)
- Frontend TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-05-SUMMARY.md`
</output>
