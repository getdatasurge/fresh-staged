---
phase: 21-backend-api-migration-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/preferences.router.ts
  - backend/src/routers/sms-config.router.ts
  - backend/src/routers/payments.router.ts
  - backend/src/trpc/router.ts
  - backend/tests/trpc/preferences.router.test.ts
  - backend/tests/trpc/sms-config.router.test.ts
  - backend/tests/trpc/payments.router.test.ts
autonomous: true

must_haves:
  truths:
    - 'User can get and update digest preferences via tRPC'
    - 'Admin can configure SMS alerting via tRPC'
    - 'User can create checkout sessions and access billing portal via tRPC'
  artifacts:
    - path: 'backend/src/routers/preferences.router.ts'
      provides: 'Digest preferences CRUD'
      exports: ['preferencesRouter']
    - path: 'backend/src/routers/sms-config.router.ts'
      provides: 'SMS configuration management'
      exports: ['smsConfigRouter']
    - path: 'backend/src/routers/payments.router.ts'
      provides: 'Stripe billing operations'
      exports: ['paymentsRouter']
  key_links:
    - from: 'backend/src/trpc/router.ts'
      to: 'preferences, smsConfig, payments routers'
      via: 'router composition'
      pattern: 'preferences: preferencesRouter'
---

<objective>
Create tRPC routers for Settings domain: user preferences, SMS configuration, and payments/billing.

Purpose: Enable frontend to migrate from REST endpoints to type-safe tRPC procedures for user settings and billing operations.

Output: Three new tRPC routers registered in appRouter with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-backend-api-migration-completion/21-RESEARCH.md

Reference existing router patterns:
@backend/src/routers/organizations.router.ts
@backend/src/routers/sites.router.ts
@backend/tests/trpc/organizations.router.test.ts

Reference REST routes being replaced:
@backend/src/routes/preferences.ts
@backend/src/routes/sms-config.ts
@backend/src/routes/payments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preferences tRPC router</name>
  <files>
    backend/src/routers/preferences.router.ts
    backend/src/trpc/router.ts
  </files>
  <action>
Create backend/src/routers/preferences.router.ts with three procedures:

1. `getDigest` - protectedProcedure (operates on ctx.user.id)
   - Query user's profile for digest preferences
   - Return: digestDaily, digestWeekly, digestDailyTime, digestSiteIds, timezone, emailEnabled
   - Parse digestSiteIds from JSON text to array

2. `updateDigest` - protectedProcedure
   - Input: UpdateDigestPreferencesSchema (digestDaily, digestWeekly, digestDailyTime, digestSiteIds, timezone - all optional)
   - Update profile in database
   - Call syncUserDigestSchedulers fire-and-forget pattern (don't await, catch errors)
   - Return updated preferences

3. `disableAllDigests` - protectedProcedure
   - Set digestDaily and digestWeekly to false
   - Call removeUserDigestSchedulers
   - Return { success: true, message: "All digest emails disabled" }

Key patterns from REST route to preserve:

- JSON.parse/stringify for digestSiteIds (stored as text)
- HH:MM validation regex for digestDailyTime
- Fire-and-forget scheduler sync (don't block response)

Register in router.ts: `preferences: preferencesRouter`
</action>
<verify>
npx tsc --noEmit -p backend/tsconfig.json
grep -q "preferencesRouter" backend/src/trpc/router.ts
</verify>
<done>
Preferences router compiles and is registered in appRouter
</done>
</task>

<task type="auto">
  <name>Task 2: Create sms-config and payments tRPC routers</name>
  <files>
    backend/src/routers/sms-config.router.ts
    backend/src/routers/payments.router.ts
    backend/src/trpc/router.ts
  </files>
  <action>
Create backend/src/routers/sms-config.router.ts with two procedures:

1. `get` - orgProcedure
   - Call smsConfigService.getSmsConfig(ctx.user.organizationId)
   - If no config: return { configured: false, message: "..." }
   - Otherwise return config

2. `upsert` - orgProcedure
   - Input: { organizationId, data: SmsConfigCreateSchema }
   - Role check: admin/owner only (throw FORBIDDEN if not)
   - Call smsConfigService.upsertSmsConfig
   - Handle SmsConfigError as BAD_REQUEST

Create backend/src/routers/payments.router.ts with three procedures:

1. `getSubscription` - orgProcedure
   - Call checkoutService.getSubscription(ctx.user.organizationId)
   - Return subscription (nullable)

2. `createCheckoutSession` - orgProcedure
   - Input: { organizationId, data: CreateCheckoutSessionSchema }
   - Call checkoutService.createCheckoutSession(orgId, userId, data)
   - Handle StripeConfigError/CheckoutError as BAD_REQUEST

3. `createPortalSession` - orgProcedure
   - Input: { organizationId, data: CreatePortalSessionSchema }
   - Call checkoutService.createPortalSession(orgId, data)
   - Handle StripeConfigError/PortalError as BAD_REQUEST

Register both in router.ts:

- `smsConfig: smsConfigRouter`
- `payments: paymentsRouter`
  </action>
  <verify>
  npx tsc --noEmit -p backend/tsconfig.json
  grep -q "smsConfigRouter" backend/src/trpc/router.ts
  grep -q "paymentsRouter" backend/src/trpc/router.ts
  </verify>
  <done>
  SMS config and payments routers compile and are registered in appRouter
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add unit tests for all three routers</name>
  <files>
    backend/tests/trpc/preferences.router.test.ts
    backend/tests/trpc/sms-config.router.test.ts
    backend/tests/trpc/payments.router.test.ts
  </files>
  <action>
Follow existing test patterns from organizations.router.test.ts and sites.router.test.ts.

Create backend/tests/trpc/preferences.router.test.ts:

- Mock db, digest-schedulers
- Test getDigest: returns preferences, handles profile not found
- Test updateDigest: updates database, syncs schedulers
- Test disableAllDigests: disables both, removes schedulers

Create backend/tests/trpc/sms-config.router.test.ts:

- Mock smsConfigService
- Test get: returns config when exists, returns unconfigured message when not
- Test upsert: success for admin, FORBIDDEN for non-admin

Create backend/tests/trpc/payments.router.test.ts:

- Mock checkoutService
- Test getSubscription: returns subscription or null
- Test createCheckoutSession: success, handles errors
- Test createPortalSession: success, handles errors

Each test file should have ~8-12 test cases covering happy path and error cases.
</action>
<verify>
npm run test -- backend/tests/trpc/preferences.router.test.ts backend/tests/trpc/sms-config.router.test.ts backend/tests/trpc/payments.router.test.ts --run
</verify>
<done>
All three test files pass with comprehensive coverage
</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p backend/tsconfig.json`
2. All three routers registered in appRouter
3. All new tests pass: `npm run test -- backend/tests/trpc/*.router.test.ts --run`
4. REST routes still work (parallel operation until frontend migrates)
</verification>

<success_criteria>

- preferencesRouter, smsConfigRouter, paymentsRouter exported and registered
- 8 total procedures across 3 routers
- ~30 new tests passing
- Backend builds without type errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-backend-api-migration-completion/21-01-SUMMARY.md`
</output>
