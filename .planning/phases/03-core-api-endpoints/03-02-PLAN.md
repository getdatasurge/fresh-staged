---
phase: 03-core-api-endpoints
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/organization.service.ts
  - backend/src/services/index.ts
  - backend/src/schemas/organizations.ts
  - backend/src/schemas/index.ts
  - backend/src/routes/organizations.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - 'User can GET their organization details'
    - 'Owner can PUT/update organization settings'
    - 'User can list organization members'
    - 'Non-members cannot access organization (403)'
  artifacts:
    - path: 'backend/src/services/organization.service.ts'
      provides: 'Organization database operations'
      exports: ['getOrganization', 'updateOrganization', 'listMembers']
    - path: 'backend/src/routes/organizations.ts'
      provides: 'Organization REST endpoints'
      exports: ['default (Fastify plugin)']
    - path: 'backend/src/schemas/organizations.ts'
      provides: 'Zod schemas for organization endpoints'
      exports: ['OrganizationSchema', 'UpdateOrganizationSchema', 'MemberSchema']
  key_links:
    - from: 'backend/src/routes/organizations.ts'
      to: 'backend/src/services/organization.service.ts'
      via: 'service function imports'
      pattern: "orgService\\."
    - from: 'backend/src/app.ts'
      to: 'backend/src/routes/organizations.ts'
      via: 'app.register'
      pattern: 'register.*organizations'
---

<objective>
Implement Organization endpoints (GET, PUT) and members list.

Purpose: Allow users to view and update organization settings, and see team members.
Output: Organization service, Zod schemas, route handlers registered in app.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-api-endpoints/03-RESEARCH.md (service layer patterns)
@.planning/phases/03-core-api-endpoints/03-CONTEXT.md (decisions)
@backend/src/db/schema/tenancy.ts (organizations table)
@backend/src/db/schema/users.ts (userRoles, profiles tables)
@backend/src/middleware/index.ts (auth, org-context, rbac)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization service</name>
  <files>backend/src/services/organization.service.ts, backend/src/services/index.ts</files>
  <action>
Create `backend/src/services/organization.service.ts`:

```typescript
import { eq, and } from 'drizzle-orm';
import { db } from '../db/client.js';
import { organizations, type Organization, type InsertOrganization } from '../db/schema/tenancy.js';
import { userRoles, profiles } from '../db/schema/users.js';
import type { AppRole } from '../types/auth.js';

/**
 * Get organization by ID
 */
export async function getOrganization(organizationId: string): Promise<Organization | null> {
  const [org] = await db
    .select()
    .from(organizations)
    .where(eq(organizations.id, organizationId))
    .limit(1);

  return org ?? null;
}

/**
 * Update organization settings
 * Only updatable fields are included
 */
export async function updateOrganization(
  organizationId: string,
  data: Partial<Pick<InsertOrganization, 'name' | 'timezone' | 'complianceMode' | 'logoUrl'>>,
): Promise<Organization | null> {
  const [org] = await db
    .update(organizations)
    .set({
      ...data,
      updatedAt: new Date(),
    })
    .where(eq(organizations.id, organizationId))
    .returning();

  return org ?? null;
}

/**
 * List organization members with their roles
 */
export async function listMembers(organizationId: string): Promise<
  Array<{
    userId: string;
    email: string;
    fullName: string | null;
    role: AppRole;
    joinedAt: Date;
  }>
> {
  // Join userRoles with profiles to get member info
  const members = await db
    .select({
      userId: userRoles.userId,
      email: profiles.email,
      fullName: profiles.fullName,
      role: userRoles.role,
      joinedAt: userRoles.createdAt,
    })
    .from(userRoles)
    .leftJoin(
      profiles,
      and(
        eq(profiles.userId, userRoles.userId),
        eq(profiles.organizationId, userRoles.organizationId),
      ),
    )
    .where(eq(userRoles.organizationId, organizationId))
    .orderBy(userRoles.createdAt);

  return members.map((m) => ({
    userId: m.userId,
    email: m.email ?? '',
    fullName: m.fullName,
    role: m.role,
    joinedAt: m.joinedAt,
  }));
}
```

Update `backend/src/services/index.ts` to export organization service:

```typescript
// Services barrel export
export * as userService from './user.service.js';
export * as orgService from './organization.service.js';
```

  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Organization service provides getOrganization, updateOrganization, and listMembers functions.</done>
</task>

<task type="auto">
  <name>Task 2: Create organization Zod schemas</name>
  <files>backend/src/schemas/organizations.ts, backend/src/schemas/index.ts</files>
  <action>
Create `backend/src/schemas/organizations.ts`:

```typescript
import { z } from 'zod';
import { UuidSchema, TimestampSchema, OrgParamsSchema } from './common.js';

// Compliance mode enum matching database
const ComplianceModeSchema = z.enum(['standard', 'haccp']);

// Full organization response schema
export const OrganizationSchema = z.object({
  id: UuidSchema,
  name: z.string(),
  slug: z.string(),
  timezone: z.string(),
  complianceMode: ComplianceModeSchema,
  sensorLimit: z.number().int(),
  logoUrl: z.string().url().nullable(),
  createdAt: TimestampSchema,
  updatedAt: TimestampSchema,
});

// Update organization request body
export const UpdateOrganizationSchema = z.object({
  name: z.string().min(1).max(256).optional(),
  timezone: z.string().max(100).optional(),
  complianceMode: ComplianceModeSchema.optional(),
  logoUrl: z.string().url().nullable().optional(),
});

// Role enum matching database
const AppRoleSchema = z.enum(['owner', 'admin', 'manager', 'staff', 'viewer']);

// Organization member response schema
export const MemberSchema = z.object({
  userId: UuidSchema,
  email: z.string().email(),
  fullName: z.string().nullable(),
  role: AppRoleSchema,
  joinedAt: TimestampSchema,
});

// Members list response
export const MembersListSchema = z.array(MemberSchema);

// Re-export params for routes
export { OrgParamsSchema };

// Type exports
export type OrganizationResponse = z.infer<typeof OrganizationSchema>;
export type UpdateOrganizationRequest = z.infer<typeof UpdateOrganizationSchema>;
export type MemberResponse = z.infer<typeof MemberSchema>;
```

Update `backend/src/schemas/index.ts` to include organizations:

```typescript
// Schemas barrel export
export * from './common.js';
export * from './organizations.js';
```

  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Organization Zod schemas are defined for request/response validation.</done>
</task>

<task type="auto">
  <name>Task 3: Create organization routes and register in app</name>
  <files>backend/src/routes/organizations.ts, backend/src/app.ts</files>
  <action>
Create `backend/src/routes/organizations.ts`:

```typescript
import type { FastifyInstance } from 'fastify';
import type { ZodTypeProvider } from 'fastify-type-provider-zod';
import { requireAuth, requireOrgContext, requireRole } from '../middleware/index.js';
import * as orgService from '../services/organization.service.js';
import { notFound } from '../utils/errors.js';
import {
  OrganizationSchema,
  UpdateOrganizationSchema,
  MembersListSchema,
  OrgParamsSchema,
} from '../schemas/organizations.js';
import { ErrorResponseSchema } from '../schemas/common.js';

export default async function organizationRoutes(fastify: FastifyInstance) {
  const app = fastify.withTypeProvider<ZodTypeProvider>();

  // GET /api/orgs/:organizationId - Get organization details
  app.get(
    '/:organizationId',
    {
      preHandler: [requireAuth, requireOrgContext],
      schema: {
        params: OrgParamsSchema,
        response: {
          200: OrganizationSchema,
          404: ErrorResponseSchema,
        },
      },
    },
    async (request, reply) => {
      const org = await orgService.getOrganization(request.user!.organizationId!);

      if (!org) {
        return notFound(reply, 'Organization not found');
      }

      return org;
    },
  );

  // PUT /api/orgs/:organizationId - Update organization settings
  app.put(
    '/:organizationId',
    {
      preHandler: [requireAuth, requireOrgContext, requireRole('owner')],
      schema: {
        params: OrgParamsSchema,
        body: UpdateOrganizationSchema,
        response: {
          200: OrganizationSchema,
          404: ErrorResponseSchema,
        },
      },
    },
    async (request, reply) => {
      const org = await orgService.updateOrganization(request.user!.organizationId!, request.body);

      if (!org) {
        return notFound(reply, 'Organization not found');
      }

      return org;
    },
  );

  // GET /api/orgs/:organizationId/members - List organization members
  app.get(
    '/:organizationId/members',
    {
      preHandler: [requireAuth, requireOrgContext],
      schema: {
        params: OrgParamsSchema,
        response: {
          200: MembersListSchema,
        },
      },
    },
    async (request) => {
      const members = await orgService.listMembers(request.user!.organizationId!);
      return members;
    },
  );
}
```

Update `backend/src/app.ts` to register organization routes:

1. Add import at top:

```typescript
import organizationRoutes from './routes/organizations.js';
```

2. After registering authPlugin, add route registration:

```typescript
// Register API routes
app.register(organizationRoutes, { prefix: '/api/orgs' });
```

The full app.ts should look like:

```typescript
import Fastify, { FastifyInstance } from 'fastify';
import { serializerCompiler, validatorCompiler } from 'fastify-type-provider-zod';
import authPlugin from './plugins/auth.plugin.js';
import { requireAuth, requireOrgContext, requireRole } from './middleware/index.js';
import organizationRoutes from './routes/organizations.js';

export interface AppOptions {
  logger?: boolean;
}

export function buildApp(opts: AppOptions = {}): FastifyInstance {
  const app = Fastify({
    logger: opts.logger ?? false,
  });

  // Configure Zod validation and serialization
  app.setValidatorCompiler(validatorCompiler);
  app.setSerializerCompiler(serializerCompiler);

  // Register auth plugin (decorates request.user)
  app.register(authPlugin);

  // Register API routes
  app.register(organizationRoutes, { prefix: '/api/orgs' });

  // Example protected route for testing (keep for Phase 2 tests)
  app.get(
    '/api/protected',
    {
      preHandler: [requireAuth],
    },
    async (request) => {
      return { userId: request.user!.id, email: request.user!.email };
    },
  );

  // ... keep remaining test routes from Phase 2

  return app;
}

export default buildApp;
```

Note: Keep the existing test routes from Phase 2 for backward compatibility with auth tests.
</action>
<verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors. Run `pnpm test` to verify existing tests still pass.</verify>
<done>Organization routes are registered at /api/orgs with GET, PUT, and /members endpoints.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `pnpm test` passes (existing auth tests still work)
3. Organization service exports getOrganization, updateOrganization, listMembers
4. Organization routes registered at /api/orgs prefix
5. Routes use proper middleware chain (requireAuth -> requireOrgContext -> requireRole)
</verification>

<success_criteria>

- GET /api/orgs/:orgId returns organization details for members
- PUT /api/orgs/:orgId updates organization (owner only)
- GET /api/orgs/:orgId/members returns member list
- Non-members get 403 via requireOrgContext
- Invalid input returns 400 with structured error
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/03-core-api-endpoints/03-02-SUMMARY.md`
</output>
