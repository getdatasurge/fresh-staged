---
phase: 03-core-api-endpoints
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-03"]
files_modified:
  - backend/src/services/area.service.ts
  - backend/src/services/index.ts
  - backend/src/schemas/areas.ts
  - backend/src/schemas/index.ts
  - backend/src/routes/areas.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "User can list areas within a site"
    - "Admin can create a new area in a site"
    - "User can view a specific area"
    - "Admin can update area settings"
    - "Admin can delete (soft) an area"
    - "Area creation validates site belongs to org (hierarchy check)"
  artifacts:
    - path: "backend/src/services/area.service.ts"
      provides: "Area CRUD with hierarchy validation"
      exports: ["listAreas", "getArea", "createArea", "updateArea", "deleteArea"]
    - path: "backend/src/routes/areas.ts"
      provides: "Area REST endpoints"
      exports: ["default (Fastify plugin)"]
    - path: "backend/src/schemas/areas.ts"
      provides: "Zod schemas for area endpoints"
      exports: ["AreaSchema", "CreateAreaSchema", "UpdateAreaSchema"]
  key_links:
    - from: "backend/src/routes/areas.ts"
      to: "backend/src/services/area.service.ts"
      via: "service function imports"
      pattern: "areaService\\."
    - from: "backend/src/services/area.service.ts"
      to: "backend/src/db/schema/hierarchy.ts"
      via: "sites and areas table joins"
      pattern: "innerJoin.*sites"
---

<objective>
Implement Area CRUD endpoints with site hierarchy validation.

Purpose: Allow organization admins to manage subdivisions within physical sites.
Output: Area service with hierarchy validation, Zod schemas, route handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-api-endpoints/03-RESEARCH.md (hierarchy validation pitfall)
@.planning/phases/03-core-api-endpoints/03-CONTEXT.md
@backend/src/db/schema/hierarchy.ts (areas, sites tables)
@backend/src/services/site.service.ts (pattern for service)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create area service with hierarchy validation</name>
  <files>backend/src/services/area.service.ts, backend/src/services/index.ts</files>
  <action>
Create `backend/src/services/area.service.ts`:

```typescript
import { eq, and } from 'drizzle-orm';
import { db } from '../db/client.js';
import { areas, sites, type Area, type InsertArea } from '../db/schema/hierarchy.js';

/**
 * Verify site belongs to organization
 * CRITICAL: Prevents BOLA by ensuring hierarchy integrity
 */
async function verifySiteAccess(
  siteId: string,
  organizationId: string
): Promise<boolean> {
  const [site] = await db
    .select({ id: sites.id })
    .from(sites)
    .where(and(
      eq(sites.id, siteId),
      eq(sites.organizationId, organizationId),
      eq(sites.isActive, true)
    ))
    .limit(1);

  return !!site;
}

/**
 * List all active areas in a site
 */
export async function listAreas(
  siteId: string,
  organizationId: string
): Promise<Area[] | null> {
  // Verify site hierarchy first
  if (!await verifySiteAccess(siteId, organizationId)) {
    return null; // Site not found or not in org
  }

  return db
    .select()
    .from(areas)
    .where(and(
      eq(areas.siteId, siteId),
      eq(areas.isActive, true)
    ))
    .orderBy(areas.sortOrder, areas.name);
}

/**
 * Get a specific area by ID
 */
export async function getArea(
  areaId: string,
  siteId: string,
  organizationId: string
): Promise<Area | null> {
  // Verify full hierarchy: org -> site -> area
  if (!await verifySiteAccess(siteId, organizationId)) {
    return null;
  }

  const [area] = await db
    .select()
    .from(areas)
    .where(and(
      eq(areas.id, areaId),
      eq(areas.siteId, siteId),
      eq(areas.isActive, true)
    ))
    .limit(1);

  return area ?? null;
}

/**
 * Create a new area in a site
 */
export async function createArea(
  siteId: string,
  organizationId: string,
  data: Omit<InsertArea, 'id' | 'siteId' | 'createdAt' | 'updatedAt' | 'isActive'>
): Promise<Area | null> {
  // Verify site hierarchy first
  if (!await verifySiteAccess(siteId, organizationId)) {
    return null; // Site not found or not in org
  }

  const [area] = await db
    .insert(areas)
    .values({
      ...data,
      siteId,
    })
    .returning();

  return area;
}

/**
 * Update an existing area
 */
export async function updateArea(
  areaId: string,
  siteId: string,
  organizationId: string,
  data: Partial<Omit<InsertArea, 'id' | 'siteId' | 'createdAt' | 'updatedAt'>>
): Promise<Area | null> {
  // Verify hierarchy first
  if (!await verifySiteAccess(siteId, organizationId)) {
    return null;
  }

  const [area] = await db
    .update(areas)
    .set({
      ...data,
      updatedAt: new Date(),
    })
    .where(and(
      eq(areas.id, areaId),
      eq(areas.siteId, siteId),
      eq(areas.isActive, true)
    ))
    .returning();

  return area ?? null;
}

/**
 * Soft delete an area
 */
export async function deleteArea(
  areaId: string,
  siteId: string,
  organizationId: string
): Promise<Area | null> {
  // Verify hierarchy first
  if (!await verifySiteAccess(siteId, organizationId)) {
    return null;
  }

  const [area] = await db
    .update(areas)
    .set({
      isActive: false,
      updatedAt: new Date(),
    })
    .where(and(
      eq(areas.id, areaId),
      eq(areas.siteId, siteId),
      eq(areas.isActive, true)
    ))
    .returning();

  return area ?? null;
}
```

Update `backend/src/services/index.ts`:

```typescript
// Services barrel export
export * as userService from './user.service.js';
export * as orgService from './organization.service.js';
export * as siteService from './site.service.js';
export * as areaService from './area.service.js';
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Area service provides CRUD with hierarchy validation (site must belong to org).</done>
</task>

<task type="auto">
  <name>Task 2: Create area Zod schemas</name>
  <files>backend/src/schemas/areas.ts, backend/src/schemas/index.ts</files>
  <action>
Create `backend/src/schemas/areas.ts`:

```typescript
import { z } from 'zod';
import { UuidSchema, TimestampSchema, SiteParamsSchema } from './common.js';

// Area params (org + site + optional area)
export const AreaParamsSchema = SiteParamsSchema.extend({
  areaId: UuidSchema.optional(),
});

// Area params with required areaId
export const AreaRequiredParamsSchema = SiteParamsSchema.extend({
  areaId: UuidSchema,
});

// Full area response schema
export const AreaSchema = z.object({
  id: UuidSchema,
  siteId: UuidSchema,
  name: z.string(),
  description: z.string().nullable(),
  sortOrder: z.number().int(),
  isActive: z.boolean(),
  createdAt: TimestampSchema,
  updatedAt: TimestampSchema,
});

// Create area request body
export const CreateAreaSchema = z.object({
  name: z.string().min(1).max(256),
  description: z.string().max(1000).nullable().optional(),
  sortOrder: z.number().int().min(0).default(0),
});

// Update area request body (all fields optional)
export const UpdateAreaSchema = CreateAreaSchema.partial();

// Areas list response
export const AreasListSchema = z.array(AreaSchema);

// Type exports
export type AreaResponse = z.infer<typeof AreaSchema>;
export type CreateAreaRequest = z.infer<typeof CreateAreaSchema>;
export type UpdateAreaRequest = z.infer<typeof UpdateAreaSchema>;
```

Update `backend/src/schemas/index.ts`:

```typescript
// Schemas barrel export
export * from './common.js';
export * from './organizations.js';
export * from './sites.js';
export * from './areas.js';
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Area Zod schemas are defined for request/response validation.</done>
</task>

<task type="auto">
  <name>Task 3: Create area routes and register in app</name>
  <files>backend/src/routes/areas.ts, backend/src/app.ts</files>
  <action>
Create `backend/src/routes/areas.ts`:

```typescript
import type { FastifyInstance } from 'fastify';
import type { ZodTypeProvider } from 'fastify-type-provider-zod';
import { requireAuth, requireOrgContext, requireRole } from '../middleware/index.js';
import * as areaService from '../services/area.service.js';
import { notFound } from '../utils/errors.js';
import {
  AreaSchema,
  AreasListSchema,
  CreateAreaSchema,
  UpdateAreaSchema,
  AreaRequiredParamsSchema,
} from '../schemas/areas.js';
import { SiteParamsSchema, ErrorResponseSchema } from '../schemas/common.js';

export default async function areaRoutes(fastify: FastifyInstance) {
  const app = fastify.withTypeProvider<ZodTypeProvider>();

  // GET /api/orgs/:organizationId/sites/:siteId/areas - List areas
  app.get('/', {
    preHandler: [requireAuth, requireOrgContext],
    schema: {
      params: SiteParamsSchema,
      response: {
        200: AreasListSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const areas = await areaService.listAreas(
      request.params.siteId,
      request.user!.organizationId!
    );

    if (areas === null) {
      return notFound(reply, 'Site not found');
    }

    return areas;
  });

  // POST /api/orgs/:organizationId/sites/:siteId/areas - Create area
  app.post('/', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: SiteParamsSchema,
      body: CreateAreaSchema,
      response: {
        201: AreaSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const area = await areaService.createArea(
      request.params.siteId,
      request.user!.organizationId!,
      request.body
    );

    if (!area) {
      return notFound(reply, 'Site not found');
    }

    reply.code(201);
    return area;
  });

  // GET /api/orgs/:organizationId/sites/:siteId/areas/:areaId - Get area
  app.get('/:areaId', {
    preHandler: [requireAuth, requireOrgContext],
    schema: {
      params: AreaRequiredParamsSchema,
      response: {
        200: AreaSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const area = await areaService.getArea(
      request.params.areaId,
      request.params.siteId,
      request.user!.organizationId!
    );

    if (!area) {
      return notFound(reply, 'Area not found');
    }

    return area;
  });

  // PUT /api/orgs/:organizationId/sites/:siteId/areas/:areaId - Update area
  app.put('/:areaId', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: AreaRequiredParamsSchema,
      body: UpdateAreaSchema,
      response: {
        200: AreaSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const area = await areaService.updateArea(
      request.params.areaId,
      request.params.siteId,
      request.user!.organizationId!,
      request.body
    );

    if (!area) {
      return notFound(reply, 'Area not found');
    }

    return area;
  });

  // DELETE /api/orgs/:organizationId/sites/:siteId/areas/:areaId - Delete area
  app.delete('/:areaId', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: AreaRequiredParamsSchema,
      response: {
        204: { type: 'null' as const, description: 'No content' },
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const area = await areaService.deleteArea(
      request.params.areaId,
      request.params.siteId,
      request.user!.organizationId!
    );

    if (!area) {
      return notFound(reply, 'Area not found');
    }

    reply.code(204);
    return;
  });
}
```

Update `backend/src/app.ts` to register area routes:

1. Add import at top:
```typescript
import areaRoutes from './routes/areas.js';
```

2. Register areas routes with nested prefix:
```typescript
// Register API routes
app.register(organizationRoutes, { prefix: '/api/orgs' });
app.register(siteRoutes, { prefix: '/api/orgs/:organizationId/sites' });
app.register(areaRoutes, { prefix: '/api/orgs/:organizationId/sites/:siteId/areas' });
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors. Run `pnpm test` to verify existing tests still pass.</verify>
  <done>Area routes registered at /api/orgs/:orgId/sites/:siteId/areas with hierarchy validation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `pnpm test` passes (existing auth tests still work)
3. Area service validates site belongs to org before any operation
4. Area routes use full hierarchy path /api/orgs/:orgId/sites/:siteId/areas
5. Create/Update/Delete routes require admin role
</verification>

<success_criteria>
- GET /api/orgs/:orgId/sites/:siteId/areas lists site's active areas
- POST /api/orgs/:orgId/sites/:siteId/areas creates area (admin+ only)
- GET /api/orgs/:orgId/sites/:siteId/areas/:areaId returns area details
- PUT /api/orgs/:orgId/sites/:siteId/areas/:areaId updates area (admin+ only)
- DELETE /api/orgs/:orgId/sites/:siteId/areas/:areaId soft-deletes area (admin+ only)
- Invalid site returns 404 (hierarchy validation)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-api-endpoints/03-04-SUMMARY.md`
</output>
