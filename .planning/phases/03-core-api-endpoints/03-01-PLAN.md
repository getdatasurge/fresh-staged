---
phase: 03-core-api-endpoints
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/schemas/common.ts
  - backend/src/schemas/index.ts
  - backend/src/utils/errors.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "Zod and fastify-type-provider-zod are installed and available"
    - "Common validation schemas (UUID, pagination, timestamps) are reusable"
    - "API errors follow structured format with code, message, and details"
    - "Fastify app uses Zod type provider for type-safe validation"
  artifacts:
    - path: "backend/src/schemas/common.ts"
      provides: "Reusable Zod schemas for validation"
      exports: ["UuidSchema", "TimestampSchema", "OrgParamsSchema", "ErrorResponseSchema"]
    - path: "backend/src/utils/errors.ts"
      provides: "Error response helpers"
      exports: ["notFound", "validationError", "forbidden"]
    - path: "backend/src/app.ts"
      provides: "Fastify app with Zod type provider"
      contains: "ZodTypeProvider"
  key_links:
    - from: "backend/src/app.ts"
      to: "fastify-type-provider-zod"
      via: "withTypeProvider import and registration"
      pattern: "ZodTypeProvider"
---

<objective>
Set up Zod validation infrastructure and common schemas for all API endpoints.

Purpose: Establish type-safe request/response validation foundation that all route files will use.
Output: Zod dependency installed, common schemas for UUIDs, params, errors, and Fastify app configured with type provider.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-api-endpoints/03-RESEARCH.md (validation patterns)
@backend/src/app.ts (current app setup)
@backend/package.json (dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zod dependencies</name>
  <files>backend/package.json</files>
  <action>
Install Zod and fastify-type-provider-zod:

```bash
cd backend && pnpm add zod fastify-type-provider-zod
```

These provide:
- `zod`: TypeScript-first schema validation
- `fastify-type-provider-zod`: Bridges Zod with Fastify for type-safe routes
  </action>
  <verify>Run `pnpm list zod fastify-type-provider-zod` and confirm both packages are installed.</verify>
  <done>Zod and fastify-type-provider-zod are in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create common validation schemas</name>
  <files>backend/src/schemas/common.ts, backend/src/schemas/index.ts</files>
  <action>
Create `backend/src/schemas/common.ts` with reusable Zod schemas:

```typescript
import { z } from 'zod';

// --- Primitive Types ---

// UUID validation (RFC 4122)
export const UuidSchema = z.string().uuid();

// ISO 8601 timestamp that converts to Date
export const TimestampSchema = z.coerce.date();

// --- Common Params ---

// Organization-scoped route params
export const OrgParamsSchema = z.object({
  organizationId: UuidSchema,
});

// Site-scoped route params (includes org)
export const SiteParamsSchema = z.object({
  organizationId: UuidSchema,
  siteId: UuidSchema,
});

// Area-scoped route params (includes org, site)
export const AreaParamsSchema = z.object({
  organizationId: UuidSchema,
  siteId: UuidSchema,
  areaId: UuidSchema,
});

// Unit-scoped route params (full hierarchy)
export const UnitParamsSchema = z.object({
  organizationId: UuidSchema,
  siteId: UuidSchema,
  areaId: UuidSchema,
  unitId: UuidSchema,
});

// --- Response Types ---

// Structured error response (used across all endpoints)
export const ErrorDetailSchema = z.object({
  path: z.array(z.union([z.string(), z.number()])),
  message: z.string(),
});

export const ErrorResponseSchema = z.object({
  error: z.object({
    code: z.string(),
    message: z.string(),
    details: z.array(ErrorDetailSchema).optional(),
  }),
});

// Type exports for TypeScript usage
export type ErrorResponse = z.infer<typeof ErrorResponseSchema>;
export type ErrorDetail = z.infer<typeof ErrorDetailSchema>;
```

Create `backend/src/schemas/index.ts` barrel export:

```typescript
// Schemas barrel export
export * from './common.js';
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Common Zod schemas are defined in backend/src/schemas/common.ts and exported via index.ts.</done>
</task>

<task type="auto">
  <name>Task 3: Create error response utilities</name>
  <files>backend/src/utils/errors.ts, backend/src/utils/index.ts</files>
  <action>
Create `backend/src/utils/errors.ts` with helper functions for consistent error responses:

```typescript
import type { FastifyReply } from 'fastify';
import type { ErrorResponse, ErrorDetail } from '../schemas/common.js';

// Error codes (used as error.code in responses)
export const ErrorCodes = {
  NOT_FOUND: 'NOT_FOUND',
  INVALID_INPUT: 'INVALID_INPUT',
  FORBIDDEN: 'FORBIDDEN',
  CONFLICT: 'CONFLICT',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
} as const;

/**
 * Send 404 Not Found response
 */
export function notFound(reply: FastifyReply, message: string): FastifyReply {
  return reply.code(404).send({
    error: {
      code: ErrorCodes.NOT_FOUND,
      message,
    },
  } satisfies ErrorResponse);
}

/**
 * Send 400 Validation Error response with field-level details
 */
export function validationError(
  reply: FastifyReply,
  message: string,
  details?: ErrorDetail[]
): FastifyReply {
  return reply.code(400).send({
    error: {
      code: ErrorCodes.INVALID_INPUT,
      message,
      details,
    },
  } satisfies ErrorResponse);
}

/**
 * Send 403 Forbidden response
 */
export function forbidden(reply: FastifyReply, message: string): FastifyReply {
  return reply.code(403).send({
    error: {
      code: ErrorCodes.FORBIDDEN,
      message,
    },
  } satisfies ErrorResponse);
}

/**
 * Send 409 Conflict response (e.g., duplicate record)
 */
export function conflict(reply: FastifyReply, message: string): FastifyReply {
  return reply.code(409).send({
    error: {
      code: ErrorCodes.CONFLICT,
      message,
    },
  } satisfies ErrorResponse);
}
```

Update `backend/src/utils/index.ts` to export error utilities (create if not exists, or add to existing):

```typescript
// Utils barrel export
export * from './jwt.js';
export * from './env-check.js';
export * from './errors.js';
```

If index.ts doesn't exist yet, create it. If it exists with other exports, add the errors.js export.
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Error response utilities (notFound, validationError, forbidden, conflict) are available via utils/errors.ts.</done>
</task>

<task type="auto">
  <name>Task 4: Configure Fastify with Zod type provider</name>
  <files>backend/src/app.ts</files>
  <action>
Update `backend/src/app.ts` to use Zod type provider:

1. Import ZodTypeProvider and related utilities:
```typescript
import {
  serializerCompiler,
  validatorCompiler,
  type ZodTypeProvider,
} from 'fastify-type-provider-zod';
```

2. After creating Fastify instance, add compiler configuration:
```typescript
// Configure Zod validation and serialization
app.setValidatorCompiler(validatorCompiler);
app.setSerializerCompiler(serializerCompiler);
```

3. Update buildApp to return typed instance:
```typescript
export function buildApp(opts: AppOptions = {}): FastifyInstance {
  const app = Fastify({
    logger: opts.logger ?? false,
  });

  // Configure Zod validation and serialization
  app.setValidatorCompiler(validatorCompiler);
  app.setSerializerCompiler(serializerCompiler);

  // Register auth plugin (decorates request.user)
  app.register(authPlugin);

  // ... existing routes
  return app;
}
```

The existing test routes can remain unchanged for now (they don't use Zod schemas yet).
Route files will use `fastify.withTypeProvider<ZodTypeProvider>()` to get typed methods.
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors. Run `pnpm test` to ensure existing tests still pass.</verify>
  <done>Fastify app is configured with Zod validator and serializer compilers.</done>
</task>

</tasks>

<verification>
1. `pnpm list zod fastify-type-provider-zod` shows both packages installed
2. `npx tsc --noEmit` passes with no errors
3. `pnpm test` passes (existing auth tests still work)
4. schemas/common.ts exports UuidSchema, ErrorResponseSchema, and param schemas
5. utils/errors.ts exports notFound, validationError, forbidden, conflict helpers
</verification>

<success_criteria>
- Zod dependencies installed and available
- Common validation schemas defined and exported
- Error response utilities provide consistent error format
- Fastify app configured with Zod type provider
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-api-endpoints/03-01-SUMMARY.md`
</output>
