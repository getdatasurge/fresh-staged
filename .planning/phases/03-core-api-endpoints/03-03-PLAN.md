---
phase: 03-core-api-endpoints
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/site.service.ts
  - backend/src/services/index.ts
  - backend/src/schemas/sites.ts
  - backend/src/schemas/index.ts
  - backend/src/routes/sites.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "User can list sites in their organization"
    - "Admin can create a new site"
    - "User can view a specific site"
    - "Admin can update site settings"
    - "Admin can delete (soft) a site"
    - "Sites from other orgs are not accessible"
  artifacts:
    - path: "backend/src/services/site.service.ts"
      provides: "Site CRUD database operations"
      exports: ["listSites", "getSite", "createSite", "updateSite", "deleteSite"]
    - path: "backend/src/routes/sites.ts"
      provides: "Site REST endpoints"
      exports: ["default (Fastify plugin)"]
    - path: "backend/src/schemas/sites.ts"
      provides: "Zod schemas for site endpoints"
      exports: ["SiteSchema", "CreateSiteSchema", "UpdateSiteSchema"]
  key_links:
    - from: "backend/src/routes/sites.ts"
      to: "backend/src/services/site.service.ts"
      via: "service function imports"
      pattern: "siteService\\."
    - from: "backend/src/app.ts"
      to: "backend/src/routes/sites.ts"
      via: "app.register"
      pattern: "register.*sites"
---

<objective>
Implement Site CRUD endpoints (list, get, create, update, delete).

Purpose: Allow organization admins to manage physical locations where equipment is monitored.
Output: Site service, Zod schemas, route handlers registered in app.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-api-endpoints/03-RESEARCH.md (service layer patterns, soft delete)
@.planning/phases/03-core-api-endpoints/03-CONTEXT.md (decisions)
@backend/src/db/schema/hierarchy.ts (sites table definition)
@backend/src/middleware/index.ts (auth, org-context, rbac)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create site service</name>
  <files>backend/src/services/site.service.ts, backend/src/services/index.ts</files>
  <action>
Create `backend/src/services/site.service.ts`:

```typescript
import { eq, and } from 'drizzle-orm';
import { db } from '../db/client.js';
import { sites, type Site, type InsertSite } from '../db/schema/hierarchy.js';

/**
 * List all active sites in an organization
 * Silent filtering - only returns sites user has access to
 */
export async function listSites(organizationId: string): Promise<Site[]> {
  return db
    .select()
    .from(sites)
    .where(and(
      eq(sites.organizationId, organizationId),
      eq(sites.isActive, true)
    ))
    .orderBy(sites.name);
}

/**
 * Get a specific site by ID within an organization
 */
export async function getSite(
  siteId: string,
  organizationId: string
): Promise<Site | null> {
  const [site] = await db
    .select()
    .from(sites)
    .where(and(
      eq(sites.id, siteId),
      eq(sites.organizationId, organizationId),
      eq(sites.isActive, true)
    ))
    .limit(1);

  return site ?? null;
}

/**
 * Create a new site in an organization
 */
export async function createSite(
  organizationId: string,
  data: Omit<InsertSite, 'id' | 'organizationId' | 'createdAt' | 'updatedAt' | 'isActive'>
): Promise<Site> {
  const [site] = await db
    .insert(sites)
    .values({
      ...data,
      organizationId,
    })
    .returning();

  return site;
}

/**
 * Update an existing site
 */
export async function updateSite(
  siteId: string,
  organizationId: string,
  data: Partial<Omit<InsertSite, 'id' | 'organizationId' | 'createdAt' | 'updatedAt'>>
): Promise<Site | null> {
  const [site] = await db
    .update(sites)
    .set({
      ...data,
      updatedAt: new Date(),
    })
    .where(and(
      eq(sites.id, siteId),
      eq(sites.organizationId, organizationId),
      eq(sites.isActive, true)
    ))
    .returning();

  return site ?? null;
}

/**
 * Soft delete a site (sets isActive = false)
 * Note: This cascades to areas, units via database constraints
 */
export async function deleteSite(
  siteId: string,
  organizationId: string
): Promise<Site | null> {
  const [site] = await db
    .update(sites)
    .set({
      isActive: false,
      updatedAt: new Date(),
    })
    .where(and(
      eq(sites.id, siteId),
      eq(sites.organizationId, organizationId),
      eq(sites.isActive, true)
    ))
    .returning();

  return site ?? null;
}
```

Update `backend/src/services/index.ts` to include site service:

```typescript
// Services barrel export
export * as userService from './user.service.js';
export * as orgService from './organization.service.js';
export * as siteService from './site.service.js';
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Site service provides listSites, getSite, createSite, updateSite, deleteSite functions.</done>
</task>

<task type="auto">
  <name>Task 2: Create site Zod schemas</name>
  <files>backend/src/schemas/sites.ts, backend/src/schemas/index.ts</files>
  <action>
Create `backend/src/schemas/sites.ts`:

```typescript
import { z } from 'zod';
import { UuidSchema, TimestampSchema, OrgParamsSchema } from './common.js';

// Site params (org + optional site)
export const SiteParamsSchema = OrgParamsSchema.extend({
  siteId: UuidSchema.optional(),
});

// Site params with required siteId
export const SiteRequiredParamsSchema = OrgParamsSchema.extend({
  siteId: UuidSchema,
});

// Full site response schema
export const SiteSchema = z.object({
  id: UuidSchema,
  organizationId: UuidSchema,
  name: z.string(),
  address: z.string().nullable(),
  city: z.string().nullable(),
  state: z.string().nullable(),
  postalCode: z.string().nullable(),
  country: z.string().nullable(),
  timezone: z.string(),
  latitude: z.string().nullable(),
  longitude: z.string().nullable(),
  isActive: z.boolean(),
  createdAt: TimestampSchema,
  updatedAt: TimestampSchema,
});

// Create site request body
export const CreateSiteSchema = z.object({
  name: z.string().min(1).max(256),
  address: z.string().max(500).nullable().optional(),
  city: z.string().max(128).nullable().optional(),
  state: z.string().max(64).nullable().optional(),
  postalCode: z.string().max(20).nullable().optional(),
  country: z.string().max(64).nullable().optional(),
  timezone: z.string().max(100).default('UTC'),
  latitude: z.string().max(32).nullable().optional(),
  longitude: z.string().max(32).nullable().optional(),
});

// Update site request body (all fields optional)
export const UpdateSiteSchema = CreateSiteSchema.partial();

// Sites list response
export const SitesListSchema = z.array(SiteSchema);

// Type exports
export type SiteResponse = z.infer<typeof SiteSchema>;
export type CreateSiteRequest = z.infer<typeof CreateSiteSchema>;
export type UpdateSiteRequest = z.infer<typeof UpdateSiteSchema>;
```

Update `backend/src/schemas/index.ts` to include sites:

```typescript
// Schemas barrel export
export * from './common.js';
export * from './organizations.js';
export * from './sites.js';
```
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors.</verify>
  <done>Site Zod schemas are defined for request/response validation.</done>
</task>

<task type="auto">
  <name>Task 3: Create site routes and register in app</name>
  <files>backend/src/routes/sites.ts, backend/src/app.ts</files>
  <action>
Create `backend/src/routes/sites.ts`:

```typescript
import type { FastifyInstance } from 'fastify';
import type { ZodTypeProvider } from 'fastify-type-provider-zod';
import { requireAuth, requireOrgContext, requireRole } from '../middleware/index.js';
import * as siteService from '../services/site.service.js';
import { notFound } from '../utils/errors.js';
import {
  SiteSchema,
  SitesListSchema,
  CreateSiteSchema,
  UpdateSiteSchema,
  SiteParamsSchema,
  SiteRequiredParamsSchema,
} from '../schemas/sites.js';
import { OrgParamsSchema, ErrorResponseSchema } from '../schemas/common.js';

export default async function siteRoutes(fastify: FastifyInstance) {
  const app = fastify.withTypeProvider<ZodTypeProvider>();

  // GET /api/orgs/:organizationId/sites - List sites
  app.get('/', {
    preHandler: [requireAuth, requireOrgContext],
    schema: {
      params: OrgParamsSchema,
      response: {
        200: SitesListSchema,
      },
    },
  }, async (request) => {
    const sites = await siteService.listSites(request.user!.organizationId!);
    return sites;
  });

  // POST /api/orgs/:organizationId/sites - Create site
  app.post('/', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: OrgParamsSchema,
      body: CreateSiteSchema,
      response: {
        201: SiteSchema,
      },
    },
  }, async (request, reply) => {
    const site = await siteService.createSite(
      request.user!.organizationId!,
      request.body
    );

    reply.code(201);
    return site;
  });

  // GET /api/orgs/:organizationId/sites/:siteId - Get site
  app.get('/:siteId', {
    preHandler: [requireAuth, requireOrgContext],
    schema: {
      params: SiteRequiredParamsSchema,
      response: {
        200: SiteSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const site = await siteService.getSite(
      request.params.siteId,
      request.user!.organizationId!
    );

    if (!site) {
      return notFound(reply, 'Site not found');
    }

    return site;
  });

  // PUT /api/orgs/:organizationId/sites/:siteId - Update site
  app.put('/:siteId', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: SiteRequiredParamsSchema,
      body: UpdateSiteSchema,
      response: {
        200: SiteSchema,
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const site = await siteService.updateSite(
      request.params.siteId,
      request.user!.organizationId!,
      request.body
    );

    if (!site) {
      return notFound(reply, 'Site not found');
    }

    return site;
  });

  // DELETE /api/orgs/:organizationId/sites/:siteId - Delete site (soft)
  app.delete('/:siteId', {
    preHandler: [requireAuth, requireOrgContext, requireRole('admin')],
    schema: {
      params: SiteRequiredParamsSchema,
      response: {
        204: { type: 'null' as const, description: 'No content' },
        404: ErrorResponseSchema,
      },
    },
  }, async (request, reply) => {
    const site = await siteService.deleteSite(
      request.params.siteId,
      request.user!.organizationId!
    );

    if (!site) {
      return notFound(reply, 'Site not found');
    }

    reply.code(204);
    return;
  });
}
```

Update `backend/src/app.ts` to register site routes:

1. Add import at top:
```typescript
import siteRoutes from './routes/sites.js';
```

2. Register sites routes with nested prefix (after org routes):
```typescript
// Register API routes
app.register(organizationRoutes, { prefix: '/api/orgs' });
app.register(siteRoutes, { prefix: '/api/orgs/:organizationId/sites' });
```

Note: Sites are nested under orgs to establish the hierarchy: /api/orgs/:orgId/sites
  </action>
  <verify>Run `cd backend && npx tsc --noEmit` to verify no TypeScript errors. Run `pnpm test` to verify existing tests still pass.</verify>
  <done>Site routes are registered at /api/orgs/:organizationId/sites with full CRUD.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `pnpm test` passes (existing auth tests still work)
3. Site service exports listSites, getSite, createSite, updateSite, deleteSite
4. Site routes registered at /api/orgs/:organizationId/sites prefix
5. List/Get routes use requireAuth + requireOrgContext
6. Create/Update/Delete routes add requireRole('admin')
</verification>

<success_criteria>
- GET /api/orgs/:orgId/sites lists organization's active sites
- POST /api/orgs/:orgId/sites creates site (admin+ only)
- GET /api/orgs/:orgId/sites/:siteId returns site details
- PUT /api/orgs/:orgId/sites/:siteId updates site (admin+ only)
- DELETE /api/orgs/:orgId/sites/:siteId soft-deletes site (admin+ only)
- Non-members get 403, non-existent sites get 404
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-api-endpoints/03-03-SUMMARY.md`
</output>
