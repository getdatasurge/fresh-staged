---
phase: 19-backend-api-migration-foundation
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - package.json
  - src/lib/trpc.ts
  - src/App.tsx
  - src/lib/api/organizations.ts
autonomous: true

must_haves:
  truths:
    - "TRPCProvider wraps application"
    - "useTRPC hook available in components"
    - "trpc.organizations.get returns typed data"
    - "Frontend can call tRPC procedures with auth"
    - "Type inference works from backend AppRouter"
  artifacts:
    - path: "src/lib/trpc.ts"
      provides: "tRPC client setup and hooks"
      exports: ["TRPCProvider", "useTRPC", "trpcClient"]
    - path: "src/lib/api/organizations.ts"
      provides: "Organization API (updated to use tRPC)"
      exports: ["organizationsApi"]
  key_links:
    - from: "src/App.tsx"
      to: "src/lib/trpc.ts"
      via: "TRPCProvider import"
      pattern: "TRPCProvider"
    - from: "src/lib/trpc.ts"
      to: "backend/src/trpc/router.ts"
      via: "AppRouter type import"
      pattern: "import type.*AppRouter"
---

<objective>
Set up tRPC client on frontend with TanStack React Query integration.

Purpose: Enable the frontend to call tRPC procedures with full type safety, replacing the Ky-based API client for the organizations domain.

Output: Working TRPCProvider in App.tsx, useTRPC hook available, organizations API migrated to tRPC calls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-backend-api-migration-foundation/19-CONTEXT.md
@.planning/phases/19-backend-api-migration-foundation/19-RESEARCH.md
@.planning/phases/19-backend-api-migration-foundation/19-01-SUMMARY.md
@src/App.tsx
@src/lib/api-client.ts
@src/lib/api/organizations.ts
@src/lib/stack/client.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tRPC client packages</name>
  <files>
    package.json
  </files>
  <action>
Install tRPC client and TanStack React Query integration in the frontend (root package.json):

```bash
npm install @trpc/client@^11.8.1 @trpc/tanstack-react-query@^11.8.1
```

Verify installation:
- @trpc/client should appear in dependencies
- @trpc/tanstack-react-query should appear in dependencies
- @tanstack/react-query is already installed (^5.83.0)
  </action>
  <verify>
    - package.json shows @trpc/client and @trpc/tanstack-react-query in dependencies
    - `npm install` completes successfully
  </verify>
  <done>
    tRPC client packages installed: @trpc/client, @trpc/tanstack-react-query
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tRPC client setup</name>
  <files>
    src/lib/trpc.ts
  </files>
  <action>
Create src/lib/trpc.ts with tRPC client configuration:

```typescript
/**
 * tRPC Client Setup
 *
 * Provides type-safe API client using tRPC with TanStack React Query integration.
 * Uses the new @trpc/tanstack-react-query package for native TanStack Query support.
 */

import { createTRPCContext, createTRPCClient, httpBatchLink } from '@trpc/tanstack-react-query';
import type { AppRouter } from '../../backend/src/trpc/router';

// API base URL from environment
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';

/**
 * Create tRPC context with provider and hooks.
 *
 * Usage:
 * - Wrap app with <TRPCProvider>
 * - Use useTRPC() in components to get typed query/mutation functions
 */
export const { TRPCProvider, useTRPC, useTRPCClient } = createTRPCContext<AppRouter>();

/**
 * Create a tRPC client instance with authentication.
 *
 * @param getAccessToken - Async function that returns the current access token
 * @returns Configured tRPC client
 *
 * @example
 * ```typescript
 * const user = useUser();
 * const trpcClient = useMemo(() =>
 *   createTRPCClientInstance(async () => {
 *     const authJson = await user?.getAuthJson();
 *     return authJson?.accessToken ?? '';
 *   }),
 *   [user]
 * );
 * ```
 */
export function createTRPCClientInstance(getAccessToken: () => Promise<string>) {
  return createTRPCClient<AppRouter>({
    links: [
      httpBatchLink({
        url: `${API_URL}/trpc`,
        /**
         * Custom headers for authentication.
         * Uses x-stack-access-token header consistent with existing API client.
         */
        async headers() {
          try {
            const token = await getAccessToken();
            if (token) {
              return { 'x-stack-access-token': token };
            }
          } catch (error) {
            console.error('[tRPC] Failed to get access token:', error);
          }
          return {};
        },
      }),
    ],
  });
}

/**
 * Type export for use in components that need to type query results.
 *
 * @example
 * ```typescript
 * import type { RouterOutput } from '@/lib/trpc';
 * type Organization = RouterOutput['organizations']['get'];
 * ```
 */
export type RouterInput = Parameters<ReturnType<typeof useTRPC>['organizations']['get']['useQuery']>[0];
export type RouterOutput = {
  organizations: {
    get: Awaited<ReturnType<ReturnType<typeof useTRPCClient>['organizations']['get']['query']>>;
    update: Awaited<ReturnType<ReturnType<typeof useTRPCClient>['organizations']['update']['mutate']>>;
    listMembers: Awaited<ReturnType<ReturnType<typeof useTRPCClient>['organizations']['listMembers']['query']>>;
    stats: Awaited<ReturnType<ReturnType<typeof useTRPCClient>['organizations']['stats']['query']>>;
  };
};
```

Notes:
- Uses path import from backend for AppRouter type (monorepo structure)
- httpBatchLink batches multiple procedure calls into single requests
- x-stack-access-token header matches existing API client pattern
- Type exports enable typed usage in components without full inference chain
  </action>
  <verify>
    - File exists: src/lib/trpc.ts
    - `npm run typecheck` passes (TypeScript can resolve AppRouter import)
  </verify>
  <done>
    tRPC client setup created with TRPCProvider, useTRPC hook, and createTRPCClientInstance factory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate TRPCProvider in App.tsx</name>
  <files>
    src/App.tsx
  </files>
  <action>
Update src/App.tsx to add TRPCProvider:

1. Add imports at top of file:
```typescript
import { useMemo } from "react";
import { useUser } from "@stackframe/react";
import { TRPCProvider, createTRPCClientInstance } from "@/lib/trpc";
```

2. Create TRPCWrapper component that handles auth integration:
```typescript
/**
 * tRPC Provider Wrapper
 *
 * Must be inside StackProvider (for useUser) and QueryClientProvider (for query client).
 * Creates tRPC client with auth token from Stack Auth.
 */
function TRPCWrapper({ children }: { children: React.ReactNode }) {
  const user = useUser();

  const trpcClient = useMemo(() => {
    return createTRPCClientInstance(async () => {
      if (!user) return '';
      try {
        const authJson = await user.getAuthJson();
        return authJson?.accessToken ?? '';
      } catch {
        return '';
      }
    });
  }, [user]);

  return (
    <TRPCProvider trpcClient={trpcClient} queryClient={queryClient}>
      {children}
    </TRPCProvider>
  );
}
```

3. Update the App component structure to wrap with TRPCWrapper:
   - TRPCWrapper must be INSIDE StackProvider (needs useUser)
   - TRPCWrapper must be INSIDE QueryClientProvider (needs queryClient)
   - Move queryClient to module scope (already there) so TRPCWrapper can access it

Final structure should be:
```
<StackProvider>
  <StackTheme>
    <QueryClientProvider>
      <TRPCWrapper>
        <RealtimeProvider>
          ... rest of app
        </RealtimeProvider>
      </TRPCWrapper>
    </QueryClientProvider>
  </StackTheme>
</StackProvider>
```
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run build` succeeds
    - App loads in browser without errors (npm run dev, visit localhost:8080)
  </verify>
  <done>
    TRPCProvider integrated in App.tsx. tRPC context available throughout application.
  </done>
</task>

</tasks>

<verification>
1. Packages installed: grep "@trpc/client" package.json
2. Client setup exists: src/lib/trpc.ts with TRPCProvider export
3. Provider integrated: grep "TRPCProvider" src/App.tsx
4. TypeScript compiles: npm run typecheck
5. Build succeeds: npm run build
6. Runtime verification:
   - npm run dev
   - Open browser console
   - No tRPC-related errors on load
   - (Organizations API migration tested in Plan 04)
</verification>

<success_criteria>
- @trpc/client and @trpc/tanstack-react-query installed
- src/lib/trpc.ts exports TRPCProvider, useTRPC, createTRPCClientInstance
- TRPCProvider wraps application inside StackProvider and QueryClientProvider
- TypeScript resolves AppRouter type from backend
- Application builds and loads without errors
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/19-backend-api-migration-foundation/19-03-SUMMARY.md`
</output>
