---
phase: 19-backend-api-migration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/trpc/index.ts
  - backend/src/trpc/context.ts
  - backend/src/trpc/procedures.ts
  - backend/src/trpc/router.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - 'tRPC endpoint responds at /trpc path'
    - 'Context correctly extracts JWT from headers'
    - 'protectedProcedure rejects unauthenticated requests'
    - 'orgProcedure enforces organization membership'
  artifacts:
    - path: 'backend/src/trpc/index.ts'
      provides: 'tRPC instance and router factory'
      exports: ['t', 'router', 'publicProcedure', 'createCallerFactory']
    - path: 'backend/src/trpc/context.ts'
      provides: 'Request context creation'
      exports: ['createContext', 'Context']
    - path: 'backend/src/trpc/procedures.ts'
      provides: 'Protected procedures with auth middleware'
      exports: ['protectedProcedure', 'orgProcedure']
    - path: 'backend/src/trpc/router.ts'
      provides: 'Root app router'
      exports: ['appRouter', 'AppRouter']
  key_links:
    - from: 'backend/src/app.ts'
      to: 'backend/src/trpc/router.ts'
      via: 'fastifyTRPCPlugin registration'
      pattern: 'fastifyTRPCPlugin'
    - from: 'backend/src/trpc/context.ts'
      to: 'backend/src/utils/jwt.ts'
      via: 'verifyAccessToken import'
      pattern: 'verifyAccessToken'
---

<objective>
Set up tRPC infrastructure on Fastify backend with authentication middleware.

Purpose: Establish the foundational tRPC setup that all domain routers will use. This is the base layer for the entire API migration.

Output: Working tRPC endpoint at /trpc with protected procedure middleware that reuses existing auth logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-backend-api-migration-foundation/19-CONTEXT.md
@.planning/phases/19-backend-api-migration-foundation/19-RESEARCH.md
@backend/src/app.ts
@backend/src/middleware/auth.ts
@backend/src/middleware/org-context.ts
@backend/src/utils/jwt.ts
@backend/src/types/auth.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tRPC server package and create infrastructure files</name>
  <files>
    backend/package.json
    backend/src/trpc/index.ts
    backend/src/trpc/context.ts
    backend/src/trpc/procedures.ts
    backend/src/trpc/router.ts
  </files>
  <action>
1. Install @trpc/server@^11.8.1 in backend:
   ```bash
   cd backend && npm install @trpc/server@^11.8.1
   ```

2. Create backend/src/trpc/index.ts:
   - Import initTRPC from @trpc/server
   - Import Context type from ./context.js
   - Create t instance with t = initTRPC.context<Context>().create()
   - Export router = t.router
   - Export publicProcedure = t.procedure
   - Export createCallerFactory = t.createCallerFactory
   - Export middleware = t.middleware (for procedures.ts)

3. Create backend/src/trpc/context.ts:
   - Import CreateFastifyContextOptions from @trpc/server/adapters/fastify
   - Import verifyAccessToken from ../utils/jwt.js
   - Import AuthUser type from ../types/auth.js
   - Create async function createContext({ req, res })
   - Extract token from x-stack-access-token header OR Authorization Bearer header (same logic as requireAuth middleware)
   - If token exists, verify with verifyAccessToken and build user object with id, email, name
   - Return { req, res, user } where user is AuthUser | null
   - Export type Context = Awaited<ReturnType<typeof createContext>>

4. Create backend/src/trpc/procedures.ts:
   - Import TRPCError from @trpc/server
   - Import middleware, publicProcedure from ./index.js
   - Import userService from ../services/index.js

   Create protectedProcedure:
   - Use middleware to check ctx.user exists
   - Throw TRPCError with code 'UNAUTHORIZED' if not
   - Return opts.next with narrowed user type

   Create orgProcedure:
   - Extend protectedProcedure
   - Extract organizationId from input (procedure will define schema with organizationId)
   - Look up user role via userService.getUserRoleInOrg
   - Throw TRPCError FORBIDDEN if no membership
   - Get profile via userService.getOrCreateProfile
   - Return ctx with organizationId, role, profileId attached

5. Create backend/src/trpc/router.ts:
   - Import router from ./index.js
   - Create appRouter = router({}) (empty for now, Plan 02 adds organizations)
   - Export appRouter
   - Export type AppRouter = typeof appRouter
     </action>
     <verify>
   - Files exist: backend/src/trpc/index.ts, context.ts, procedures.ts, router.ts
   - `cd backend && npm run build` compiles without errors
   - package.json shows @trpc/server in dependencies
     </verify>
     <done>
     tRPC infrastructure files created with t instance, context, protected procedures, and empty app router. TypeScript compiles successfully.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Register tRPC plugin with Fastify</name>
  <files>
    backend/src/app.ts
  </files>
  <action>
1. Add imports to backend/src/app.ts:
   ```typescript
   import { fastifyTRPCPlugin, FastifyTRPCPluginOptions } from '@trpc/server/adapters/fastify';
   import { createContext } from './trpc/context.js';
   import { appRouter, type AppRouter } from './trpc/router.js';
   ```

2. Register tRPC plugin after queue plugin but before routes:

   ```typescript
   // Register tRPC router
   app.register(fastifyTRPCPlugin, {
     prefix: '/trpc',
     trpcOptions: {
       router: appRouter,
       createContext,
       onError({ path, error }) {
         app.log.error({ path, error: error.message }, 'tRPC error');
       },
     } satisfies FastifyTRPCPluginOptions<AppRouter>['trpcOptions'],
   });
   ```

3. Add maxParamLength to Fastify config to support batched requests:
   - In the Fastify constructor options, add: `maxParamLength: 5000`
   - This prevents "Parameter too long" errors on batch requests

4. Ensure CORS allowedHeaders includes any headers tRPC might need (already has x-stack-access-token which is sufficient).
   </action>
   <verify> - `cd backend && npm run build` compiles without errors - `cd backend && npm run dev` starts server without errors - `curl http://localhost:3000/trpc` returns tRPC response (even if empty/error, confirms route registered)
   </verify>
   <done>
   tRPC plugin registered at /trpc prefix. Server starts and responds to tRPC requests.
   </done>
   </task>

<task type="auto">
  <name>Task 3: Add health check procedure and verify end-to-end</name>
  <files>
    backend/src/trpc/router.ts
    backend/tests/trpc/context.test.ts
  </files>
  <action>
1. Add a health check procedure to router.ts for verification:
   ```typescript
   import { router, publicProcedure } from './index.js';
   import { z } from 'zod';

export const appRouter = router({
health: publicProcedure
.output(z.object({ status: z.string(), timestamp: z.string() }))
.query(() => ({
status: 'ok',
timestamp: new Date().toISOString(),
})),
});

````

2. Create backend/tests/trpc/context.test.ts to verify context creation:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createContext } from '../../src/trpc/context.js';
import type { FastifyRequest, FastifyReply } from 'fastify';

// Mock verifyAccessToken
vi.mock('../../src/utils/jwt.js', () => ({
  verifyAccessToken: vi.fn(),
}));

describe('tRPC Context', () => {
  it('should return null user when no token provided', async () => {
    const req = {
      headers: {},
    } as FastifyRequest;
    const res = {} as FastifyReply;

    const ctx = await createContext({ req, res });

    expect(ctx.user).toBeNull();
    expect(ctx.req).toBe(req);
    expect(ctx.res).toBe(res);
  });

  it('should extract token from x-stack-access-token header', async () => {
    const { verifyAccessToken } = await import('../../src/utils/jwt.js');
    (verifyAccessToken as any).mockResolvedValue({
      payload: { email: 'test@example.com', name: 'Test User' },
      userId: 'user-123',
    });

    const req = {
      headers: { 'x-stack-access-token': 'valid-token' },
    } as FastifyRequest;
    const res = {} as FastifyReply;

    const ctx = await createContext({ req, res });

    expect(ctx.user).toEqual({
      id: 'user-123',
      email: 'test@example.com',
      name: 'Test User',
    });
  });

  it('should extract token from Authorization Bearer header', async () => {
    const { verifyAccessToken } = await import('../../src/utils/jwt.js');
    (verifyAccessToken as any).mockResolvedValue({
      payload: { email: 'bearer@example.com', name: 'Bearer User' },
      userId: 'user-456',
    });

    const req = {
      headers: { authorization: 'Bearer valid-token' },
    } as FastifyRequest;
    const res = {} as FastifyReply;

    const ctx = await createContext({ req, res });

    expect(ctx.user).toEqual({
      id: 'user-456',
      email: 'bearer@example.com',
      name: 'Bearer User',
    });
  });
});
````

3. Run verification:
   - Start backend: `cd backend && npm run dev`
   - Test health endpoint: `curl http://localhost:3000/trpc/health`
   - Should return: `{"result":{"data":{"status":"ok","timestamp":"..."}}}` (or similar tRPC response format)
     </action>
     <verify>
   - `cd backend && npm test` passes (including new context tests)
   - `curl http://localhost:3000/trpc/health` returns JSON with status: ok
   - Backend logs show tRPC route handling requests
     </verify>
     <done>
     Health check procedure working. Context tests passing. tRPC infrastructure verified end-to-end.
     </done>
     </task>

</tasks>

<verification>
1. tRPC packages installed: @trpc/server in backend/package.json
2. Infrastructure files exist: backend/src/trpc/*.ts
3. Plugin registered: grep "fastifyTRPCPlugin" backend/src/app.ts
4. Health endpoint works: curl http://localhost:3000/trpc/health returns 200
5. Tests pass: cd backend && npm test
6. TypeScript compiles: cd backend && npm run build
</verification>

<success_criteria>

- @trpc/server@^11.8.1 installed in backend
- backend/src/trpc/ directory with index.ts, context.ts, procedures.ts, router.ts
- fastifyTRPCPlugin registered at /trpc prefix
- Health check procedure responds at /trpc/health
- Context correctly extracts JWT from headers (tested)
- protectedProcedure and orgProcedure middleware defined
- Backend builds and tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/19-backend-api-migration-foundation/19-01-SUMMARY.md`
</output>
