---
phase: 01-local-development-environment
plan: 05
type: execute
wave: 3
depends_on: ['01-01', '01-03', '01-04']
files_modified:
  - backend/src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - 'schema/index.ts re-exports all 8 schema modules'
    - 'TypeScript compiles without errors'
    - 'pnpm db:generate creates migration files in drizzle/'
    - 'pnpm db:migrate applies schema to database successfully'
    - 'All 22 tables exist in PostgreSQL'
  artifacts:
    - path: 'backend/src/db/schema/index.ts'
      provides: 'Central export of all schema modules'
      contains: 'export * from'
      min_lines: 10
    - path: 'backend/drizzle/0000_*.sql'
      provides: 'Initial migration file'
      contains: 'CREATE TABLE'
  key_links:
    - from: 'backend/src/db/schema/index.ts'
      to: 'all schema files'
      via: 're-export statements'
      pattern: "export \\* from"
    - from: 'backend/drizzle.config.ts'
      to: 'schema/index.ts'
      via: 'schema path configuration'
      pattern: 'schema.*index'
---

<objective>
Update schema index to export all modules, then generate and apply migrations.

Purpose: This is the final integration step that proves all schema files work together and can be applied to a real database. It validates the entire Phase 1 deliverable.

Output: Working schema index, generated migrations, and verified database with all tables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-local-development-environment/01-RESEARCH.md
@.planning/phases/01-local-development-environment/01-01-SUMMARY.md (if exists)

Schema modules to export:

1. enums.ts - All PostgreSQL enum types
2. tenancy.ts - organizations, subscriptions
3. users.ts - profiles, userRoles, escalationContacts
4. hierarchy.ts - sites, areas, units, hubs
5. devices.ts - devices, loraSensors, calibrationRecords, pairingSessions
6. telemetry.ts - sensorReadings, manualTemperatureLogs, doorEvents
7. alerts.ts - alertRules, alertRulesHistory, alerts, correctiveActions
8. notifications.ts - notificationDeliveries
9. audit.ts - eventLogs

Exit criteria from roadmap:

- docker compose up starts all services
- Health checks pass within 60 seconds
- pnpm db:migrate applies schema successfully
- Manual verification: connect to DB, see tables
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema index to export all modules</name>
  <files>backend/src/db/schema/index.ts</files>
  <action>
Update the schema index file to re-export all schema modules:

**backend/src/db/schema/index.ts:**

```typescript
// Schema index - exports all tables and types
// This file is referenced by drizzle.config.ts for migration generation

// Enums (must be first - other schemas depend on these)
export * from './enums.js';

// Foundation schemas (no dependencies on other tables)
export * from './tenancy.js';

// User management (depends on tenancy)
export * from './users.js';

// Physical hierarchy (depends on tenancy)
export * from './hierarchy.js';

// Device management (depends on hierarchy)
export * from './devices.js';

// Telemetry data (depends on hierarchy, devices, users)
export * from './telemetry.js';

// Alerting system (depends on tenancy, hierarchy, users)
export * from './alerts.js';

// Notifications (depends on alerts, users)
export * from './notifications.js';

// Audit logging (depends on tenancy, users)
export * from './audit.js';
```

  </action>
  <verify>
```bash
cd backend && grep -c "export \* from" src/db/schema/index.ts
```
Output should be 9 (one export per schema module).
  </verify>
  <done>schema/index.ts re-exports all 9 schema modules</done>
</task>

<task type="auto">
  <name>Task 2: Verify TypeScript compilation</name>
  <files>backend/</files>
  <action>
Verify that all schema files compile without TypeScript errors:

```bash
cd backend && pnpm exec tsc --noEmit
```

If there are errors:

1. Check import paths use .js extension (ESM requirement)
2. Verify all referenced tables/enums are exported from their files
3. Check for circular dependencies

Common fixes:

- Import paths must end in `.js` (e.g., `from './enums.js'`)
- Ensure all `references()` targets are exported
  </action>
  <verify>

```bash
cd backend && pnpm exec tsc --noEmit && echo "TypeScript compilation successful"
```

Output should end with "TypeScript compilation successful".
</verify>
<done>All TypeScript files compile without errors</done>
</task>

<task type="auto">
  <name>Task 3: Generate and apply migrations</name>
  <files>backend/drizzle/</files>
  <action>
IMPORTANT: Docker Compose must be running before this step.

1. Ensure Docker Compose services are running:

```bash
cd /home/skynet/freshtrack-pro-local/freshtrack-pro && docker compose ps
```

If not running:

```bash
cd /home/skynet/freshtrack-pro-local/freshtrack-pro && ./scripts/dev/up.sh
```

Wait for health checks to pass (up to 60 seconds).

2. Generate migrations from schema:

```bash
cd backend && pnpm db:generate
```

This should create:

- `drizzle/0000_*.sql` - Initial migration file
- `drizzle/meta/` - Migration metadata

3. Apply migrations to database:

```bash
cd backend && pnpm db:migrate
```

Expected output: "Migrations completed successfully!"

4. Verify tables exist:

```bash
docker exec frostguard-postgres psql -U frostguard -d frostguard -c "\dt"
```

Expected: 22 tables listed (all from schemas plus drizzle tracking table)
</action>
<verify>

```bash
cd backend && test -f drizzle/0000_*.sql && echo "Migration file exists"
docker exec frostguard-postgres psql -U frostguard -d frostguard -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';"
```

Migration file exists and table count should be 22+.
</verify>
<done>Migrations generated and applied, all 22 tables exist in database</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema index completeness:**

```bash
grep -c "export \* from" backend/src/db/schema/index.ts
```

Expected: 9

2. **TypeScript compilation:**

```bash
cd backend && pnpm exec tsc --noEmit && echo "OK"
```

Expected: "OK"

3. **Migration files exist:**

```bash
ls backend/drizzle/*.sql 2>/dev/null | head -1
```

Expected: At least one .sql file

4. **Database tables count:**

```bash
docker exec frostguard-postgres psql -U frostguard -d frostguard -c "SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';"
```

Expected: 22 or 23 (including drizzle migrations table)

5. **Specific tables exist:**

```bash
docker exec frostguard-postgres psql -U frostguard -d frostguard -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;"
```

Expected: All tables from schema files listed
</verification>

<success_criteria>

- schema/index.ts exports all 9 schema modules
- TypeScript compiles without errors
- drizzle/0000\_\*.sql migration file generated
- pnpm db:migrate completes successfully
- All 22 tables exist in PostgreSQL database
- Docker Compose services remain healthy after migration
  </success_criteria>

<output>
After completion, create `.planning/phases/01-local-development-environment/01-05-SUMMARY.md`

Phase 1 Exit Criteria Verification:

- [ ] `docker compose up` starts all services - verify with `docker compose ps`
- [ ] Health checks pass within 60 seconds - verify with health status
- [ ] `pnpm db:migrate` applies schema successfully - verify with migrate output
- [ ] Manual verification: connect to DB, see tables - verify with psql \dt
      </output>
