---
phase: 01-local-development-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/drizzle.config.ts
  - backend/.env.example
  - backend/.gitignore
  - backend/src/db/client.ts
  - backend/src/db/migrate.ts
autonomous: true

must_haves:
  truths:
    - 'pnpm install completes without errors in backend/'
    - 'TypeScript compiles without errors'
    - 'drizzle.config.ts loads DATABASE_URL from .env'
  artifacts:
    - path: 'backend/package.json'
      provides: 'Project configuration with db:generate and db:migrate scripts'
      contains: 'drizzle-orm'
    - path: 'backend/tsconfig.json'
      provides: 'TypeScript configuration with strict mode'
      contains: 'strict'
    - path: 'backend/drizzle.config.ts'
      provides: 'Drizzle Kit configuration'
      contains: 'defineConfig'
    - path: 'backend/.env.example'
      provides: 'Environment template with DATABASE_URL'
      contains: 'DATABASE_URL'
    - path: 'backend/src/db/client.ts'
      provides: 'Database connection singleton'
      contains: 'drizzle'
    - path: 'backend/src/db/migrate.ts'
      provides: 'Migration runner script'
      contains: 'migrate'
  key_links:
    - from: 'backend/drizzle.config.ts'
      to: '.env'
      via: 'dotenv config() call'
      pattern: "config.*path.*\\.env"
    - from: 'backend/src/db/client.ts'
      to: 'process.env.DATABASE_URL'
      via: 'Pool connectionString'
      pattern: "process\\.env\\.DATABASE_URL"
---

<objective>
Set up the backend TypeScript project with Drizzle ORM configuration.

Purpose: Establish the foundation for all database schema work. Without this, no schema files can be created or migrations run.

Output: A working backend/ directory with pnpm, TypeScript, Drizzle ORM, and migration infrastructure ready for schema definitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-local-development-environment/01-RESEARCH.md

Key research findings to follow:

- Use pnpm as package manager
- Use pg (node-postgres) driver with Pool
- Connection string uses PgBouncer port 6432, not direct PostgreSQL 5432
- Use ESM modules ("type": "module" in package.json)
- drizzle.config.ts must call dotenv config() to load .env
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend project structure</name>
  <files>
    backend/package.json
    backend/tsconfig.json
    backend/.gitignore
    backend/.env.example
  </files>
  <action>
Create the backend/ directory at the project root with:

1. **backend/package.json:**

```json
{
  "name": "freshtrack-backend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "db:generate": "drizzle-kit generate",
    "db:migrate": "tsx src/db/migrate.ts",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio",
    "db:check": "drizzle-kit check"
  },
  "dependencies": {
    "drizzle-orm": "^0.38.0",
    "pg": "^8.13.0",
    "dotenv": "^16.4.7"
  },
  "devDependencies": {
    "drizzle-kit": "^0.30.0",
    "@types/pg": "^8.11.10",
    "@types/node": "^22.10.0",
    "tsx": "^4.19.0",
    "typescript": "^5.7.0"
  }
}
```

2. **backend/tsconfig.json:**

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*", "drizzle.config.ts"],
  "exclude": ["node_modules", "dist"]
}
```

3. **backend/.gitignore:**

```
node_modules/
dist/
.env
*.log
drizzle/meta/_journal.json.bak
```

4. **backend/.env.example:**

```
# Database connection (use PgBouncer port 6432 for transaction pooling)
DATABASE_URL=postgresql://frostguard:frostguard_dev_password@localhost:6432/frostguard

# Direct PostgreSQL connection (use for operations requiring session state)
DATABASE_URL_DIRECT=postgresql://frostguard:frostguard_dev_password@localhost:5432/frostguard
```

  </action>
  <verify>
```bash
cd backend && ls -la package.json tsconfig.json .gitignore .env.example
```
All four files exist.
  </verify>
  <done>backend/ directory has package.json, tsconfig.json, .gitignore, and .env.example</done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle configuration and database client</name>
  <files>
    backend/drizzle.config.ts
    backend/src/db/client.ts
    backend/src/db/migrate.ts
  </files>
  <action>
Create the Drizzle ORM configuration and database connection files:

1. **backend/drizzle.config.ts:**

```typescript
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

if (!process.env.DATABASE_URL) {
  throw new Error('DATABASE_URL is not set in .env file');
}

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema/index.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});
```

2. **backend/src/db/client.ts:**

```typescript
import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import * as schema from './schema/index.js';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
});

export const db = drizzle({ client: pool, schema });

export async function closeDatabase(): Promise<void> {
  await pool.end();
}

// Graceful shutdown handler
process.on('SIGTERM', async () => {
  console.log('SIGTERM received, closing database connections...');
  await closeDatabase();
  process.exit(0);
});
```

3. **backend/src/db/migrate.ts:**

```typescript
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/node-postgres';
import { migrate } from 'drizzle-orm/node-postgres/migrator';
import { Pool } from 'pg';

async function runMigrations(): Promise<void> {
  const connectionString = process.env.DATABASE_URL;

  if (!connectionString) {
    console.error('DATABASE_URL is not set');
    process.exit(1);
  }

  console.log('Connecting to database...');
  const pool = new Pool({ connectionString });

  try {
    const db = drizzle({ client: pool });

    console.log('Running migrations...');
    await migrate(db, { migrationsFolder: './drizzle' });

    console.log('Migrations completed successfully!');
  } catch (error) {
    console.error('Migration failed:', error);
    process.exit(1);
  } finally {
    await pool.end();
  }
}

runMigrations();
```

Also create a placeholder for the schema index (will be populated in Plan 02):

4. **backend/src/db/schema/index.ts:**

```typescript
// Schema exports - populated by subsequent plans
// This file will re-export all schema modules

export {};
```

  </action>
  <verify>
```bash
cd backend && ls -la drizzle.config.ts src/db/client.ts src/db/migrate.ts src/db/schema/index.ts
```
All four files exist.
  </verify>
  <done>Drizzle config, database client, migration runner, and schema index placeholder created</done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and verify setup</name>
  <files>
    backend/package.json
    backend/.env
  </files>
  <action>
Install dependencies and create local .env file:

1. Copy .env.example to .env:

```bash
cd backend && cp .env.example .env
```

2. Install dependencies with pnpm:

```bash
cd backend && pnpm install
```

3. Verify TypeScript compiles (will have import error for schema, that's expected):

```bash
cd backend && pnpm exec tsc --noEmit 2>&1 || true
```

Note: TypeScript will show an error about schema/index.ts being empty. This is expected and will be fixed in Plan 02.

4. Verify drizzle-kit is accessible:

```bash
cd backend && pnpm exec drizzle-kit --version
```

  </action>
  <verify>
```bash
cd backend && test -d node_modules/drizzle-orm && test -d node_modules/pg && echo "Dependencies installed"
```
Output shows "Dependencies installed".
  </verify>
  <done>pnpm install completes, node_modules contains drizzle-orm and pg</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File structure check:**

```bash
find backend -type f -name "*.ts" -o -name "*.json" -o -name ".env*" | sort
```

Expected: package.json, tsconfig.json, drizzle.config.ts, .env, .env.example, src/db/client.ts, src/db/migrate.ts, src/db/schema/index.ts

2. **Dependencies check:**

```bash
cd backend && pnpm list drizzle-orm pg dotenv
```

Expected: All three packages listed with versions

3. **Script verification:**

```bash
cd backend && grep -E "db:(generate|migrate)" package.json
```

Expected: Both db:generate and db:migrate scripts present
</verification>

<success_criteria>

- backend/ directory exists with all configuration files
- pnpm install succeeds without errors
- drizzle-kit --version runs successfully
- .env file exists with DATABASE_URL pointing to PgBouncer port 6432
- TypeScript configuration uses strict mode and ESM modules
  </success_criteria>

<output>
After completion, create `.planning/phases/01-local-development-environment/01-01-SUMMARY.md`
</output>
