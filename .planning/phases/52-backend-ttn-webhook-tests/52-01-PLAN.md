---
phase: 52-backend-ttn-webhook-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/api/ttn-webhooks.test.ts
  - backend/tests/routes/ttn-webhook.test.ts
autonomous: true

must_haves:
  truths:
    - 'Zero it.skip() markers remain in any TTN webhook test file'
    - 'All TTN webhook tests pass (32 tests covering ingestion, alerts, metadata, edge cases)'
    - 'No duplicate test files exist for the same route'
    - 'Test directory structure follows the tests/api/ convention'
  artifacts:
    - path: 'backend/tests/api/ttn-webhooks.test.ts'
      provides: 'Complete TTN webhook test suite with socket plugin mock'
      contains: "Symbol.for('skip-override')"
  key_links:
    - from: 'backend/tests/api/ttn-webhooks.test.ts'
      to: 'backend/src/routes/ttn-webhooks.ts'
      via: 'buildApp + app.inject POST /api/v1/ttn/webhook'
      pattern: 'inject.*ttn.*webhook'
    - from: 'backend/tests/api/ttn-webhooks.test.ts'
      to: 'backend/src/plugins/socket.plugin.ts'
      via: "vi.mock with Symbol.for('skip-override')"
      pattern: 'skip-override'
---

<objective>
Consolidate TTN webhook tests by replacing the broken api/ test file (14 skipped tests) with the working routes/ test file (32 passing tests), then remove the empty routes/ directory.

Purpose: Research (52-RESEARCH.md) proved that all 14 skipped tests in `tests/api/ttn-webhooks.test.ts` are exact duplicates of passing tests in `tests/routes/ttn-webhook.test.ts`. The routes file is a strict superset with 32 tests (including 12 additional scenarios). The fix is consolidation, not implementation.

Output: Single TTN webhook test file at `tests/api/ttn-webhooks.test.ts` with 32 passing tests and zero skips.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-backend-ttn-webhook-tests/52-RESEARCH.md
@backend/tests/api/ttn-webhooks.test.ts
@backend/tests/routes/ttn-webhook.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate TTN webhook test files</name>
  <files>backend/tests/api/ttn-webhooks.test.ts, backend/tests/routes/ttn-webhook.test.ts</files>
  <action>
Replace the broken `backend/tests/api/ttn-webhooks.test.ts` with the working `backend/tests/routes/ttn-webhook.test.ts`.

Steps:

1. Read `backend/tests/routes/ttn-webhook.test.ts` to capture the full working content (943 lines, 32 passing tests)
2. Read `backend/tests/api/ttn-webhooks.test.ts` to confirm it has the 14 it.skip markers
3. Overwrite `backend/tests/api/ttn-webhooks.test.ts` with the content from the routes file
4. Check if any import paths in the file are relative and need adjusting:
   - The routes file uses `../../src/` relative imports -- since both `tests/api/` and `tests/routes/` are at the same depth under `tests/`, these paths should remain identical. Verify by checking the first few import lines reference `../../src/` paths.
5. Delete `backend/tests/routes/ttn-webhook.test.ts`
6. Check if `backend/tests/routes/` directory is now empty. If so, delete it with `rmdir`.
7. Verify NO `it.skip` or `test.skip` markers exist in the new `backend/tests/api/ttn-webhooks.test.ts` by running `grep -c 'it\.skip\|test\.skip' backend/tests/api/ttn-webhooks.test.ts` (expect 0)

IMPORTANT: Do NOT modify any test logic. This is a file move operation. The content of the routes file is already proven to work (32/32 passing).
</action>
<verify>
Run from `backend/` directory:

- `grep -c 'it\.skip\|test\.skip' tests/api/ttn-webhooks.test.ts` returns 0
- `ls tests/routes/ 2>/dev/null` returns "No such file or directory"
- `npx vitest run tests/api/ttn-webhooks.test.ts` shows 32 passed, 0 skipped, 0 failed
  </verify>
  <done>
- `backend/tests/api/ttn-webhooks.test.ts` contains the consolidated 32-test suite with socket plugin mock
- `backend/tests/routes/` directory no longer exists
- Zero `it.skip` markers in the file
- All 32 tests pass
  </done>
  </task>

<task type="auto">
  <name>Task 2: Verify backend test suite integrity</name>
  <files>backend/tests/api/ttn-webhooks.test.ts</files>
  <action>
Run the full backend test suite to confirm consolidation did not break anything.

Steps:

1. Run `cd backend && pnpm test` to execute the full backend test suite
2. Compare results against the baseline from research:
   - Before consolidation: 1252 passed, 38 skipped, 10 failed
   - Expected after: ~1246 passed (removed 6 duplicate passing tests from old api file), 24 skipped (removed 14 skipped tests), same 10 failed (unrelated to this phase)
3. Confirm the TTN webhook file specifically shows 32 passed in the output
4. Confirm no NEW failures were introduced (any failures should match the pre-existing 10 from baseline)

If any NEW test failures appear in the TTN webhook file:

- Check if import paths need adjustment (the `../../src/` pattern should be correct since both directories are at the same depth)
- Check if the file references any test helpers from `tests/routes/` that no longer exist
- Check vitest config for any path aliases specific to `tests/routes/`
  </action>
  <verify>
- `cd backend && pnpm test 2>&1 | tail -5` shows test results with 0 new failures compared to baseline
- `cd backend && npx vitest run tests/api/ttn-webhooks.test.ts 2>&1 | grep -E 'passed|failed|skipped'` shows 32 passed, 0 skipped, 0 failed
  </verify>
  <done>
- Full backend test suite runs without new failures
- TTN webhook tests: 32 passed, 0 skipped, 0 failed
- Net change: -14 skipped tests, -6 duplicate passing tests from the backend suite
  </done>
  </task>

</tasks>

<verification>
Phase-level verification checks:
1. `grep -rc 'it\.skip\|test\.skip' backend/tests/api/ttn-webhooks.test.ts` returns 0
2. `ls backend/tests/routes/ 2>/dev/null` fails (directory removed)
3. `cd backend && npx vitest run tests/api/ttn-webhooks.test.ts` shows 32 passed
4. `cd backend && pnpm test` shows no new failures vs baseline
</verification>

<success_criteria>

- Zero `it.skip` or `test.skip` markers in any TTN webhook test file
- All 32 TTN webhook tests pass (covering: authentication, payload validation, reading creation, alert triggers, device metadata, edge cases)
- Single canonical test file at `backend/tests/api/ttn-webhooks.test.ts`
- `backend/tests/routes/` directory removed
- No regression in the broader backend test suite
  </success_criteria>

<output>
After completion, create `.planning/phases/52-backend-ttn-webhook-tests/52-01-SUMMARY.md`
</output>
