---
phase: 40-settings-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/SmsAlertHistory.tsx
  - src/components/settings/TTNProvisioningLogs.tsx
  - src/components/settings/EmulatorSyncHistory.tsx
autonomous: true

must_haves:
  truths:
    - 'SmsAlertHistory renders SMS log data from tRPC without supabase'
    - 'TTNProvisioningLogs renders provisioning log data from tRPC without supabase'
    - 'EmulatorSyncHistory renders sync history data from tRPC without supabase'
    - 'All three components load and display data without errors'
  artifacts:
    - path: 'src/components/settings/SmsAlertHistory.tsx'
      provides: 'SMS alert history display using tRPC'
      contains: 'useTRPC'
    - path: 'src/components/settings/TTNProvisioningLogs.tsx'
      provides: 'TTN provisioning logs display using tRPC'
      contains: 'useTRPC'
    - path: 'src/components/settings/EmulatorSyncHistory.tsx'
      provides: 'Emulator sync history display using tRPC'
      contains: 'useTRPC'
  key_links:
    - from: 'src/components/settings/SmsAlertHistory.tsx'
      to: 'backend smsAlertLog procedure'
      via: 'queryOptions'
      pattern: "trpc\\.sms.*\\.queryOptions"
    - from: 'src/components/settings/TTNProvisioningLogs.tsx'
      to: 'backend ttnSettings procedure'
      via: 'queryOptions'
      pattern: "trpc\\.ttnSettings.*\\.queryOptions"
    - from: 'src/components/settings/EmulatorSyncHistory.tsx'
      to: 'backend emulatorSync procedure'
      via: 'queryOptions'
      pattern: "trpc\\..*\\.queryOptions"
---

<objective>
Migrate 3 read-only list components from supabase to tRPC data fetching.

Purpose: These components (SmsAlertHistory, TTNProvisioningLogs, EmulatorSyncHistory) have straightforward read-only queries displaying historical log data. Some may require new backend procedures.

Output: 3 components using tRPC hooks instead of supabase-placeholder imports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/38-test-infrastructure/38-01-SUMMARY.md (tRPC mock patterns)
@.planning/phases/39-dashboard-widgets/39-01-SUMMARY.md (widget migration patterns)
@src/hooks/useSites.ts (tRPC hook pattern reference)
@src/lib/trpc.ts (tRPC client setup)
@backend/src/routers/ttn-settings.router.ts (TTN procedures)
@backend/src/routers/sms-config.router.ts (SMS config procedures)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend procedures for logs if needed, then migrate SmsAlertHistory</name>
  <files>
    backend/src/routers/sms-config.router.ts
    backend/src/schemas/sms-config.ts
    src/components/settings/SmsAlertHistory.tsx
  </files>
  <action>
First, check if backend has a procedure for sms_alert_log. If not, add one:

1. In backend/src/routers/sms-config.router.ts, add a new procedure:

```typescript
/**
 * List SMS alert history
 * Returns recent SMS alerts sent for the organization
 */
listAlertHistory: orgProcedure
  .input(z.object({
    organizationId: z.string().uuid(),
    limit: z.number().int().min(1).max(100).optional().default(20),
  }))
  .output(z.array(z.object({
    id: z.string().uuid(),
    phoneNumber: z.string(),
    fromNumber: z.string().nullable(),
    alertType: z.string(),
    message: z.string(),
    status: z.string(),
    createdAt: z.date(),
    errorMessage: z.string().nullable(),
    providerMessageId: z.string().nullable(),
    deliveryUpdatedAt: z.date().nullable(),
  })))
  .query(async ({ ctx, input }) => {
    const logs = await db.query.smsAlertLog.findMany({
      where: eq(smsAlertLog.organizationId, ctx.user.organizationId),
      orderBy: [desc(smsAlertLog.createdAt)],
      limit: input.limit,
    });
    return logs.map(log => ({
      id: log.id,
      phoneNumber: log.phoneNumber,
      fromNumber: log.fromNumber,
      alertType: log.alertType,
      message: log.message,
      status: log.status,
      createdAt: log.createdAt,
      errorMessage: log.errorMessage,
      providerMessageId: log.providerMessageId,
      deliveryUpdatedAt: log.deliveryUpdatedAt,
    }));
  }),
```

2. In SmsAlertHistory.tsx:

- Remove: `import { supabase } from "@/lib/supabase-placeholder";`
- Add: `import { useTRPC } from "@/lib/trpc";`
- Replace the useQuery queryFn with tRPC:

```tsx
const trpc = useTRPC();
const queryOptions = trpc.smsConfig.listAlertHistory.queryOptions({
  organizationId: organizationId!,
  limit: 20,
});
const {
  data: logs,
  isLoading,
  isRefetching,
} = useQuery({
  ...queryOptions,
  enabled: !!organizationId,
});
```

- Update field references from snake_case to camelCase:
  - `phone_number` -> `phoneNumber`
  - `from_number` -> `fromNumber`
  - `alert_type` -> `alertType`
  - `created_at` -> `createdAt`
  - `error_message` -> `errorMessage`
  - `provider_message_id` -> `providerMessageId`
  - `delivery_updated_at` -> `deliveryUpdatedAt`
    </action>
    <verify>
    `grep -c "supabase-placeholder" src/components/settings/SmsAlertHistory.tsx` returns 0
    `grep -c "useTRPC" src/components/settings/SmsAlertHistory.tsx` returns 1+
    `npx tsc --noEmit` passes
    </verify>
    <done>SmsAlertHistory fetches data via tRPC, no supabase imports remain</done>
    </task>

<task type="auto">
  <name>Task 2: Add backend procedure for TTN provisioning logs, then migrate TTNProvisioningLogs</name>
  <files>
    backend/src/routers/ttn-settings.router.ts
    src/components/settings/TTNProvisioningLogs.tsx
  </files>
  <action>
1. In backend/src/routers/ttn-settings.router.ts, add a new procedure:
```typescript
/**
 * List TTN provisioning logs
 * Returns recent provisioning activity for the organization
 */
listProvisioningLogs: orgProcedure
  .input(z.object({
    organizationId: z.string().uuid(),
    limit: z.number().int().min(1).max(100).optional().default(50),
  }))
  .output(z.array(z.object({
    id: z.string().uuid(),
    createdAt: z.date(),
    step: z.string(),
    status: z.string(),
    message: z.string().nullable(),
    payload: z.record(z.unknown()).nullable(),
    durationMs: z.number().nullable(),
    requestId: z.string().nullable(),
    ttnHttpStatus: z.number().nullable(),
    ttnResponseBody: z.string().nullable(),
    errorCategory: z.string().nullable(),
    ttnEndpoint: z.string().nullable(),
  })))
  .query(async ({ ctx, input }) => {
    const logs = await db.query.ttnProvisioningLogs.findMany({
      where: eq(ttnProvisioningLogs.organizationId, ctx.user.organizationId),
      orderBy: [desc(ttnProvisioningLogs.createdAt)],
      limit: input.limit,
    });
    return logs.map(log => ({
      id: log.id,
      createdAt: log.createdAt,
      step: log.step,
      status: log.status,
      message: log.message,
      payload: log.payload,
      durationMs: log.durationMs,
      requestId: log.requestId,
      ttnHttpStatus: log.ttnHttpStatus,
      ttnResponseBody: log.ttnResponseBody,
      errorCategory: log.errorCategory,
      ttnEndpoint: log.ttnEndpoint,
    }));
  }),
```

Note: Check if the ttnProvisioningLogs table/schema exists. If not in drizzle schema, may need to add it or use raw query.

2. In TTNProvisioningLogs.tsx:

- Remove: `import { supabase } from "@/lib/supabase-placeholder";`
- Add: `import { useTRPC } from "@/lib/trpc";` and `import { useQuery } from "@tanstack/react-query";`
- Replace the useEffect + fetchLogs with useQuery:

```tsx
const trpc = useTRPC();
const queryOptions = trpc.ttnSettings.listProvisioningLogs.queryOptions({
  organizationId: organizationId!,
  limit: 50,
});
const {
  data: logs = [],
  isLoading,
  refetch,
} = useQuery({
  ...queryOptions,
  enabled: !!organizationId,
});
```

- Remove the useState for logs and isLoading (useQuery provides these)
- Remove the useEffect and fetchLogs function
- Update field references from snake_case to camelCase:
  - `created_at` -> `createdAt`
  - `duration_ms` -> `durationMs`
  - `request_id` -> `requestId`
  - `ttn_http_status` -> `ttnHttpStatus`
  - `ttn_response_body` -> `ttnResponseBody`
  - `error_category` -> `errorCategory`
  - `ttn_endpoint` -> `ttnEndpoint`
    </action>
    <verify>
    `grep -c "supabase-placeholder" src/components/settings/TTNProvisioningLogs.tsx` returns 0
    `grep -c "useTRPC" src/components/settings/TTNProvisioningLogs.tsx` returns 1+
    `npx tsc --noEmit` passes
    </verify>
    <done>TTNProvisioningLogs fetches data via tRPC, no supabase imports remain</done>
    </task>

<task type="auto">
  <name>Task 3: Add backend procedure for emulator sync history, then migrate EmulatorSyncHistory</name>
  <files>
    backend/src/routers/organizations.router.ts
    src/components/settings/EmulatorSyncHistory.tsx
  </files>
  <action>
1. In backend/src/routers/organizations.router.ts (or create a new emulator.router.ts), add:
```typescript
/**
 * List emulator sync history
 * Returns recent emulator sync runs for the organization
 */
listEmulatorSyncHistory: orgProcedure
  .input(z.object({
    organizationId: z.string().uuid(),
    limit: z.number().int().min(1).max(100).optional().default(25),
  }))
  .output(z.array(z.object({
    id: z.string().uuid(),
    organizationId: z.string().uuid(),
    syncId: z.string().nullable(),
    syncedAt: z.date(),
    processedAt: z.date(),
    status: z.string(),
    counts: z.object({
      gateways: z.object({ created: z.number(), updated: z.number() }).optional(),
      devices: z.object({ created: z.number(), updated: z.number() }).optional(),
      sensors: z.object({ created: z.number(), updated: z.number() }).optional(),
    }),
    warnings: z.array(z.string()),
    errors: z.array(z.string()),
    payloadSummary: z.object({
      gatewaysCount: z.number().optional(),
      devicesCount: z.number().optional(),
      sensorsCount: z.number().optional(),
    }).nullable(),
    createdAt: z.date(),
  })))
  .query(async ({ ctx, input }) => {
    const runs = await db.query.emulatorSyncRuns.findMany({
      where: eq(emulatorSyncRuns.organizationId, ctx.user.organizationId),
      orderBy: [desc(emulatorSyncRuns.createdAt)],
      limit: input.limit,
    });
    return runs.map(run => ({
      id: run.id,
      organizationId: run.organizationId,
      syncId: run.syncId,
      syncedAt: run.syncedAt,
      processedAt: run.processedAt,
      status: run.status,
      counts: run.counts ?? {},
      warnings: run.warnings ?? [],
      errors: run.errors ?? [],
      payloadSummary: run.payloadSummary,
      createdAt: run.createdAt,
    }));
  }),
```

Note: Check if emulatorSyncRuns exists in drizzle schema. If not, may need raw query.

2. In EmulatorSyncHistory.tsx:

- Remove: `import { supabase } from "@/lib/supabase-placeholder";`
- Add: `import { useTRPC } from "@/lib/trpc";`
- Replace the useQuery queryFn with tRPC:

```tsx
const trpc = useTRPC();
const queryOptions = trpc.organizations.listEmulatorSyncHistory.queryOptions({
  organizationId: organizationId!,
  limit: 25,
});
const {
  data: syncRuns,
  isLoading,
  refetch,
  isRefetching,
} = useQuery({
  ...queryOptions,
  enabled: !!organizationId,
});
```

- Update field references from snake_case to camelCase:
  - `sync_id` -> `syncId`
  - `synced_at` -> `syncedAt`
  - `processed_at` -> `processedAt`
  - `created_at` -> `createdAt`
  - `payload_summary` -> `payloadSummary`
  - `gateways_count` -> `gatewaysCount`
  - `devices_count` -> `devicesCount`
  - `sensors_count` -> `sensorsCount`
    </action>
    <verify>
    `grep -c "supabase-placeholder" src/components/settings/EmulatorSyncHistory.tsx` returns 0
    `grep -c "useTRPC" src/components/settings/EmulatorSyncHistory.tsx` returns 1+
    `npx tsc --noEmit` passes
    </verify>
    <done>EmulatorSyncHistory fetches data via tRPC, no supabase imports remain</done>
    </task>

</tasks>

<verification>
After all tasks complete:

1. Check no supabase imports remain in migrated components:

```bash
grep -l "supabase-placeholder" src/components/settings/SmsAlertHistory.tsx src/components/settings/TTNProvisioningLogs.tsx src/components/settings/EmulatorSyncHistory.tsx
```

Should return empty.

2. TypeScript compilation:

```bash
npx tsc --noEmit
```

3. Verify tRPC usage:

```bash
grep -c "useTRPC" src/components/settings/SmsAlertHistory.tsx
grep -c "useTRPC" src/components/settings/TTNProvisioningLogs.tsx
grep -c "useTRPC" src/components/settings/EmulatorSyncHistory.tsx
```

Each should return 1+.

4. Run backend tests:

```bash
npm run test:backend -- --testPathPattern="sms-config|ttn-settings|organizations"
```

</verification>

<success_criteria>

- 3 components migrated from supabase to tRPC
- Zero supabase-placeholder imports in migrated files
- Backend procedures added/updated as needed
- TypeScript compiles without errors
- Each component uses useTRPC() pattern with queryOptions
  </success_criteria>

<output>
After completion, create `.planning/phases/40-settings-components/40-01-SUMMARY.md`
</output>
