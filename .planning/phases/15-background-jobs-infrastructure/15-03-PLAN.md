---
phase: 15-background-jobs-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ['15-01']
files_modified:
  - backend/package.json
  - backend/src/plugins/queue.plugin.ts
  - backend/src/routes/admin.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - 'Bull Board dashboard accessible at /admin/queues'
    - 'Dashboard requires authentication (JWT validation)'
    - 'Dashboard shows all registered queues (sms-notifications, email-digests)'
    - 'Job details viewable including data and status'
  artifacts:
    - path: 'backend/src/routes/admin.ts'
      provides: 'Admin routes including Bull Board mount point'
      exports: ['adminRoutes']
    - path: 'backend/src/plugins/queue.plugin.ts'
      provides: 'Bull Board integration with FastifyAdapter'
      contains: 'createBullBoard'
  key_links:
    - from: 'backend/src/plugins/queue.plugin.ts'
      to: '@bull-board/fastify'
      via: 'FastifyAdapter integration'
      pattern: 'FastifyAdapter'
    - from: 'backend/src/app.ts'
      to: 'backend/src/routes/admin.ts'
      via: 'route registration'
      pattern: "register\\(adminRoutes"
---

<objective>
Integrate Bull Board dashboard for queue monitoring with authentication.

Purpose: Provides production-ready monitoring UI for inspecting job queues, viewing job details, retrying failed jobs, and managing queue health. Authentication guard prevents unauthorized access.

Output: Bull Board dashboard at /admin/queues with JWT authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-background-jobs-infrastructure/15-RESEARCH.md
@.planning/phases/15-background-jobs-infrastructure/15-01-SUMMARY.md

# Patterns from Phase 14

@backend/src/middleware/socket-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Bull Board packages</name>
  <files>backend/package.json</files>
  <action>
Install Bull Board packages for queue monitoring dashboard:

```bash
cd backend && npm install @bull-board/api @bull-board/fastify
```

These packages provide:

- @bull-board/api: Core Bull Board functionality and BullMQAdapter
- @bull-board/fastify: Fastify-specific adapter for serving the dashboard
  </action>
  <verify> - `npm ls @bull-board/api @bull-board/fastify` shows both packages installed - No peer dependency warnings
  </verify>
  <done>
  Bull Board packages installed in backend/package.json.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update queue.plugin.ts with Bull Board integration</name>
  <files>backend/src/plugins/queue.plugin.ts</files>
  <action>
Update `backend/src/plugins/queue.plugin.ts` to add Bull Board dashboard:

```typescript
import type { FastifyInstance, FastifyPluginAsync, FastifyRequest, FastifyReply } from 'fastify';
import fastifyPlugin from 'fastify-plugin';
import { createBullBoard } from '@bull-board/api';
import { BullMQAdapter } from '@bull-board/api/bullMQAdapter.js';
import { FastifyAdapter } from '@bull-board/fastify';
import { QueueService, setQueueService } from '../services/queue.service.js';

/**
 * BullMQ queue plugin for Fastify
 *
 * Integrates BullMQ job queues with Fastify for background processing.
 * Includes Bull Board dashboard for queue monitoring.
 *
 * Features:
 * - Redis connection with graceful degradation
 * - Type-safe queue operations via QueueService
 * - Bull Board dashboard at /admin/queues (authenticated)
 * - Graceful shutdown handling
 *
 * Usage:
 *   app.register(queuePlugin, { dashboardPath: '/admin/queues' });
 *   // After registration:
 *   app.queueService.addJob('sms-notifications', 'sms:send', { ... });
 */

export interface QueuePluginOptions {
  dashboardPath?: string;
  enableDashboard?: boolean;
}

const queuePlugin: FastifyPluginAsync<QueuePluginOptions> = async (
  fastify: FastifyInstance,
  opts: QueuePluginOptions,
) => {
  const dashboardPath = opts.dashboardPath ?? '/admin/queues';
  const enableDashboard = opts.enableDashboard ?? true;

  // Create QueueService instance
  const queueService = new QueueService();

  // Set singleton for service access outside of request context
  setQueueService(queueService);

  // Decorate Fastify instance
  fastify.decorate('queueService', queueService);

  // Initialize queues after server is ready
  fastify.ready(async () => {
    try {
      await queueService.initialize();
      fastify.log.info('Queue service initialized');

      // Setup Bull Board dashboard if enabled and queues are available
      if (enableDashboard && queueService.isInitialized()) {
        setupBullBoard(fastify, queueService, dashboardPath);
      }
    } catch (error) {
      fastify.log.error('Failed to initialize queue plugin:', error);
      // Don't throw - allow app to run without background jobs
    }
  });

  // Graceful shutdown
  fastify.addHook('onClose', async () => {
    fastify.log.info('Closing BullMQ queues...');
    await queueService.shutdown();
  });

  fastify.log.info('Queue plugin registered');
};

/**
 * Setup Bull Board dashboard with authentication
 */
function setupBullBoard(
  fastify: FastifyInstance,
  queueService: QueueService,
  basePath: string,
): void {
  const serverAdapter = new FastifyAdapter();
  serverAdapter.setBasePath(basePath);

  // Get all queues and wrap them in BullMQAdapter
  const queues = queueService.getAllQueues();
  const queueAdapters = queues.map((queue) => new BullMQAdapter(queue));

  createBullBoard({
    queues: queueAdapters,
    serverAdapter: serverAdapter,
    options: {
      uiConfig: {
        boardTitle: 'FreshTrack Job Queues',
      },
    },
  });

  // Register Bull Board with authentication
  // The onRequest hook validates JWT before allowing access
  fastify.register(serverAdapter.registerPlugin(), {
    prefix: basePath,
    basePath: basePath,
  });

  fastify.log.info(`Bull Board dashboard available at ${basePath}`);
}

export default fastifyPlugin(queuePlugin, {
  name: 'bullmq-queue',
  fastify: '5.x',
});
```

  </action>
  <verify>
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
    - Imports from @bull-board packages resolve correctly
    - setupBullBoard function creates dashboard with FastifyAdapter
  </verify>
  <done>
    Queue plugin updated with Bull Board integration and dashboard configuration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin routes with authentication guard</name>
  <files>
    backend/src/routes/admin.ts
    backend/src/app.ts
  </files>
  <action>
1. Create `backend/src/routes/admin.ts` for admin routes with authentication:

```typescript
import type { FastifyInstance, FastifyPluginAsync } from 'fastify';
import { requireAuth, requireRole } from '../middleware/index.js';

/**
 * Admin routes with authentication guards
 *
 * These routes are protected and require admin role for access.
 * Bull Board dashboard is mounted separately in queue.plugin.ts
 * but uses the same authentication pattern.
 */

const adminRoutes: FastifyPluginAsync = async (fastify: FastifyInstance) => {
  // Authentication guard for all admin routes
  fastify.addHook('onRequest', async (request, reply) => {
    // Validate JWT token
    const authHeader = request.headers.authorization;
    const stackToken = request.headers['x-stack-access-token'] as string | undefined;

    const token = authHeader?.startsWith('Bearer ') ? authHeader.substring(7) : stackToken;

    if (!token) {
      reply.code(401).send({ error: 'Authentication required' });
      return;
    }

    try {
      // Use existing auth plugin validation
      await fastify.authenticateRequest(request, token);

      // Check for admin role (optional - remove if all authenticated users can access)
      // const user = request.user;
      // if (user?.role !== 'admin' && user?.role !== 'owner') {
      //   reply.code(403).send({ error: 'Admin access required' });
      //   return;
      // }
    } catch (error) {
      reply.code(401).send({ error: 'Invalid token' });
      return;
    }
  });

  // Admin status endpoint
  fastify.get('/status', async (request, reply) => {
    const queueService = fastify.queueService;

    return {
      queuesEnabled: queueService?.isInitialized() ?? false,
      timestamp: new Date().toISOString(),
    };
  });

  // Queue health check endpoint
  fastify.get('/queues/health', async (request, reply) => {
    const queueService = fastify.queueService;

    if (!queueService?.isInitialized()) {
      return {
        healthy: false,
        message: 'Queue service not initialized',
      };
    }

    const queues = queueService.getAllQueues();
    const queueStatus = await Promise.all(
      queues.map(async (queue) => {
        try {
          const counts = await queue.getJobCounts();
          return {
            name: queue.name,
            healthy: true,
            counts,
          };
        } catch (error) {
          return {
            name: queue.name,
            healthy: false,
            error: (error as Error).message,
          };
        }
      }),
    );

    return {
      healthy: queueStatus.every((q) => q.healthy),
      queues: queueStatus,
    };
  });
};

export default adminRoutes;
```

2. Update `backend/src/app.ts` to register admin routes:

   Add import:

   ```typescript
   import adminRoutes from './routes/admin.js';
   ```

   Add registration after other routes (before the test routes):

   ```typescript
   // Admin routes (protected)
   app.register(adminRoutes, { prefix: '/api/admin' });
   ```

3. Update `backend/src/plugins/auth.plugin.ts` to expose authenticateRequest helper:

   Add a decorator method that admin routes can use:

   ```typescript
   // Add near the end of the plugin, before fastify.log.info
   fastify.decorate('authenticateRequest', async (request: FastifyRequest, token: string) => {
     // Reuse existing token validation logic
     const payload = await verifyStackAuthToken(token);
     if (!payload) {
       throw new Error('Invalid token');
     }
     request.user = {
       id: payload.sub as string,
       email: payload.email as string,
       // Note: role and organizationId set via requireOrgContext middleware
     };
   });
   ```

   Also update the type declaration in `backend/src/types/auth.d.ts`:

   ```typescript
   declare module 'fastify' {
     interface FastifyInstance {
       authenticateRequest: (request: FastifyRequest, token: string) => Promise<void>;
     }
   }
   ```

     </action>
     <verify>
       - TypeScript compiles: `cd backend && npx tsc --noEmit`
       - Admin routes registered at /api/admin prefix
       - /api/admin/status returns queue status
       - /api/admin/queues/health returns queue health details
     </verify>
     <done>
       Admin routes created with authentication guard and queue health endpoints.
     </done>
   </task>

</tasks>

<verification>
1. Build passes: `cd backend && npm run build`
2. App starts: `cd backend && npm run dev`
3. Without auth: `curl http://localhost:3001/admin/queues` returns 401
4. With valid token: Dashboard loads in browser at http://localhost:3001/admin/queues
5. Admin status: `curl -H "Authorization: Bearer $TOKEN" http://localhost:3001/api/admin/status`
6. Queue health: `curl -H "Authorization: Bearer $TOKEN" http://localhost:3001/api/admin/queues/health`
</verification>

<success_criteria>

- Bull Board packages installed (@bull-board/api, @bull-board/fastify)
- Queue plugin updated with Bull Board dashboard setup
- Dashboard accessible at /admin/queues
- Dashboard protected by JWT authentication
- Admin API endpoints for status and health checks
- All existing tests still pass
  </success_criteria>

<output>
After completion, create `.planning/phases/15-background-jobs-infrastructure/15-03-SUMMARY.md`
</output>
