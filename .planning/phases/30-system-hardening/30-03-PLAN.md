---
phase: 30-system-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase-placeholder.ts
autonomous: true

must_haves:
  truths:
    - 'Supabase placeholder provides clear, user-friendly error messages'
    - 'Edge function calls return structured errors with feature names for UI display'
    - 'Placeholder warns only once per session to avoid console spam'
  artifacts:
    - path: 'src/lib/supabase-placeholder.ts'
      provides: 'Enhanced placeholder with clear unavailability messages'
      contains: '__unavailable'
  key_links: []
---

<objective>
Enhance the supabase-placeholder.ts to provide clearer error messages and structured responses that UI components can use to display helpful "feature unavailable" messages to users.

Purpose: Improve UX for disabled features by providing clear, actionable messaging instead of generic errors
Output: Enhanced placeholder that returns structured errors with feature identification
</objective>

<execution_context>
@/home/swoop/.claude/get-shit-done/workflows/execute-plan.md
@/home/swoop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-system-hardening/30-RESEARCH.md
@.planning/phases/30-system-hardening/30-CONTEXT.md

# Key files

@src/lib/supabase-placeholder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance supabase-placeholder with structured error responses</name>
  <files>src/lib/supabase-placeholder.ts</files>
  <action>
    Update the placeholder to provide better error handling:

    1. Add a typed error class for better error identification:
       ```typescript
       export class SupabaseMigrationError extends Error {
         readonly isSupabaseMigration = true;
         readonly featureName?: string;

         constructor(message: string, featureName?: string) {
           super(message);
           this.name = 'SupabaseMigrationError';
           this.featureName = featureName;
         }
       }
       ```

    2. Create a base error message:
       ```typescript
       const MIGRATION_MESSAGE = 'This feature is temporarily unavailable while being migrated to the new backend.';
       ```

    3. Update `functions.invoke` to include the function name in the error:
       ```typescript
       functions: {
         invoke: async (functionName: string) => {
           warnOnce();
           return {
             data: null,
             error: new SupabaseMigrationError(
               `${MIGRATION_MESSAGE} (${functionName})`,
               functionName
             ),
             __unavailable: functionName,
           };
         },
       },
       ```

    4. Update `rpc` to include the function name:
       ```typescript
       rpc: async (functionName: string) => {
         warnOnce();
         return {
           data: null,
           error: new SupabaseMigrationError(
             `${MIGRATION_MESSAGE} (${functionName})`,
             functionName
           ),
           __unavailable: functionName,
         };
       },
       ```

    5. Export a helper function for UI components to check if an error is a migration error:
       ```typescript
       export function isSupabaseMigrationError(error: unknown): error is SupabaseMigrationError {
         return error instanceof SupabaseMigrationError ||
           (error !== null && typeof error === 'object' && 'isSupabaseMigration' in error);
       }
       ```

    Keep existing types (AppRole, ComplianceMode, Database, Json) as they may be used by imports.
    Keep the warnOnce() behavior to avoid console spam.

  </action>
  <verify>
    1. `npm run build` succeeds (TypeScript compiles)
    2. `grep -q "SupabaseMigrationError" src/lib/supabase-placeholder.ts` returns 0
    3. `grep -q "__unavailable" src/lib/supabase-placeholder.ts` returns 0
  </verify>
  <done>
    - SupabaseMigrationError class exported for type checking
    - functions.invoke returns structured error with function name
    - rpc returns structured error with function name
    - isSupabaseMigrationError helper exported for UI components
    - Frontend builds successfully
  </done>
</task>

</tasks>

<verification>
1. Frontend compiles: `npm run build`
2. Placeholder has new error class: `grep "SupabaseMigrationError" src/lib/supabase-placeholder.ts`
3. Placeholder includes function names: `grep "__unavailable" src/lib/supabase-placeholder.ts`
</verification>

<success_criteria>

- SupabaseMigrationError class is exported and can be used for type checking
- functions.invoke returns errors with the specific function name
- rpc returns errors with the specific function name
- isSupabaseMigrationError helper function is exported
- Frontend builds without errors
- Existing imports of AppRole, ComplianceMode, Database, Json still work
  </success_criteria>

<output>
After completion, create `.planning/phases/30-system-hardening/30-03-SUMMARY.md`
</output>
