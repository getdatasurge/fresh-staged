---
phase: 30-system-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - 'Backend adds security headers (X-Content-Type-Options, X-Frame-Options, etc.) to all responses'
    - 'JSON request body size is limited to prevent DoS'
    - 'Request timeout prevents indefinite connection hangs'
  artifacts:
    - path: 'backend/src/app.ts'
      provides: 'Helmet registration and body/timeout limits'
      contains: '@fastify/helmet'
  key_links:
    - from: 'backend/src/app.ts'
      to: '@fastify/helmet'
      via: 'plugin registration'
      pattern: "app\\.register\\(helmet"
---

<objective>
Add security headers via @fastify/helmet, set JSON body limits, and configure request timeout to harden the backend against common web vulnerabilities and DoS attacks.

Purpose: Fill the identified security gaps in backend hardening (missing helmet, unlimited JSON body, no request timeout)
Output: Hardened backend with production-ready security defaults
</objective>

<execution_context>
@/home/swoop/.claude/get-shit-done/workflows/execute-plan.md
@/home/swoop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-system-hardening/30-RESEARCH.md

# Key files

@backend/src/app.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @fastify/helmet security headers plugin</name>
  <files>backend/package.json</files>
  <action>
    Install @fastify/helmet for comprehensive HTTP security headers.

    ```bash
    cd backend && npm install @fastify/helmet
    ```

    This adds Content-Security-Policy, X-Content-Type-Options, X-Frame-Options,
    X-Download-Options, X-XSS-Protection, and other security headers automatically.

  </action>
  <verify>`npm ls @fastify/helmet` shows package installed</verify>
  <done>@fastify/helmet is in backend/package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Configure helmet, body limits, and request timeout in app.ts</name>
  <files>backend/src/app.ts</files>
  <action>
    1. Import helmet at top of file:
       ```typescript
       import helmet from '@fastify/helmet';
       ```

    2. Add bodyLimit and requestTimeout to Fastify constructor options (after logger config):
       ```typescript
       const app = Fastify({
         logger: loggerConfig,
         requestIdHeader: 'x-request-id',
         requestIdLogLabel: 'requestId',
         maxParamLength: 5000,
         // Security: Limit JSON body size (1MB default)
         bodyLimit: 1048576,
         // Security: Prevent indefinite request hangs (30 seconds)
         requestTimeout: 30000,
       });
       ```

    3. Register helmet AFTER CORS but BEFORE routes. Add after the CORS registration block:
       ```typescript
       // Security headers via helmet
       // Note: CSP configured for React SPA with Stack Auth integration
       app.register(helmet, {
         contentSecurityPolicy: {
           directives: {
             defaultSrc: ["'self'"],
             scriptSrc: ["'self'", "'unsafe-inline'"],
             styleSrc: ["'self'", "'unsafe-inline'"],
             imgSrc: ["'self'", "data:", "https:"],
             fontSrc: ["'self'", "https://fonts.gstatic.com"],
             connectSrc: [
               "'self'",
               "https://api.stack-auth.com",
               "https://*.thethings.network",
               "wss://*",
               "ws://*",
             ],
           },
         },
         // HSTS handled by reverse proxy (Caddy/nginx) in production
         strictTransportSecurity: false,
       });
       ```

    NOTE: Register helmet AFTER cors because helmet must not interfere with CORS preflight responses.
    The 'unsafe-inline' for scripts/styles is required for React SPA hydration.

  </action>
  <verify>
    1. `cd backend && npm run build` succeeds (TypeScript compiles)
    2. `grep -q "helmet" backend/src/app.ts` returns 0
    3. `grep -q "bodyLimit: 1048576" backend/src/app.ts` returns 0
    4. `grep -q "requestTimeout: 30000" backend/src/app.ts` returns 0
  </verify>
  <done>
    - Helmet registered with CSP directives appropriate for React SPA
    - JSON body limit set to 1MB
    - Request timeout set to 30 seconds
    - Backend builds successfully
  </done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd backend && npm run build`
2. Helmet installed: `cd backend && npm ls @fastify/helmet`
3. Security config present in app.ts:
   - `grep "helmet" backend/src/app.ts`
   - `grep "bodyLimit" backend/src/app.ts`
   - `grep "requestTimeout" backend/src/app.ts`
</verification>

<success_criteria>

- @fastify/helmet is installed and registered in app.ts
- JSON body limit of 1MB is configured
- Request timeout of 30 seconds is configured
- CSP directives allow Stack Auth and React SPA operation
- Backend compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/30-system-hardening/30-01-SUMMARY.md`
</output>
