---
phase: 32-remaining-edge-function-migration
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/src/routers/ttn-devices.router.ts
  - src/components/settings/SensorManager.tsx
  - src/components/debug/EdgeFunctionDiagnostics.tsx
  - src/components/admin/SensorSimulatorPanel.tsx
autonomous: true

must_haves:
  truths:
    - 'SensorManager diagnoses devices via tRPC not edge function'
    - 'EdgeFunctionDiagnostics.tsx is deleted (dead code)'
    - 'SensorSimulatorPanel edge function call is evaluated and handled'
  artifacts:
    - path: 'backend/src/routers/ttn-devices.router.ts'
      provides: 'TTN devices router with diagnose procedure'
      contains: 'diagnose:'
    - path: 'src/components/settings/SensorManager.tsx'
      provides: 'Sensor management with tRPC diagnose'
      contains: 'ttnDevices.diagnose'
  key_links:
    - from: 'src/components/settings/SensorManager.tsx'
      to: 'ttnDevices.diagnose'
      via: 'useMutation'
      pattern: "ttnDevices\\.diagnose"
---

<objective>
Add diagnose procedure to ttn-devices router, migrate SensorManager, and clean up dead code

Purpose: Complete edge function migration by handling remaining 3 files - SensorManager needs backend procedure, EdgeFunctionDiagnostics is dead code, SensorSimulatorPanel needs evaluation
Output: ttnDevices.diagnose procedure, SensorManager migrated, dead code removed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-remaining-edge-function-migration/32-RESEARCH.md
@backend/src/routers/ttn-devices.router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diagnose procedure to ttn-devices router</name>
  <files>backend/src/routers/ttn-devices.router.ts</files>
  <action>
Add diagnose procedure to existing ttnDevicesRouter:

```typescript
// Add to existing imports if needed
import { TtnSettingsService } from '../services/ttn/settings.js'

// Add schema near other schemas
const DiagnoseInputSchema = z.object({
  organizationId: z.string().uuid(),
  sensorId: z.string().min(1), // deviceId/sensor identifier
})

const DiagnoseOutputSchema = z.object({
  success: z.boolean(),
  clusterBaseUrl: z.string().nullable(),
  region: z.string().nullable(),
  appId: z.string().nullable(),
  deviceId: z.string().nullable(),
  checks: z.array(z.object({
    name: z.string(),
    passed: z.boolean(),
    message: z.string().optional(),
  })),
  diagnosis: z.string().nullable(),
  hint: z.string().nullable(),
})

// Add to router object
/**
 * Diagnose device connectivity issues
 * Equivalent to: ttn-provision-device diagnose action
 *
 * Runs connectivity checks and returns diagnostic information.
 */
diagnose: orgProcedure
  .input(DiagnoseInputSchema)
  .output(DiagnoseOutputSchema)
  .mutation(async ({ input, ctx }) => {
    // Get TTN connection settings for the organization
    const conn = await db.query.ttnConnections.findFirst({
      where: eq(ttnConnections.organizationId, input.organizationId),
    })

    if (!conn) {
      return {
        success: false,
        clusterBaseUrl: null,
        region: null,
        appId: null,
        deviceId: input.sensorId,
        checks: [{ name: 'TTN Configuration', passed: false, message: 'No TTN connection configured' }],
        diagnosis: 'TTN is not configured for this organization',
        hint: 'Configure TTN settings in organization settings',
      }
    }

    // Run diagnostic checks
    const checks = []

    // Check 1: TTN connection configured
    checks.push({
      name: 'TTN Configuration',
      passed: true,
      message: 'TTN connection is configured',
    })

    // Check 2: Application ID exists
    const hasAppId = !!(conn.ttnApplicationId || conn.applicationId)
    checks.push({
      name: 'Application ID',
      passed: hasAppId,
      message: hasAppId ? `App ID: ${conn.ttnApplicationId || conn.applicationId}` : 'No application ID',
    })

    // Check 3: API credentials present
    const hasCredentials = !!conn.ttnApiKeyEncrypted
    checks.push({
      name: 'API Credentials',
      passed: hasCredentials,
      message: hasCredentials ? 'API credentials configured' : 'No API credentials',
    })

    // Generate diagnosis
    const allPassed = checks.every(c => c.passed)
    const diagnosis = allPassed
      ? 'All checks passed - device should be able to connect'
      : 'Some checks failed - see details above'

    const hint = allPassed
      ? 'If device still not working, check device-side configuration'
      : 'Fix the failed checks before troubleshooting further'

    return {
      success: allPassed,
      clusterBaseUrl: conn.ttnRegion ? `https://${conn.ttnRegion}.cloud.thethings.network` : null,
      region: conn.ttnRegion,
      appId: conn.ttnApplicationId || conn.applicationId || null,
      deviceId: input.sensorId,
      checks,
      diagnosis,
      hint,
    }
  }),
```

  </action>
  <verify>
- `grep "diagnose:" backend/src/routers/ttn-devices.router.ts` shows procedure exists
- `npm run build --prefix backend` succeeds
  </verify>
  <done>ttnDevices.diagnose procedure exists in router</done>
</task>

<task type="auto">
  <name>Task 2: Migrate SensorManager and clean up dead code</name>
  <files>src/components/settings/SensorManager.tsx, src/components/debug/EdgeFunctionDiagnostics.tsx, src/components/admin/SensorSimulatorPanel.tsx</files>
  <action>
Handle 3 remaining files:

1. **SensorManager.tsx** (line ~376):
   Replace `supabase.functions.invoke('ttn-provision-device', { body: { action: 'diagnose', sensor_id, organization_id } })`

   ```typescript
   const trpc = useTRPC();
   const diagnoseMutation = trpc.ttnDevices.diagnose.useMutation({
     onSuccess: (data) => {
       if (data.success) {
         toast.success('Diagnosis complete - all checks passed');
       } else {
         toast.warning(data.diagnosis || 'Some checks failed');
       }
       // Update UI with diagnostic results
     },
     onError: (err) => toast.error(err.message),
   });
   // Usage: diagnoseMutation.mutate({ organizationId, sensorId })
   ```

2. **EdgeFunctionDiagnostics.tsx** - DELETE THIS FILE:
   - This component checks health of edge functions that no longer exist
   - It's dead code - the edge functions have been migrated to tRPC
   - Search for imports/references and remove them too
   - Check if it's rendered anywhere (likely a debug/admin page)
   - If referenced in a route, remove the route or replace with a "deprecated" notice

3. **SensorSimulatorPanel.tsx** (line ~245):
   This is an admin-only dev tool. Two options:

   Option A (Preferred - Keep as-is): If `sensor-simulator` edge function still exists and works:
   - Add comment: `// Note: Kept as edge function - admin-only dev tool`
   - This is acceptable for internal tooling

   Option B (If edge function removed): Create minimal tRPC procedure:
   - Add `admin.simulateSensor` procedure
   - Migrate the call

   Decision: Check if edge function exists first. If it does, leave as-is with comment.
   If not, create placeholder procedure that returns error "Simulator not available".
   </action>
   <verify>

- `grep -c "supabase.functions.invoke" src/components/settings/SensorManager.tsx` returns 0
- `ls src/components/debug/EdgeFunctionDiagnostics.tsx` should NOT exist (deleted)
- `npm run build` succeeds (no broken imports)
- `grep "ttnDevices.diagnose" src/components/settings/SensorManager.tsx` shows tRPC usage
  </verify>
  <done>SensorManager uses tRPC diagnose, EdgeFunctionDiagnostics deleted, SensorSimulatorPanel handled</done>
  </task>

</tasks>

<verification>
Overall plan verification:
1. `grep -r "supabase.functions.invoke" src/components/settings/SensorManager.tsx` returns empty
2. `ls src/components/debug/EdgeFunctionDiagnostics.tsx 2>/dev/null` returns nothing (file deleted)
3. `npm run build --prefix backend && npm run build` both succeed
4. No broken imports from deleted EdgeFunctionDiagnostics
</verification>

<success_criteria>

- ttnDevices.diagnose procedure exists and works
- SensorManager.tsx uses tRPC for diagnose operation
- EdgeFunctionDiagnostics.tsx is deleted
- SensorSimulatorPanel.tsx is handled (kept with comment OR migrated)
- TypeScript builds without errors
- No broken imports or routes
  </success_criteria>

<output>
After completion, create `.planning/phases/32-remaining-edge-function-migration/32-04-SUMMARY.md`
</output>
