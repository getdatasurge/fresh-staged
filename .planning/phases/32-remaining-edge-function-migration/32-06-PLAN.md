---
phase: 32-remaining-edge-function-migration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/telnyx.router.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "verificationStatus queries Telnyx API for real toll-free verification status"
    - "verificationStatus returns actual status (approved/pending/rejected) from Telnyx"
    - "configureWebhook makes actual Telnyx API call to register webhook"
    - "configureWebhook returns real success/failure based on API response"
    - "Both procedures handle API errors gracefully"
  artifacts:
    - path: "backend/src/routers/telnyx.router.ts"
      provides: "Implemented Telnyx API integration for verification and webhook"
      contains: "tollFreeVerifications"
  key_links:
    - from: "backend/src/routers/telnyx.router.ts"
      to: "Telnyx SDK"
      via: "API calls"
      pattern: "telnyx\\.(tollFreeVerifications|messagingProfiles)"
---

<objective>
Implement the Telnyx API integration for verificationStatus and configureWebhook procedures

Purpose: Close Gaps 2 and 3 from 32-VERIFICATION.md - both procedures return placeholder data instead of making real Telnyx API calls.

Output: Working Telnyx integration that queries verification status and configures webhooks via the Telnyx SDK.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-remaining-edge-function-migration/32-VERIFICATION.md

# Existing stub to implement
@backend/src/routers/telnyx.router.ts

# Existing Telnyx service for pattern reference
@backend/src/services/telnyx.service.ts
@backend/src/config/telnyx.config.ts

# Env config
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement verificationStatus with Telnyx API</name>
  <files>backend/src/routers/telnyx.router.ts</files>
  <action>
Replace the placeholder in verificationStatus query with actual Telnyx API call:

1. Add Telnyx import at the top:
   ```typescript
   import { Telnyx } from 'telnyx'
   ```

2. Create Telnyx client helper (or use singleton pattern like TelnyxService):
   ```typescript
   function getTelnyxClient(): Telnyx | null {
     const apiKey = process.env.TELNYX_API_KEY
     if (!apiKey) return null
     return new Telnyx({ apiKey })
   }
   ```

3. In verificationStatus query implementation:
   ```typescript
   .query(async () => {
     const client = getTelnyxClient()
     if (!client) {
       return {
         status: 'unknown' as const,
         verificationId: null,
         phoneNumber: null,
         details: 'Telnyx API key not configured',
         lastChecked: new Date().toISOString(),
       }
     }

     try {
       // Get toll-free verifications for the configured phone number
       const phoneNumber = process.env.TELNYX_PHONE_NUMBER
       if (!phoneNumber) {
         return {
           status: 'unknown' as const,
           verificationId: null,
           phoneNumber: null,
           details: 'Telnyx phone number not configured',
           lastChecked: new Date().toISOString(),
         }
       }

       // List toll-free verifications filtered by phone number
       const response = await client.tollFreeVerifications.list({
         filter: { phone_number: { eq: phoneNumber } }
       })

       const verification = response.data?.[0]
       if (!verification) {
         return {
           status: 'unknown' as const,
           verificationId: null,
           phoneNumber,
           details: 'No verification found for this number',
           lastChecked: new Date().toISOString(),
         }
       }

       // Map Telnyx status to our enum
       const statusMap: Record<string, 'approved' | 'pending' | 'rejected' | 'unknown'> = {
         approved: 'approved',
         pending: 'pending',
         rejected: 'rejected',
         submitted: 'pending',
         in_review: 'pending',
       }

       return {
         status: statusMap[verification.status] || 'unknown',
         verificationId: verification.id || null,
         phoneNumber: verification.phone_number || phoneNumber,
         details: verification.rejection_reason || null,
         lastChecked: new Date().toISOString(),
       }
     } catch (error) {
       console.error('[telnyx.verificationStatus] API error:', error)
       return {
         status: 'unknown' as const,
         verificationId: null,
         phoneNumber: process.env.TELNYX_PHONE_NUMBER || null,
         details: error instanceof Error ? error.message : 'Failed to fetch verification status',
         lastChecked: new Date().toISOString(),
       }
     }
   })
   ```

Note: The Telnyx SDK types may vary. Check the actual SDK response shape and adjust field names accordingly. Key is to NOT return hardcoded "pending" anymore.
  </action>
  <verify>
Grep for the implementation:
```bash
grep -n "tollFreeVerifications\|client\." backend/src/routers/telnyx.router.ts
```

Should show Telnyx API calls, NOT "Placeholder" comments.
  </verify>
  <done>
verificationStatus queries Telnyx API for real verification status. Returns actual status from API or 'unknown' with error details if API fails or is not configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement configureWebhook with Telnyx API</name>
  <files>backend/src/routers/telnyx.router.ts</files>
  <action>
Replace the placeholder in configureWebhook mutation with actual Telnyx API call:

1. In configureWebhook mutation implementation, after the admin/owner check:
   ```typescript
   .mutation(async ({ ctx }) => {
     // Admin/owner check (already exists)
     if (!['admin', 'owner'].includes(ctx.user.role)) {
       return {
         success: false,
         error: 'Only administrators can configure webhooks',
       }
     }

     const client = getTelnyxClient()
     if (!client) {
       return {
         success: false,
         error: 'Telnyx API key not configured',
       }
     }

     try {
       // Build webhook URL from API_URL or FRONTEND_URL
       const apiUrl = process.env.API_URL || process.env.FRONTEND_URL || 'http://localhost:3000'
       const webhookUrl = `${apiUrl}/webhooks/telnyx`

       // Get messaging profile ID
       const profileId = process.env.TELNYX_MESSAGING_PROFILE_ID
       if (!profileId) {
         return {
           success: false,
           error: 'Telnyx messaging profile ID not configured',
         }
       }

       // Update the messaging profile with webhook URL
       await client.messagingProfiles.update(profileId, {
         webhook_url: webhookUrl,
         webhook_api_version: '2',
       })

       return {
         success: true,
         webhookUrl,
       }
     } catch (error) {
       console.error('[telnyx.configureWebhook] API error:', error)
       return {
         success: false,
         error: error instanceof Error ? error.message : 'Failed to configure webhook',
       }
     }
   })
   ```

Note: The Telnyx messagingProfiles API is used to configure webhooks for SMS delivery. Check SDK docs for exact method names if they differ.
  </action>
  <verify>
TypeScript check:
```bash
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npx tsc --noEmit
```

Grep for implementation:
```bash
grep -n "messagingProfiles\|webhook_url" backend/src/routers/telnyx.router.ts
```

Should show Telnyx API calls for webhook configuration.
  </verify>
  <done>
configureWebhook makes real Telnyx API call to update messaging profile with webhook URL. Returns actual success/failure based on API response.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. verificationStatus contains Telnyx SDK calls (tollFreeVerifications)
3. configureWebhook contains Telnyx SDK calls (messagingProfiles)
4. No more "Placeholder" comments in the procedures
5. Both procedures handle missing API key gracefully (return error, don't crash)
6. Both procedures handle API errors gracefully (catch and return error message)
</verification>

<success_criteria>
- [ ] verificationStatus queries Telnyx tollFreeVerifications API
- [ ] verificationStatus returns real status (not hardcoded "pending")
- [ ] configureWebhook calls Telnyx messagingProfiles API
- [ ] configureWebhook actually registers webhook URL in Telnyx
- [ ] Both procedures handle missing TELNYX_API_KEY gracefully
- [ ] Both procedures handle API errors with error messages
- [ ] TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/32-remaining-edge-function-migration/32-06-SUMMARY.md`
</output>
