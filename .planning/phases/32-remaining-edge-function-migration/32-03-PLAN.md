---
phase: 32-remaining-edge-function-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/telnyx.router.ts
  - backend/src/trpc/router.ts
  - src/components/settings/TollFreeVerificationCard.tsx
  - src/components/settings/WebhookStatusCard.tsx
  - src/components/settings/OptInImageStatusCard.tsx
  - src/pages/UploadTelnyxImage.tsx
autonomous: true

must_haves:
  truths:
    - 'TollFreeVerificationCard fetches verification status via tRPC'
    - 'WebhookStatusCard configures webhook via tRPC'
    - 'OptInImageStatusCard verifies public asset via tRPC'
    - 'UploadTelnyxImage verifies public asset via tRPC'
  artifacts:
    - path: 'backend/src/routers/telnyx.router.ts'
      provides: 'Telnyx tRPC router'
      exports: ['telnyxRouter']
    - path: 'src/components/settings/TollFreeVerificationCard.tsx'
      provides: 'Toll-free verification UI'
      contains: 'trpc.telnyx.verificationStatus'
    - path: 'src/components/settings/WebhookStatusCard.tsx'
      provides: 'Webhook configuration UI'
      contains: 'trpc.telnyx.configureWebhook'
  key_links:
    - from: 'backend/src/trpc/router.ts'
      to: 'telnyx.router.ts'
      via: 'router import'
      pattern: "telnyx:\\s*telnyxRouter"
    - from: 'src/components/settings/TollFreeVerificationCard.tsx'
      to: 'telnyx.verificationStatus'
      via: 'useQuery'
      pattern: "telnyx\\.verificationStatus"
---

<objective>
Create Telnyx tRPC router and migrate 4 edge function calls across 4 files

Purpose: Replace 4 Telnyx-related edge function calls with type-safe tRPC procedures
Output: New telnyx.router.ts with 3 procedures, 4 frontend files migrated
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-remaining-edge-function-migration/32-RESEARCH.md
@backend/src/trpc/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Telnyx tRPC router with 3 procedures</name>
  <files>backend/src/routers/telnyx.router.ts, backend/src/trpc/router.ts</files>
  <action>
Create backend/src/routers/telnyx.router.ts:

```typescript
/**
 * Telnyx tRPC Router
 *
 * Provides procedures for Telnyx SMS configuration:
 * - verificationStatus: Get toll-free verification status
 * - configureWebhook: Configure Telnyx webhook endpoint
 * - verifyPublicAsset: Verify a public URL is accessible (for opt-in images)
 */

import { z } from 'zod';
import { router } from '../trpc/index.js';
import { publicProcedure, orgProcedure } from '../trpc/procedures.js';

export const telnyxRouter = router({
  /**
   * Get toll-free verification status
   * Equivalent to: telnyx-verification-status edge function
   *
   * Returns current toll-free number verification status from Telnyx API.
   */
  verificationStatus: publicProcedure
    .output(
      z.object({
        status: z.string(),
        verificationId: z.string().nullable(),
        phoneNumber: z.string().nullable(),
        details: z.record(z.unknown()).nullable(),
        lastChecked: z.string().nullable(),
      }),
    )
    .query(async () => {
      // Port logic from telnyx-verification-status edge function
      // Query Telnyx API for verification status

      // Placeholder - implement based on edge function source
      return {
        status: 'pending',
        verificationId: null,
        phoneNumber: null,
        details: null,
        lastChecked: new Date().toISOString(),
      };
    }),

  /**
   * Configure Telnyx webhook endpoint
   * Equivalent to: telnyx-configure-webhook edge function
   *
   * Sets up or updates the webhook URL in Telnyx for SMS delivery notifications.
   */
  configureWebhook: orgProcedure
    .input(
      z.object({
        organizationId: z.string().uuid(),
      }),
    )
    .output(
      z.object({
        success: z.boolean(),
        webhookUrl: z.string().optional(),
        error: z.string().optional(),
      }),
    )
    .mutation(async ({ input, ctx }) => {
      // Admin/owner check
      if (!['admin', 'owner'].includes(ctx.user.role)) {
        return {
          success: false,
          error: 'Only administrators can configure webhooks',
        };
      }

      // Port logic from telnyx-configure-webhook edge function
      // Configure webhook in Telnyx API

      // Placeholder - implement based on edge function source
      return {
        success: true,
        webhookUrl: `${process.env.API_URL}/webhooks/telnyx`,
      };
    }),

  /**
   * Verify a public URL is accessible
   * Equivalent to: verify-public-asset edge function
   *
   * Checks if a URL is publicly accessible (for opt-in images).
   * Used to verify Telnyx toll-free verification images are reachable.
   */
  verifyPublicAsset: publicProcedure
    .input(
      z.object({
        url: z.string().url(),
      }),
    )
    .output(
      z.object({
        accessible: z.boolean(),
        status: z.number().nullable(),
        contentType: z.string().nullable(),
        contentLength: z.number().nullable(),
        isImage: z.boolean(),
        error: z.string().nullable(),
      }),
    )
    .mutation(async ({ input }) => {
      try {
        const response = await fetch(input.url, { method: 'HEAD' });
        const contentType = response.headers.get('content-type') || '';
        const contentLength = parseInt(response.headers.get('content-length') || '0', 10);

        return {
          accessible: response.ok,
          status: response.status,
          contentType,
          contentLength,
          isImage: contentType.startsWith('image/'),
          error: null,
        };
      } catch (err) {
        return {
          accessible: false,
          status: null,
          contentType: null,
          contentLength: null,
          isImage: false,
          error: err instanceof Error ? err.message : 'Failed to verify URL',
        };
      }
    }),
});
```

Register in backend/src/trpc/router.ts:

- Add import: `import { telnyxRouter } from '../routers/telnyx.router.js'`
- Add to appRouter: `telnyx: telnyxRouter,`
  </action>
  <verify>
- `ls backend/src/routers/telnyx.router.ts` exists
- `grep "telnyx:" backend/src/trpc/router.ts` shows router registered
- `npm run build --prefix backend` succeeds
  </verify>
  <done>telnyx.router.ts exists with 3 procedures, registered in appRouter</done>
  </task>

<task type="auto">
  <name>Task 2: Migrate frontend Telnyx calls to tRPC</name>
  <files>src/components/settings/TollFreeVerificationCard.tsx, src/components/settings/WebhookStatusCard.tsx, src/components/settings/OptInImageStatusCard.tsx, src/pages/UploadTelnyxImage.tsx</files>
  <action>
Migrate 4 files from edge functions to tRPC:

1. **TollFreeVerificationCard.tsx** (line ~90):
   Replace `supabase.functions.invoke("telnyx-verification-status")`

   ```typescript
   const trpc = useTRPC();
   const statusQuery = trpc.telnyx.verificationStatus.useQuery(undefined, {
     staleTime: 30000, // Cache for 30 seconds
   });
   // Use statusQuery.data, statusQuery.isLoading, statusQuery.error
   // Use statusQuery.refetch() for manual refresh
   ```

2. **WebhookStatusCard.tsx** (line ~124):
   Replace `supabase.functions.invoke("telnyx-configure-webhook", { body: { organization_id, action: 'configure' } })`

   ```typescript
   const trpc = useTRPC();
   const configureMutation = trpc.telnyx.configureWebhook.useMutation({
     onSuccess: (data) => {
       if (data.success) toast.success('Webhook configured');
       else toast.error(data.error || 'Configuration failed');
     },
     onError: (err) => toast.error(err.message),
   });
   // Use configureMutation.mutate({ organizationId })
   ```

3. **OptInImageStatusCard.tsx** (line ~46):
   Replace `supabase.functions.invoke("verify-public-asset", { body: { url } })`

   ```typescript
   const trpc = useTRPC();
   const verifyMutation = trpc.telnyx.verifyPublicAsset.useMutation({
     onSuccess: (data) => {
       if (data.accessible && data.isImage) {
         toast.success('Image is publicly accessible');
       } else {
         toast.error(data.error || 'Image not accessible');
       }
     },
   });
   // Use verifyMutation.mutate({ url })
   ```

4. **UploadTelnyxImage.tsx** (line ~38):
   Same pattern as OptInImageStatusCard - verify uploaded image URL
   ```typescript
   const trpc = useTRPC();
   const verifyMutation = trpc.telnyx.verifyPublicAsset.useMutation({...});
   // Use verifyMutation.mutate({ url: uploadedImageUrl })
   ```

Remove:

- supabase-placeholder imports from all 4 files if no longer needed
- Manual loading/error state management where React Query handles it
  </action>
  <verify>
- `grep -c "supabase.functions.invoke" src/components/settings/TollFreeVerificationCard.tsx src/components/settings/WebhookStatusCard.tsx src/components/settings/OptInImageStatusCard.tsx src/pages/UploadTelnyxImage.tsx` all return 0
- `grep "trpc.telnyx" src/components/settings/TollFreeVerificationCard.tsx` shows tRPC usage
- `npm run build` succeeds without type errors
  </verify>
  <done>All 4 Telnyx-related files use tRPC instead of edge functions</done>
  </task>

</tasks>

<verification>
Overall plan verification:
1. `grep -r "telnyx-verification-status\|telnyx-configure-webhook\|verify-public-asset" src/` returns empty (edge function names gone)
2. Backend builds: `npm run build --prefix backend`
3. Frontend builds: `npm run build`
4. No supabase.functions.invoke in any of the 4 files
</verification>

<success_criteria>

- telnyx.router.ts exists with 3 procedures (verificationStatus, configureWebhook, verifyPublicAsset)
- Router registered in appRouter
- 0 supabase.functions.invoke calls in TollFreeVerificationCard, WebhookStatusCard, OptInImageStatusCard, UploadTelnyxImage
- TypeScript builds without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/32-remaining-edge-function-migration/32-03-SUMMARY.md`
</output>
