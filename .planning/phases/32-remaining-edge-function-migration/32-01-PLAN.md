---
phase: 32-remaining-edge-function-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/EmulatorTTNRoutingCard.tsx
  - src/pages/Onboarding.tsx
autonomous: true

must_haves:
  truths:
    - "EmulatorTTNRoutingCard fetches TTN settings via tRPC not edge function"
    - "EmulatorTTNRoutingCard tests TTN connection via tRPC not edge function"
    - "Onboarding page provisions TTN via tRPC not edge function"
    - "Onboarding page polls provisioning status via tRPC not edge function"
  artifacts:
    - path: "src/components/admin/EmulatorTTNRoutingCard.tsx"
      provides: "TTN emulator routing management"
      contains: "trpc.ttnSettings"
    - path: "src/pages/Onboarding.tsx"
      provides: "Organization onboarding flow"
      contains: "trpc.ttnSettings"
  key_links:
    - from: "src/components/admin/EmulatorTTNRoutingCard.tsx"
      to: "ttnSettings.get"
      via: "useQuery"
      pattern: "ttnSettings\\.get\\.useQuery"
    - from: "src/pages/Onboarding.tsx"
      to: "ttnSettings.saveAndConfigure"
      via: "useMutation"
      pattern: "ttnSettings\\.(saveAndConfigure|getStatus)"
---

<objective>
Migrate TTN domain edge function calls to existing tRPC procedures

Purpose: Replace 4 supabase.functions.invoke calls with type-safe tRPC - backend procedures already exist from Phase 27/31
Output: EmulatorTTNRoutingCard.tsx and Onboarding.tsx using tRPC instead of edge functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-remaining-edge-function-migration/32-RESEARCH.md
@backend/src/routers/ttn-settings.router.ts
@.planning/phases/31-ttn-provisioning-ui-migration/31-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate EmulatorTTNRoutingCard to tRPC</name>
  <files>src/components/admin/EmulatorTTNRoutingCard.tsx</files>
  <action>
Replace 2 supabase.functions.invoke calls with tRPC:

1. Line ~75: Replace `supabase.functions.invoke("manage-ttn-settings", { body: { action: "get", organization_id } })`
   - Use: `trpc.ttnSettings.get.useQuery({ organizationId }, { enabled: !!organizationId })`
   - Map response to existing state structure

2. Line ~109: Replace `supabase.functions.invoke("manage-ttn-settings", { body: { action: "test", organization_id } })`
   - Use: `trpc.ttnSettings.test.useMutation({ onSuccess, onError })`
   - Call with organizationId, handle result.success/result.error

Pattern from Phase 31:
```typescript
import { useTRPC } from '@/lib/trpc';

const trpc = useTRPC();
const settingsQuery = trpc.ttnSettings.get.useQuery(
  { organizationId },
  { enabled: !!organizationId }
);
const testMutation = trpc.ttnSettings.test.useMutation({
  onSuccess: (result) => {
    if (result.success) toast.success("Connection verified");
    else toast.error(result.error || "Test failed");
  },
  onError: (err) => toast.error(err.message),
});
```

Remove:
- supabase-placeholder import if no longer needed
- Manual loading/error state management (use query.isLoading, mutation.isPending)
  </action>
  <verify>
- `grep -c "supabase.functions.invoke" src/components/admin/EmulatorTTNRoutingCard.tsx` returns 0
- `grep "ttnSettings.get" src/components/admin/EmulatorTTNRoutingCard.tsx` shows tRPC usage
- `npm run build` succeeds without type errors
  </verify>
  <done>EmulatorTTNRoutingCard uses tRPC for get and test operations, no edge function calls remain</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Onboarding TTN provisioning to tRPC</name>
  <files>src/pages/Onboarding.tsx</files>
  <action>
Replace 2 supabase.functions.invoke calls with tRPC:

1. Line ~203: Replace `supabase.functions.invoke("ttn-provision-org", { body: { action: "provision", ... } })`
   - Use: `trpc.ttnSettings.saveAndConfigure.useMutation()`
   - The saveAndConfigure procedure handles initial provisioning
   - Pass: { organizationId, apiKey, applicationId, cluster }

2. Line ~230: Replace `supabase.functions.invoke("ttn-provision-org", { body: { action: "status" } })`
   - Use: `trpc.ttnSettings.getStatus.useQuery({ organizationId }, { enabled: false })`
   - Use refetch() for polling pattern (like Phase 31 TTNCredentialsPanel)
   - Or use refetchInterval for automatic polling during provisioning

Status polling pattern:
```typescript
const statusQuery = trpc.ttnSettings.getStatus.useQuery(
  { organizationId },
  {
    enabled: false,
    // OR for auto-polling: refetchInterval: isProvisioning ? 2000 : false
  }
);

// Manual check
const checkStatus = async () => {
  const result = await statusQuery.refetch();
  if (result.data?.provisioning_status === 'ready') {
    // Provisioning complete
  }
};
```

Remove:
- supabase-placeholder import
- Manual fetch/axios calls for provisioning
  </action>
  <verify>
- `grep -c "supabase.functions.invoke" src/pages/Onboarding.tsx` returns 0
- `grep "ttnSettings" src/pages/Onboarding.tsx` shows tRPC usage
- `npm run build` succeeds without type errors
  </verify>
  <done>Onboarding page uses tRPC for TTN provisioning and status polling, no edge function calls remain</done>
</task>

</tasks>

<verification>
Overall plan verification:
1. `grep -r "supabase.functions.invoke" src/components/admin/EmulatorTTNRoutingCard.tsx src/pages/Onboarding.tsx` returns empty
2. `npm run build` completes successfully
3. Both files import and use `useTRPC` hook
</verification>

<success_criteria>
- 0 supabase.functions.invoke calls in EmulatorTTNRoutingCard.tsx (was 2)
- 0 supabase.functions.invoke calls in Onboarding.tsx (was 2)
- TypeScript builds without errors
- Components render without runtime errors (existing query/mutation patterns)
</success_criteria>

<output>
After completion, create `.planning/phases/32-remaining-edge-function-migration/32-01-SUMMARY.md`
</output>
