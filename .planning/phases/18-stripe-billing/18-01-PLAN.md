---
phase: 18-stripe-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/billing.ts
  - backend/src/db/schema/index.ts
  - backend/src/jobs/index.ts
  - backend/drizzle/migrations/XXXX_add_stripe_events_table.sql
autonomous: true

must_haves:
  truths:
    - "Webhook events are deduplicated (processing same event twice returns early)"
    - "Meter reporting jobs can be queued with proper types"
  artifacts:
    - path: "backend/src/db/schema/billing.ts"
      provides: "stripeEvents table definition"
      contains: "export const stripeEvents"
    - path: "backend/src/jobs/index.ts"
      provides: "MeterReportJobData and METER_REPORTING queue"
      contains: "METER_REPORTING"
  key_links:
    - from: "backend/src/db/schema/billing.ts"
      to: "backend/src/db/schema/index.ts"
      via: "re-export from index"
      pattern: "export.*from.*billing"
---

<objective>
Create foundation infrastructure for Stripe billing metering: idempotency table and job queue types.

Purpose: Stripe webhooks can retry for 3 days, so we need idempotency to prevent duplicate processing. Meter events need background job types for batched reporting.

Output: stripeEvents schema, migration, and MeterReportJobData types ready for use by subsequent plans.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-stripe-billing/18-RESEARCH.md

# Existing patterns to follow
@backend/src/db/schema/tenancy.ts
@backend/src/jobs/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stripeEvents table schema and migration</name>
  <files>
    backend/src/db/schema/billing.ts
    backend/src/db/schema/index.ts
  </files>
  <action>
Create new `backend/src/db/schema/billing.ts` file with stripeEvents table:

```typescript
import { pgTable, uuid, varchar, timestamp, uniqueIndex } from 'drizzle-orm/pg-core';

// Stripe Events - idempotency tracking for webhook processing
// Stripe retries failed webhooks for up to 3 days with exponential backoff
export const stripeEvents = pgTable(
  'stripe_events',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    eventId: varchar('event_id', { length: 256 }).notNull(),
    eventType: varchar('event_type', { length: 256 }).notNull(),
    processedAt: timestamp('processed_at', {
      mode: 'date',
      precision: 3,
      withTimezone: true,
    }).defaultNow().notNull(),
  },
  (table) => [
    uniqueIndex('stripe_events_event_id_idx').on(table.eventId),
  ]
);

export type StripeEvent = typeof stripeEvents.$inferSelect;
export type InsertStripeEvent = typeof stripeEvents.$inferInsert;
```

Then update `backend/src/db/schema/index.ts` to add:
```typescript
export * from './billing.js';
```

Generate migration with `cd backend && pnpm drizzle-kit generate` - name it descriptively when prompted (e.g., "add_stripe_events_table").
  </action>
  <verify>
Run `cd backend && pnpm drizzle-kit generate` succeeds.
Check that `backend/drizzle/migrations/` contains new migration file with CREATE TABLE stripe_events.
Run `pnpm tsc --noEmit` from backend directory passes.
  </verify>
  <done>
stripeEvents table schema exists with eventId unique constraint.
Migration file generated.
Type exports available from schema/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add meter reporting job types to jobs registry</name>
  <files>backend/src/jobs/index.ts</files>
  <action>
Update `backend/src/jobs/index.ts` to add meter reporting job infrastructure:

1. Add MeterReportJobData interface (after EmailDigestJobData):
```typescript
// Meter reporting job data (Phase 18)
export interface MeterReportJobData extends BaseJobData {
  /** Event name: 'active_sensors' for gauge, 'temperature_readings' for counter */
  eventName: 'active_sensors' | 'temperature_readings';
  /** Usage value to report (whole number) */
  value: number;
  /** Optional timestamp for historical reporting (unix seconds) */
  timestamp?: number;
}
```

2. Add METER_REPORTING to QueueNames:
```typescript
export const QueueNames = {
  SMS_NOTIFICATIONS: 'sms-notifications',
  EMAIL_DIGESTS: 'email-digests',
  METER_REPORTING: 'meter-reporting',
} as const;
```

3. Add METER_REPORT to JobNames:
```typescript
export const JobNames = {
  SMS_SEND: 'sms:send',
  EMAIL_DIGEST: 'email:digest',
  METER_REPORT: 'meter:report',
} as const;
```

4. Add type helper:
```typescript
export type MeterReportJob = Job<MeterReportJobData>;
```

5. Add job options (after emailDigestJobOptions):
```typescript
/**
 * Meter reporting job options
 *
 * Configuration:
 * - 5 attempts for reliability (Stripe meter events are idempotent)
 * - 5s initial delay with exponential backoff
 * - Longer retention for billing debugging
 */
export const meterReportJobOptions: JobsOptions = {
  attempts: 5,
  backoff: {
    type: 'exponential',
    delay: 5000, // 5s initial
  },
  removeOnComplete: 200,
  removeOnFail: 1000,
};
```
  </action>
  <verify>
Run `cd backend && pnpm tsc --noEmit` passes.
Verify QueueNames.METER_REPORTING, JobNames.METER_REPORT, and MeterReportJobData are exported.
  </verify>
  <done>
MeterReportJobData interface exists with eventName, value, timestamp fields.
METER_REPORTING queue and METER_REPORT job name constants exist.
meterReportJobOptions configured with 5 attempts and 5s backoff.
  </done>
</task>

</tasks>

<verification>
- [ ] `backend/src/db/schema/billing.ts` exists with stripeEvents table
- [ ] stripeEvents has unique index on eventId
- [ ] Migration file generated in `backend/drizzle/migrations/`
- [ ] `backend/src/jobs/index.ts` exports MeterReportJobData
- [ ] QueueNames.METER_REPORTING and JobNames.METER_REPORT constants exist
- [ ] `pnpm tsc --noEmit` passes in backend directory
</verification>

<success_criteria>
1. stripeEvents table schema defined with eventId, eventType, processedAt
2. Unique index on eventId for fast idempotency lookups
3. Migration generated (not yet applied - that happens in deployment)
4. MeterReportJobData type ready for meter reporting service
5. Queue and job name constants ready for queue service integration
</success_criteria>

<output>
After completion, create `.planning/phases/18-stripe-billing/18-01-SUMMARY.md`
</output>
