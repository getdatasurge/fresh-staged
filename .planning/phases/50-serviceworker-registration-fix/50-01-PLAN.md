---
phase: 50-serviceworker-registration-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/vite-env.d.ts
  - src/components/ServiceWorkerRegistration.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - 'No uncaught promise rejection from ServiceWorker registration in browser console'
    - 'ServiceWorker registration succeeds (valid SSL) or fails silently with console.info log'
    - 'App loads and functions identically with or without ServiceWorker'
    - 'PWA install prompt still works when SSL is valid (future domain setup)'
    - 'pnpm run build succeeds'
  artifacts:
    - path: 'vite.config.ts'
      provides: 'VitePWA config with injectRegister: false'
      contains: 'injectRegister: false'
    - path: 'src/vite-env.d.ts'
      provides: 'TypeScript type declarations for PWA virtual module'
      contains: 'vite-plugin-pwa/client'
    - path: 'src/components/ServiceWorkerRegistration.tsx'
      provides: 'React component with useRegisterSW hook and error handling'
      contains: 'onRegisterError'
    - path: 'src/App.tsx'
      provides: 'App root rendering ServiceWorkerRegistration component'
      contains: 'ServiceWorkerRegistration'
  key_links:
    - from: 'src/components/ServiceWorkerRegistration.tsx'
      to: 'virtual:pwa-register/react'
      via: 'import useRegisterSW hook'
      pattern: 'import.*useRegisterSW.*from.*virtual:pwa-register/react'
    - from: 'src/App.tsx'
      to: 'src/components/ServiceWorkerRegistration.tsx'
      via: 'import and render component'
      pattern: 'import.*ServiceWorkerRegistration'
    - from: 'vite.config.ts'
      to: 'build output'
      via: 'injectRegister: false prevents auto-generated registerSW.js script'
      pattern: "injectRegister:\\s*false"
---

<objective>
Gracefully handle ServiceWorker registration failure on self-signed SSL certs by switching from vite-plugin-pwa's auto-injected registration script (which has no error handling) to the plugin's React virtual module hook with onRegisterError callback.

Purpose: Eliminate uncaught promise rejection in browser console when SW registration fails on self-signed SSL (current deployment at 192.168.4.181 via Caddy). The app must work identically with or without ServiceWorker.

Output: 4 files modified/created, build passes, no runtime errors from SW registration.

NOTE: The research phase already applied the code changes to the working tree (uncommitted). This plan verifies the changes are correct and commits them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-serviceworker-registration-fix/50-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and complete ServiceWorker registration fix</name>
  <files>
    vite.config.ts
    src/vite-env.d.ts
    src/components/ServiceWorkerRegistration.tsx
    src/App.tsx
  </files>
  <action>
The research phase already applied code changes to the working tree. Verify each change is correct per the research findings:

1. **vite.config.ts** -- Verify `injectRegister: false` is present inside the VitePWA config object, after `registerType: "autoUpdate"`. This disables the auto-generated `registerSW.js` script that had no `.catch()` handler. Keep `registerType: "autoUpdate"` unchanged (it controls update strategy, NOT registration method).

2. **src/vite-env.d.ts** -- Verify it contains both:

   ```
   /// <reference types="vite/client" />
   /// <reference types="vite-plugin-pwa/client" />
   ```

   The second reference enables TypeScript to recognize `virtual:pwa-register/react`.

3. **src/components/ServiceWorkerRegistration.tsx** -- Verify this NEW file exists with:
   - Import: `useRegisterSW` from `'virtual:pwa-register/react'`
   - `onRegisteredSW` callback logging success via `console.info`
   - `onRegisterError` callback logging failure via `console.info` (NOT console.error -- this is graceful degradation, not an error)
   - Returns `null` (pure side-effect component, renders nothing)
   - Named export `ServiceWorkerRegistration`

4. **src/App.tsx** -- Verify:
   - Import of `ServiceWorkerRegistration` from `'@/components/ServiceWorkerRegistration'`
   - `<ServiceWorkerRegistration />` rendered inside the `<Suspense>` boundary but before/outside providers (it has no provider dependencies)

If any change is missing or incorrect, apply it per the research at `.planning/phases/50-serviceworker-registration-fix/50-RESEARCH.md`.

Do NOT:

- Change `registerType` (must stay `"autoUpdate"`)
- Use `selfDestroying: true` (we want SW to work when SSL is valid)
- Add try/catch in vite.config.ts (config runs at build time, not runtime)
- Use `console.error` for the registration failure (it is expected on self-signed SSL)
  </action>
  <verify>
  Run these checks in sequence:

1. `pnpm exec tsc --noEmit` -- zero TypeScript errors
2. `pnpm run build` -- succeeds, produces dist/sw.js
3. Verify no `registerSW.js` script tag in built HTML:
   `grep -c 'registerSW' dist/index.html` -- should return 0 (no auto-injected script)
4. Verify the virtual module is bundled into the main JS:
   `grep -c 'Registration unavailable' dist/assets/index-*.js` -- should return 1 (the console.info message from onRegisterError is in the bundle)
   </verify>
   <done>

- TypeScript compiles with zero errors
- Build succeeds
- dist/index.html has NO registerSW.js script tag (auto-injection disabled)
- The onRegisterError handler is present in the built JS bundle
- ServiceWorkerRegistration component is rendered in App.tsx component tree
  </done>
  </task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` passes with zero errors
2. `pnpm run build` succeeds
3. `grep -c 'registerSW' dist/index.html` returns 0
4. `grep -c 'Registration unavailable' dist/assets/index-*.js` returns 1
5. SW-01: ServiceWorker registration failure does not produce uncaught promise rejection (onRegisterError catches it)
6. SW-02: App functions normally when ServiceWorker registration is unavailable (component returns null, no UI impact)
</verification>

<success_criteria>

- No uncaught promise rejection from ServiceWorker registration
- ServiceWorker registration either succeeds (valid SSL) or fails silently with info log
- App loads and functions identically with or without ServiceWorker
- PWA install prompt still works when SSL is valid (future domain setup)
- pnpm run build succeeds
  </success_criteria>

<output>
After completion, create `.planning/phases/50-serviceworker-registration-fix/50-01-SUMMARY.md`
</output>
