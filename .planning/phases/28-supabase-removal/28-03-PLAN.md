---
phase: 28
plan: 03
wave: 3
gap_closure: false
---

# Plan 28-03: Alert Rules Migration

## Goal
Migrate `useAlertRulesHistory.ts` to use tRPC.

## Requirements
- Create `backend/src/routers/alert-history.router.ts`.
- Procedure `getHistory` taking scope (org, site, unit) and limit.
- Should join user profiles in backend (Drizzle relation or manual join) to return `user_email`, `user_name` properly.

## Tasks

<task>
<name>Create Alert History Service/Router</name>
<description>
Create `backend/src/routers/alert-history.router.ts`.
Query `alert_rules_history` using Drizzle.
Fetch profiles for `changed_by`.
</description>
<file>backend/src/routers/alert-history.router.ts</file>
<verify>
grep "alertHistoryRouter" backend/src/routers/alert-history.router.ts
</verify>
</task>

<task>
<name>Update useAlertRulesHistory</name>
<description>
Replace `supabase.from(...).select` with `trpc.alertHistory.get.useQuery`.
</description>
<file>src/hooks/useAlertRulesHistory.ts</file>
<verify>
grep "trpc.alertHistory" src/hooks/useAlertRulesHistory.ts
! grep "supabase.from" src/hooks/useAlertRulesHistory.ts
</verify>
</task>
