---
phase: 28
plan: 02
wave: 2
gap_closure: false
---

# Plan 28-02: Site Compliance Migration

## Goal

Migrate `SiteComplianceSettings.tsx` to use tRPC for updates.

## Requirements

- Update `sites.router.ts` to include `updateComplianceSettings` (or ensuring generic `update` covers it).
- Updates fields: `timezone`, `compliance_mode`, `manual_log_cadence_seconds`, `corrective_action_required`.

## Tasks

<task>
<name>Verify Sites Router</name>
<description>
Check `backend/src/routers/sites.router.ts`. Ensure it has an update procedure that accepts compliance fields.
If missing, add it.
</description>
<file>backend/src/routers/sites.router.ts</file>
<verify>
grep "timezone" backend/src/routers/sites.router.ts
</verify>
</task>

<task>
<name>Update SiteComplianceSettings</name>
<description>
Replace `supabase.from("sites").update(...)` with `trpc.sites.update.mutateAsync(...)`.
Replace `supabase.from("event_logs").insert(...)` with the new Audit/Event logging mechanism (or let the backend handle it?).
Better: Move the event logging into the `sites.update` procedure in the backend!
</description>
<file>src/components/site/SiteComplianceSettings.tsx</file>
<verify>
grep "trpc.sites" src/components/site/SiteComplianceSettings.tsx
! grep "supabase.from" src/components/site/SiteComplianceSettings.tsx
</verify>
</task>
