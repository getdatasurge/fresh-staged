---
phase: 28
plan: 01
wave: 1
gap_closure: false
---

# Plan 28-01: Audit Service Migration

## Goal

Migrate `useAuditedWrite` and `eventLogger.ts` to use a backend `AuditService` via tRPC, removing strict dependency on Supabase RPC `log_impersonated_action`.

## Requirements

- Create `backend/src/services/AuditService.ts`.
- Create `backend/src/routers/audit.ts` (or add to `events`).
- Update `src/hooks/useAuditedWrite.ts` to use tRPC.
- Update `src/lib/eventLogger.ts` to use tRPC.

## Tasks

<task>
<name>Create Audit Service</name>
<description>
Implement `AuditService` in the backend to write to `event_logs` table.
It should handle `logImpersonatedAction` and generic `logEvent`.
</description>
<file>backend/src/services/AuditService.ts</file>
<verify>
grep "logImpersonatedAction" backend/src/services/AuditService.ts
</verify>
</task>

<task>
<name>Create Audit Router</name>
<description>
Create `backend/src/routers/audit.ts`.
Expose `logEvent` mutation.
</description>
<file>backend/src/routers/audit.ts</file>
<verify>
grep "auditRouter" backend/src/routers/audit.ts
</verify>
</task>

<task>
<name>Update useAuditedWrite</name>
<description>
Update the hook to call `trpc.audit.logEvent.mutateAsync` instead of `supabase.rpc`.
</description>
<file>src/hooks/useAuditedWrite.ts</file>
<verify>
grep "trpc.audit" src/hooks/useAuditedWrite.ts
! grep "supabase.rpc" src/hooks/useAuditedWrite.ts
</verify>
</task>

<task>
<name>Update eventLogger</name>
<description>
Update `src/lib/eventLogger.ts` to use tRPC client (vanilla client) instead of Supabase client.
</description>
<file>src/lib/eventLogger.ts</file>
<verify>
grep "trpc" src/lib/eventLogger.ts
! grep "supabase" src/lib/eventLogger.ts
</verify>
</task>
