---
phase: 06-data-migration-scripts
plan: 06
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified:
  - scripts/migration/README.md
autonomous: true

must_haves:
  truths:
    - "Migration runbook documents complete process"
    - "Environment setup instructions are clear"
    - "Rollback procedure documented"
    - "Password reset requirement communicated"
  artifacts:
    - path: "scripts/migration/README.md"
      provides: "Complete migration runbook"
      contains: "## Migration Runbook"
  key_links:
    - from: "scripts/migration/README.md"
      to: "export.ts, import.ts, verify.ts"
      via: "command documentation"
      pattern: "pnpm exec tsx"
---

<objective>
Create migration runbook documenting the complete data migration process.

Purpose: Provide step-by-step instructions for running the migration scripts during the production cutover. This is the operational documentation that ensures a smooth migration.

Output:
- scripts/migration/README.md - Complete runbook with all procedures
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-migration-scripts/06-CONTEXT.md
@.planning/phases/06-data-migration-scripts/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration runbook</name>
  <files>
    scripts/migration/README.md
  </files>
  <action>
Create README.md with comprehensive migration documentation:

```markdown
# FreshTrack Pro Data Migration

Scripts to migrate data from Supabase to self-hosted PostgreSQL.

## Overview

**Strategy:** Freeze+Backfill (8+ hour maintenance window)
**Data Volume:** <1GB total (estimated)
**User ID Mapping:** Retained 90 days for customer support

## Prerequisites

1. New PostgreSQL database running and accessible
2. All database tables created (Phase 1 complete)
3. Stack Auth project configured
4. Supabase direct PostgreSQL connection string
5. Sufficient disk space for JSON exports (~2GB recommended)

## Environment Setup

Copy `.env.example` to `.env` and configure:

```bash
# Supabase (source)
SUPABASE_DB_URL=postgresql://postgres:[password]@db.xxxxx.supabase.co:5432/postgres

# New database (target)
DATABASE_URL=postgresql://postgres:[password]@localhost:5432/freshtrack

# Stack Auth
STACK_AUTH_PROJECT_ID=your-project-id
STACK_AUTH_SECRET_KEY=your-secret-key

# Logging
LOG_FILE_PATH=./migration.log
```

## Migration Steps

### Step 1: Pre-Migration Checks

```bash
# Install dependencies
cd scripts/migration
pnpm install

# Test database connections
pnpm exec tsx test-connections.ts

# Verify target database is empty (or acceptable to truncate)
pnpm exec tsx verify.ts --skip-checksum
```

### Step 2: Export Data from Supabase

```bash
# List tables to export
pnpm exec tsx export.ts --dry-run

# Full export (takes ~10-30 minutes depending on data volume)
pnpm exec tsx export.ts

# Verify export files
ls -la migration-data/
cat migration-data/metadata.json
```

Output: `migration-data/*.json` files + `metadata.json`

### Step 3: Migrate Users to Stack Auth

**IMPORTANT: Users will need to reset their passwords after migration.**

```bash
# Preview user migration
pnpm exec tsx migrate-users.ts --dry-run

# Create users in Stack Auth
pnpm exec tsx migrate-users.ts

# Verify mapping file created
cat migration-data/user-mapping.json | head -50
```

Output: `migration-data/user-mapping.json`

### Step 4: Import Data to New Database

```bash
# Preview import
pnpm exec tsx import.ts --dry-run

# Full import (takes ~10-30 minutes)
# Option A: Import with FK checks disabled (faster)
pnpm exec tsx import.ts --disable-fk

# Option B: Import with FK checks enabled (safer)
pnpm exec tsx import.ts
```

If import fails partway through:
```bash
# Clear all data and restart
pnpm exec tsx import.ts --truncate-first --yes
```

### Step 5: Verify Migration

```bash
# Full verification with checksums
pnpm exec tsx verify.ts

# Quick verification (row counts only)
pnpm exec tsx verify.ts --skip-checksum

# Check report
cat migration-data/verification-report.json
```

All tables must show `"status": "pass"` or `"status": "warn"` (warn = checksum couldn't be computed but row counts match).

### Step 6: Post-Migration Tasks

1. **Send password reset emails** to all users
   - Stack Auth does not import passwords from Supabase
   - Users must set new passwords via reset flow

2. **Update DNS/configuration** to point to new system

3. **Monitor for errors** in new system logs

4. **Keep Supabase running** for 24-48 hours as rollback option

## Rollback Procedure

If issues are discovered after migration:

1. **Do NOT delete Supabase data** - it remains untouched
2. Revert DNS/configuration to point back to Supabase
3. Investigate and fix issues in new system
4. Re-run migration when ready

## Troubleshooting

### Connection Refused

- Check SUPABASE_DB_URL format (must use port 5432, not 6543 for direct connection)
- Verify Supabase allows direct database connections (check project settings)
- Check firewall rules on target database

### Foreign Key Violations

- Use `--disable-fk` flag during import
- Or ensure tables are imported in correct dependency order (should be automatic)

### User Mapping Errors

- Verify Stack Auth users were created successfully
- Check `user-mapping.json` has entries for all Supabase users
- Run `map-users.ts` if mapping needs to be regenerated

### Checksum Mismatch

- Expected for tables with user ID columns (IDs are different)
- For other tables, indicates data corruption - investigate before proceeding
- Check for timezone issues with timestamps

## Files Reference

| File | Purpose |
|------|---------|
| `export.ts` | Export all tables from Supabase to JSON |
| `import.ts` | Import JSON files to new database |
| `verify.ts` | Compare source and target databases |
| `migrate-users.ts` | Create users in Stack Auth |
| `map-users.ts` | Generate user ID mapping from existing users |
| `test-connections.ts` | Verify database connectivity |
| `lib/logger.ts` | Shared logging configuration |
| `lib/supabase-client.ts` | Supabase connection pool |
| `lib/new-db-client.ts` | New database connection pool |
| `lib/table-metadata.ts` | Table dependency order |
| `lib/user-mapping.ts` | User ID mapping utilities |
| `lib/checksum.ts` | Data verification utilities |
| `lib/stream-helpers.ts` | Streaming export utilities |
| `lib/import-helpers.ts` | Import utilities |

## User ID Mapping Retention

The `user-mapping.json` file maps Supabase UUIDs to Stack Auth UUIDs:

```json
{
  "generatedAt": "2026-01-23T...",
  "retainUntil": "2026-04-23T...",
  "mappings": [
    {
      "supabaseUserId": "abc-123",
      "stackAuthUserId": "xyz-789",
      "email": "user@example.com",
      "migratedAt": "2026-01-23T..."
    }
  ]
}
```

**Retain this file for 90 days** after migration for customer support scenarios where old IDs are referenced.

---

*Migration scripts version: 1.0*
*Created: 2026-01-23*
```
  </action>
  <verify>
Read the README.md and verify all scripts are documented, all CLI options mentioned, and rollback procedure is clear.
  </verify>
  <done>
Migration runbook is complete with all steps, troubleshooting, and rollback procedure documented.
  </done>
</task>

</tasks>

<verification>
1. README.md exists in scripts/migration/
2. All scripts documented with CLI options
3. Environment setup instructions are clear
4. Step-by-step migration procedure complete
5. Rollback procedure documented
6. Password reset requirement clearly communicated
7. User ID mapping retention (90 days) documented
</verification>

<success_criteria>
- Runbook is comprehensive enough for someone unfamiliar with the codebase to execute migration
- All scripts referenced with correct CLI options
- Troubleshooting section covers common issues
- Rollback procedure is clear and actionable
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-migration-scripts/06-06-SUMMARY.md`
</output>
