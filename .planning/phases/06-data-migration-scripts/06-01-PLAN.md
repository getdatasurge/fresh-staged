---
phase: 06-data-migration-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migration/lib/logger.ts
  - scripts/migration/lib/supabase-client.ts
  - scripts/migration/lib/new-db-client.ts
  - scripts/migration/lib/table-metadata.ts
  - scripts/migration/package.json
  - scripts/migration/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Migration scripts can connect to Supabase PostgreSQL"
    - "Migration scripts can connect to new self-hosted PostgreSQL"
    - "Logger writes to both console and log file"
  artifacts:
    - path: "scripts/migration/lib/logger.ts"
      provides: "Pino logger with console and file transports"
      exports: ["logger"]
    - path: "scripts/migration/lib/supabase-client.ts"
      provides: "PostgreSQL pool connection to Supabase"
      exports: ["supabasePool", "getSupabaseClient"]
    - path: "scripts/migration/lib/new-db-client.ts"
      provides: "PostgreSQL pool connection to new database"
      exports: ["newDbPool", "getNewDbClient"]
    - path: "scripts/migration/lib/table-metadata.ts"
      provides: "Table dependency order and schema info"
      exports: ["TABLE_IMPORT_ORDER", "TABLES_WITH_USER_IDS"]
  key_links:
    - from: "scripts/migration/lib/supabase-client.ts"
      to: "SUPABASE_DB_URL"
      via: "environment variable"
      pattern: "process\\.env\\.SUPABASE_DB_URL"
    - from: "scripts/migration/lib/new-db-client.ts"
      to: "DATABASE_URL"
      via: "environment variable"
      pattern: "process\\.env\\.DATABASE_URL"
---

<objective>
Create migration script infrastructure with database clients, logging, and table metadata.

Purpose: Foundation for all migration scripts - enables connecting to both Supabase and new PostgreSQL databases, provides consistent logging, and defines table dependency order for import.

Output:
- scripts/migration/ directory with TypeScript project
- Reusable database connection pools
- Pino logger with console + file output
- Table metadata with import order and user ID column identification
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-migration-scripts/06-CONTEXT.md
@.planning/phases/06-data-migration-scripts/06-RESEARCH.md
@docs/SUPABASE_SCHEMA_INVENTORY.md
@docs/DATABASE_MIGRATION_PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration script TypeScript project</name>
  <files>
    scripts/migration/package.json
    scripts/migration/tsconfig.json
    scripts/migration/.env.example
  </files>
  <action>
Create scripts/migration/ directory with TypeScript project:

1. Create package.json:
   - Name: "freshtrack-migration"
   - Type: "module" (ESM)
   - Scripts: "export", "import", "verify", "map-users"
   - Dependencies: pg, pg-query-stream, pino, pino-pretty, zod, commander, ora
   - DevDependencies: @types/pg, @types/node, typescript, tsx

2. Create tsconfig.json:
   - Target: ES2022
   - Module: NodeNext
   - ModuleResolution: NodeNext
   - Strict: true
   - outDir: dist

3. Create .env.example with required variables:
   - SUPABASE_DB_URL (direct PostgreSQL connection to Supabase)
   - DATABASE_URL (new self-hosted PostgreSQL)
   - STACK_AUTH_PROJECT_ID
   - STACK_AUTH_SECRET_KEY
   - LOG_FILE_PATH (default: ./migration.log)

Note: Use SSL with rejectUnauthorized: false for Supabase connection (self-signed certs).
  </action>
  <verify>
cd scripts/migration && pnpm install && pnpm exec tsc --noEmit
  </verify>
  <done>
Migration project initializes without TypeScript errors and dependencies install successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create logger and database clients</name>
  <files>
    scripts/migration/lib/logger.ts
    scripts/migration/lib/supabase-client.ts
    scripts/migration/lib/new-db-client.ts
  </files>
  <action>
Create shared library modules:

1. logger.ts:
   - Use Pino with pino-pretty for console output
   - Write to both console and file (LOG_FILE_PATH env var, default ./migration.log)
   - Include timestamp, level, and message in all outputs
   - Export logger instance

2. supabase-client.ts:
   - Create Pool from pg using SUPABASE_DB_URL
   - SSL config: { rejectUnauthorized: false } for Supabase hosted certs
   - Export getSupabaseClient() that returns connected client
   - Export supabasePool for direct access
   - Add connection test function

3. new-db-client.ts:
   - Create Pool from pg using DATABASE_URL
   - Export getNewDbClient() that returns connected client
   - Export newDbPool for direct access
   - Add connection test function

Both clients should:
- Log connection attempts and success/failure
- Handle connection errors gracefully with clear error messages
- Support connection pooling (max 10 connections)
  </action>
  <verify>
Create test-connections.ts that imports both clients, connects to each, and logs success. Run with: pnpm exec tsx test-connections.ts
  </verify>
  <done>
Both database clients can connect successfully. Logger writes to console and log file.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create table metadata with dependency order</name>
  <files>
    scripts/migration/lib/table-metadata.ts
  </files>
  <action>
Create table-metadata.ts defining migration order and schema info:

1. Define TABLE_IMPORT_ORDER array (respects foreign key dependencies):
   ```typescript
   export const TABLE_IMPORT_ORDER = [
     // Level 0: No dependencies
     'organizations',

     // Level 1: Depends on organizations
     'subscriptions',
     'profiles',
     'sites',
     'ttn_connections',

     // Level 2: Depends on Level 1
     'user_roles',        // profiles, organizations
     'escalation_contacts', // profiles, organizations
     'areas',             // sites
     'hubs',              // sites
     'alert_rules',       // organizations, sites (nullable unit_id)

     // Level 3: Depends on Level 2
     'units',             // areas
     'devices',           // hubs (nullable unit_id)

     // Level 4: Depends on Level 3
     'lora_sensors',      // devices
     'calibration_records', // devices
     'sensor_readings',   // units, devices
     'manual_temperature_logs', // units, profiles
     'door_events',       // units

     // Level 5: Depends on units
     'alerts',            // units
     'alert_rules_history', // alert_rules

     // Level 6: Depends on alerts
     'corrective_actions', // alerts, units, profiles
     'notification_deliveries', // alerts, profiles

     // Level 7: Standalone (no FK dependencies but last for completeness)
     'event_logs',        // organizations (audit trail - import last)
     'pairing_sessions',  // devices (temporary data)
   ] as const;
   ```

2. Define TABLES_WITH_USER_IDS map identifying columns that need user ID mapping:
   ```typescript
   export const TABLES_WITH_USER_IDS: Record<string, string[]> = {
     profiles: ['user_id'],
     user_roles: ['user_id'],
     escalation_contacts: ['profile_id'],
     manual_temperature_logs: ['profile_id'],
     corrective_actions: ['profile_id'],
     notification_deliveries: ['profile_id'],
     event_logs: ['actor_id'],  // If this references users
   };
   ```

3. Export helper functions:
   - getTableImportOrder(): Returns full ordered list
   - requiresUserMapping(tableName): Returns true if table has user ID columns
   - getUserIdColumns(tableName): Returns array of column names needing mapping
  </action>
  <verify>
Import table-metadata.ts and log TABLE_IMPORT_ORDER length and TABLES_WITH_USER_IDS keys.
  </verify>
  <done>
Table metadata exports correctly with 20+ tables in dependency order and user ID column mappings for 6+ tables.
  </done>
</task>

</tasks>

<verification>
1. `cd scripts/migration && pnpm install` succeeds
2. `pnpm exec tsc --noEmit` has no TypeScript errors
3. Connection test script connects to both databases (requires valid .env)
4. TABLE_IMPORT_ORDER contains all tables from Supabase schema inventory
5. TABLES_WITH_USER_IDS identifies all columns referencing user IDs
</verification>

<success_criteria>
- Migration script project compiles without errors
- Database clients can connect to Supabase and new PostgreSQL
- Logger outputs to both console and file
- Table import order respects all foreign key constraints
- User ID columns identified for post-import mapping
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-migration-scripts/06-01-SUMMARY.md`
</output>
