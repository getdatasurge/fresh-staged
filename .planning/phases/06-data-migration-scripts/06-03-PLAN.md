---
phase: 06-data-migration-scripts
plan: 03
type: execute
wave: 2
depends_on: ['06-01']
files_modified:
  - scripts/migration/lib/user-mapping.ts
  - scripts/migration/map-users.ts
  - scripts/migration/migrate-users.ts
autonomous: true

must_haves:
  truths:
    - 'Supabase auth.users can be exported'
    - 'Users can be created in Stack Auth via API'
    - 'User ID mapping persists to JSON file'
    - 'Mapping retained for 90 days (documented)'
  artifacts:
    - path: 'scripts/migration/lib/user-mapping.ts'
      provides: 'User ID mapping utilities'
      exports: ['UserMapping', 'loadMapping', 'saveMapping', 'mapUserId']
    - path: 'scripts/migration/map-users.ts'
      provides: 'Generate user ID mapping after Stack Auth users created'
      exports: ['main']
    - path: 'scripts/migration/migrate-users.ts'
      provides: 'Create users in Stack Auth from Supabase export'
      exports: ['main']
  key_links:
    - from: 'scripts/migration/migrate-users.ts'
      to: 'Stack Auth API'
      via: 'fetch POST /api/v1/users'
      pattern: "api\\.stack-auth\\.com.*users"
    - from: 'scripts/migration/lib/user-mapping.ts'
      to: 'migration-data/user-mapping.json'
      via: 'file read/write'
      pattern: "user-mapping\\.json"
---

<objective>
Create user migration scripts to move users from Supabase Auth to Stack Auth with ID mapping.

Purpose: Users need to be created in Stack Auth before data import, and a mapping file tracks old Supabase IDs to new Stack Auth IDs. This mapping is used during data import to update foreign key references.

Output:

- scripts/migration/migrate-users.ts - Create users in Stack Auth
- scripts/migration/map-users.ts - Generate mapping from exported data
- scripts/migration/lib/user-mapping.ts - Mapping utilities
- migration-data/user-mapping.json (generated at runtime)
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-migration-scripts/06-CONTEXT.md
@.planning/phases/06-data-migration-scripts/06-RESEARCH.md
@.planning/phases/06-data-migration-scripts/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user mapping utilities</name>
  <files>
    scripts/migration/lib/user-mapping.ts
  </files>
  <action>
Create user-mapping.ts with utilities for managing user ID mappings:

1. Types:

   ```typescript
   interface UserMapping {
     supabaseUserId: string; // UUID from auth.users
     stackAuthUserId: string; // UUID from Stack Auth
     email: string; // For debugging/verification
     migratedAt: string; // ISO timestamp
   }

   interface UserMappingFile {
     generatedAt: string;
     retainUntil: string; // 90 days from generation
     mappings: UserMapping[];
   }
   ```

2. Functions:
   - loadMapping(filePath): Load UserMappingFile from JSON, return Map<supabaseId, stackAuthId>
   - saveMapping(filePath, mappings: UserMapping[]): Save with metadata
   - mapUserId(mapping: Map, supabaseId: string): Return Stack Auth ID or null if not found
   - getMappingAge(filePath): Return days since generation

3. Constants:
   - MAPPING_RETENTION_DAYS = 90
   - DEFAULT_MAPPING_PATH = './migration-data/user-mapping.json'

4. Add validation:
   - Throw if mapping file is older than 90 days (warn only, don't block)
   - Log warning if any Supabase ID has no mapping during import
     </action>
     <verify>
     Unit test: Create test mapping, save to temp file, load back, verify roundtrip.
     </verify>
     <done>
     User mapping utilities can save and load mappings with proper metadata and retention tracking.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Create Stack Auth user migration script</name>
  <files>
    scripts/migration/migrate-users.ts
  </files>
  <action>
Create migrate-users.ts to create users in Stack Auth from Supabase export:

1. CLI options with commander:
   - --input (default: ./migration-data/auth_users.json)
   - --output (default: ./migration-data/user-mapping.json)
   - --dry-run (show what would be created without calling API)
   - --rate-limit (ms between API calls, default: 100)

2. Stack Auth user creation:

   ```typescript
   interface StackAuthUserCreate {
     email: string;
     emailVerified: boolean;
     displayName?: string;
   }

   async function createStackAuthUser(userData: StackAuthUserCreate): Promise<string> {
     const response = await fetch('https://api.stack-auth.com/api/v1/users', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'x-stack-access-type': 'server',
         'x-stack-project-id': process.env.STACK_AUTH_PROJECT_ID!,
         'x-stack-secret-server-key': process.env.STACK_AUTH_SECRET_KEY!,
       },
       body: JSON.stringify({
         ...userData,
         // Note: Stack Auth may not support password import
         // Users will need to reset passwords post-migration
       }),
     });

     if (!response.ok) {
       const error = await response.text();
       throw new Error(`Stack Auth user creation failed: ${response.status} ${error}`);
     }

     const user = await response.json();
     return user.id;
   }
   ```

3. Main flow:
   - Load auth_users.json (exported from Supabase)
   - For each user:
     - Create in Stack Auth via API
     - Capture new ID
     - Add to mapping array
     - Rate limit between calls (100ms default)
   - Save mapping file with 90-day retention marker
   - Log summary (created count, failed count)

4. Error handling:
   - Fail fast on API errors (migration should be reliable)
   - Log failed users with details for manual resolution
   - Handle duplicate email gracefully (user may already exist in Stack Auth)

5. Important note about passwords:
   - Supabase uses bcrypt hashes
   - Stack Auth may not accept pre-hashed passwords
   - Document that users will need password reset emails post-migration
   - Add comment in code explaining this limitation
     </action>
     <verify>
     Run `pnpm exec tsx migrate-users.ts --dry-run` with sample auth_users.json to verify parsing.
     </verify>
     <done>
     User migration script can read Supabase users and create them in Stack Auth (or simulate in dry-run). Mapping file generated with 90-day retention marker.
     </done>
     </task>

<task type="auto">
  <name>Task 3: Create mapping generation script for existing users</name>
  <files>
    scripts/migration/map-users.ts
  </files>
  <action>
Create map-users.ts for generating mapping when users already exist in Stack Auth:

This script is for cases where:

- Users were manually created in Stack Auth
- Users self-registered after migration announcement
- Need to regenerate mapping from both systems

1. CLI options:
   - --supabase-export (default: ./migration-data/auth_users.json)
   - --output (default: ./migration-data/user-mapping.json)
   - --match-by (email | metadata, default: email)

2. Main flow:
   - Load Supabase auth_users.json
   - Fetch all users from Stack Auth via API:
     ```typescript
     GET https://api.stack-auth.com/api/v1/users
     ```
   - Match by email (case-insensitive)
   - Generate mapping for matched users
   - Log unmatched Supabase users (need manual creation)
   - Log unmatched Stack Auth users (new registrations, ignore)
   - Save mapping file

3. Validation:
   - Warn if any Supabase user has no Stack Auth match
   - Provide count summary: matched, unmatched-supabase, unmatched-stackauth

This is a utility script for edge cases; primary path is migrate-users.ts creating users.
</action>
<verify>
Run `pnpm exec tsx map-users.ts --help` to verify CLI. Test with mock data if no API access.
</verify>
<done>
Mapping script can match existing users by email and generate mapping file.
</done>
</task>

</tasks>

<verification>
1. User mapping utilities roundtrip correctly (save/load)
2. migrate-users.ts parses auth_users.json format
3. Stack Auth API calls use correct headers and endpoint
4. Mapping file includes retention metadata (90 days)
5. Scripts handle API rate limiting and errors
6. Password migration limitation documented in code comments
</verification>

<success_criteria>

- migrate-users.ts can create users in Stack Auth from Supabase export
- User ID mapping saved to JSON file with retention tracking
- map-users.ts can generate mapping from existing users by email match
- All scripts have --dry-run mode for safe testing
- Password reset requirement clearly documented
  </success_criteria>

<output>
After completion, create `.planning/phases/06-data-migration-scripts/06-03-SUMMARY.md`
</output>
