---
phase: 10-database-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/blackbox/blackbox.yml
  - docker/compose.prod.yaml
  - docker/prometheus/prometheus.yml
  - docker/prometheus/alerts/ssl-certs.yml
autonomous: true

must_haves:
  truths:
    - "Blackbox Exporter probes HTTPS endpoints for SSL certificate metrics"
    - "Prometheus fires alerts 30 days before SSL certificate expiry"
  artifacts:
    - path: "docker/blackbox/blackbox.yml"
      provides: "Blackbox Exporter module configuration"
      contains: "http_2xx"
    - path: "docker/prometheus/alerts/ssl-certs.yml"
      provides: "SSL certificate expiry alert rules"
      contains: "probe_ssl_earliest_cert_expiry"
  key_links:
    - from: "docker/prometheus/prometheus.yml"
      to: "blackbox:9115"
      via: "scrape config with relabeling"
      pattern: "blackbox:9115"
    - from: "docker/prometheus/prometheus.yml"
      to: "docker/prometheus/alerts/ssl-certs.yml"
      via: "rule_files include"
      pattern: "rule_files"
---

<objective>
Configure Blackbox Exporter for SSL certificate monitoring with Prometheus alerting

Purpose: Prevent service outages from expired SSL certificates by alerting 30 days before expiry
Output: Blackbox Exporter configuration and Prometheus alert rules for certificate monitoring
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-production-readiness/10-RESEARCH.md

# Existing infrastructure
@docker/compose.prod.yaml
@docker/prometheus/prometheus.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Blackbox Exporter configuration and service</name>
  <files>
    docker/blackbox/blackbox.yml
    docker/compose.prod.yaml
  </files>
  <action>
1. **Create docker/blackbox/ directory and blackbox.yml**:

```yaml
modules:
  http_2xx:
    prober: http
    timeout: 10s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200, 201, 301, 302]
      method: GET
      follow_redirects: true
      fail_if_ssl: false
      fail_if_not_ssl: true
      tls_config:
        insecure_skip_verify: false

  http_2xx_no_ssl:
    prober: http
    timeout: 10s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200, 201, 301, 302]
      method: GET
      follow_redirects: true
      fail_if_ssl: false
      fail_if_not_ssl: false

  tcp_connect:
    prober: tcp
    timeout: 10s
```

2. **Add Blackbox Exporter service to docker/compose.prod.yaml**:

```yaml
  # Blackbox Exporter (SSL/HTTP Probing)
  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: freshtrack-blackbox
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    ports:
      - "9115:9115"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9115/metrics"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-batch-size: "400"
        loki-retries: "3"
        loki-external-labels: "service={{.Name}},environment=production"
```
  </action>
  <verify>
    ls -la docker/blackbox/
    cat docker/blackbox/blackbox.yml | grep "http_2xx"
    grep -A10 "blackbox:" docker/compose.prod.yaml
  </verify>
  <done>
    docker/blackbox/blackbox.yml exists with http_2xx module
    Blackbox Exporter service added to compose.prod.yaml
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Prometheus SSL monitoring and alerts</name>
  <files>
    docker/prometheus/prometheus.yml
    docker/prometheus/alerts/ssl-certs.yml
  </files>
  <action>
1. **Create docker/prometheus/alerts/ directory and ssl-certs.yml**:

```yaml
groups:
  - name: ssl_certificates
    rules:
      # Warning: Certificate expires in less than 30 days
      - alert: SSLCertExpiring30Days
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSL certificate expires in less than 30 days"
          description: "Certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}. Renewal recommended."

      # Critical: Certificate expires in less than 7 days
      - alert: SSLCertExpiring7Days
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 30m
        labels:
          severity: critical
        annotations:
          summary: "SSL certificate expires in less than 7 days - URGENT"
          description: "Certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}. Immediate renewal required."

      # SSL probe failed - endpoint unreachable or SSL error
      - alert: SSLProbeFailure
        expr: probe_success{job="ssl-certs"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "SSL probe failed for endpoint"
          description: "SSL probe failed for {{ $labels.instance }}. Check if endpoint is reachable and certificate is valid."
```

2. **Update docker/prometheus/prometheus.yml**:

Add rule_files section (at top level, after global):
```yaml
rule_files:
  - /etc/prometheus/alerts/*.yml
```

Add SSL certificate scrape config:
```yaml
  # SSL Certificate monitoring via Blackbox Exporter
  - job_name: 'ssl-certs'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://localhost  # Placeholder - replace with actual domain in deployment
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115

  # Blackbox Exporter self-metrics
  - job_name: 'blackbox'
    static_configs:
      - targets: ['blackbox:9115']
```

Update Prometheus command in compose.prod.yaml to mount alerts directory:
```yaml
  prometheus:
    # ... existing config ...
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts:/etc/prometheus/alerts:ro  # Add this line
```
  </action>
  <verify>
    ls -la docker/prometheus/alerts/
    cat docker/prometheus/alerts/ssl-certs.yml | grep "SSLCertExpiring30Days"
    grep "rule_files" docker/prometheus/prometheus.yml
    grep "ssl-certs" docker/prometheus/prometheus.yml
    grep "alerts:" docker/compose.prod.yaml
    docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "Compose config valid"
  </verify>
  <done>
    SSL alert rules created in docker/prometheus/alerts/ssl-certs.yml
    Prometheus configured with rule_files and ssl-certs scrape job
    Prometheus volume mount updated for alerts directory
    Compose configuration validates
  </done>
</task>

</tasks>

<verification>
- [ ] docker/blackbox/blackbox.yml exists with http_2xx module
- [ ] Blackbox Exporter service in compose.prod.yaml
- [ ] docker/prometheus/alerts/ssl-certs.yml exists with 30-day and 7-day alerts
- [ ] prometheus.yml has rule_files section
- [ ] prometheus.yml has ssl-certs scrape job
- [ ] prometheus service has alerts volume mount
- [ ] `docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet` passes
</verification>

<success_criteria>
Blackbox Exporter configured for SSL probing with Prometheus alert rules that fire 30 days before certificate expiry
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-production-readiness/10-02-SUMMARY.md`
</output>
