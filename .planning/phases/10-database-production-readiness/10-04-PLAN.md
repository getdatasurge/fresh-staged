---
phase: 10-database-production-readiness
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/src/db/client.ts
  - docs/DATABASE.md
autonomous: true

must_haves:
  truths:
    - "Backend connects to PostgreSQL through PgBouncer"
    - "Backend code is verified compatible with PgBouncer transaction mode"
  artifacts:
    - path: "backend/src/db/client.ts"
      provides: "Database client configuration"
      contains: "DATABASE_URL"
    - path: "docs/DATABASE.md"
      provides: "PgBouncer compatibility audit documentation"
      contains: "transaction mode"
  key_links:
    - from: "backend/src/db/client.ts"
      to: "pgbouncer:6432"
      via: "DATABASE_URL environment variable"
      pattern: "DATABASE_URL"
---

<objective>
Audit backend code for PgBouncer transaction mode compatibility and document DATABASE_URL configuration

Purpose: Ensure backend code works correctly with connection pooling in transaction mode
Output: Compatibility audit documentation and verified database client configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-production-readiness/10-RESEARCH.md

# Backend code
@backend/src/db/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit backend code for PgBouncer transaction mode compatibility</name>
  <files>
    docs/DATABASE.md
  </files>
  <action>
Perform a comprehensive audit of the backend codebase for PgBouncer transaction mode compatibility:

1. **Check for prepared statements** - Search for `.prepare()` calls:
   ```bash
   grep -r "\.prepare(" backend/src/ --include="*.ts"
   ```
   Should return no results (Drizzle + node-postgres don't use prepared statements unless explicitly named)

2. **Check for SET commands** - Search for session-level settings:
   ```bash
   grep -r "SET SESSION\|SET LOCAL\|SET timezone\|SET search_path" backend/src/ --include="*.ts" -i
   ```
   Should return no results (session state resets in transaction mode)

3. **Check for LISTEN/NOTIFY** - Search for pub/sub patterns:
   ```bash
   grep -r "LISTEN\|NOTIFY\|pg_notify" backend/src/ --include="*.ts" -i
   ```
   Should return no results (not compatible with transaction mode)

4. **Check for advisory locks** - Search for pg_advisory_lock:
   ```bash
   grep -r "advisory_lock\|pg_advisory" backend/src/ --include="*.ts" -i
   ```
   Should return no results (session-level locks don't work with transaction mode)

5. **Check for named parameters in pg Pool** - Verify no explicit prepare:
   ```bash
   grep -r "name:" backend/src/db/ --include="*.ts"
   ```
   Should return no query-related named parameters

Create docs/DATABASE.md documenting the audit:

```markdown
# Database Configuration - FreshTrack Pro

## Connection Pooling Architecture

FreshTrack Pro uses PgBouncer for connection pooling in production:

```
┌─────────────┐     ┌───────────────┐     ┌────────────────┐
│   Backend   │────▶│   PgBouncer   │────▶│   PostgreSQL   │
│  (port 6432)│     │  (pooler)     │     │  (port 5432)   │
└─────────────┘     └───────────────┘     └────────────────┘
```

### Configuration

**Development:**
```
DATABASE_URL=postgresql://freshtrack:password@localhost:6432/freshtrack
```

**Production:**
```
DATABASE_URL=postgresql://freshtrack:${DB_PASSWORD}@pgbouncer:6432/freshtrack
```

### PgBouncer Transaction Mode

PgBouncer runs in **transaction pooling mode**, meaning:
- Connections are released back to the pool after each transaction commits
- Session-level state (SET variables) is reset between transactions
- This provides optimal connection efficiency for web applications

## Compatibility Audit

**Audit Date:** [Current Date]
**Status:** COMPATIBLE

### Verified Compatible Patterns

| Pattern | Status | Notes |
|---------|--------|-------|
| Drizzle ORM queries | ✅ Compatible | Uses node-postgres without named prepared statements |
| Transaction blocks | ✅ Compatible | db.transaction() works correctly |
| Connection pooling | ✅ Compatible | node-postgres Pool compatible with PgBouncer |

### Verified No Incompatible Patterns

| Pattern | Checked | Result |
|---------|---------|--------|
| .prepare() calls | ✅ | None found |
| SET SESSION/LOCAL | ✅ | None found |
| LISTEN/NOTIFY | ✅ | None found |
| Advisory locks | ✅ | None found |
| Named query parameters | ✅ | None found |

### Technical Details

**Drizzle ORM Compatibility:**
- Drizzle with node-postgres uses simple query protocol by default
- Prepared statements only used when explicitly calling `.prepare()`
- No `.prepare()` calls exist in the codebase

**node-postgres Pool Settings:**
```typescript
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,  // Backend's pool size
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
});
```

These settings are appropriate for PgBouncer:
- `max: 20` limits concurrent connections from this backend instance
- PgBouncer's `default_pool_size` controls actual database connections
- Combined: 20 backend connections × PgBouncer pool = efficient resource usage

## Backup and Recovery

See backup procedures in: `/docker/scripts/backup-postgres.sh`

Backup schedule: Daily at 2 AM UTC
Retention: 30 days
Storage: MinIO (postgres-backups bucket)

## Monitoring

PgBouncer metrics available via pgbouncer_exporter (port 9127):
- `pgbouncer_pools_client_active` - Active client connections
- `pgbouncer_pools_server_active` - Active server connections
- `pgbouncer_pools_client_waiting` - Clients waiting for connection

Grafana dashboard: Database Overview (pre-configured)
```
  </action>
  <verify>
    # Run the actual audit commands
    echo "=== Checking for .prepare() calls ==="
    grep -r "\.prepare(" backend/src/ --include="*.ts" || echo "No .prepare() calls found"

    echo "=== Checking for SET commands ==="
    grep -r "SET SESSION\|SET LOCAL\|SET timezone\|SET search_path" backend/src/ --include="*.ts" -i || echo "No SET commands found"

    echo "=== Checking for LISTEN/NOTIFY ==="
    grep -r "LISTEN\|NOTIFY\|pg_notify" backend/src/ --include="*.ts" -i || echo "No LISTEN/NOTIFY found"

    echo "=== Checking for advisory locks ==="
    grep -r "advisory_lock\|pg_advisory" backend/src/ --include="*.ts" -i || echo "No advisory locks found"

    ls -la docs/DATABASE.md
  </verify>
  <done>
    Backend code audit complete - no PgBouncer incompatibilities found
    docs/DATABASE.md created with audit results and configuration guide
  </done>
</task>

<task type="auto">
  <name>Task 2: Document DATABASE_URL configuration for PgBouncer</name>
  <files>
    backend/src/db/client.ts
  </files>
  <action>
Update backend/src/db/client.ts to add documentation comment about PgBouncer:

```typescript
import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import * as schema from './schema/index.js';

/**
 * Database client configured for PgBouncer transaction pooling.
 *
 * Connection string format:
 * - Development: postgresql://freshtrack:password@localhost:6432/freshtrack
 * - Production:  postgresql://freshtrack:${DB_PASSWORD}@pgbouncer:6432/freshtrack
 *
 * PgBouncer Compatibility:
 * - This client is compatible with PgBouncer transaction mode
 * - No prepared statements (no .prepare() calls)
 * - No session-level SET commands
 * - No LISTEN/NOTIFY operations
 *
 * Pool settings are configured for optimal PgBouncer interaction:
 * - max: 20 controls backend connections to PgBouncer
 * - PgBouncer's default_pool_size controls actual PostgreSQL connections
 */
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
});

export const db = drizzle({ client: pool, schema });

export async function closeDatabase(): Promise<void> {
  await pool.end();
}

// Graceful shutdown handler
process.on('SIGTERM', async () => {
  console.log('SIGTERM received, closing database connections...');
  await closeDatabase();
  process.exit(0);
});
```

The key change is adding comprehensive documentation comments. No functional changes needed since the client is already compatible.
  </action>
  <verify>
    cat backend/src/db/client.ts | head -30
    grep "PgBouncer" backend/src/db/client.ts
  </verify>
  <done>
    backend/src/db/client.ts updated with PgBouncer compatibility documentation
    No functional changes required - client already compatible
  </done>
</task>

</tasks>

<verification>
- [ ] Backend audit complete - no .prepare() calls found
- [ ] Backend audit complete - no SET SESSION/LOCAL commands found
- [ ] Backend audit complete - no LISTEN/NOTIFY operations found
- [ ] Backend audit complete - no advisory locks found
- [ ] docs/DATABASE.md created with audit results
- [ ] backend/src/db/client.ts has PgBouncer documentation comments
</verification>

<success_criteria>
Backend code verified compatible with PgBouncer transaction mode, configuration documented for both development and production environments
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-production-readiness/10-04-SUMMARY.md`
</output>
