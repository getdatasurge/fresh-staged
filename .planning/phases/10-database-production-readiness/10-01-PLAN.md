---
phase: 10-database-production-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/pgbouncer/pgbouncer.ini
  - docker/pgbouncer/userlist.txt
  - docker/compose.prod.yaml
  - docker/prometheus/prometheus.yml
autonomous: true

must_haves:
  truths:
    - 'PgBouncer exposes metrics on port 9127'
    - 'Prometheus scrapes pgbouncer_exporter metrics'
  artifacts:
    - path: 'docker/pgbouncer/pgbouncer.ini'
      provides: 'PgBouncer configuration with transaction mode'
      contains: 'pool_mode = transaction'
    - path: 'docker/pgbouncer/userlist.txt'
      provides: 'PgBouncer user credentials'
      contains: 'pgbouncer_exporter'
    - path: 'docker/compose.prod.yaml'
      provides: 'pgbouncer_exporter service definition'
      contains: 'pgbouncer_exporter'
  key_links:
    - from: 'docker/compose.prod.yaml'
      to: 'docker/pgbouncer/pgbouncer.ini'
      via: 'volume mount'
      pattern: './pgbouncer/pgbouncer.ini'
    - from: 'docker/prometheus/prometheus.yml'
      to: 'pgbouncer_exporter:9127'
      via: 'scrape config'
      pattern: 'pgbouncer_exporter:9127'
---

<objective>
Configure PgBouncer with custom configuration file and add pgbouncer_exporter for Prometheus metrics

Purpose: Enable production-grade connection pooling visibility through Prometheus metrics
Output: PgBouncer configuration files and pgbouncer_exporter service integrated with observability stack
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-production-readiness/10-RESEARCH.md

# Existing infrastructure

@docker/docker-compose.yml
@docker/compose.prod.yaml
@docker/prometheus/prometheus.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PgBouncer configuration files</name>
  <files>
    docker/pgbouncer/pgbouncer.ini
    docker/pgbouncer/userlist.txt
  </files>
  <action>
Create directory docker/pgbouncer/ and add:

1. **pgbouncer.ini** - Configuration file with:
   - [databases] section: freshtrack pointing to postgres:5432
   - [pgbouncer] section:
     - listen_addr = 0.0.0.0, listen_port = 6432
     - auth_type = md5, auth_file = /etc/pgbouncer/userlist.txt
     - pool_mode = transaction
     - default_pool_size = 20, min_pool_size = 10, reserve_pool_size = 5
     - max_client_conn = 100, max_db_connections = 20
     - server_lifetime = 3600, server_idle_timeout = 600
     - max_prepared_statements = 200 (for ORM compatibility)
     - ignore_startup_parameters = extra_float_digits (for exporter)
     - admin_users = pgbouncer_exporter, stats_users = pgbouncer_exporter
     - log_connections = 1, log_disconnections = 1, log_pooler_errors = 1

2. **userlist.txt** - User credentials in md5 format:
   - Main user: "freshtrack" with md5 hash placeholder (will be replaced by secrets in prod)
   - Exporter user: "pgbouncer_exporter" with md5 hash placeholder

   Use format: "username" "md5{md5hash}" where md5hash is md5(password+username)
   For development, use simple hashes that match docker-compose.yml defaults.

Note: The bitnami/pgbouncer image uses /bitnami/pgbouncer/conf/ for config location.
</action>
<verify>
ls -la docker/pgbouncer/
cat docker/pgbouncer/pgbouncer.ini | grep "pool_mode"
cat docker/pgbouncer/pgbouncer.ini | grep "max_prepared_statements"
</verify>
<done>
pgbouncer.ini exists with transaction mode and prepared statements support
userlist.txt exists with required users
</done>
</task>

<task type="auto">
  <name>Task 2: Add pgbouncer_exporter service and update Prometheus</name>
  <files>
    docker/compose.prod.yaml
    docker/prometheus/prometheus.yml
  </files>
  <action>
1. **Update docker/compose.prod.yaml** - Add pgbouncer_exporter service:

```yaml
# PgBouncer Metrics Exporter
pgbouncer_exporter:
  image: prometheuscommunity/pgbouncer-exporter:latest
  container_name: freshtrack-pgbouncer-exporter
  environment:
    PGBOUNCER_EXPORTER_CONNECTION_STRING: 'postgres://pgbouncer_exporter:exporter_password@pgbouncer:6432/pgbouncer?sslmode=disable'
  ports:
    - '9127:9127'
  depends_on:
    pgbouncer:
      condition: service_healthy
  deploy:
    resources:
      limits:
        cpus: '0.25'
        memory: 128M
      reservations:
        cpus: '0.1'
        memory: 64M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 5
      window: 120s
  healthcheck:
    test: ['CMD', 'wget', '-qO-', 'http://localhost:9127/metrics']
    interval: 10s
    timeout: 5s
    retries: 3
  logging:
    driver: loki
    options:
      loki-url: 'http://loki:3100/loki/api/v1/push'
      loki-batch-size: '400'
      loki-retries: '3'
      loki-external-labels: 'service={{.Name}},environment=production'
```

2. Also update the pgbouncer service in compose.prod.yaml to mount the custom config:

```yaml
pgbouncer:
  # ... existing config ...
  volumes:
    - ./pgbouncer/pgbouncer.ini:/bitnami/pgbouncer/conf/pgbouncer.ini:ro
    - ./pgbouncer/userlist.txt:/bitnami/pgbouncer/conf/userlist.txt:ro
```

3. **Update docker/prometheus/prometheus.yml** - Add pgbouncer scrape config:

```yaml
# PgBouncer metrics
- job_name: 'pgbouncer'
  static_configs:
    - targets: ['pgbouncer_exporter:9127']
```

  </action>
  <verify>
    grep -A5 "pgbouncer_exporter:" docker/compose.prod.yaml
    grep "pgbouncer" docker/prometheus/prometheus.yml
    docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "Compose config valid"
  </verify>
  <done>
    pgbouncer_exporter service defined in compose.prod.yaml
    Prometheus configured to scrape pgbouncer_exporter:9127
    Compose configuration validates without errors
  </done>
</task>

</tasks>

<verification>
- [ ] docker/pgbouncer/ directory exists with pgbouncer.ini and userlist.txt
- [ ] pgbouncer.ini has pool_mode = transaction
- [ ] pgbouncer.ini has max_prepared_statements = 200
- [ ] pgbouncer_exporter service in compose.prod.yaml
- [ ] prometheus.yml has pgbouncer scrape job
- [ ] `docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet` passes
</verification>

<success_criteria>
PgBouncer configuration files created with transaction mode settings and pgbouncer_exporter integrated with Prometheus for connection pool monitoring
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-production-readiness/10-01-SUMMARY.md`
</output>
