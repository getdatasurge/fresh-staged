---
phase: 10-database-production-readiness
plan: 06
type: execute
wave: 3
depends_on: ["10-01", "10-02", "10-03", "10-04", "10-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All Phase 10 deliverables validated and working"
    - "Database infrastructure production-ready"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 10 deliverables and confirm database production readiness

Purpose: Ensure all database infrastructure components are correctly configured before Phase 11 deployment
Output: Verified Phase 10 completion with all requirements met
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-production-readiness/10-RESEARCH.md

# Phase 10 summaries
@.planning/phases/10-database-production-readiness/10-01-SUMMARY.md
@.planning/phases/10-database-production-readiness/10-02-SUMMARY.md
@.planning/phases/10-database-production-readiness/10-03-SUMMARY.md
@.planning/phases/10-database-production-readiness/10-04-SUMMARY.md
@.planning/phases/10-database-production-readiness/10-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate all Phase 10 configurations</name>
  <files></files>
  <action>
Run comprehensive validation of all Phase 10 deliverables:

1. **PgBouncer Configuration (DB-01):**
   ```bash
   # Check config files exist
   ls -la docker/pgbouncer/pgbouncer.ini docker/pgbouncer/userlist.txt

   # Verify transaction mode
   grep "pool_mode = transaction" docker/pgbouncer/pgbouncer.ini

   # Verify prepared statements support
   grep "max_prepared_statements = 200" docker/pgbouncer/pgbouncer.ini

   # Verify exporter service
   grep -A5 "pgbouncer_exporter:" docker/compose.prod.yaml
   ```

2. **Backend Compatibility (DB-02):**
   ```bash
   # Verify no incompatible patterns
   grep -r "\.prepare(" backend/src/ --include="*.ts" && echo "FAIL: Found prepare()" || echo "PASS: No prepare()"
   grep -r "SET SESSION" backend/src/ --include="*.ts" && echo "FAIL: Found SET SESSION" || echo "PASS: No SET SESSION"
   grep -r "LISTEN\|NOTIFY" backend/src/ --include="*.ts" && echo "FAIL: Found LISTEN/NOTIFY" || echo "PASS: No LISTEN/NOTIFY"

   # Verify documentation
   grep "PgBouncer" backend/src/db/client.ts
   ```

3. **Backup System (DB-03):**
   ```bash
   # Check backup script
   ls -la docker/scripts/backup-postgres.sh
   grep "pg_dump" docker/scripts/backup-postgres.sh
   grep "RETENTION_DAYS" docker/scripts/backup-postgres.sh

   # Check backup service
   grep -A10 "postgres_backup:" docker/compose.prod.yaml

   # Check backup alerts
   grep "BackupContainerDown" docker/prometheus/alerts/backups.yml
   ```

4. **Restoration Procedure (DB-04):**
   ```bash
   # Check restore script
   ls -la docker/scripts/test-restore.sh
   grep "pg_restore" docker/scripts/test-restore.sh

   # Check documentation
   grep "Backup Restoration" docs/DATABASE.md
   grep "Disaster Recovery" docs/DATABASE.md
   ```

5. **SSL Monitoring (DB-05):**
   ```bash
   # Check Blackbox config
   ls -la docker/blackbox/blackbox.yml
   grep "http_2xx" docker/blackbox/blackbox.yml

   # Check SSL alerts
   grep "SSLCertExpiring30Days" docker/prometheus/alerts/ssl-certs.yml

   # Check Prometheus config
   grep "ssl-certs" docker/prometheus/prometheus.yml
   ```

6. **Full Compose Validation:**
   ```bash
   docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "PASS: Compose validates"
   ```
  </action>
  <verify>
    # All validation commands should pass
    echo "Phase 10 Validation Complete"
  </verify>
  <done>
    All configuration files exist and are valid
    Compose configuration validates without errors
    All Phase 10 requirements addressed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 10 Database Production Readiness infrastructure:

1. **PgBouncer Configuration** (DB-01):
   - docker/pgbouncer/pgbouncer.ini with transaction mode
   - docker/pgbouncer/userlist.txt with credentials
   - pgbouncer_exporter service for Prometheus metrics

2. **Backend Compatibility** (DB-02):
   - Code audit confirms no PgBouncer incompatibilities
   - docs/DATABASE.md with configuration guide
   - backend/src/db/client.ts with PgBouncer documentation

3. **Backup System** (DB-03):
   - docker/scripts/backup-postgres.sh (daily pg_dump to MinIO)
   - postgres_backup service in compose.prod.yaml
   - docker/prometheus/alerts/backups.yml for failure alerts

4. **Restoration Procedure** (DB-04):
   - docker/scripts/test-restore.sh for automated testing
   - Comprehensive restore documentation in docs/DATABASE.md
   - Disaster recovery checklist

5. **SSL Monitoring** (DB-05):
   - docker/blackbox/blackbox.yml configuration
   - docker/prometheus/alerts/ssl-certs.yml (30-day warning)
   - Prometheus scrape config for SSL endpoints
  </what-built>
  <how-to-verify>
1. **Verify file structure exists:**
   ```bash
   ls -la docker/pgbouncer/
   ls -la docker/blackbox/
   ls -la docker/prometheus/alerts/
   ls -la docker/scripts/
   ```

2. **Verify compose validates:**
   ```bash
   docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet
   ```

3. **Review key configurations:**
   - PgBouncer uses transaction mode: `grep "pool_mode" docker/pgbouncer/pgbouncer.ini`
   - SSL alerts at 30 days: `grep "30" docker/prometheus/alerts/ssl-certs.yml`
   - Backups have 30-day retention: `grep "RETENTION" docker/scripts/backup-postgres.sh`

4. **Review documentation:**
   - docs/DATABASE.md contains restore procedures
   - docs/DATABASE.md contains disaster recovery checklist

**Expected outcomes:**
- All directories and files exist
- Compose validates without errors
- Configuration values match requirements
- Documentation is comprehensive
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 10 Requirements from ROADMAP.md:

- [ ] **DB-01:** PgBouncer connection pooling enabled and validated
  - pgbouncer.ini with pool_mode = transaction
  - pgbouncer_exporter for Prometheus metrics

- [ ] **DB-02:** Backend code audited for PgBouncer transaction mode compatibility
  - No .prepare() calls, no SET SESSION, no LISTEN/NOTIFY
  - Documentation in docs/DATABASE.md

- [ ] **DB-03:** Automated database backup system implemented
  - Daily pg_dump at 2 AM UTC
  - Upload to MinIO postgres-backups bucket
  - 30-day retention with automatic cleanup

- [ ] **DB-04:** Backup restoration procedure documented and tested
  - test-restore.sh script for automated validation
  - Step-by-step manual restore procedure
  - Disaster recovery checklist

- [ ] **DB-05:** SSL certificate expiration monitoring configured
  - Blackbox Exporter probing HTTPS endpoints
  - Prometheus alerts at 30-day and 7-day thresholds
</verification>

<success_criteria>
All Phase 10 requirements verified and approved. Database infrastructure ready for production deployment in Phase 11.
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-production-readiness/10-06-SUMMARY.md`
</output>
