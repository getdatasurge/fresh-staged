---
phase: 43-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase-placeholder.ts
  - src/hooks/__tests__/useOrganizations.test.tsx
  - src/hooks/__tests__/useSites.test.tsx
  - .planning/STATE.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - 'supabase-placeholder.ts does not exist in the codebase'
    - 'Zero imports or mocks of supabase-placeholder in any source file'
    - 'All frontend tests pass (145+ tests)'
    - 'All backend tests pass (1050+ tests, excluding 15 pre-existing TTN failures)'
  artifacts:
    - path: 'src/lib/supabase-placeholder.ts'
      provides: 'DELETED - must not exist'
      exists: false
  key_links:
    - from: 'src/hooks/__tests__/*.test.tsx'
      to: 'supabase-placeholder'
      via: 'vi.mock statements'
      pattern: 'REMOVED - no mocks should exist'
---

<objective>
Delete supabase-placeholder.ts and remove all remaining references, completing the Supabase-to-tRPC migration.

Purpose: This is the final cleanup phase that removes the deprecated placeholder file and verifies the migration is complete. After phases 39-42 migrated all components to tRPC, the placeholder is no longer needed.

Output: A codebase with zero Supabase references and all tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove supabase-placeholder mocks from test files</name>
  <files>
    src/hooks/__tests__/useOrganizations.test.tsx
    src/hooks/__tests__/useSites.test.tsx
  </files>
  <action>
Remove the vi.mock('@/lib/supabase-placeholder', ...) blocks from both test files:

1. **useOrganizations.test.tsx** (lines 15-29):
   - Delete the entire vi.mock block for supabase-placeholder
   - The test already uses tRPC mocks via mockUseTRPC

2. **useSites.test.tsx** (lines 18-44):
   - Delete the entire vi.mock block for supabase-placeholder
   - The test already uses tRPC mocks via mockUseTRPC and createQueryOptionsMock

These mocks were defensive during migration but are now unnecessary since:

- The hooks being tested (useBranding, useNavTree) use tRPC, not supabase
- No production code imports supabase-placeholder anymore
  </action>
  <verify>
  grep -r "supabase-placeholder" src/hooks/**tests**/ | wc -l # Should return 0
  </verify>
  <done>Zero vi.mock statements for supabase-placeholder in test files</done>
  </task>

<task type="auto">
  <name>Task 2: Delete supabase-placeholder.ts file</name>
  <files>src/lib/supabase-placeholder.ts</files>
  <action>
Delete the file: src/lib/supabase-placeholder.ts

This file contains:

- AppRole and ComplianceMode type aliases (not used elsewhere - types come from drizzle schema)
- Database type (not used - drizzle provides types)
- SupabaseMigrationError class (no longer needed - all error handling migrated)
- isSupabaseMigrationError helper (no longer needed)
- supabase placeholder object with stub methods (no longer called)

After deletion, verify no imports remain:

```bash
grep -r "supabase-placeholder" src/ --include="*.ts" --include="*.tsx" | wc -l
```

Should return 0.
</action>
<verify>
test ! -f src/lib/supabase-placeholder.ts && echo "File deleted"
grep -r "supabase-placeholder" src/ --include="_.ts" --include="_.tsx" | wc -l # Should return 0
</verify>
<done>supabase-placeholder.ts deleted and zero imports remain in src/</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify all tests pass</name>
  <files>None (verification only)</files>
  <action>
Run the complete test suite to verify the migration is complete:

1. **Frontend tests:**

```bash
npm run test:frontend -- --run
```

Expected: 145+ tests pass

2. **Backend tests:**

```bash
npm run test:backend -- --run
```

Expected: 1050+ tests pass (15 pre-existing failures in tests/api/ttn-devices.test.ts are unrelated to migration)

3. **TypeScript compilation:**

```bash
npx tsc --noEmit
```

Expected: No errors

If any tests fail due to missing supabase-placeholder imports:

- The import should be removed (not the file re-added)
- Check if the file actually needs the import or if it's leftover from migration
  </action>
  <verify>
  npm run test:frontend -- --run 2>&1 | tail -20
  npm run test:backend -- --run 2>&1 | tail -20
  npx tsc --noEmit
  </verify>
  <done>All frontend tests pass (145+), all backend tests pass (1050+ minus 15 pre-existing TTN failures), TypeScript compiles without errors</done>
  </task>

</tasks>

<verification>
1. File existence check:
```bash
test ! -f src/lib/supabase-placeholder.ts && echo "PASS: File deleted"
```

2. Import check across entire codebase:

```bash
grep -r "supabase-placeholder" src/ --include="*.ts" --include="*.tsx" | wc -l
# Must be 0
```

3. Test results:

```bash
npm run test:frontend -- --run
npm run test:backend -- --run
```

4. Build verification:

```bash
npm run build
```

</verification>

<success_criteria>

1. src/lib/supabase-placeholder.ts is deleted from the codebase
2. Zero imports/mocks of supabase-placeholder in any src/ file
3. All frontend tests pass (145+ tests)
4. All backend tests pass (1050+ tests, excluding 15 pre-existing TTN failures)
5. TypeScript compilation succeeds
6. Production build succeeds
   </success_criteria>

<output>
After completion, create `.planning/phases/43-cleanup-verification/43-01-SUMMARY.md`

Also update:

- `.planning/STATE.md` - Mark Phase 43 complete, update progress to 100%
- `.planning/ROADMAP.md` - Check off Phase 43 and update progress
  </output>
