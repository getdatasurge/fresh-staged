---
phase: 29-production-data-migration
plan: 02
type: execute
wave: 2
depends_on: ['29-01']
files_modified: []
autonomous: false

must_haves:
  truths:
    - 'Supabase set to read-only and freeze time recorded'
    - 'Exported dataset stored in migration-data'
    - 'User mapping file generated and validated'
  artifacts: []
  key_links: []
---

<objective>
Freeze legacy writes, export production data, and migrate users to Stack Auth.

Purpose: Capture a consistent snapshot and preserve user identity mapping before import.
Output: Exported JSON data and user-mapping.json ready for import.
</objective>

<context>
@.planning/phases/29-production-data-migration/29-RESEARCH.md
@scripts/migration/README.md
@docs/CUTOVER_CHECKLIST.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 1: Freeze Supabase writes</name>
  <what-built>Legacy system is read-only for a consistent export.</what-built>
  <how-to-verify>
- [ ] Supabase set to read-only (maintenance mode)
- [ ] Freeze timestamp recorded
- [ ] User-facing maintenance notice posted
  </how-to-verify>
  <resume-signal>Type "frozen" when Supabase is read-only</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 2: Export Supabase data</name>
  <what-built>Complete data export saved to disk.</what-built>
  <how-to-verify>
```bash
cd scripts/migration
pnpm run export
ls -la migration-data/
cat migration-data/metadata.json
```
- Confirm all expected table JSON files exist
- Confirm metadata.json includes row counts and export timestamp
  </how-to-verify>
  <resume-signal>Type "exported" when export completes successfully</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint 3: Migrate users and generate mapping</name>
  <what-built>Stack Auth users created and mapping file ready.</what-built>
  <how-to-verify>
```bash
cd scripts/migration
pnpm run migrate-users
cat migration-data/user-mapping.json | head -50
```
- Confirm user-mapping.json exists and includes retainUntil
- If users already exist, use map-users.ts instead
  </how-to-verify>
  <resume-signal>Type "users-mapped" when mapping file is ready</resume-signal>
</task>

</tasks>
