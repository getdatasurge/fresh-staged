---
phase: 13-e2e-validation-cutover
plan: 05
type: execute
wave: 2
depends_on: ['13-01', '13-02']
files_modified:
  - scripts/test/validate-zero-downtime.sh
  - scripts/test/README.md
  - docs/E2E_VALIDATION_CHECKLIST.md
autonomous: false

must_haves:
  truths:
    - 'Health checks prevent traffic to unhealthy containers during deployment'
    - 'Zero-downtime validation script confirms rolling update behavior'
    - 'Caddy routes only to healthy backend instances'
    - 'Validation checklist confirms all TEST-01 through TEST-04 requirements are met'
    - 'Phase 13 success criteria can be verified against checklist'
  artifacts:
    - path: 'scripts/test/validate-zero-downtime.sh'
      provides: 'Zero-downtime deployment validation script'
      min_lines: 80
    - path: 'docs/E2E_VALIDATION_CHECKLIST.md'
      provides: 'Final E2E validation checklist for production cutover'
      min_lines: 100
  key_links:
    - from: 'validate-zero-downtime.sh'
      to: 'docker/docker-compose.yml'
      via: 'Docker health check verification'
      pattern: 'docker.*health'
    - from: 'validate-zero-downtime.sh'
      to: 'backend/src/routes/health.ts'
      via: 'Health endpoint response'
      pattern: '/health'
---

<objective>
Validate zero-downtime deployment capability and create final E2E validation checklist for production cutover.

Purpose: Validate TEST-04 requirement (zero-downtime deployment) and create comprehensive checklist confirming all Phase 13 success criteria are met.
Output: Zero-downtime validation script and production cutover checklist.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-validation-cutover/13-RESEARCH.md
@.planning/phases/13-e2e-validation-cutover/13-01-SUMMARY.md
@.planning/phases/13-e2e-validation-cutover/13-02-SUMMARY.md
@docker/docker-compose.yml
@docker/compose.prod.yaml
@backend/src/routes/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create zero-downtime deployment validation script</name>
  <files>scripts/test/validate-zero-downtime.sh</files>
  <action>
Create scripts/test/validate-zero-downtime.sh that validates health check-based zero-downtime deployment:

1. **Configuration:**
   - BASE_URL (default: http://localhost:3000)
   - COMPOSE_FILE (default: docker/docker-compose.yml)
   - HEALTH_ENDPOINT (default: /health)

2. **Pre-flight checks:**
   - Verify Docker is running
   - Verify docker compose is available (v2 syntax)
   - Verify application is running and healthy

3. **Test flow (5 steps):**

   Step 1: Verify current health status
   - GET /health returns 200 with status: "healthy"
   - GET /health/ready returns ready: true
   - Record baseline response time

   Step 2: Verify Docker health check configuration
   - docker inspect backend container
   - Confirm healthcheck is configured
   - Print health check interval/timeout/retries

   Step 3: Verify service dependency conditions
   - Check docker-compose.yml for depends_on with condition: service_healthy
   - List services with health check dependencies
   - Confirm backend depends on postgres (service_healthy)

   Step 4: Simulate deployment (non-destructive)
   - docker compose up -d --no-deps backend (recreate just backend)
   - Poll /health endpoint every second for 30 seconds
   - Count successful responses vs failures during transition
   - Note: Caddy should handle the transition gracefully

   Step 5: Verify post-deployment health
   - Confirm /health returns 200
   - Confirm /health/ready returns ready: true
   - Report any requests that failed during step 4

4. **Output:**
   - Summary of health check configuration
   - Request success rate during deployment (should be >95% for zero-downtime)
   - Recommendation: If any failures, suggest increasing health check retries or start_period

5. **Note on validation approach:**
   - This validates the MECHANISM (health checks prevent unhealthy traffic)
   - Full load testing during deployment is optional (at user discretion)
   - Production deployments use deploy-selfhosted.sh which already waits for health
     </action>
     <verify>
     Run: chmod +x scripts/test/validate-zero-downtime.sh && shellcheck scripts/test/validate-zero-downtime.sh
     Script should pass shellcheck validation.
     </verify>
     <done>
     validate-zero-downtime.sh exists with health check validation.
     Script confirms Docker health checks are configured correctly.
     Script tests deployment transition behavior.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Create E2E validation checklist document</name>
  <files>docs/E2E_VALIDATION_CHECKLIST.md</files>
  <action>
Create docs/E2E_VALIDATION_CHECKLIST.md as the final validation checklist before production cutover:

1. **Purpose:**
   - Comprehensive checklist to verify all Phase 13 requirements are met
   - Use before production cutover to confirm readiness

2. **Requirements Checklist:**

## TEST-01: Sensor Data Ingestion

- [ ] Run `scripts/test/e2e-sensor-pipeline.sh` against target deployment
- [ ] Verify: Sensor reading appears in database within 5 seconds
- [ ] Verify: Threshold breach triggers alert creation
- [ ] Both simulator mode and direct API paths documented

## TEST-02: Alert Notification Pipeline

- [ ] Run `scripts/test/e2e-alert-notifications.sh` against target deployment
- [ ] Verify: Alert lifecycle works (trigger → acknowledge → resolve)
- [ ] Verify: Webhook notifications are delivered (if configured)
- [ ] Verify: Email notifications are delivered (if SMTP configured)

## TEST-03: Migration Procedure

- [ ] Run `scripts/test/generate-test-data.ts` to create 100K test records
- [ ] Run `scripts/test/validate-migration-timing.sh` to measure timing
- [ ] Document: Migration window estimate for production data volume
- [ ] Confirm: Backup/restore procedures from Phase 10 are available

## TEST-04: Zero-Downtime Deployment

- [ ] Run `scripts/test/validate-zero-downtime.sh` on deployment target
- [ ] Verify: Health checks are configured on all services
- [ ] Verify: Service dependencies use condition: service_healthy
- [ ] Verify: Deployments maintain >95% request success rate

3. **Success Criteria Verification:**

| Criterion                                     | How to Verify                               | Status |
| --------------------------------------------- | ------------------------------------------- | ------ |
| Sensor data flows ingestion → storage → alert | Run e2e-sensor-pipeline.sh                  | [ ]    |
| Alert notifications delivered                 | Run e2e-alert-notifications.sh with webhook | [ ]    |
| Migration timing documented                   | Run validate-migration-timing.sh            | [ ]    |
| Zero-downtime validated                       | Run validate-zero-downtime.sh               | [ ]    |
| Deployment guide exists                       | Check docs/DEPLOYMENT_DECISION_GUIDE.md     | [ ]    |

4. **Pre-Cutover Checklist:**

**Infrastructure:**

- [ ] Production domain configured (DNS pointing to server)
- [ ] SSL certificates issued (Let's Encrypt via Caddy)
- [ ] Secrets configured (Infisical or file-based)
- [ ] Backup system running (daily backups to MinIO)

**Application:**

- [ ] All E2E tests pass against production deployment
- [ ] Observability stack accessible (Grafana, Prometheus)
- [ ] Alert rules configured for production thresholds
- [ ] Health checks passing on all services

**Data Migration (if applicable):**

- [ ] Migration scripts tested with production data sample
- [ ] Maintenance window scheduled based on timing validation
- [ ] Rollback plan documented (Phase 10 backup/restore)
- [ ] User communication sent (downtime notification)

5. **Post-Cutover Verification:**

- [ ] All services healthy (docker compose ps shows healthy)
- [ ] Health endpoints responding (GET /health returns 200)
- [ ] Sensor data flowing (check recent readings)
- [ ] Alerts firing correctly (trigger test alert)
- [ ] Notifications delivering (verify webhook/email)

6. **Rollback Procedure:**
   If issues detected after cutover:
1. Restore from latest backup (see docs/DATABASE.md)
1. Revert to previous Docker images (deploy-selfhosted.sh rollback)
1. Notify users of rollback
1. Investigate and fix before re-attempting
   </action>
   <verify>
   Run: wc -l docs/E2E_VALIDATION_CHECKLIST.md
   Should be at least 100 lines.
   Run: grep -c "\[ \]" docs/E2E_VALIDATION_CHECKLIST.md
   Should return at least 15 checkboxes.
   </verify>
   <done>
   E2E_VALIDATION_CHECKLIST.md exists with comprehensive checklist.
   All TEST-01 through TEST-04 requirements have verification steps.
   Pre-cutover and post-cutover checklists included.
   </done>
   </task>

<task type="auto">
  <name>Task 3: Update test README with complete test suite</name>
  <files>scripts/test/README.md</files>
  <action>
Finalize scripts/test/README.md with complete test suite documentation:

1. **Complete Test Suite Overview:**
   - List all test scripts created in Phase 13
   - Document recommended execution order
   - Note which tests are required vs optional

2. **Test Execution Order:**

```bash
# 1. Basic ingestion validation
./scripts/test/e2e-sensor-pipeline.sh

# 2. Alert lifecycle validation
./scripts/test/e2e-alert-notifications.sh

# 3. (Optional) Migration timing - requires test data
npx tsx scripts/test/generate-test-data.ts
./scripts/test/validate-migration-timing.sh

# 4. Zero-downtime validation
./scripts/test/validate-zero-downtime.sh
```

3. **Environment Variables Summary:**
   - List all env vars used across all scripts
   - Provide example .env.test file content

4. **Final Notes:**
   - Link to docs/E2E_VALIDATION_CHECKLIST.md for production cutover
   - Note that all tests can run against local or production environments
   - Recommend running full suite before any production deployment
     </action>
     <verify>
     Run: grep -c "e2e-" scripts/test/README.md
     Should return at least 4 (references to all test scripts).
     </verify>
     <done>
     README.md documents complete test suite.
     Execution order and environment variables documented.
     Links to validation checklist included.
     </done>
     </task>

</tasks>

<verification>
Run the complete E2E validation suite against local development:
```bash
cd /home/skynet/freshtrack-pro-local/freshtrack-pro
export BASE_URL=http://localhost:3000
export TTN_WEBHOOK_SECRET=test-secret
export TEST_JWT=<valid-jwt>

# Run all validation scripts

./scripts/test/e2e-sensor-pipeline.sh
./scripts/test/e2e-alert-notifications.sh
./scripts/test/validate-zero-downtime.sh

# Review checklist

cat docs/E2E_VALIDATION_CHECKLIST.md | head -50

```
</verification>

<success_criteria>
- validate-zero-downtime.sh confirms health check-based deployment works
- E2E_VALIDATION_CHECKLIST.md provides comprehensive cutover checklist
- All TEST-01 through TEST-04 requirements have verification paths
- Complete test suite documented in README
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>
Complete E2E validation test suite including:
- Sensor pipeline test (e2e-sensor-pipeline.sh)
- Alert notification test (e2e-alert-notifications.sh)
- Migration timing test (validate-migration-timing.sh + generate-test-data.ts)
- Zero-downtime validation (validate-zero-downtime.sh)
- Deployment decision guide (DEPLOYMENT_DECISION_GUIDE.md)
- Final validation checklist (E2E_VALIDATION_CHECKLIST.md)
  </what-built>
  <how-to-verify>
1. Review test scripts in scripts/test/
2. Run scripts against local development stack
3. Review deployment decision guide in docs/
4. Confirm all Phase 13 success criteria are addressed
5. Verify checklist covers TEST-01 through TEST-04 requirements
  </how-to-verify>
  <resume-signal>
Type "phase 13 approved" to confirm Phase 13 is complete and v1.1 milestone is ready for production cutover.
  </resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/13-e2e-validation-cutover/13-05-SUMMARY.md`
</output>
```
