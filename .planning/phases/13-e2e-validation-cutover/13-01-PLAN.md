---
phase: 13-e2e-validation-cutover
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/test/e2e-sensor-pipeline.sh
  - scripts/test/README.md
autonomous: true

must_haves:
  truths:
    - 'Sensor reading submitted via API appears in database within 5 seconds'
    - 'Threshold breach triggers alert creation in alerts table'
    - 'Test script can run without physical sensors (simulator mode)'
    - 'Both direct API and TTN webhook paths are documented'
  artifacts:
    - path: 'scripts/test/e2e-sensor-pipeline.sh'
      provides: 'E2E sensor pipeline validation script'
      min_lines: 100
    - path: 'scripts/test/README.md'
      provides: 'Test script documentation and usage'
      min_lines: 30
  key_links:
    - from: 'e2e-sensor-pipeline.sh'
      to: 'backend/src/routes/readings.ts'
      via: 'POST /api/readings'
      pattern: 'curl.*api/readings'
    - from: 'e2e-sensor-pipeline.sh'
      to: 'backend/src/services/alert-evaluator.service.ts'
      via: 'Alert trigger after threshold breach'
      pattern: 'api/alerts'
---

<objective>
Create E2E sensor pipeline validation script that tests sensor data flow from ingestion to alert trigger.

Purpose: Validate TEST-01 requirement that sensor data flows correctly through the self-hosted stack.
Output: Executable shell script that can be run against local or production deployments to validate the complete sensor → storage → alert pipeline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-validation-cutover/13-RESEARCH.md
@backend/src/routes/readings.ts
@backend/src/routes/alerts.ts
@backend/src/routes/health.ts
@backend/src/services/alert-evaluator.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E sensor pipeline test script</name>
  <files>scripts/test/e2e-sensor-pipeline.sh</files>
  <action>
Create scripts/test/ directory and e2e-sensor-pipeline.sh with the following functionality:

1. **Configuration section:**
   - Accept BASE_URL env var (default: http://localhost:3000)
   - Accept TTN_WEBHOOK_SECRET for API key auth
   - Accept TEST_JWT for authenticated endpoints (alert acknowledgment/resolution)
   - Configurable temperature threshold breach value

2. **Pre-flight checks:**
   - Verify backend is healthy (GET /health returns 200)
   - Verify database connectivity (GET /health/ready returns ready: true)
   - Print configuration being used

3. **Test flow (6 steps):**
   - Step 1: Generate test device ID with timestamp to ensure uniqueness
   - Step 2: POST sensor reading to /api/readings with temperature BELOW threshold (normal reading)
   - Step 3: Verify reading appears (query database or GET endpoint if available)
   - Step 4: POST sensor reading ABOVE threshold (excursion reading - e.g., temp_limit_high + 5)
   - Step 5: Wait 5 seconds for async alert processing
   - Step 6: Check if alert was created (GET /api/alerts with device_id filter or check database)

4. **Output:**
   - Clear step-by-step output with checkmarks/X for pass/fail
   - Summary showing total tests passed/failed
   - Exit code 0 on success, 1 on any failure

5. **Edge cases to handle:**
   - Backend not running (graceful failure message)
   - Auth errors (clear message about missing JWT/API key)
   - Timeout waiting for alert (configurable, default 10s)

Script should be idempotent - can run multiple times without side effects (uses unique device IDs).
</action>
<verify>
Run: chmod +x scripts/test/e2e-sensor-pipeline.sh && shellcheck scripts/test/e2e-sensor-pipeline.sh
Script should pass shellcheck with no errors.
</verify>
<done>
Script exists at scripts/test/e2e-sensor-pipeline.sh with all 6 test steps implemented.
Script is executable and passes shellcheck validation.
</done>
</task>

<task type="auto">
  <name>Task 2: Create test scripts README documentation</name>
  <files>scripts/test/README.md</files>
  <action>
Create scripts/test/README.md documenting test script usage:

1. **Overview:** Explain purpose of E2E test scripts (validate production readiness)

2. **Prerequisites:**
   - Backend running (local or deployed)
   - API key configured for sensor ingestion
   - JWT token for authenticated endpoints
   - jq installed for JSON parsing

3. **E2E Sensor Pipeline (e2e-sensor-pipeline.sh):**
   - What it tests (sensor → storage → alert flow)
   - Environment variables:
     - BASE_URL (default: http://localhost:3000)
     - TTN_WEBHOOK_SECRET (required)
     - TEST_JWT (required for alert lifecycle tests)
   - Example usage for local testing
   - Example usage for production validation
   - Expected output

4. **Testing Modes:**
   - Direct API mode (uses /api/readings directly)
   - TTN webhook mode (routes through TTN webhook endpoint if configured)
   - Document how SensorSimulatorPanel in Settings provides UI-based testing

5. **Troubleshooting:**
   - Common errors and solutions
   - How to generate test JWT
   - Verifying API key configuration
     </action>
     <verify>
     Run: cat scripts/test/README.md | head -50
     README should have clear structure with prerequisites, usage, and examples.
     </verify>
     <done>
     README.md exists with complete documentation for running E2E tests.
     Documentation includes both API and UI testing approaches (SensorSimulatorPanel).
     </done>
     </task>

</tasks>

<verification>
Run the E2E sensor pipeline test against local development environment:
```bash
cd /home/skynet/freshtrack-pro-local/freshtrack-pro
# Start local stack if not running
# Export required env vars
export TTN_WEBHOOK_SECRET=test-secret
export TEST_JWT=<valid-jwt>
./scripts/test/e2e-sensor-pipeline.sh
```
</verification>

<success_criteria>

- scripts/test/e2e-sensor-pipeline.sh exists and is executable
- Script tests complete sensor → storage → alert pipeline
- Script provides clear pass/fail output
- README.md documents usage and prerequisites
- TEST-01 requirement (sensor data ingestion validated) is addressed
  </success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-validation-cutover/13-01-SUMMARY.md`
</output>
