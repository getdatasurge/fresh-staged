---
phase: 38-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/trpc-test-utils.ts
  - src/hooks/__tests__/useSites.test.tsx
  - src/test/setup.ts
autonomous: true

must_haves:
  truths:
    - 'All frontend tests using tRPC queryOptions pattern pass'
    - 'tRPC mock utility is reusable across test files'
    - 'Mock pattern matches production code: trpc.X.Y.queryOptions() returns { queryKey, queryFn }'
  artifacts:
    - path: 'src/test/trpc-test-utils.ts'
      provides: 'Reusable tRPC mock factory for queryOptions pattern'
      exports: ['createMockTRPC', 'MockTRPCReturn']
    - path: 'src/hooks/__tests__/useSites.test.tsx'
      provides: 'Fixed useSites tests using queryOptions mock pattern'
      contains: 'queryOptions'
  key_links:
    - from: 'src/test/trpc-test-utils.ts'
      to: 'src/hooks/__tests__/*.test.tsx'
      via: 'import { createMockTRPC }'
      pattern: 'createMockTRPC'
    - from: 'test mocks'
      to: 'src/lib/trpc.ts'
      via: "vi.mock('@/lib/trpc')"
      pattern: 'useTRPC.*queryOptions'
---

<objective>
Fix frontend tRPC test mocking to support the queryOptions pattern used throughout the codebase.

Purpose: Frontend tests fail with `trpc.X.Y.queryOptions is not a function` because mocks use the old `.useQuery` pattern instead of the `.queryOptions` pattern that `createTRPCContext` provides.

Output: A reusable tRPC mock utility and fixed useSites.test.tsx demonstrating the correct pattern for subsequent migration phases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md

# Key files to understand the pattern

@src/lib/trpc.ts
@src/hooks/useNavTree.ts
@src/hooks/**tests**/useSites.test.tsx
@src/hooks/**tests**/useOrganizations.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable tRPC mock utility</name>
  <files>src/test/trpc-test-utils.ts</files>
  <action>
Create a new file `src/test/trpc-test-utils.ts` that provides a factory for creating properly-typed tRPC mocks.

The utility must:

1. Support the `queryOptions` pattern that TanStack Query v5 uses:
   - `trpc.router.procedure.queryOptions(input, opts)` returns `{ queryKey, queryFn, enabled?, staleTime? }`
   - The mock must accept a query result and return the proper structure

2. Support nested router paths (e.g., `sites.list`, `units.listByOrg`, `organizations.get`)

3. Provide type-safe mock creation that doesn't require casting

Example usage pattern (what the utility should enable):

```typescript
const mockTRPC = createMockTRPC({
  sites: {
    list: { data: mockSites, isLoading: false, error: null },
  },
  units: {
    listByOrg: { data: mockUnits, isLoading: false, error: null },
  },
});

vi.mock('@/lib/trpc', () => ({
  useTRPC: () => mockTRPC,
}));
```

The `queryOptions` mock should return:

```typescript
{
  queryKey: [routerName, procedureName, input],
  queryFn: () => Promise.resolve(data),
  enabled: true,
  staleTime: 0
}
```

Reference the working pattern in `useOrganizations.test.tsx` lines 70-79 which correctly mocks `queryOptions`.

Do NOT use `any` types - provide proper TypeScript types for the mock structure.
</action>
<verify>
Run: `npx tsc --noEmit src/test/trpc-test-utils.ts` - should have no type errors
</verify>
<done>
File exists at `src/test/trpc-test-utils.ts` with exported `createMockTRPC` function that produces mocks with `.queryOptions()` methods returning `{ queryKey, queryFn }` structure.
</done>
</task>

<task type="auto">
  <name>Task 2: Fix useSites.test.tsx using new mock utility</name>
  <files>src/hooks/__tests__/useSites.test.tsx</files>
  <action>
Update `useSites.test.tsx` to use the `queryOptions` mock pattern.

**CRITICAL:** Remove ALL `.useQuery` properties from the mock structure. The production code does NOT use `.useQuery` — it uses `.queryOptions()` directly with TanStack Query's `useQuery`.

Current broken pattern (lines 108-119):

```typescript
mockUseTRPC.mockReturnValue({
  sites: {
    list: {
      useQuery: vi.fn().mockReturnValue(mockSitesQuery), // WRONG - remove this entirely
    },
  },
  // ...
});
```

**Replace** with this pattern (matching how `useNavTree.ts` actually uses tRPC):

```typescript
// useNavTree.ts uses: useQuery(trpc.sites.list.queryOptions({ organizationId }, opts))
// So the mock needs queryOptions to return { queryKey, queryFn }

mockUseTRPC.mockReturnValue({
  sites: {
    list: {
      queryOptions: vi.fn().mockReturnValue({
        queryKey: ['sites', 'list', { organizationId: 'org-1' }],
        queryFn: () => Promise.resolve(mockSites),
        enabled: true,
        staleTime: 30000,
      }),
    },
  },
  units: {
    listByOrg: {
      queryOptions: vi.fn().mockReturnValue({
        queryKey: ['units', 'listByOrg', { organizationId: 'org-1' }],
        queryFn: () => Promise.resolve(mockUnits),
        enabled: true,
        staleTime: 30000,
      }),
    },
  },
});
```

Update ALL test cases in the file to use this pattern. There are 6 test cases:

1. "fetches sites and units using tRPC"
2. "builds navigation tree structure"
3. "detects single site correctly"
4. "handles multiple sites"
5. "returns empty when organizationId is null"
6. "handles errors gracefully"

For each test, ensure the mock returns the appropriate data for that test scenario.

Also import and optionally use the `createMockTRPC` utility if it simplifies the mocks.
</action>
<verify>
Run: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- src/hooks/__tests__/useSites.test.tsx`
All 6 tests should pass.
</verify>
<done>
All 6 tests in useSites.test.tsx pass without `queryOptions is not a function` errors.
</done>
</task>

<task type="auto">
  <name>Task 3: Verify all frontend tests and document pattern</name>
  <files>src/test/setup.ts</files>
  <action>
1. Run the full frontend test suite to identify remaining failures:
   `npm test`

2. Add a JSDoc comment to `src/test/setup.ts` documenting the tRPC mock pattern for future reference:

```typescript
/**
 * tRPC Test Mocking Pattern
 *
 * Production code uses: useQuery(trpc.router.procedure.queryOptions(input, opts))
 *
 * Test mocks must provide queryOptions() that returns:
 * {
 *   queryKey: [routerName, procedureName, input],
 *   queryFn: () => Promise.resolve(data),
 *   enabled: boolean,
 *   staleTime: number
 * }
 *
 * See: src/test/trpc-test-utils.ts for reusable mock factory
 * Example: src/hooks/__tests__/useSites.test.tsx
 */
```

3. If there are other test files with similar failures, note them in the summary for subsequent phases to address.

The goal is to establish the pattern, not fix every test file in this plan.
</action>
<verify>
Run: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|✓|✗)" | head -50`
Note pass/fail counts. useSites.test.tsx should show all tests passing.
</verify>
<done>

- tRPC mock pattern documented in setup.ts
- Full test run completed
- Remaining failures (if any) catalogued for subsequent phases
- useSites.test.tsx demonstrates working pattern for reuse
  </done>
  </task>

</tasks>

<verification>
- [ ] `src/test/trpc-test-utils.ts` exists with `createMockTRPC` export
- [ ] `src/hooks/__tests__/useSites.test.tsx` passes all 6 tests
- [ ] Mock pattern documented in `src/test/setup.ts`
- [ ] No TypeScript errors in new test utilities
</verification>

<success_criteria>

1. useSites.test.tsx passes without `queryOptions is not a function` errors
2. Reusable mock utility exists for use in subsequent migration phases
3. Pattern is documented for Claude to follow in phases 39-42
   </success_criteria>

<output>
After completion, create `.planning/phases/38-test-infrastructure/38-01-SUMMARY.md`
</output>
