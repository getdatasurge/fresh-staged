---
phase: 38-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [38-01]
files_modified:
  - src/hooks/__tests__/useAlerts.test.tsx
  - src/components/settings/__tests__/TTNCredentialsPanel.test.tsx
autonomous: true

must_haves:
  truths:
    - 'All frontend tests using tRPC queryOptions/mutationOptions pattern pass'
    - 'useAlerts.test.tsx passes all 11 tests'
    - 'TTNCredentialsPanel.test.tsx passes all 21 tests'
  artifacts:
    - path: 'src/hooks/__tests__/useAlerts.test.tsx'
      provides: 'Fixed useAlerts tests using queryOptions/mutationOptions mock pattern'
      contains: 'queryOptions'
    - path: 'src/components/settings/__tests__/TTNCredentialsPanel.test.tsx'
      provides: 'Fixed TTNCredentialsPanel tests using queryOptions/mutationOptions mock pattern'
      contains: 'queryOptions'
  key_links:
    - from: 'src/test/trpc-test-utils.ts'
      to: 'src/hooks/__tests__/useAlerts.test.tsx'
      via: 'import { createQueryOptionsMock }'
      pattern: 'createQueryOptionsMock'
---

<objective>
Fix remaining frontend test files to use the queryOptions/mutationOptions mock pattern established in 38-01.

Purpose: Two test files still fail with `trpc.X.Y.queryOptions is not a function` because they use the old `.useQuery` pattern. This plan migrates them to match the pattern established in useSites.test.tsx.

Output: All 32 remaining frontend test failures resolved, completing Phase 38's goal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/test/trpc-test-utils.ts
@src/hooks/__tests__/useSites.test.tsx (working pattern)
@.planning/phases/38-test-infrastructure/38-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix useAlerts.test.tsx (11 tests)</name>
  <files>src/hooks/__tests__/useAlerts.test.tsx</files>
  <action>
Update `useAlerts.test.tsx` to use the `queryOptions` and `mutationOptions` mock pattern.

**Production code pattern (from useUnitAlerts.ts):**

```typescript
// Queries use queryOptions
const alerts = useQuery(trpc.alerts.listByOrg.queryOptions({ organizationId, ... }, opts))

// Mutations use mutationOptions
return useMutation({
  ...trpc.alerts.acknowledge.mutationOptions(),
  onSuccess: () => { ... }
})
```

**Current broken pattern:**

```typescript
mockUseTRPC.mockReturnValue({
  alerts: {
    listByOrg: {
      useQuery: mockUseQuery, // WRONG
    },
    acknowledge: {
      useMutation: mockUseMutation, // WRONG
    },
  },
});
```

**Replace with:**

```typescript
mockUseTRPC.mockReturnValue({
  alerts: {
    listByOrg: {
      queryOptions: vi.fn().mockReturnValue({
        queryKey: ['alerts', 'listByOrg', { organizationId: 'test-org-id' }],
        queryFn: () => Promise.resolve(mockAlerts),
        enabled: true,
        staleTime: 10000,
      }),
    },
    acknowledge: {
      mutationOptions: vi.fn().mockReturnValue({
        mutationKey: ['alerts', 'acknowledge'],
        mutationFn: vi.fn().mockResolvedValue(mockResult),
      }),
    },
    resolve: {
      mutationOptions: vi.fn().mockReturnValue({
        mutationKey: ['alerts', 'resolve'],
        mutationFn: vi.fn().mockResolvedValue(mockResult),
      }),
    },
  },
});
```

Update ALL test cases to use this pattern. There are 11 tests across 4 describe blocks:

- useFetchUnitAlerts (3 tests)
- useFetchAlerts (2 tests)
- useAcknowledgeAlert (3 tests)
- useResolveAlert (3 tests)

Import the utilities from `src/test/trpc-test-utils.ts` if helpful.
</action>
<verify>
Run: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- src/hooks/__tests__/useAlerts.test.tsx`
All 11 tests should pass.
</verify>
<done>
All 11 tests in useAlerts.test.tsx pass without `queryOptions is not a function` errors.
</done>
</task>

<task type="auto">
  <name>Task 2: Fix TTNCredentialsPanel.test.tsx (21 tests)</name>
  <files>src/components/settings/__tests__/TTNCredentialsPanel.test.tsx</files>
  <action>
Update `TTNCredentialsPanel.test.tsx` to use the `queryOptions` and `mutationOptions` mock pattern.

**Production code pattern (from TTNCredentialsPanel.tsx):**

```typescript
// Queries use queryOptions
const credentialsQuery = useQuery(
  trpc.ttnSettings.getCredentials.queryOptions({ organizationId }, opts),
);
const statusQuery = useQuery(trpc.ttnSettings.getStatus.queryOptions({ organizationId }, opts));

// Mutations use mutationOptions directly
const provisionMutation = useMutation(trpc.ttnSettings.provision.mutationOptions());
const startFreshMutation = useMutation(trpc.ttnSettings.startFresh.mutationOptions());
const deepCleanMutation = useMutation(trpc.ttnSettings.deepClean.mutationOptions());
```

**Current broken pattern (lines 50-92):**

```typescript
vi.mock('@/lib/trpc', () => ({
  useTRPC: () => ({
    ttnSettings: {
      getCredentials: {
        useQuery: () => ({ ... }),  // WRONG
      },
      provision: {
        useMutation: () => ({ ... }),  // WRONG
      },
    },
  }),
}))
```

**Replace with:**

```typescript
vi.mock('@/lib/trpc', () => ({
  useTRPC: () => ({
    ttnSettings: {
      getCredentials: {
        queryOptions: vi.fn().mockReturnValue({
          queryKey: ['ttnSettings', 'getCredentials', { organizationId: 'test-org-id' }],
          queryFn: () => Promise.resolve(mockCredentials),
        }),
      },
      getStatus: {
        queryOptions: vi.fn().mockReturnValue({
          queryKey: ['ttnSettings', 'getStatus', { organizationId: 'test-org-id' }],
          queryFn: () => Promise.resolve(mockStatus),
        }),
      },
      provision: {
        mutationOptions: vi.fn().mockReturnValue({
          mutationKey: ['ttnSettings', 'provision'],
          mutationFn: provisionMutateMock,
        }),
      },
      startFresh: {
        mutationOptions: vi.fn().mockReturnValue({
          mutationKey: ['ttnSettings', 'startFresh'],
          mutationFn: startFreshMutateMock,
        }),
      },
      deepClean: {
        mutationOptions: vi.fn().mockReturnValue({
          mutationKey: ['ttnSettings', 'deepClean'],
          mutationFn: deepCleanMutateMock,
        }),
      },
    },
  }),
}));
```

IMPORTANT: This file uses a static mock at module level (lines 51-92) with vi.hoisted mocks for refetch/mutate functions. You'll need to update the static mock structure to use queryOptions/mutationOptions, while keeping the vi.hoisted mocks for the actual function implementations.

Update ALL 21 test cases across the describe blocks:

- Rendering (4 tests)
- Status Badges (3 tests)
- Action Buttons (5 tests)
- Error Handling (4 tests)
- Permissions (2 tests)
- TTN Console Link (2 tests)
- Provisioning Step Tracker (2 tests - 1 was originally listed but there are 2)
  </action>
  <verify>
  Run: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- src/components/settings/__tests__/TTNCredentialsPanel.test.tsx`
  All 21 tests should pass.
  </verify>
  <done>
  All 21 tests in TTNCredentialsPanel.test.tsx pass without `queryOptions is not a function` errors.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Verify full frontend test suite passes</name>
  <files>-</files>
  <action>
1. Run the full frontend test suite:
   `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test`

2. Verify all 38 previously-failing tests now pass:
   - useSites.test.tsx: 6 tests (fixed in 38-01)
   - useAlerts.test.tsx: 11 tests (fixed in this plan)
   - TTNCredentialsPanel.test.tsx: 21 tests (fixed in this plan)
     Total: 38 tests

3. If any tests still fail with queryOptions errors, fix them.

4. Document final test counts in the summary.
   </action>
   <verify>
   Run: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|✓|✗)" | head -50`
   All frontend test files should pass.
   </verify>
   <done>

- All frontend tests pass
- Zero `queryOptions is not a function` errors remain
- Phase 38 success criteria achieved
  </done>
  </task>

</tasks>

<verification>
- [ ] `src/hooks/__tests__/useAlerts.test.tsx` passes all 11 tests
- [ ] `src/components/settings/__tests__/TTNCredentialsPanel.test.tsx` passes all 21 tests
- [ ] Full frontend test suite passes with no queryOptions errors
- [ ] Phase 38 success criteria #1 achieved: "All 38 frontend tests pass without queryOptions errors"
</verification>

<success_criteria>

1. All 32 remaining frontend test failures resolved
2. Full frontend test suite green
3. Phase 38 can be marked complete
   </success_criteria>

<output>
After completion, create `.planning/phases/38-test-infrastructure/38-03-SUMMARY.md`
</output>
