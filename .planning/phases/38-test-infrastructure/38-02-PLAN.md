---
phase: 38-test-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/services/queue.service.test.ts
  - backend/tests/mocks/bullmq.mock.ts
  - backend/tests/setup.ts
autonomous: true

must_haves:
  truths:
    - "All 22 backend queue.service tests pass without requiring real Redis"
    - "BullMQ/Redis is properly mocked for unit testing"
    - "Tests remain useful for verifying queue service behavior"
  artifacts:
    - path: "backend/tests/mocks/bullmq.mock.ts"
      provides: "BullMQ mock implementation for testing"
      exports: ["MockQueue", "MockWorker"]
    - path: "backend/tests/services/queue.service.test.ts"
      provides: "Queue service tests with mocked BullMQ"
      contains: "vi.mock"
  key_links:
    - from: "backend/tests/mocks/bullmq.mock.ts"
      to: "backend/tests/services/queue.service.test.ts"
      via: "vi.mock('bullmq')"
      pattern: "MockQueue"
---

<objective>
Fix backend queue.service.test.ts to run without requiring a live Redis connection.

Purpose: The current tests are integration tests that fail without Redis. Converting to unit tests with mocked BullMQ allows tests to run in CI and verify queue service logic without infrastructure dependencies.

Output: Mocked BullMQ tests that verify QueueService initialization, job addition, queue retrieval, and shutdown behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md

# Key files to understand the service
@backend/tests/services/queue.service.test.ts
@backend/src/services/queue.service.ts
@backend/src/jobs/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BullMQ mock module</name>
  <files>backend/tests/mocks/bullmq.mock.ts</files>
  <action>
Create a mock module for BullMQ that simulates Queue and Worker behavior without Redis.

The mock must support:

1. **MockQueue class** that:
   - Has a `name` property
   - Has an `add(jobName, data, opts?)` method that returns a mock job with an `id`
   - Has `getJobCounts()` that returns `{ waiting: 0, active: 0, completed: 0, failed: 0, delayed: 0 }`
   - Has `drain()` that returns Promise<void>
   - Has `close()` that returns Promise<void>
   - Stores added jobs in memory for verification

2. **MockWorker class** that:
   - Accepts a queue name and processor function
   - Has `close()` that returns Promise<void>
   - Does not actually process jobs (just stores the processor)

3. **MockQueueEvents class** that:
   - Has `close()` that returns Promise<void>

Example structure:
```typescript
export class MockQueue {
  name: string;
  private jobs: Map<string, { id: string; name: string; data: unknown }> = new Map();
  private jobCounter = 0;

  constructor(name: string, opts?: unknown) {
    this.name = name;
  }

  async add(jobName: string, data: unknown, opts?: { delay?: number }) {
    const id = `job-${++this.jobCounter}`;
    this.jobs.set(id, { id, name: jobName, data });
    return { id };
  }

  async getJobCounts() {
    return { waiting: this.jobs.size, active: 0, completed: 0, failed: 0, delayed: 0 };
  }

  async drain() {
    this.jobs.clear();
  }

  async close() {
    // No-op for tests
  }
}
```

Export all mock classes for use in tests.
  </action>
  <verify>
Run: `npx tsc --noEmit backend/tests/mocks/bullmq.mock.ts` - should have no type errors
  </verify>
  <done>
File exists at `backend/tests/mocks/bullmq.mock.ts` with `MockQueue`, `MockWorker`, and `MockQueueEvents` exports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor queue.service.test.ts to use mocks</name>
  <files>backend/tests/services/queue.service.test.ts</files>
  <action>
Refactor the test file to use mocked BullMQ instead of requiring real Redis.

Changes needed:

1. **Add vi.mock at top of file** (before any imports):
```typescript
import { vi, describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import { MockQueue, MockWorker, MockQueueEvents } from '../mocks/bullmq.mock.js';

vi.mock('bullmq', () => ({
  Queue: MockQueue,
  Worker: MockWorker,
  QueueEvents: MockQueueEvents,
}));
```

2. **Remove Redis env var setup** from `beforeAll`:
   - Delete lines 23-25 that set `REDIS_HOST` and `REDIS_PORT`
   - The mocked BullMQ doesn't need Redis connection

3. **Update test expectations** to match mock behavior:
   - `isRedisEnabled()` should still return true (service thinks it's connected)
   - Job IDs will be `job-1`, `job-2` format from mock
   - `getJobCounts()` returns mock values

4. **Adjust the "without Redis" test** at the bottom:
   - This test can remain as-is since it tests the service's graceful degradation
   - The mock doesn't need Redis env vars, but the service logic being tested does

5. **Keep the test structure** (describe blocks, test cases) - just update assertions as needed

The tests should verify:
- QueueService initializes without errors
- Queues are registered (SMS, Email, Meter)
- Jobs can be added (returns job ID)
- Delayed jobs can be added
- Queue retrieval works
- Unknown queues return undefined
- getAllQueues returns expected count
- Job counts can be retrieved
- Queue drain works
- Service handles missing Redis config gracefully
  </action>
  <verify>
Run: `cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npm test -- tests/services/queue.service.test.ts`
All tests should pass without Redis connection errors.
  </verify>
  <done>
All queue.service.test.ts tests pass without requiring Redis:
- "initialization" tests pass
- "addJob" tests pass
- "getQueue" tests pass
- "getAllQueues" tests pass
- "queue operations" tests pass
- "without Redis" test passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full backend test suite and document pattern</name>
  <files>backend/tests/setup.ts</files>
  <action>
1. Run the full backend test suite to verify no regressions:
   `cd backend && npm test`

2. Add documentation to `backend/tests/setup.ts` about the BullMQ mocking pattern:

```typescript
/**
 * BullMQ/Redis Test Mocking Pattern
 *
 * Queue service tests use mocked BullMQ to avoid Redis dependency.
 * Mock is in: tests/mocks/bullmq.mock.ts
 *
 * Usage:
 * ```
 * vi.mock('bullmq', () => ({
 *   Queue: MockQueue,
 *   Worker: MockWorker,
 *   QueueEvents: MockQueueEvents,
 * }));
 * ```
 *
 * The mock provides in-memory queue simulation for testing:
 * - Jobs are stored in memory, not Redis
 * - Job IDs are deterministic (job-1, job-2, etc.)
 * - No actual job processing occurs
 *
 * For integration tests requiring real Redis, use docker compose:
 * `docker compose up redis -d`
 */
```

3. If there are any other Redis-dependent tests, note them in the summary.
  </action>
  <verify>
Run: `cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npm test 2>&1 | tail -20`
Should show test summary with 1000+ tests passing.
  </verify>
  <done>
- Backend test suite runs successfully
- BullMQ mock pattern documented in setup.ts
- Queue service tests pass without Redis dependency
  </done>
</task>

</tasks>

<verification>
- [ ] `backend/tests/mocks/bullmq.mock.ts` exists with `MockQueue`, `MockWorker`, `MockQueueEvents` exports
- [ ] `backend/tests/services/queue.service.test.ts` passes all tests without Redis
- [ ] Mock pattern documented in `backend/tests/setup.ts`
- [ ] Full backend test suite still passes (1000+ tests)
</verification>

<success_criteria>
1. All 22 queue.service tests pass without requiring Redis
2. Backend test suite remains green (1050+ tests)
3. BullMQ mock is reusable for any future queue-related tests
</success_criteria>

<output>
After completion, create `.planning/phases/38-test-infrastructure/38-02-SUMMARY.md`
</output>
