---
phase: 53-backend-api-tests
plan: 02
type: execute
---

<objective>
Fix 5 readings ingest tests (REST-only, no tRPC equivalent) and remove 3 duplicate query tests from `tests/api/readings.test.ts`. The ingest tests require the socket plugin mock pattern from Phase 52 to provide `sensorStreamService` and `socketService` on the Fastify instance.

Purpose: Eliminate all 8 skipped readings tests — fix the 5 unique ingest tests, delete the 3 query duplicates
Output: readings.test.ts with 11 passing tests (6 existing + 5 fixed), 0 skipped, 0 failed
</objective>

<execution_context>
Read file: .planning/phases/53-backend-api-tests/53-RESEARCH.md
Read file: .planning/phases/52-backend-ttn-webhook-tests/52-01-SUMMARY.md
</execution_context>

<context>
Read file: .planning/PROJECT.md
Read file: .planning/ROADMAP.md
Read file: .planning/STATE.md
Read file: .planning/phases/53-backend-api-tests/53-RESEARCH.md

**Prior decisions affecting this phase:**
- Phase 52: Socket plugin mock uses `Symbol.for('skip-override')` pattern to bypass `fastify-plugin` decorator propagation
- Phase 52: Mock provides `sensorStreamService` (addReading, getLatestReading, stop) and `socketService` (emitToOrg, joinOrganization, etc.)

**Key context from research:**
- `backend/tests/api/readings.test.ts` has 6 passing + 8 skipped tests
- 5 of 8 skipped tests are for the **ingest** endpoint (`POST /api/ingest/readings`) — REST-only, NO tRPC equivalent
- 3 of 8 skipped tests are query tests duplicated by `tests/trpc/readings.router.test.ts` (8 passing)
- Ingest tests fail with "sensorStreamService is undefined" — same root cause as Phase 52 TTN webhooks
- The readings ingest route calls `request.server.sensorStreamService.addReading()` (line 60) and `request.server.socketService` (line 96)

**Socket plugin mock pattern (from Phase 52 TTN webhook tests):**
```typescript
vi.mock('../../src/plugins/socket.plugin.js', () => {
  return {
    default: Object.assign(
      async function socketPlugin(fastify: any) {
        fastify.decorate('io', {});
        fastify.decorate('socketService', { emitToOrg: mockEmitToOrg, ... });
        fastify.decorate('sensorStreamService', { addReading: mockAddReading, ... });
      },
      { [Symbol.for('skip-override')]: true }
    ),
  };
});
```

Relevant source files:
Read file: backend/tests/api/readings.test.ts
Read file: backend/tests/trpc/readings.router.test.ts
Read file: backend/src/routes/readings.ts
Read file: backend/tests/api/ttn-webhooks.test.ts (for socket plugin mock reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add socket plugin mock and fix 5 ingest tests</name>
  <files>backend/tests/api/readings.test.ts</files>
  <action>
1. Add the socket plugin mock at the top of the file (after existing vi.mock calls), using the EXACT pattern from `backend/tests/api/ttn-webhooks.test.ts`:
   - Create mock functions: mockAddReading, mockGetLatestReading, mockStop, mockEmitToOrg, mockInitialize, mockShutdown
   - vi.mock('../../src/plugins/socket.plugin.js', ...) with Symbol.for('skip-override')
   - Decorate fastify with io, socketService, sensorStreamService

2. Remove `.skip` from the 5 ingest test cases (lines ~167, ~237, ~241, ~245, ~249):
   - "should return 200 with valid API key" (ingest)
   - "should insert single reading successfully"
   - "should insert multiple readings successfully"
   - "should return correct insertedCount and readingIds"
   - "should trigger alert when temperature above threshold"

3. Implement the test bodies for the 5 ingest tests. Each test should:
   - Use `app.inject({ method: 'POST', url: '/api/ingest/readings', ... })` with API key auth header
   - Mock the readings service (createReadings or equivalent) to return expected data
   - Assert HTTP 200 response status
   - Assert response body contains expected fields (insertedCount, readingIds)
   - For the alert test: mock alert evaluation to return triggered alert

4. DO NOT touch the 6 existing passing tests — they work as-is.

5. The ingest route uses API key authentication (X-API-Key header), NOT JWT. Check the route source to confirm the exact header name and validation logic.

IMPORTANT: Read the actual readings.test.ts file FIRST to understand the existing test structure, mock setup, and helper functions before making changes. The existing mock patterns (readings.service.js mock, buildApp usage) must be preserved.
  </action>
  <verify>
1. `cd backend && npx vitest run tests/api/readings.test.ts` shows 11 passed (6 existing + 5 fixed), 0 skipped, 0 failed
2. grep -c 'it\.skip\|test\.skip' backend/tests/api/readings.test.ts returns 0
  </verify>
  <done>5 ingest tests pass with socket plugin mock, 6 existing tests still pass, 0 skipped tests remain</done>
</task>

<task type="auto">
  <name>Task 2: Remove 3 duplicate query tests</name>
  <files>backend/tests/api/readings.test.ts</files>
  <action>
Remove the 3 skipped query test cases that duplicate passing tRPC tests (lines ~284, ~288, ~292):
- "should return 200 with valid JWT" (query) — duplicated by readings.router.test.ts "should list readings for unit with pagination"
- "should support pagination with limit and offset" — duplicated by "should calculate offset from page correctly"
- "should filter by start and end time" — duplicated by "should list readings with date range filters"

Delete the entire `it.skip(...)` blocks for these 3 tests. If they are inside a describe block that becomes empty after deletion, remove the empty describe block too.

DO NOT remove any passing tests or modify any other test content.
  </action>
  <verify>
1. `cd backend && npx vitest run tests/api/readings.test.ts` shows all remaining tests pass, 0 skipped
2. grep -c 'it\.skip\|test\.skip' backend/tests/api/readings.test.ts returns 0
3. `cd backend && npx vitest run tests/trpc/readings.router.test.ts` still shows 8 passed (query coverage preserved)
  </verify>
  <done>3 duplicate query tests removed, 0 skipped tests remain in readings.test.ts, tRPC readings tests still pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd backend && npx vitest run tests/api/readings.test.ts` — all tests pass, 0 skipped
- [ ] `cd backend && npx vitest run tests/trpc/readings.router.test.ts` — 8 passed, 0 skipped (query coverage preserved)
- [ ] grep for `.skip` in readings.test.ts returns 0 matches
- [ ] `cd backend && npx vitest run` — no regression in broader test suite
- [ ] Ingest tests verify: API key auth, single reading insert, multiple readings insert, response shape, alert triggering
</verification>

<success_criteria>
- readings.test.ts has 0 skipped tests
- 5 ingest tests pass with socket plugin mock (covering REST-only ingest endpoint)
- 6 existing passing tests unaffected
- 3 duplicate query tests removed (coverage preserved in tRPC file)
- Reading ingestion, pagination, and time-based filtering all tested (across REST + tRPC files)
- No regression in broader backend test suite
</success_criteria>

<must_haves>
- Zero `it.skip()` or `it.todo()` markers in readings.test.ts
- Socket plugin mock uses `Symbol.for('skip-override')` pattern (same as Phase 52)
- All ingest tests use API key authentication (not JWT)
- `sensorStreamService.addReading` is properly mocked and called
- tRPC readings tests (8) still pass unchanged
</must_haves>

<output>
After completion, create `.planning/phases/53-backend-api-tests/53-02-SUMMARY.md`
</output>
