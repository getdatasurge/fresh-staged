---
phase: 53-backend-api-tests
plan: 01
type: execute
---

<objective>
Eliminate all 14 skipped alert API tests by deleting the duplicate `tests/api/alerts.test.ts` file. The tRPC test file (`tests/trpc/alerts.router.test.ts`) already has 19 passing tests covering every scenario in the REST file plus additional role-based and filter coverage.

Purpose: Remove duplicate test file that creates 14 false skips without losing any coverage
Output: alerts.test.ts deleted, backend test suite shows -14 skipped, -5 passing (all duplicated)
</objective>

<execution_context>
Read file: .planning/phases/53-backend-api-tests/53-RESEARCH.md
</execution_context>

<context>
Read file: .planning/PROJECT.md
Read file: .planning/ROADMAP.md
Read file: .planning/STATE.md
Read file: .planning/phases/53-backend-api-tests/53-RESEARCH.md

**Prior decisions affecting this phase:**
- Phase 52: Established the pattern of consolidating duplicate test files rather than implementing skipped tests when coverage already exists elsewhere
- TTN webhook tests: consolidated via content replacement (routes -> api), not merge

**Key context from research:**
- `backend/tests/api/alerts.test.ts` has 5 passing + 14 skipped tests
- `backend/tests/trpc/alerts.router.test.ts` has 19 passing + 0 skipped tests
- Every one of the 14 skipped REST tests has an EXACT or EQUIVALENT match in the tRPC file
- The 5 passing REST tests are also covered by tRPC tests (except "401 without JWT" which tests auth middleware, not alerts)
- Root cause of skips: Fastify response serialization with mocks (Zod schema + fast-json-stringify incompatibility)

Relevant source files:
Read file: backend/tests/api/alerts.test.ts
Read file: backend/tests/trpc/alerts.router.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete duplicate alerts REST test file</name>
  <files>backend/tests/api/alerts.test.ts</files>
  <action>Delete `backend/tests/api/alerts.test.ts` entirely. This file has 14 skipped tests that are all duplicated by the passing tRPC test file. The 5 passing tests are also duplicated (status filter, severity filter, unitId filter, pagination are all in the tRPC file; "401 without JWT" tests auth middleware which is tested separately). DO NOT attempt to fix the skipped tests — the research confirmed 100% coverage overlap with the tRPC version.</action>
  <verify>
1. `ls backend/tests/api/alerts.test.ts` returns "No such file"
2. `cd backend && npx vitest run tests/trpc/alerts.router.test.ts` shows 19 passed, 0 skipped
3. `cd backend && npx vitest run` completes without errors referencing alerts.test.ts
  </verify>
  <done>alerts.test.ts deleted, tRPC alert tests still pass (19/19), no import/reference errors</done>
</task>

<task type="auto">
  <name>Task 2: Verify alert coverage preserved</name>
  <files>None (verification only)</files>
  <action>Run the full tRPC alerts test suite and verify it covers the alert lifecycle: list alerts (with filters), get alert by ID, acknowledge alert (role-based), resolve alert (role-based), conflict handling. Compare against the ROADMAP success criteria for ALERT-02: "Alert lifecycle (list, acknowledge, resolve) is tested through the API layer with correct status transitions."</action>
  <verify>
1. `cd backend && npx vitest run tests/trpc/alerts.router.test.ts` shows 19 passed, 0 failed, 0 skipped
2. Test names cover: list, get, acknowledge (staff/manager/admin/owner), resolve (staff/manager), forbidden (viewer), not found, conflict (already acknowledged)
  </verify>
  <done>19 tRPC alert tests pass, covering full alert lifecycle (list, get, acknowledge, resolve) with role-based access control and error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `backend/tests/api/alerts.test.ts` does not exist
- [ ] `cd backend && npx vitest run tests/trpc/alerts.router.test.ts` — 19 passed, 0 skipped, 0 failed
- [ ] `cd backend && npx vitest run` — no regression (no new failures introduced)
- [ ] grep for `alerts.test.ts` in any import/config file returns no references
</verification>

<success_criteria>
- alerts.test.ts deleted (14 skipped tests eliminated)
- tRPC alerts test suite (19 tests) still passes
- Alert lifecycle fully covered: list, acknowledge, resolve with role checks
- No regression in broader backend test suite
</success_criteria>

<must_haves>
- Zero `it.skip()` or `it.todo()` markers remain in any alert test file
- `alerts.router.test.ts` passes 19 tests covering list, get, acknowledge, resolve
- No file references to the deleted `alerts.test.ts`
- Backend test suite runs without errors related to alert tests
</must_haves>

<output>
After completion, create `.planning/phases/53-backend-api-tests/53-01-SUMMARY.md`
</output>
