---
phase: 09-production-environment-hardening
plan: 03
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - docker/compose.selfhosted.yaml
  - docker/compose.digitalocean.yaml
autonomous: true

must_haves:
  truths:
    - "Self-hosted deployment uses localhost-only port bindings for internal services"
    - "DigitalOcean deployment can use managed database connection string"
    - "Both overlays reference secrets from Infisical paths"
  artifacts:
    - path: "docker/compose.selfhosted.yaml"
      provides: "Self-hosted VM specific configuration"
      contains: "127.0.0.1:"
    - path: "docker/compose.digitalocean.yaml"
      provides: "DigitalOcean Droplet specific configuration"
      contains: "digitalocean"
  key_links:
    - from: "docker/compose.selfhosted.yaml"
      to: "docker/compose.prod.yaml"
      via: "Extends production base"
      pattern: "secrets:"
---

<objective>
Create deployment target-specific Docker Compose overlays for self-hosted VMs and DigitalOcean Droplets.

Purpose: Different deployment targets have different security requirements and infrastructure options. Self-hosted needs all services locally; DigitalOcean can use managed PostgreSQL. Both need secrets from Infisical and appropriate network security.

Output: Two deployment-specific overlays that layer on top of base + production configs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-CONTEXT.md
@.planning/phases/09-production-environment-hardening/09-RESEARCH.md
@docker/docker-compose.yml
@docker/compose.prod.yaml (created in 09-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Self-Hosted Deployment Overlay</name>
  <files>docker/compose.selfhosted.yaml</files>
  <action>
Create `docker/compose.selfhosted.yaml` for self-hosted VM deployments:

**Header comment:**
```yaml
# FreshTrack Pro Self-Hosted Deployment Overlay
# Usage: docker compose -f docker-compose.yml -f compose.prod.yaml -f compose.selfhosted.yaml up -d
#
# Self-hosted specific settings:
# - Localhost-only bindings for internal services
# - Secrets from Infisical file mounts
# - All services run locally (no managed services)
```

**Security: Localhost-only port bindings for internal services:**
```yaml
services:
  postgres:
    ports:
      - "127.0.0.1:5432:5432"

  pgbouncer:
    ports:
      - "127.0.0.1:6432:6432"

  redis:
    ports:
      - "127.0.0.1:6379:6379"

  minio:
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"  # MinIO console
```

**Secrets configuration using Docker secrets with file sources:**
```yaml
services:
  postgres:
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password

  pgbouncer:
    environment:
      POSTGRESQL_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password

  backend:
    environment:
      DATABASE_URL_FILE: /run/secrets/database_url
      STACK_AUTH_SECRET_KEY_FILE: /run/secrets/stack_auth_secret
    secrets:
      - database_url
      - stack_auth_secret

secrets:
  postgres_password:
    file: /var/infisical/secrets/postgres_password
  database_url:
    file: /var/infisical/secrets/database_url
  stack_auth_secret:
    file: /var/infisical/secrets/stack_auth_secret
```

**Note:** The `/var/infisical/secrets/` path is where Infisical Agent exports secrets as files. This will be documented in Phase 11 deployment.

**Caddy external access:**
Only Caddy (reverse proxy) should be accessible externally:
```yaml
services:
  caddy:
    ports:
      - "80:80"
      - "443:443"
```
  </action>
  <verify>
```bash
# Check localhost bindings exist
grep -c "127.0.0.1:" docker/compose.selfhosted.yaml

# Validate syntax with full stack
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.selfhosted.yaml config --quiet && echo "Config valid"
```
  </verify>
  <done>compose.selfhosted.yaml exists with localhost-only port bindings and secrets configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create DigitalOcean Deployment Overlay</name>
  <files>docker/compose.digitalocean.yaml</files>
  <action>
Create `docker/compose.digitalocean.yaml` for DigitalOcean Droplet deployments:

**Header comment:**
```yaml
# FreshTrack Pro DigitalOcean Deployment Overlay
# Usage: docker compose -f docker-compose.yml -f compose.prod.yaml -f compose.digitalocean.yaml up -d
#
# DigitalOcean specific settings:
# - Option to use DO Managed PostgreSQL (comment out local postgres)
# - Secrets from Infisical file mounts
# - DigitalOcean Spaces for MinIO (optional)
# - Reduced resource limits for smaller Droplets
```

**Managed PostgreSQL option (documented but commented):**
```yaml
# To use DigitalOcean Managed PostgreSQL:
# 1. Comment out postgres and pgbouncer services in docker-compose.yml
# 2. Set DATABASE_URL to your managed PostgreSQL connection string
# 3. Ensure SSL mode is enabled (sslmode=require)

services:
  # Override postgres for DO Droplet (smaller limits)
  postgres:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1GB
        reservations:
          cpus: '0.5'
          memory: 512MB
    ports:
      - "127.0.0.1:5432:5432"

  # Override backend with DO-specific settings
  backend:
    environment:
      # For managed PostgreSQL, use:
      # DATABASE_URL_FILE: /run/secrets/do_database_url
      DATABASE_URL_FILE: /run/secrets/database_url
      STACK_AUTH_SECRET_KEY_FILE: /run/secrets/stack_auth_secret
    secrets:
      - database_url
      - stack_auth_secret
      # - do_database_url  # Uncomment for managed PostgreSQL
```

**Reduced resource limits for smaller Droplets:**
Override some limits from compose.prod.yaml for Basic Droplet (4GB RAM):
```yaml
  redis:
    deploy:
      resources:
        limits:
          memory: 512MB
        reservations:
          memory: 256MB

  minio:
    deploy:
      resources:
        limits:
          memory: 1GB
        reservations:
          memory: 512MB
```

**Secrets configuration (same pattern as self-hosted):**
```yaml
secrets:
  postgres_password:
    file: /var/infisical/secrets/postgres_password
  database_url:
    file: /var/infisical/secrets/database_url
  stack_auth_secret:
    file: /var/infisical/secrets/stack_auth_secret
  # do_database_url:
  #   file: /var/infisical/secrets/do_database_url
```

**Network notes (comment in file):**
```yaml
# DigitalOcean private networking:
# If using DO VPC, services can communicate over private IPs.
# Managed PostgreSQL is accessed via private network when in same VPC.
```
  </action>
  <verify>
```bash
# Check file exists
test -f docker/compose.digitalocean.yaml && echo "File exists"

# Validate syntax with full stack
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.digitalocean.yaml config --quiet && echo "Config valid"
```
  </verify>
  <done>compose.digitalocean.yaml exists with DO-specific settings and reduced resource limits</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Validate both overlays:
```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.selfhosted.yaml config --quiet && echo "Self-hosted: VALID"
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.digitalocean.yaml config --quiet && echo "DigitalOcean: VALID"
```

2. Verify localhost bindings in self-hosted:
```bash
grep -E "127\.0\.0\.1:" docker/compose.selfhosted.yaml | wc -l
```

3. Check secrets defined:
```bash
grep -A5 "^secrets:" docker/compose.selfhosted.yaml
grep -A5 "^secrets:" docker/compose.digitalocean.yaml
```
</verification>

<success_criteria>
- compose.selfhosted.yaml exists with localhost-only port bindings
- compose.digitalocean.yaml exists with reduced resource limits
- Both files validate with base + production overlay
- Both files define secrets section with Infisical file sources
- Documentation comments explain deployment-specific settings
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-03-SUMMARY.md`
</output>
