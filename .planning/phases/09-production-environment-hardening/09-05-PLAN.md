---
phase: 09-production-environment-hardening
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - scripts/deploy/notify.sh
  - scripts/deploy/README.md
autonomous: true

must_haves:
  truths:
    - "Deployment script can send success/failure notifications"
    - "Notifications include deployment timestamp, version, and status"
    - "Webhook URL is configurable via environment variable"
  artifacts:
    - path: "scripts/deploy/notify.sh"
      provides: "Deployment notification script"
      contains: "curl"
      min_lines: 30
    - path: "scripts/deploy/README.md"
      provides: "Documentation for webhook configuration"
      contains: "DEPLOY_WEBHOOK_URL"
  key_links:
    - from: "scripts/deploy/notify.sh"
      to: "deployment workflow"
      via: "called by deployment scripts with status argument"
      pattern: "./notify\\.sh (success|failure)"
---

<objective>
Create deployment notification infrastructure that sends success/failure alerts via webhook (Slack, Discord, or generic HTTP endpoint).

Purpose: HARD-06 requires deployment notifications on success/failure. Notifications enable ops awareness without constant monitoring, and provide an audit trail of deployments.

**Note:** This plan creates the notification infrastructure (notify.sh script). Integration with actual deployment scripts (calling notify.sh from deployment workflows) will be completed in Phase 11 (Production Deployment).

Output: Reusable notification script and documentation for webhook configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-CONTEXT.md
@.planning/phases/09-production-environment-hardening/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Deployment Notification Script</name>
  <files>scripts/deploy/notify.sh</files>
  <action>
Create `scripts/deploy/notify.sh` that sends deployment notifications:

```bash
#!/bin/bash
# ===========================================
# FreshTrack Pro Deployment Notification
# ===========================================
# Sends deployment status notifications to configured webhook
#
# Usage:
#   ./notify.sh success "Deployment completed"
#   ./notify.sh failure "Health check failed"
#
# Environment variables:
#   DEPLOY_WEBHOOK_URL - Webhook URL (Slack, Discord, or generic)
#   DEPLOY_ENVIRONMENT - Environment name (production, staging)
#   DEPLOY_VERSION     - Version being deployed (optional)
#
# Supports:
#   - Slack webhooks (incoming webhooks)
#   - Discord webhooks (via /slack endpoint)
#   - Generic webhooks (JSON POST)

set -euo pipefail

# Arguments
STATUS="${1:-unknown}"
MESSAGE="${2:-No message provided}"

# Environment
WEBHOOK_URL="${DEPLOY_WEBHOOK_URL:-}"
ENVIRONMENT="${DEPLOY_ENVIRONMENT:-production}"
VERSION="${DEPLOY_VERSION:-$(git describe --tags --always 2>/dev/null || echo 'unknown')}"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
HOSTNAME=$(hostname -f 2>/dev/null || hostname)

# Validate
if [ -z "$WEBHOOK_URL" ]; then
  echo "Warning: DEPLOY_WEBHOOK_URL not set, skipping notification"
  exit 0
fi

# Color mapping for Slack/Discord
case "$STATUS" in
  success)
    COLOR="#36a64f"  # Green
    EMOJI=":white_check_mark:"
    ;;
  failure)
    COLOR="#dc3545"  # Red
    EMOJI=":x:"
    ;;
  warning)
    COLOR="#ffc107"  # Yellow
    EMOJI=":warning:"
    ;;
  *)
    COLOR="#6c757d"  # Gray
    EMOJI=":information_source:"
    ;;
esac

# Construct Slack-compatible payload
# (Discord webhooks accept Slack format via /slack suffix)
PAYLOAD=$(cat <<EOF
{
  "attachments": [
    {
      "color": "$COLOR",
      "title": "$EMOJI FreshTrack Pro Deployment",
      "fields": [
        {
          "title": "Status",
          "value": "$STATUS",
          "short": true
        },
        {
          "title": "Environment",
          "value": "$ENVIRONMENT",
          "short": true
        },
        {
          "title": "Version",
          "value": "$VERSION",
          "short": true
        },
        {
          "title": "Host",
          "value": "$HOSTNAME",
          "short": true
        },
        {
          "title": "Message",
          "value": "$MESSAGE",
          "short": false
        }
      ],
      "footer": "FreshTrack Pro Deployment System",
      "ts": $(date +%s)
    }
  ]
}
EOF
)

# Send notification with retry
MAX_RETRIES=3
RETRY_DELAY=5

for i in $(seq 1 $MAX_RETRIES); do
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    "$WEBHOOK_URL" || echo "000")

  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
    echo "Notification sent successfully (HTTP $HTTP_CODE)"
    exit 0
  fi

  if [ "$i" -lt "$MAX_RETRIES" ]; then
    echo "Notification failed (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
    sleep $RETRY_DELAY
    RETRY_DELAY=$((RETRY_DELAY * 2))
  fi
done

echo "Warning: Failed to send notification after $MAX_RETRIES attempts"
exit 0  # Don't fail deployment due to notification failure
```

Make the script executable.
  </action>
  <verify>
```bash
chmod +x scripts/deploy/notify.sh
test -x scripts/deploy/notify.sh && echo "Script is executable"
# Syntax check
bash -n scripts/deploy/notify.sh && echo "Syntax valid"
```
  </verify>
  <done>notify.sh exists, is executable, and passes syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Create Notification Configuration Documentation</name>
  <files>scripts/deploy/README.md</files>
  <action>
Create `scripts/deploy/README.md` documenting notification setup:

```markdown
# Deployment Scripts

## Notification Setup

The deployment notification script supports Slack, Discord, and generic webhook endpoints.

### Configuration

Set the following environment variables:

| Variable | Required | Description |
|----------|----------|-------------|
| `DEPLOY_WEBHOOK_URL` | Yes | Webhook URL for notifications |
| `DEPLOY_ENVIRONMENT` | No | Environment name (default: production) |
| `DEPLOY_VERSION` | No | Version being deployed (auto-detected from git) |

### Slack Setup

1. Go to your Slack workspace settings
2. Navigate to "Apps" > "Incoming Webhooks"
3. Create a new webhook for your deployment channel
4. Copy the webhook URL:
   ```bash
   export DEPLOY_WEBHOOK_URL="https://hooks.slack.com/services/T00/B00/XXX"
   ```

### Discord Setup

1. Open Discord server settings
2. Navigate to "Integrations" > "Webhooks"
3. Create a new webhook for your deployment channel
4. Copy the webhook URL and append `/slack`:
   ```bash
   export DEPLOY_WEBHOOK_URL="https://discord.com/api/webhooks/XXX/YYY/slack"
   ```

### Generic Webhook

For custom endpoints, the script sends a JSON payload:

```json
{
  "attachments": [{
    "color": "#36a64f",
    "title": "FreshTrack Pro Deployment",
    "fields": [
      {"title": "Status", "value": "success"},
      {"title": "Environment", "value": "production"},
      {"title": "Version", "value": "v1.2.3"},
      {"title": "Host", "value": "prod-server-1"},
      {"title": "Message", "value": "Deployment completed"}
    ]
  }]
}
```

### Usage

```bash
# Success notification
./notify.sh success "Deployment completed successfully"

# Failure notification
./notify.sh failure "Health check failed after 3 retries"

# Warning notification
./notify.sh warning "Deployment completed with warnings"
```

### Integration with Deployment

Add notifications to your deployment script:

```bash
#!/bin/bash

# At the start
./scripts/deploy/notify.sh info "Starting deployment..."

# Deploy
docker compose ... up -d

# After health checks
if health_check_passes; then
  ./scripts/deploy/notify.sh success "Deployment completed"
else
  ./scripts/deploy/notify.sh failure "Health check failed"
  exit 1
fi
```
```
  </action>
  <verify>
```bash
test -f scripts/deploy/README.md && echo "README exists"
grep -q "DEPLOY_WEBHOOK_URL" scripts/deploy/README.md && echo "Documents webhook URL"
```
  </verify>
  <done>README.md documents notification setup for Slack, Discord, and generic webhooks</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Check script exists and is executable:
```bash
test -x scripts/deploy/notify.sh && echo "Script executable"
```

2. Validate script syntax:
```bash
bash -n scripts/deploy/notify.sh && echo "Syntax valid"
```

3. Check documentation exists:
```bash
test -f scripts/deploy/README.md && echo "README exists"
```

4. Test dry run (without webhook URL):
```bash
DEPLOY_WEBHOOK_URL="" ./scripts/deploy/notify.sh success "Test message"
# Should print warning and exit 0
```
</verification>

<success_criteria>
- scripts/deploy/notify.sh is executable and passes syntax check
- Script supports success, failure, warning status types
- Script has retry logic (3 attempts with exponential backoff)
- Script gracefully handles missing webhook URL
- README.md documents Slack, Discord, and generic webhook setup
- JSON payload includes status, environment, version, host, message, and timestamp
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-05-SUMMARY.md`
</output>
