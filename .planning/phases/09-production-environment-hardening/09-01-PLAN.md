---
phase: 09-production-environment-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/infisical/docker-compose.infisical.yml
  - docker/infisical/infisical.env.example
  - scripts/dev/setup-infisical.sh
autonomous: true

must_haves:
  truths:
    - 'Infisical stack configuration is valid and deployable'
    - 'Infisical services have health checks for production reliability'
    - 'Infisical PostgreSQL data persists via named Docker volume'
  artifacts:
    - path: 'docker/infisical/docker-compose.infisical.yml'
      provides: 'Self-hosted Infisical secrets manager stack'
      contains: 'infisical:'
    - path: 'docker/infisical/infisical.env.example'
      provides: 'Environment template for Infisical deployment'
      contains: 'INFISICAL_ENCRYPTION_KEY'
    - path: 'scripts/dev/setup-infisical.sh'
      provides: 'Setup script to initialize Infisical stack'
      contains: 'docker compose'
  key_links:
    - from: 'docker/infisical/docker-compose.infisical.yml'
      to: 'postgres container'
      via: 'depends_on with service_healthy'
      pattern: 'condition: service_healthy'
---

<objective>
Set up self-hosted Infisical secrets manager as a separate Docker Compose stack for centralized credentials management.

Purpose: Infisical provides centralized secrets management with rotation capabilities, audit logs, and web UI. Running as a separate stack allows independent lifecycle management and ensures secrets are available before application services start.

Output: Infisical Docker Compose stack ready for production secrets management
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-CONTEXT.md
@.planning/phases/09-production-environment-hardening/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Infisical Docker Compose Stack</name>
  <files>docker/infisical/docker-compose.infisical.yml</files>
  <action>
Create a dedicated Docker Compose file for the Infisical secrets manager stack:

1. Create `docker/infisical/docker-compose.infisical.yml` with:
   - `infisical-db`: PostgreSQL 15 for Infisical data
     - Volume: `infisical_db_data`
     - Health check: `pg_isready -U infisical`
     - Resource limits: 512MB memory, 0.5 CPU
   - `infisical-redis`: Redis 7 for Infisical caching
     - Volume: `infisical_redis_data`
     - Health check: `redis-cli ping`
     - Resource limits: 256MB memory, 0.25 CPU
   - `infisical`: Main Infisical service
     - Image: `infisical/infisical:latest-postgres`
     - Depends on: db and redis with `service_healthy`
     - Ports: `8080:8080` (web UI)
     - Environment variables from `.env` file:
       - `DB_CONNECTION_URI`: postgresql connection to infisical-db
       - `REDIS_URL`: redis connection to infisical-redis
       - `ENCRYPTION_KEY`: 32-byte hex key (generate with `openssl rand -hex 32`)
       - `AUTH_SECRET`: 32-byte hex key for JWT signing
       - `SITE_URL`: http://localhost:8080
     - Health check: `curl -f http://localhost:8080/api/status`
     - Resource limits: 1GB memory, 1.0 CPU

2. Use network `frostguard_infisical_network` (separate from main app network)

3. Define volumes:
   - `infisical_db_data`
   - `infisical_redis_data`

Reference Infisical docker-compose.prod.yml pattern from research but adapt for self-hosted use.
</action>
<verify>
Validate compose file syntax:

```bash
docker compose -f docker/infisical/docker-compose.infisical.yml config
```

  </verify>
  <done>docker-compose.infisical.yml exists and passes config validation</done>
</task>

<task type="auto">
  <name>Task 2: Create Infisical Environment Template</name>
  <files>docker/infisical/infisical.env.example</files>
  <action>
Create an environment template file with documentation:

1. Create `docker/infisical/infisical.env.example`:

```env
# Infisical Secrets Manager Configuration
# Copy to .env and fill in values before starting

# ===========================================
# Database Configuration
# ===========================================
INFISICAL_DB_USER=infisical
INFISICAL_DB_PASSWORD=<generate-secure-password>
INFISICAL_DB_NAME=infisical

# ===========================================
# Security Keys (REQUIRED - Generate unique keys)
# ===========================================
# Generate with: openssl rand -hex 32
INFISICAL_ENCRYPTION_KEY=<32-byte-hex-key>
INFISICAL_AUTH_SECRET=<32-byte-hex-key>

# ===========================================
# Site Configuration
# ===========================================
INFISICAL_SITE_URL=http://localhost:8080

# For production, use HTTPS:
# INFISICAL_SITE_URL=https://secrets.yourdomain.com
```

2. Include instructions for generating secure keys at the top of the file
   </action>
   <verify>

```bash
test -f docker/infisical/infisical.env.example && echo "Template exists"
grep -q "INFISICAL_ENCRYPTION_KEY" docker/infisical/infisical.env.example
```

  </verify>
  <done>infisical.env.example exists with all required variables documented</done>
</task>

<task type="auto">
  <name>Task 3: Create Infisical Setup Script</name>
  <files>scripts/dev/setup-infisical.sh</files>
  <action>
Create a setup script that initializes the Infisical stack:

1. Create `scripts/dev/setup-infisical.sh`:

```bash
#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
INFISICAL_DIR="$PROJECT_ROOT/docker/infisical"

echo "=== FreshTrack Pro: Infisical Secrets Manager Setup ==="

# Check if .env exists
if [ ! -f "$INFISICAL_DIR/.env" ]; then
  echo "Creating .env from template..."
  cp "$INFISICAL_DIR/infisical.env.example" "$INFISICAL_DIR/.env"

  # Generate secure keys
  echo "Generating secure encryption keys..."
  ENCRYPTION_KEY=$(openssl rand -hex 32)
  AUTH_SECRET=$(openssl rand -hex 32)
  DB_PASSWORD=$(openssl rand -base64 24 | tr -d '=/+')

  # Replace placeholders (works on both Linux and macOS)
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/<32-byte-hex-key>/$ENCRYPTION_KEY/; s/<32-byte-hex-key>/$AUTH_SECRET/" "$INFISICAL_DIR/.env"
    sed -i '' "s/<generate-secure-password>/$DB_PASSWORD/" "$INFISICAL_DIR/.env"
  else
    sed -i "s/<32-byte-hex-key>/$ENCRYPTION_KEY/; s/<32-byte-hex-key>/$AUTH_SECRET/" "$INFISICAL_DIR/.env"
    sed -i "s/<generate-secure-password>/$DB_PASSWORD/" "$INFISICAL_DIR/.env"
  fi

  echo "Generated .env with secure keys"
fi

# Start Infisical stack
echo "Starting Infisical stack..."
docker compose -f "$INFISICAL_DIR/docker-compose.infisical.yml" up -d

# Wait for health
echo "Waiting for Infisical to be healthy..."
timeout 60 bash -c 'until curl -sf http://localhost:8080/api/status > /dev/null 2>&1; do sleep 2; done' || {
  echo "ERROR: Infisical failed to start within 60 seconds"
  docker compose -f "$INFISICAL_DIR/docker-compose.infisical.yml" logs
  exit 1
}

echo ""
echo "=== Infisical Setup Complete ==="
echo "Web UI: http://localhost:8080"
echo "Create an admin account on first visit"
echo ""
```

2. Make the script executable
   </action>
   <verify>

```bash
chmod +x scripts/dev/setup-infisical.sh
test -x scripts/dev/setup-infisical.sh && echo "Script is executable"
```

  </verify>
  <done>setup-infisical.sh is executable and contains setup logic</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Validate compose file:

```bash
docker compose -f docker/infisical/docker-compose.infisical.yml config --quiet && echo "Compose valid"
```

2. Check all required files exist:

```bash
ls -la docker/infisical/
```

3. Optionally start the stack (if Docker available):

```bash
./scripts/dev/setup-infisical.sh
curl -s http://localhost:8080/api/status | jq .
```

</verification>

<success_criteria>

- docker/infisical/docker-compose.infisical.yml exists and is valid
- docker/infisical/infisical.env.example exists with documented variables
- scripts/dev/setup-infisical.sh is executable
- Compose file defines services: infisical-db, infisical-redis, infisical
- All services have health checks and resource limits
  </success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-01-SUMMARY.md`
</output>
