---
phase: 09-production-environment-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/compose.prod.yaml
autonomous: true

must_haves:
  truths:
    - 'All services have memory and CPU limits configured'
    - 'All services use Loki logging driver for centralized logs'
    - 'Services restart on failure with delay and max attempts'
  artifacts:
    - path: 'docker/compose.prod.yaml'
      provides: 'Production base configuration with resource limits and logging'
      contains: 'deploy:'
      min_lines: 100
  key_links:
    - from: 'docker/compose.prod.yaml'
      to: 'Loki service'
      via: 'Docker logging driver configuration'
      pattern: 'logging:\s+driver:\s+loki[\s\S]*?loki-url:\s+"http://loki:3100'
---

<objective>
Create the production base Docker Compose overlay with resource limits, restart policies, and centralized Loki logging for all services.

Purpose: Resource limits prevent runaway containers from crashing the host, restart policies enable auto-recovery, and centralized logging allows debugging through Grafana. This is the foundation for all production deployments.

Output: compose.prod.yaml overlay that can be combined with base compose and deployment-specific overlays
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-CONTEXT.md
@.planning/phases/09-production-environment-hardening/09-RESEARCH.md
@docker/docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Production Base Compose Overlay</name>
  <files>docker/compose.prod.yaml</files>
  <action>
Create `docker/compose.prod.yaml` with production-specific configurations:

**Resource Limits (based on research patterns):**

| Service    | Memory Limit | Memory Reserve | CPU Limit | CPU Reserve |
| ---------- | ------------ | -------------- | --------- | ----------- |
| postgres   | 2GB          | 1GB            | 2.0       | 1.0         |
| pgbouncer  | 256MB        | 128MB          | 0.5       | 0.25        |
| redis      | 768MB        | 512MB          | 1.0       | 0.5         |
| minio      | 2GB          | 1GB            | 1.0       | 0.5         |
| backend    | 1GB          | 512MB          | 1.0       | 0.5         |
| caddy      | 512MB        | 256MB          | 0.5       | 0.25        |
| prometheus | 1GB          | 512MB          | 0.5       | 0.25        |
| grafana    | 512MB        | 256MB          | 0.5       | 0.25        |
| loki       | 1GB          | 512MB          | 0.5       | 0.25        |
| promtail   | 256MB        | 128MB          | 0.25      | 0.1         |

**Restart Policies (all services):**

```yaml
restart_policy:
  condition: on-failure
  delay: 5s
  max_attempts: 5
  window: 120s
```

**Loki Logging Configuration:**

```yaml
logging:
  driver: loki
  options:
    loki-url: 'http://loki:3100/loki/api/v1/push'
    loki-batch-size: '400'
    loki-retries: '3'
    loki-external-labels: 'service={{.Name}},environment=production'
```

**Structure:**

1. Override each service from base docker-compose.yml
2. Add `deploy:` section with resources and restart_policy
3. Add `logging:` section for Loki integration
4. Do NOT duplicate image, ports, or other base settings (compose merges them)

**Redis-specific:**

- Add `command:` to set maxmemory (512mb) and maxmemory-policy (allkeys-lru)

**Backend-specific:**

- Target production build stage
- Can have replicas: 2 (horizontal scaling)

Include header comment explaining this is an overlay file:

```yaml
# FreshTrack Pro Production Configuration Overlay
# Usage: docker compose -f docker-compose.yml -f compose.prod.yaml up -d
#
# This overlay adds:
# - Resource limits (memory, CPU) for all services
# - Restart policies for auto-recovery
# - Loki logging driver for centralized logs
# - Production-specific settings
#
# Combine with deployment-specific overlay:
# docker compose -f docker-compose.yml -f compose.prod.yaml -f compose.selfhosted.yaml up -d
```

  </action>
  <verify>
```bash
# Validate overlay merges correctly with base
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "Config valid"

# Check resource limits are defined

grep -c "limits:" docker/compose.prod.yaml

````
  </verify>
  <done>compose.prod.yaml exists with resource limits for all services and valid compose syntax</done>
</task>

<task type="auto">
  <name>Task 2: Add Observability Services to Production Overlay</name>
  <files>docker/compose.prod.yaml</files>
  <action>
Extend `docker/compose.prod.yaml` to include observability services (Prometheus, Grafana, Loki, Promtail) with production settings.

**Add services to the overlay:**

1. **loki** service:
   - Resource limits from table above
   - Volume for data persistence
   - Health check: `wget -qO- http://localhost:3100/ready || exit 1`
   - Logging: json-file (can't send logs to itself)

2. **promtail** service (optional - only if using file-based log collection):
   - Resource limits from table above
   - Mount Docker socket for container log discovery
   - Logging: json-file

3. **prometheus** service:
   - Resource limits from table above
   - Health check: `wget -qO- http://localhost:9090/-/healthy || exit 1`
   - Logging: loki driver

4. **grafana** service:
   - Resource limits from table above
   - Health check: `curl -f http://localhost:3000/api/health || exit 1`
   - Logging: loki driver

5. **caddy** service:
   - Resource limits from table above
   - Health check: `curl -f http://localhost:80/health || exit 1` (or skip if caddy handles it differently)
   - Logging: loki driver

**Note:** These services may not be in the base docker-compose.yml yet. If they don't exist in base, include full service definitions. If they do exist, only include overrides.

Check existing base compose to determine which services need full definitions vs overrides.
  </action>
  <verify>
```bash
# Verify all expected services are defined
grep -E "^\s{2}[a-z]+:" docker/compose.prod.yaml | sort -u

# Validate merged config
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet
````

  </verify>
  <done>All observability services have resource limits, health checks, and logging configured</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Validate compose overlay syntax:

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "PASS"
```

2. Check resource limits exist for all key services:

```bash
for svc in postgres pgbouncer redis minio backend; do
  grep -A10 "^  $svc:" docker/compose.prod.yaml | grep -q "limits:" && echo "$svc: has limits" || echo "$svc: MISSING limits"
done
```

3. Verify Loki logging configured:

```bash
grep -c "loki-url" docker/compose.prod.yaml
```

</verification>

<success_criteria>

- docker/compose.prod.yaml exists and validates with base compose
- All infrastructure services (postgres, pgbouncer, redis, minio) have resource limits
- All services have restart policies configured
- Most services use Loki logging driver (except Loki itself)
- Redis has maxmemory configuration
- Backend targets production build stage
  </success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-02-SUMMARY.md`
</output>
