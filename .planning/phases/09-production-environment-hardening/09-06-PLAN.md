---
phase: 09-production-environment-hardening
plan: 06
type: execute
wave: 3
depends_on: ['09-01', '09-02', '09-03', '09-04', '09-05']
files_modified: []
autonomous: false

# Execution flow: Tasks 1-2 run automatically, then execution pauses for Task 3 (human checkpoint).
# The autonomous: false flag indicates this plan contains a checkpoint that requires user input.

must_haves:
  truths:
    - 'All compose files validate together (base + prod + target)'
    - 'Resource limits exist for all services in compose.prod.yaml'
    - 'Secrets are defined using Docker secrets pattern'
    - '.dockerignore prevents secrets from entering build context'
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 9 hardening is complete by validating compose configurations, checking resource limits, and confirming secrets exclusion patterns.

Purpose: Final verification ensures all hardening requirements are met before moving to Phase 10 (Database Production Readiness). This checkpoint catches integration issues between the layered compose files.

**Execution flow:**

1. Tasks 1-2 run automatically (validation and resource limit checks)
2. Execution pauses for Task 3 (human checkpoint)
3. User reviews results and approves or reports issues

Output: Verification report confirming all success criteria are met
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-01-SUMMARY.md
@.planning/phases/09-production-environment-hardening/09-02-SUMMARY.md
@.planning/phases/09-production-environment-hardening/09-03-SUMMARY.md
@.planning/phases/09-production-environment-hardening/09-04-SUMMARY.md
@.planning/phases/09-production-environment-hardening/09-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate All Compose Configurations</name>
  <files></files>
  <action>
Run comprehensive validation of all Docker Compose configurations:

1. **Validate base + production overlay:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet
echo "Base + Production: VALID"
```

2. **Validate self-hosted full stack:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.selfhosted.yaml config --quiet
echo "Self-hosted stack: VALID"
```

3. **Validate DigitalOcean full stack:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.digitalocean.yaml config --quiet
echo "DigitalOcean stack: VALID"
```

4. **Validate Infisical stack:**

```bash
docker compose -f docker/infisical/docker-compose.infisical.yml config --quiet
echo "Infisical stack: VALID"
```

5. **Render merged config and check key fields:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config | grep -c "limits:"
# Should be > 0
```

  </action>
  <verify>All validation commands exit with code 0</verify>
  <done>All four compose configurations validate successfully</done>
</task>

<task type="auto">
  <name>Task 2: Verify Resource Limits and Health Checks</name>
  <files></files>
  <action>
Check that all services have resource limits and health checks in production config:

1. **List services with resource limits:**

```bash
echo "=== Services with Resource Limits ==="
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config | \
  grep -B20 "limits:" | grep "^\s\+\w.*:$" | sed 's/://g' | sort -u
```

2. **List services with health checks:**

```bash
echo "=== Services with Health Checks ==="
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config | \
  grep -B20 "healthcheck:" | grep "^\s\+\w.*:$" | sed 's/://g' | sort -u
```

3. **Check required services have limits:**

```bash
REQUIRED_SERVICES="postgres pgbouncer redis minio backend"
CONFIG=$(docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config)

for svc in $REQUIRED_SERVICES; do
  if echo "$CONFIG" | grep -A30 "^  $svc:" | grep -q "limits:"; then
    echo "$svc: HAS LIMITS"
  else
    echo "$svc: MISSING LIMITS - ERROR"
  fi
done
```

4. **Verify Loki logging for key services:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config | \
  grep -c "loki-url"
echo "Services configured for Loki logging"
```

  </action>
  <verify>All required services (postgres, pgbouncer, redis, minio, backend) have resource limits</verify>
  <done>Resource limits and health checks verified for all required services</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 9 Production Environment Hardening:
- Infisical secrets manager stack
- Production compose overlay with resource limits
- Self-hosted and DigitalOcean deployment overlays
- Enhanced .dockerignore files
- Deployment notification script
  </what-built>
  <how-to-verify>
1. **Check file structure exists:**
```bash
ls -la docker/compose.*.yaml
ls -la docker/infisical/
ls -la scripts/deploy/
```

2. **Verify compose syntax:**

```bash
docker compose -f docker/docker-compose.yml -f docker/compose.prod.yaml config --quiet && echo "PASS"
```

3. **Optionally start Infisical stack (if testing locally):**

```bash
./scripts/dev/setup-infisical.sh
# Then visit http://localhost:8080
```

4. **Verify .dockerignore protections:**

```bash
grep "\.key" backend/.dockerignore
grep "\.pem" backend/.dockerignore
grep "secrets/" backend/.dockerignore
```

5. **Test notification script (dry run):**

```bash
DEPLOY_WEBHOOK_URL="" ./scripts/deploy/notify.sh success "Test"
# Should output "Warning: DEPLOY_WEBHOOK_URL not set..."
```

  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 9 Success Criteria (from ROADMAP.md):

1. [ ] Sensitive credentials stored in Docker Secrets (not environment variables visible in docker inspect)
   - Verified by: compose files use `secrets:` section with file sources

2. [ ] All services have resource limits configured (memory, CPU)
   - Verified by: compose.prod.yaml has `deploy.resources.limits` for all services

3. [ ] All services have health checks configured
   - Verified by: All services have `healthcheck:` in base or overlay

4. [ ] Production docker-compose override file exists
   - Verified by: compose.prod.yaml, compose.selfhosted.yaml, compose.digitalocean.yaml exist

5. [ ] Docker builds exclude secrets (.env files, keys never appear in image layers)
   - Verified by: .dockerignore has comprehensive patterns

Requirements mapping:

- HARD-01: Secrets in Docker Secrets - compose files reference /run/secrets/\*
- HARD-02: Resource limits - compose.prod.yaml has limits for all services
- HARD-03: Health checks - all services have healthcheck configured
- HARD-04: Production override file - compose.prod.yaml exists
- HARD-05: .dockerignore - backend/.dockerignore has secret patterns
- HARD-06: Deployment notifications - scripts/deploy/notify.sh exists
  </verification>

<success_criteria>

- All compose files validate without errors
- All required services have resource limits
- All required services have health checks
- Secrets pattern used consistently across deployment overlays
- .dockerignore files protect against secret leakage
- Human verification confirms hardening is complete
  </success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-06-SUMMARY.md`
</output>
