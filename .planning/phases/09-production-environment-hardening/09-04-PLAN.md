---
phase: 09-production-environment-hardening
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - backend/.dockerignore
  - docker/.dockerignore
autonomous: true

must_haves:
  truths:
    - ".dockerignore excludes .env files, private keys, and credential patterns"
    - "Docker builds cannot include secrets in image layers"
  artifacts:
    - path: "backend/.dockerignore"
      provides: "Comprehensive secret exclusion patterns"
      contains: "*.pem"
    - path: "docker/.dockerignore"
      provides: "Docker context secret exclusion"
      contains: "*.key"
  key_links:
    - from: "backend/.dockerignore"
      to: "backend/Dockerfile"
      via: "Build context exclusion"
      pattern: ".env"
---

<objective>
Enhance .dockerignore files to comprehensively exclude secrets, credentials, and sensitive files from Docker build contexts.

Purpose: Prevents accidental inclusion of secrets in Docker image layers. Even if secrets are in COPY commands, .dockerignore blocks them from entering the build context, providing defense-in-depth.

Output: Comprehensive .dockerignore patterns protecting against credential leakage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-environment-hardening/09-CONTEXT.md
@.planning/phases/09-production-environment-hardening/09-RESEARCH.md
@backend/.dockerignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Backend .dockerignore</name>
  <files>backend/.dockerignore</files>
  <action>
Update `backend/.dockerignore` with comprehensive secret exclusion patterns.

Read the existing file first, then update with the following additions (preserve existing patterns):

**Add secrets and credentials section:**
```
# ===========================================
# Secrets and Credentials (CRITICAL)
# ===========================================
# Environment files
.env
.env.*
.env.local
.env.*.local
!.env.example

# Private keys and certificates
*.key
*.pem
*.p12
*.pfx
*.crt
*.cer
*.der
secrets/
*.secret
*.secrets

# Cloud credentials
.aws/
.gcp/
.azure/
credentials.json
service-account*.json

# SSH keys
id_rsa
id_rsa.pub
id_ed25519
id_ed25519.pub
*.pub

# Config files that may contain secrets
config/*.secret.*
config/production.*
```

**Add development artifacts section:**
```
# ===========================================
# Development Artifacts
# ===========================================
.vscode/
.idea/
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
.pnpm-debug.log

# Test and coverage
tests/
*.test.ts
*.spec.ts
coverage/
.nyc_output/
jest.config.*

# Documentation (not needed in image)
docs/
*.md
!README.md

# CI/CD
.github/
.gitlab-ci.yml
.circleci/
Jenkinsfile
```

**Add OS and editor section:**
```
# ===========================================
# OS and Editor
# ===========================================
.DS_Store
Thumbs.db
*.swp
*.swo
*~
```

**Preserve existing patterns** that are already in the file.
  </action>
  <verify>
```bash
# Check critical patterns exist
grep -q "\.key" backend/.dockerignore && echo ".key: found"
grep -q "\.pem" backend/.dockerignore && echo ".pem: found"
grep -q "\.env\." backend/.dockerignore && echo ".env.*: found"
grep -q "secrets/" backend/.dockerignore && echo "secrets/: found"
```
  </verify>
  <done>backend/.dockerignore includes comprehensive secret exclusion patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create Docker Directory .dockerignore</name>
  <files>docker/.dockerignore</files>
  <action>
Create `docker/.dockerignore` to protect the docker/ directory context if ever used directly:

```
# ===========================================
# Docker Context .dockerignore
# ===========================================
# This file protects against accidental secret inclusion
# if docker/ is used as a build context

# Infisical secrets (CRITICAL)
infisical/.env
infisical/*.secret
infisical/secrets/

# Local environment files
*.env
.env.*
!*.env.example

# Private keys and certificates
*.key
*.pem
*.p12
*.pfx
*.crt

# Temporary files
*.tmp
*.bak
*.swp

# Data volumes (should never be in context)
data/
volumes/
*.data

# Logs
*.log
logs/

# Editor files
.vscode/
.idea/
```
  </action>
  <verify>
```bash
test -f docker/.dockerignore && echo "File exists"
grep -q "infisical/.env" docker/.dockerignore && echo "Infisical secrets excluded"
```
  </verify>
  <done>docker/.dockerignore exists with Infisical and general secret patterns</done>
</task>

<task type="auto">
  <name>Task 3: Verify No Secrets in Existing Dockerfiles</name>
  <files>backend/Dockerfile</files>
  <action>
Audit the backend Dockerfile to ensure no secrets can leak into image layers.

**Check for anti-patterns:**
1. No `ARG` with secret values (ARG persists in layer metadata)
2. No `ENV` with actual secrets (use ENV *_FILE pattern instead)
3. No `COPY` of .env files
4. No hardcoded passwords or keys

**Verify current Dockerfile follows best practices:**
- Uses multi-stage build (secrets only in builder, not in final)
- Production stage only copies dist and node_modules
- No unnecessary files copied to production image

If any issues found, document them (but do NOT fix in this plan - that would require Dockerfile changes which is risky).

**Action:** Read and audit the Dockerfile, report findings in the SUMMARY.
  </action>
  <verify>
```bash
# Check for common secret anti-patterns
grep -n "ARG.*PASSWORD" backend/Dockerfile || echo "No ARG PASSWORD found"
grep -n "ARG.*SECRET" backend/Dockerfile || echo "No ARG SECRET found"
grep -n "ARG.*KEY" backend/Dockerfile || echo "No ARG KEY found"
grep -n "ENV.*PASSWORD=" backend/Dockerfile || echo "No ENV PASSWORD= found"
grep -n "COPY.*\.env" backend/Dockerfile || echo "No COPY .env found"
```
  </verify>
  <done>Dockerfile audited for secret leakage, findings documented</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Check backend .dockerignore has all patterns:
```bash
for pattern in ".key" ".pem" ".env." "secrets/" "*.secret"; do
  grep -q "$pattern" backend/.dockerignore && echo "$pattern: PRESENT" || echo "$pattern: MISSING"
done
```

2. Check docker/.dockerignore exists:
```bash
test -f docker/.dockerignore && echo "docker/.dockerignore: EXISTS"
```

3. Dockerfile audit (no secret patterns):
```bash
grep -E "(ARG|ENV).*(PASSWORD|SECRET|KEY)=" backend/Dockerfile && echo "WARNING: Potential secret in Dockerfile" || echo "No secrets in Dockerfile"
```
</verification>

<success_criteria>
- backend/.dockerignore has comprehensive secret exclusion patterns
- docker/.dockerignore exists protecting Infisical secrets
- Dockerfile audit confirms no secrets in image layers
- .env.example files are NOT excluded (templates are safe)
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-environment-hardening/09-04-SUMMARY.md`
</output>
