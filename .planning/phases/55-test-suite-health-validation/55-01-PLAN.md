---
phase: 55-test-suite-health-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/services/reading-ingestion.service.test.ts
autonomous: true

must_haves:
  truths:
    - "Backend test suite exits 0 with zero failures and zero skipped tests"
    - "Frontend test suite exits 0 with zero failures and zero skipped tests"
    - "No .skip, .todo, xit, xdescribe, xtest, skipIf, or runIf patterns remain in any test file"
  artifacts:
    - path: "backend/tests/services/reading-ingestion.service.test.ts"
      provides: "Fixed mock lifecycle (clearAllMocks instead of resetAllMocks)"
      contains: "vi.clearAllMocks"
  key_links:
    - from: "backend/tests/services/reading-ingestion.service.test.ts afterEach"
      to: "vi.mock factory for db client"
      via: "vi.clearAllMocks preserves mock implementations set by vi.mock factory"
      pattern: "afterEach.*clearAllMocks"
---

<objective>
Fix the 10 failing backend tests in reading-ingestion.service.test.ts and validate that both backend and frontend test suites pass cleanly with zero failures and zero skipped tests. This is the final gate for the v2.9 QA milestone.

Purpose: Confirm that all test restoration work from Phases 52-54 is complete and the entire test suite is healthy.
Output: Both test suites green, milestone v2.9 ready to ship.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-test-suite-health-validation/55-RESEARCH.md
@backend/tests/services/reading-ingestion.service.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix vi.resetAllMocks destroying db mock implementations</name>
  <files>backend/tests/services/reading-ingestion.service.test.ts</files>
  <action>
In `backend/tests/services/reading-ingestion.service.test.ts`, change the `afterEach` block (lines 80-82) from:

```typescript
afterEach(() => {
  vi.resetAllMocks();
});
```

to:

```typescript
afterEach(() => {
  vi.clearAllMocks();
});
```

WHY: The test file uses `vi.mock('../../src/db/client.js', ...)` with a factory function that creates chained mock implementations (`db.select() -> from() -> where() -> limit()`). `vi.resetAllMocks()` destroys those factory-set implementations, causing `db.select()` to return `undefined` in subsequent tests. `vi.clearAllMocks()` only resets call counts and arguments while preserving the mock implementations.

NOTE: The `beforeEach` at line 76-78 already calls `vi.clearAllMocks()`, so technically the `afterEach` could be removed entirely. However, changing to `vi.clearAllMocks()` is the minimal-risk fix and maintains the symmetric before/after pattern.

Do NOT change any other part of the file. This single-line change fixes all 10 failing tests.
  </action>
  <verify>
Run the specific test file:
```bash
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npx vitest run tests/services/reading-ingestion.service.test.ts
```
Expected: All tests pass (previously 10 failures, now 0).
  </verify>
  <done>All tests in reading-ingestion.service.test.ts pass. Zero failures in this file.</done>
</task>

<task type="auto">
  <name>Task 2: Validate full backend and frontend test suites</name>
  <files></files>
  <action>
Run both complete test suites and verify zero failures and zero skipped tests:

1. Backend suite:
```bash
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npx vitest run
```
Expected output contains: "Test Files  56 passed (56)" and "Tests  1256 passed (1256)" (or similar total with zero failures/skips).

2. Frontend suite:
```bash
cd /home/swoop/swoop-claude-projects/fresh-staged && npx vitest run
```
Expected output contains: "Test Files  10 passed (10)" and "Tests  150 passed (150)" (or similar total with zero failures/skips).

3. Verify no skip patterns remain:
```bash
grep -rn '\.skip\|\.todo\b\|xdescribe\|xit\b\|xtest\|skipIf\|runIf' \
  /home/swoop/swoop-claude-projects/fresh-staged/backend/tests/ \
  /home/swoop/swoop-claude-projects/fresh-staged/src/ \
  --include='*.test.*' --include='*.spec.*'
```
Expected: Zero matches.

If any test fails that is NOT the reading-ingestion file (already fixed in Task 1), investigate and fix. The research found no other failures, but validate to be certain.

If any skip patterns are found, either remove them (if the test should run) or add a comment explaining why the skip is necessary.
  </action>
  <verify>
All three commands above produce the expected results:
- Backend: 56 files passed, 0 failed, 0 skipped
- Frontend: 10 files passed, 0 failed, 0 skipped
- Grep: zero matches for skip/todo patterns
  </verify>
  <done>Both test suites exit 0 with zero failures and zero skipped tests. No skip/todo patterns remain in test files.</done>
</task>

</tasks>

<verification>
Phase 55 is verified when:
1. `pnpm test` (or `npx vitest run`) in backend/ exits 0 with all tests passing
2. `pnpm test` (or `npx vitest run`) in project root exits 0 with all tests passing
3. Grep for skip patterns across all test files returns zero matches
4. The only file modified is `backend/tests/services/reading-ingestion.service.test.ts` (single-line change)
</verification>

<success_criteria>
- Backend: 56 test files, ~1256 tests, all passing, zero skipped
- Frontend: 10 test files, ~150 tests, all passing, zero skipped
- Zero .skip/.todo/xit/xdescribe/xtest/skipIf/runIf patterns in any test file
- v2.9 QA milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/55-test-suite-health-validation/55-01-SUMMARY.md`
</output>
