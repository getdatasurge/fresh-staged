---
phase: 12-digitalocean-deployment
plan: 04
type: execute
wave: 2
depends_on: ['12-01', '12-02']
files_modified:
  - docs/DIGITALOCEAN_DEPLOYMENT.md
autonomous: false

must_haves:
  truths:
    - 'Documentation guides from empty DigitalOcean account to running application'
    - 'Cost comparison helps users choose between self-hosted and managed services'
    - 'Troubleshooting section addresses common doctl and Droplet issues'
  artifacts:
    - path: 'docs/DIGITALOCEAN_DEPLOYMENT.md'
      provides: 'Complete DigitalOcean deployment guide'
      min_lines: 400
  key_links:
    - from: 'docs/DIGITALOCEAN_DEPLOYMENT.md'
      to: 'scripts/deploy-digitalocean.sh'
      via: 'command references'
      pattern: "deploy-digitalocean\\.sh"
---

<objective>
Create comprehensive DigitalOcean deployment documentation including prerequisites, step-by-step guide, cost comparison, and troubleshooting.

Purpose: Enable users to deploy FreshTrack Pro to DigitalOcean with clear guidance on choosing between self-hosted and managed database options.

Output: docs/DIGITALOCEAN_DEPLOYMENT.md with complete deployment guide and cost analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-digitalocean-deployment/12-RESEARCH.md
@docs/SELFHOSTED_DEPLOYMENT.md
@scripts/deploy-digitalocean.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DigitalOcean deployment documentation</name>
  <files>docs/DIGITALOCEAN_DEPLOYMENT.md</files>
  <action>
Create comprehensive deployment documentation:

```markdown
# FreshTrack Pro - DigitalOcean Deployment Guide

This guide covers deploying FreshTrack Pro to DigitalOcean infrastructure, including Droplet provisioning, optional managed PostgreSQL, and DigitalOcean Spaces integration.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Configuration Options](#configuration-options)
- [Deployment Modes](#deployment-modes)
- [Step-by-Step Deployment](#step-by-step-deployment)
- [Managed PostgreSQL Setup](#managed-postgresql-setup)
- [DigitalOcean Spaces Setup](#digitalocean-spaces-setup)
- [Cost Comparison](#cost-comparison)
- [Networking and Security](#networking-and-security)
- [Troubleshooting](#troubleshooting)
- [Maintenance](#maintenance)

## Overview

FreshTrack Pro can be deployed to DigitalOcean in two primary configurations:

| Mode                 | Database              | Storage         | Monthly Cost | Best For                              |
| -------------------- | --------------------- | --------------- | ------------ | ------------------------------------- |
| **Self-Hosted**      | PostgreSQL container  | MinIO container | ~$24-48/mo   | Full control, cost optimization       |
| **Managed Services** | DO Managed PostgreSQL | DO Spaces       | ~$60-100/mo  | Reduced ops burden, automatic backups |

The deployment script (`deploy-digitalocean.sh`) automates Droplet provisioning and supports both modes through configuration flags.

### Architecture
```

┌─────────────────────────────────────────────────────────────┐
│ DigitalOcean VPC │
│ │
│ ┌────────────────────┐ ┌──────────────────────────────┐ │
│ │ Droplet │ │ Managed PostgreSQL │ │
│ │ ┌──────────────┐ │ │ (optional) │ │
│ │ │ Caddy (443) │ │ │ │ │
│ │ └──────┬───────┘ │ │ • Auto-backups │ │
│ │ │ │ │ • Connection pooling │ │
│ │ ┌──────▼───────┐ │ │ • Private network │ │
│ │ │ Backend │──┼────┤ │ │
│ │ └──────────────┘ │ └──────────────────────────────┘ │
│ │ │ │ │
│ │ ┌──────▼───────┐ │ ┌──────────────────────────────┐ │
│ │ │ PostgreSQL │ │ │ DigitalOcean Spaces │ │
│ │ │ (self-host) │ │ │ (optional) │ │
│ │ └──────────────┘ │ │ │ │
│ │ │ │ │ • 250GB + 1TB bandwidth │ │
│ │ ┌──────▼───────┐ │ │ • CDN included │ │
│ │ │ Redis │ │ │ • S3-compatible API │ │
│ │ └──────────────┘ │ │ │ │
│ │ │ │ └──────────────────────────────┘ │
│ │ ┌──────▼───────┐ │ │
│ │ │ MinIO │ │ │
│ │ │ (self-host) │ │ │
│ │ └──────────────┘ │ │
│ └────────────────────┘ │
│ │
└──────────────────────────────────────────────────────────────┘

````

## Prerequisites

### 1. DigitalOcean Account

Create an account at [digitalocean.com](https://www.digitalocean.com/).

**Required:**
- API token with read/write permissions
- SSH key added to account
- Payment method configured

### 2. doctl CLI Installation

**macOS:**
```bash
brew install doctl
````

**Linux (snap):**

```bash
sudo snap install doctl
```

**Linux (manual):**

```bash
cd ~
wget https://github.com/digitalocean/doctl/releases/download/v1.98.0/doctl-1.98.0-linux-amd64.tar.gz
tar xf doctl-1.98.0-linux-amd64.tar.gz
sudo mv doctl /usr/local/bin
```

**Authenticate:**

```bash
doctl auth init
# Paste your API token when prompted
```

Verify authentication:

```bash
doctl account get
```

### 3. SSH Key Setup

If you haven't added an SSH key to DigitalOcean:

```bash
# Generate key (if you don't have one)
ssh-keygen -t ed25519 -C "your-email@example.com"

# Add to DigitalOcean
doctl compute ssh-key create my-laptop-key --public-key "$(cat ~/.ssh/id_ed25519.pub)"
```

List available keys:

```bash
doctl compute ssh-key list
```

### 4. API Token

Create at: https://cloud.digitalocean.com/account/api/tokens

**Permissions required:**

- Read
- Write

Save the token securely - it's only shown once.

## Quick Start

```bash
# 1. Clone repository
git clone https://github.com/yourusername/freshtrack-pro.git
cd freshtrack-pro

# 2. Copy and configure
cp scripts/deploy.config.example scripts/deploy.config
# Edit deploy.config with your values

# 3. Deploy to DigitalOcean
./scripts/deploy-digitalocean.sh
```

The script will:

1. Validate doctl authentication
2. Provision a new Droplet (or reuse existing)
3. Wait for cloud-init to install Docker
4. Deploy application containers
5. Display the Droplet IP for DNS configuration

## Configuration Options

Edit `scripts/deploy.config`:

### Required Settings

```bash
# Domain and SSL
DOMAIN=freshtrackpro.com
ADMIN_EMAIL=admin@freshtrackpro.com

# DigitalOcean API
DO_API_TOKEN=dop_v1_your_token_here
DO_SSH_KEY_NAME=my-laptop-key

# Stack Auth (from app.stack-auth.com)
STACK_AUTH_PROJECT_ID=prj_xxx
STACK_AUTH_PUBLISHABLE_KEY=pk_xxx
STACK_AUTH_SECRET_KEY=sk_xxx
```

### Optional Settings

```bash
# Droplet configuration
DO_REGION=nyc3                    # Default: nyc3
DO_DROPLET_SIZE=s-2vcpu-4gb       # Default: s-2vcpu-4gb ($24/mo)

# Managed services (see Cost Comparison section)
USE_MANAGED_DB=false              # Use DO Managed PostgreSQL
USE_DO_SPACES=false               # Use DO Spaces instead of MinIO

# Managed database size (if USE_MANAGED_DB=true)
DO_DB_SIZE=db-s-1vcpu-2gb         # Default: $30/mo

# Spaces configuration (if USE_DO_SPACES=true)
DO_SPACES_REGION=nyc3
DO_SPACES_BUCKET=freshtrack-media
DO_SPACES_ACCESS_KEY=xxx
DO_SPACES_SECRET_KEY=xxx
```

### Region Selection

Choose the region closest to your users:

| Region     | Location      | Latency (US East Coast) |
| ---------- | ------------- | ----------------------- |
| nyc1, nyc3 | New York      | ~5ms                    |
| sfo3       | San Francisco | ~70ms                   |
| tor1       | Toronto       | ~15ms                   |
| lon1       | London        | ~80ms                   |
| fra1       | Frankfurt     | ~90ms                   |
| ams3       | Amsterdam     | ~85ms                   |
| sgp1       | Singapore     | ~230ms                  |
| blr1       | Bangalore     | ~250ms                  |
| syd1       | Sydney        | ~200ms                  |

## Deployment Modes

### Mode 1: Self-Hosted (Default)

All services run in Docker containers on the Droplet:

```bash
# Default configuration
USE_MANAGED_DB=false
USE_DO_SPACES=false
```

**Pros:**

- Lower monthly cost ($24-48/mo)
- Full control over configuration
- No external dependencies

**Cons:**

- You manage backups
- Manual scaling required
- Database admin responsibility

### Mode 2: Managed Database

Use DigitalOcean Managed PostgreSQL:

```bash
USE_MANAGED_DB=true
DO_DB_SIZE=db-s-1vcpu-2gb
```

**Pros:**

- Automated daily backups
- Point-in-time recovery
- Connection pooling included
- High availability options

**Cons:**

- Higher monthly cost (+$15-60/mo)
- Less configuration flexibility

### Mode 3: Full Managed

Managed PostgreSQL + DigitalOcean Spaces:

```bash
USE_MANAGED_DB=true
USE_DO_SPACES=true
```

**Pros:**

- Minimal operational burden
- CDN included with Spaces
- Professional-grade infrastructure

**Cons:**

- Highest monthly cost (~$100+/mo)
- Vendor lock-in considerations

## Step-by-Step Deployment

### Step 1: Prepare Configuration

```bash
cp scripts/deploy.config.example scripts/deploy.config
```

Edit `deploy.config` with your values. At minimum:

- `DOMAIN`
- `ADMIN_EMAIL`
- `DO_API_TOKEN`
- `DO_SSH_KEY_NAME`
- `STACK_AUTH_*` credentials

### Step 2: Run Deployment

```bash
./scripts/deploy-digitalocean.sh
```

This takes approximately 5-10 minutes:

- Droplet provisioning: 60-90 seconds
- Cloud-init (Docker install): 3-5 minutes
- Application deployment: 1-2 minutes

### Step 3: Configure DNS

After deployment completes, you'll see:

```
Droplet IP: 123.45.67.89

Next Steps:
  1. Configure DNS:
     Add A record: freshtrackpro.com -> 123.45.67.89
```

In your DNS provider:

1. Add A record pointing domain to Droplet IP
2. Add A record for www subdomain (optional)
3. Wait for propagation (5-60 minutes)

### Step 4: Verify Deployment

Check DNS propagation:

```bash
dig freshtrackpro.com
```

Access your application:

```
https://freshtrackpro.com
```

## Managed PostgreSQL Setup

### Automatic Setup

If `USE_MANAGED_DB=true` in config, the deployment script automatically:

1. Creates database cluster in VPC
2. Configures connection pooling (transaction mode)
3. Downloads SSL certificate
4. Saves connection string to secrets

### Manual Setup (Standalone)

To add managed database to existing deployment:

```bash
./scripts/deploy-digitalocean.sh --setup-managed-db
```

This creates the database and outputs the connection string.

### Connection String Format

```
postgresql://user:password@host-pooler.db.ondigitalocean.com:25060/defaultdb?sslmode=require
```

**Important:** Always use the `-pooler` endpoint:

- `host.db.ondigitalocean.com` = Direct connection (limited connections)
- `host-pooler.db.ondigitalocean.com` = Connection pooler (25+ connections per GB RAM)

### Database Tiers

| Tier           | RAM  | Connections | Monthly Cost | Use Case                |
| -------------- | ---- | ----------- | ------------ | ----------------------- |
| db-s-1vcpu-1gb | 1 GB | 25          | $15          | Development             |
| db-s-1vcpu-2gb | 2 GB | 50          | $30          | Small production        |
| db-s-2vcpu-4gb | 4 GB | 100         | $60          | Production with standby |
| db-s-4vcpu-8gb | 8 GB | 200         | $120         | High traffic            |

## DigitalOcean Spaces Setup

### Enable Spaces

1. Set in config:

   ```bash
   USE_DO_SPACES=true
   DO_SPACES_REGION=nyc3
   DO_SPACES_BUCKET=freshtrack-media
   ```

2. Create Spaces credentials at:
   https://cloud.digitalocean.com/account/api/spaces

3. Add to config:
   ```bash
   DO_SPACES_ACCESS_KEY=xxx
   DO_SPACES_SECRET_KEY=xxx
   ```

### Spaces Pricing

- $5/month for 250 GB storage
- 1 TB outbound bandwidth included
- CDN included at no extra cost

## Cost Comparison

### Monthly Infrastructure Costs

| Component             | Self-Hosted    | Managed DB     | Full Managed   |
| --------------------- | -------------- | -------------- | -------------- |
| Droplet (2 vCPU, 4GB) | $24            | $24            | $24            |
| PostgreSQL            | $0 (container) | $30 (managed)  | $30 (managed)  |
| MinIO/Storage         | $0 (container) | $0 (container) | $5 (Spaces)    |
| Redis                 | $0 (container) | $0 (container) | $0 (container) |
| Backups               | ~$1 (Volumes)  | $0 (included)  | $0 (included)  |
| **Total**             | **~$25/mo**    | **~$54/mo**    | **~$59/mo**    |

### Operational Time Costs

| Task               | Self-Hosted  | Managed     |
| ------------------ | ------------ | ----------- |
| Database backups   | 2 hrs/mo     | 0 hrs/mo    |
| Security patches   | 2 hrs/mo     | 0.5 hrs/mo  |
| Monitoring         | 2 hrs/mo     | 0.5 hrs/mo  |
| Storage management | 1 hr/mo      | 0 hrs/mo    |
| **Total**          | **7 hrs/mo** | **1 hr/mo** |

### Cost Analysis

At $100/hour engineer rate:

- Self-hosted: $25 + $700 = **$725/mo total**
- Managed: $59 + $100 = **$159/mo total**

**Recommendation:**

- Teams < 5 engineers: Use managed services
- Teams with dedicated DBA: Consider self-hosted
- Prototypes/MVPs: Use managed to focus on product

## Networking and Security

### VPC Private Networking

All resources are automatically placed in a VPC:

- Private network between Droplet and managed database
- No bandwidth charges for internal traffic
- Reduced latency (~1ms vs 5-10ms)

### Cloud Firewall

The deployment script creates a Cloud Firewall with rules:

- SSH (22/tcp) from any source
- HTTP (80/tcp) from any source (for Let's Encrypt)
- HTTPS (443/tcp) from any source

### Host Firewall (UFW)

UFW is also configured on the Droplet (defense-in-depth):

```bash
ufw status
```

### fail2ban

Protects SSH from brute force attacks:

```bash
fail2ban-client status sshd
```

## Troubleshooting

### doctl Authentication Failed

```
Error: Unable to authenticate
```

**Solution:**

```bash
# Re-authenticate
doctl auth init

# Or use API token directly
export DIGITALOCEAN_TOKEN=your_token
doctl account get
```

### Droplet Not Accessible

1. Check firewall rules:

   ```bash
   doctl compute firewall list
   ```

2. Verify SSH key:

   ```bash
   doctl compute ssh-key list
   ```

3. Check Droplet status:
   ```bash
   doctl compute droplet list
   ```

### DNS Not Resolving

```bash
# Check DNS propagation
dig freshtrackpro.com

# Check from different DNS servers
dig @8.8.8.8 freshtrackpro.com
dig @1.1.1.1 freshtrackpro.com
```

DNS propagation can take up to 48 hours in worst case (usually 5-60 minutes).

### SSL Certificate Failed

If Let's Encrypt fails, check:

1. DNS is resolving correctly
2. Port 80 is open
3. Domain is pointing to correct IP

```bash
# On Droplet
docker logs freshtrack-caddy
```

### Database Connection Failed

For managed database:

```bash
# Test connection (replace with your details)
psql "postgresql://user:pass@host-pooler:25060/db?sslmode=require"
```

Check:

1. Using `-pooler` endpoint
2. `sslmode=require` in connection string
3. Droplet is in trusted sources

### View Logs

```bash
# SSH to Droplet
ssh root@DROPLET_IP

# View all logs
cd /opt/freshtrack-pro
docker compose logs -f

# View specific service
docker compose logs -f backend
```

## Maintenance

### Updates

```bash
ssh root@DROPLET_IP
cd /opt/freshtrack-pro
git pull
./scripts/deploy-selfhosted.sh --deploy
```

### Backups

**Self-hosted mode:**

- Automated daily backups to MinIO (configured in Phase 10)
- Test restoration: `./scripts/test-restore.sh`

**Managed PostgreSQL:**

- Automatic daily backups
- 7-day point-in-time recovery
- Restore from dashboard or doctl

### Scaling

**Vertical scaling (resize Droplet):**

```bash
doctl compute droplet-action resize DROPLET_ID --size s-4vcpu-8gb --wait
```

**Add managed database standby:**

```bash
doctl databases configuration update DB_ID --num-nodes 2
```

### Monitoring

- **Grafana:** https://your-domain/grafana
- **DigitalOcean Dashboard:** https://cloud.digitalocean.com/droplets
- **Database Metrics:** https://cloud.digitalocean.com/databases

---

## Next Steps

After deployment:

1. Configure monitoring alerts in Grafana
2. Set up backup verification schedule
3. Configure DNS for any additional subdomains
4. Review firewall rules for your security requirements

For additional help:

- [Self-Hosted Deployment Guide](SELFHOSTED_DEPLOYMENT.md)
- [Database Documentation](DATABASE.md)
- [SSL Certificates Guide](SSL_CERTIFICATES.md)

````
  </action>
  <verify>
Run: `wc -l docs/DIGITALOCEAN_DEPLOYMENT.md && grep -c "## " docs/DIGITALOCEAN_DEPLOYMENT.md`
Expected: 400+ lines and 12+ section headers.
  </verify>
  <done>docs/DIGITALOCEAN_DEPLOYMENT.md contains comprehensive deployment guide with prerequisites, step-by-step instructions, cost comparison, and troubleshooting.</done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <what-built>
Complete DigitalOcean deployment automation:
- scripts/deploy.config.example with DO configuration section
- scripts/lib/doctl-helpers.sh with authentication and provisioning functions
- scripts/lib/managed-db-helpers.sh with managed PostgreSQL functions
- scripts/deploy-digitalocean.sh with Droplet provisioning and deployment
- docker/compose.digitalocean.yaml with managed DB support
- docs/DIGITALOCEAN_DEPLOYMENT.md with comprehensive guide
  </what-built>
  <how-to-verify>
1. **Review documentation:**
   - Read docs/DIGITALOCEAN_DEPLOYMENT.md
   - Verify cost comparison makes sense
   - Check troubleshooting section is helpful

2. **Script syntax check:**
   ```bash
   bash -n scripts/deploy-digitalocean.sh
   bash -n scripts/lib/doctl-helpers.sh
   bash -n scripts/lib/managed-db-helpers.sh
````

3. **Config template review:**
   - Check scripts/deploy.config.example has all DO options
   - Verify comments explain each option

4. **Compose file validation:**

   ```bash
   docker compose -f docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.digitalocean.yaml config --quiet
   ```

5. **(Optional) Actual deployment test:**
   - Requires DigitalOcean account with API token
   - Run: `./scripts/deploy-digitalocean.sh --provision-only`
   - Verify Droplet created successfully
     </how-to-verify>
     <resume-signal>Type "approved" to complete the phase, or describe any issues found.</resume-signal>
     </task>

</tasks>

<verification>
After all tasks complete:

1. **Documentation completeness:**

   ```bash
   grep -c "^##" docs/DIGITALOCEAN_DEPLOYMENT.md
   # Should be 12+ section headers
   ```

2. **Cost comparison included:**

   ```bash
   grep -c "Cost\|\\$" docs/DIGITALOCEAN_DEPLOYMENT.md
   # Should be 20+ cost-related mentions
   ```

3. **Troubleshooting coverage:**

   ```bash
   grep -c "Solution:\|Check:\|Error:" docs/DIGITALOCEAN_DEPLOYMENT.md
   # Should be 5+ troubleshooting items
   ```

4. **Cross-references to scripts:**
   ```bash
   grep -c "deploy-digitalocean.sh\|doctl" docs/DIGITALOCEAN_DEPLOYMENT.md
   # Should be 10+ references
   ```
   </verification>

<success_criteria>

- docs/DIGITALOCEAN_DEPLOYMENT.md is 400+ lines
- Documentation covers prerequisites, deployment, managed services, costs, and troubleshooting
- Cost comparison table shows self-hosted vs managed pricing
- Human verification confirms documentation quality (checkpoint)
  </success_criteria>

<output>
After completion, create `.planning/phases/12-digitalocean-deployment/12-04-SUMMARY.md`
</output>
