---
phase: 47-trpc-proxy-call-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAlertRules.ts
  - src/hooks/useAlertRulesHistory.ts
  - src/hooks/useWidgetHealthMetrics.ts
  - src/hooks/useSiteLocationMutation.ts
autonomous: true

must_haves:
  truths:
    - "Zero .mutate() calls on useTRPC() proxy in hook files"
    - "Zero .query() calls on useTRPC() proxy in hook files"
    - "All imperative tRPC calls use useTRPCClient() vanilla client"
    - "pnpm run build succeeds with no TypeScript errors in modified files"
  artifacts:
    - path: "src/hooks/useAlertRules.ts"
      provides: "Alert rules CRUD hooks using useTRPCClient for mutate calls"
      contains: "useTRPCClient"
    - path: "src/hooks/useAlertRulesHistory.ts"
      provides: "Alert history hooks using useTRPCClient for mutate calls"
      contains: "useTRPCClient"
    - path: "src/hooks/useWidgetHealthMetrics.ts"
      provides: "Widget health metrics using useTRPCClient for both mutate and query calls"
      contains: "useTRPCClient"
    - path: "src/hooks/useSiteLocationMutation.ts"
      provides: "Site location mutation using useTRPCClient for mutate call"
      contains: "useTRPCClient"
  key_links:
    - from: "src/hooks/useAlertRules.ts"
      to: "src/lib/trpc.ts"
      via: "import { useTRPCClient } from '@/lib/trpc'"
      pattern: "useTRPCClient"
    - from: "src/hooks/useWidgetHealthMetrics.ts"
      to: "src/lib/trpc.ts"
      via: "import { useTRPCClient } from '@/lib/trpc'"
      pattern: "useTRPCClient"
---

<objective>
Fix all `.mutate()` and `.query()` calls on the `useTRPC()` proxy in 4 hook files by switching them to use `useTRPCClient()` (vanilla client).

Purpose: The `useTRPC()` proxy only supports `.queryOptions()` / `.mutationOptions()` in tRPC v11. Imperative `.mutate()` and `.query()` calls must use `useTRPCClient()` which returns the vanilla client that supports these methods. This eliminates the `TypeError: e[i] is not a function` runtime crash.

Output: 4 hook files with all imperative tRPC calls using the vanilla client pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix .mutate() calls in useAlertRules.ts, useAlertRulesHistory.ts, and useSiteLocationMutation.ts</name>
  <files>src/hooks/useAlertRules.ts, src/hooks/useAlertRulesHistory.ts, src/hooks/useSiteLocationMutation.ts</files>
  <action>
In each file, apply this pattern:

1. Change the import from `import { useTRPC } from '@/lib/trpc'` to `import { useTRPC, useTRPCClient } from '@/lib/trpc'`
2. In each hook function that has `.mutate()` calls, add `const trpcClient = useTRPCClient()` alongside the existing `const trpc = useTRPC()`
3. Replace `trpc.X.Y.mutate(...)` with `trpcClient.X.Y.mutate(...)` in mutationFn callbacks

**useAlertRules.ts** - 3 mutations to fix:
- `useUpsertAlertRules`: `trpc.alertRules.upsert.mutate(...)` -> `trpcClient.alertRules.upsert.mutate(...)`
- `useDeleteAlertRules`: `trpc.alertRules.delete.mutate(...)` -> `trpcClient.alertRules.delete.mutate(...)`
- `useClearRuleField`: `trpc.alertRules.clearField.mutate(...)` -> `trpcClient.alertRules.clearField.mutate(...)`
- Note: The query hooks (useUnitAlertRules, useOrgAlertRules, useSiteAlertRules, useUnitAlertRulesOverride) already use `.queryOptions()` correctly -- do NOT change them.

**useAlertRulesHistory.ts** - 1 mutation to fix:
- `useInsertAlertRulesHistory`: `trpc.alertHistory.create.mutate(...)` -> `trpcClient.alertHistory.create.mutate(...)`
- Note: `useAlertRulesHistory` query hook already uses `.queryOptions()` correctly -- do NOT change it.

**useSiteLocationMutation.ts** - 1 mutation to fix:
- `useSiteLocationMutation`: `trpc.sites.update.mutate(...)` -> `trpcClient.sites.update.mutate(...)`

IMPORTANT: Keep `const trpc = useTRPC()` in hooks that also use `.queryOptions()` or `.mutationOptions()`. Only add `useTRPCClient` for the imperative `.mutate()` calls.
  </action>
  <verify>Run `grep -n '\.mutate(' src/hooks/useAlertRules.ts src/hooks/useAlertRulesHistory.ts src/hooks/useSiteLocationMutation.ts` and confirm all `.mutate()` calls are on `trpcClient` not `trpc`. Run `grep -n 'useTRPCClient' src/hooks/useAlertRules.ts src/hooks/useAlertRulesHistory.ts src/hooks/useSiteLocationMutation.ts` to confirm import and usage present in all 3 files.</verify>
  <done>All .mutate() calls in these 3 hook files use trpcClient (vanilla client). Existing .queryOptions()/.mutationOptions() calls remain on trpc (proxy) unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Fix .mutate() and .query() calls in useWidgetHealthMetrics.ts</name>
  <files>src/hooks/useWidgetHealthMetrics.ts</files>
  <action>
This file has the most calls to fix -- 3 `.mutate()` and 4 `.query()` calls, all imperative (not inside useMutation/useQuery hooks).

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPCClient } from '@/lib/trpc'`
   Note: This file does NOT use `.queryOptions()` or `.mutationOptions()` at all, so we can replace `useTRPC` entirely with `useTRPCClient`.
2. Change: `const trpc = useTRPC()` -> `const trpcClient = useTRPCClient()`
3. Replace ALL 7 calls:
   - `trpc.widgetHealth.trackHealthChange.mutate(event)` -> `trpcClient.widgetHealth.trackHealthChange.mutate(event)`
   - `trpc.widgetHealth.getHealthDistribution.query(...)` -> `trpcClient.widgetHealth.getHealthDistribution.query(...)`
   - `trpc.widgetHealth.getFailuresByLayer.query(...)` -> `trpcClient.widgetHealth.getFailuresByLayer.query(...)`
   - `trpc.widgetHealth.hasCriticalIssues.query(...)` -> `trpcClient.widgetHealth.hasCriticalIssues.query(...)`
   - `trpc.widgetHealth.getBufferedEvents.query(...)` -> `trpcClient.widgetHealth.getBufferedEvents.query(...)`
   - `trpc.widgetHealth.flushHealthMetrics.mutate(...)` -> `trpcClient.widgetHealth.flushHealthMetrics.mutate(...)`
   - `trpc.widgetHealth.resetOrgCounters.mutate(...)` -> `trpcClient.widgetHealth.resetOrgCounters.mutate(...)`
  </action>
  <verify>Run `grep -n 'trpc\.' src/hooks/useWidgetHealthMetrics.ts` and confirm zero references to bare `trpc.` (should only show `trpcClient.`). Run `grep -c '\.mutate\|\.query' src/hooks/useWidgetHealthMetrics.ts` to confirm 7 calls exist and all use `trpcClient`.</verify>
  <done>All 7 imperative tRPC calls in useWidgetHealthMetrics.ts use trpcClient (vanilla client). useTRPC import removed since it was not needed.</done>
</task>

</tasks>

<verification>
Run from project root:
1. `grep -rn 'trpc\.\(alertRules\|alertHistory\|sites\|widgetHealth\)\.[a-zA-Z]*\.\(mutate\|query\)(' src/hooks/useAlertRules.ts src/hooks/useAlertRulesHistory.ts src/hooks/useSiteLocationMutation.ts src/hooks/useWidgetHealthMetrics.ts` -- should show ONLY `trpcClient.` prefixed calls
2. `grep -rn 'useTRPCClient' src/hooks/useAlertRules.ts src/hooks/useAlertRulesHistory.ts src/hooks/useSiteLocationMutation.ts src/hooks/useWidgetHealthMetrics.ts` -- all 4 files should import and use it
3. `pnpm run build` -- should succeed (or at least these 4 files should have no errors)
</verification>

<success_criteria>
- Zero `.mutate()` calls on `trpc` (useTRPC proxy) in the 4 hook files
- Zero `.query()` calls on `trpc` (useTRPC proxy) in the 4 hook files
- All imperative calls use `trpcClient` from `useTRPCClient()`
- Existing `.queryOptions()` / `.mutationOptions()` calls untouched
- TypeScript compilation succeeds for modified files
</success_criteria>

<output>
After completion, create `.planning/phases/47-trpc-proxy-call-migration/47-01-SUMMARY.md`
</output>
