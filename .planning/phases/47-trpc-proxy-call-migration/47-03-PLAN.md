---
phase: 47-trpc-proxy-call-migration
plan: 03
type: execute
wave: 2
depends_on: ['47-01', '47-02']
files_modified:
  - src/pages/Inspector.tsx
  - src/pages/PilotSetup.tsx
  - src/features/dashboard-layout/widgets/SiteAlertsSummaryWidget.tsx
  - src/features/dashboard-layout/widgets/AlertHistoryWidget.tsx
autonomous: true

must_haves:
  truths:
    - 'Zero .mutate() calls on useTRPC() proxy in any src/ file'
    - 'Zero .query() calls on useTRPC() proxy in any src/ file'
    - 'All imperative tRPC calls across entire codebase use useTRPCClient()'
    - 'pnpm run build succeeds with zero errors'
    - 'grep confirms zero remaining proxy misuse patterns'
  artifacts:
    - path: 'src/pages/Inspector.tsx'
      provides: 'Inspector page with useTRPCClient for all imperative calls'
      contains: 'useTRPCClient'
    - path: 'src/pages/PilotSetup.tsx'
      provides: 'PilotSetup page with useTRPCClient for query calls'
      contains: 'useTRPCClient'
    - path: 'src/features/dashboard-layout/widgets/SiteAlertsSummaryWidget.tsx'
      provides: 'Site alerts widget with useTRPCClient for query call'
      contains: 'useTRPCClient'
    - path: 'src/features/dashboard-layout/widgets/AlertHistoryWidget.tsx'
      provides: 'Alert history widget with useTRPCClient for query call'
      contains: 'useTRPCClient'
  key_links:
    - from: 'src/pages/Inspector.tsx'
      to: 'src/lib/trpc.ts'
      via: "import { useTRPC, useTRPCClient } from '@/lib/trpc'"
      pattern: 'useTRPCClient'
    - from: 'src/pages/PilotSetup.tsx'
      to: 'src/lib/trpc.ts'
      via: "import { useTRPC, useTRPCClient } from '@/lib/trpc'"
      pattern: 'useTRPCClient'
---

<objective>
Fix all remaining `.mutate()` and `.query()` calls on the `useTRPC()` proxy in 4 page/widget files, then verify the entire codebase has zero proxy misuse patterns and `pnpm run build` succeeds.

Purpose: This is the final plan that completes the tRPC proxy call migration. After this plan, the root cause of `TypeError: e[i] is not a function` is fully eliminated across the entire codebase.

Output: 4 files fixed, full codebase grep verification, successful build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix .mutate()/.query() calls in Inspector.tsx, PilotSetup.tsx, SiteAlertsSummaryWidget.tsx, and AlertHistoryWidget.tsx</name>
  <files>src/pages/Inspector.tsx, src/pages/PilotSetup.tsx, src/features/dashboard-layout/widgets/SiteAlertsSummaryWidget.tsx, src/features/dashboard-layout/widgets/AlertHistoryWidget.tsx</files>
  <action>
**Inspector.tsx** - 1 `.mutate()` call + 4 `.query()` calls, PLUS uses `.mutationOptions()` correctly:
1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPC, useTRPCClient } from '@/lib/trpc'`
   IMPORTANT: This file uses BOTH patterns -- `trpc.reports.export.mutationOptions()` (correct, keep on proxy) AND imperative `.mutate()`/`.query()` calls (need vanilla client). So KEEP useTRPC AND ADD useTRPCClient.
2. Add `const trpcClient = useTRPCClient()` alongside existing `const trpc = useTRPC()`
3. Fix the 1 mutate call:
   - `trpc.inspector.validateSession.mutate(...)` -> `trpcClient.inspector.validateSession.mutate(...)`
4. Fix the 4 query calls:
   - `trpc.inspector.checkUserAccess.query(...)` -> `trpcClient.inspector.checkUserAccess.query(...)`
   - `trpc.inspector.getOrgData.query(...)` -> `trpcClient.inspector.getOrgData.query(...)`
   - `trpc.inspector.getUnits.query(...)` -> `trpcClient.inspector.getUnits.query(...)`
   - `trpc.inspector.getInspectionData.query(...)` -> `trpcClient.inspector.getInspectionData.query(...)`
5. Leave `trpc.reports.export.mutationOptions()` UNCHANGED (this is the correct proxy pattern)

**PilotSetup.tsx** - 2 `.query()` calls, PLUS uses `.mutationOptions()` correctly:

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPC, useTRPCClient } from '@/lib/trpc'`
   IMPORTANT: This file uses BOTH patterns -- `trpc.pilotFeedback.upsert.mutationOptions()` (correct, keep on proxy) AND imperative `.query()` calls (need vanilla client). So KEEP useTRPC AND ADD useTRPCClient.
2. Add `const trpcClient = useTRPCClient()` alongside existing `const trpc = useTRPC()`
3. Fix the 2 query calls:
   - `trpc.sites.list.query(...)` -> `trpcClient.sites.list.query(...)`
   - `trpc.organizations.stats.query(...)` -> `trpcClient.organizations.stats.query(...)`
4. Leave `trpc.pilotFeedback.upsert.mutationOptions()` UNCHANGED (this is the correct proxy pattern)

**SiteAlertsSummaryWidget.tsx** - 1 `.query()` call, no proxy pattern usage:

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPCClient } from '@/lib/trpc'`
   This file only uses imperative `.query()` -- no `.queryOptions()` or `.mutationOptions()`.
2. Change: `const trpc = useTRPC()` -> `const trpcClient = useTRPCClient()`
3. Fix the query call:
   - `trpc.alerts.list.query(...)` -> `trpcClient.alerts.list.query(...)`
4. Update the useEffect dependency array: `[entityId, organizationId, trpc]` -> `[entityId, organizationId, trpcClient]`

**AlertHistoryWidget.tsx** - 1 `.query()` call, no proxy pattern usage:

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPCClient } from '@/lib/trpc'`
   This file only uses imperative `.query()` -- no `.queryOptions()` or `.mutationOptions()`.
2. Change: `const trpc = useTRPC()` -> `const trpcClient = useTRPCClient()`
3. Fix the query call:
   - `trpc.alerts.list.query(...)` -> `trpcClient.alerts.list.query(...)`
4. Update the useEffect dependency array: `[entityId, organizationId, trpc]` -> `[entityId, organizationId, trpcClient]`
   </action>
   <verify>
   Run these verification commands:
5. `grep -n 'trpcClient\.' src/pages/Inspector.tsx` -- should show 5 trpcClient calls
6. `grep -n 'trpcClient\.' src/pages/PilotSetup.tsx` -- should show 2 trpcClient calls
7. `grep -n 'trpcClient\.' src/features/dashboard-layout/widgets/SiteAlertsSummaryWidget.tsx` -- should show 1 trpcClient call
8. `grep -n 'trpcClient\.' src/features/dashboard-layout/widgets/AlertHistoryWidget.tsx` -- should show 1 trpcClient call
9. `grep -n 'mutationOptions' src/pages/Inspector.tsx src/pages/PilotSetup.tsx` -- should show these still use `trpc.` (proxy pattern, correct)
   </verify>
   <done>All imperative .mutate() and .query() calls in all 4 files use trpcClient. Correct .mutationOptions()/.queryOptions() calls remain on trpc proxy.</done>
   </task>

<task type="auto">
  <name>Task 2: Full codebase verification -- zero proxy misuse remaining, build succeeds</name>
  <files>No files modified -- verification only</files>
  <action>
Run comprehensive verification to confirm the entire tRPC proxy call migration is complete:

1. **Codebase-wide grep for remaining proxy misuse:**
   Run: `grep -rn '= useTRPC()' src/ | grep -v node_modules`
   For each file that still has `useTRPC()`, check if it ALSO has `.mutate(` or `.query(` calls on the `trpc` variable. If so, this is a missed file that needs fixing.

   Specific pattern to catch remaining issues:
   `grep -rn 'trpc\.[a-zA-Z]*\.[a-zA-Z]*\.mutate\|trpc\.[a-zA-Z]*\.[a-zA-Z]*\.query' src/`
   This should return ZERO results. All `.mutate()` and `.query()` calls should be on `trpcClient`.

   Note: This grep pattern will NOT match `trpc.X.Y.queryOptions()` or `trpc.X.Y.mutationOptions()` which are correct.

2. **Verify correct patterns still work:**
   `grep -rn '\.queryOptions\|\.mutationOptions' src/ | head -20`
   Should still show many hits -- these are the CORRECT proxy pattern usages.

3. **Build verification:**
   Run: `pnpm run build`
   Must succeed with zero errors.

4. **If any remaining proxy misuse found in step 1:** Fix those files using the same pattern (add useTRPCClient import, get trpcClient, replace trpc.X.Y.mutate/query with trpcClient.X.Y.mutate/query). Then re-run verification.
   </action>
   <verify>
5. `grep -rn 'trpc\.[a-zA-Z]*\.[a-zA-Z]*\.mutate\b\|trpc\.[a-zA-Z]*\.[a-zA-Z]*\.query\b' src/ --include='*.ts' --include='*.tsx'` returns ZERO matches
6. `pnpm run build` exits with code 0
   </verify>
   <done>Zero .mutate()/.query() calls remain on useTRPC() proxy across entire src/ tree. pnpm run build succeeds. TRPC-01, TRPC-02 requirements fully satisfied.</done>
   </task>

</tasks>

<verification>
Full phase verification (all 3 plans combined):
1. `grep -rn 'trpc\.[a-zA-Z]*\.[a-zA-Z]*\.mutate\b' src/ --include='*.ts' --include='*.tsx'` -- ZERO matches (TRPC-01)
2. `grep -rn 'trpc\.[a-zA-Z]*\.[a-zA-Z]*\.query\b' src/ --include='*.ts' --include='*.tsx'` -- ZERO matches (TRPC-02)
3. `grep -rn '\.queryOptions\|\.mutationOptions' src/ --include='*.ts' --include='*.tsx' | wc -l` -- should be >100 (correct proxy pattern preserved)
4. `grep -rn 'useTRPCClient' src/ --include='*.ts' --include='*.tsx' | wc -l` -- should match number of fixed files (10+)
5. `pnpm run build` -- exits 0 (TRPC-04 partial -- build works)
</verification>

<success_criteria>

- Zero `.mutate()` calls on `trpc` (useTRPC proxy) in ANY src/ file (TRPC-01)
- Zero `.query()` calls on `trpc` (useTRPC proxy) in ANY src/ file (TRPC-02)
- All imperative calls use `trpcClient` from `useTRPCClient()`
- All `.queryOptions()` / `.mutationOptions()` calls remain on `trpc` proxy (unchanged)
- `pnpm run build` succeeds with zero errors
- Phase 47 requirements TRPC-01 and TRPC-02 fully satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/47-trpc-proxy-call-migration/47-03-SUMMARY.md`
</output>
