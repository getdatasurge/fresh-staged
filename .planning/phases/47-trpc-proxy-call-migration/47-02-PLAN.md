---
phase: 47-trpc-proxy-call-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts
  - src/components/billing/BillingTab.tsx
autonomous: true

must_haves:
  truths:
    - "Zero .mutate() calls on useTRPC() proxy in feature files"
    - "Zero .query() calls on useTRPC() proxy in feature files"
    - "All imperative tRPC calls use useTRPCClient() vanilla client"
    - "pnpm run build succeeds with no TypeScript errors in modified files"
  artifacts:
    - path: "src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts"
      provides: "Entity layout storage with useTRPCClient for all imperative calls"
      contains: "useTRPCClient"
    - path: "src/components/billing/BillingTab.tsx"
      provides: "Billing tab with useTRPCClient for query and mutate calls"
      contains: "useTRPCClient"
  key_links:
    - from: "src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts"
      to: "src/lib/trpc.ts"
      via: "import { useTRPCClient } from '@/lib/trpc'"
      pattern: "useTRPCClient"
    - from: "src/components/billing/BillingTab.tsx"
      to: "src/lib/trpc.ts"
      via: "import { useTRPCClient } from '@/lib/trpc'"
      pattern: "useTRPCClient"
---

<objective>
Fix all `.mutate()` and `.query()` calls on the `useTRPC()` proxy in 2 feature files (useEntityLayoutStorage and BillingTab) by switching them to use `useTRPCClient()` (vanilla client).

Purpose: These feature files use imperative `.mutate()` and `.query()` calls inside `mutationFn` callbacks and `useEffect` handlers. The `useTRPC()` proxy does not support these methods in tRPC v11 -- only `useTRPCClient()` does.

Output: 2 feature files with all imperative tRPC calls using the vanilla client pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix .query() and .mutate() calls in useEntityLayoutStorage.ts</name>
  <files>src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts</files>
  <action>
This file has 1 `.query()` call (in queryFn) and 4 `.mutate()` calls (in mutationFn callbacks).

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPC, useTRPCClient } from '@/lib/trpc'`
   Note: This file does NOT use `.queryOptions()` or `.mutationOptions()` but since it calls `useTRPC()` and we might want consistency, actually check -- the file only uses imperative calls. So change to: `import { useTRPCClient } from '@/lib/trpc'` and replace `const trpc = useTRPC()` with `const trpcClient = useTRPCClient()`.

   WAIT -- Actually, look at the file. It uses `useTRPC()` but NONE of the calls use `.queryOptions()` or `.mutationOptions()`. ALL calls are imperative `.query()` and `.mutate()`. So we can fully replace:
   - Import: `import { useTRPCClient } from '@/lib/trpc'` (remove useTRPC)
   - Hook: `const trpcClient = useTRPCClient()` (replace trpc)

2. Fix the 1 query call:
   - In queryFn: `trpc.dashboardLayouts.list.query(...)` -> `trpcClient.dashboardLayouts.list.query(...)`

3. Fix the 4 mutate calls:
   - saveLayoutMutation: `trpc.dashboardLayouts.create.mutate(...)` -> `trpcClient.dashboardLayouts.create.mutate(...)`
   - updateLayoutMutation: `trpc.dashboardLayouts.update.mutate(...)` -> `trpcClient.dashboardLayouts.update.mutate(...)`
   - deleteLayoutMutation: `trpc.dashboardLayouts.remove.mutate(...)` -> `trpcClient.dashboardLayouts.remove.mutate(...)`
   - setAsDefaultMutation: `trpc.dashboardLayouts.setDefault.mutate(...)` -> `trpcClient.dashboardLayouts.setDefault.mutate(...)`
  </action>
  <verify>Run `grep -n 'trpc\.' src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts` and confirm all calls use `trpcClient.` not bare `trpc.`. Run `grep -c '\.mutate\|\.query' src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts` to confirm 5 calls present.</verify>
  <done>All 5 imperative tRPC calls in useEntityLayoutStorage.ts use trpcClient (vanilla client). useTRPC import removed.</done>
</task>

<task type="auto">
  <name>Task 2: Fix .query() and .mutate() calls in BillingTab.tsx</name>
  <files>src/components/billing/BillingTab.tsx</files>
  <action>
This file has 1 `.query()` call and 2 `.mutate()` calls, all imperative inside async functions.

1. Change import: `import { useTRPC } from '@/lib/trpc'` -> `import { useTRPCClient } from '@/lib/trpc'`
   This file does NOT use `.queryOptions()` or `.mutationOptions()` at all -- every tRPC call is imperative. So fully replace useTRPC with useTRPCClient.

2. Change: `const trpc = useTRPC()` -> `const trpcClient = useTRPCClient()`

3. Fix the 1 query call:
   - In `loadSubscription`: `trpc.payments.getSubscription.query(...)` -> `trpcClient.payments.getSubscription.query(...)`

4. Fix the 2 mutate calls:
   - In `handleUpgrade`: `trpc.payments.createCheckoutSession.mutate(...)` -> `trpcClient.payments.createCheckoutSession.mutate(...)`
   - In `handleManageBilling`: `trpc.payments.createPortalSession.mutate(...)` -> `trpcClient.payments.createPortalSession.mutate(...)`
  </action>
  <verify>Run `grep -n 'trpc\.' src/components/billing/BillingTab.tsx` and confirm all calls use `trpcClient.` not bare `trpc.`. Run `grep -c '\.mutate\|\.query' src/components/billing/BillingTab.tsx` to confirm 3 calls present.</verify>
  <done>All 3 imperative tRPC calls in BillingTab.tsx use trpcClient (vanilla client). useTRPC import removed.</done>
</task>

</tasks>

<verification>
Run from project root:
1. `grep -rn '= useTRPC()' src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts src/components/billing/BillingTab.tsx` -- should return NO matches (these files should only use useTRPCClient)
2. `grep -rn 'useTRPCClient' src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts src/components/billing/BillingTab.tsx` -- both files should import and use it
3. `grep -rn '\.mutate\|\.query' src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts src/components/billing/BillingTab.tsx` -- all calls should be on `trpcClient.`
4. `pnpm run build` -- should succeed for these files
</verification>

<success_criteria>
- Zero `.mutate()` calls on `trpc` (useTRPC proxy) in the 2 feature files
- Zero `.query()` calls on `trpc` (useTRPC proxy) in the 2 feature files
- All imperative calls use `trpcClient` from `useTRPCClient()`
- TypeScript compilation succeeds for modified files
</success_criteria>

<output>
After completion, create `.planning/phases/47-trpc-proxy-call-migration/47-02-SUMMARY.md`
</output>
