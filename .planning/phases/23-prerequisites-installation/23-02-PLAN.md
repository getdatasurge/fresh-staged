---
phase: 23-prerequisites-installation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/prereq-lib.sh
autonomous: true

must_haves:
  truths:
    - "UFW firewall allows ports 22, 80, 443 and denies all other incoming traffic"
    - "fail2ban protects SSH from brute-force attacks (bans after 5 failed attempts)"
    - "jq is installed for JSON parsing in health checks"
    - "Running configure_firewall() twice produces same firewall state (idempotent)"
    - "fail2ban config is in jail.local (not jail.conf) to survive package updates"
  artifacts:
    - path: "scripts/lib/prereq-lib.sh"
      provides: "configure_firewall(), install_fail2ban(), install_jq() functions"
      exports: ["configure_firewall", "install_fail2ban", "install_jq", "install_all_prerequisites"]
  key_links:
    - from: "scripts/lib/prereq-lib.sh"
      to: "scripts/lib/preflight-lib.sh"
      via: "source statement and run_step() usage"
      pattern: "run_step.*install_"
---

<objective>
Add firewall, fail2ban, and jq installation functions to prereq-lib.sh with full prerequisites orchestration.

Purpose: Complete the prerequisites installation library with security hardening (UFW + fail2ban) and utility installation (jq), plus master function to install all prerequisites with checkpoint tracking.

Output: Extended `scripts/lib/prereq-lib.sh` with security and utility functions, plus `install_all_prerequisites()` orchestration function.
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-prerequisites-installation/23-RESEARCH.md
@.planning/phases/23-prerequisites-installation/23-01-PLAN.md
@scripts/lib/preflight-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UFW firewall configuration function</name>
  <files>scripts/lib/prereq-lib.sh</files>
  <action>
Add `configure_firewall()` function to prereq-lib.sh that:

1. **Early return if UFW already configured correctly:**
   ```bash
   # Check if UFW is active and has required rules
   if ufw status | grep -q "Status: active"; then
       if ufw status | grep -qE "22/tcp.*ALLOW" && \
          ufw status | grep -qE "80/tcp.*ALLOW" && \
          ufw status | grep -qE "443/tcp.*ALLOW"; then
           success "UFW firewall already configured (ports 22, 80, 443)"
           return 0
       fi
   fi
   ```

2. **Install UFW if not present:**
   ```bash
   ensure_package ufw
   ```

3. **Set default policies:**
   ```bash
   ufw default deny incoming
   ufw default allow outgoing
   ```

4. **Allow required ports (idempotent - ufw handles duplicates):**
   ```bash
   ufw allow 22/tcp comment 'SSH'
   ufw allow 80/tcp comment 'HTTP - Let'\''s Encrypt ACME'
   ufw allow 443/tcp comment 'HTTPS - Production traffic'
   ```

5. **Enable firewall non-interactively:**
   ```bash
   ufw --force enable
   ```

6. **Verify configuration:**
   ```bash
   if ufw status | grep -q "Status: active"; then
       success "UFW firewall configured (ports 22, 80, 443 allowed)"
   else
       error "UFW failed to enable"
       return 1
   fi
   ```

**Important:** Use `--force` flag to avoid interactive prompts. UFW allow commands are naturally idempotent (won't create duplicate rules).
  </action>
  <verify>
    ```bash
    # Verify configure_firewall function exists
    grep -q "^configure_firewall()" scripts/lib/prereq-lib.sh && echo "Has configure_firewall()"

    # Verify allows required ports
    grep -A 30 "^configure_firewall()" scripts/lib/prereq-lib.sh | grep -q "ufw allow 22" && echo "Allows SSH"
    grep -A 30 "^configure_firewall()" scripts/lib/prereq-lib.sh | grep -q "ufw allow 80" && echo "Allows HTTP"
    grep -A 30 "^configure_firewall()" scripts/lib/prereq-lib.sh | grep -q "ufw allow 443" && echo "Allows HTTPS"

    # Verify uses --force for non-interactive
    grep -A 30 "^configure_firewall()" scripts/lib/prereq-lib.sh | grep -q "ufw --force enable" && echo "Uses --force"
    ```
  </verify>
  <done>configure_firewall() function exists in prereq-lib.sh, allows ports 22/80/443, uses --force enable, and is idempotent</done>
</task>

<task type="auto">
  <name>Task 2: Add fail2ban SSH protection function</name>
  <files>scripts/lib/prereq-lib.sh</files>
  <action>
Add `install_fail2ban()` function to prereq-lib.sh that:

1. **Install fail2ban package:**
   ```bash
   ensure_package fail2ban
   ```

2. **Create jail.local only if it doesn't exist (idempotent):**
   ```bash
   if [[ ! -f /etc/fail2ban/jail.local ]]; then
       step "Creating fail2ban SSH jail configuration..."
       cat > /etc/fail2ban/jail.local <<'EOF'
   [DEFAULT]
   # Ban for 1 hour (3600 seconds)
   bantime = 3600
   # Check window of 10 minutes (600 seconds)
   findtime = 600
   # Ban after 5 failed attempts
   maxretry = 5

   [sshd]
   enabled = true
   port = 22
   # Use auto-detected log path and backend
   logpath = %(sshd_log)s
   backend = %(sshd_backend)s
   EOF
       success "Created /etc/fail2ban/jail.local"
   else
       success "fail2ban jail.local already exists"
   fi
   ```

3. **Enable and start fail2ban service:**
   ```bash
   systemctl enable fail2ban
   systemctl restart fail2ban  # Use restart to apply any config changes
   ```

4. **Verify fail2ban is running:**
   ```bash
   if systemctl is-active --quiet fail2ban; then
       success "fail2ban is active and protecting SSH"
   else
       error "fail2ban failed to start"
       echo "  Check: systemctl status fail2ban"
       return 1
   fi
   ```

**Important:** Use jail.local (not jail.conf) because jail.conf is overwritten on package updates. The %(sshd_log)s and %(sshd_backend)s placeholders auto-detect the correct values for the OS.
  </action>
  <verify>
    ```bash
    # Verify install_fail2ban function exists
    grep -q "^install_fail2ban()" scripts/lib/prereq-lib.sh && echo "Has install_fail2ban()"

    # Verify creates jail.local (not jail.conf)
    grep -A 30 "^install_fail2ban()" scripts/lib/prereq-lib.sh | grep -q "jail.local" && echo "Uses jail.local"

    # Verify has sshd jail configuration
    grep -A 40 "^install_fail2ban()" scripts/lib/prereq-lib.sh | grep -q "\[sshd\]" && echo "Has sshd jail"

    # Verify uses auto-detect placeholders
    grep -A 40 "^install_fail2ban()" scripts/lib/prereq-lib.sh | grep -q "%(sshd_log)s" && echo "Uses auto-detect placeholders"
    ```
  </verify>
  <done>install_fail2ban() function exists in prereq-lib.sh, creates jail.local with SSH protection, uses auto-detect placeholders</done>
</task>

<task type="auto">
  <name>Task 3: Add jq installation and prerequisites orchestration</name>
  <files>scripts/lib/prereq-lib.sh</files>
  <action>
Add `install_jq()` and `install_all_prerequisites()` functions to prereq-lib.sh:

1. **install_jq() function:**
   ```bash
   install_jq() {
       if command -v jq &>/dev/null; then
           success "jq is already installed ($(jq --version 2>/dev/null || echo 'version unknown'))"
           return 0
       fi

       step "Installing jq..."
       wait_for_apt_lock
       apt-get install -y jq

       if command -v jq &>/dev/null; then
           success "jq installed ($(jq --version))"
       else
           error "jq installation failed"
           return 1
       fi
   }
   ```

2. **install_all_prerequisites() master function:**
   Uses run_step() from preflight-lib.sh for checkpoint-based resume:
   ```bash
   install_all_prerequisites() {
       echo "========================================"
       echo "Prerequisites Installation"
       echo "========================================"
       echo ""

       # Run apt-get update once at the beginning
       step "Updating package lists..."
       apt_update

       # Install each prerequisite with checkpoint tracking
       run_step "docker" install_docker
       run_step "firewall" configure_firewall
       run_step "fail2ban" install_fail2ban
       run_step "jq" install_jq

       echo ""
       echo "========================================"
       success "All prerequisites installed successfully!"
       echo "========================================"

       # Summary
       echo ""
       echo "Installed components:"
       echo "  - Docker Engine: $(docker version --format '{{.Server.Version}}' 2>/dev/null || echo 'N/A')"
       echo "  - Docker Compose: $(docker compose version --short 2>/dev/null || echo 'N/A')"
       echo "  - UFW Firewall: $(ufw status | head -1)"
       echo "  - fail2ban: $(systemctl is-active fail2ban 2>/dev/null || echo 'N/A')"
       echo "  - jq: $(jq --version 2>/dev/null || echo 'N/A')"
       echo ""
   }
   ```

3. **Update self-test block** to verify all functions are defined:
   - Test that install_jq function exists
   - Test that install_all_prerequisites function exists
   - Test that configure_firewall function exists
   - Test that install_fail2ban function exists
  </action>
  <verify>
    ```bash
    # Verify install_jq function exists
    grep -q "^install_jq()" scripts/lib/prereq-lib.sh && echo "Has install_jq()"

    # Verify install_all_prerequisites function exists
    grep -q "^install_all_prerequisites()" scripts/lib/prereq-lib.sh && echo "Has install_all_prerequisites()"

    # Verify uses run_step for checkpoints
    grep -A 20 "^install_all_prerequisites()" scripts/lib/prereq-lib.sh | grep -q 'run_step "docker"' && echo "Uses run_step"

    # Run self-test
    bash scripts/lib/prereq-lib.sh 2>&1 | tail -5
    ```
  </verify>
  <done>install_jq() and install_all_prerequisites() functions exist, orchestration uses run_step() for checkpoint tracking, self-test passes</done>
</task>

</tasks>

<verification>
Phase 23 Plan 02 complete when:
- [ ] configure_firewall() allows ports 22, 80, 443 and denies other incoming
- [ ] configure_firewall() uses --force flag for non-interactive operation
- [ ] install_fail2ban() creates jail.local with SSH protection
- [ ] install_fail2ban() uses %(sshd_log)s placeholder for portability
- [ ] install_jq() detects existing installation and skips (idempotent)
- [ ] install_all_prerequisites() uses run_step() for checkpoint tracking
- [ ] Self-test passes when script run directly
</verification>

<success_criteria>
- UFW firewall is configured with deny incoming default and allows only 22, 80, 443
- fail2ban is installed with sensible defaults (ban 1hr after 5 failures in 10min)
- jq is installed for JSON parsing needs
- install_all_prerequisites() orchestrates all installations with checkpoint resume
- All functions are idempotent (safe to re-run)
- Full integration with preflight-lib.sh error handling and checkpoint system
</success_criteria>

<output>
After completion, create `.planning/phases/23-prerequisites-installation/23-02-SUMMARY.md`
</output>
