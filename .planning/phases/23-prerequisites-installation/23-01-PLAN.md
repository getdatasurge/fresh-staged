---
phase: 23-prerequisites-installation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/prereq-lib.sh
autonomous: true

must_haves:
  truths:
    - "Docker Engine 29.x runs on fresh Ubuntu 22.04+ VM after script execution"
    - "Docker Compose v2 is available via 'docker compose' command"
    - "Running script twice detects existing installation and skips (idempotent)"
    - "Script uses apt repository method, not get.docker.com"
  artifacts:
    - path: "scripts/lib/prereq-lib.sh"
      provides: "install_docker() and verify_docker_compose() functions"
      exports: ["install_docker", "verify_docker_compose", "is_package_installed", "ensure_package"]
      min_lines: 100
  key_links:
    - from: "scripts/lib/prereq-lib.sh"
      to: "scripts/lib/preflight-lib.sh"
      via: "source statement at top"
      pattern: "source.*preflight-lib\\.sh"
---

<objective>
Create prereq-lib.sh with idempotent Docker Engine installation using official apt repository method.

Purpose: Install Docker Engine 29.x and Compose v2 reliably with checkpoint-based resume, avoiding the non-idempotent get.docker.com script.

Output: `scripts/lib/prereq-lib.sh` with Docker installation functions that integrate with Phase 22 error handling infrastructure.
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-prerequisites-installation/23-RESEARCH.md
@scripts/lib/preflight-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prereq-lib.sh with Docker installation</name>
  <files>scripts/lib/prereq-lib.sh</files>
  <action>
Create `scripts/lib/prereq-lib.sh` as a new library file that:

1. **Header and sourcing:**
   - Add shebang and description header matching preflight-lib.sh style
   - Source preflight-lib.sh for error handling and checkpoint system:
     ```bash
     SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
     source "${SCRIPT_DIR}/preflight-lib.sh"
     ```
   - Set LIB_VERSION="1.0.0"

2. **Helper functions:**
   - `is_package_installed()` - Check if apt package is installed:
     ```bash
     is_package_installed() {
         local package="$1"
         dpkg-query -W -f='${Status}' "$package" 2>/dev/null | grep -q "install ok installed"
     }
     ```
   - `ensure_package()` - Install package if not present (idempotent):
     ```bash
     ensure_package() {
         local package="$1"
         if is_package_installed "$package"; then
             success "$package is already installed"
             return 0
         fi
         step "Installing $package..."
         apt-get install -y "$package"
         success "$package installed"
     }
     ```

3. **install_docker() function:**
   - Early return if Docker and Compose v2 already installed:
     ```bash
     if command -v docker &>/dev/null && docker compose version &>/dev/null; then
         local version=$(docker version --format '{{.Server.Version}}' 2>/dev/null || echo "unknown")
         success "Docker $version with Compose v2 already installed"
         return 0
     fi
     ```
   - Remove conflicting packages (docker.io, docker-doc, docker-compose, podman-docker, containerd, runc) - safe if not present
   - Install prerequisites (ca-certificates, curl)
   - Add Docker's official GPG key to /etc/apt/keyrings/docker.asc
   - Add Docker apt repository for Ubuntu (handle VERSION_CODENAME vs UBUNTU_CODENAME)
   - Install packages: docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin
   - Enable and start Docker service via systemctl
   - Verify with `docker run --rm hello-world`

4. **verify_docker_compose() function:**
   - Check `docker compose version` works
   - Log version number on success
   - Return error with guidance if not available

5. **Self-test block:**
   - Guard with `[[ "${BASH_SOURCE[0]}" == "${0}" ]]`
   - Test is_package_installed with "coreutils" (always installed)
   - Test that install_docker and verify_docker_compose are callable (dry run check)
   - Print "All prereq-lib tests passed!"

**Critical:** Do NOT use get.docker.com - the research explicitly states it's not idempotent. Use the apt repository method from https://docs.docker.com/engine/install/ubuntu/
  </action>
  <verify>
    ```bash
    # Verify file exists and has content
    test -f scripts/lib/prereq-lib.sh && wc -l scripts/lib/prereq-lib.sh

    # Verify sources preflight-lib.sh
    grep -q "source.*preflight-lib.sh" scripts/lib/prereq-lib.sh && echo "Sources preflight-lib.sh"

    # Verify install_docker function exists
    grep -q "^install_docker()" scripts/lib/prereq-lib.sh && echo "Has install_docker()"

    # Verify uses apt repository (not get.docker.com)
    grep -q "download.docker.com" scripts/lib/prereq-lib.sh && echo "Uses apt repository"
    ! grep -q "get.docker.com" scripts/lib/prereq-lib.sh && echo "Does not use get.docker.com"

    # Run self-test (will skip actual Docker install if not root)
    bash scripts/lib/prereq-lib.sh 2>&1 | tail -5
    ```
  </verify>
  <done>prereq-lib.sh exists with install_docker() and verify_docker_compose() functions using apt repository method, sources preflight-lib.sh, and passes self-test</done>
</task>

<task type="auto">
  <name>Task 2: Add apt lock handling for concurrent package operations</name>
  <files>scripts/lib/prereq-lib.sh</files>
  <action>
Add robust apt lock handling to prevent race conditions with unattended-upgrades or other apt processes.

1. **Add wait_for_apt_lock() function:**
   ```bash
   # Wait for apt lock to be released (handles unattended-upgrades)
   # Args: $1 = timeout in seconds (default: 120)
   wait_for_apt_lock() {
       local timeout="${1:-120}"
       local waited=0

       while fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
             fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
           if [[ $waited -ge $timeout ]]; then
               error "Timeout waiting for apt lock after ${timeout}s"
               echo "  Another package manager may be running (e.g., unattended-upgrades)"
               echo "  Check: ps aux | grep -E 'apt|dpkg'"
               return 1
           fi
           warning "Waiting for apt lock... (${waited}s/${timeout}s)"
           sleep 5
           ((waited+=5))
       done

       return 0
   }
   ```

2. **Add apt_update() wrapper:**
   ```bash
   # Run apt-get update with lock wait
   apt_update() {
       wait_for_apt_lock
       apt-get update -qq
   }
   ```

3. **Update install_docker() to use apt_update():**
   - Replace direct `apt-get update -qq` calls with `apt_update`
   - Add lock wait before apt-get install commands

4. **Update ensure_package() to use lock wait:**
   - Add `wait_for_apt_lock` before apt-get install

This prevents "Could not get lock /var/lib/apt/lists/lock" errors on fresh VMs where unattended-upgrades may be running.
  </action>
  <verify>
    ```bash
    # Verify wait_for_apt_lock function exists
    grep -q "^wait_for_apt_lock()" scripts/lib/prereq-lib.sh && echo "Has wait_for_apt_lock()"

    # Verify apt_update wrapper exists
    grep -q "^apt_update()" scripts/lib/prereq-lib.sh && echo "Has apt_update()"

    # Verify install_docker uses apt_update or wait_for_apt_lock
    grep -A 50 "^install_docker()" scripts/lib/prereq-lib.sh | grep -q "apt_update\|wait_for_apt_lock" && echo "install_docker uses lock handling"
    ```
  </verify>
  <done>prereq-lib.sh has apt lock handling functions and install_docker() uses them to prevent race conditions</done>
</task>

</tasks>

<verification>
Phase 23 Plan 01 complete when:
- [ ] scripts/lib/prereq-lib.sh exists with 100+ lines
- [ ] File sources preflight-lib.sh for error handling
- [ ] install_docker() uses apt repository method (not get.docker.com)
- [ ] verify_docker_compose() checks for v2 plugin
- [ ] is_package_installed() and ensure_package() helper functions exist
- [ ] wait_for_apt_lock() handles concurrent apt operations
- [ ] Self-test passes when run directly
</verification>

<success_criteria>
- prereq-lib.sh creates install_docker() function using official apt repository method
- Docker installation is idempotent (detects existing installation and returns success)
- Compose v2 verification confirms `docker compose` plugin availability
- apt lock handling prevents race conditions with unattended-upgrades
- All functions integrate with preflight-lib.sh error handling
</success_criteria>

<output>
After completion, create `.planning/phases/23-prerequisites-installation/23-01-SUMMARY.md`
</output>
