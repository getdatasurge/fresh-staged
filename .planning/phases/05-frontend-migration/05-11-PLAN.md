---
phase: 05-frontend-migration
plan: 11
type: execute
wave: 5
depends_on: ["05-10"]
files_modified:
  - src/hooks/__tests__/useOrganizations.test.ts
  - src/hooks/__tests__/useSites.test.ts
  - src/hooks/__tests__/useAlerts.test.ts
  - src/lib/__tests__/api-client.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests exist for migrated hooks"
    - "API client tests verify retry and error handling"
    - "All tests pass"
  artifacts:
    - path: "src/lib/__tests__/api-client.test.ts"
      provides: "API client unit tests"
      contains: "describe.*apiClient"
    - path: "src/hooks/__tests__/useOrganizations.test.ts"
      provides: "Organization hook tests"
      contains: "describe.*useOrganization"
  key_links:
    - from: "src/hooks/__tests__/*.test.ts"
      to: "src/hooks/*.ts"
      via: "import hook under test"
      pattern: "import.*from.*hooks"
---

<objective>
Add unit tests for migrated API client and critical hooks.

Purpose: Verify the migration works correctly with comprehensive tests for the core infrastructure.

Output:
- API client tests for retry, error handling, auth
- Hook tests for key migrated hooks
- All tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-frontend-migration/05-RESEARCH.md
@.planning/phases/05-frontend-migration/05-01-SUMMARY.md
@.planning/phases/05-frontend-migration/05-10-SUMMARY.md
@src/lib/api-client.ts
@src/hooks/useNavTree.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client tests</name>
  <files>src/lib/__tests__/api-client.test.ts</files>
  <action>
Create unit tests for the API client:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { apiClient, createAuthenticatedClient } from '../api-client';

// Mock fetch globally
const mockFetch = vi.fn();
global.fetch = mockFetch;

describe('apiClient', () => {
  beforeEach(() => {
    mockFetch.mockClear();
  });

  describe('createAuthenticatedClient', () => {
    it('adds auth header to requests', async () => {
      mockFetch.mockResolvedValueOnce({
        ok: true,
        json: () => Promise.resolve({ data: 'test' }),
      });

      const client = createAuthenticatedClient('test-token');
      await client.get('test-endpoint').json();

      expect(mockFetch).toHaveBeenCalledWith(
        expect.stringContaining('test-endpoint'),
        expect.objectContaining({
          headers: expect.objectContaining({
            'x-stack-access-token': 'test-token',
          }),
        })
      );
    });
  });

  describe('error handling', () => {
    it('logs errors to console', async () => {
      const consoleSpy = vi.spyOn(console, 'error');
      mockFetch.mockResolvedValueOnce({
        ok: false,
        status: 500,
        json: () => Promise.resolve({ message: 'Server error' }),
      });

      await expect(apiClient.get('test').json()).rejects.toThrow();
      expect(consoleSpy).toHaveBeenCalled();
    });

    it('throws with error message from response', async () => {
      mockFetch.mockResolvedValueOnce({
        ok: false,
        status: 400,
        json: () => Promise.resolve({ message: 'Validation failed' }),
      });

      await expect(apiClient.get('test').json()).rejects.toThrow('Validation failed');
    });

    it('handles 401 unauthorized', async () => {
      mockFetch.mockResolvedValueOnce({
        ok: false,
        status: 401,
        json: () => Promise.resolve({ message: 'Unauthorized' }),
      });

      await expect(apiClient.get('test').json()).rejects.toThrow();
    });
  });

  describe('retry behavior', () => {
    it('retries on 5xx errors', async () => {
      mockFetch
        .mockResolvedValueOnce({ ok: false, status: 503, json: () => Promise.resolve({}) })
        .mockResolvedValueOnce({ ok: true, json: () => Promise.resolve({ data: 'success' }) });

      const result = await apiClient.get('test').json();
      expect(result).toEqual({ data: 'success' });
      expect(mockFetch).toHaveBeenCalledTimes(2);
    });
  });
});
```

Test coverage:
- Auth header injection
- Error logging to console
- Error message extraction
- Retry on transient errors
- 401/403 handling
  </action>
  <verify>Run `pnpm test src/lib/__tests__/api-client.test.ts` - all tests pass</verify>
  <done>API client has comprehensive unit tests</done>
</task>

<task type="auto">
  <name>Task 2: Create hook tests</name>
  <files>src/hooks/__tests__/useOrganizations.test.ts, src/hooks/__tests__/useSites.test.ts</files>
  <action>
Create unit tests for critical migrated hooks:

**src/hooks/__tests__/useOrganizations.test.ts:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useOrganization } from '../useOrganizations';

// Mock dependencies
vi.mock('@stackframe/stack', () => ({
  useUser: () => ({
    id: 'test-user-id',
    getAuthJson: () => Promise.resolve({ accessToken: 'test-token' }),
  }),
}));

vi.mock('@/lib/api', () => ({
  organizationsApi: {
    getOrganization: vi.fn(),
  },
}));

vi.mock('../useOrgScope', () => ({
  useOrgScope: () => ({ orgId: 'test-org-id', isReady: true }),
}));

import { organizationsApi } from '@/lib/api';

const queryClient = new QueryClient({
  defaultOptions: { queries: { retry: false } },
});

const wrapper = ({ children }: { children: React.ReactNode }) => (
  <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
);

describe('useOrganization', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    queryClient.clear();
  });

  it('fetches organization data', async () => {
    const mockOrg = { id: 'test-org-id', name: 'Test Org' };
    vi.mocked(organizationsApi.getOrganization).mockResolvedValueOnce(mockOrg);

    const { result } = renderHook(() => useOrganization('test-org-id'), { wrapper });

    await waitFor(() => expect(result.current.isSuccess).toBe(true));

    expect(result.current.data).toEqual(mockOrg);
    expect(organizationsApi.getOrganization).toHaveBeenCalledWith('test-org-id', 'test-token');
  });

  it('preserves query key for cache', async () => {
    vi.mocked(organizationsApi.getOrganization).mockResolvedValueOnce({ id: 'test', name: 'Test' });

    const { result } = renderHook(() => useOrganization('test-org-id'), { wrapper });

    await waitFor(() => expect(result.current.isSuccess).toBe(true));

    // Verify cache entry exists with correct key
    const cachedData = queryClient.getQueryData(['org', 'test-org-id', 'profile']);
    expect(cachedData).toBeDefined();
  });
});
```

**src/hooks/__tests__/useSites.test.ts:**
Similar pattern testing:
- Data fetching via sitesApi
- Query key preservation
- Error handling
- Enabled/disabled state based on orgId

Focus on testing the migration worked correctly (uses new API, preserves cache keys).
  </action>
  <verify>Run `pnpm test src/hooks/__tests__/` - all tests pass</verify>
  <done>Critical hooks have unit tests verifying migration</done>
</task>

<task type="auto">
  <name>Task 3: Create alert hooks tests</name>
  <files>src/hooks/__tests__/useAlerts.test.ts</files>
  <action>
Create tests for alert-related hooks:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useUnitAlerts, useAcknowledgeAlert } from '../useUnitAlerts';

// Mock dependencies
vi.mock('@stackframe/stack', () => ({
  useUser: () => ({
    id: 'test-user-id',
    getAuthJson: () => Promise.resolve({ accessToken: 'test-token' }),
  }),
}));

vi.mock('@/lib/api', () => ({
  alertsApi: {
    listAlerts: vi.fn(),
    acknowledgeAlert: vi.fn(),
    resolveAlert: vi.fn(),
  },
}));

vi.mock('../useOrgScope', () => ({
  useOrgScope: () => ({ orgId: 'test-org-id', isReady: true }),
}));

import { alertsApi } from '@/lib/api';

const queryClient = new QueryClient({
  defaultOptions: { queries: { retry: false } },
});

const wrapper = ({ children }: { children: React.ReactNode }) => (
  <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
);

describe('useUnitAlerts', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    queryClient.clear();
  });

  it('fetches alerts for a unit', async () => {
    const mockAlerts = {
      data: [
        { id: 'alert-1', unitId: 'unit-1', type: 'temperature', status: 'active' },
      ],
      pagination: { page: 1, limit: 50, total: 1, totalPages: 1 },
    };
    vi.mocked(alertsApi.listAlerts).mockResolvedValueOnce(mockAlerts);

    const { result } = renderHook(() => useUnitAlerts('unit-1'), { wrapper });

    await waitFor(() => expect(result.current.isSuccess).toBe(true));

    expect(result.current.data).toEqual(mockAlerts.data);
    expect(alertsApi.listAlerts).toHaveBeenCalledWith(
      'test-org-id',
      expect.objectContaining({ unitId: 'unit-1' }),
      'test-token'
    );
  });
});

describe('useAcknowledgeAlert', () => {
  it('acknowledges alert and invalidates cache', async () => {
    vi.mocked(alertsApi.acknowledgeAlert).mockResolvedValueOnce({
      id: 'alert-1',
      status: 'acknowledged',
    });

    const { result } = renderHook(() => useAcknowledgeAlert(), { wrapper });

    await result.current.mutateAsync('alert-1');

    expect(alertsApi.acknowledgeAlert).toHaveBeenCalledWith('test-org-id', 'alert-1', 'test-token');
  });
});
```

Test coverage:
- Alert list fetching
- Alert acknowledgement mutation
- Cache invalidation after mutation
- Error handling
  </action>
  <verify>Run `pnpm test src/hooks/__tests__/useAlerts.test.ts` - all tests pass</verify>
  <done>Alert hooks have comprehensive tests</done>
</task>

</tasks>

<verification>
1. Run `pnpm test` - all tests pass
2. API client tests cover retry, error handling, auth
3. Hook tests verify migration patterns
4. Test output shows coverage of critical paths
</verification>

<success_criteria>
- API client has unit tests for core functionality
- Organization hook tests verify migration
- Site hook tests verify CRUD operations
- Alert hook tests verify queries and mutations
- All tests pass with `pnpm test`
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-migration/05-11-SUMMARY.md`
</output>
