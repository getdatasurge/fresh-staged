---
phase: 05-frontend-migration
plan: 14
type: execute
wave: 3
depends_on: ["05-04", "05-08"]
files_modified:
  - src/hooks/useTTNSetupWizard.ts
  - src/hooks/useTTNDeprovision.ts
  - src/hooks/useCheckTtnProvisioningState.ts
  - src/hooks/useGatewayProvisioningPreflight.ts
autonomous: true

must_haves:
  truths:
    - "TTN setup wizard hook uses Stack Auth for authentication"
    - "TTN deprovision hook uses Stack Auth"
    - "Provisioning state check hooks use Stack Auth"
    - "All edge function calls pass Stack Auth token"
  artifacts:
    - path: "src/hooks/useTTNSetupWizard.ts"
      provides: "TTN setup wizard orchestration"
      exports: ["useTTNSetupWizard"]
    - path: "src/hooks/useTTNDeprovision.ts"
      provides: "TTN deprovisioning operations"
      exports: ["useTTNDeprovision"]
    - path: "src/hooks/useCheckTtnProvisioningState.ts"
      provides: "TTN provisioning state polling"
      exports: ["useCheckTtnProvisioningState"]
    - path: "src/hooks/useGatewayProvisioningPreflight.ts"
      provides: "Gateway provisioning validation"
      exports: ["useGatewayProvisioningPreflight"]
  key_links:
    - from: "src/hooks/useTTNSetupWizard.ts"
      to: "@stackframe/stack"
      via: "import useUser"
      pattern: "useUser"
---

<objective>
Migrate remaining TTN provisioning and wizard hooks to Stack Auth.

Purpose: These hooks handle TTN setup wizard flows, deprovisioning, and state checking. They're separated from plan 08 to keep task scope manageable.

Output:
- useTTNSetupWizard uses Stack Auth
- useTTNDeprovision uses Stack Auth
- useCheckTtnProvisioningState uses Stack Auth
- useGatewayProvisioningPreflight uses Stack Auth
- All edge function calls pass Stack Auth token
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-frontend-migration/05-RESEARCH.md
@.planning/phases/05-frontend-migration/05-04-SUMMARY.md
@.planning/phases/05-frontend-migration/05-08-SUMMARY.md
@src/hooks/useTTNSetupWizard.ts
@src/hooks/useTTNDeprovision.ts
@src/hooks/useCheckTtnProvisioningState.ts
@src/hooks/useGatewayProvisioningPreflight.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useTTNSetupWizard to Stack Auth</name>
  <files>src/hooks/useTTNSetupWizard.ts</files>
  <action>
Migrate the TTN setup wizard hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function calls with backend job queue
 * - Replace Supabase data calls with API calls
 *
 * Current status: Stack Auth for identity, edge functions for operations (Phase 5)
 */
import { useState, useCallback } from "react";
import { useUser } from "@stackframe/stack";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

interface WizardStep {
  id: string;
  status: 'pending' | 'in_progress' | 'complete' | 'error';
  error?: string;
}

export function useTTNSetupWizard() {
  const { orgId } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();
  const [steps, setSteps] = useState<WizardStep[]>([]);

  // Helper for edge function calls with Stack Auth
  const invokeEdgeFunction = useCallback(async (functionName: string, payload: any) => {
    if (!user) throw new Error('Not authenticated');
    const { accessToken } = await user.getAuthJson();

    // TODO Phase 6: Replace with backend API/job calls
    const { data, error } = await supabase.functions.invoke(functionName, {
      body: { organizationId: orgId, ...payload },
      headers: { 'x-stack-access-token': accessToken },
    });

    if (error) throw error;
    return data;
  }, [user, orgId]);

  const startSetup = useMutation({
    mutationFn: async (config: TTNSetupConfig) => {
      // Reset steps
      setSteps([
        { id: 'create-application', status: 'pending' },
        { id: 'configure-webhook', status: 'pending' },
        { id: 'generate-api-key', status: 'pending' },
      ]);

      // Execute steps sequentially
      try {
        setSteps(s => s.map(step =>
          step.id === 'create-application' ? { ...step, status: 'in_progress' } : step
        ));
        await invokeEdgeFunction('ttn-create-application', config);
        setSteps(s => s.map(step =>
          step.id === 'create-application' ? { ...step, status: 'complete' } : step
        ));

        // ... continue with other steps
      } catch (error) {
        // Mark current step as error
        throw error;
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).ttnSettings() });
    },
  });

  return { steps, startSetup };
}
```

Preserve existing wizard step interface.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. Edge function calls include Stack Auth token
4. TODO markers present
  </verify>
  <done>TTN setup wizard uses Stack Auth</done>
</task>

<task type="auto">
  <name>Task 2: Migrate useTTNDeprovision to Stack Auth</name>
  <files>src/hooks/useTTNDeprovision.ts</files>
  <action>
Migrate the TTN deprovisioning hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function calls with backend job queue
 *
 * Current status: Stack Auth for identity, edge functions for operations (Phase 5)
 */
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

interface DeprovisionParams {
  deviceId?: string;
  gatewayId?: string;
  removeAll?: boolean;
}

export function useTTNDeprovision() {
  const { orgId } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();

  const deprovision = useMutation({
    mutationFn: async (params: DeprovisionParams) => {
      if (!orgId || !user) throw new Error('Not authenticated');
      const { accessToken } = await user.getAuthJson();

      // TODO Phase 6: Replace with backend job queue
      const { data, error } = await supabase.functions.invoke('ttn-deprovision', {
        body: { organizationId: orgId, ...params },
        headers: { 'x-stack-access-token': accessToken },
      });

      if (error) throw error;
      return data;
    },
    onSuccess: (_, params) => {
      // Invalidate relevant queries based on what was deprovisioned
      if (params.deviceId) {
        queryClient.invalidateQueries({ queryKey: qk.org(orgId).loraSensors() });
      }
      if (params.gatewayId) {
        queryClient.invalidateQueries({ queryKey: qk.org(orgId).gateways() });
      }
      if (params.removeAll) {
        queryClient.invalidateQueries({ queryKey: qk.org(orgId).ttnSettings() });
      }
    },
  });

  return { deprovision };
}
```
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth token passed to edge function
3. TODO markers present
4. Query invalidation preserved
  </verify>
  <done>TTN deprovision hook uses Stack Auth</done>
</task>

<task type="auto">
  <name>Task 3: Migrate useCheckTtnProvisioningState to Stack Auth</name>
  <files>src/hooks/useCheckTtnProvisioningState.ts</files>
  <action>
Migrate the provisioning state check hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace Supabase polling with backend job status endpoint
 *
 * Current status: Stack Auth for identity, Supabase for data (Phase 5)
 */
import { useQuery } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

interface ProvisioningState {
  status: 'pending' | 'in_progress' | 'complete' | 'failed';
  message?: string;
  progress?: number;
}

export function useCheckTtnProvisioningState(jobId: string | null) {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();

  return useQuery({
    queryKey: [...qk.org(orgId).ttnSettings(), 'provisioning', jobId],
    queryFn: async (): Promise<ProvisioningState | null> => {
      if (!jobId || !orgId || !user) return null;

      // TODO Phase 6: Migrate to backend job status endpoint
      const { data, error } = await supabase
        .from('provisioning_jobs')
        .select('status, message, progress')
        .eq('id', jobId)
        .eq('organization_id', orgId)
        .single();

      if (error) {
        console.error('[useCheckTtnProvisioningState] Error:', error);
        throw error;
      }

      return data as ProvisioningState;
    },
    enabled: isReady && !!jobId && !!user,
    refetchInterval: (data) => {
      // Poll while in progress
      if (data?.status === 'pending' || data?.status === 'in_progress') {
        return 2000; // Poll every 2 seconds
      }
      return false; // Stop polling when complete or failed
    },
  });
}
```

Preserve polling behavior for job status.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. Polling behavior preserved
4. TODO markers for Phase 6 migration
  </verify>
  <done>Provisioning state check hook uses Stack Auth</done>
</task>

<task type="auto">
  <name>Task 4: Migrate useGatewayProvisioningPreflight to Stack Auth</name>
  <files>src/hooks/useGatewayProvisioningPreflight.ts</files>
  <action>
Migrate the gateway provisioning preflight check hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function with backend validation endpoint
 *
 * Current status: Stack Auth for identity, edge functions for validation (Phase 5)
 */
import { useQuery } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

interface PreflightResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
  gatewayInfo?: {
    eui: string;
    name: string;
    frequency_plan: string;
  };
}

export function useGatewayProvisioningPreflight(gatewayEui: string | null) {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();

  return useQuery({
    queryKey: [...qk.org(orgId).gateways(), 'preflight', gatewayEui],
    queryFn: async (): Promise<PreflightResult | null> => {
      if (!gatewayEui || !orgId || !user) return null;
      const { accessToken } = await user.getAuthJson();

      // TODO Phase 6: Replace with backend validation endpoint
      const { data, error } = await supabase.functions.invoke('ttn-gateway-preflight', {
        body: { organizationId: orgId, gatewayEui },
        headers: { 'x-stack-access-token': accessToken },
      });

      if (error) throw error;
      return data as PreflightResult;
    },
    enabled: isReady && !!gatewayEui && !!user,
    staleTime: 1000 * 60, // Cache for 1 minute
  });
}
```

Pass Stack Auth token to edge function for validation.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth token passed to edge function
3. Query caching preserved
4. TODO markers present
  </verify>
  <done>Gateway preflight hook uses Stack Auth</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. All hooks import useUser from @stackframe/stack
3. No supabase.auth calls remain
4. Edge function calls include Stack Auth token header
5. TODO comments clearly mark remaining Supabase dependencies
6. Query keys preserved
7. Polling and caching behaviors preserved
</verification>

<success_criteria>
- All 4 TTN provisioning hooks use Stack Auth
- Supabase auth calls completely removed
- Edge function calls pass Stack Auth token
- Polling behavior preserved for state checking
- Hooks continue to function in hybrid mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-migration/05-14-SUMMARY.md`
</output>
