---
phase: 05-frontend-migration
plan: 04
type: execute
wave: 2
depends_on: ['05-01']
files_modified:
  - backend/src/routes/auth.ts
  - backend/src/app.ts
  - src/lib/api/auth.ts
  - src/hooks/useEffectiveIdentity.ts
  - src/hooks/useOrgScope.ts
  - src/hooks/useUserRole.ts
  - src/hooks/useAuthAndOnboarding.ts
autonomous: true

must_haves:
  truths:
    - 'Identity hooks use Stack Auth instead of Supabase auth'
    - 'GET /api/auth/me returns current user profile and org roles'
    - 'Org scope remains functional for downstream hooks'
    - 'User role lookups work with new backend'
  artifacts:
    - path: 'backend/src/routes/auth.ts'
      provides: 'Auth route with /api/auth/me endpoint'
      exports: ['authRoutes']
    - path: 'src/hooks/useEffectiveIdentity.ts'
      provides: 'Effective user/org identity resolution'
      exports: ['useEffectiveIdentity']
    - path: 'src/hooks/useOrgScope.ts'
      provides: 'Org scope for data fetching'
      exports: ['useOrgScope']
    - path: 'src/hooks/useUserRole.ts'
      provides: 'User role in current org'
      exports: ['useUserRole']
  key_links:
    - from: 'src/hooks/useEffectiveIdentity.ts'
      to: 'backend/src/routes/auth.ts'
      via: 'fetch /api/auth/me'
      pattern: "authApi\\.getMe|/api/auth/me"
    - from: 'src/hooks/useOrgScope.ts'
      to: 'src/hooks/useEffectiveIdentity.ts'
      via: 'import useEffectiveIdentity'
      pattern: 'useEffectiveIdentity'
---

<objective>
Migrate core identity and auth hooks from Supabase to Stack Auth + new API.

Purpose: These hooks provide the foundation for all data fetching - orgId and userId scope. They must be migrated first to enable subsequent hook migrations.

Output:

- Backend /api/auth/me endpoint that returns current user's profile and org context
- useEffectiveIdentity migrated to Stack Auth + new API
- useOrgScope continues working (may need minimal changes)
- useUserRole uses new API for role lookups
- useAuthAndOnboarding works with Stack Auth flows
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-frontend-migration/05-RESEARCH.md
@.planning/phases/05-frontend-migration/05-01-SUMMARY.md
@backend/src/app.ts
@backend/src/middleware/stack-auth.ts
@src/hooks/useEffectiveIdentity.ts
@src/hooks/useOrgScope.ts
@src/hooks/useUserRole.ts
@src/hooks/useAuthAndOnboarding.ts
@src/contexts/SuperAdminContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /api/auth/me backend endpoint</name>
  <files>backend/src/routes/auth.ts, backend/src/app.ts, src/lib/api/auth.ts</files>
  <action>
Create a new auth route with GET /api/auth/me endpoint:

**Backend: backend/src/routes/auth.ts**

```typescript
import { FastifyPluginAsync } from 'fastify';
import { stackAuth } from '../middleware/stack-auth.js';

interface AuthMeResponse {
  userId: string;
  email: string | null;
  displayName: string | null;
  primaryOrganizationId: string | null;
  organizations: Array<{
    organizationId: string;
    role: 'owner' | 'admin' | 'viewer';
  }>;
}

export const authRoutes: FastifyPluginAsync = async (fastify) => {
  // GET /api/auth/me - Get current user's profile and org context
  fastify.get<{ Reply: AuthMeResponse }>(
    '/me',
    {
      preHandler: [stackAuth],
    },
    async (request, reply) => {
      // stackAuth middleware adds user to request
      const user = request.user;
      if (!user) {
        return reply.code(401).send({ error: 'Unauthorized' });
      }

      // Query user's organization memberships from profiles/user_roles
      // This uses the same pattern as org-context middleware
      const db = fastify.db;

      // Get user's org memberships
      const memberships = await db
        .selectFrom('profiles')
        .select(['organization_id', 'role'])
        .where('user_id', '=', user.userId)
        .execute();

      const organizations = memberships.map((m) => ({
        organizationId: m.organization_id,
        role: m.role as 'owner' | 'admin' | 'viewer',
      }));

      // Primary org is first organization (or could be stored in profile)
      const primaryOrganizationId = organizations[0]?.organizationId ?? null;

      return {
        userId: user.userId,
        email: user.email ?? null,
        displayName: user.displayName ?? null,
        primaryOrganizationId,
        organizations,
      };
    },
  );
};
```

**Register in backend/src/app.ts:**

```typescript
import { authRoutes } from './routes/auth.js';
// ...
app.register(authRoutes, { prefix: '/api/auth' });
```

**Frontend: src/lib/api/auth.ts**

```typescript
import { apiClient } from '../api-client';

export interface AuthMeResponse {
  userId: string;
  email: string | null;
  displayName: string | null;
  primaryOrganizationId: string | null;
  organizations: Array<{
    organizationId: string;
    role: 'owner' | 'admin' | 'viewer';
  }>;
}

export const authApi = {
  getMe: async (accessToken: string): Promise<AuthMeResponse> => {
    return apiClient
      .get('api/auth/me', {
        headers: { 'x-stack-access-token': accessToken },
      })
      .json<AuthMeResponse>();
  },
};
```

Add authApi to the barrel export in src/lib/api/index.ts.
</action>
<verify>

1. `cd backend && pnpm tsc --noEmit` passes
2. Backend test: `curl -H "x-stack-access-token: test" http://localhost:3000/api/auth/me` returns user data
3. Frontend: authApi.getMe function exists and compiles
   </verify>
   <done>/api/auth/me endpoint returns current user profile with org memberships</done>
   </task>

<task type="auto">
  <name>Task 2: Migrate useEffectiveIdentity to Stack Auth + new API</name>
  <files>src/hooks/useEffectiveIdentity.ts</files>
  <action>
Migrate `useEffectiveIdentity.ts` to use Stack Auth and the new /api/auth/me endpoint:

**Key changes:**

1. Replace Supabase auth calls with Stack Auth:
   - `supabase.auth.getUser()` â†’ `useUser()` from `@stackframe/stack`
   - The Stack Auth user object has `.id` for user ID

2. For getting org from profile, call /api/auth/me:
   - Replace `supabase.from('profiles').select()...` with `authApi.getMe()`
   - Use TanStack Query for caching the auth/me response

3. For impersonation RPC calls:
   - `supabase.rpc('get_active_impersonation')` - mark with TODO for Phase 6
   - Core identity resolution (effectiveUserId, effectiveOrgId) must work without impersonation

**Migration pattern:**

```typescript
import { useUser } from '@stackframe/stack';
import { useQuery } from '@tanstack/react-query';
import { authApi } from '@/lib/api';
import { qk } from '@/lib/queryKeys';

export function useEffectiveIdentity() {
  const stackUser = useUser();

  // Fetch user profile with org context
  const { data: profile, isLoading } = useQuery({
    queryKey: qk.user(stackUser?.id ?? null).profile(),
    queryFn: async () => {
      if (!stackUser) return null;
      const { accessToken } = await stackUser.getAuthJson();
      return authApi.getMe(accessToken);
    },
    enabled: !!stackUser,
    staleTime: 1000 * 60 * 5, // 5 min cache
  });

  // TODO: Impersonation support - Phase 6
  // For now, effective identity is just the authenticated user
  const effectiveUserId = profile?.userId ?? null;
  const effectiveOrgId = profile?.primaryOrganizationId ?? null;

  return {
    effectiveUserId,
    effectiveOrgId,
    isInitialized: !isLoading,
    isImpersonating: false, // TODO: Phase 6
    // ... preserve rest of interface
  };
}
```

**Critical:** Preserve the hook's public API (EffectiveIdentity interface) exactly.
</action>
<verify>

1. Hook compiles without TypeScript errors
2. Stack Auth useUser import is present
3. authApi.getMe is called for profile data
4. Supabase auth calls removed
   </verify>
   <done>useEffectiveIdentity uses Stack Auth + /api/auth/me for identity resolution</done>
   </task>

<task type="auto">
  <name>Task 3: Update useUserRole and useAuthAndOnboarding</name>
  <files>src/hooks/useUserRole.ts, src/hooks/useAuthAndOnboarding.ts</files>
  <action>
Migrate `useUserRole.ts` and `useAuthAndOnboarding.ts` to Stack Auth:

**useUserRole:**
Use the auth/me response which already includes org roles:

```typescript
import { useQuery } from '@tanstack/react-query';
import { useUser } from '@stackframe/stack';
import { authApi } from '@/lib/api';
import { qk } from '@/lib/queryKeys';

export function useUserRole(orgId: string | null) {
  const user = useUser();

  return useQuery({
    queryKey: qk.user(user?.id ?? null).role(),
    queryFn: async () => {
      if (!orgId || !user) return null;
      const { accessToken } = await user.getAuthJson();
      const profile = await authApi.getMe(accessToken);

      // Find role for the specified org
      const membership = profile.organizations.find((o) => o.organizationId === orgId);
      return membership?.role ?? null;
    },
    enabled: !!orgId && !!user,
  });
}
```

**useAuthAndOnboarding:**

```typescript
import { useUser } from '@stackframe/stack';
import { useEffectiveIdentity } from './useEffectiveIdentity';

export function useAuthAndOnboarding() {
  const user = useUser();
  const { effectiveOrgId, isInitialized } = useEffectiveIdentity();

  const isAuthenticated = !!user;
  const hasOrganization = !!effectiveOrgId;
  const needsOnboarding = isAuthenticated && !hasOrganization;
  const isReady = isInitialized;

  return {
    isAuthenticated,
    hasOrganization,
    needsOnboarding,
    isReady,
    user,
  };
}
```

Preserve both hooks' public interfaces for consuming components.
</action>
<verify>

1. Both hooks compile without TypeScript errors
2. Stack Auth imports present in both
3. No Supabase auth imports remain
   </verify>
   <done>useUserRole uses auth/me for role, useAuthAndOnboarding uses Stack Auth</done>
   </task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes (both backend and frontend)
2. `cd backend && pnpm test` - auth routes work
3. No Supabase auth imports remain in migrated hooks
4. useOrgScope still returns valid orgId when authenticated
5. useUserRole returns role from API
6. Login/auth flow still works in browser
</verification>

<success_criteria>

- /api/auth/me endpoint returns user profile with org roles
- Core identity hooks compile without Supabase auth dependency
- Stack Auth useUser() used for authentication state
- Org scope resolution works for downstream hooks
- Role lookup uses authApi.getMe response
  </success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-migration/05-04-SUMMARY.md`
</output>
