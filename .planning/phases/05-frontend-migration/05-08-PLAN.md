---
phase: 05-frontend-migration
plan: 08
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - src/hooks/useTTNSettings.ts
  - src/hooks/useTTNApiKey.ts
  - src/hooks/useTTNWebhook.ts
  - src/hooks/useTTNOperations.ts
autonomous: true

must_haves:
  truths:
    - "TTN settings and API key hooks use Stack Auth for authentication"
    - "TTN webhook and operations hooks use Stack Auth"
    - "Edge function calls pass Stack Auth token in headers"
    - "Supabase data calls marked for later migration"
  artifacts:
    - path: "src/hooks/useTTNSettings.ts"
      provides: "TTN configuration management"
      exports: ["useTTNSettings"]
    - path: "src/hooks/useTTNApiKey.ts"
      provides: "TTN API key management"
      exports: ["useTTNApiKey"]
    - path: "src/hooks/useTTNWebhook.ts"
      provides: "TTN webhook configuration"
      exports: ["useTTNWebhook"]
    - path: "src/hooks/useTTNOperations.ts"
      provides: "TTN operations orchestration"
      exports: ["useTTNOperations"]
  key_links:
    - from: "src/hooks/useTTNSettings.ts"
      to: "@stackframe/stack"
      via: "import useUser"
      pattern: "useUser"
---

<objective>
Migrate TTN (The Things Network) configuration hooks to Stack Auth.

Purpose: TTN hooks manage LoRaWAN gateway and sensor provisioning configuration. They may use Supabase edge functions. This plan migrates the core settings and operations hooks.

Output:
- useTTNSettings uses Stack Auth
- useTTNApiKey uses Stack Auth
- useTTNWebhook uses Stack Auth
- useTTNOperations uses Stack Auth
- Edge function calls pass Stack Auth token
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-frontend-migration/05-RESEARCH.md
@.planning/phases/05-frontend-migration/05-04-SUMMARY.md
@src/hooks/useTTNSettings.ts
@src/hooks/useTTNApiKey.ts
@src/hooks/useTTNWebhook.ts
@src/hooks/useTTNOperations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useTTNSettings to Stack Auth</name>
  <files>src/hooks/useTTNSettings.ts</files>
  <action>
Migrate TTN settings hook from Supabase auth to Stack Auth:

```typescript
/**
 * TODO: Full migration to new backend
 * - Create TTN integration endpoints in backend
 * - Replace Supabase data calls with API calls
 * - Remove supabase import
 *
 * Current status: Stack Auth for identity, Supabase for data (Phase 5)
 */
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

export function useTTNSettings() {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();

  const query = useQuery({
    queryKey: qk.org(orgId).ttnSettings(),
    queryFn: async () => {
      if (!orgId || !user) return null;

      // TODO Phase 6: Migrate to new API when TTN backend endpoints available
      const { data, error } = await supabase
        .from('ttn_connections')
        .select('*')
        .eq('organization_id', orgId)
        .maybeSingle();

      if (error && error.code !== 'PGRST116') {
        console.error('[useTTNSettings] Error:', error);
        throw error;
      }

      return data;
    },
    enabled: isReady && !!user,
  });

  // Mutations for TTN settings CRUD
  const updateSettings = useMutation({
    mutationFn: async (settings: Partial<TTNConnectionSettings>) => {
      if (!orgId || !user) throw new Error('Not authenticated');

      // TODO Phase 6: Migrate to new API
      const { data, error } = await supabase
        .from('ttn_connections')
        .upsert({
          organization_id: orgId,
          ...settings,
        })
        .select()
        .single();

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).ttnSettings() });
    },
  });

  return { ...query, updateSettings };
}
```

Preserve existing hook interface. Mark all Supabase calls with TODO.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. useUser from Stack Auth is imported
3. No supabase.auth calls remain
4. Supabase data calls have TODO comments
  </verify>
  <done>TTN settings hook uses Stack Auth, Supabase calls marked</done>
</task>

<task type="auto">
  <name>Task 2: Migrate useTTNApiKey to Stack Auth</name>
  <files>src/hooks/useTTNApiKey.ts</files>
  <action>
Migrate TTN API key hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function calls with BullMQ jobs
 * - Replace Supabase data calls with API calls
 *
 * Current status: Stack Auth for identity, Supabase for data/edge functions (Phase 5)
 */
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

export function useTTNApiKey() {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();

  // Query for API key status
  const query = useQuery({
    queryKey: qk.org(orgId).ttnApiKey(),
    queryFn: async () => {
      if (!orgId || !user) return null;

      // TODO Phase 6: Migrate to new API
      const { data, error } = await supabase
        .from('ttn_api_keys')
        .select('id, created_at, last_used_at, status')
        .eq('organization_id', orgId)
        .maybeSingle();

      if (error && error.code !== 'PGRST116') throw error;
      return data;
    },
    enabled: isReady && !!user,
  });

  // Mutation for rotating API key (calls edge function)
  const rotateKey = useMutation({
    mutationFn: async () => {
      if (!orgId || !user) throw new Error('Not authenticated');
      const { accessToken } = await user.getAuthJson();

      // TODO Phase 6: Replace with backend job queue
      const { data, error } = await supabase.functions.invoke('ttn-rotate-api-key', {
        body: { organizationId: orgId },
        headers: { 'x-stack-access-token': accessToken },
      });

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).ttnApiKey() });
    },
  });

  return { ...query, rotateKey };
}
```

For edge function calls, pass Stack Auth token in headers for backend validation.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. Edge function calls include Stack Auth token header
4. TODO markers present
  </verify>
  <done>TTN API key hook uses Stack Auth, edge functions pass token</done>
</task>

<task type="auto">
  <name>Task 3: Migrate useTTNWebhook to Stack Auth</name>
  <files>src/hooks/useTTNWebhook.ts</files>
  <action>
Migrate TTN webhook configuration hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function calls with backend API/jobs
 *
 * Current status: Stack Auth for identity, edge functions for operations (Phase 5)
 */
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

interface TTNWebhookConfig {
  applicationId: string;
  webhookUrl?: string;
}

export function useTTNWebhook() {
  const { orgId } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();

  const configureWebhook = useMutation({
    mutationFn: async (config: TTNWebhookConfig) => {
      if (!orgId || !user) throw new Error('Not authenticated');
      const { accessToken } = await user.getAuthJson();

      // TODO Phase 6: Migrate to new backend endpoint
      const { data, error } = await supabase.functions.invoke('ttn-configure-webhook', {
        body: { organizationId: orgId, ...config },
        headers: { 'x-stack-access-token': accessToken },
      });

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).ttnSettings() });
    },
  });

  return { configureWebhook };
}
```
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth token passed to edge functions
3. TODO markers for Phase 6 migration
  </verify>
  <done>TTN webhook hook uses Stack Auth</done>
</task>

<task type="auto">
  <name>Task 4: Migrate useTTNOperations to Stack Auth</name>
  <files>src/hooks/useTTNOperations.ts</files>
  <action>
Migrate TTN operations orchestration hook:

```typescript
/**
 * TODO: Full migration to new backend
 * - Replace edge function calls with backend job queue
 *
 * Current status: Stack Auth for identity, edge functions for operations (Phase 5)
 */
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useUser } from "@stackframe/stack";
import { supabase } from "@/integrations/supabase/client";  // TEMPORARY
import { qk } from "@/lib/queryKeys";
import { useOrgScope } from "./useOrgScope";

export function useTTNOperations() {
  const { orgId } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();

  // Helper for edge function calls with Stack Auth
  const invokeEdgeFunction = async (functionName: string, payload: any) => {
    if (!user) throw new Error('Not authenticated');
    const { accessToken } = await user.getAuthJson();

    // TODO Phase 6: Replace with backend API calls
    const { data, error } = await supabase.functions.invoke(functionName, {
      body: { organizationId: orgId, ...payload },
      headers: { 'x-stack-access-token': accessToken },
    });

    if (error) throw error;
    return data;
  };

  const registerDevice = useMutation({
    mutationFn: async (device: DeviceRegistration) => {
      return invokeEdgeFunction('ttn-register-device', device);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).loraSensors() });
    },
  });

  const provisionGateway = useMutation({
    mutationFn: async (gateway: GatewayProvision) => {
      return invokeEdgeFunction('ttn-provision-gateway', gateway);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: qk.org(orgId).gateways() });
    },
  });

  return { registerDevice, provisionGateway };
}
```

Extract common edge function invocation pattern with Stack Auth token.
  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth token passed to all edge function calls
3. Common helper for edge function invocation
4. TODO markers present
  </verify>
  <done>TTN operations hook uses Stack Auth for all edge function calls</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. All TTN hooks import useUser from @stackframe/stack
3. No supabase.auth calls remain
4. Edge function calls include Stack Auth token header
5. TODO comments clearly mark remaining Supabase dependencies
6. Query keys preserved
</verification>

<success_criteria>
- All 4 TTN hooks use Stack Auth for authentication
- Supabase auth calls completely removed
- Edge function calls pass Stack Auth token for backend validation
- Supabase data queries clearly marked with TODO
- Hooks continue to function in hybrid mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-migration/05-08-SUMMARY.md`
</output>
