---
phase: 05-frontend-migration
plan: 13
type: execute
wave: 3
depends_on: ['05-04', '05-05']
files_modified:
  - src/hooks/useLoraSensors.ts
  - src/hooks/useGateways.ts
  - src/hooks/useSetPrimarySensor.ts
autonomous: true

must_haves:
  truths:
    - 'Sensor hooks use Stack Auth with Supabase data calls marked TODO'
    - 'Gateway hooks use Stack Auth with Supabase data calls marked TODO'
    - 'Primary sensor mutation uses Stack Auth with clear migration path'
  artifacts:
    - path: 'src/hooks/useLoraSensors.ts'
      provides: 'LoRa sensor queries (hybrid)'
      exports: ['useLoraSensors']
    - path: 'src/hooks/useGateways.ts'
      provides: 'Gateway queries (hybrid)'
      exports: ['useGateways']
    - path: 'src/hooks/useSetPrimarySensor.ts'
      provides: 'Set primary sensor mutation (hybrid)'
      exports: ['useSetPrimarySensor']
  key_links:
    - from: 'src/hooks/useLoraSensors.ts'
      to: '@stackframe/stack'
      via: 'import useUser'
      pattern: 'useUser'
---

<objective>
Migrate device management hooks (sensors, gateways) to Stack Auth.

Purpose: These hooks manage LoRa sensors and gateways. Backend doesn't have dedicated sensor/gateway CRUD endpoints yet (device management is Phase 6+ work), so these use Stack Auth for identity but keep Supabase data calls with clear TODO markers.

Output:

- useLoraSensors uses Stack Auth, Supabase data calls marked
- useGateways uses Stack Auth, Supabase data calls marked
- useSetPrimarySensor uses Stack Auth, Supabase data calls marked
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-frontend-migration/05-RESEARCH.md
@.planning/phases/05-frontend-migration/05-04-SUMMARY.md
@.planning/phases/05-frontend-migration/05-05-SUMMARY.md
@src/hooks/useLoraSensors.ts
@src/hooks/useGateways.ts
@src/hooks/useSetPrimarySensor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useLoraSensors to Stack Auth (hybrid)</name>
  <files>src/hooks/useLoraSensors.ts</files>
  <action>
Migrate `useLoraSensors.ts` to use Stack Auth for identity while keeping Supabase data calls temporarily:

**Why hybrid approach:**
Backend Phase 4 focused on readings ingestion. Sensor CRUD endpoints don't exist yet.

```typescript
/**
 * TODO: Full migration to new backend
 * - Create /api/orgs/:orgId/sensors endpoint
 * - Replace Supabase data calls with API calls
 * - Remove supabase import
 *
 * Current status: Stack Auth for identity, Supabase for data (Phase 5)
 */
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useUser } from '@stackframe/stack';
import { supabase } from '@/integrations/supabase/client'; // TEMPORARY
import { qk } from '@/lib/queryKeys';
import { useOrgScope } from './useOrgScope';

export function useLoraSensors(unitId?: string | null) {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();

  return useQuery({
    queryKey: unitId ? qk.unit(unitId).loraSensors() : qk.org(orgId).loraSensors(),
    queryFn: async () => {
      if (!orgId || !user) return [];

      // TODO Phase 6: Migrate to new API when backend endpoint available
      console.warn('[useLoraSensors] Using Supabase - TODO: migrate to new API');

      let query = supabase
        .from('lora_sensors')
        .select('*')
        .eq('organization_id', orgId)
        .is('deleted_at', null);

      if (unitId) {
        query = query.eq('unit_id', unitId);
      }

      const { data, error } = await query;

      if (error) {
        console.error('[useLoraSensors] Supabase error:', error);
        throw error;
      }

      return data || [];
    },
    enabled: isReady && !!user,
  });
}
```

Preserve existing hook interface. Mark all Supabase data calls with TODO.
</action>
<verify>

1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. No supabase.auth calls remain
4. Supabase data calls have TODO comments
5. Query keys preserved
   </verify>
   <done>Sensor hooks use Stack Auth, Supabase data calls marked for Phase 6</done>
   </task>

<task type="auto">
  <name>Task 2: Migrate useGateways to Stack Auth (hybrid)</name>
  <files>src/hooks/useGateways.ts</files>
  <action>
Migrate `useGateways.ts` following same hybrid pattern:

```typescript
/**
 * TODO: Full migration to new backend
 * - Create /api/orgs/:orgId/gateways endpoint
 * - Replace Supabase data calls with API calls
 * - Remove supabase import
 *
 * Current status: Stack Auth for identity, Supabase for data (Phase 5)
 */
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useUser } from '@stackframe/stack';
import { supabase } from '@/integrations/supabase/client'; // TEMPORARY
import { qk } from '@/lib/queryKeys';
import { useOrgScope } from './useOrgScope';

export function useGateways(siteId?: string | null) {
  const { orgId, isReady } = useOrgScope();
  const user = useUser();

  return useQuery({
    queryKey: siteId ? qk.site(siteId).gateways() : qk.org(orgId).gateways(),
    queryFn: async () => {
      if (!orgId || !user) return [];

      // TODO Phase 6: Migrate to new API when backend endpoint available
      console.warn('[useGateways] Using Supabase - TODO: migrate to new API');

      let query = supabase
        .from('gateways')
        .select('*')
        .eq('organization_id', orgId)
        .is('deleted_at', null);

      if (siteId) {
        query = query.eq('site_id', siteId);
      }

      const { data, error } = await query;

      if (error) {
        console.error('[useGateways] Supabase error:', error);
        throw error;
      }

      return data || [];
    },
    enabled: isReady && !!user,
  });
}
```

Same approach: Stack Auth for identity, Supabase for data with clear TODO markers.
</action>
<verify>

1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. No supabase.auth calls remain
4. Supabase data calls have TODO comments
5. Query keys preserved
   </verify>
   <done>Gateway hooks use Stack Auth, Supabase data calls marked for Phase 6</done>
   </task>

<task type="auto">
  <name>Task 3: Migrate useSetPrimarySensor to Stack Auth (hybrid)</name>
  <files>src/hooks/useSetPrimarySensor.ts</files>
  <action>
Migrate `useSetPrimarySensor.ts`:

```typescript
/**
 * TODO: Full migration to new backend
 * - This may become part of unit update endpoint
 * - Or a dedicated /api/orgs/:orgId/units/:unitId/primary-sensor endpoint
 *
 * Current status: Stack Auth for identity, Supabase for data (Phase 5)
 */
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { useUser } from '@stackframe/stack';
import { supabase } from '@/integrations/supabase/client'; // TEMPORARY
import { qk } from '@/lib/queryKeys';
import { useOrgScope } from './useOrgScope';

interface SetPrimarySensorParams {
  unitId: string;
  sensorId: string;
}

export function useSetPrimarySensor() {
  const { orgId } = useOrgScope();
  const user = useUser();
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ unitId, sensorId }: SetPrimarySensorParams) => {
      if (!orgId || !user) throw new Error('Not authenticated');

      // TODO Phase 6: Migrate to new API
      console.warn('[useSetPrimarySensor] Using Supabase - TODO: migrate to new API');

      // First, unset any existing primary sensor for this unit
      await supabase.from('lora_sensors').update({ is_primary: false }).eq('unit_id', unitId);

      // Then set the new primary
      const { data, error } = await supabase
        .from('lora_sensors')
        .update({ is_primary: true })
        .eq('id', sensorId)
        .eq('unit_id', unitId)
        .select()
        .single();

      if (error) throw error;
      return data;
    },
    onSuccess: (_, { unitId }) => {
      queryClient.invalidateQueries({ queryKey: qk.unit(unitId).loraSensors() });
    },
  });
}
```

  </action>
  <verify>
1. Hook compiles without TypeScript errors
2. Stack Auth useUser imported
3. No supabase.auth calls remain
4. Supabase data calls have TODO comments
5. Query invalidation preserved
  </verify>
  <done>Set primary sensor mutation uses Stack Auth, Supabase data calls marked</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. All hooks use Stack Auth for user identity
3. No supabase.auth calls in any migrated hook
4. All Supabase data calls have clear TODO markers
5. Query keys preserved
6. Hooks still function correctly in hybrid mode
</verification>

<success_criteria>

- All device hooks use Stack Auth for authentication
- Supabase data calls clearly marked with TODO Phase 6
- No Supabase auth calls remain
- Hooks continue to function in hybrid mode
- Clear migration path documented in TODO comments
  </success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-migration/05-13-SUMMARY.md`
</output>
