---
phase: 08-frontend-auth-cleanup
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Dashboard.tsx
  - src/pages/ManualLog.tsx
  - src/pages/Reports.tsx
  - src/pages/DataMaintenance.tsx
  - src/pages/Settings.tsx
  - src/pages/SiteDetail.tsx
  - src/pages/UnitDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Complex pages use Stack Auth for all auth operations"
    - "Auth state subscriptions removed (Stack Auth is reactive)"
    - "Database calls preserved"
  artifacts:
    - path: "src/pages/Dashboard.tsx"
      provides: "Dashboard with Stack Auth"
      contains: "useUser"
    - path: "src/pages/Reports.tsx"
      provides: "Reports with Stack Auth"
      contains: "useUser"
  key_links:
    - from: "src/pages/Dashboard.tsx"
      to: "@stackframe/react"
      via: "useUser import"
      pattern: "import.*useUser.*from.*@stackframe/react"
---

<objective>
Migrate 7 pages with complex auth patterns (auth state listeners, multiple calls) from Supabase to Stack Auth.

Purpose: These pages have onAuthStateChange subscriptions and/or multiple auth calls that need careful migration.

Output: 7 pages migrated, reactive auth patterns, no Supabase auth calls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-frontend-auth-cleanup/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Dashboard and ManualLog (auth subscriptions)</name>
  <files>
    src/pages/Dashboard.tsx
    src/pages/ManualLog.tsx
  </files>
  <action>
    Both files have `supabase.auth.onAuthStateChange` subscriptions that need removal.

    **Dashboard.tsx:**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at page level
    3. Remove the `onAuthStateChange` subscription:
       ```typescript
       // DELETE this entire pattern:
       useEffect(() => {
         const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
           setSession(session);
         });
         supabase.auth.getSession().then(({ data: { session } }) => {
           setSession(session);
         });
         return () => subscription.unsubscribe();
       }, []);
       ```
    4. Replace session state with Stack Auth user:
       - Remove `const [session, setSession] = useState<Session | null>(null);`
       - Remove `Session` type import from `@supabase/supabase-js`
       - Use `user` directly instead of `session`
       - `session?.user` becomes just `user`
       - `session?.access_token` becomes `await user.getAuthJson().accessToken`
    5. Remove supabase import if no database calls remain

    **ManualLog.tsx:**
    Same pattern - has onAuthStateChange subscription:
    1. Add Stack Auth imports
    2. Remove auth subscription
    3. Remove session state
    4. Use user directly
    5. Database calls (supabase.from) might exist - check and preserve
  </action>
  <verify>
    Run `grep -c "onAuthStateChange" src/pages/Dashboard.tsx src/pages/ManualLog.tsx` returns 0
    Run `grep -c "supabase.auth" src/pages/Dashboard.tsx src/pages/ManualLog.tsx` returns 0
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Dashboard and ManualLog use Stack Auth reactive patterns, no subscriptions
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Reports, DataMaintenance, Settings</name>
  <files>
    src/pages/Reports.tsx
    src/pages/DataMaintenance.tsx
    src/pages/Settings.tsx
  </files>
  <action>
    **Reports.tsx (2 auth calls, 1 db call):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at page level
    3. Replace `supabase.auth.getSession()` with `user.getAuthJson()`
    4. Replace `supabase.auth.getUser()` with `user.id`
    5. Keep database call unchanged
    6. Keep supabase import for database

    **DataMaintenance.tsx (2 auth calls, 3 db calls):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at page level
    3. Replace both auth calls
    4. Keep all 3 database calls unchanged

    **Settings.tsx (2 auth calls, 3 db calls):**
    1. Check for onAuthStateChange pattern
    2. If present, remove subscription and use reactive user
    3. Replace auth calls with Stack Auth
    4. Keep all database calls unchanged

    For all three:
    - Migrate only auth (supabase.auth.*)
    - Preserve database (supabase.from, supabase.rpc, supabase.functions)
    - Keep supabase import for database
  </action>
  <verify>
    Run `grep -c "supabase.auth" src/pages/Reports.tsx src/pages/DataMaintenance.tsx src/pages/Settings.tsx` returns 0 for all
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Reports, DataMaintenance, Settings use Stack Auth, database calls preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate SiteDetail and UnitDetail</name>
  <files>
    src/pages/SiteDetail.tsx
    src/pages/UnitDetail.tsx
  </files>
  <action>
    **SiteDetail.tsx (2 auth calls, 2 db calls, auth subscription):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at page level
    3. Check for and remove any onAuthStateChange subscription
    4. Replace `supabase.auth.getSession()` calls with Stack Auth
    5. Replace `supabase.auth.getUser()` calls with `user.id`
    6. Keep database calls (supabase.from, supabase.rpc)
    7. Keep supabase.functions.invoke calls

    **UnitDetail.tsx (2 auth calls, many db calls, auth subscription):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at page level
    3. Remove onAuthStateChange subscription if present
    4. Replace auth calls with Stack Auth
    5. Keep all database calls (this file has realtime subscriptions too)
    6. Keep supabase import for database/realtime

    For realtime subscriptions (supabase.channel):
    - These are NOT auth calls - keep them unchanged
    - Only remove auth.onAuthStateChange, not channel subscriptions

    Pattern to identify:
    - `supabase.auth.onAuthStateChange` -> REMOVE
    - `supabase.channel()` -> KEEP (realtime data, not auth)
  </action>
  <verify>
    Run `grep -c "supabase.auth" src/pages/SiteDetail.tsx src/pages/UnitDetail.tsx` returns 0 for both
    Run `grep "supabase.channel" src/pages/UnitDetail.tsx` still finds realtime subscriptions (expected)
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    SiteDetail and UnitDetail use Stack Auth, realtime and database preserved
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `pnpm tsc --noEmit`
2. Search for remaining auth calls in all 7 pages
3. Verify no onAuthStateChange subscriptions remain
4. Verify database and realtime calls preserved
</verification>

<success_criteria>
- All 7 pages compile without errors
- Zero `supabase.auth` calls remain
- Zero `onAuthStateChange` subscriptions remain
- Database calls (supabase.from, supabase.rpc) preserved
- Realtime subscriptions (supabase.channel) preserved
- Stack Auth reactive patterns used correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-auth-cleanup/08-05-SUMMARY.md`
</output>
