---
phase: 08-frontend-auth-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/AlertRulesEditor.tsx
  - src/components/settings/TTNCredentialsPanel.tsx
  - src/components/NotificationDropdown.tsx
  - src/components/debug/RBACDebugPanel.tsx
  - src/components/site/SiteComplianceSettings.tsx
  - src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - 'Complex components use Stack Auth for all auth operations'
    - 'Multiple auth calls consolidated to single useUser hook'
    - 'Database calls preserved (not changed)'
  artifacts:
    - path: 'src/components/settings/AlertRulesEditor.tsx'
      provides: 'Alert rules with Stack Auth'
      contains: 'useUser'
    - path: 'src/components/settings/TTNCredentialsPanel.tsx'
      provides: 'TTN credentials with Stack Auth'
      contains: 'useUser'
  key_links:
    - from: 'src/components/settings/AlertRulesEditor.tsx'
      to: '@stackframe/react'
      via: 'useUser import'
      pattern: 'import.*useUser.*from.*@stackframe/react'
---

<objective>
Migrate 6 components with complex auth patterns (multiple auth calls) from Supabase to Stack Auth.

Purpose: These components have 2-4 auth calls each. Need careful migration to ensure all calls are replaced.

Output: 6 components migrated, consolidated auth patterns, no Supabase auth imports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-frontend-auth-cleanup/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AlertRulesEditor and TTNCredentialsPanel</name>
  <files>
    src/components/settings/AlertRulesEditor.tsx
    src/components/settings/TTNCredentialsPanel.tsx
  </files>
  <action>
    **AlertRulesEditor.tsx (3 auth calls):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at component level
    3. Find all 3 `supabase.auth.getSession()` calls
    4. For each, replace with pattern:
       ```typescript
       // OLD
       const { data: { session } } = await supabase.auth.getSession();
       if (!session) throw new Error('...');
       // use session.access_token

       // NEW
       if (!user) throw new Error('Not authenticated');
       const { accessToken } = await user.getAuthJson();
       // use accessToken
       ```
    5. Remove supabase import IF no database calls remain, otherwise keep for .from()/.rpc()

    **TTNCredentialsPanel.tsx (4 auth calls, 6 db calls):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at component level
    3. Find all 4 `supabase.auth.getUser()` calls
    4. Replace each with Stack Auth pattern
    5. KEEP the 6 database calls (supabase.from, supabase.rpc) - those are not auth
    6. Keep supabase import for database calls

  </action>
  <verify>
    Run `grep -c "supabase.auth" src/components/settings/AlertRulesEditor.tsx src/components/settings/TTNCredentialsPanel.tsx` returns 0 for both
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    AlertRulesEditor and TTNCredentialsPanel use Stack Auth for all auth operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate NotificationDropdown, RBACDebugPanel, SiteComplianceSettings</name>
  <files>
    src/components/NotificationDropdown.tsx
    src/components/debug/RBACDebugPanel.tsx
    src/components/site/SiteComplianceSettings.tsx
  </files>
  <action>
    **NotificationDropdown.tsx (2 auth calls, 1 db call):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at component level
    3. Replace both `supabase.auth.getUser()` calls with `user.id`
    4. Keep the database call unchanged

    **RBACDebugPanel.tsx (1 auth call, 1 db call):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at component level
    3. Replace the auth call with Stack Auth pattern
    4. Keep the database call unchanged

    **SiteComplianceSettings.tsx (1 auth call, 1 db call):**
    1. Add `import { useUser } from "@stackframe/react"`
    2. Add `const user = useUser()` at component level
    3. Replace the auth call with Stack Auth pattern
    4. Keep the database call unchanged

    For all three:
    - Only migrate auth calls (supabase.auth.*)
    - Preserve database calls (supabase.from, supabase.rpc)
    - Keep supabase import if database calls exist

  </action>
  <verify>
    Run `grep -c "supabase.auth" src/components/NotificationDropdown.tsx src/components/debug/RBACDebugPanel.tsx src/components/site/SiteComplianceSettings.tsx` returns 0 for all
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    NotificationDropdown, RBACDebugPanel, SiteComplianceSettings use Stack Auth
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate DashboardLayout</name>
  <files>
    src/components/DashboardLayout.tsx
  </files>
  <action>
    **DashboardLayout.tsx (3 auth calls):**
    1. Analyze the 3 auth calls - likely:
       - `supabase.auth.getSession()` for initial session
       - `supabase.auth.onAuthStateChange()` for auth state listener
       - Another getSession or getUser call

    2. Add `import { useUser } from "@stackframe/react"`
    3. Add `const user = useUser()` at component level

    4. For `onAuthStateChange` pattern:
       - Stack Auth useUser() is reactive - it updates automatically
       - Remove the onAuthStateChange subscription entirely
       - Use `user` directly for session state

    5. For `getSession` calls:
       - Replace with `user` and `user.getAuthJson()`
       - Check for session becomes checking for `user`

    6. Update any effects that depended on auth state change:
       ```typescript
       // OLD
       useEffect(() => {
         const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
           // handle auth change
         });
         return () => subscription.unsubscribe();
       }, []);

       // NEW
       // Stack Auth useUser() is reactive - no subscription needed
       // The user object updates automatically on auth changes
       ```

    7. Remove supabase import if no database calls remain

  </action>
  <verify>
    Run `grep -c "supabase.auth" src/components/DashboardLayout.tsx` returns 0
    Run `grep "onAuthStateChange" src/components/DashboardLayout.tsx` returns empty
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    DashboardLayout uses Stack Auth reactive patterns, no auth subscriptions
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `pnpm tsc --noEmit`
2. Search for remaining auth calls: `grep -r "supabase.auth" <all 6 files>`
3. Verify no onAuthStateChange subscriptions remain
4. Confirm database calls preserved
</verification>

<success_criteria>

- All 6 components compile without errors
- Zero `supabase.auth` calls remain in these files
- No auth state subscriptions (onAuthStateChange) remain
- Database calls (supabase.from, supabase.rpc) preserved where needed
- Stack Auth reactive patterns used correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-auth-cleanup/08-03-SUMMARY.md`
</output>
