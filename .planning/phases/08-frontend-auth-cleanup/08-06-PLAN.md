---
phase: 08-frontend-auth-cleanup
plan: 06
type: execute
wave: 2
depends_on: ['08-01', '08-02', '08-03', '08-04', '08-05']
files_modified:
  - src/lib/instrumentedSupabase.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - 'No supabase.auth calls remain in frontend codebase'
    - 'Build passes with all auth migrated'
    - 'instrumentedSupabase deleted (unused)'
  artifacts:
    - path: 'src/lib/instrumentedSupabase.ts'
      provides: 'DELETED - no longer exists'
  key_links:
    - from: 'frontend'
      to: '@stackframe/react'
      via: 'all auth operations'
      pattern: 'useUser|useStackApp'
---

<objective>
Final cleanup and verification of frontend auth migration.

Purpose: Verify all auth calls migrated, delete unused files, update documentation.

Output: Clean codebase with no Supabase auth calls, deleted instrumentedSupabase.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-frontend-auth-cleanup/08-RESEARCH.md
@.planning/phases/08-frontend-auth-cleanup/08-01-SUMMARY.md
@.planning/phases/08-frontend-auth-cleanup/08-02-SUMMARY.md
@.planning/phases/08-frontend-auth-cleanup/08-03-SUMMARY.md
@.planning/phases/08-frontend-auth-cleanup/08-04-SUMMARY.md
@.planning/phases/08-frontend-auth-cleanup/08-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive auth cleanup verification</name>
  <files>
    (verification task - no files modified)
  </files>
  <action>
    Run comprehensive verification of all auth migration:

    1. Search for any remaining supabase.auth calls:
       ```bash
       grep -r "supabase\.auth\." src/ --include="*.ts" --include="*.tsx" | grep -v "// OLD\|// TEMPORARY\|\.test\."
       ```
       Result should be empty.

    2. Search for any remaining onAuthStateChange:
       ```bash
       grep -r "onAuthStateChange" src/ --include="*.ts" --include="*.tsx"
       ```
       Result should be empty.

    3. Search for Session type imports from Supabase:
       ```bash
       grep -r "from.*@supabase/supabase-js.*Session" src/ --include="*.ts" --include="*.tsx"
       ```
       Result should be empty (or only in types files).

    4. Verify Stack Auth is used everywhere auth was:
       ```bash
       grep -r "useUser\|useStackApp" src/ --include="*.ts" --include="*.tsx" | wc -l
       ```
       Should be 30+ occurrences (one per migrated file).

    5. Run full TypeScript check:
       ```bash
       pnpm tsc --noEmit
       ```
       Must pass with no errors.

    6. Run dev server briefly to check for runtime errors:
       ```bash
       timeout 10 pnpm dev || true
       ```
       Should start without auth-related errors.

    If any verification fails, note which files still need migration.

  </action>
  <verify>
    All grep commands return expected results
    TypeScript compiles
    Dev server starts
  </verify>
  <done>
    Verification complete, all auth calls migrated
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete unused instrumentedSupabase</name>
  <files>
    src/lib/instrumentedSupabase.ts
  </files>
  <action>
    1. Verify instrumentedSupabase.ts is not imported anywhere:
       ```bash
       grep -r "instrumentedSupabase" src/ --include="*.ts" --include="*.tsx" | grep -v "src/lib/instrumentedSupabase.ts"
       ```
       Should return empty (no imports of this file).

    2. Delete the file:
       ```bash
       rm src/lib/instrumentedSupabase.ts
       ```

    3. Verify deletion doesn't break build:
       ```bash
       pnpm tsc --noEmit
       ```

    Note: src/integrations/supabase/client.ts and types.ts MUST stay - they're still used for database queries by 100+ files. AUTH-02 (removing Supabase client from package.json) is blocked until all database queries are migrated to backend API.

  </action>
  <verify>
    instrumentedSupabase.ts no longer exists
    Build still passes
    No import errors
  </verify>
  <done>
    instrumentedSupabase.ts deleted, unused wrapper removed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Frontend auth cleanup complete:
    - All 30 files migrated from Supabase auth to Stack Auth
    - Auth patterns consolidated to useUser() and useStackApp()
    - No more onAuthStateChange subscriptions
    - Unused instrumentedSupabase.ts deleted
  </what-built>
  <how-to-verify>
    1. Start the development server: `pnpm dev`
    2. Open http://localhost:5173 in browser
    3. Test authentication flow:
       - If logged in, verify session persists (Stack Auth working)
       - Click logout and verify you're redirected to auth page
       - Log back in and verify session works
    4. Navigate to a few pages that were migrated:
       - Dashboard (had auth subscription)
       - Settings (had multiple auth calls)
       - Reports (had getSession + getUser)
    5. Check browser console for any auth-related errors
    6. Verify no "supabase" errors appear
  </how-to-verify>
  <resume-signal>Type "approved" if auth flows work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Zero `supabase.auth` calls in codebase
2. Zero `onAuthStateChange` subscriptions
3. TypeScript compiles
4. Dev server runs without auth errors
5. Auth flows (login, logout) work correctly
</verification>

<success_criteria>

- Comprehensive grep shows zero remaining auth calls
- Build passes
- instrumentedSupabase.ts deleted
- User verifies auth flows work in browser
- No runtime errors related to authentication
  </success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-auth-cleanup/08-06-SUMMARY.md`

Note for summary: Document that AUTH-02 (removing @supabase/supabase-js from package.json) is BLOCKED. The package is still needed for database queries in 100+ files. This requires a future phase to migrate all database queries to the backend API before the client can be removed.
</output>
