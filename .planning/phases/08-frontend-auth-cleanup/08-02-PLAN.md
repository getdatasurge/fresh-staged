---
phase: 08-frontend-auth-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/platform/PlatformLayout.tsx
  - src/components/unit/UnitSettingsSection.tsx
  - src/components/reports/ComplianceReportCard.tsx
  - src/components/settings/EmulatorResyncCard.tsx
  - src/components/debug/DebugTerminal.tsx
  - src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts
  - src/features/dashboard-layout/widgets/AnnotationsWidget.tsx
autonomous: true

must_haves:
  truths:
    - 'Components get user info from Stack Auth'
    - 'SignOut uses Stack Auth'
    - 'No supabase.auth calls in simple components'
  artifacts:
    - path: 'src/components/platform/PlatformLayout.tsx'
      provides: 'Layout with Stack Auth signOut'
      contains: 'useStackApp'
    - path: 'src/components/unit/UnitSettingsSection.tsx'
      provides: 'Settings with Stack Auth user'
      contains: 'useUser'
  key_links:
    - from: 'src/components/platform/PlatformLayout.tsx'
      to: '@stackframe/react'
      via: 'useStackApp import'
      pattern: 'import.*useStackApp.*from.*@stackframe/react'
---

<objective>
Migrate 7 components with simple auth patterns from Supabase to Stack Auth.

Purpose: These components use single auth calls for user ID or signOut. Simple pattern replacements.

Output: 7 components migrated, no Supabase auth imports remaining.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-frontend-auth-cleanup/08-RESEARCH.md

# Reference patterns

@src/hooks/useEffectiveIdentity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate PlatformLayout and UnitSettingsSection</name>
  <files>
    src/components/platform/PlatformLayout.tsx
    src/components/unit/UnitSettingsSection.tsx
  </files>
  <action>
    **PlatformLayout.tsx:**
    1. Find `supabase.auth.signOut()` call
    2. Add: `import { useStackApp } from "@stackframe/react"`
    3. Add: `const stackApp = useStackApp()` in component
    4. Replace: `await supabase.auth.signOut()` with `await stackApp.signOut()`
    5. Remove supabase import IF no other supabase usage remains
    6. If other supabase usage (like .from() or .rpc()), keep import but remove only auth usage

    **UnitSettingsSection.tsx:**
    1. Find `supabase.auth.getUser()` call
    2. Add: `import { useUser } from "@stackframe/react"`
    3. Add: `const user = useUser()` in component
    4. Replace:
       ```typescript
       const { data: { user } } = await supabase.auth.getUser();
       const userId = user.id;
       ```
       with:
       ```typescript
       if (!user) return;
       const userId = user.id;
       ```
    5. Remove supabase import IF no other usage, keep if database calls exist

  </action>
  <verify>
    Run `grep -n "supabase.auth" src/components/platform/PlatformLayout.tsx src/components/unit/UnitSettingsSection.tsx` returns empty
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    PlatformLayout uses Stack Auth signOut, UnitSettingsSection uses Stack Auth user ID
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate ComplianceReportCard, EmulatorResyncCard, DebugTerminal</name>
  <files>
    src/components/reports/ComplianceReportCard.tsx
    src/components/settings/EmulatorResyncCard.tsx
    src/components/debug/DebugTerminal.tsx
  </files>
  <action>
    For each component, apply the same pattern:

    **ComplianceReportCard.tsx:**
    1. Find `supabase.auth.getUser()` call
    2. Add `useUser` import from `@stackframe/react`
    3. Replace Supabase user with Stack Auth user
    4. Keep any database calls (supabase.from) unchanged

    **EmulatorResyncCard.tsx:**
    1. Find auth usage pattern
    2. Add `useUser` import
    3. Replace `supabase.auth.getSession()` with `useUser().getAuthJson()`
    4. Keep database calls unchanged

    **DebugTerminal.tsx:**
    1. Find auth usage pattern
    2. Add `useUser` import
    3. Replace Supabase auth with Stack Auth
    4. Keep any debugging database calls unchanged

    Pattern for each:
    ```typescript
    // OLD
    const { data: { session } } = await supabase.auth.getSession();
    // or
    const { data: { user } } = await supabase.auth.getUser();

    // NEW
    const user = useUser(); // at component level
    // In function:
    if (!user) return;
    const { accessToken } = await user.getAuthJson();
    // Use accessToken for API calls, user.id for user ID
    ```

  </action>
  <verify>
    Run `grep -n "supabase.auth" src/components/reports/ComplianceReportCard.tsx src/components/settings/EmulatorResyncCard.tsx src/components/debug/DebugTerminal.tsx` returns empty
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    All 3 components use Stack Auth for authentication
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate dashboard-layout hooks and widgets</name>
  <files>
    src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts
    src/features/dashboard-layout/widgets/AnnotationsWidget.tsx
  </files>
  <action>
    **useEntityLayoutStorage.ts:**
    1. Find auth usage (likely getSession for API calls)
    2. Add `useUser` import from `@stackframe/react`
    3. Add `const user = useUser()` at hook level
    4. Replace session token retrieval with `user.getAuthJson().accessToken`
    5. Add null check for user in relevant conditions

    **AnnotationsWidget.tsx:**
    1. Find auth usage pattern
    2. Add `useUser` import
    3. Replace Supabase auth with Stack Auth user
    4. Keep any database calls unchanged

    Both files follow the established pattern:
    - Import `useUser` from `@stackframe/react`
    - Use `user.getAuthJson()` for access tokens
    - Use `user.id` for user identification

  </action>
  <verify>
    Run `grep -n "supabase.auth" src/features/dashboard-layout/hooks/useEntityLayoutStorage.ts src/features/dashboard-layout/widgets/AnnotationsWidget.tsx` returns empty
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Dashboard layout files use Stack Auth for authentication
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `pnpm tsc --noEmit`
2. Search for remaining auth calls in all 7 files
3. Verify Stack Auth imports present
</verification>

<success_criteria>

- All 7 components compile without errors
- Zero `supabase.auth` calls remain
- Stack Auth hooks properly imported and used
- Components render without runtime auth errors
  </success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-auth-cleanup/08-02-SUMMARY.md`
</output>
