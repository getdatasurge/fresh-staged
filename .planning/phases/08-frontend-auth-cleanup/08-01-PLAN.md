---
phase: 08-frontend-auth-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useBranding.ts
  - src/hooks/useNavTree.ts
  - src/hooks/useSoftDelete.ts
  - src/hooks/useAccountDeletion.ts
autonomous: true

must_haves:
  truths:
    - 'Hooks fetch data using Stack Auth tokens'
    - 'No supabase.auth.getSession() calls remain in hooks'
    - 'No supabase.auth.signOut() calls remain in hooks'
  artifacts:
    - path: 'src/hooks/useBranding.ts'
      provides: 'Org branding with Stack Auth'
      contains: 'useUser'
    - path: 'src/hooks/useNavTree.ts'
      provides: 'Navigation tree with Stack Auth'
      contains: 'useUser'
    - path: 'src/hooks/useSoftDelete.ts'
      provides: 'Soft delete with Stack Auth'
      contains: 'useUser'
    - path: 'src/hooks/useAccountDeletion.ts'
      provides: 'Account deletion prep'
      contains: 'useStackApp'
  key_links:
    - from: 'src/hooks/useBranding.ts'
      to: '@stackframe/react'
      via: 'useUser import'
      pattern: 'import.*useUser.*from.*@stackframe/react'
---

<objective>
Migrate 4 hooks from Supabase auth to Stack Auth patterns.

Purpose: These hooks use `supabase.auth.getSession()` to get access tokens for API calls. They need to use Stack Auth's `useUser().getAuthJson()` instead.

Output: 4 hooks migrated to Stack Auth, no Supabase auth imports remaining.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-frontend-auth-cleanup/08-RESEARCH.md
@.planning/phases/05-frontend-migration/05-04-SUMMARY.md

# Reference for established pattern

@src/hooks/useEffectiveIdentity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useBranding and useNavTree</name>
  <files>
    src/hooks/useBranding.ts
    src/hooks/useNavTree.ts
  </files>
  <action>
    Migrate both hooks from Supabase auth to Stack Auth:

    **useBranding.ts:**
    1. Remove: `import { supabase } from "@/integrations/supabase/client"`
    2. Add: `import { useUser } from "@stackframe/react"`
    3. In queryFn, replace:
       ```typescript
       // OLD
       const { data: { session } } = await supabase.auth.getSession();
       if (!session) throw new Error('No session available');
       // ... use session.access_token
       ```
       with:
       ```typescript
       // NEW
       const user = useUser(); // Add at hook level, not in queryFn
       // In queryFn:
       if (!user) return null;
       const { accessToken } = await user.getAuthJson();
       // ... use accessToken
       ```
    4. Add `!!user` to the `enabled` condition

    **useNavTree.ts:**
    1. Remove: `import { supabase } from "@/integrations/supabase/client"`
    2. Add: `import { useUser } from "@stackframe/react"`
    3. Add `const user = useUser()` at hook level
    4. In BOTH queryFn (sites query and layouts query), replace:
       ```typescript
       const { data: { session } } = await supabase.auth.getSession();
       if (!session) throw new Error('No session');
       ```
       with:
       ```typescript
       if (!user) return [];
       const { accessToken } = await user.getAuthJson();
       ```
    5. Add `!!user` to both `enabled` conditions
    6. NOTE: Keep any `supabase.from()` database calls unchanged - those are not auth calls

  </action>
  <verify>
    Run `grep -n "supabase.auth" src/hooks/useBranding.ts src/hooks/useNavTree.ts` returns empty
    Run `grep -n "useUser" src/hooks/useBranding.ts src/hooks/useNavTree.ts` finds imports
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    useBranding and useNavTree use Stack Auth useUser() for token retrieval, no supabase.auth calls remain
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate useSoftDelete and useAccountDeletion</name>
  <files>
    src/hooks/useSoftDelete.ts
    src/hooks/useAccountDeletion.ts
  </files>
  <action>
    Migrate both hooks from Supabase auth to Stack Auth:

    **useSoftDelete.ts:**
    1. Remove: `import { supabase } from "@/integrations/supabase/client"`
    2. Add: `import { useUser } from "@stackframe/react"`
    3. This hook has 3 functions (softDelete, softDeleteRecursive, restoreEntity) each calling getSession
    4. Refactor to accept user as parameter or use closure:
       - Add `const user = useUser()` at top of hook
       - In each function, replace:
         ```typescript
         const { data: { session } } = await supabase.auth.getSession();
         if (!session) throw new Error('No session');
         ```
         with:
         ```typescript
         if (!user) throw new Error('Not authenticated');
         const { accessToken } = await user.getAuthJson();
         ```
       - Use `accessToken` instead of `session.access_token` in API calls

    **useAccountDeletion.ts:**
    1. This hook already imports useUser from Stack Auth (line 3)
    2. Remove: `import { supabase } from '@/integrations/supabase/client';  // TEMPORARY` (line 4)
    3. The hook has a TODO on line 74-78 about migrating to backend
    4. For now, the RPC call on line 81 (`supabase.rpc('delete_user_account')`) stays - that's database, not auth
    5. BUT the signOut call at end needs Stack Auth:
       - Add: `import { useStackApp } from "@stackframe/react"`
       - Add: `const stackApp = useStackApp()` at hook level
       - Replace any `supabase.auth.signOut()` with `await stackApp.signOut()`
    6. Keep the supabase import ONLY if still needed for RPC call, otherwise remove

    NOTE: Check if useAccountDeletion still needs supabase for the RPC call. If so, keep that import but remove the TEMPORARY comment.

  </action>
  <verify>
    Run `grep -n "supabase.auth" src/hooks/useSoftDelete.ts src/hooks/useAccountDeletion.ts` returns empty
    Run `grep -n "useUser\|useStackApp" src/hooks/useSoftDelete.ts src/hooks/useAccountDeletion.ts` finds imports
    Run `pnpm tsc --noEmit` passes
  </verify>
  <done>
    useSoftDelete uses Stack Auth for all 3 operations, useAccountDeletion uses Stack Auth for signOut
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `pnpm tsc --noEmit`
2. Search for remaining auth calls: `grep -r "supabase.auth" src/hooks/useBranding.ts src/hooks/useNavTree.ts src/hooks/useSoftDelete.ts src/hooks/useAccountDeletion.ts`
3. Verify Stack Auth imports: `grep -r "useUser\|useStackApp" src/hooks/useBranding.ts src/hooks/useNavTree.ts src/hooks/useSoftDelete.ts src/hooks/useAccountDeletion.ts`
</verification>

<success_criteria>

- All 4 hooks compile without TypeScript errors
- Zero `supabase.auth` calls remain in these files
- All hooks import from `@stackframe/react`
- Token retrieval uses `user.getAuthJson().accessToken`
  </success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-auth-cleanup/08-01-SUMMARY.md`
</output>
