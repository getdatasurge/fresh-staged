---
phase: 39-dashboard-widgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx
  - src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx
  - src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx
autonomous: true

must_haves:
  truths:
    - "ManualLogStatusWidget renders manual log data from tRPC without supabase"
    - "UnitsStatusGridWidget renders unit status data from tRPC without supabase"
    - "SensorSignalTrendWidget renders signal strength data from tRPC without supabase"
    - "Dashboard loads showing all three widgets without errors"
  artifacts:
    - path: "src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx"
      provides: "Manual log status display using tRPC"
      contains: "useTRPC"
    - path: "src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx"
      provides: "Units status grid using tRPC"
      contains: "useTRPC"
    - path: "src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx"
      provides: "Signal trend chart using tRPC"
      contains: "useTRPC"
  key_links:
    - from: "src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx"
      to: "trpc.readings.listManual"
      via: "queryOptions"
      pattern: "trpc\\.readings\\.listManual"
    - from: "src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx"
      to: "trpc.units.listByOrg"
      via: "queryOptions"
      pattern: "trpc\\.units\\.listByOrg"
    - from: "src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx"
      to: "trpc.readings.list"
      via: "queryOptions"
      pattern: "trpc\\.readings\\.list"
---

<objective>
Migrate 3 simple dashboard widgets from supabase to tRPC data fetching.

Purpose: These widgets (ManualLogStatusWidget, UnitsStatusGridWidget, SensorSignalTrendWidget) have straightforward read-only queries that map directly to existing tRPC procedures.

Output: 3 widgets using tRPC hooks instead of supabase-placeholder imports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-test-infrastructure/38-01-SUMMARY.md (tRPC mock patterns)
@src/hooks/useSites.ts (tRPC hook pattern reference)
@src/hooks/useUnits.ts (tRPC hook pattern reference)
@backend/src/routers/readings.router.ts (available procedures)
@backend/src/routers/units.router.ts (available procedures)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ManualLogStatusWidget to tRPC</name>
  <files>src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx</files>
  <action>
Replace supabase queries with tRPC:

1. Remove import: `import { supabase } from "@/lib/supabase-placeholder";`
2. Add imports: `import { useQuery } from "@tanstack/react-query"; import { useTRPC } from "@/lib/trpc";`
3. Replace the useEffect data fetching with useQuery + tRPC:

Current supabase queries:
- `supabase.from("manual_temperature_logs").select("logged_at").eq("unit_id", entityId).order("logged_at", { ascending: false }).limit(1).maybeSingle()` -> Use `trpc.readings.listManual.queryOptions({ organizationId, unitId: entityId, limit: 1 })`
- `supabase.from("manual_temperature_logs").select("*", { count: "exact", head: true }).eq("unit_id", entityId).gte("logged_at", dayAgo)` -> Use same procedure with start filter

Pattern to follow (from useSites.ts):
```tsx
const trpc = useTRPC();
const queryOptions = trpc.readings.listManual.queryOptions({
  organizationId: organizationId!,
  unitId: entityId!,
  limit: 50,
  start: dayAgo.toISOString(),
});
const { data: logs, isLoading } = useQuery({
  ...queryOptions,
  enabled: !!entityId && !!organizationId,
});
```

Note: organizationId must come from props or context. Check WidgetProps for organizationId field.
Compute lastLog as `logs?.[0]` and logCount as `logs?.length ?? 0`.
  </action>
  <verify>
`grep -c "supabase-placeholder" src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx` returns 0
`grep -c "useTRPC" src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx` returns 1+
`npx tsc --noEmit` passes for the file
  </verify>
  <done>ManualLogStatusWidget fetches data via tRPC, no supabase imports remain</done>
</task>

<task type="auto">
  <name>Task 2: Migrate UnitsStatusGridWidget to tRPC</name>
  <files>src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx</files>
  <action>
Replace supabase query with tRPC:

1. Remove import: `import { supabase } from "@/lib/supabase-placeholder";`
2. Add imports: `import { useQuery } from "@tanstack/react-query"; import { useTRPC } from "@/lib/trpc";`
3. Replace the useEffect with useQuery:

Current supabase query:
```tsx
supabase.from("units")
  .select(`id, name, unit_type, temp_limit_high, last_temp_reading, last_reading_at, area:areas!inner(name, site_id)`)
  .eq("areas.site_id", entityId)
  .eq("is_active", true)
  .order("name")
  .limit(50)
```

Use `trpc.units.listByOrg.queryOptions({ organizationId })` which returns units with hierarchy info.
Then filter client-side for the specific site: `units?.filter(u => u.site?.id === entityId)`.

Pattern:
```tsx
const trpc = useTRPC();
const queryOptions = trpc.units.listByOrg.queryOptions({
  organizationId: organizationId!,
});
const { data: allUnits, isLoading } = useQuery({
  ...queryOptions,
  enabled: !!organizationId,
  staleTime: 60_000,
});

// Filter for site (entityId is siteId for site-level widgets)
const units = useMemo(() => {
  if (!allUnits || !entityId) return [];
  return allUnits
    .filter(u => u.site?.id === entityId && u.isActive)
    .slice(0, 50)
    .map(u => ({
      id: u.id,
      name: u.name,
      unit_type: u.unitType,
      temp_limit_high: u.tempLimitHigh,
      last_temp_reading: u.lastTempReading,
      last_reading_at: u.lastReadingAt,
      area_name: u.area?.name || '',
    }));
}, [allUnits, entityId]);
```

Note: Field names from tRPC use camelCase (tempLimitHigh, unitType, lastTempReading, lastReadingAt).
  </action>
  <verify>
`grep -c "supabase-placeholder" src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx` returns 0
`grep -c "useTRPC" src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx` returns 1+
`npx tsc --noEmit` passes for the file
  </verify>
  <done>UnitsStatusGridWidget fetches data via tRPC, no supabase imports remain</done>
</task>

<task type="auto">
  <name>Task 3: Migrate SensorSignalTrendWidget to tRPC</name>
  <files>src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx</files>
  <action>
Replace supabase query with tRPC:

1. Remove import: `import { supabase } from "@/lib/supabase-placeholder";`
2. Add imports: `import { useQuery } from "@tanstack/react-query"; import { useTRPC } from "@/lib/trpc";`
3. Replace the useEffect with useQuery:

Current supabase query:
```tsx
supabase.from("sensor_readings")
  .select("recorded_at, signal_strength")
  .eq("unit_id", entityId)
  .not("signal_strength", "is", null)
  .order("recorded_at", { ascending: true })
  .limit(100)
```

Use `trpc.readings.list.queryOptions({ organizationId, unitId: entityId, limit: 100 })`.
Note: The tRPC procedure returns full reading objects; extract recordedAt and signalStrength fields.

Pattern:
```tsx
const trpc = useTRPC();
const queryOptions = trpc.readings.list.queryOptions({
  organizationId: organizationId!,
  unitId: entityId!,
  limit: 100,
});
const { data: readingsData, isLoading } = useQuery({
  ...queryOptions,
  enabled: !!entityId && !!organizationId,
});

// Filter for readings with signal strength and transform
const readings = useMemo(() => {
  if (!readingsData) return [];
  return readingsData
    .filter(r => r.signalStrength != null)
    .map(r => ({
      recorded_at: r.recordedAt,
      signal_strength: r.signalStrength!,
    }));
}, [readingsData]);
```

Note: tRPC returns camelCase fields (recordedAt, signalStrength).
  </action>
  <verify>
`grep -c "supabase-placeholder" src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx` returns 0
`grep -c "useTRPC" src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx` returns 1+
`npx tsc --noEmit` passes for the file
  </verify>
  <done>SensorSignalTrendWidget fetches data via tRPC, no supabase imports remain</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Check no supabase imports remain in migrated widgets:
```bash
grep -l "supabase-placeholder" src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx
```
Should return empty.

2. TypeScript compilation:
```bash
npx tsc --noEmit
```

3. Verify tRPC usage:
```bash
grep -c "useTRPC" src/features/dashboard-layout/widgets/ManualLogStatusWidget.tsx
grep -c "useTRPC" src/features/dashboard-layout/widgets/UnitsStatusGridWidget.tsx
grep -c "useTRPC" src/features/dashboard-layout/widgets/SensorSignalTrendWidget.tsx
```
Each should return 1+.
</verification>

<success_criteria>
- 3 widgets migrated from supabase to tRPC
- Zero supabase-placeholder imports in migrated files
- TypeScript compiles without errors
- Each widget uses useTRPC() pattern with queryOptions
</success_criteria>

<output>
After completion, create `.planning/phases/39-dashboard-widgets/39-01-SUMMARY.md`
</output>
