---
phase: 46-dependency-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - '@trpc/react-query is not in package.json and not installed'
    - 'All tRPC packages (@trpc/client, @trpc/server, @trpc/tanstack-react-query) are pinned to exact 11.9.0'
    - 'Frontend zod version matches backend (v4.x, not v3.x)'
    - 'pnpm install completes without tRPC peer dependency warnings'
    - 'pnpm run build succeeds with zero errors'
  artifacts:
    - path: 'package.json'
      provides: 'Clean dependency manifest'
      contains: '"@trpc/client": "11.9.0"'
    - path: 'pnpm-lock.yaml'
      provides: 'Locked dependency tree'
  key_links:
    - from: 'package.json'
      to: 'node_modules'
      via: 'pnpm install'
      pattern: 'all tRPC packages resolve to 11.9.0'
    - from: 'package.json'
      to: 'src/**/*.ts{x,}'
      via: 'zod imports'
      pattern: 'import.*from "zod"'
---

<objective>
Remove phantom @trpc/react-query dependency, pin all tRPC packages to exact version 11.9.0, and upgrade frontend Zod from v3 to v4 to match backend.

Purpose: Establish a clean, consistent dependency foundation so the tRPC proxy call fixes in Phase 47 operate against known, aligned package versions.
Output: Updated package.json with correct dependencies, clean pnpm install, successful build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove phantom dep and pin tRPC versions</name>
  <files>package.json</files>
  <action>
  Edit the root package.json to make these three changes in the dependencies section:

1. REMOVE the line: `"@trpc/react-query": "^11.8.1"` entirely.
   This package is not imported anywhere in the frontend codebase (confirmed: zero grep matches for `@trpc/react-query` in src/).
   The actual tRPC React integration used is `@trpc/tanstack-react-query`.

2. PIN all three remaining tRPC packages to exact version 11.9.0 (no caret, no range):
   - Change `"@trpc/client": "^11.8.1"` to `"@trpc/client": "11.9.0"`
   - Change `"@trpc/server": "^11.8.1"` to `"@trpc/server": "11.9.0"`
   - Change `"@trpc/tanstack-react-query": "^11.8.1"` to `"@trpc/tanstack-react-query": "11.9.0"`

Why exact pins (no caret): The tRPC v11 ecosystem is sensitive to version mismatches between client/server/react-query. Currently @trpc/client resolved to 11.8.1 while server resolved to 11.9.0. Exact pins prevent this drift.

Do NOT change any other dependencies.
</action>
<verify>
Run: `grep -E '@trpc' package.json`
Expected output shows exactly three entries, all pinned to "11.9.0", with NO @trpc/react-query line.

Run: `pnpm install`
Expected: Completes successfully. Verify no peer dependency warnings for tRPC packages in the output.

Run: `pnpm ls @trpc/client @trpc/server @trpc/tanstack-react-query @trpc/react-query 2>&1`
Expected: Shows client 11.9.0, server 11.9.0, tanstack-react-query 11.9.0. @trpc/react-query should NOT appear (or show as "not found").
</verify>
<done>

- @trpc/react-query removed from package.json (DEP-01)
- @trpc/client, @trpc/server, @trpc/tanstack-react-query all pinned to exact 11.9.0 (DEP-02)
- pnpm install succeeds with no tRPC peer dependency warnings
  </done>
  </task>

<task type="auto">
  <name>Task 2: Upgrade frontend Zod to v4 and verify build</name>
  <files>package.json</files>
  <action>
  1. In the root package.json, change the zod dependency:
     - Change `"zod": "^3.25.76"` to `"zod": "^4.3.6"`
     This aligns with backend/package.json which already uses `"zod": "^4.3.6"`.

2. Run `pnpm install` to update the lockfile.

3. Verify the upgrade is safe for existing code:
   - All 6 frontend files that import zod use `import { z } from "zod"` -- this import path works identically in Zod v4.
   - 5 files use `@hookform/resolvers/zod` (zodResolver) -- `@hookform/resolvers@3.10.0` supports Zod v4.
   - No files use `from "zod/v4"` or other v4-specific import paths.

4. Run `pnpm run build` to confirm the frontend builds successfully with the upgraded dependencies.

5. Run `pnpm run test` to confirm existing frontend tests still pass.

If the build fails due to Zod v4 type incompatibilities:

- Check if `@hookform/resolvers` needs upgrading: `pnpm update @hookform/resolvers`
- Check if any zod usage needs the v4 migration (e.g., `.email()` -> `.email()` is the same, `.min()` -> `.min()` is the same, most basic z.string/z.number/z.object patterns are unchanged)
- The 6 files using zod are: src/lib/validation.ts, AddSensorDialog.tsx, EditSensorDialog.tsx, AddGatewayDialog.tsx, EditGatewayDialog.tsx, SiteLocationModal.tsx
  </action>
  <verify>
  Run: `pnpm ls zod`
  Expected: Shows zod 4.x.x (not 3.x.x)

Run: `pnpm run build`
Expected: Build succeeds with zero errors.

Run: `pnpm run test`
Expected: All frontend tests pass (141 expected).
</verify>
<done>

- Frontend zod upgraded from v3 (3.25.76) to v4 (4.x) matching backend (DEP-03)
- Build succeeds
- Tests pass
  </done>
  </task>

</tasks>

<verification>
All three requirements verified:
1. DEP-01: `grep '@trpc/react-query' package.json` returns nothing
2. DEP-02: `pnpm ls @trpc/client @trpc/server @trpc/tanstack-react-query` all show 11.9.0
3. DEP-03: `pnpm ls zod` shows 4.x.x

Integration check:

- `pnpm install` succeeds with no tRPC peer warnings
- `pnpm run build` succeeds
- `pnpm run test` passes
  </verification>

<success_criteria>

- @trpc/react-query removed from package.json and node_modules
- @trpc/client pinned to exact 11.9.0
- @trpc/server pinned to exact 11.9.0
- @trpc/tanstack-react-query pinned to exact 11.9.0
- Frontend zod upgraded to v4 matching backend
- pnpm install clean (no tRPC peer warnings)
- pnpm run build succeeds
- pnpm run test passes
  </success_criteria>

<output>
After completion, create `.planning/phases/46-dependency-cleanup/46-01-SUMMARY.md`
</output>
