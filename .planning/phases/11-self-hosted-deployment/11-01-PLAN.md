---
phase: 11-self-hosted-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/deploy.config.example
  - scripts/deploy-selfhosted.sh
autonomous: true

must_haves:
  truths:
    - 'Configuration file template exists with all required variables documented'
    - 'Deployment script is idempotent (safe to rerun after failures)'
    - 'Script installs Docker, Compose, ufw, fail2ban, node_exporter automatically'
    - 'Script reads from config file with interactive fallback for missing values'
  artifacts:
    - path: 'scripts/deploy.config.example'
      provides: 'Configuration template with documented variables'
      contains: 'DOMAIN='
    - path: 'scripts/deploy-selfhosted.sh'
      provides: 'Idempotent VM setup script'
      min_lines: 200
      contains: 'mkdir -p'
  key_links:
    - from: 'scripts/deploy-selfhosted.sh'
      to: 'scripts/deploy.config.example'
      via: 'source config file'
      pattern: "source.*deploy\\.config"
---

<objective>
Create the deploy-selfhosted.sh script foundation with configuration template

Purpose: Enable one-command deployment from bare Ubuntu 24.04 VM to running FreshTrack Pro. The script must be idempotent (safe to rerun after any failure) and auto-install all dependencies.

Output:

- scripts/deploy.config.example (template with all variables)
- scripts/deploy-selfhosted.sh (idempotent deployment script with dependency installation)
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-self-hosted-deployment/11-CONTEXT.md
@.planning/phases/11-self-hosted-deployment/11-RESEARCH.md

# Existing infrastructure

@scripts/deploy.sh
@docker/compose.selfhosted.yaml
@docker/compose.prod.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration template</name>
  <files>scripts/deploy.config.example</files>
  <action>
Create deploy.config.example with all required configuration variables.

Required sections:

1. **Domain configuration**
   - DOMAIN (e.g., freshtrackpro.com)
   - ADMIN_EMAIL (for Let's Encrypt notifications)

2. **Database credentials**
   - POSTGRES_PASSWORD (generate strong password)
   - POSTGRES_DB (default: freshtrack)
   - POSTGRES_USER (default: freshtrack_user)

3. **Application secrets**
   - STACK_AUTH_PROJECT_ID
   - STACK_AUTH_PUBLISHABLE_KEY
   - STACK_AUTH_SECRET_KEY

4. **Optional services**
   - GRAFANA_ADMIN_PASSWORD (default: auto-generate)
   - MINIO_ACCESS_KEY
   - MINIO_SECRET_KEY
   - BACKUP_WEBHOOK_URL (for failure notifications)

5. **Deployment settings**
   - VERSION_RETENTION=3 (how many versions to keep for rollback)
   - HEALTH_CHECK_TIMEOUT=30 (seconds per retry)
   - HEALTH_CHECK_RETRIES=30 (total attempts)

Include:

- Comments explaining each variable
- Default values where sensible
- Example values (not real secrets)
- Instructions at top for copying to deploy.config
  </action>
  <verify>
  File exists: scripts/deploy.config.example
  Contains: DOMAIN=, POSTGRES_PASSWORD=, STACK_AUTH_PROJECT_ID=
  Has comments: grep -c "^#" scripts/deploy.config.example shows 20+ comment lines
  </verify>
  <done>Configuration template exists with all required variables documented and example values</done>
  </task>

<task type="auto">
  <name>Task 2: Create deploy-selfhosted.sh base script</name>
  <files>scripts/deploy-selfhosted.sh</files>
  <action>
Create the main deployment script with idempotent patterns.

**Script structure:**

```
#!/bin/bash
# FreshTrack Pro Self-Hosted Deployment Script
# Transforms bare Ubuntu 24.04 VM into production environment
# Usage: ./scripts/deploy-selfhosted.sh [--config path/to/config]
set -e

# Colors and helpers (reuse pattern from existing deploy.sh)

# Configuration loading with interactive fallback
load_config() {
  # Source config file if exists
  # Prompt for missing required values
}

# Idempotent helper functions
ensure_package() {
  # Only install if not present: dpkg -s $pkg || apt install -y $pkg
}

ensure_line_in_file() {
  # grep -qF before appending
}
```

**Required installation functions (all idempotent):**

1. `install_docker()`:
   - Check: `command -v docker`
   - Install via official script: `curl -fsSL https://get.docker.com | sh`
   - Add current user to docker group
   - Enable and start docker service

2. `install_docker_compose()`:
   - Check: `docker compose version` (v2 is built into Docker now)
   - Only need to verify Docker is installed

3. `configure_firewall()`:
   - Install ufw if missing
   - Allow ports: 22/tcp (SSH), 80/tcp (HTTP), 443/tcp (HTTPS)
   - Use `ufw status | grep -q "X/tcp.*ALLOW"` before adding rules
   - Enable with `ufw --force enable`

4. `install_fail2ban()`:
   - Check: `command -v fail2ban-client`
   - Install: `apt install -y fail2ban`
   - Enable and start service
   - Create basic jail.local for ssh protection

5. `install_node_exporter()`:
   - Check if container exists: `docker ps -a --filter name=node-exporter`
   - Run as Docker container bound to 127.0.0.1:9100
   - Use image: prom/node-exporter:v1.6.0

6. `setup_app_directory()`:
   - Create /opt/freshtrack-pro with proper permissions
   - Clone or update git repo
   - Copy deploy.config to app directory

7. `create_secrets()`:
   - Create /opt/freshtrack-pro/secrets directory (mode 700)
   - Write secrets to files (mode 600)
   - postgres_password.txt, database_url.txt, stack_auth_secret.txt

**Main execution flow:**

```bash
main() {
  step "Loading configuration..."
  load_config

  step "Installing Docker..."
  install_docker

  step "Configuring firewall..."
  configure_firewall

  step "Installing fail2ban..."
  install_fail2ban

  step "Installing node_exporter..."
  install_node_exporter

  step "Setting up application directory..."
  setup_app_directory

  step "Creating secrets..."
  create_secrets

  # DNS check and deployment handled in Plan 11-03
  echo "Base setup complete. Run with --deploy to start services."
}
```

**Key idempotent patterns to use (from RESEARCH.md):**

- `mkdir -p` instead of `mkdir`
- `ln -sfn` instead of `ln -s`
- `grep -qF "pattern" file || echo "pattern" >> file`
- `command -v X || install X`
- `dpkg -s package 2>/dev/null || apt install -y package`

Make script executable (chmod +x) in final step.
</action>
<verify>
File exists: scripts/deploy-selfhosted.sh
Is executable: test -x scripts/deploy-selfhosted.sh
Contains idempotent patterns: grep -c "mkdir -p\|grep -qF\|command -v" scripts/deploy-selfhosted.sh shows 10+
Contains all install functions: grep -c "install_docker\|configure_firewall\|install_fail2ban\|install_node_exporter" scripts/deploy-selfhosted.sh shows 4+
Shellcheck passes: shellcheck scripts/deploy-selfhosted.sh (warnings OK, errors not OK)
</verify>
<done>Deployment script exists with idempotent dependency installation for Docker, firewall, fail2ban, and node_exporter</done>
</task>

</tasks>

<verification>
- [ ] deploy.config.example exists with all required variables
- [ ] deploy-selfhosted.sh is executable
- [ ] Script uses idempotent patterns throughout (grep -qF, mkdir -p, command -v)
- [ ] Script sources config file with interactive fallback
- [ ] shellcheck reports no errors (warnings acceptable)
</verification>

<success_criteria>

- Configuration template documents all required variables with examples
- Deployment script is idempotent (can be safely rerun)
- All dependency installation functions exist and use state-checking before install
- Script structure is ready for DNS check and deployment logic (Plan 11-03)
  </success_criteria>

<output>
After completion, create `.planning/phases/11-self-hosted-deployment/11-01-SUMMARY.md`
</output>
