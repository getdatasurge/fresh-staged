---
phase: 11-self-hosted-deployment
plan: 04
type: execute
wave: 3
depends_on: ['11-01', '11-02', '11-03']
files_modified:
  - docs/SELFHOSTED_DEPLOYMENT.md
autonomous: false

must_haves:
  truths:
    - 'Complete guide exists from bare VM to running application'
    - 'Guide covers prerequisites, DNS setup, configuration, deployment, and verification'
    - 'Rollback procedures documented with examples'
    - 'Troubleshooting section addresses common issues'
  artifacts:
    - path: 'docs/SELFHOSTED_DEPLOYMENT.md'
      provides: 'Complete self-hosted deployment guide'
      min_lines: 300
      contains: 'deploy-selfhosted.sh'
  key_links:
    - from: 'docs/SELFHOSTED_DEPLOYMENT.md'
      to: 'scripts/deploy-selfhosted.sh'
      via: 'deployment command'
      pattern: "deploy-selfhosted\\.sh"
    - from: 'docs/SELFHOSTED_DEPLOYMENT.md'
      to: 'docs/SSL_CERTIFICATES.md'
      via: 'reference link'
      pattern: "SSL_CERTIFICATES\\.md"
---

<objective>
Create comprehensive self-hosted deployment documentation and verify the complete deployment workflow

Purpose: Users need a single document that guides them from a fresh Ubuntu 24.04 VM to a fully operational FreshTrack Pro instance. This documentation is the primary deliverable for DEPLOY-01.

Output:

- docs/SELFHOSTED_DEPLOYMENT.md (complete deployment guide)
- Human verification of deployment workflow
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-self-hosted-deployment/11-CONTEXT.md
@.planning/phases/11-self-hosted-deployment/11-01-SUMMARY.md
@.planning/phases/11-self-hosted-deployment/11-02-SUMMARY.md
@.planning/phases/11-self-hosted-deployment/11-03-SUMMARY.md

# Reference documentation

@docs/PRODUCTION_DEPLOYMENT.md
@docs/SSL_CERTIFICATES.md

# Scripts to document

@scripts/deploy-selfhosted.sh
@scripts/deploy.config.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive self-hosted deployment guide</name>
  <files>docs/SELFHOSTED_DEPLOYMENT.md</files>
  <action>
Create the complete self-hosted deployment guide covering the entire journey from bare VM to running application.

**Document structure:**

````markdown
# Self-Hosted Deployment Guide

Complete guide for deploying FreshTrack Pro to a self-hosted Ubuntu 24.04 VM.

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [DNS Configuration](#dns-configuration)
4. [Server Preparation](#server-preparation)
5. [Configuration](#configuration)
6. [Deployment](#deployment)
7. [Verification](#verification)
8. [Post-Deployment](#post-deployment)
9. [Rollback Procedures](#rollback-procedures)
10. [Troubleshooting](#troubleshooting)
11. [Maintenance](#maintenance)

---

## Overview

This guide covers deploying FreshTrack Pro using the automated `deploy-selfhosted.sh` script. The script is idempotent and can be safely rerun after failures.

**What the script does:**

- Installs Docker and Docker Compose
- Configures UFW firewall (ports 22, 80, 443)
- Installs fail2ban for intrusion prevention
- Installs node_exporter for system metrics
- Sets up application directory (/opt/freshtrack-pro)
- Creates secure secret files
- Validates DNS before requesting SSL certificates
- Deploys services with health check validation
- Automatic rollback on deployment failure

**Estimated time:** 30-45 minutes for first deployment

---

## Prerequisites

### Server Requirements

| Requirement | Minimum          | Recommended      |
| ----------- | ---------------- | ---------------- |
| CPU         | 4 vCPU           | 4+ vCPU          |
| RAM         | 8 GB             | 16 GB            |
| Storage     | 100 GB SSD       | 200 GB SSD       |
| OS          | Ubuntu 24.04 LTS | Ubuntu 24.04 LTS |
| Network     | Static IP        | Static IP        |

### External Services

**Required:**

- [ ] Domain name with DNS access
- [ ] Stack Auth account (https://stack-auth.com)
  - Project ID
  - Publishable Key
  - Secret Key

**Optional:**

- [ ] Telnyx account for SMS notifications
- [ ] Slack/Discord webhook for deployment notifications

### Local Tools

- SSH client for server access
- Text editor for configuration

---

## DNS Configuration

Configure DNS records BEFORE running deployment:

### Required Records

| Type | Name                  | Value          | TTL |
| ---- | --------------------- | -------------- | --- |
| A    | @ (or yourdomain.com) | YOUR_SERVER_IP | 300 |
| A    | www                   | YOUR_SERVER_IP | 300 |
| A    | monitoring            | YOUR_SERVER_IP | 300 |
| A    | status                | YOUR_SERVER_IP | 300 |

### Verify DNS Propagation

```bash
# Check A record
dig yourdomain.com +short

# Should return your server IP
# Wait for propagation (5-60 minutes) if different
```
````

**Important:** The deployment script checks DNS before requesting SSL certificates.
If DNS is not configured, deployment will abort (prevents Let's Encrypt rate limit issues).

---

## Server Preparation

### 1. SSH into Your Server

```bash
ssh root@YOUR_SERVER_IP
```

### 2. Update System

```bash
apt update && apt upgrade -y
```

### 3. Clone Repository

```bash
git clone https://github.com/your-org/freshtrack-pro.git /opt/freshtrack-pro
cd /opt/freshtrack-pro
```

---

## Configuration

### 1. Create Configuration File

```bash
cp scripts/deploy.config.example scripts/deploy.config
```

### 2. Edit Configuration

```bash
nano scripts/deploy.config
```

**Required settings:**

```bash
# Domain (must match DNS configuration)
DOMAIN=yourdomain.com
ADMIN_EMAIL=admin@yourdomain.com

# Database credentials (generate strong password)
POSTGRES_PASSWORD=your-secure-password-here

# Stack Auth credentials (from Stack Auth dashboard)
STACK_AUTH_PROJECT_ID=your-project-id
STACK_AUTH_PUBLISHABLE_KEY=pk_...
STACK_AUTH_SECRET_KEY=sk_...
```

See `scripts/deploy.config.example` for all available options.

---

## Deployment

### Run Deployment Script

```bash
chmod +x scripts/deploy-selfhosted.sh
./scripts/deploy-selfhosted.sh
```

The script will:

1. Install dependencies (Docker, firewall, fail2ban, etc.)
2. Verify DNS configuration
3. Create secure secret files
4. Start all services
5. Validate health checks
6. Report deployment status

### Deployment Output

```
==> Loading configuration...
✓ Configuration loaded

==> Installing Docker...
✓ Docker already installed

==> Configuring firewall...
✓ Firewall configured

==> Checking DNS resolution...
Server public IP: 159.89.123.456
✓ DNS resolved correctly: yourdomain.com -> 159.89.123.456

==> Starting services...
✓ All services started

==> Validating deployment health...
✓ Health check passed
✓ Backend reports healthy status

========================================
Deployment Complete
========================================
```

---

## Verification

### 1. Check Application

Open in browser:

- Main app: https://yourdomain.com
- Health check: https://yourdomain.com/health
- API health: https://yourdomain.com/api/health

### 2. Check SSL Certificate

```bash
# Verify certificate
echo | openssl s_client -connect yourdomain.com:443 2>/dev/null | openssl x509 -noout -dates
```

### 3. Check Services

```bash
cd /opt/freshtrack-pro
docker compose -f docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.selfhosted.yaml ps
```

### 4. Check Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f backend
```

---

## Post-Deployment

### Access Monitoring

- Grafana: https://monitoring.yourdomain.com
  - Default login: admin / (from GRAFANA_ADMIN_PASSWORD in config)
- Prometheus: http://localhost:9090 (via SSH tunnel)

### Set Up Backups

Verify backup job is running:

```bash
docker compose logs postgres_backup
```

Backups run daily at 2 AM UTC to MinIO.

---

## Rollback Procedures

### Automatic Rollback

The deployment script automatically rolls back if health checks fail:

- Previous 3 versions retained (configurable via VERSION_RETENTION)
- Code-only rollback (database unchanged)
- Previous Docker images restored

### Manual Rollback

If needed, manually rollback:

```bash
cd /opt/freshtrack-pro

# Check available versions
cat .deployment-history

# Stop current deployment
docker compose down

# Restore previous version's images
docker tag freshtrack-backend:previous-tag freshtrack-backend:latest
docker tag freshtrack-frontend:previous-tag freshtrack-frontend:latest

# Start services
docker compose -f docker-compose.yml -f docker/compose.prod.yaml -f docker/compose.selfhosted.yaml up -d
```

### Database Considerations

Rollback is code-only. If deployment included database migrations:

- Forward-only migrations (no automatic schema rollback)
- If schema change broke app, restore from backup
- See docs/DATABASE.md for restore procedures

---

## Troubleshooting

### DNS Check Fails

**Symptom:** "DNS resolution failed for yourdomain.com"

**Solution:**

1. Verify DNS records in your provider dashboard
2. Wait for propagation (use `dig yourdomain.com`)
3. Ensure A record points to server IP
4. Retry deployment

### Health Check Fails

**Symptom:** "Health check failed after 30 attempts"

**Solutions:**

1. Check backend logs: `docker compose logs backend`
2. Verify database is healthy: `docker compose logs postgres`
3. Check resource usage: `docker stats`

### SSL Certificate Not Issued

**Symptom:** Browser shows certificate error

**Solutions:**

1. Check Caddy logs: `docker compose logs caddy`
2. Verify port 80 is accessible from internet
3. Check Let's Encrypt rate limits (5 failures/hour)
4. Use staging environment for testing

See docs/SSL_CERTIFICATES.md for detailed SSL troubleshooting.

### Service Won't Start

**Symptom:** Container restarts repeatedly

**Solutions:**

1. Check logs: `docker compose logs <service>`
2. Verify secrets exist: `ls -la /opt/freshtrack-pro/secrets/`
3. Check resource limits: `docker stats`

---

## Maintenance

### Updates

```bash
cd /opt/freshtrack-pro
git pull
./scripts/deploy-selfhosted.sh
```

The script handles migrations and health checks automatically.

### Monitoring

- System metrics: Grafana dashboard
- Application logs: Loki via Grafana
- SSL expiry: Blackbox exporter alerts

### Backup Verification

Monthly backup restore test:

```bash
./scripts/test-restore.sh
```

See docs/DATABASE.md for full backup documentation.

---

## Related Documentation

- [SSL Certificate Configuration](SSL_CERTIFICATES.md)
- [Database Operations](DATABASE.md)
- [Production Deployment (general)](PRODUCTION_DEPLOYMENT.md)

```
  </action>
  <verify>
File exists: docs/SELFHOSTED_DEPLOYMENT.md
Line count sufficient: wc -l docs/SELFHOSTED_DEPLOYMENT.md shows 300+
Contains all sections: grep -c "^## " docs/SELFHOSTED_DEPLOYMENT.md shows 10+
References deploy script: grep -q "deploy-selfhosted.sh" docs/SELFHOSTED_DEPLOYMENT.md
References SSL docs: grep -q "SSL_CERTIFICATES.md" docs/SELFHOSTED_DEPLOYMENT.md
Contains rollback section: grep -q "## Rollback" docs/SELFHOSTED_DEPLOYMENT.md
  </verify>
  <done>Complete self-hosted deployment guide covers entire journey from bare VM to running application</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete self-hosted deployment workflow:
- deploy.config.example configuration template
- deploy-selfhosted.sh idempotent deployment script
- DNS pre-check to prevent Let's Encrypt rate limits
- Health check validation with automatic rollback
- Version tagging for rollback capability
- SSL certificate documentation (individual and wildcard)
- Comprehensive deployment guide (docs/SELFHOSTED_DEPLOYMENT.md)
  </what-built>
  <how-to-verify>
**Documentation Review:**
1. Read docs/SELFHOSTED_DEPLOYMENT.md end-to-end
2. Verify all steps are clear and actionable
3. Check cross-references to other docs work

**Script Review:**
1. Review scripts/deploy-selfhosted.sh for completeness
2. Run `shellcheck scripts/deploy-selfhosted.sh` (warnings OK)
3. Verify idempotent patterns throughout

**Configuration Review:**
1. Review scripts/deploy.config.example for all needed variables
2. Verify sensitive values have placeholder comments

**Optional (if test VM available):**
1. Provision fresh Ubuntu 24.04 VM
2. Clone repo, create deploy.config
3. Run deploy-selfhosted.sh
4. Verify application accessible via HTTPS
5. Simulate failure, verify rollback works
  </how-to-verify>
  <resume-signal>Type "approved" if documentation and scripts are complete, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] docs/SELFHOSTED_DEPLOYMENT.md exists with 300+ lines
- [ ] Guide covers: prerequisites, DNS, config, deployment, verification, rollback, troubleshooting
- [ ] All code examples are accurate and tested
- [ ] Cross-references to other docs are correct
- [ ] Human reviewer approved documentation completeness
</verification>

<success_criteria>
- Documentation enables user to deploy from bare VM without external help
- Rollback procedures clearly documented with examples
- Troubleshooting covers common failure scenarios
- Phase 11 requirements satisfied:
  - DEPLOY-01: Self-hosted deployment documentation complete
  - DEPLOY-02: Self-hosted deployment scripts validated (deploy-selfhosted.sh)
  - DEPLOY-03: SSL/TLS with Let's Encrypt configured (Caddy automatic HTTPS)
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-hosted-deployment/11-04-SUMMARY.md`
</output>
```
