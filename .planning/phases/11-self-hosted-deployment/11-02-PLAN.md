---
phase: 11-self-hosted-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/SSL_CERTIFICATES.md
  - docker/caddy/Caddyfile.wildcard.example
autonomous: true

must_haves:
  truths:
    - 'Wildcard certificate setup documented with DNS challenge instructions'
    - 'Individual certificate setup documented as default (simpler, no DNS API needed)'
    - 'DNS provider-specific instructions included for common providers'
  artifacts:
    - path: 'docs/SSL_CERTIFICATES.md'
      provides: 'SSL/TLS certificate documentation'
      min_lines: 100
      contains: 'wildcard'
    - path: 'docker/caddy/Caddyfile.wildcard.example'
      provides: 'Caddyfile template for wildcard certificates'
      contains: 'dns cloudflare'
  key_links:
    - from: 'docs/SSL_CERTIFICATES.md'
      to: 'docker/caddy/Caddyfile'
      via: 'references default config'
      pattern: 'Caddyfile'
---

<objective>
Document SSL/TLS certificate options for self-hosted deployment

Purpose: Users need clear guidance on SSL certificate setup. Default path (individual certs via HTTP-01) works without DNS API credentials. Advanced path (wildcard certs via DNS-01) requires DNS provider API access but simplifies multi-subdomain setups.

Output:

- docs/SSL_CERTIFICATES.md (comprehensive SSL documentation)
- docker/caddy/Caddyfile.wildcard.example (template for wildcard setup)
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-self-hosted-deployment/11-RESEARCH.md

# Existing Caddy config

@docker/caddy/Caddyfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSL certificate documentation</name>
  <files>docs/SSL_CERTIFICATES.md</files>
  <action>
Create comprehensive SSL/TLS documentation covering both certificate approaches.

**Document structure:**

````markdown
# SSL/TLS Certificate Configuration

FreshTrack Pro uses Caddy for automatic HTTPS. Caddy handles certificate acquisition, renewal, and OCSP stapling automatically.

## Table of Contents

1. [How Caddy Automatic HTTPS Works](#how-caddy-automatic-https-works)
2. [Default Setup: Individual Certificates](#default-setup-individual-certificates)
3. [Advanced Setup: Wildcard Certificates](#advanced-setup-wildcard-certificates)
4. [DNS Provider Configuration](#dns-provider-configuration)
5. [Troubleshooting](#troubleshooting)
6. [Let's Encrypt Rate Limits](#lets-encrypt-rate-limits)

## How Caddy Automatic HTTPS Works

[Explain HTTP-01 vs DNS-01 challenges]

- HTTP-01: Let's Encrypt connects to your server on port 80
- DNS-01: Prove domain ownership via DNS TXT record

## Default Setup: Individual Certificates

This is the **recommended approach** for most deployments.

**Pros:**

- No DNS API credentials needed
- Works with any DNS provider
- Zero configuration in most cases

**Cons:**

- Each subdomain needs separate certificate
- Requires port 80 accessible from internet

**Configuration:**
The default Caddyfile handles this automatically:
[Reference docker/caddy/Caddyfile]

**Required DNS setup:**

- A record: freshtrackpro.com -> your server IP
- A record: monitoring.freshtrackpro.com -> your server IP
- A record: status.freshtrackpro.com -> your server IP

## Advanced Setup: Wildcard Certificates

Use wildcard certificates when:

- You have many subdomains
- You want to add subdomains without certificate requests
- You have DNS API access

**Pros:**

- Single certificate covers \*.yourdomain.com
- Add subdomains without SSL configuration

**Cons:**

- Requires DNS provider API credentials
- More complex setup

**Configuration:**

1. Copy wildcard template: `cp docker/caddy/Caddyfile.wildcard.example docker/caddy/Caddyfile`
2. Set DNS API credentials in environment
3. Restart Caddy

## DNS Provider Configuration

### Cloudflare (Recommended)

1. Create API token:
   - Go to Cloudflare Dashboard > My Profile > API Tokens
   - Create Token > Edit zone DNS template
   - Zone Resources: Include > Specific zone > your domain
   - Copy the token

2. Set environment variable:
   ```bash
   export CLOUDFLARE_API_TOKEN="your-token-here"
   ```
````

3. Use Caddyfile.wildcard.example

### DigitalOcean

[Instructions for DO DNS]

### Route53 (AWS)

[Instructions for Route53]

### Other providers

[Link to Caddy DNS providers documentation]

## Troubleshooting

### Certificate not issued

[Common issues and solutions]

### Rate limit errors

[How to use staging environment]

### DNS propagation delays

[Waiting for DNS, using dig to verify]

## Let's Encrypt Rate Limits

**Current limits (as of 2026):**

- 50 certificates per registered domain per week
- 5 duplicate certificates per week
- 5 failed validations per account per hour

**Best practices:**

- Use staging environment for testing
- Check DNS resolution before deployment
- Don't retry immediately on failure

```
  </action>
  <verify>
File exists: docs/SSL_CERTIFICATES.md
Contains sections: grep -c "## " docs/SSL_CERTIFICATES.md shows 6+
Contains Cloudflare instructions: grep -q "Cloudflare" docs/SSL_CERTIFICATES.md
Contains rate limits: grep -q "Rate Limit" docs/SSL_CERTIFICATES.md
  </verify>
  <done>SSL documentation exists with individual and wildcard certificate setup instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create wildcard Caddyfile template</name>
  <files>docker/caddy/Caddyfile.wildcard.example</files>
  <action>
Create a Caddyfile template for wildcard certificate setup with DNS challenge.

**Template content:**

```

# FreshTrack Pro Caddy Configuration - Wildcard Certificates

#

# This configuration uses DNS-01 challenge for wildcard certificates.

# Requires DNS provider API credentials.

#

# Usage:

# 1. Copy this file to Caddyfile: cp Caddyfile.wildcard.example Caddyfile

# 2. Replace {$DNS_PROVIDER} with your provider (cloudflare, digitalocean, route53, etc.)

# 3. Set required environment variables (see comments)

# 4. Restart Caddy

#

# Supported DNS providers: https://caddyserver.com/docs/modules/

{ # Admin email for Let's Encrypt notifications
email {$ADMIN_EMAIL:admin@example.com}

    # Uncomment for testing (uses Let's Encrypt staging)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Access logging
    log {
        output file /var/log/caddy/access.log
        format json
    }

}

# Wildcard certificate for all subdomains

\*.{$DOMAIN} {
tls { # DNS challenge configuration # Replace with your DNS provider # Common providers: cloudflare, digitalocean, route53, gandi, namecheap

        # Cloudflare example (set CLOUDFLARE_API_TOKEN env var):
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}

        # DigitalOcean example (set DO_AUTH_TOKEN env var):
        # dns digitalocean {env.DO_AUTH_TOKEN}

        # Route53 example (uses AWS credentials from environment):
        # dns route53

        # Propagation settings (increase if DNS is slow)
        propagation_timeout 5m
        propagation_delay 30s
    }

    # Route different subdomains to different services
    @api host api.{$DOMAIN}
    handle @api {
        reverse_proxy backend:3000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    @monitoring host monitoring.{$DOMAIN}
    handle @monitoring {
        reverse_proxy grafana:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
        }
    }

    @status host status.{$DOMAIN}
    handle @status {
        reverse_proxy uptime-kuma:3001 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
        }
    }

    # Main application (www and apex)
    @main host {$DOMAIN} www.{$DOMAIN}
    handle @main {
        # API routes
        reverse_proxy /api/* backend:3000 {
            health_uri /health
            health_interval 30s
            health_timeout 10s
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }

        # Health endpoint
        reverse_proxy /health backend:3000

        # Frontend
        reverse_proxy /* frontend:5173
    }

    # Fallback for unmatched subdomains
    handle {
        respond "Not found" 404
    }

    # Response compression
    encode gzip zstd

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

}

# Redirect bare domain to www (optional)

# {$DOMAIN} {

# redir https://www.{$DOMAIN}{uri} permanent

# }

```

Include comments explaining:
- How to switch DNS providers
- Required environment variables per provider
- Propagation timeout settings
- How to test with staging environment
  </action>
  <verify>
File exists: docker/caddy/Caddyfile.wildcard.example
Contains wildcard pattern: grep -q '^\*\.' docker/caddy/Caddyfile.wildcard.example
Contains dns directive: grep -q "dns cloudflare" docker/caddy/Caddyfile.wildcard.example
Contains propagation settings: grep -q "propagation_timeout" docker/caddy/Caddyfile.wildcard.example
  </verify>
  <done>Wildcard Caddyfile template exists with DNS challenge configuration for multiple providers</done>
</task>

</tasks>

<verification>
- [ ] docs/SSL_CERTIFICATES.md exists with comprehensive coverage
- [ ] Covers both HTTP-01 (individual) and DNS-01 (wildcard) approaches
- [ ] Caddyfile.wildcard.example exists with DNS provider configuration
- [ ] Documentation includes troubleshooting and rate limit guidance
</verification>

<success_criteria>
- SSL documentation clearly explains when to use each approach
- Wildcard template includes examples for common DNS providers (Cloudflare, DO, Route53)
- Rate limit warnings prevent users from exhausting Let's Encrypt limits
- Users can choose appropriate SSL setup based on their DNS provider access
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-hosted-deployment/11-02-SUMMARY.md`
</output>
```
