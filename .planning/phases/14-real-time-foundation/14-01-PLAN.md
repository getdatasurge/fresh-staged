---
phase: 14-real-time-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/plugins/socket.plugin.ts
  - backend/src/types/socket.d.ts
  - backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "Socket.io server starts with Fastify without errors"
    - "WebSocket connections can be established from browser"
    - "Connection count visible in health endpoint"
  artifacts:
    - path: "backend/src/plugins/socket.plugin.ts"
      provides: "Socket.io Fastify plugin"
      exports: ["default"]
      min_lines: 40
    - path: "backend/src/types/socket.d.ts"
      provides: "Socket.io TypeScript types"
      contains: "interface SocketData"
  key_links:
    - from: "backend/src/app.ts"
      to: "socket.plugin.ts"
      via: "app.register"
      pattern: "register.*socket"
---

<objective>
Install Socket.io dependencies and create Fastify plugin for WebSocket support.

Purpose: Establish foundational real-time infrastructure that all subsequent plans build upon.
Output: Working Socket.io server integrated with Fastify, basic connection handling, updated health endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/REALTIME.md

@backend/src/app.ts
@backend/package.json
@backend/src/routes/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Socket.io dependencies</name>
  <files>backend/package.json</files>
  <action>
Install required dependencies in backend directory:
- socket.io (server library)
- fastify-socket.io (Fastify plugin)
- bufferutil (performance optimization - optional peer dep)
- utf-8-validate (performance optimization - optional peer dep)

Run: `cd backend && npm install socket.io fastify-socket.io && npm install --save-optional bufferutil utf-8-validate`

Verify package.json includes new dependencies after install.
  </action>
  <verify>Run `npm list socket.io fastify-socket.io` in backend directory - both packages appear</verify>
  <done>socket.io and fastify-socket.io listed in backend/package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Socket.io plugin and TypeScript types</name>
  <files>
    backend/src/plugins/socket.plugin.ts
    backend/src/types/socket.d.ts
  </files>
  <action>
Create TypeScript type definitions for Socket.io in `backend/src/types/socket.d.ts`:
- Define `SocketData` interface with userId, organizationId, role, email fields
- Extend Fastify types to include `io` decorator using `fastify-socket.io` pattern
- Export interfaces for ServerToClientEvents and ClientToServerEvents

Create Socket.io plugin in `backend/src/plugins/socket.plugin.ts`:
- Import fastifySocketIO from 'fastify-socket.io'
- Configure CORS from environment (FRONTEND_URL) with credentials:true
- Handle io.on('connection') with basic logging
- Log disconnect events with reason
- Export as default Fastify plugin

Example structure from research:
```typescript
app.register(fastifySocketIO, {
  cors: {
    origin: process.env.FRONTEND_URL || 'http://localhost:5173',
    credentials: true,
  },
});
```

IMPORTANT: Socket.io handlers must be set up inside app.ready() callback, not during plugin registration. The plugin file should export the plugin registration AND a setup function that gets called after ready().
  </action>
  <verify>Run `npx tsc --noEmit` in backend directory - no type errors</verify>
  <done>socket.plugin.ts exports Fastify plugin, socket.d.ts provides type definitions, TypeScript compiles without errors</done>
</task>

<task type="auto">
  <name>Task 3: Integrate plugin into app.ts and update health endpoint</name>
  <files>
    backend/src/app.ts
    backend/src/routes/health.ts
  </files>
  <action>
Update `backend/src/app.ts`:
- Import socket plugin: `import socketPlugin from './plugins/socket.plugin.js'`
- Register plugin after CORS: `app.register(socketPlugin)`
- Add app.ready() callback to set up Socket.io event handlers
- Log "Socket.io ready" when handlers are configured

Update `backend/src/routes/health.ts`:
- Add /health/realtime endpoint that returns connection count
- Access `app.io.engine.clientsCount` for active connections
- Return JSON: `{ websocket: { enabled: true, connections: N } }`
- Keep existing health endpoint unchanged

CORS origins in socket plugin should match existing CORS config in app.ts (localhost:8080, localhost:5173, WSL IPs).
  </action>
  <verify>
1. Start backend: `cd backend && npm run dev`
2. Verify no startup errors in console
3. Check "Socket.io ready" message appears
4. `curl http://localhost:3000/health/realtime` returns `{"websocket":{"enabled":true,"connections":0}}`
  </verify>
  <done>Backend starts without errors, Socket.io initialized, health/realtime endpoint returns connection count</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Backend starts without errors: `npm run dev`
2. TypeScript compiles: `npx tsc --noEmit`
3. Health endpoint works: `curl http://localhost:3000/health/realtime`
4. No console errors related to Socket.io initialization
</verification>

<success_criteria>
- Socket.io v4 installed and integrated with Fastify
- TypeScript types properly defined for socket events and data
- Health endpoint reports WebSocket connection status
- Backend can accept WebSocket connections (tested in next plan)
</success_criteria>

<output>
After completion, create `.planning/phases/14-real-time-foundation/14-01-SUMMARY.md`
</output>
