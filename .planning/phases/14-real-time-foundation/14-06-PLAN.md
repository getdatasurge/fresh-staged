---
phase: 14-real-time-foundation
plan: 06
type: execute
wave: 5
depends_on: ["14-05"]
files_modified:
  - src/components/common/ConnectionStatus.tsx
  - src/features/dashboard-layout/components/DashboardHeader.tsx
autonomous: false

must_haves:
  truths:
    - "Connection status indicator visible in dashboard header"
    - "Live sensor readings appear on dashboard without refresh"
    - "Alert toast appears when threshold exceeded"
    - "Multiple browser tabs see synchronized data"
  artifacts:
    - path: "src/components/common/ConnectionStatus.tsx"
      provides: "WebSocket connection status indicator"
      exports: ["ConnectionStatus"]
      min_lines: 30
  key_links:
    - from: "src/components/common/ConnectionStatus.tsx"
      to: "useRealtimeStatus"
      via: "hook for connection state"
      pattern: "useRealtimeStatus"
---

<objective>
Add connection status indicator and verify end-to-end real-time functionality.

Purpose: Complete the real-time foundation with visual feedback and integration testing.
Output: Connection status UI component, verified E2E real-time flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/REALTIME.md

@.planning/phases/14-real-time-foundation/14-05-SUMMARY.md

@src/providers/RealtimeProvider.tsx
@src/features/dashboard-layout/components/DashboardHeader.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionStatus indicator component</name>
  <files>src/components/common/ConnectionStatus.tsx</files>
  <action>
Create `src/components/common/ConnectionStatus.tsx`:

```typescript
import { Wifi, WifiOff, Loader2 } from 'lucide-react';
import { useRealtimeStatus } from '@/providers/RealtimeProvider';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { cn } from '@/lib/utils';

export function ConnectionStatus() {
  const { isConnected, isConnecting, connectionError } = useRealtimeStatus();

  const getStatusConfig = () => {
    if (isConnecting) {
      return {
        icon: Loader2,
        color: 'text-yellow-500',
        tooltip: 'Connecting to real-time updates...',
        animate: true,
      };
    }
    if (isConnected) {
      return {
        icon: Wifi,
        color: 'text-green-500',
        tooltip: 'Real-time updates active',
        animate: false,
      };
    }
    return {
      icon: WifiOff,
      color: 'text-red-500',
      tooltip: connectionError || 'Real-time updates disconnected',
      animate: false,
    };
  };

  const config = getStatusConfig();
  const Icon = config.icon;

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <div className="flex items-center">
            <Icon
              className={cn(
                'w-4 h-4',
                config.color,
                config.animate && 'animate-spin'
              )}
            />
          </div>
        </TooltipTrigger>
        <TooltipContent>
          <p>{config.tooltip}</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
```

Export from common/index.ts if barrel export exists.
  </action>
  <verify>Run `npm run build` - component compiles without errors</verify>
  <done>ConnectionStatus component shows real-time connection state with appropriate icon and tooltip</done>
</task>

<task type="auto">
  <name>Task 2: Add ConnectionStatus to dashboard header</name>
  <files>src/features/dashboard-layout/components/DashboardHeader.tsx</files>
  <action>
Update `src/features/dashboard-layout/components/DashboardHeader.tsx`:

1. Import ConnectionStatus: `import { ConnectionStatus } from '@/components/common/ConnectionStatus'`
2. Add ConnectionStatus component near the user menu/settings area
3. Position it with appropriate spacing (e.g., in the header toolbar area)

Example placement:
```tsx
<div className="flex items-center gap-4">
  <ConnectionStatus />
  {/* existing user menu, settings, etc */}
</div>
```

The indicator should be visible but not prominent - it's informational, not a primary action.

If DashboardHeader doesn't exist with this exact name, find the appropriate header component in the dashboard layout and add it there.
  </action>
  <verify>Run `npm run dev` - indicator visible in dashboard header, shows correct state</verify>
  <done>ConnectionStatus indicator visible in dashboard header showing real-time connection state</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete real-time foundation with Socket.io integration:
- Backend: Socket.io server with Redis adapter and JWT auth
- Backend: Sensor data buffering and 1-second batched broadcasts
- Backend: Alert event emission on state changes
- Frontend: Socket.io client with auth token
- Frontend: TanStack Query cache updates from WebSocket events
- Frontend: Alert toast notifications
- Frontend: Connection status indicator
  </what-built>
  <how-to-verify>
**Setup:**
1. Ensure Redis is running (or backend handles missing Redis gracefully)
2. Start backend: `cd backend && npm run dev`
3. Start frontend: `npm run dev`
4. Open browser to http://localhost:5173

**Test 1: Connection Status**
1. Log in to dashboard
2. Verify green Wifi icon in header (connected)
3. Stop backend - icon should turn red (disconnected)
4. Restart backend - icon should return to green (auto-reconnect)

**Test 2: Sensor Data Streaming**
1. With dashboard open on unit detail page
2. POST a sensor reading via API:
   ```bash
   curl -X POST http://localhost:3000/api/readings/ingest \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"readings": [{"unitId": "YOUR_UNIT_ID", "temperature": 45.5, "recordedAt": "2024-01-24T12:00:00Z", "source": "test"}]}'
   ```
3. Dashboard should update temperature display within 1 second (no page refresh)

**Test 3: Alert Notifications**
1. POST a reading that exceeds unit threshold (e.g., temp > max)
2. Toast notification should appear showing alert triggered
3. Unit status should update to "excursion" in UI

**Test 4: Multi-Tab Sync**
1. Open dashboard in two browser tabs (same user)
2. POST a sensor reading
3. Both tabs should update simultaneously

**Expected Outcome:**
- All four tests pass
- No console errors related to Socket.io
- No duplicate event handling
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Connection status indicator visible and accurate
2. Sensor readings stream to dashboard in real-time
3. Alert toasts appear when thresholds exceeded
4. Multiple tabs stay synchronized
5. Auto-reconnection works after disconnect
</verification>

<success_criteria>
- RT-01: Socket.io integrated with Fastify backend - VERIFIED
- RT-02: Redis adapter configured for horizontal scaling - VERIFIED
- RT-03: Multi-tenant room architecture with org isolation - VERIFIED
- RT-04: Live sensor readings pushed to dashboard - VERIFIED
- RT-05: Real-time alert notifications delivered - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/14-real-time-foundation/14-06-SUMMARY.md`
</output>
