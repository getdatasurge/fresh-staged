---
phase: 45-production-deployment
plan: 03
type: execute
wave: 3
depends_on: ["45-02"]
files_modified: []
autonomous: false

user_setup:
  - service: stripe
    why: "Webhook endpoint configuration"
    dashboard_config:
      - task: "Create webhook endpoint pointing to https://${DOMAIN}/api/webhooks/stripe"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Copy webhook signing secret (whsec_...)"
        location: "Stripe Dashboard -> Webhooks -> Your endpoint -> Signing secret"
  - service: stack-auth
    why: "Allowed redirect URLs"
    dashboard_config:
      - task: "Add https://${DOMAIN} to allowed redirect URLs"
        location: "Stack Auth Dashboard -> Project Settings -> OAuth"
  - service: ttn
    why: "Webhook for sensor data"
    dashboard_config:
      - task: "Create webhook pointing to https://${DOMAIN}/api/webhooks/ttn"
        location: "TTN Console -> Applications -> Webhooks"

must_haves:
  truths:
    - "SSL certificate is valid and auto-renewing"
    - "User can sign up via Stack Auth"
    - "User can create an organization"
    - "Dashboard loads and displays correctly"
    - "Stripe webhooks are configured"
    - "Monitoring dashboard is accessible"
  artifacts: []
  key_links:
    - from: "Stack Auth"
      to: "Backend /api/auth"
      via: "JWT validation"
      pattern: "Authorization: Bearer"
    - from: "Frontend"
      to: "Backend /api/trpc"
      via: "tRPC client"
      pattern: "trpc"
---

<objective>
Validate deployment and configure external service webhooks.

Purpose: Ensure end-to-end functionality works and external integrations are connected.
Output: Fully functional production instance with verified user flows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/45-production-deployment/45-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify SSL and Core Services</name>
  <files>N/A - validation only</files>
  <action>
    Run verification checks against the deployed instance:

    1. Check SSL certificate:
       ```bash
       curl -vI https://${DOMAIN} 2>&1 | grep -E "(SSL|certificate|expire)"
       ```

    2. Check health endpoint:
       ```bash
       curl -s https://${DOMAIN}/health | jq .
       ```

    3. Check API availability:
       ```bash
       curl -s https://${DOMAIN}/api/health | jq .
       ```

    4. Check monitoring dashboard (if configured):
       ```bash
       curl -sI https://monitoring.${DOMAIN} | head -5
       ```

    5. Check status page (if configured):
       ```bash
       curl -sI https://status.${DOMAIN} | head -5
       ```

    6. View service status on VM:
       ```bash
       ssh ${VM_USER}@${VM_HOST} "cd /opt/freshtrack && docker compose ps"
       ```
  </action>
  <verify>
    - SSL certificate valid (not self-signed, not expired)
    - /health returns {"status":"ok"}
    - All services show "healthy" in docker compose ps
  </verify>
  <done>Core infrastructure verified: SSL valid, health checks pass, all services running</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure External Service Webhooks</name>
  <action>
    User must configure webhooks in external service dashboards:

    **1. Stripe Webhooks:**
    - Go to https://dashboard.stripe.com/webhooks
    - Click "Add endpoint"
    - URL: `https://${DOMAIN}/api/webhooks/stripe`
    - Events to listen for:
      - checkout.session.completed
      - customer.subscription.created
      - customer.subscription.updated
      - customer.subscription.deleted
      - invoice.payment_succeeded
      - invoice.payment_failed
    - Copy the "Signing secret" (whsec_...)
    - Update .env.production: `STRIPE_WEBHOOK_SECRET=whsec_...`
    - Restart backend: `docker compose restart backend`

    **2. Stack Auth Redirect URLs:**
    - Go to Stack Auth Dashboard -> Project Settings
    - Add `https://${DOMAIN}` to allowed redirect URLs
    - Add `https://${DOMAIN}/auth/callback` if separate callback

    **3. TTN Webhooks (if using IoT):**
    - Go to TTN Console -> Your Application -> Webhooks
    - Create webhook with URL: `https://${DOMAIN}/api/webhooks/ttn`
    - Format: JSON
    - Enable uplink messages
  </action>
  <how-to-verify>
    User confirms:
    - Stripe webhook endpoint created and signing secret added to .env.production
    - Stack Auth redirect URLs configured
    - (If using TTN) TTN webhook created
  </how-to-verify>
  <resume-signal>Type "webhooks configured" when external services are set up</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-End User Flow Validation</name>
  <what-built>Complete production deployment of FreshTrack Pro</what-built>
  <how-to-verify>
    Test the full user journey:

    1. **Open the application:**
       - Navigate to https://${DOMAIN}
       - Verify the login page loads without errors

    2. **Sign up a new user:**
       - Click "Sign up" or equivalent
       - Complete Stack Auth registration flow
       - Verify redirect back to application

    3. **Create an organization:**
       - After login, follow onboarding to create organization
       - Enter organization name and details
       - Verify organization is created successfully

    4. **View the dashboard:**
       - Navigate to main dashboard
       - Verify dashboard loads without errors
       - Check that widgets render (may be empty without data)

    5. **Check monitoring (optional):**
       - Visit https://monitoring.${DOMAIN}
       - Login with Grafana credentials (from secrets/grafana_password.txt)
       - Verify dashboards load

    **Expected results:**
    - All pages load without JavaScript errors
    - User can complete signup -> org creation -> dashboard view
    - No 500 errors in browser console or backend logs
  </how-to-verify>
  <resume-signal>Type "validated" if user flow works, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
- SSL certificate valid and trusted by browsers
- Health endpoint returns 200 OK
- User can sign up via Stack Auth
- User can create organization
- Dashboard displays correctly
- Stripe webhook endpoint configured
- No critical errors in logs
</verification>

<success_criteria>
Phase 45 complete when:
1. SSL certificate valid and auto-renewing
2. All services healthy (docker compose ps)
3. User signup flow works end-to-end
4. Organization creation succeeds
5. Dashboard loads and displays
6. External webhooks configured (Stripe, optionally TTN)
7. Monitoring accessible (Grafana)
</success_criteria>

<output>
After completion, create `.planning/phases/45-production-deployment/45-03-SUMMARY.md`
</output>
