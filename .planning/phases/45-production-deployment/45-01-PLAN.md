---
phase: 45-production-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: vm-provider
    why: "Hosting infrastructure"
    dashboard_config:
      - task: "Provision Ubuntu VM with 4+ vCPU, 8+ GB RAM, 100+ GB SSD"
        location: "Your cloud provider (DigitalOcean, AWS, Hetzner, etc.)"
      - task: "Open ports 22 (SSH), 80 (HTTP), 443 (HTTPS)"
        location: "VM firewall/security group settings"
  - service: domain-registrar
    why: "DNS configuration"
    dashboard_config:
      - task: "Point domain A record to VM IP address"
        location: "DNS management (Cloudflare, Namecheap, etc.)"
  - service: stack-auth
    why: "Authentication service"
    env_vars:
      - name: STACK_AUTH_PROJECT_ID
        source: "Stack Auth Dashboard -> Project Settings"
      - name: STACK_AUTH_PUBLISHABLE_KEY
        source: "Stack Auth Dashboard -> API Keys"
      - name: STACK_AUTH_SECRET_KEY
        source: "Stack Auth Dashboard -> API Keys (secret)"
  - service: stripe
    why: "Payment processing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks (after endpoint created)"
  - service: resend
    why: "Email delivery"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"

must_haves:
  truths:
    - "User has provided VM SSH access information"
    - "User has provided domain name"
    - "User has provided Stack Auth credentials"
    - "DNS is configured and propagated"
  artifacts: []
  key_links: []
---

<objective>
Validate deployment prerequisites and collect required information from user.

Purpose: Ensure all infrastructure and credentials are ready before deployment begins.
Output: Validated checklist confirming VM access, domain, and external service credentials.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.env.production.example
@docs/deployment/deploy-guide.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Collect VM and Domain Information</name>
  <action>
    User must provide the following infrastructure details:

    1. **VM Access:**
       - VM IP address or hostname
       - SSH username (typically `root` or a sudo user)
       - SSH key or password authentication method
       - Confirm: Ubuntu 22.04 or 24.04 LTS installed
       - Confirm: 4+ vCPU, 8+ GB RAM, 100+ GB SSD

    2. **Domain:**
       - Production domain name (e.g., `app.freshtrackpro.com`)
       - Confirm: DNS A record points to VM IP
       - Email for Let's Encrypt SSL certificates

    3. **Firewall Ports:**
       - Port 22 (SSH) - open
       - Port 80 (HTTP) - open
       - Port 443 (HTTPS) - open
  </action>
  <how-to-verify>
    User provides:
    - VM_HOST: [IP or hostname]
    - VM_USER: [SSH username]
    - DOMAIN: [domain name]
    - EMAIL: [admin email]
  </how-to-verify>
  <resume-signal>Provide the information above, or type "skip" if VM not yet provisioned</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Collect External Service Credentials</name>
  <action>
    User must provide credentials for external services:

    1. **Stack Auth (Required):**
       - STACK_AUTH_PROJECT_ID
       - STACK_AUTH_PUBLISHABLE_KEY
       - STACK_AUTH_SECRET_KEY
       Get from: https://app.stack-auth.com -> Your Project -> Settings

    2. **Stripe (Required for billing):**
       - STRIPE_SECRET_KEY (sk_live_... or sk_test_...)
       Get from: https://dashboard.stripe.com/apikeys
       Note: Webhook secret will be generated during deployment

    3. **Resend (Required for email):**
       - RESEND_API_KEY (re_...)
       - EMAIL_FROM_ADDRESS (must be verified domain)
       Get from: https://resend.com/api-keys

    4. **TTN (Optional - for IoT devices):**
       - TTN_APPLICATION_ID
       - TTN_API_KEY
       Get from: https://console.cloud.thethings.network

    5. **Telnyx (Optional - for SMS):**
       - TELNYX_API_KEY
       - TELNYX_MESSAGING_PROFILE_ID
       - TELNYX_PHONE_NUMBER
       Get from: https://portal.telnyx.com
  </action>
  <how-to-verify>
    User confirms they have:
    - Stack Auth credentials ready
    - Stripe API key ready
    - Resend API key ready
    - (Optional) TTN and Telnyx credentials
  </how-to-verify>
  <resume-signal>Type "credentials ready" when you have gathered all required credentials</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Validate DNS Resolution</name>
  <files>N/A - validation only</files>
  <action>
    Once user provides domain, verify DNS is configured:

    1. Check DNS resolution:
       ```bash
       dig +short ${DOMAIN}
       ```
    2. Verify it matches the VM IP provided
    3. Check if domain is reachable (may get connection refused, but should resolve)
       ```bash
       curl -I --connect-timeout 5 http://${DOMAIN} 2>&1 || true
       ```

    If DNS not propagated yet, warn user but allow proceeding (Let's Encrypt will handle verification).
  </action>
  <verify>dig +short ${DOMAIN} returns the expected VM IP address</verify>
  <done>DNS resolution confirmed or user acknowledged propagation delay</done>
</task>

</tasks>

<verification>
- User has provided VM access details
- User has provided domain name
- User has gathered all required external service credentials
- DNS resolution verified (or acknowledged as pending)
</verification>

<success_criteria>
All prerequisite information collected:
- VM_HOST, VM_USER, DOMAIN, EMAIL documented
- Stack Auth, Stripe, Resend credentials confirmed ready
- DNS verified or user acknowledged delay
</success_criteria>

<output>
After completion, create `.planning/phases/45-production-deployment/45-01-SUMMARY.md`
</output>
