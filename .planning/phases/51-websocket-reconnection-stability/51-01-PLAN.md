---
phase: 51-websocket-reconnection-stability
plan: 01
status: complete
completed: 2026-01-30
started: 2026-01-30
---

## Goal

Eliminate Socket.io reconnection flicker caused by JWT token refresh and force WebSocket-only transport.

## Analysis

### Root Cause: `useEffect` dependency on `user`

`RealtimeProvider.tsx` has `useEffect(..., [user])`. The Stack Auth `useUser()` hook returns a new object reference whenever the user's auth state refreshes (token refresh, profile update). This causes the entire effect to re-run:
1. Cleanup runs → `disconnectSocket()` → visible disconnection
2. Effect body runs → `connectWithAuth()` → new connection with fresh token
3. UI shows connecting → connected flicker

### Fix Strategy

1. **Stabilize the useEffect dependency**: Use `useRef` to track the user object. Only disconnect/reconnect when the user *identity* changes (logged in → logged out, or different user), not when the token refreshes.
2. **Force WebSocket transport**: Set `transports: ['websocket']` on the client socket to skip the polling→websocket upgrade dance.
3. **Refresh token on reconnect**: When Socket.io auto-reconnects (e.g., after network drop), fetch a fresh token in the reconnect attempt rather than reusing a stale one.

## Wave 1: Fix RealtimeProvider + Socket Config

### Task 1.1: Stabilize useEffect dependency in RealtimeProvider
- **File:** `src/providers/RealtimeProvider.tsx`
- **Change:**
  - Replace `[user]` dependency with `[user?.id]` (stable string) so the effect only re-runs when the user identity changes
  - Use a ref to hold the current user for token refresh on reconnect
  - Add `socket.io.on('reconnect_attempt')` handler that fetches a fresh token before each reconnect attempt

### Task 1.2: Force WebSocket-only transport on client
- **File:** `src/lib/socket.ts`
- **Change:** Add `transports: ['websocket']` to socket options to skip polling→websocket upgrade

### Task 1.3: Force WebSocket-only transport on server
- **File:** `backend/src/plugins/socket.plugin.ts`
- **Change:** Change `transports: ['websocket', 'polling']` to `transports: ['websocket']`

## Wave 2: Verify

### Task 2.1: TypeScript check (frontend)
- **Command:** `pnpm exec tsc --noEmit`

### Task 2.2: TypeScript check (backend)
- **Command:** `cd backend && pnpm exec tsc --noEmit`

## Success Criteria

1. Socket.io connection persists through JWT token refresh (no disconnect/reconnect cycle)
2. Socket.io uses WebSocket transport only (no polling fallback)
3. No visible "connecting" → "connected" flicker during normal app usage
4. Socket.io still reconnects correctly after actual network disconnection
5. Both `tsc --noEmit` pass (frontend + backend)
