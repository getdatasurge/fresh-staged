---
phase: 20-backend-api-migration-core
plan: 04
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - backend/tests/trpc/e2e.test.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify tRPC endpoints work end-to-end via HTTP"
    - "Sites, areas, units, readings, alerts procedures all reachable"
    - "Authentication flows work correctly with mock JWT"
    - "Error handling returns correct tRPC error codes"
  artifacts:
    - path: "backend/tests/trpc/e2e.test.ts"
      provides: "End-to-end integration tests for all tRPC routers"
      min_lines: 150
  key_links:
    - from: "backend/tests/trpc/e2e.test.ts"
      to: "backend/src/app.ts"
      via: "Fastify app.inject()"
      pattern: "app\\.inject"
---

<objective>
Create comprehensive E2E tests verifying all tRPC domain routers work via HTTP

Purpose: Ensure full stack integration from HTTP request to database (mocked) and back
Output: Extended e2e.test.ts covering all five domain routers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-backend-api-migration-core/20-RESEARCH.md
@.planning/phases/20-backend-api-migration-core/20-02-SUMMARY.md
@.planning/phases/19-backend-api-migration-foundation/19-04-SUMMARY.md

Reference files:
@backend/tests/trpc/e2e.test.ts (existing E2E tests to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend E2E tests for sites and areas routers</name>
  <files>backend/tests/trpc/e2e.test.ts</files>
  <action>
Extend the existing e2e.test.ts file to add tests for sites and areas routers.

Add new describe blocks after the existing organizations tests:

```typescript
describe('Sites Router E2E', () => {
  const validOrgId = '123e4567-e89b-12d3-a456-426614174000';
  const validSiteId = '223e4567-e89b-12d3-a456-426614174001';

  beforeEach(() => {
    // Mock site service methods
    vi.doMock('../../src/services/site.service.js', () => ({
      listSites: vi.fn().mockResolvedValue([
        { id: validSiteId, name: 'Test Site', organizationId: validOrgId }
      ]),
      getSite: vi.fn().mockResolvedValue(
        { id: validSiteId, name: 'Test Site', organizationId: validOrgId }
      ),
      createSite: vi.fn().mockResolvedValue(
        { id: validSiteId, name: 'New Site', organizationId: validOrgId }
      ),
      updateSite: vi.fn().mockResolvedValue(
        { id: validSiteId, name: 'Updated Site', organizationId: validOrgId }
      ),
      deleteSite: vi.fn().mockResolvedValue(true),
    }));
  });

  it('should list sites via tRPC', async () => {
    const response = await app.inject({
      method: 'GET',
      url: `/trpc/sites.list?input=${encodeURIComponent(JSON.stringify({ organizationId: validOrgId }))}`,
      headers: { 'x-stack-access-token': mockToken },
    });

    expect(response.statusCode).toBe(200);
    const body = JSON.parse(response.body);
    expect(body.result.data).toBeInstanceOf(Array);
  });

  it('should get site by ID via tRPC', async () => {
    const response = await app.inject({
      method: 'GET',
      url: `/trpc/sites.get?input=${encodeURIComponent(JSON.stringify({ organizationId: validOrgId, siteId: validSiteId }))}`,
      headers: { 'x-stack-access-token': mockToken },
    });

    expect(response.statusCode).toBe(200);
    const body = JSON.parse(response.body);
    expect(body.result.data.id).toBe(validSiteId);
  });

  it('should create site via tRPC mutation', async () => {
    const response = await app.inject({
      method: 'POST',
      url: '/trpc/sites.create',
      headers: {
        'x-stack-access-token': mockToken,
        'content-type': 'application/json',
      },
      payload: JSON.stringify({
        organizationId: validOrgId,
        data: { name: 'New Site', timezone: 'America/New_York' }
      }),
    });

    expect(response.statusCode).toBe(200);
  });

  it('should return FORBIDDEN for non-admin create', async () => {
    // Mock staff role
    vi.mocked(userService.getUserRoleInOrg).mockResolvedValueOnce('staff');

    const response = await app.inject({
      method: 'POST',
      url: '/trpc/sites.create',
      headers: {
        'x-stack-access-token': mockToken,
        'content-type': 'application/json',
      },
      payload: JSON.stringify({
        organizationId: validOrgId,
        data: { name: 'New Site', timezone: 'UTC' }
      }),
    });

    expect(response.statusCode).toBe(403);
  });
});

describe('Areas Router E2E', () => {
  // Similar pattern for areas - list, get, create, update, delete
  // Test org membership validation
  // Test admin role requirement for mutations
});
```

Follow the existing mock patterns from the organizations E2E tests. Use valid UUIDs.
  </action>
  <verify>npm test --prefix backend -- --grep "Sites Router E2E|Areas Router E2E" passes</verify>
  <done>E2E tests added for sites and areas routers</done>
</task>

<task type="auto">
  <name>Task 2: Extend E2E tests for units, readings, and alerts routers</name>
  <files>backend/tests/trpc/e2e.test.ts</files>
  <action>
Continue extending e2e.test.ts with tests for remaining routers:

```typescript
describe('Units Router E2E', () => {
  const validOrgId = '123e4567-e89b-12d3-a456-426614174000';
  const validSiteId = '223e4567-e89b-12d3-a456-426614174001';
  const validAreaId = '323e4567-e89b-12d3-a456-426614174002';
  const validUnitId = '423e4567-e89b-12d3-a456-426614174003';

  beforeEach(() => {
    // Mock unit service
    vi.doMock('../../src/services/unit.service.js', () => ({
      listUnits: vi.fn().mockResolvedValue([/* mock data */]),
      getUnit: vi.fn().mockResolvedValue({ id: validUnitId, name: 'Test Unit' }),
      createUnit: vi.fn().mockResolvedValue({ id: validUnitId, name: 'New Unit' }),
      updateUnit: vi.fn().mockResolvedValue({ id: validUnitId, name: 'Updated Unit' }),
      deleteUnit: vi.fn().mockResolvedValue(true),
    }));
  });

  it('should list units for area', async () => {
    const input = { organizationId: validOrgId, siteId: validSiteId, areaId: validAreaId };
    const response = await app.inject({
      method: 'GET',
      url: `/trpc/units.list?input=${encodeURIComponent(JSON.stringify(input))}`,
      headers: { 'x-stack-access-token': mockToken },
    });
    expect(response.statusCode).toBe(200);
  });

  it('should require manager role for create', async () => {
    vi.mocked(userService.getUserRoleInOrg).mockResolvedValueOnce('staff');
    // Test that staff cannot create units (manager required)
  });
});

describe('Readings Router E2E', () => {
  it('should query readings with pagination', async () => {
    // Mock readingsService.queryReadings
    // Test list endpoint with page/limit
  });

  it('should get latest reading', async () => {
    // Test latest endpoint
  });

  it('should return NOT_FOUND for invalid unit', async () => {
    // Mock service to throw "Unit not found or access denied"
  });
});

describe('Alerts Router E2E', () => {
  const validAlertId = '523e4567-e89b-12d3-a456-426614174004';

  it('should list alerts with filters', async () => {
    // Mock alertService.listAlerts
    // Test status filter
  });

  it('should acknowledge alert', async () => {
    // Mock acknowledgeAlert
    // Verify staff can acknowledge
  });

  it('should return CONFLICT for already acknowledged', async () => {
    // Mock acknowledgeAlert to return 'already_acknowledged'
  });

  it('should resolve alert with resolution text', async () => {
    // Mock resolveAlert
    // Verify required resolution field
  });

  it('should require staff role for acknowledge/resolve', async () => {
    // Test with viewer role (or no role)
  });
});
```

Ensure all tests:
1. Use app.inject() pattern from existing tests
2. Include proper headers (x-stack-access-token)
3. Use valid UUID formats
4. Mock appropriate services
5. Test both success and error cases
  </action>
  <verify>npm test --prefix backend -- --grep "Units Router E2E|Readings Router E2E|Alerts Router E2E" passes</verify>
  <done>E2E tests added for units, readings, and alerts routers</done>
</task>

<task type="auto">
  <name>Task 3: Run full E2E test suite and verify all domains</name>
  <files>backend/tests/trpc/e2e.test.ts</files>
  <action>
Run the complete E2E test suite and ensure all tests pass:

1. Run all tRPC E2E tests:
   ```bash
   cd backend && npm test -- --grep "E2E" --run
   ```

2. Verify test count covers all routers:
   - Organizations: ~10 tests (existing)
   - Sites: ~5 tests
   - Areas: ~5 tests
   - Units: ~5 tests
   - Readings: ~3 tests
   - Alerts: ~5 tests
   Total: 30+ E2E tests

3. Check for any flaky tests or timing issues

4. Ensure mocks are properly reset between describe blocks using beforeEach/afterEach

5. Add a summary describe block at the end:
   ```typescript
   describe('tRPC Router Summary', () => {
     it('should have all domain routers registered', async () => {
       // Verify each router responds (basic smoke test)
       const routers = ['organizations', 'sites', 'areas', 'units', 'readings', 'alerts'];
       for (const router of routers) {
         const response = await app.inject({
           method: 'GET',
           url: `/trpc/${router}.list?input=${encodeURIComponent(JSON.stringify({ organizationId: validOrgId }))}`,
           headers: { 'x-stack-access-token': mockToken },
         });
         // Should not be 404 (router not found)
         expect(response.statusCode).not.toBe(404);
       }
     });
   });
   ```

Fix any failing tests before marking complete.
  </action>
  <verify>npm test --prefix backend -- --run passes all tests (including new E2E tests)</verify>
  <done>All E2E tests pass, 30+ tests covering all domain routers</done>
</task>

</tasks>

<verification>
1. E2E tests run: npm test --prefix backend -- --grep "E2E" --run
2. All tests pass: Exit code 0, no failures
3. Coverage: Each router has at least 3 E2E tests
4. Error cases: FORBIDDEN, NOT_FOUND, CONFLICT all tested
5. Full backend tests: npm test --prefix backend -- --run (all 730+ tests pass)
</verification>

<success_criteria>
- E2E test file extended with tests for all 5 new domain routers
- Total 30+ E2E tests covering success and error cases
- All tests pass consistently
- No flaky tests or race conditions
- Error codes verified (403 FORBIDDEN, 404 NOT_FOUND, 409 CONFLICT)
- Full backend test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-backend-api-migration-core/20-04-SUMMARY.md`
</output>
