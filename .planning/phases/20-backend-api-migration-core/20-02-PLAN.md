---
phase: 20-backend-api-migration-core
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - backend/src/routers/units.router.ts
  - backend/src/routers/readings.router.ts
  - backend/src/routers/alerts.router.ts
  - backend/src/trpc/router.ts
  - backend/tests/trpc/units.router.test.ts
  - backend/tests/trpc/readings.router.test.ts
  - backend/tests/trpc/alerts.router.test.ts
autonomous: true

must_haves:
  truths:
    - "Units can be listed, retrieved, created, updated, and deleted via tRPC"
    - "Readings can be queried via tRPC with pagination and date filters"
    - "Alerts can be listed, retrieved, acknowledged, and resolved via tRPC"
    - "Manager role is required for unit create/update/delete operations"
    - "Staff role is required for alert acknowledge/resolve operations"
  artifacts:
    - path: "backend/src/routers/units.router.ts"
      provides: "tRPC units router with CRUD procedures"
      exports: ["unitsRouter"]
    - path: "backend/src/routers/readings.router.ts"
      provides: "tRPC readings router with query procedures"
      exports: ["readingsRouter"]
    - path: "backend/src/routers/alerts.router.ts"
      provides: "tRPC alerts router with CRUD and workflow procedures"
      exports: ["alertsRouter"]
  key_links:
    - from: "backend/src/routers/units.router.ts"
      to: "backend/src/services/unit.service.js"
      via: "service method calls"
      pattern: "unitService\\."
    - from: "backend/src/routers/readings.router.ts"
      to: "backend/src/services/readings.service.js"
      via: "service method calls"
      pattern: "readingsService\\."
    - from: "backend/src/routers/alerts.router.ts"
      to: "backend/src/services/alert.service.js"
      via: "service method calls"
      pattern: "alertService\\."
---

<objective>
Create tRPC routers for units, readings, and alerts domains with full procedures

Purpose: Complete backend tRPC migration for remaining core domains
Output: Three new tRPC routers registered in appRouter with comprehensive unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-backend-api-migration-core/20-RESEARCH.md
@.planning/phases/20-backend-api-migration-core/20-CONTEXT.md
@.planning/phases/20-backend-api-migration-core/20-01-SUMMARY.md

Reference files:
@backend/src/routers/organizations.router.ts (template pattern)
@backend/src/routes/units.ts (REST routes to migrate)
@backend/src/routes/readings.ts (REST routes to migrate - query only, NOT bulk ingest)
@backend/src/routes/alerts.ts (REST routes to migrate)
@backend/src/schemas/units.ts (Zod schemas)
@backend/src/schemas/readings.ts (Zod schemas)
@backend/src/schemas/alerts.ts (Zod schemas)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create units tRPC router with CRUD procedures</name>
  <files>backend/src/routers/units.router.ts</files>
  <action>
Create the units router following established patterns:

1. Import dependencies:
   - z from 'zod'
   - TRPCError from '@trpc/server'
   - router from '../trpc/index.js'
   - orgProcedure from '../trpc/procedures.js'
   - All functions from '../services/unit.service.js' as unitService
   - UnitSchema, UnitsListSchema, CreateUnitSchema, UpdateUnitSchema from '../schemas/units.js'

2. Define input schemas (note: units are nested under areas, but tRPC uses flat input):
   - AreaInput: { organizationId, areaId, siteId } (all z.string().uuid())
   - UnitInput: { organizationId, unitId, areaId, siteId } (all z.string().uuid())
   - CreateUnitInput: { organizationId, areaId, siteId, data: CreateUnitSchema }
   - UpdateUnitInput: { organizationId, unitId, areaId, siteId, data: UpdateUnitSchema }

3. Create unitsRouter with these procedures:
   - list: orgProcedure.input(AreaInput).output(UnitsListSchema).query()
     - Call unitService.listUnits(input.areaId, input.siteId, ctx.user.organizationId)
     - If result === null, throw TRPCError NOT_FOUND 'Area not found'
   - get: orgProcedure.input(UnitInput).output(UnitSchema).query()
     - Call unitService.getUnit(input.unitId, input.areaId, input.siteId, ctx.user.organizationId)
     - Throw NOT_FOUND if null
   - create: orgProcedure.input(CreateUnitInput).output(UnitSchema).mutation()
     - Check role: if (!['manager', 'admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call unitService.createUnit(input.areaId, input.siteId, ctx.user.organizationId, input.data)
     - Throw NOT_FOUND if null (area not found)
   - update: orgProcedure.input(UpdateUnitInput).output(UnitSchema).mutation()
     - Check role: if (!['manager', 'admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call unitService.updateUnit(input.unitId, input.areaId, input.siteId, ctx.user.organizationId, input.data)
     - Throw NOT_FOUND if null
   - delete: orgProcedure.input(UnitInput).output(z.void()).mutation()
     - Check role: if (!['manager', 'admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call unitService.deleteUnit(input.unitId, input.areaId, input.siteId, ctx.user.organizationId)
     - Throw NOT_FOUND if null

Export unitsRouter.
  </action>
  <verify>TypeScript compiles: cd backend && npx tsc --noEmit</verify>
  <done>units.router.ts exists with 5 procedures matching REST route functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create readings and alerts tRPC routers</name>
  <files>backend/src/routers/readings.router.ts, backend/src/routers/alerts.router.ts, backend/src/trpc/router.ts</files>
  <action>
**readings.router.ts:**

1. Import dependencies:
   - z from 'zod'
   - TRPCError from '@trpc/server'
   - router from '../trpc/index.js'
   - orgProcedure from '../trpc/procedures.js'
   - queryReadings from '../services/readings.service.js' (as readingsService)
   - ReadingResponseSchema from '../schemas/readings.js'

2. Define input schemas:
   - ReadingsListInput: { organizationId, unitId (uuid), page (optional int min 1), limit (optional int 1-1000), start (optional datetime string), end (optional datetime string) }
   - ReadingLatestInput: { organizationId, unitId }

3. Create readingsRouter with procedures:
   - list: orgProcedure.input(ReadingsListInput).output(z.array(ReadingResponseSchema)).query()
     - Call readingsService.queryReadings({ unitId: input.unitId, organizationId: ctx.user.organizationId, page: input.page, limit: input.limit, start: input.start, end: input.end })
     - Catch errors with 'Unit not found or access denied' and throw NOT_FOUND
   - latest: orgProcedure.input(ReadingLatestInput).output(ReadingResponseSchema.nullable()).query()
     - Call readingsService.queryReadings with limit: 1
     - Return readings[0] || null
     - Catch same error for NOT_FOUND

NOTE: Bulk ingestion endpoint (POST /api/ingest/readings) stays as REST - it uses API key auth.

**alerts.router.ts:**

1. Import dependencies:
   - z from 'zod'
   - TRPCError from '@trpc/server'
   - router from '../trpc/index.js'
   - orgProcedure from '../trpc/procedures.js'
   - All functions from '../services/alert.service.js' as alertService
   - AlertSchema, AlertsListSchema from '../schemas/alerts.js'

2. Define input schemas:
   - OrgInput: { organizationId }
   - AlertInput: { organizationId, alertId }
   - AlertListInput: { organizationId, status (optional enum pending/acknowledged/resolved), unitId (optional), siteId (optional), page (optional), limit (optional 1-100) }
   - AlertAcknowledgeInput: { organizationId, alertId, notes (optional string) }
   - AlertResolveInput: { organizationId, alertId, resolution (string), correctiveAction (optional string) }

3. Create alertsRouter with procedures:
   - list: orgProcedure.input(AlertListInput).output(AlertsListSchema).query()
     - Extract filters from input, call alertService.listAlerts(ctx.user.organizationId, filters)
   - get: orgProcedure.input(AlertInput).output(AlertSchema).query()
     - Call alertService.getAlert(input.alertId, ctx.user.organizationId)
     - Throw NOT_FOUND if null
   - acknowledge: orgProcedure.input(AlertAcknowledgeInput).output(AlertSchema).mutation()
     - Check role: if (!['staff', 'manager', 'admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call alertService.acknowledgeAlert(input.alertId, ctx.user.organizationId, ctx.user.profileId, input.notes)
     - If null, throw NOT_FOUND
     - If 'already_acknowledged', throw CONFLICT
   - resolve: orgProcedure.input(AlertResolveInput).output(AlertSchema).mutation()
     - Check role: if (!['staff', 'manager', 'admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call alertService.resolveAlert(input.alertId, ctx.user.organizationId, ctx.user.profileId, input.resolution, input.correctiveAction)
     - Throw NOT_FOUND if null

4. Update backend/src/trpc/router.ts:
   - Import unitsRouter, readingsRouter, alertsRouter
   - Add to appRouter: units: unitsRouter, readings: readingsRouter, alerts: alertsRouter
  </action>
  <verify>TypeScript compiles: cd backend && npx tsc --noEmit</verify>
  <done>readings.router.ts with 2 procedures, alerts.router.ts with 4 procedures, all registered in appRouter</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for units, readings, and alerts routers</name>
  <files>backend/tests/trpc/units.router.test.ts, backend/tests/trpc/readings.router.test.ts, backend/tests/trpc/alerts.router.test.ts</files>
  <action>
Create comprehensive unit tests following established patterns:

**units.router.test.ts:**
Mock unitService functions. Test cases:
- list units for area (verify service called with correct params)
- throw NOT_FOUND when area not found (listUnits returns null)
- get unit by ID
- throw NOT_FOUND when unit not found
- create unit when manager role
- throw FORBIDDEN when staff tries to create
- update unit when manager role
- throw FORBIDDEN when staff tries to update
- delete unit when manager role
- throw FORBIDDEN when staff tries to delete

**readings.router.test.ts:**
Mock readingsService.queryReadings. Test cases:
- list readings for unit with pagination
- list readings with date range filters
- throw NOT_FOUND when unit not found
- get latest reading for unit
- return null when no readings exist

**alerts.router.test.ts:**
Mock alertService functions. Test cases:
- list alerts for organization
- list alerts with status filter
- list alerts with unitId filter
- get alert by ID
- throw NOT_FOUND when alert not found
- acknowledge alert when staff role
- throw FORBIDDEN when viewer tries to acknowledge
- throw CONFLICT when alert already acknowledged
- resolve alert when staff role
- throw FORBIDDEN when viewer tries to resolve
- throw NOT_FOUND when resolving non-existent alert

Use valid UUIDs in all tests. Setup default roles via getUserRoleInOrg mock in beforeEach.
  </action>
  <verify>npm test --prefix backend -- --grep "Units tRPC Router|Readings tRPC Router|Alerts tRPC Router" passes all tests</verify>
  <done>All test files exist with comprehensive coverage, all tests passing</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: cd backend && npx tsc --noEmit
2. All tests pass: npm test --prefix backend -- --run
3. Router registered: grep -q "units: unitsRouter" backend/src/trpc/router.ts
4. Router registered: grep -q "readings: readingsRouter" backend/src/trpc/router.ts
5. Router registered: grep -q "alerts: alertsRouter" backend/src/trpc/router.ts
6. Bulk ingest still REST: grep -q "POST.*ingest/readings" backend/src/routes/readings.ts
</verification>

<success_criteria>
- units.router.ts exports unitsRouter with list, get, create, update, delete procedures
- readings.router.ts exports readingsRouter with list, latest procedures (query only)
- alerts.router.ts exports alertsRouter with list, get, acknowledge, resolve procedures
- All routers registered in appRouter (total: organizations, sites, areas, units, readings, alerts)
- All unit tests pass (25+ new tests)
- Role checks match REST routes (manager for units, staff for alerts)
- Bulk ingestion remains as REST endpoint (not migrated to tRPC)
</success_criteria>

<output>
After completion, create `.planning/phases/20-backend-api-migration-core/20-02-SUMMARY.md`
</output>
