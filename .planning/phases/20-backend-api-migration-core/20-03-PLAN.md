---
phase: 20-backend-api-migration-core
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - src/lib/api/sites.ts
  - src/lib/api/areas.ts
  - src/lib/api/units.ts
  - src/lib/api/readings.ts
  - src/lib/api/alerts.ts
  - src/hooks/useSites.ts
  - src/hooks/useAreas.ts
  - src/hooks/useUnits.ts
  - src/hooks/useReadings.ts
  - src/hooks/useAlerts.ts
autonomous: true

must_haves:
  truths:
    - "Frontend can list, get, create, update, delete sites via tRPC hooks"
    - "Frontend can list, get, create, update, delete areas via tRPC hooks"
    - "Frontend can list, get, create, update, delete units via tRPC hooks"
    - "Frontend can query readings via tRPC hooks"
    - "Frontend can list, get, acknowledge, resolve alerts via tRPC hooks"
    - "All hooks use useTRPC() directly without wrapper functions"
  artifacts:
    - path: "src/hooks/useSites.ts"
      provides: "React Query hooks for sites domain"
      exports: ["useSites", "useSite", "useCreateSite", "useUpdateSite", "useDeleteSite"]
    - path: "src/hooks/useAreas.ts"
      provides: "React Query hooks for areas domain"
      exports: ["useAreas", "useArea", "useCreateArea", "useUpdateArea", "useDeleteArea"]
    - path: "src/hooks/useUnits.ts"
      provides: "React Query hooks for units domain"
      exports: ["useUnits", "useUnit", "useCreateUnit", "useUpdateUnit", "useDeleteUnit"]
    - path: "src/hooks/useReadings.ts"
      provides: "React Query hooks for readings domain"
      exports: ["useReadings", "useLatestReading"]
    - path: "src/hooks/useAlerts.ts"
      provides: "React Query hooks for alerts domain"
      exports: ["useAlerts", "useAlert", "useAcknowledgeAlert", "useResolveAlert"]
  key_links:
    - from: "src/hooks/useSites.ts"
      to: "src/lib/trpc.ts"
      via: "useTRPC hook"
      pattern: "useTRPC\\(\\)"
    - from: "src/hooks/useAlerts.ts"
      to: "src/lib/trpc.ts"
      via: "useTRPC hook"
      pattern: "useTRPC\\(\\)"
---

<objective>
Create React Query hooks for all migrated domains using tRPC

Purpose: Enable frontend components to use type-safe tRPC calls for all CRUD operations
Output: Ten hook files (new or updated) providing complete domain access via tRPC
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-backend-api-migration-core/20-RESEARCH.md
@.planning/phases/20-backend-api-migration-core/20-CONTEXT.md
@.planning/phases/20-backend-api-migration-core/20-02-SUMMARY.md
@.planning/phases/19-backend-api-migration-foundation/19-04-SUMMARY.md

Reference files:
@src/hooks/useOrganization.ts (pattern to follow)
@src/lib/api/organizations.ts (deprecated pattern reference)
@src/lib/trpc.ts (tRPC client setup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sites and areas hooks using tRPC</name>
  <files>src/hooks/useSites.ts, src/hooks/useAreas.ts, src/lib/api/sites.ts, src/lib/api/areas.ts</files>
  <action>
**src/hooks/useSites.ts** - Create new file following useOrganization.ts pattern:

```typescript
/**
 * Sites Domain Hooks
 *
 * tRPC-based hooks for site management operations.
 * Uses direct useTRPC() hooks per Phase 19 patterns.
 */

import { useTRPC } from '@/lib/trpc';
import { useQueryClient } from '@tanstack/react-query';

// Query hooks
export function useSites(organizationId: string | undefined, options?: { enabled?: boolean }) {
  const trpc = useTRPC();
  return trpc.sites.list.useQuery(
    { organizationId: organizationId! },
    {
      enabled: !!organizationId && (options?.enabled !== false),
      staleTime: 60_000, // 1 minute
    }
  );
}

export function useSite(organizationId: string | undefined, siteId: string | undefined, options?: { enabled?: boolean }) {
  const trpc = useTRPC();
  return trpc.sites.get.useQuery(
    { organizationId: organizationId!, siteId: siteId! },
    {
      enabled: !!organizationId && !!siteId && (options?.enabled !== false),
      staleTime: 60_000,
    }
  );
}

// Mutation hooks
export function useCreateSite() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();

  return trpc.sites.create.useMutation({
    onSuccess: (_data, variables) => {
      // Invalidate sites list for this org
      queryClient.invalidateQueries({
        queryKey: [['sites', 'list'], { input: { organizationId: variables.organizationId } }]
      });
    },
  });
}

export function useUpdateSite() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();

  return trpc.sites.update.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({
        queryKey: [['sites', 'list'], { input: { organizationId: variables.organizationId } }]
      });
      queryClient.invalidateQueries({
        queryKey: [['sites', 'get'], { input: { organizationId: variables.organizationId, siteId: variables.siteId } }]
      });
    },
  });
}

export function useDeleteSite() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();

  return trpc.sites.delete.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({
        queryKey: [['sites', 'list'], { input: { organizationId: variables.organizationId } }]
      });
    },
  });
}
```

**src/hooks/useAreas.ts** - Create new file with same pattern:

```typescript
/**
 * Areas Domain Hooks
 */

import { useTRPC } from '@/lib/trpc';
import { useQueryClient } from '@tanstack/react-query';

export function useAreas(organizationId: string | undefined, siteId: string | undefined, options?: { enabled?: boolean }) {
  const trpc = useTRPC();
  return trpc.areas.list.useQuery(
    { organizationId: organizationId!, siteId: siteId! },
    {
      enabled: !!organizationId && !!siteId && (options?.enabled !== false),
      staleTime: 60_000,
    }
  );
}

export function useArea(organizationId: string | undefined, siteId: string | undefined, areaId: string | undefined, options?: { enabled?: boolean }) {
  const trpc = useTRPC();
  return trpc.areas.get.useQuery(
    { organizationId: organizationId!, siteId: siteId!, areaId: areaId! },
    { enabled: !!organizationId && !!siteId && !!areaId && (options?.enabled !== false) }
  );
}

export function useCreateArea() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.areas.create.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({
        queryKey: [['areas', 'list'], { input: { organizationId: variables.organizationId, siteId: variables.siteId } }]
      });
    },
  });
}

export function useUpdateArea() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.areas.update.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: [['areas']] });
    },
  });
}

export function useDeleteArea() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.areas.delete.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: [['areas']] });
    },
  });
}
```

**Update src/lib/api/sites.ts and src/lib/api/areas.ts:**
Add @deprecated JSDoc comments to all functions indicating migration to tRPC hooks:
```typescript
/**
 * @deprecated Use useSites() hook from '@/hooks/useSites' instead
 */
```
  </action>
  <verify>npm run build in root (or cd to frontend if separate) compiles without errors</verify>
  <done>useSites.ts and useAreas.ts created with all hooks, API wrappers marked deprecated</done>
</task>

<task type="auto">
  <name>Task 2: Create units and readings hooks using tRPC</name>
  <files>src/hooks/useUnits.ts, src/hooks/useReadings.ts, src/lib/api/units.ts, src/lib/api/readings.ts</files>
  <action>
**src/hooks/useUnits.ts** - Create new file:

```typescript
/**
 * Units Domain Hooks
 */

import { useTRPC } from '@/lib/trpc';
import { useQueryClient } from '@tanstack/react-query';

export function useUnits(
  organizationId: string | undefined,
  siteId: string | undefined,
  areaId: string | undefined,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.units.list.useQuery(
    { organizationId: organizationId!, siteId: siteId!, areaId: areaId! },
    {
      enabled: !!organizationId && !!siteId && !!areaId && (options?.enabled !== false),
      staleTime: 60_000,
    }
  );
}

export function useUnit(
  organizationId: string | undefined,
  siteId: string | undefined,
  areaId: string | undefined,
  unitId: string | undefined,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.units.get.useQuery(
    { organizationId: organizationId!, siteId: siteId!, areaId: areaId!, unitId: unitId! },
    { enabled: !!organizationId && !!siteId && !!areaId && !!unitId && (options?.enabled !== false) }
  );
}

export function useCreateUnit() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.units.create.useMutation({
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [['units']] });
    },
  });
}

export function useUpdateUnit() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.units.update.useMutation({
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [['units']] });
    },
  });
}

export function useDeleteUnit() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();
  return trpc.units.delete.useMutation({
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [['units']] });
    },
  });
}
```

**src/hooks/useReadings.ts** - Create new file (or update if exists):

```typescript
/**
 * Readings Domain Hooks
 *
 * Query-only hooks for temperature/sensor readings.
 * Bulk ingestion uses REST API with API key auth.
 */

import { useTRPC } from '@/lib/trpc';

interface ReadingsQueryOptions {
  page?: number;
  limit?: number;
  start?: string;
  end?: string;
}

export function useReadings(
  organizationId: string | undefined,
  unitId: string | undefined,
  queryOptions?: ReadingsQueryOptions,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.readings.list.useQuery(
    {
      organizationId: organizationId!,
      unitId: unitId!,
      page: queryOptions?.page,
      limit: queryOptions?.limit,
      start: queryOptions?.start,
      end: queryOptions?.end,
    },
    {
      enabled: !!organizationId && !!unitId && (options?.enabled !== false),
      staleTime: 30_000, // 30 seconds - readings update frequently
    }
  );
}

export function useLatestReading(
  organizationId: string | undefined,
  unitId: string | undefined,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.readings.latest.useQuery(
    { organizationId: organizationId!, unitId: unitId! },
    {
      enabled: !!organizationId && !!unitId && (options?.enabled !== false),
      staleTime: 10_000, // 10 seconds - latest readings are time-sensitive
      refetchInterval: 30_000, // Auto-refresh every 30s
    }
  );
}
```

**Update src/lib/api/units.ts and src/lib/api/readings.ts:**
Add @deprecated JSDoc comments to all functions.
  </action>
  <verify>npm run build compiles without errors, TypeScript types resolve correctly</verify>
  <done>useUnits.ts and useReadings.ts created with all hooks, API wrappers marked deprecated</done>
</task>

<task type="auto">
  <name>Task 3: Create alerts hooks using tRPC</name>
  <files>src/hooks/useAlerts.ts, src/lib/api/alerts.ts</files>
  <action>
**src/hooks/useAlerts.ts** - Update or create file:

If file exists (useUnitAlerts.ts or similar), rename/refactor. Otherwise create:

```typescript
/**
 * Alerts Domain Hooks
 *
 * tRPC-based hooks for alert management and workflow operations.
 */

import { useTRPC } from '@/lib/trpc';
import { useQueryClient } from '@tanstack/react-query';

interface AlertsQueryOptions {
  status?: 'pending' | 'acknowledged' | 'resolved';
  unitId?: string;
  siteId?: string;
  page?: number;
  limit?: number;
}

export function useAlerts(
  organizationId: string | undefined,
  queryOptions?: AlertsQueryOptions,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.alerts.list.useQuery(
    {
      organizationId: organizationId!,
      status: queryOptions?.status,
      unitId: queryOptions?.unitId,
      siteId: queryOptions?.siteId,
      page: queryOptions?.page,
      limit: queryOptions?.limit,
    },
    {
      enabled: !!organizationId && (options?.enabled !== false),
      staleTime: 30_000, // 30 seconds
      refetchOnWindowFocus: true, // Alerts are time-sensitive
    }
  );
}

export function useAlert(
  organizationId: string | undefined,
  alertId: string | undefined,
  options?: { enabled?: boolean }
) {
  const trpc = useTRPC();
  return trpc.alerts.get.useQuery(
    { organizationId: organizationId!, alertId: alertId! },
    { enabled: !!organizationId && !!alertId && (options?.enabled !== false) }
  );
}

export function useAcknowledgeAlert() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();

  return trpc.alerts.acknowledge.useMutation({
    onSuccess: (_data, variables) => {
      // Invalidate all alerts queries to ensure lists update
      queryClient.invalidateQueries({ queryKey: [['alerts']] });
    },
  });
}

export function useResolveAlert() {
  const trpc = useTRPC();
  const queryClient = useQueryClient();

  return trpc.alerts.resolve.useMutation({
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: [['alerts']] });
    },
  });
}

// Convenience hook for unit-specific alerts (common use case)
export function useUnitAlerts(
  organizationId: string | undefined,
  unitId: string | undefined,
  queryOptions?: Omit<AlertsQueryOptions, 'unitId'>,
  options?: { enabled?: boolean }
) {
  return useAlerts(organizationId, { ...queryOptions, unitId }, options);
}
```

**Update src/lib/api/alerts.ts:**
Add @deprecated JSDoc comments to all functions:
```typescript
/**
 * @deprecated Use useAlerts() hook from '@/hooks/useAlerts' instead
 */
```

Verify the hooks work by checking TypeScript compilation. The tRPC types should flow from AppRouter.
  </action>
  <verify>npm run build compiles without errors, all hook exports resolve correctly</verify>
  <done>useAlerts.ts created with all hooks including useUnitAlerts convenience function, API wrapper marked deprecated</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: npm run build (or npm run typecheck if available)
2. All hooks export correctly: Check each hook file exports expected functions
3. tRPC types flow: Verify hooks have proper type inference from AppRouter
4. API wrappers deprecated: grep -r "@deprecated" src/lib/api/ shows all functions
5. No direct REST calls in hooks: grep -v "createAuthenticatedClient" src/hooks/use*.ts
</verification>

<success_criteria>
- 5 new hook files created: useSites.ts, useAreas.ts, useUnits.ts, useReadings.ts, useAlerts.ts
- Each hook file uses useTRPC() directly (no wrapper functions)
- Query hooks have appropriate staleTime and enabled options
- Mutation hooks invalidate related queries on success
- All src/lib/api/*.ts files for these domains marked @deprecated
- TypeScript compiles without errors
- Type inference works (hover over hook shows correct types from AppRouter)
</success_criteria>

<output>
After completion, create `.planning/phases/20-backend-api-migration-core/20-03-SUMMARY.md`
</output>
