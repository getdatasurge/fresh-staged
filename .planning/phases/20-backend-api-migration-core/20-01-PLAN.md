---
phase: 20-backend-api-migration-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/sites.router.ts
  - backend/src/routers/areas.router.ts
  - backend/src/trpc/router.ts
  - backend/tests/trpc/sites.router.test.ts
  - backend/tests/trpc/areas.router.test.ts
autonomous: true

must_haves:
  truths:
    - 'Sites can be listed, retrieved, created, updated, and deleted via tRPC'
    - 'Areas can be listed, retrieved, created, updated, and deleted via tRPC'
    - 'Admin role is required for site/area create, update, delete operations'
    - 'Non-admin users can only list and get sites/areas'
  artifacts:
    - path: 'backend/src/routers/sites.router.ts'
      provides: 'tRPC sites router with CRUD procedures'
      exports: ['sitesRouter']
    - path: 'backend/src/routers/areas.router.ts'
      provides: 'tRPC areas router with CRUD procedures'
      exports: ['areasRouter']
    - path: 'backend/tests/trpc/sites.router.test.ts'
      provides: 'Unit tests for sites router'
      min_lines: 80
    - path: 'backend/tests/trpc/areas.router.test.ts'
      provides: 'Unit tests for areas router'
      min_lines: 80
  key_links:
    - from: 'backend/src/routers/sites.router.ts'
      to: 'backend/src/services/site.service.js'
      via: 'service method calls'
      pattern: "siteService\\."
    - from: 'backend/src/routers/areas.router.ts'
      to: 'backend/src/services/area.service.js'
      via: 'service method calls'
      pattern: "areaService\\."
    - from: 'backend/src/trpc/router.ts'
      to: 'backend/src/routers/sites.router.ts'
      via: 'router import and mount'
      pattern: 'sites: sitesRouter'
---

<objective>
Create tRPC routers for sites and areas domains with full CRUD procedures

Purpose: Enable type-safe API calls for site and area management, replacing REST endpoints
Output: Two new tRPC routers (sites, areas) registered in appRouter with comprehensive unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-backend-api-migration-core/20-RESEARCH.md
@.planning/phases/20-backend-api-migration-core/20-CONTEXT.md
@.planning/phases/19-backend-api-migration-foundation/19-02-SUMMARY.md

Reference files:
@backend/src/routers/organizations.router.ts (template pattern)
@backend/src/routes/sites.ts (REST routes to migrate)
@backend/src/routes/areas.ts (REST routes to migrate)
@backend/src/schemas/sites.ts (Zod schemas to reuse)
@backend/src/schemas/areas.ts (Zod schemas to reuse)
@backend/tests/trpc/organizations.router.test.ts (test pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sites tRPC router with CRUD procedures</name>
  <files>backend/src/routers/sites.router.ts</files>
  <action>
Create the sites router following the organizations.router.ts pattern exactly:

1. Import dependencies:
   - z from 'zod'
   - TRPCError from '@trpc/server'
   - router from '../trpc/index.js'
   - orgProcedure from '../trpc/procedures.js'
   - All functions from '../services/site.service.js' as siteService
   - SiteSchema, SitesListSchema, CreateSiteSchema, UpdateSiteSchema from '../schemas/sites.js'

2. Define input schemas (all must include organizationId for orgProcedure):
   - OrgInput: { organizationId: z.string().uuid() }
   - SiteInput: { organizationId: z.string().uuid(), siteId: z.string().uuid() }
   - CreateSiteInput: { organizationId: z.string().uuid(), data: CreateSiteSchema }
   - UpdateSiteInput: { organizationId: z.string().uuid(), siteId: z.string().uuid(), data: UpdateSiteSchema }

3. Create sitesRouter with these procedures:
   - list: orgProcedure.input(OrgInput).output(SitesListSchema).query()
     - Call siteService.listSites(ctx.user.organizationId)
   - get: orgProcedure.input(SiteInput).output(SiteSchema).query()
     - Call siteService.getSite(input.siteId, ctx.user.organizationId)
     - Throw TRPCError NOT_FOUND if null
   - create: orgProcedure.input(CreateSiteInput).output(SiteSchema).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call siteService.createSite(ctx.user.organizationId, input.data)
   - update: orgProcedure.input(UpdateSiteInput).output(SiteSchema).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call siteService.updateSite(input.siteId, ctx.user.organizationId, input.data)
     - Throw TRPCError NOT_FOUND if null
   - delete: orgProcedure.input(SiteInput).output(z.void()).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call siteService.deleteSite(input.siteId, ctx.user.organizationId)
     - Throw TRPCError NOT_FOUND if null

Export sitesRouter.
</action>
<verify>TypeScript compiles without errors: cd backend && npx tsc --noEmit</verify>
<done>sites.router.ts exists with 5 procedures matching REST route functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create areas tRPC router with CRUD procedures</name>
  <files>backend/src/routers/areas.router.ts, backend/src/trpc/router.ts</files>
  <action>
Create the areas router following the same pattern:

1. Import dependencies:
   - z from 'zod'
   - TRPCError from '@trpc/server'
   - router from '../trpc/index.js'
   - orgProcedure from '../trpc/procedures.js'
   - All functions from '../services/area.service.js' as areaService
   - AreaSchema, AreasListSchema, CreateAreaSchema, UpdateAreaSchema from '../schemas/areas.js'

2. Define input schemas:
   - SiteInput: { organizationId: z.string().uuid(), siteId: z.string().uuid() }
   - AreaInput: { organizationId: z.string().uuid(), siteId: z.string().uuid(), areaId: z.string().uuid() }
   - CreateAreaInput: { organizationId: z.string().uuid(), siteId: z.string().uuid(), data: CreateAreaSchema }
   - UpdateAreaInput: { organizationId: z.string().uuid(), siteId: z.string().uuid(), areaId: z.string().uuid(), data: UpdateAreaSchema }

3. Create areasRouter with these procedures:
   - list: orgProcedure.input(SiteInput).output(AreasListSchema).query()
     - Call areaService.listAreas(input.siteId, ctx.user.organizationId)
   - get: orgProcedure.input(AreaInput).output(AreaSchema).query()
     - Call areaService.getArea(input.areaId, input.siteId, ctx.user.organizationId)
     - Throw TRPCError NOT_FOUND if null
   - create: orgProcedure.input(CreateAreaInput).output(AreaSchema).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call areaService.createArea(input.siteId, ctx.user.organizationId, input.data)
     - Throw TRPCError NOT_FOUND if null (site not found)
   - update: orgProcedure.input(UpdateAreaInput).output(AreaSchema).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call areaService.updateArea(input.areaId, input.siteId, ctx.user.organizationId, input.data)
     - Throw TRPCError NOT_FOUND if null
   - delete: orgProcedure.input(AreaInput).output(z.void()).mutation()
     - Check role: if (!['admin', 'owner'].includes(ctx.user.role)) throw FORBIDDEN
     - Call areaService.deleteArea(input.areaId, input.siteId, ctx.user.organizationId)
     - Throw TRPCError NOT_FOUND if null

Export areasRouter.

4. Update backend/src/trpc/router.ts:
   - Import sitesRouter from '../routers/sites.router.js'
   - Import areasRouter from '../routers/areas.router.js'
   - Add to appRouter: sites: sitesRouter, areas: areasRouter
     </action>
     <verify>TypeScript compiles: cd backend && npx tsc --noEmit</verify>
     <done>areas.router.ts exists with 5 procedures, both routers registered in appRouter</done>
     </task>

<task type="auto">
  <name>Task 3: Add unit tests for sites and areas routers</name>
  <files>backend/tests/trpc/sites.router.test.ts, backend/tests/trpc/areas.router.test.ts</files>
  <action>
Create comprehensive unit tests following the organizations.router.test.ts pattern:

**sites.router.test.ts:**

1. Mock services at top level:
   - vi.mock('../../src/services/user.service.js', () => ({ getUserRoleInOrg: vi.fn(), getOrCreateProfile: vi.fn() }))
   - vi.mock('../../src/services/site.service.js', () => ({ listSites: vi.fn(), getSite: vi.fn(), createSite: vi.fn(), updateSite: vi.fn(), deleteSite: vi.fn() }))

2. Setup createCallerFactory with sitesRouter

3. Create test context helper with valid UUIDs (use format like '123e4567-e89b-12d3-a456-426614174000')

4. Test cases (minimum):
   - 'should list sites for organization' - verify service called with correct orgId
   - 'should get site by ID' - verify service called with correct siteId and orgId
   - 'should throw NOT_FOUND when site not found'
   - 'should create site when admin' - mock admin role, verify service called
   - 'should throw FORBIDDEN when non-admin tries to create'
   - 'should update site when admin'
   - 'should throw FORBIDDEN when non-admin tries to update'
   - 'should delete site when admin'
   - 'should throw FORBIDDEN when non-admin tries to delete'

**areas.router.test.ts:**
Same pattern with areaService mocks and test cases for:

- list, get, create, update, delete operations
- FORBIDDEN errors for non-admin mutations
- NOT_FOUND errors for missing areas/sites

Use beforeEach to reset mocks and setup default admin role via getUserRoleInOrg mock.
</action>
<verify>npm test --prefix backend -- --grep "Sites tRPC Router|Areas tRPC Router" passes all tests</verify>
<done>Both test files exist with 9+ tests each, all passing</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: cd backend && npx tsc --noEmit
2. Tests pass: npm test --prefix backend -- --run
3. Test coverage: Both routers have tests for all CRUD operations
4. Router registered: grep -q "sites: sitesRouter" backend/src/trpc/router.ts
5. Router registered: grep -q "areas: areasRouter" backend/src/trpc/router.ts
</verification>

<success_criteria>

- sites.router.ts exports sitesRouter with list, get, create, update, delete procedures
- areas.router.ts exports areasRouter with list, get, create, update, delete procedures
- Both routers registered in appRouter
- All unit tests pass (18+ tests total)
- TypeScript compiles without errors
- Role checks match REST routes (admin for create/update/delete)
  </success_criteria>

<output>
After completion, create `.planning/phases/20-backend-api-migration-core/20-01-SUMMARY.md`
</output>
