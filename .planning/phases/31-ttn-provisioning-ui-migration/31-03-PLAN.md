---
phase: 31-ttn-provisioning-ui-migration
plan: 03
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/settings/__tests__/TTNCredentialsPanel.test.tsx
autonomous: false

must_haves:
  truths:
    - "Integration tests verify TTNCredentialsPanel renders with tRPC"
    - "Tests cover happy path for credential loading"
    - "Tests cover error handling for failed operations"
    - "Tests verify all action buttons trigger correct tRPC calls"
  artifacts:
    - path: "src/components/settings/__tests__/TTNCredentialsPanel.test.tsx"
      provides: "Component integration tests"
      min_lines: 100
  key_links:
    - from: "src/components/settings/__tests__/TTNCredentialsPanel.test.tsx"
      to: "src/components/settings/TTNCredentialsPanel.tsx"
      via: "React Testing Library render"
      pattern: "render.*TTNCredentialsPanel"
---

<objective>
Add integration tests for the migrated TTNCredentialsPanel component.

Purpose: Ensure the tRPC migration works correctly with comprehensive test coverage for happy paths, error cases, and user interactions.

Output: Test file with coverage for credential loading, provisioning actions, and error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-CONTEXT.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-01-SUMMARY.md

# Component under test
@src/components/settings/TTNCredentialsPanel.tsx

# Existing test patterns
@src/components/settings/__tests__
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TTNCredentialsPanel integration tests</name>
  <files>src/components/settings/__tests__/TTNCredentialsPanel.test.tsx</files>
  <action>
Create comprehensive integration tests for TTNCredentialsPanel. Follow existing test patterns in the codebase.

Mock setup:
- Mock useTRPC to return controlled mutation/query objects
- Mock useUser from @stackframe/react
- Mock toast from sonner

Test cases to implement:

**Rendering tests:**
1. Renders loading skeleton while fetching credentials
2. Renders credential fields when data loads successfully
3. Renders error banner when credential fetch fails
4. Renders "Not Configured" badge when no credentials exist
5. Renders "Fully Provisioned" badge when all credentials present

**Credential loading tests:**
1. Calls getCredentials.mutateAsync on mount with organizationId
2. Does not call getCredentials when organizationId is null
3. Clears credentials when organizationId changes
4. Handles getCredentials error gracefully

**Action button tests:**
1. Retry Provisioning button calls provision mutation with action='retry'
2. Start Fresh button calls startFresh mutation
3. Deep Clean button calls deepClean mutation after confirmation
4. Check Status button calls getStatus mutation
5. Buttons are disabled during loading states
6. Buttons show spinner during operations

**Error handling tests:**
1. Shows toast on provision failure
2. Shows "use Start Fresh" message when use_start_fresh=true
3. Shows inline error for failed state
4. Refreshes credentials after error

**Permission tests:**
1. Shows "View Only" badge when readOnly=true
2. Hides action buttons when readOnly=true

Example test structure:
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { TTNCredentialsPanel } from '../TTNCredentialsPanel'

// Mock tRPC
const mockGetCredentials = { mutateAsync: vi.fn(), isPending: false }
const mockProvision = { mutateAsync: vi.fn(), isPending: false }
const mockStartFresh = { mutateAsync: vi.fn(), isPending: false }
const mockDeepClean = { mutateAsync: vi.fn(), isPending: false }
const mockGetStatus = { mutateAsync: vi.fn(), isPending: false }

vi.mock('@/lib/trpc', () => ({
  useTRPC: () => ({
    ttnSettings: {
      getCredentials: { useMutation: () => mockGetCredentials },
      provision: { useMutation: () => mockProvision },
      startFresh: { useMutation: () => mockStartFresh },
      deepClean: { useMutation: () => mockDeepClean },
      getStatus: { useMutation: () => mockGetStatus },
    },
  }),
}))

// Mock useUser
vi.mock('@stackframe/react', () => ({
  useUser: () => ({ getAuthJson: vi.fn().mockResolvedValue({ accessToken: 'test-token' }) }),
}))

// Mock toast
vi.mock('sonner', () => ({
  toast: { success: vi.fn(), error: vi.fn() },
}))

describe('TTNCredentialsPanel', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('renders loading skeleton initially', () => {
    render(<TTNCredentialsPanel organizationId="test-org-id" />)
    expect(screen.getByTestId('skeleton')).toBeInTheDocument()
  })

  it('calls getCredentials on mount', async () => {
    mockGetCredentials.mutateAsync.mockResolvedValue({
      organization_name: 'Test Org',
      provisioning_status: 'ready',
      // ... other fields
    })

    render(<TTNCredentialsPanel organizationId="test-org-id" />)

    await waitFor(() => {
      expect(mockGetCredentials.mutateAsync).toHaveBeenCalledWith({
        organizationId: 'test-org-id',
      })
    })
  })

  // ... more tests
})
```
  </action>
  <verify>
Run frontend tests: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- --testPathPattern=TTNCredentialsPanel`
All tests pass.
  </verify>
  <done>
TTNCredentialsPanel.test.tsx exists with tests for rendering, loading, actions, and errors.
All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete TTN Provisioning UI migration with tRPC integration and tests</what-built>
  <how-to-verify>
1. Start the development servers:
   ```bash
   cd /home/swoop/swoop-claude-projects/fresh-staged
   # Terminal 1: Backend
   cd backend && npm run dev
   # Terminal 2: Frontend
   npm run dev
   ```

2. Open browser to http://localhost:5173

3. Navigate to Settings -> TTN Credentials (or wherever the panel is located)

4. Verify the following work correctly:
   - [ ] Credentials panel loads without errors
   - [ ] Organization name and application ID display correctly
   - [ ] Secret fields show masked values or "Missing" status
   - [ ] Check Status button refreshes the panel
   - [ ] If not provisioned: Start Provisioning button appears
   - [ ] If failed: Retry Provisioning button appears
   - [ ] Start Fresh button opens confirmation dialog
   - [ ] Deep Clean button opens confirmation dialog (if applicable)

5. Check browser console for any errors or warnings

6. Verify no network calls to Supabase edge functions (check Network tab for "/functions/v1/" calls)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
```bash
# Run frontend tests
cd /home/swoop/swoop-claude-projects/fresh-staged && npm test -- --testPathPattern=TTNCredentialsPanel

# Verify test file exists
ls -la src/components/settings/__tests__/TTNCredentialsPanel.test.tsx
```
</verification>

<success_criteria>
- [ ] TTNCredentialsPanel.test.tsx exists
- [ ] Tests cover credential loading (happy path + error)
- [ ] Tests cover all action buttons (retry, start fresh, deep clean, check status)
- [ ] Tests cover error handling and toast notifications
- [ ] Tests cover permission states (readOnly)
- [ ] All tests pass
- [ ] Human verification confirms UI works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/31-ttn-provisioning-ui-migration/31-03-SUMMARY.md`
</output>
