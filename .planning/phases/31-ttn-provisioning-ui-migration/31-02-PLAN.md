---
phase: 31-ttn-provisioning-ui-migration
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/settings/TTNCredentialsPanel.tsx
autonomous: true

must_haves:
  truths:
    - "TTNCredentialsPanel loads credentials via tRPC getCredentials"
    - "Retry Provisioning button uses tRPC provision mutation"
    - "Start Fresh button uses tRPC startFresh mutation"
    - "Deep Clean button uses tRPC deepClean mutation"
    - "Check Status button uses tRPC getStatus query"
    - "No supabase.functions.invoke calls remain in TTNCredentialsPanel"
  artifacts:
    - path: "src/components/settings/TTNCredentialsPanel.tsx"
      provides: "TTN credentials panel with tRPC integration"
      contains: "trpc.ttnSettings"
  key_links:
    - from: "src/components/settings/TTNCredentialsPanel.tsx"
      to: "backend/src/routers/ttn-settings.router.ts"
      via: "tRPC mutations and queries"
      pattern: "trpc\\.ttnSettings\\.(getCredentials|getStatus|provision|startFresh|deepClean)"
---

<objective>
Migrate TTNCredentialsPanel.tsx from Supabase edge functions to tRPC.

Purpose: Complete the frontend wiring for TTN provisioning UI, replacing all 6 edge function calls with type-safe tRPC calls.

Output: TTNCredentialsPanel.tsx using tRPC exclusively with no supabase.functions.invoke calls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-CONTEXT.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-RESEARCH.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-01-SUMMARY.md

# Source file to migrate
@src/components/settings/TTNCredentialsPanel.tsx

# Reference patterns
@src/hooks/useTTNSetupWizard.ts
@src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace fetchCredentials with tRPC getCredentials</name>
  <files>src/components/settings/TTNCredentialsPanel.tsx</files>
  <action>
Migrate the fetchCredentials function (lines ~100-155) to use tRPC:

1. Add tRPC hook import at top:
```typescript
import { useTRPC } from '@/lib/trpc'
```

2. Remove supabase import:
```typescript
// DELETE: import { supabase } from "@/lib/supabase-placeholder";
```

3. Inside component, add tRPC hooks:
```typescript
const trpc = useTRPC()
const getCredentialsMutation = trpc.ttnSettings.getCredentials.useMutation()
```

4. Rewrite fetchCredentials to use tRPC:
```typescript
const fetchCredentials = useCallback(async () => {
  if (!organizationId) {
    if (!lastOrgIdRef.current) {
      setIsLoading(false)
      setCredentials(null)
      setFetchError(null)
    }
    return
  }

  if (lastOrgIdRef.current && lastOrgIdRef.current !== organizationId) {
    setCredentials(null)
  }
  lastOrgIdRef.current = organizationId

  setIsLoading(true)
  setFetchError(null)

  try {
    if (!user) {
      setFetchError("Session expired - please sign in again")
      return
    }

    const data = await getCredentialsMutation.mutateAsync({ organizationId })

    console.log(`[TTNCredentialsPanel] Fetched credentials for org ${organizationId.slice(0, 8)}:`, {
      provisioning_status: data.provisioning_status,
      has_app_secret: !!(data.app_api_secret || data.app_api_secret_last4),
      has_webhook_secret: !!(data.webhook_secret || data.webhook_secret_last4),
      app_api_secret_status: data.app_api_secret_status,
      ttn_region: data.ttn_region,
    })

    setCredentials(data)
  } catch (err: any) {
    console.error("Failed to fetch TTN credentials:", err)
    setFetchError(err.message || "Unable to load TTN settings")
  } finally {
    setIsLoading(false)
  }
}, [organizationId, user, getCredentialsMutation])
```

Follow CONTEXT.md decisions:
- Display errors using BOTH toast and inline (toast.error + setFetchError)
- Strict data expectations - fail with meaningful error
  </action>
  <verify>
Run frontend build: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm run build`
No TypeScript errors.
  </verify>
  <done>
fetchCredentials uses tRPC getCredentials mutation.
No supabase.functions.invoke for get_credentials action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace provisioning actions with tRPC mutations</name>
  <files>src/components/settings/TTNCredentialsPanel.tsx</files>
  <action>
Migrate the remaining 5 edge function calls to tRPC mutations:

1. Add mutation hooks after getCredentialsMutation:
```typescript
const provisionMutation = trpc.ttnSettings.provision.useMutation()
const startFreshMutation = trpc.ttnSettings.startFresh.useMutation()
const deepCleanMutation = trpc.ttnSettings.deepClean.useMutation()
const getStatusMutation = trpc.ttnSettings.getStatus.useMutation()
```

2. **handleRetryProvisioning** (lines ~168-226) - Replace edge function calls:
```typescript
const handleRetryProvisioning = async () => {
  if (!organizationId) return

  setIsRetrying(true)
  try {
    if (!user) {
      toast.error("Session expired - please sign in again")
      return
    }

    const data = await provisionMutation.mutateAsync({
      organizationId,
      action: 'retry'
    })

    if (!data.success) {
      if (data.use_start_fresh) {
        toast.error("Cannot retry - use Start Fresh", {
          description: data.message || "Application is owned by different account",
        })
      } else {
        toast.error(data.error || "Provisioning failed", {
          description: data.message,
        })
      }
      await fetchCredentials()
      return
    }

    toast.success("Provisioning retry initiated")
    setTimeout(fetchCredentials, 2000)
  } catch (err: any) {
    console.error("Failed to retry provisioning:", err)
    toast.error(err.message || "Failed to retry provisioning")
  } finally {
    setIsRetrying(false)
  }
}
```

3. **handleStartFresh** (lines ~228-272) - Replace edge function call:
```typescript
const handleStartFresh = async () => {
  if (!organizationId) return

  setIsStartingFresh(true)
  try {
    if (!user) {
      toast.error("Session expired - please sign in again")
      return
    }

    const data = await startFreshMutation.mutateAsync({
      organizationId,
      region: "nam1", // NAM1 ONLY
    })

    if (!data.success) {
      toast.error(data.error || "Start Fresh failed", {
        description: data.message,
      })
      await fetchCredentials()
      return
    }

    toast.success("Start Fresh completed", {
      description: "Provisioned on NAM1 cluster successfully",
    })
    setTimeout(fetchCredentials, 2000)
  } catch (err: any) {
    console.error("Failed to start fresh:", err)
    toast.error(err.message || "Failed to start fresh")
  } finally {
    setIsStartingFresh(false)
  }
}
```

4. **handleDeepClean** (lines ~274-320) - Replace edge function call:
```typescript
const handleDeepClean = async () => {
  if (!organizationId) return

  setIsDeepCleaning(true)
  try {
    if (!user) {
      toast.error("Session expired - please sign in again")
      return
    }

    const data = await deepCleanMutation.mutateAsync({ organizationId })

    if (!data.success) {
      toast.error(data.error || "Deep clean failed", {
        description: data.message,
      })
      await fetchCredentials()
      return
    }

    toast.success("Deep clean completed", {
      description: `Deleted ${data.deleted_devices || 0} devices. ${data.deleted_org ? 'Organization deleted.' : ''} Ready to provision on NAM1.`,
    })

    setShowDeepCleanDialog(false)
    setDeepCleanConfirmChecked(false)
    setTimeout(fetchCredentials, 2000)
  } catch (err: any) {
    console.error("Failed to deep clean:", err)
    toast.error(err.message || "Failed to deep clean")
  } finally {
    setIsDeepCleaning(false)
  }
}
```

5. **handleCheckStatus** (lines ~337-359) - Replace edge function call:
```typescript
const handleCheckStatus = async () => {
  if (!organizationId) return
  setIsLoading(true)
  try {
    await getStatusMutation.mutateAsync({ organizationId })
    // Refresh full credentials after status check
    await fetchCredentials()
    toast.success("Status refreshed")
  } catch (err: any) {
    console.error("Failed to check status:", err)
    toast.error(err.message || "Failed to check status")
  } finally {
    setIsLoading(false)
  }
}
```

Follow CONTEXT.md decisions:
- Buttons show BOTH spinner icon AND changed text (already implemented in JSX)
- Display errors with toast AND inline where applicable
- Remove old edge function calls entirely (no commented code)
  </action>
  <verify>
Run frontend build: `cd /home/swoop/swoop-claude-projects/fresh-staged && npm run build`
Grep for remaining supabase calls: `grep -n "supabase.functions.invoke" src/components/settings/TTNCredentialsPanel.tsx`
Should return nothing.
  </verify>
  <done>
handleRetryProvisioning uses tRPC provision mutation.
handleStartFresh uses tRPC startFresh mutation.
handleDeepClean uses tRPC deepClean mutation.
handleCheckStatus uses tRPC getStatus mutation.
No supabase.functions.invoke calls remain in the file.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify frontend builds without errors
cd /home/swoop/swoop-claude-projects/fresh-staged && npm run build

# Verify no supabase edge function calls remain
grep -n "supabase.functions.invoke" src/components/settings/TTNCredentialsPanel.tsx
# Should return nothing

# Verify tRPC imports are present
grep -n "useTRPC\|trpc.ttnSettings" src/components/settings/TTNCredentialsPanel.tsx
# Should show multiple matches

# Verify supabase import is removed
grep -n "supabase-placeholder" src/components/settings/TTNCredentialsPanel.tsx
# Should return nothing
```
</verification>

<success_criteria>
- [ ] TTNCredentialsPanel.tsx imports useTRPC from @/lib/trpc
- [ ] fetchCredentials uses trpc.ttnSettings.getCredentials
- [ ] handleRetryProvisioning uses trpc.ttnSettings.provision
- [ ] handleStartFresh uses trpc.ttnSettings.startFresh
- [ ] handleDeepClean uses trpc.ttnSettings.deepClean
- [ ] handleCheckStatus uses trpc.ttnSettings.getStatus
- [ ] No supabase.functions.invoke calls remain
- [ ] No import from supabase-placeholder
- [ ] Frontend builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/31-ttn-provisioning-ui-migration/31-02-SUMMARY.md`
</output>
