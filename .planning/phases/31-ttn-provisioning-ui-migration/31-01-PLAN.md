---
phase: 31-ttn-provisioning-ui-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routers/ttn-settings.router.ts
  - backend/src/schemas/ttn-settings.ts
  - backend/src/services/ttn/provisioning.ts
autonomous: true

must_haves:
  truths:
    - "getCredentials procedure returns decrypted TTN credentials for organization"
    - "getStatus procedure returns current provisioning status and step details"
    - "provision procedure executes retry action for failed provisioning"
    - "startFresh procedure deprovisions and re-provisions TTN resources"
    - "deepClean procedure deletes all TTN resources and resets sensors"
  artifacts:
    - path: "backend/src/routers/ttn-settings.router.ts"
      provides: "New provisioning tRPC procedures"
      contains: "getCredentials|getStatus|provision|startFresh|deepClean"
    - path: "backend/src/services/ttn/provisioning.ts"
      provides: "Provisioning operations implementation"
      contains: "startFresh|deepClean|getStatus"
  key_links:
    - from: "backend/src/routers/ttn-settings.router.ts"
      to: "backend/src/services/ttn/provisioning.ts"
      via: "service method calls"
      pattern: "TtnProvisioningService\\."
---

<objective>
Add missing tRPC procedures to ttn-settings router for TTN provisioning operations.

Purpose: Enable frontend migration by providing backend endpoints for getCredentials, getStatus, provision (retry), startFresh, and deepClean operations currently handled by edge functions.

Output: Extended ttn-settings.router.ts with 5 new procedures ready for frontend consumption.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-CONTEXT.md
@.planning/phases/31-ttn-provisioning-ui-migration/31-RESEARCH.md

# Source files to reference
@backend/src/routers/ttn-settings.router.ts
@backend/src/services/ttn/provisioning.ts
@backend/src/services/ttn/settings.ts
@backend/src/services/ttn/crypto.ts
@backend/src/schemas/ttn-settings.ts

# Edge function logic to port (reference patterns, not full code)
@supabase/functions/manage-ttn-settings/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getCredentials and getStatus procedures</name>
  <files>
    backend/src/routers/ttn-settings.router.ts
    backend/src/schemas/ttn-settings.ts
    backend/src/services/ttn/settings.ts
  </files>
  <action>
Add two new query procedures to ttn-settings.router.ts:

1. **getCredentials** - Port from manage-ttn-settings `get_credentials` action:
   - Input: `{ organizationId: z.string().uuid() }`
   - Query organization name from organizations table
   - Query ttn_connections for full settings
   - Decrypt secrets using TtnCrypto.deobfuscateKey (same pattern as edge function)
   - Return TTNCredentials shape with:
     - organization_name, organization_id
     - ttn_application_id, ttn_region
     - org_api_secret (decrypted), org_api_secret_last4, org_api_secret_status
     - app_api_secret (decrypted), app_api_secret_last4, app_api_secret_status
     - webhook_secret (decrypted), webhook_secret_last4, webhook_secret_status
     - webhook_url
     - provisioning_status, provisioning_step, provisioning_step_details
     - provisioning_error, provisioning_attempt_count
     - last_http_status, last_http_body
     - app_rights_check_status, last_ttn_correlation_id, last_ttn_error_name
     - credentials_last_rotated_at
   - Allow manager role (read-only action) - check ctx.user.role includes 'manager'

2. **getStatus** - Port from ttn-provision-org `status` action:
   - Input: `{ organizationId: z.string().uuid() }`
   - Query ttn_connections for provisioning fields only
   - Return: provisioning_status, provisioning_step, provisioning_step_details, provisioning_error, provisioning_attempt_count

Add corresponding Zod schemas to ttn-settings.ts:
- TTNCredentialsResponseSchema
- TTNStatusResponseSchema

Add helper method to TtnSettingsService if needed for credential fetching.

Note: Use existing TtnCrypto.deobfuscateKey for decryption. Handle decryption failures gracefully (return status: 'failed' not throw).
  </action>
  <verify>
Run backend tests: `cd backend && npm test -- --testPathPattern=ttn`
Verify TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
getCredentials returns decrypted TTN credentials with status fields.
getStatus returns current provisioning state.
Both procedures accessible to admin/owner (getCredentials also to manager).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add provision, startFresh, and deepClean mutation procedures</name>
  <files>
    backend/src/routers/ttn-settings.router.ts
    backend/src/services/ttn/provisioning.ts
  </files>
  <action>
Add three new mutation procedures to ttn-settings.router.ts:

1. **provision** - Port from ttn-provision-org `retry` action:
   - Input: `{ organizationId: z.string().uuid(), action: z.enum(['retry']) }`
   - Admin/owner only check
   - Call TtnProvisioningService.retryProvisioning (new method)
   - Return: `{ success: boolean, message?: string, use_start_fresh?: boolean, error?: string }`

2. **startFresh** - Port from ttn-provision-org `start_fresh` action:
   - Input: `{ organizationId: z.string().uuid(), region: z.string().default('nam1') }`
   - Admin/owner only check
   - Call TtnProvisioningService.startFresh (new method)
   - Return: `{ success: boolean, message?: string, error?: string }`

3. **deepClean** - Port from ttn-provision-org `deep_clean` action:
   - Input: `{ organizationId: z.string().uuid() }`
   - Admin/owner only check
   - Call TtnProvisioningService.deepClean (new method)
   - Return: `{ success: boolean, deleted_devices?: number, deleted_org?: boolean, message?: string, error?: string }`

Extend TtnProvisioningService with new methods:

1. **retryProvisioning(organizationId: string)** - Reset failed state, re-execute provisioning steps:
   - Check current state is 'failed', throw if not
   - Reset provisioning_status to 'pending'
   - Execute provisioning flow (reuse existing provisionOrganization pattern)
   - Update step details as it progresses
   - Return success/failure with details

2. **startFresh(organizationId: string, region: string)** - Deprovision and re-provision:
   - Delete existing TTN application via TTN API (if exists)
   - Delete existing TTN organization via TTN API (if exists)
   - Clear ttn_connections record credentials
   - Re-execute full provisioning flow
   - Return success/failure

3. **deepClean(organizationId: string)** - Delete ALL TTN resources:
   - List and delete all devices in TTN application
   - Delete TTN application
   - Delete TTN organization
   - Reset all lora_sensors to provisioning_state='pending' for this org
   - Clear ttn_connections record completely
   - Return deleted counts

Important implementation notes:
- Use TTN_ADMIN_API_KEY env var for admin operations (same as edge function)
- TTN API base URL is NAM1 only: https://nam1.cloud.thethings.network
- Handle TTN API errors gracefully, return structured error responses (don't throw)
- Log operations for audit trail (use console.log with request context)
  </action>
  <verify>
Run backend tests: `cd backend && npm test -- --testPathPattern=ttn`
Verify TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
provision procedure retries failed provisioning.
startFresh procedure deprovisions and re-provisions on NAM1.
deepClean procedure deletes all TTN resources and resets sensors.
All three procedures admin/owner only.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add backend tests for new procedures</name>
  <files>
    backend/src/routers/__tests__/ttn-settings.test.ts
  </files>
  <action>
Add tests for the new tRPC procedures. Follow existing test patterns in the file.

Test cases for getCredentials:
- Returns credentials for valid organization
- Returns empty/null credentials for org without TTN configured
- Handles decryption failures gracefully (returns status: 'failed')
- Allows manager role access (read-only)
- Rejects viewer role

Test cases for getStatus:
- Returns provisioning status for valid organization
- Returns null/idle for org without TTN configured

Test cases for provision (retry):
- Rejects retry when status is not 'failed'
- Initiates retry when status is 'failed'
- Returns use_start_fresh=true for no_application_rights errors
- Admin/owner only

Test cases for startFresh:
- Executes full reprovisioning flow
- Admin/owner only

Test cases for deepClean:
- Deletes TTN resources and resets sensors
- Returns deleted counts
- Admin/owner only

Use mocks for TTN API calls (don't hit real TTN).
Use mocks for database operations following existing patterns.
  </action>
  <verify>
Run all ttn tests: `cd backend && npm test -- --testPathPattern=ttn-settings`
All new tests pass.
  </verify>
  <done>
Tests exist for getCredentials, getStatus, provision, startFresh, deepClean.
Tests cover happy paths and error cases.
All tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify all backend tests pass
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npm test -- --testPathPattern=ttn

# Verify TypeScript compiles without errors
cd /home/swoop/swoop-claude-projects/fresh-staged/backend && npx tsc --noEmit

# Verify new procedures are exported in router
grep -E "getCredentials|getStatus|provision|startFresh|deepClean" backend/src/routers/ttn-settings.router.ts
```
</verification>

<success_criteria>
- [ ] ttn-settings.router.ts has 5 new procedures: getCredentials, getStatus, provision, startFresh, deepClean
- [ ] TtnProvisioningService has 3 new methods: retryProvisioning, startFresh, deepClean
- [ ] All procedures have proper admin/owner checks (getCredentials also allows manager)
- [ ] Backend tests pass for all new procedures
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-ttn-provisioning-ui-migration/31-01-SUMMARY.md`
</output>
