---
phase: 17-email-digests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/users.ts
  - backend/drizzle/0003_digest_preferences.sql
  - backend/src/jobs/schedulers/digest-schedulers.ts
  - backend/src/routes/preferences.ts
autonomous: true

must_haves:
  truths:
    - "User can configure their preferred daily digest time"
    - "User can select specific sites for digest filtering"
    - "Scheduler uses user's configured time instead of hardcoded 9 AM"
  artifacts:
    - path: "backend/src/db/schema/users.ts"
      provides: "digestDailyTime and digestSiteIds columns"
      contains: "digestDailyTime"
    - path: "backend/drizzle/0003_digest_preferences.sql"
      provides: "Migration adding new columns"
      contains: "ALTER TABLE"
    - path: "backend/src/jobs/schedulers/digest-schedulers.ts"
      provides: "Scheduler using dailyTime parameter"
      contains: "dailyTime"
  key_links:
    - from: "backend/src/routes/preferences.ts"
      to: "syncUserDigestSchedulers"
      via: "passes dailyTime parameter"
      pattern: "dailyTime.*profile"
---

<objective>
Add user-configurable daily digest time and site filtering preferences to the profile schema, with corresponding scheduler updates.

Purpose: Users need to control when they receive their daily digest (per CONTEXT.md: "each user picks their preferred time") and which sites to include.
Output: Schema migration, updated profile columns, scheduler using user's preferred time
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-email-digests/17-CONTEXT.md
@.planning/phases/17-email-digests/17-RESEARCH.md
@backend/src/db/schema/users.ts
@backend/src/jobs/schedulers/digest-schedulers.ts
@backend/src/routes/preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add digest preference columns to profile schema</name>
  <files>
    backend/src/db/schema/users.ts
    backend/drizzle/0003_digest_preferences.sql
  </files>
  <action>
1. Update profiles table in backend/src/db/schema/users.ts to add:
   - digestDailyTime: varchar('digest_daily_time', { length: 5 }).notNull().default('09:00')
     - Format: "HH:MM" in 24-hour format
     - Default 09:00 maintains backward compatibility
   - digestSiteIds: text('digest_site_ids')
     - JSON array of site UUIDs, null means "all sites"
     - Store as text since PostgreSQL JSON would add complexity for simple array

2. Create migration file backend/drizzle/0003_digest_preferences.sql:
```sql
-- Add user-configurable digest preferences
ALTER TABLE profiles ADD COLUMN digest_daily_time VARCHAR(5) NOT NULL DEFAULT '09:00';
ALTER TABLE profiles ADD COLUMN digest_site_ids TEXT;

COMMENT ON COLUMN profiles.digest_daily_time IS 'Preferred time for daily digest in HH:MM format (24-hour)';
COMMENT ON COLUMN profiles.digest_site_ids IS 'JSON array of site UUIDs to include in digest, NULL means all sites';
```

3. Export updated Profile type (handled by $inferSelect)
  </action>
  <verify>
- Run `cd /home/skynet/freshtrack-pro-local/fresh-staged/backend && pnpm drizzle-kit push` to apply schema
- Verify with: `pnpm drizzle-kit studio` or psql query to check columns exist
- TypeScript compilation: `pnpm tsc --noEmit`
  </verify>
  <done>
- profiles table has digestDailyTime column with '09:00' default
- profiles table has digestSiteIds column (nullable text)
- Profile type includes new fields
- Migration file exists and can be applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Update scheduler to use user's daily time</name>
  <files>
    backend/src/jobs/schedulers/digest-schedulers.ts
  </files>
  <action>
1. Update syncUserDigestSchedulers function signature to accept dailyTime:
```typescript
export async function syncUserDigestSchedulers(
  userId: string,
  organizationId: string,
  preferences: {
    dailyEnabled: boolean;
    weeklyEnabled: boolean;
    timezone: string;
    dailyTime?: string; // "HH:MM" format, defaults to "09:00"
  }
): Promise<void>
```

2. Parse dailyTime and use in cron pattern:
```typescript
const { dailyEnabled, weeklyEnabled, timezone, dailyTime = '09:00' } = preferences;

// Parse user's preferred time
const [hour, minute] = dailyTime.split(':').map(Number);

// Daily digest at user's preferred time
if (dailyEnabled) {
  await queue.upsertJobScheduler(
    `digest-daily-${userId}`,
    {
      pattern: `${minute} ${hour} * * *`, // User's chosen time daily
      tz: timezone,
    },
    // ... rest of config
  );
  console.log(`[DigestSchedulers] Upserted daily scheduler for user ${userId} at ${dailyTime} ${timezone}`);
}

// Weekly digest: Monday at user's preferred time (not fixed 9 AM)
if (weeklyEnabled) {
  await queue.upsertJobScheduler(
    `digest-weekly-${userId}`,
    {
      pattern: `${minute} ${hour} * * 1`, // Monday at user's time
      tz: timezone,
    },
    // ... rest of config
  );
  console.log(`[DigestSchedulers] Upserted weekly scheduler for user ${userId} at Monday ${dailyTime} ${timezone}`);
}
```

3. Update log messages to show actual configured time
  </action>
  <verify>
- TypeScript compilation: `cd /home/skynet/freshtrack-pro-local/fresh-staged/backend && pnpm tsc --noEmit`
- Unit test (if exists): `pnpm test -- digest-schedulers`
  </verify>
  <done>
- syncUserDigestSchedulers accepts dailyTime parameter
- Cron pattern uses user's configured hour and minute
- Weekly digest also uses user's time (on Monday)
- Log messages show actual scheduled time
  </done>
</task>

<task type="auto">
  <name>Task 3: Update preferences API to handle new fields</name>
  <files>
    backend/src/routes/preferences.ts
  </files>
  <action>
1. Update DigestPreferencesResponseSchema to include new fields:
```typescript
const DigestPreferencesResponseSchema = z.object({
  digestDaily: z.boolean(),
  digestWeekly: z.boolean(),
  digestDailyTime: z.string(), // "HH:MM" format
  digestSiteIds: z.array(z.string()).nullable(), // Array of site UUIDs or null
  timezone: z.string(),
  emailEnabled: z.boolean(),
});
```

2. Update UpdateDigestPreferencesSchema:
```typescript
const UpdateDigestPreferencesSchema = z.object({
  digestDaily: z.boolean().optional(),
  digestWeekly: z.boolean().optional(),
  digestDailyTime: z.string().regex(/^([01]\d|2[0-3]):[0-5]\d$/).optional(), // HH:MM validation
  digestSiteIds: z.array(z.string().uuid()).nullable().optional(), // Array of UUIDs or null
  timezone: z.string().min(1).max(64).optional(),
});
```

3. Update GET /digest handler to return new fields:
```typescript
const [profile] = await db
  .select({
    digestDaily: profiles.digestDaily,
    digestWeekly: profiles.digestWeekly,
    digestDailyTime: profiles.digestDailyTime,
    digestSiteIds: profiles.digestSiteIds, // Raw text, needs parsing
    timezone: profiles.timezone,
    emailEnabled: profiles.emailEnabled,
  })
  .from(profiles)
  .where(eq(profiles.userId, userId))
  .limit(1);

// Parse digestSiteIds from JSON text to array
return reply.send({
  ...profile,
  digestSiteIds: profile.digestSiteIds ? JSON.parse(profile.digestSiteIds) : null,
});
```

4. Update PATCH /digest handler:
   - Add digestDailyTime and digestSiteIds to updates object
   - Convert digestSiteIds array to JSON string for storage
   - Pass dailyTime to syncUserDigestSchedulers

```typescript
if (body.digestDailyTime !== undefined) updates.digestDailyTime = body.digestDailyTime;
if (body.digestSiteIds !== undefined) {
  updates.digestSiteIds = body.digestSiteIds ? JSON.stringify(body.digestSiteIds) : null;
}

// In scheduler sync call:
syncUserDigestSchedulers(userId, profile.organizationId, {
  dailyEnabled: updated.digestDaily,
  weeklyEnabled: updated.digestWeekly,
  timezone: updated.timezone,
  dailyTime: updated.digestDailyTime, // Pass user's preferred time
}).catch((err) => {
  fastify.log.error({ err }, '[Preferences] Failed to sync digest schedulers');
});
```
  </action>
  <verify>
- TypeScript compilation: `cd /home/skynet/freshtrack-pro-local/fresh-staged/backend && pnpm tsc --noEmit`
- Test endpoints with curl:
  - GET /api/preferences/digest returns digestDailyTime and digestSiteIds
  - PATCH /api/preferences/digest accepts new fields
- Backend starts without errors: `pnpm dev` (check startup logs)
  </verify>
  <done>
- GET /api/preferences/digest returns digestDailyTime (string) and digestSiteIds (array or null)
- PATCH /api/preferences/digest accepts and validates digestDailyTime (HH:MM) and digestSiteIds (UUID array)
- Scheduler sync receives dailyTime parameter
- JSON serialization/deserialization for digestSiteIds works correctly
  </done>
</task>

</tasks>

<verification>
1. Schema verification:
   - `psql` or drizzle-kit studio shows new columns in profiles table
   - Default digestDailyTime is '09:00'
   - digestSiteIds allows NULL

2. API verification:
   - GET /api/preferences/digest includes new fields
   - PATCH with `{"digestDailyTime": "07:30"}` updates preference
   - PATCH with `{"digestSiteIds": ["uuid1", "uuid2"]}` stores as JSON

3. Scheduler verification:
   - After PATCH, check Bull Board for scheduler with correct cron pattern
   - User setting 07:30 should produce pattern `30 7 * * *` for daily
</verification>

<success_criteria>
1. Profile schema includes digestDailyTime (varchar, default '09:00') and digestSiteIds (text, nullable)
2. Migration file can be applied without errors
3. Scheduler sync uses user's configured daily time instead of hardcoded 9 AM
4. Preferences API accepts, validates, and returns new fields
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-email-digests/17-01-SUMMARY.md`
</output>
