---
phase: 48-production-redeploy-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/production-smoke.spec.ts
autonomous: false

must_haves:
  truths:
    - "Frontend container is rebuilt with all tRPC proxy fixes from phases 46-47"
    - "Frontend container is running and healthy on 192.168.4.181"
    - "App renders in browser - React mounts and #root has visible children"
    - "No TypeError: e[i] is not a function in browser console"
    - "Playwright smoke tests pass with React rendering assertion (not just warning)"
  artifacts:
    - path: "e2e/production-smoke.spec.ts"
      provides: "Strengthened smoke test that asserts React mount (not just logs warning)"
      contains: "expect(rootChildren).toBeGreaterThan(0)"
  key_links:
    - from: "local git repo"
      to: "VM at 192.168.4.181:/opt/fresh-staged"
      via: "ssh + git pull"
      pattern: "git pull"
    - from: "docker compose build"
      to: "frontend container"
      via: "Vite build with VITE_ env vars as build args"
      pattern: "docker compose.*build.*frontend"
    - from: "playwright smoke tests"
      to: "https://192.168.4.181"
      via: "playwright.production.config.ts baseURL"
      pattern: "baseURL.*192.168.4.181"
---

<objective>
Rebuild and redeploy the frontend to the production VM at 192.168.4.181, then verify that React mounts successfully and the tRPC runtime crash is resolved.

Purpose: This is the final phase of v2.7 tRPC Client Fix. Phases 46-47 fixed all the code (dependency cleanup + proxy call migration). This phase deploys those fixes to production and confirms the app actually renders.

Output: Running frontend container with working React app, passing Playwright smoke tests that assert React rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-production-deployment/45-02-SUMMARY.md
@e2e/production-smoke.spec.ts
@playwright.production.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push code to VM, rebuild and redeploy frontend container</name>
  <files>e2e/production-smoke.spec.ts</files>
  <action>
    **Step 1: Strengthen the smoke test BEFORE deploying.**

    Edit `e2e/production-smoke.spec.ts` to make the "JS bundle loads and React mount attempted" test actually ASSERT that React renders instead of just logging a warning. Change the test named "JS bundle loads and React mount attempted" to:

    1. Rename it to "React app renders successfully"
    2. After getting `rootChildren`, ASSERT `expect(rootChildren).toBeGreaterThan(0)` instead of the current if/else that just logs
    3. Also collect `pageerror` events and assert that none contain "is not a function" (to catch the specific tRPC crash)
    4. Keep the existing screenshot capture

    The test should fail clearly if React does not mount, rather than silently passing.

    **Step 2: Commit the strengthened test locally.**

    ```bash
    git add e2e/production-smoke.spec.ts
    git commit -m "test(48): strengthen smoke test to assert React mount"
    ```

    **Step 3: Push code to VM and rebuild frontend.**

    Execute these commands via SSH (each command depends on the previous):

    ```bash
    # Pull latest code (includes phases 46-47 fixes + strengthened test)
    ssh root@192.168.4.181 "cd /opt/fresh-staged && git pull"

    # Rebuild frontend container with no cache, passing VITE_ env vars as build args
    ssh root@192.168.4.181 "cd /opt/fresh-staged && export \$(grep -v '^#' .env.production | xargs) && docker compose -f docker-compose.yml -f compose.production.yaml build --no-cache frontend"

    # Restart frontend container
    ssh root@192.168.4.181 "cd /opt/fresh-staged && export \$(grep -v '^#' .env.production | xargs) && docker compose -f docker-compose.yml -f compose.production.yaml up -d frontend"

    # Wait 10 seconds for container startup
    sleep 10

    # Verify container is running and healthy
    ssh root@192.168.4.181 "docker ps --format 'table {{.Names}}\t{{.Status}}' | grep frontend"
    ```

    **If git pull fails** because of local changes on the VM, run:
    ```bash
    ssh root@192.168.4.181 "cd /opt/fresh-staged && git stash && git pull"
    ```

    **If build fails**, check the build logs for specific errors and address them. Common issues from Phase 45 experience:
    - Missing env vars: ensure `.env.production` exists and has VITE_ prefixed vars
    - Lockfile stale: run `pnpm install` on VM first

    **Do NOT use `docker compose restart`** - use `up -d` which recreates the container from the new image.
  </action>
  <verify>
    Run: `ssh root@192.168.4.181 "docker ps --format 'table {{.Names}}\t{{.Status}}' | grep frontend"`
    Expected: Container shows "Up" and "healthy" status.

    Run: `curl -k -s -o /dev/null -w '%{http_code}' https://192.168.4.181/`
    Expected: HTTP 200 (or 308 redirect from Caddy, which is fine - means frontend is serving).
  </verify>
  <done>
    1. Smoke test strengthened to assert React mount (not just log warning)
    2. Code pushed to VM via git pull
    3. Frontend container rebuilt with --no-cache
    4. Frontend container running and healthy on 192.168.4.181
  </done>
</task>

<task type="auto">
  <name>Task 2: Run Playwright smoke tests and verify React renders</name>
  <files>e2e/production-smoke.spec.ts</files>
  <action>
    **Step 1: Run the Playwright production smoke tests from the local machine.**

    ```bash
    cd /home/swoop/swoop-claude-projects/fresh-staged
    npx playwright test --config=playwright.production.config.ts
    ```

    This runs the 4 tests in `e2e/production-smoke.spec.ts` against `https://192.168.4.181`:
    1. "frontend serves HTML successfully" - checks HTTP response, title, #root element
    2. "API health endpoint responds" - checks /api/health returns healthy
    3. "React app renders successfully" - THE KEY TEST: asserts #root has children (React mounted)
    4. "no critical resources fail to load" - checks no JS/CSS failed to load

    **Step 2: If test 3 ("React app renders successfully") fails:**

    This means React still isn't mounting. Debug by:
    1. Check browser console errors via Playwright trace (saved on retry)
    2. SSH into VM and check frontend container logs: `ssh root@192.168.4.181 "docker logs frostguard-frontend --tail 50"`
    3. Check if the specific error `TypeError: e[i] is not a function` still appears
    4. If it does, there may be remaining `.mutate()`/`.query()` proxy calls that were missed in Phase 47

    **Step 3: If all tests pass, capture evidence.**

    Take note of the full Playwright output showing all 4 tests passing. The key line to confirm is test 3 passing, which proves React mounts successfully.

    Also verify no console errors by running a quick manual check:
    ```bash
    ssh root@192.168.4.181 "docker logs frostguard-frontend --tail 20"
    ```

    **Step 4: If Playwright is not installed or fails to launch:**
    ```bash
    npx playwright install chromium
    ```
    Then retry the test command.
  </action>
  <verify>
    Run: `npx playwright test --config=playwright.production.config.ts`
    Expected: All 4 tests pass (4 passed, 0 failed).

    The critical assertion: "React app renders successfully" test passes, confirming `#root` has children.
  </verify>
  <done>
    1. All 4 Playwright production smoke tests pass
    2. "React app renders successfully" test confirms #root has children (React mounted)
    3. No "TypeError: e[i] is not a function" errors in browser console
    4. Frontend serves working React app at https://192.168.4.181
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Frontend redeployed to production VM (192.168.4.181) with all tRPC proxy fixes from v2.7.
    Playwright smoke tests should confirm React renders successfully.
  </what-built>
  <how-to-verify>
    1. Open https://192.168.4.181 in your browser (accept self-signed cert warning)
    2. Confirm the FrostGuard/FreshTrack dashboard loads and is visible (not a blank white page)
    3. Open browser DevTools console (F12 -> Console tab)
    4. Confirm NO "TypeError: e[i] is not a function" errors appear
    5. Click around the UI briefly to confirm basic navigation works
  </how-to-verify>
  <resume-signal>Type "approved" if the app renders and works, or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
Phase-level verification checklist:

1. **PROD-01**: Frontend rebuilt and redeployed
   - `ssh root@192.168.4.181 "docker ps | grep frontend"` shows healthy container
   - Container was rebuilt with `--no-cache` after code changes

2. **PROD-02**: App renders in browser
   - Playwright "React app renders successfully" test passes
   - `#root` has children (React mounted)
   - User visually confirms dashboard loads (checkpoint)

3. **PROD-03**: Playwright smoke tests pass
   - `npx playwright test --config=playwright.production.config.ts` shows 4/4 passing
   - No "is not a function" errors in test output
</verification>

<success_criteria>
- Frontend container rebuilt and running healthy on 192.168.4.181
- All 4 Playwright production smoke tests pass
- React mounts successfully (#root has visible children)
- No TypeError: e[i] is not a function in browser console
- User confirms app renders in browser (checkpoint approved)
</success_criteria>

<output>
After completion, create `.planning/phases/48-production-redeploy-verification/48-01-SUMMARY.md`
</output>
