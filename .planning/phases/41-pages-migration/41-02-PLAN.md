---
phase: 41-pages-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/ManualLog.tsx
  - src/pages/OrganizationDashboard.tsx
autonomous: true

must_haves:
  truths:
    - 'ManualLog page loads units via tRPC'
    - 'ManualLog page loads manual logs via tRPC'
    - 'OrganizationDashboard loads org/sites/units via tRPC'
  artifacts:
    - path: 'src/pages/ManualLog.tsx'
      provides: 'Manual log page with tRPC data fetching'
    - path: 'src/pages/OrganizationDashboard.tsx'
      provides: 'Org dashboard with tRPC data fetching'
  key_links:
    - from: 'src/pages/ManualLog.tsx'
      to: 'trpc.units.listByOrg'
      via: 'useQuery'
      pattern: "trpc\\.units"
    - from: 'src/pages/OrganizationDashboard.tsx'
      to: 'trpc.sites.list'
      via: 'useQuery'
      pattern: "trpc\\.sites"
---

<objective>
Migrate ManualLog and OrganizationDashboard pages from supabase-placeholder to tRPC

Purpose: Remove supabase dependencies from pages that display unit data with computed status
Output: 2 pages using tRPC hooks for all data fetching
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-dashboard-widgets/39-01-SUMMARY.md
@.planning/phases/40-settings-components/40-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ManualLog to tRPC</name>
  <files>src/pages/ManualLog.tsx</files>
  <action>
    Replace supabase queries with tRPC for units and manual log data.

    Steps:
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';`
    2. Add tRPC imports if not present: `import { useTRPC } from '@/lib/trpc';`
    3. Replace loadUnits function:
       - Use `trpc.units.listByOrg.queryOptions({ organizationId: effectiveOrgId })` with useQuery
       - The response includes: id, name, unitType, status, tempLimitHigh, tempLimitLow, lastTempReading, lastReadingAt, siteId, siteName, areaName, sensorReliable, manualLoggingEnabled, consecutiveCheckins
       - Transform camelCase response to snake_case for UnitStatusInfo interface compatibility
    4. For manual logs (last log per unit), add a new tRPC procedure OR use existing readings router:
       - Check if `trpc.readings.listManualLogs` exists - if so use it
       - Otherwise, the manual_temperature_logs can be queried via a new procedure in readings router
       - Alternative: Use `trpc.readings.getLatestManualLogPerUnit.queryOptions({ unitIds })` if available
    5. If no existing procedure for manual logs per unit, simplify:
       - Use the unit's `lastManualLogAt` field if available from listByOrg response
       - Or add `last_manual_log_at` to the units.listByOrg response
    6. Replace useState/useEffect pattern with useQuery + useMemo for filtering

  </action>
  <verify>
    - `grep -c "supabase" src/pages/ManualLog.tsx` returns 0
    - `npx tsc --noEmit` passes
  </verify>
  <done>ManualLog.tsx uses tRPC queries, no supabase imports</done>
</task>

<task type="auto">
  <name>Task 2: Migrate OrganizationDashboard to tRPC</name>
  <files>src/pages/OrganizationDashboard.tsx</files>
  <action>
    Replace supabase queries with tRPC for organization, sites, and units data.

    Steps:
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';`
    2. Use existing tRPC hooks and procedures:
       - Organization name: Use `trpc.organizations.getCurrent.queryOptions()` or similar
       - Sites: Use `trpc.sites.list.queryOptions()`
       - Units by site: Use `trpc.units.listByOrg.queryOptions({ organizationId: effectiveOrgId })`
    3. Replace loadOrganizationData function with useQuery hooks:
       ```typescript
       const trpc = useTRPC();
       const { data: orgData } = useQuery(trpc.organizations.getCurrent.queryOptions());
       const { data: sitesData } = useQuery(trpc.sites.list.queryOptions());
       const { data: unitsData } = useQuery(
         trpc.units.listByOrg.queryOptions({ organizationId: effectiveOrgId })
       );
       ```
    4. Use useMemo to process the data:
       - Group units by siteId
       - Compute alertSummary using computeUnitAlerts (already imported)
       - Calculate compliance scores
    5. Transform tRPC response (camelCase) to match existing interface expectations:
       - units from listByOrg have: siteId, siteName, areaName, etc.
       - Map to UnitStatusInfo interface format
    6. Handle loading state from useQuery isLoading

  </action>
  <verify>
    - `grep -c "supabase" src/pages/OrganizationDashboard.tsx` returns 0
    - `npx tsc --noEmit` passes
  </verify>
  <done>OrganizationDashboard.tsx uses tRPC queries, no supabase imports</done>
</task>

</tasks>

<verification>
- Both pages compile without TypeScript errors
- No supabase imports in either file
- `grep -l "supabase" src/pages/ManualLog.tsx src/pages/OrganizationDashboard.tsx` returns empty
</verification>

<success_criteria>

- ManualLog and OrganizationDashboard pages have zero supabase imports
- All data fetching uses tRPC procedures
- TypeScript compilation passes
- Existing functionality preserved (unit status computation, alert summaries)
  </success_criteria>

<output>
After completion, create `.planning/phases/41-pages-migration/41-02-SUMMARY.md`
</output>
