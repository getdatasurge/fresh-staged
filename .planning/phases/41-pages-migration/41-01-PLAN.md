---
phase: 41-pages-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/HealthDashboard.tsx
  - src/pages/TTNCleanup.tsx
  - src/pages/Reports.tsx
autonomous: true

must_haves:
  truths:
    - "HealthDashboard renders without supabase import"
    - "TTNCleanup loads user profile via tRPC"
    - "Reports page loads sites and units via tRPC"
  artifacts:
    - path: "src/pages/HealthDashboard.tsx"
      provides: "Health dashboard without supabase"
    - path: "src/pages/TTNCleanup.tsx"
      provides: "TTN cleanup with tRPC profile query"
    - path: "src/pages/Reports.tsx"
      provides: "Reports with tRPC site/unit queries"
  key_links:
    - from: "src/pages/Reports.tsx"
      to: "trpc.sites.list"
      via: "useQuery"
      pattern: "trpc\\.sites"
---

<objective>
Migrate 3 simpler pages (HealthDashboard, TTNCleanup, Reports) from supabase-placeholder to tRPC

Purpose: Remove supabase dependencies from pages with straightforward data fetching patterns
Output: 3 pages using tRPC hooks instead of direct supabase queries
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-settings-components/40-01-SUMMARY.md
@.planning/phases/40-settings-components/40-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate HealthDashboard to tRPC</name>
  <files>src/pages/HealthDashboard.tsx</files>
  <action>
    Remove the supabase import from HealthDashboard.tsx. The page currently imports supabase but doesn't actually use it directly - all data fetching is handled by the useHealthCheck hook. Simply remove the unused import.

    Steps:
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';` line
    2. Verify no other supabase references exist in the file
    3. TypeScript should compile without errors
  </action>
  <verify>
    - `grep -c "supabase" src/pages/HealthDashboard.tsx` returns 0
    - `npx tsc --noEmit` passes
  </verify>
  <done>HealthDashboard.tsx has no supabase import and compiles successfully</done>
</task>

<task type="auto">
  <name>Task 2: Migrate TTNCleanup to tRPC</name>
  <files>src/pages/TTNCleanup.tsx</files>
  <action>
    Replace the supabase profile query with tRPC. The page only uses supabase to fetch the user's organization_id from profiles table.

    Steps:
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';`
    2. Replace the profile query with existing tRPC hook:
       - Use `useEffectiveIdentity` hook which already provides `effectiveOrgId`
       - Import: `import { useEffectiveIdentity } from '@/hooks/useEffectiveIdentity';`
    3. Replace `const orgId = profile?.organization_id;` with `const { effectiveOrgId: orgId } = useEffectiveIdentity();`
    4. Remove the `useQuery` for profile since useEffectiveIdentity handles this
    5. Update the hooks that depend on orgId to also check `isInitialized` from useEffectiveIdentity
  </action>
  <verify>
    - `grep -c "supabase" src/pages/TTNCleanup.tsx` returns 0
    - `npx tsc --noEmit` passes
  </verify>
  <done>TTNCleanup.tsx uses useEffectiveIdentity instead of supabase profile query</done>
</task>

<task type="auto">
  <name>Task 3: Migrate Reports to tRPC</name>
  <files>src/pages/Reports.tsx</files>
  <action>
    Replace supabase queries for sites and units with tRPC. The Reports page queries sites and units with area/site joins for filtering.

    Steps:
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';`
    2. Import useTRPC and useQuery: already has `useTRPC` imported
    3. Replace loadData function:
       - Use `trpc.sites.list.queryOptions()` with useQuery for sites
       - Use `trpc.units.listByOrg.queryOptions({ organizationId: effectiveOrgId })` for units
    4. The units query from listByOrg returns units with siteId, so transform the response:
       ```typescript
       const formattedUnits = unitsData?.map(u => ({
         id: u.id,
         name: u.name,
         area: {
           name: u.areaName || "",
           site: {
             id: u.siteId || "",
             name: u.siteName || ""
           }
         }
       }));
       ```
    5. Replace useState + useEffect pattern with useQuery hooks
    6. Handle loading state from useQuery's isLoading
  </action>
  <verify>
    - `grep -c "supabase" src/pages/Reports.tsx` returns 0
    - `npx tsc --noEmit` passes
  </verify>
  <done>Reports.tsx uses tRPC queries for sites and units, no supabase imports</done>
</task>

</tasks>

<verification>
- All 3 pages compile without TypeScript errors
- No supabase imports in any of the 3 files
- `grep -l "supabase" src/pages/HealthDashboard.tsx src/pages/TTNCleanup.tsx src/pages/Reports.tsx` returns empty
</verification>

<success_criteria>
- HealthDashboard, TTNCleanup, and Reports pages have zero supabase imports
- All pages use tRPC or existing hooks for data fetching
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/41-pages-migration/41-01-SUMMARY.md`
</output>
