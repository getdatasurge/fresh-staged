---
phase: 41-pages-migration
plan: 03
type: execute
wave: 2
depends_on: [41-01, 41-02]
files_modified:
  - src/pages/Inspector.tsx
  - src/pages/Onboarding.tsx
  - backend/src/routers/inspector.router.ts
  - backend/src/routers/onboarding.router.ts
  - backend/src/routers/index.ts
autonomous: true

must_haves:
  truths:
    - 'Inspector page validates sessions via tRPC'
    - 'Inspector page loads all inspection data via tRPC'
    - 'Onboarding page creates org/site/area/unit via tRPC'
  artifacts:
    - path: 'src/pages/Inspector.tsx'
      provides: 'Inspector page with tRPC data fetching'
    - path: 'src/pages/Onboarding.tsx'
      provides: 'Onboarding with tRPC mutations'
    - path: 'backend/src/routers/inspector.router.ts'
      provides: 'Inspector data procedures'
    - path: 'backend/src/routers/onboarding.router.ts'
      provides: 'Onboarding mutation procedures'
  key_links:
    - from: 'src/pages/Inspector.tsx'
      to: 'backend/src/routers/inspector.router.ts'
      via: 'tRPC procedures'
      pattern: "trpc\\.inspector"
    - from: 'src/pages/Onboarding.tsx'
      to: 'backend/src/routers/onboarding.router.ts'
      via: 'tRPC mutations'
      pattern: "trpc\\.onboarding"
---

<objective>
Migrate Inspector and Onboarding pages from supabase-placeholder to tRPC with new backend procedures

Purpose: Remove supabase dependencies from complex pages that require new backend procedures
Output: 2 pages using tRPC, 2 new backend routers with required procedures
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-settings-components/40-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Inspector router and migrate page</name>
  <files>
    backend/src/routers/inspector.router.ts
    backend/src/routers/index.ts
    src/pages/Inspector.tsx
  </files>
  <action>
    Create backend procedures for Inspector page data and migrate the frontend.

    **Backend (inspector.router.ts):**
    Create new router with these procedures:

    1. `validateSession` - Validate inspector token
       - Input: { token: string }
       - Query inspector_sessions table for valid, active, non-expired session
       - Update last_used_at timestamp
       - Return { organizationId, allowedSiteIds } or throw error

    2. `getOrgData` - Get organization details and sites
       - Input: { organizationId: string, allowedSiteIds?: string[] }
       - Query organizations for name, timezone
       - Query sites filtered by org and optionally by allowedSiteIds
       - Return { name, timezone, sites: Site[] }

    3. `getUnits` - Get units for filtering
       - Input: { organizationId: string, siteId?: string }
       - Query units with area/site joins
       - Filter by org and optionally by site
       - Return Unit[]

    4. `getInspectionData` - Get all inspection data for date range
       - Input: { unitIds: string[], startDate: string, endDate: string }
       - Query sensor_readings, manual_temperature_logs, alerts, corrective_actions, event_logs
       - Join with profiles for user names
       - Return { temperatureLogs, exceptions, correctiveActions, monitoringGaps }

    **Add to index.ts:**
    ```typescript
    import { inspectorRouter } from './inspector.router';
    // Add to appRouter: inspector: inspectorRouter,
    ```

    **Frontend (Inspector.tsx):**
    1. Remove `import { supabase } from '@/lib/supabase-placeholder';`
    2. Replace initializeInspector:
       - Token-based: Use `trpc.inspector.validateSession.mutate({ token })`
       - User-based: Use existing auth check, then call `trpc.inspector.getOrgData`
    3. Replace loadOrgData with `trpc.inspector.getOrgData.query()`
    4. Replace loadUnits with `trpc.inspector.getUnits.query()`
    5. Replace loadData with `trpc.inspector.getInspectionData.query()`
    6. Transform responses to match existing snake_case interfaces

  </action>
  <verify>
    - `grep -c "supabase" src/pages/Inspector.tsx` returns 0
    - `npx tsc --noEmit` passes
    - Inspector router exists in backend/src/routers/inspector.router.ts
  </verify>
  <done>Inspector.tsx uses tRPC procedures from new inspector router</done>
</task>

<task type="auto">
  <name>Task 2: Create Onboarding router and migrate page</name>
  <files>
    backend/src/routers/onboarding.router.ts
    backend/src/routers/index.ts
    src/pages/Onboarding.tsx
  </files>
  <action>
    Create backend procedures for Onboarding wizard and migrate the frontend.

    **Backend (onboarding.router.ts):**
    Create new router with these procedures:

    1. `checkExistingOrg` - Check if user already has an organization
       - Use auth context for user ID
       - Query profiles table for organization_id
       - Return { hasOrg: boolean, organizationId?: string }

    2. `createOrganization` - Create org with owner
       - Input: { name: string, slug: string, timezone: string }
       - Call existing RPC create_organization_with_owner or implement directly
       - Return { ok: boolean, organizationId?: string, code?: string, message?: string, suggestions?: string[] }

    3. `createSite` - Create site for org
       - Input: { name: string, address?: string, city?: string, state?: string, postalCode?: string }
       - Use org from auth context
       - Return siteId

    4. `createArea` - Create area for site
       - Input: { siteId: string, name: string, description?: string }
       - Return areaId

    5. `createUnit` - Create unit for area
       - Input: { areaId: string, name: string, unitType: string }
       - Return unitId

    6. `createGateway` - Register gateway
       - Input: { name: string, gatewayEui: string, siteId: string }
       - Use org from auth context
       - Insert into gateways table
       - Return gatewayId

    **Add to index.ts:**
    ```typescript
    import { onboardingRouter } from './onboarding.router';
    // Add to appRouter: onboarding: onboardingRouter,
    ```

    **Frontend (Onboarding.tsx):**
    1. Remove `import { supabase, isSupabaseMigrationError } from '@/lib/supabase-placeholder';`
    2. Replace checkExistingOrg useEffect:
       - Use `trpc.onboarding.checkExistingOrg.query()`
    3. Replace handleCreateOrganization:
       - Use `trpc.onboarding.createOrganization.mutate()`
    4. Replace handleCreateSite:
       - Use `trpc.onboarding.createSite.mutate()`
    5. Replace handleCreateArea:
       - Use `trpc.onboarding.createArea.mutate()`
    6. Replace handleCreateUnit:
       - Use `trpc.onboarding.createUnit.mutate()`
    7. Replace handleCreateGateway:
       - Use `trpc.onboarding.createGateway.mutate()`
    8. Remove isSupabaseMigrationError checks - use standard tRPC error handling
    9. Keep TTN provisioning status polling (already uses tRPC)

  </action>
  <verify>
    - `grep -c "supabase" src/pages/Onboarding.tsx` returns 0
    - `npx tsc --noEmit` passes
    - Onboarding router exists in backend/src/routers/onboarding.router.ts
  </verify>
  <done>Onboarding.tsx uses tRPC procedures from new onboarding router</done>
</task>

</tasks>

<verification>
- All pages compile without TypeScript errors
- No supabase imports in Inspector.tsx or Onboarding.tsx
- `grep -l "supabase" src/pages/Inspector.tsx src/pages/Onboarding.tsx` returns empty
- Both new routers exist and are registered in index.ts
</verification>

<success_criteria>

- Inspector and Onboarding pages have zero supabase imports
- inspector.router.ts provides all data fetching procedures
- onboarding.router.ts provides all mutation procedures
- TypeScript compilation passes
- Existing functionality preserved (inspector sessions, onboarding wizard flow)
  </success_criteria>

<output>
After completion, create `.planning/phases/41-pages-migration/41-03-SUMMARY.md`
</output>
