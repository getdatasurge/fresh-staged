---
phase: 42-admin-debug-components
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/NotificationDropdown.tsx
  - src/components/LogTempModal.tsx
  - src/components/platform/GlobalUserSearch.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "NotificationDropdown fetches alerts via tRPC"
    - "LogTempModal saves temperature logs via tRPC mutation"
    - "GlobalUserSearch queries users via tRPC"
  artifacts:
    - path: "src/components/NotificationDropdown.tsx"
      provides: "Notification dropdown with tRPC alerts"
    - path: "src/components/LogTempModal.tsx"
      provides: "Temperature logging modal with tRPC mutation"
    - path: "src/components/platform/GlobalUserSearch.tsx"
      provides: "Platform user search with tRPC"
  key_links:
    - from: "src/components/NotificationDropdown.tsx"
      to: "trpc.alerts.list"
      via: "useQuery"
      pattern: "trpc\\.alerts\\.list"
    - from: "src/components/LogTempModal.tsx"
      to: "trpc.readings"
      via: "useMutation"
      pattern: "trpc\\.readings"
---

<objective>
Migrate 3 general components from supabase-placeholder to tRPC

Purpose: Complete COMP-01 through COMP-03 requirements - remove supabase imports from notification, logging, and platform search components
Output: All 3 components use tRPC for data fetching and mutations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-pages-migration/41-01-SUMMARY.md
@.planning/phases/41-pages-migration/41-02-SUMMARY.md
@backend/src/routers/alerts.router.ts
@backend/src/routers/admin.router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate NotificationDropdown to tRPC</name>
  <files>src/components/NotificationDropdown.tsx</files>
  <action>
**NotificationDropdown.tsx:**
- Remove import of `supabase, isSupabaseMigrationError` from `@/lib/supabase-placeholder`
- Add: `import { useTRPC } from '@/lib/trpc'`
- Add: `import { useQuery } from '@tanstack/react-query'`
- Add: `import { useEffectiveIdentity } from '@/hooks/useEffectiveIdentity'`

**Replace orgId loading (lines 61-73):**
- Remove the loadOrgId useEffect that queries profiles
- Use `useEffectiveIdentity` hook instead:
  ```typescript
  const { organizationId: orgId } = useEffectiveIdentity()
  ```

**Replace loadNotifications (lines 75-172):**
- Replace with tRPC useQuery:
  ```typescript
  const trpc = useTRPC()
  const { data: alertsData, isLoading, refetch: loadNotifications } = useQuery(
    trpc.alerts.list.queryOptions(
      { status: ['active', 'acknowledged'], limit: 20 },
      { enabled: isOpen && !!orgId }
    )
  )
  ```
- Transform alerts to notifications using useMemo:
  ```typescript
  const notifications = useMemo(() => {
    if (!alertsData) return []
    return alertsData.map(alert => mapAlertToNotification({
      id: alert.id,
      title: alert.title,
      message: alert.message,
      alert_type: alert.alertType,
      severity: alert.severity as 'critical' | 'warning' | 'info',
      status: alert.status,
      temp_reading: alert.tempReading,
      temp_limit: alert.tempLimit,
      triggered_at: alert.triggeredAt,
      metadata: alert.metadata as Record<string, unknown> | null,
      unit_id: alert.unitId,
      unit: alert.unit ? {
        id: alert.unit.id,
        name: alert.unit.name,
        area: alert.unit.area ? {
          id: alert.unit.area.id,
          name: alert.unit.area.name,
          site: alert.unit.area.site ? {
            id: alert.unit.area.site.id,
            name: alert.unit.area.site.name
          } : undefined
        } : undefined
      } : undefined
    }))
  }, [alertsData])
  ```

**shouldShowToast function (lines 181-214):**
- This uses supabase.rpc for notification policy
- Replace with tRPC call to notificationPolicies.getEffective:
  ```typescript
  const shouldShowToast = async (alert: { unit_id: string; alert_type: string; severity: string }): Promise<boolean> => {
    try {
      // Use queryClient to fetch policy
      const policy = await queryClient.fetchQuery(
        trpc.notificationPolicies.getEffective.queryOptions({
          unitId: alert.unit_id,
          alertType: alert.alert_type
        })
      )
      if (!policy) return false
      const initialChannels = policy.initialChannels || []
      if (!initialChannels.includes('WEB_TOAST')) return false
      if (alert.severity === 'critical') return true
      if (alert.severity === 'warning' && policy.allowWarningNotifications) return true
      return false
    } catch {
      return false
    }
  }
  ```
- Add `import { useQueryClient } from '@tanstack/react-query'` and `const queryClient = useQueryClient()`

**Real-time subscription (lines 217-261):**
- The Supabase realtime subscription for new alerts needs to be removed
- For now, remove the realtime subscription - alerts will refresh when dropdown opens
- Add a comment: `// TODO: Implement WebSocket subscription for real-time alerts`
- Remove the useEffect that sets up the channel subscription

**Remove:**
- The useState for orgId (use from hook)
- The loadOrgId useEffect
- The supabase channel subscription useEffect
- All isSupabaseMigrationError checks
  </action>
  <verify>
    grep "supabase-placeholder" src/components/NotificationDropdown.tsx
    # Should return nothing
    npx tsc --noEmit
  </verify>
  <done>NotificationDropdown uses tRPC for alerts, realtime subscription removed with TODO comment</done>
</task>

<task type="auto">
  <name>Task 2: Migrate LogTempModal to tRPC</name>
  <files>src/components/LogTempModal.tsx</files>
  <action>
**LogTempModal.tsx:**
- Remove import of `supabase, isSupabaseMigrationError` from `@/lib/supabase-placeholder`
- Add: `import { useTRPC } from '@/lib/trpc'`
- Add: `import { useMutation } from '@tanstack/react-query'`

**Add tRPC mutation for manual temperature logging:**
The readings router needs a procedure for manual logs. Check if it exists, if not we need to add one.

Looking at the readings router, there should be a procedure for creating manual logs. If not present, create a simple mutation that:
1. Inserts into manual_temperature_logs
2. Optionally creates corrective_action record
3. Resolves missed_manual_entry alerts

**Replace handleSubmit (lines 69-191):**
- Create tRPC mutation:
  ```typescript
  const trpc = useTRPC()
  const logTemperatureMutation = useMutation(
    trpc.readings.logManualTemperature.mutationOptions()
  )
  ```

- If the procedure doesn't exist, we need to add it to readings.router.ts:
  ```typescript
  logManualTemperature: protectedProcedure
    .input(z.object({
      unitId: z.string().uuid(),
      temperature: z.number(),
      notes: z.string().nullable().optional(),
      correctiveAction: z.string().nullable().optional(),
      isInRange: z.boolean()
    }))
    .mutation(async ({ input, ctx }) => {
      // Insert manual log, corrective action, resolve alerts
    })
  ```

**Simplified approach if no backend procedure exists:**
- Keep the offline sync fallback via `saveLogOffline`
- Show toast that online logging is being migrated
- The useOfflineSync hook will queue the log for later sync

**Updated handleSubmit:**
```typescript
const handleSubmit = async () => {
  // ... validation code stays the same ...

  setIsSubmitting(true)
  const logEntry = { /* ... same as before ... */ }

  try {
    if (isOnline && user?.id) {
      await logTemperatureMutation.mutateAsync({
        unitId: unit.id,
        temperature: validatedTemp,
        notes: validatedNotes,
        correctiveAction: isOutOfRange ? correctiveAction.trim() : null,
        isInRange: !isOutOfRange
      })
      toast({ title: "Temperature logged successfully" })
    } else {
      await saveLogOffline(logEntry)
      toast({ title: "Saved offline", description: "Will sync when back online" })
    }
    onOpenChange(false)
    onSuccess?.()
  } catch (error) {
    console.error("Error saving log:", error)
    // Fallback to offline
    await saveLogOffline(logEntry)
    toast({ title: "Saved offline", description: "Will sync when back online" })
    onOpenChange(false)
    onSuccess?.()
  }
  setIsSubmitting(false)
}
```

**If readings.logManualTemperature doesn't exist:**
- Add the procedure to backend/src/routers/readings.router.ts
- The procedure should insert into manual_temperature_logs, corrective_actions, and update alerts
  </action>
  <verify>
    grep "supabase-placeholder" src/components/LogTempModal.tsx
    # Should return nothing
    npx tsc --noEmit
  </verify>
  <done>LogTempModal uses tRPC mutation for temperature logging with offline fallback</done>
</task>

<task type="auto">
  <name>Task 3: Migrate GlobalUserSearch to tRPC</name>
  <files>src/components/platform/GlobalUserSearch.tsx</files>
  <action>
**GlobalUserSearch.tsx:**
- Remove import of `supabase` from `@/lib/supabase-placeholder`
- Add: `import { useTRPC } from '@/lib/trpc'`
- Add: `import { useQuery } from '@tanstack/react-query'`

**Replace searchUsers (lines 57-117):**
- The admin.router.ts already has `listUsers` procedure that returns users with org context
- However, it doesn't support search filtering - we need to add a search procedure OR filter client-side

**Option A: Add search procedure to admin.router.ts:**
```typescript
searchUsers: protectedProcedure
  .input(z.object({ query: z.string().min(2) }))
  .output(z.array(SearchResultSchema))
  .query(async ({ input }) => {
    const { query } = input
    const results = await db.select(...)
      .from(profiles)
      .where(or(
        ilike(profiles.email, `%${query}%`),
        ilike(profiles.fullName, `%${query}%`)
      ))
      .limit(10)
    // ... transform and return
  })
```

**Option B: Use listUsers and filter client-side (simpler for now):**
```typescript
const trpc = useTRPC()
const { data: allUsers } = useQuery(
  trpc.admin.listUsers.queryOptions(undefined, {
    enabled: isSuperAdmin && isSupportModeActive
  })
)

const results = useMemo(() => {
  if (!allUsers || !debouncedQuery || debouncedQuery.length < 2) return []
  const q = debouncedQuery.toLowerCase()
  return allUsers
    .filter(u =>
      u.email.toLowerCase().includes(q) ||
      (u.fullName?.toLowerCase().includes(q))
    )
    .slice(0, 10)
    .map(u => ({
      user_id: u.userId,
      email: u.email,
      full_name: u.fullName,
      organization_id: u.organizationId,
      organization_name: u.organizationName,
      role: u.role
    }))
}, [allUsers, debouncedQuery])
```

**Recommended: Option A (add search procedure) for better performance:**
- Add `searchUsers` procedure to admin.router.ts with proper ILIKE search
- Use useQuery with the search procedure, enabled when query length >= 2

**Implementation with new procedure:**
```typescript
const trpc = useTRPC()
const { data: searchResults, isLoading: isSearching } = useQuery(
  trpc.admin.searchUsers.queryOptions(
    { query: debouncedQuery },
    { enabled: debouncedQuery.length >= 2 && isSuperAdmin && isSupportModeActive }
  )
)

const results = useMemo(() => {
  if (!searchResults) return []
  return searchResults.map(u => ({
    user_id: u.userId,
    email: u.email,
    full_name: u.fullName,
    organization_id: u.organizationId,
    organization_name: u.organizationName,
    role: u.role
  }))
}, [searchResults])
```

**Remove:**
- The searchUsers useEffect (lines 56-117)
- The useState for isSearching (derived from query loading state)
- The manual setResults calls

**Keep:**
- handleSelectUser and handleImpersonate functions
- All UI rendering code
  </action>
  <verify>
    grep "supabase-placeholder" src/components/platform/GlobalUserSearch.tsx
    # Should return nothing
    npx tsc --noEmit
  </verify>
  <done>GlobalUserSearch uses tRPC for user search with admin.searchUsers procedure</done>
</task>

</tasks>

<verification>
```bash
# Verify no supabase imports in migrated files
grep -l "supabase-placeholder" \
  src/components/NotificationDropdown.tsx \
  src/components/LogTempModal.tsx \
  src/components/platform/GlobalUserSearch.tsx

# Should return nothing (empty output)

# TypeScript compilation
npx tsc --noEmit

# Run frontend tests
npm test -- --passWithNoTests
```
</verification>

<success_criteria>
- All 3 component files have zero imports from supabase-placeholder
- TypeScript compiles without errors
- NotificationDropdown shows alerts from tRPC
- LogTempModal can save temperature logs (online via tRPC, offline via sync)
- GlobalUserSearch finds users via tRPC admin procedure
</success_criteria>

<output>
After completion, create `.planning/phases/42-admin-debug-components/42-02-SUMMARY.md`
</output>
