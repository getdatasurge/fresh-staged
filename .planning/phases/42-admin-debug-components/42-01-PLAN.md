---
phase: 42-admin-debug-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/SuperAdminContext.tsx
  - src/components/admin/SensorSimulatorPanel.tsx
  - src/components/debug/RBACDebugPanel.tsx
  - src/components/debug/UnitDebugBanner.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - 'SuperAdminContext no longer imports from supabase-placeholder'
    - 'SensorSimulatorPanel fetches units via tRPC'
    - 'RBACDebugPanel displays debug info without supabase RPC calls'
    - 'UnitDebugBanner performs RLS checks via tRPC'
  artifacts:
    - path: 'src/contexts/SuperAdminContext.tsx'
      provides: 'Super admin context without supabase import'
    - path: 'src/components/admin/SensorSimulatorPanel.tsx'
      provides: 'Sensor simulator with tRPC data fetching'
    - path: 'src/components/debug/RBACDebugPanel.tsx'
      provides: 'RBAC debug panel without supabase'
    - path: 'src/components/debug/UnitDebugBanner.tsx'
      provides: 'Unit debug banner without supabase'
  key_links:
    - from: 'src/components/admin/SensorSimulatorPanel.tsx'
      to: 'trpc.units.listByOrg'
      via: 'useQuery'
      pattern: "trpc\\.units\\.listByOrg"
---

<objective>
Migrate 4 admin/debug components from supabase-placeholder to tRPC

Purpose: Complete ADMIN-01 through ADMIN-04 requirements - remove supabase imports from admin and debug components
Output: All 4 admin/debug components use tRPC or existing hooks for data fetching
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-pages-migration/41-01-SUMMARY.md
@.planning/phases/41-pages-migration/41-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate SuperAdminContext and RBACDebugPanel</name>
  <files>
    src/contexts/SuperAdminContext.tsx
    src/components/debug/RBACDebugPanel.tsx
  </files>
  <action>
**SuperAdminContext.tsx:**
- Remove import of `isSupabaseMigrationError` from `@/lib/supabase-placeholder`
- The context already uses Stack Auth and tRPC for most operations
- In the `checkSuperAdminStatus` function, the `isSupabaseMigrationError` check (line 208) can be removed since super admin check is already disabled with a TODO comment
- Simply remove the import and the error check that uses it - the catch block already handles errors appropriately

**RBACDebugPanel.tsx:**

- Remove import of `supabase, isSupabaseMigrationError` from `@/lib/supabase-placeholder`
- The direct RPC call to `is_current_user_super_admin` (line 62-73) is already broken since Supabase auth is removed
- Replace with display showing "RPC unavailable (migration complete)" or similar static message
- The `platform_roles` count check (line 84-91) should be removed - this was for debugging RLS which no longer applies
- Keep the component functional for displaying the SuperAdminContext state (which is the main purpose)
- Set `directRpcResult` to null and `directRpcError` to "Supabase RPC removed" as static values
- Remove the platformRolesCount state and its display section
  </action>
  <verify>
  grep -l "supabase-placeholder" src/contexts/SuperAdminContext.tsx src/components/debug/RBACDebugPanel.tsx | wc -l # Should return 0
  npx tsc --noEmit
  </verify>
  <done>SuperAdminContext and RBACDebugPanel have no supabase imports, TypeScript compiles</done>
  </task>

<task type="auto">
  <name>Task 2: Migrate SensorSimulatorPanel to tRPC</name>
  <files>src/components/admin/SensorSimulatorPanel.tsx</files>
  <action>
**SensorSimulatorPanel.tsx:**
- Replace `supabase, isSupabaseMigrationError` import with tRPC
- Add: `import { useTRPC } from '@/lib/trpc'` and `import { useQuery } from '@tanstack/react-query'`

**loadUnits function (lines 114-174):**

- Replace with tRPC useQuery:
  ```typescript
  const trpc = useTRPC();
  const {
    data: unitsData,
    isLoading: unitsLoading,
    refetch: refetchUnits,
  } = useQuery(
    trpc.units.listByOrg.queryOptions(
      { organizationId: organizationId! },
      {
        enabled: !!organizationId,
      },
    ),
  );
  ```
- Transform the tRPC response to match the Unit interface using useMemo:
  ```typescript
  const units = useMemo(() => {
    if (!unitsData) return [];
    return unitsData.map((u) => ({
      id: u.id,
      name: u.name,
      unit_type: u.unitType,
      temp_limit_high: u.tempLimitHigh,
      temp_limit_low: u.tempLimitLow,
      last_reading_at: u.lastReadingAt,
      last_temp_reading: u.lastTempReading,
      door_state: u.doorState,
      area: {
        name: u.areaName || '',
        site: { name: u.siteName || '' },
      },
    }));
  }, [unitsData]);
  ```
- Remove the `loadUnits` useCallback and the useEffect that calls it

**loadSimConfig function (lines 176-197):**

- Note: This queries `simulated_devices` table which is an internal dev tool table
- Keep using supabase.functions.invoke for the sensor-simulator edge function (line 249) as noted in the code comments (lines 231-234): "sensor-simulator edge function is intentionally kept as-is"
- For the simulated_devices query, this can remain as-is OR be removed since it's dev-only tooling
- Decision: Remove the supabase queries for simulated_devices and event_logs - show "Simulator config loading requires edge function" message when no config
- The invokeSimulator function that uses supabase.functions.invoke should show an error toast since edge functions are removed

**loadRecentEvents function (lines 199-213):**

- Remove this supabase query - it's for showing recent simulator events
- Set recentEvents to empty array always

**invokeSimulator function (lines 235-270):**

- The sensor-simulator edge function no longer exists after Supabase removal
- Replace the supabase.functions.invoke call with a toast.error message:
  ```typescript
  toast.error('Sensor simulator unavailable', {
    description: 'Edge function removed during migration. Use direct API for testing.',
  });
  ```
- Remove the isSupabaseMigrationError check

**Remove:**

- All useState for config, recentEvents that rely on supabase
- The useEffects that call loadSimConfig and loadRecentEvents

**Keep:**

- The UI structure and unit selection (now via tRPC)
- Show a banner explaining simulator edge function is unavailable
  </action>
  <verify>
  grep "supabase-placeholder" src/components/admin/SensorSimulatorPanel.tsx # Should return nothing
  npx tsc --noEmit
  </verify>
  <done>SensorSimulatorPanel uses tRPC for units, simulator functions show unavailable message</done>
  </task>

<task type="auto">
  <name>Task 3: Migrate UnitDebugBanner to tRPC</name>
  <files>src/components/debug/UnitDebugBanner.tsx</files>
  <action>
**UnitDebugBanner.tsx:**
- Remove import of `supabase` from `@/lib/supabase-placeholder`
- Add: `import { useTRPC } from '@/lib/trpc'` and `import { useQuery } from '@tanstack/react-query'`

**RLS check (lines 43-48):**

- The RLS check via profiles query is no longer meaningful since we're not using Supabase RLS
- Replace with a simple "auth check" that verifies user context exists:
  ```typescript
  const rlsCheck = user?.id ? 'ok' : 'fail';
  ```
- Remove the useEffect that does the supabase profiles query

**Door events count (lines 50-55):**

- Replace supabase query with tRPC using readings router (which has event log procedures from phase 39-03)
- Actually, door_events is a separate table - check if there's a tRPC procedure for it
- If no tRPC procedure exists, set doorEventsCount to null with a note "tRPC migration pending"
- Simpler approach: Remove the door events count check entirely since it's debug-only
  ```typescript
  const doorEventsCount = null; // Removed: door_events query migrated
  ```

**Final state:**

- Remove the checkData useEffect entirely
- Set rlsCheck based on user presence
- Set doorEventsCount to null (or keep the state but don't query)
- The banner still shows useful debug info: session, IDs, counts passed as props, realtime status
  </action>
  <verify>
  grep "supabase-placeholder" src/components/debug/UnitDebugBanner.tsx # Should return nothing
  npx tsc --noEmit
  </verify>
  <done>UnitDebugBanner has no supabase imports, shows debug info from props and user context</done>
  </task>

</tasks>

<verification>
```bash
# Verify no supabase imports in migrated files
grep -l "supabase-placeholder" \
  src/contexts/SuperAdminContext.tsx \
  src/components/admin/SensorSimulatorPanel.tsx \
  src/components/debug/RBACDebugPanel.tsx \
  src/components/debug/UnitDebugBanner.tsx

# Should return nothing (empty output)

# TypeScript compilation

npx tsc --noEmit

# Verify admin router still works (existing tests)

npm test -- --grep "admin" --passWithNoTests

```
</verification>

<success_criteria>
- All 4 admin/debug files have zero imports from supabase-placeholder
- TypeScript compiles without errors
- Components render without runtime errors (functional but simulator may show unavailable)
- SuperAdminContext continues to provide role state to the app
</success_criteria>

<output>
After completion, create `.planning/phases/42-admin-debug-components/42-01-SUMMARY.md`
</output>
```
