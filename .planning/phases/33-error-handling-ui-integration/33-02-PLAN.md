---
phase: 33-error-handling-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/components/LogTempModal.tsx
  - src/components/NotificationDropdown.tsx
  - src/contexts/SuperAdminContext.tsx
  - src/components/debug/RBACDebugPanel.tsx
  - src/pages/Onboarding.tsx
  - src/components/admin/SensorSimulatorPanel.tsx
autonomous: false

must_haves:
  truths:
    - "LogTempModal shows migration toast when Supabase insert fails"
    - "NotificationDropdown handles migration errors gracefully without crash"
    - "SuperAdminContext shows migration-aware error state"
    - "Components using placeholder display feature unavailable message"
  artifacts:
    - path: "src/components/LogTempModal.tsx"
      provides: "Migration-aware temperature logging"
      contains: "handleError"
    - path: "src/components/NotificationDropdown.tsx"
      provides: "Migration-aware notification loading"
      contains: "isSupabaseMigrationError"
    - path: "src/contexts/SuperAdminContext.tsx"
      provides: "Migration-aware admin context"
      contains: "isSupabaseMigrationError"
  key_links:
    - from: "src/components/LogTempModal.tsx"
      to: "src/lib/errorHandler.ts"
      via: "import handleError"
      pattern: "import.*handleError.*from.*errorHandler"
    - from: "src/components/NotificationDropdown.tsx"
      to: "src/lib/supabase-placeholder.ts"
      via: "import isSupabaseMigrationError"
      pattern: "import.*isSupabaseMigrationError"
---

<objective>
Wire migration error handling into key UI components that still use supabase-placeholder.

Purpose: Ensure users see helpful "feature unavailable" messages instead of cryptic errors or silent failures.
Output: 6 updated components with proper migration error handling and toast notifications.
</objective>

<execution_context>
@/home/swoop/.claude/get-shit-done/workflows/execute-plan.md
@/home/swoop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-error-handling-ui-integration/33-RESEARCH.md
@.planning/phases/33-error-handling-ui-integration/33-01-SUMMARY.md
@src/lib/errorHandler.ts
@src/lib/supabase-placeholder.ts
@src/components/errors/MigrationErrorBoundary.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update UI components with migration error handling</name>
  <files>
src/components/LogTempModal.tsx
src/components/NotificationDropdown.tsx
src/contexts/SuperAdminContext.tsx
src/components/debug/RBACDebugPanel.tsx
src/pages/Onboarding.tsx
src/components/admin/SensorSimulatorPanel.tsx
  </files>
  <action>
Update each component to handle SupabaseMigrationError gracefully:

**1. LogTempModal.tsx:**
Add import at top:
```typescript
import { handleError } from "@/lib/errorHandler";
import { isSupabaseMigrationError } from "@/lib/supabase-placeholder";
```

Update catch block in handleSubmit (around line 164):
```typescript
} catch (error) {
  console.error("Error saving log:", error);

  // Show migration-specific message instead of silently falling back to offline
  if (isSupabaseMigrationError(error)) {
    handleError(error, "save temperature log");
    // Still save offline as fallback
    await saveLogOffline(logEntry);
    onOpenChange(false);
    onSuccess?.();
    setIsSubmitting(false);
    return;
  }

  // Original fallback for network errors
  await saveLogOffline(logEntry);
  toast({
    title: "Saved offline",
    description: "Will sync when back online",
    variant: "default",
  });
  onOpenChange(false);
  onSuccess?.();
}
```

**2. NotificationDropdown.tsx:**
Add import at top:
```typescript
import { isSupabaseMigrationError } from "@/lib/supabase-placeholder";
```

Update loadNotifications catch block (around line 163):
```typescript
} catch (error) {
  console.error("Error loading notifications:", error);
  if (isSupabaseMigrationError(error)) {
    // Don't show toast for background loading - just log and show empty
    console.warn("[NotificationDropdown] Notifications unavailable during migration");
  }
  setNotifications([]);
}
```

Update shouldShowToast catch block (around line 203):
```typescript
} catch (error) {
  // Silently fail for migration errors - notification policy not available
  if (!isSupabaseMigrationError(error)) {
    console.error("Error checking notification policy:", error);
  }
  return false;
}
```

**3. SuperAdminContext.tsx:**
Add import at top (if not present):
```typescript
import { isSupabaseMigrationError } from "@/lib/supabase-placeholder";
```

Update the error handling in checkSuperAdminStatus to set a migration-specific error message:
```typescript
if (isSupabaseMigrationError(error)) {
  setRoleLoadError("Super admin check unavailable during migration");
} else {
  setRoleLoadError(error instanceof Error ? error.message : 'Unknown error');
}
```

**4. RBACDebugPanel.tsx:**
Add import at top (if not present):
```typescript
import { isSupabaseMigrationError } from "@/lib/supabase-placeholder";
```

Update the direct RPC call error handling (around line 62):
```typescript
try {
  const { data, error } = await supabase.rpc('is_current_user_super_admin');
  if (error) {
    if (isSupabaseMigrationError(error)) {
      setDirectRpcError('RPC unavailable during migration');
    } else {
      setDirectRpcError(error.message);
    }
    setDirectRpcResult(null);
  } else {
    setDirectRpcResult(data);
    setDirectRpcError(null);
  }
} catch (err) {
  if (isSupabaseMigrationError(err)) {
    setDirectRpcError('RPC unavailable during migration');
  } else {
    setDirectRpcError(err instanceof Error ? err.message : 'Unknown error');
  }
}
```

**5. Onboarding.tsx:**
Add import and wrap key sections in try-catch with migration error handling.
Check for any supabase.functions.invoke calls and update error handling similarly.

**6. SensorSimulatorPanel.tsx:**
This is admin-only dev tool. Add a simple migration check at the start of any Supabase operations:
```typescript
import { isSupabaseMigrationError } from "@/lib/supabase-placeholder";
import { toast } from "sonner";

// In relevant function:
if (isSupabaseMigrationError(error)) {
  toast.error("Sensor simulator unavailable during migration");
  return;
}
```

For all components, ensure:
- Migration errors show user-friendly messages
- Components don't crash on migration errors
- Background operations (like notification loading) fail silently with logging
- User-initiated operations (like form submit) show toast feedback
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Verify imports added: `grep -l "isSupabaseMigrationError" src/components/LogTempModal.tsx src/components/NotificationDropdown.tsx src/contexts/SuperAdminContext.tsx`
3. Run lint: `npm run lint -- --fix`
  </verify>
  <done>
- All 6 components import isSupabaseMigrationError or handleError
- Migration errors handled gracefully without crashes
- User-facing operations show toast with feature unavailable message
- Background operations fail silently with console logging
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Migration error handling wired to 6 UI components</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to any page that uses supabase-placeholder (e.g., /dashboard)
3. Open browser DevTools console
4. Verify console shows: `[supabase-placeholder] Supabase calls are disabled.`
5. Verify NO crashes or unhandled errors in console
6. Check that any toast notifications show "temporarily unavailable" messaging (if component triggers placeholder)
7. Verify app remains functional (navigation works, non-placeholder features work)
  </how-to-verify>
  <resume-signal>Type "approved" if no crashes and migration errors handled gracefully, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. No unhandled promise rejections in browser console
3. Migration errors show user-friendly messages
4. App remains stable when placeholder is triggered
</verification>

<success_criteria>
- [ ] LogTempModal shows migration toast on save failure
- [ ] NotificationDropdown loads without crash
- [ ] SuperAdminContext shows migration-specific error state
- [ ] RBACDebugPanel shows "unavailable during migration" status
- [ ] All components type-check
- [ ] User confirms app is stable
</success_criteria>

<output>
After completion, create `.planning/phases/33-error-handling-ui-integration/33-02-SUMMARY.md`
</output>
