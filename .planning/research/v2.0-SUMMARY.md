# Research Summary: FreshTrack Pro v2.0

**Domains:** Real-Time, Background Jobs, Billing, API Migration
**Researched:** 2026-01-24
**Overall Confidence:** HIGH

## Executive Summary

v2.0 research confirms all target features are technically feasible with the existing stack. The research reveals clear implementation paths for each domain:

1. **Real-Time:** Socket.io v4 + Fastify via `fastify-socket.io` plugin with Redis adapter for horizontal scaling. Multi-tenant isolation via organization rooms. React integration with TanStack Query through imperative cache updates.

2. **Background Jobs:** BullMQ as the job queue (TypeScript-first, Redis-backed). Separate worker containers from API. Telnyx SMS integration patterns derived from existing Edge Function code. Cron scheduling via Job Schedulers API.

3. **Billing:** Stripe Node v19 with V2 Billing Meters API for IoT usage metering. Fastify webhook handling requires `rawBody: true`. Customer Portal recommended for v2.0 (faster than custom UI).

4. **API Migration:** Strangler Fig pattern with tRPC for type-safe API layer. Incremental migration domain-by-domain with feature flags for instant rollback. Enables AUTH-02 completion (Supabase client removal).

## Key Findings Summary

### Real-Time (Socket.io)

| Aspect       | Recommendation                          | Confidence |
| ------------ | --------------------------------------- | ---------- |
| Integration  | `fastify-socket.io` plugin              | HIGH       |
| Scaling      | Redis adapter (sharded for Redis 7+)    | HIGH       |
| Multi-tenant | Room-based (`org:${orgId}`)             | HIGH       |
| React        | Imperative `queryClient.setQueryData()` | HIGH       |
| Auth         | JWT middleware on connection            | HIGH       |

**Effort:** ~49 hours (1.5 weeks)

### Background Jobs (BullMQ)

| Aspect     | Recommendation                      | Confidence |
| ---------- | ----------------------------------- | ---------- |
| Queue      | BullMQ v5.16+                       | HIGH       |
| SMS        | Telnyx with custom backoff strategy | HIGH       |
| Email      | Job Schedulers with cron patterns   | HIGH       |
| Deployment | Separate worker containers          | HIGH       |
| Dashboard  | Bull Board for monitoring           | HIGH       |

**Effort:** ~4 weeks

### Billing (Stripe)

| Aspect       | Recommendation           | Confidence |
| ------------ | ------------------------ | ---------- |
| SDK          | Stripe Node v19.1.0      | HIGH       |
| Metering     | V2 Billing Meters API    | HIGH       |
| Self-service | Customer Portal          | HIGH       |
| Webhooks     | rawBody: true in Fastify | HIGH       |
| Testing      | Test Clocks + Stripe CLI | HIGH       |

**Effort:** ~6 weeks

### API Migration (tRPC)

| Aspect      | Recommendation              | Confidence |
| ----------- | --------------------------- | ---------- |
| Strategy    | Strangler Fig (incremental) | HIGH       |
| API Layer   | tRPC (zero code-gen)        | HIGH       |
| Type Safety | Export AppRouter type       | HIGH       |
| Rollback    | Feature flags per domain    | HIGH       |
| Validation  | Parallel run testing        | HIGH       |

**Effort:** ~8-9 weeks

## Implications for Roadmap

### Recommended Phase Structure

Based on dependencies and risk profiles:

**Phase 14: Real-Time Foundation**

- Socket.io + Fastify + Redis adapter
- JWT authentication on WebSocket
- Multi-tenant room architecture
- Enables: Live dashboard updates

**Phase 15: Background Jobs Infrastructure**

- BullMQ setup with Fastify
- Worker container configuration
- Dashboard (Bull Board)
- Enables: Async processing for SMS/email

**Phase 16: SMS Notifications**

- Telnyx integration via BullMQ workers
- Alert notification delivery
- Retry strategies with error code mapping
- Depends on: Phase 15

**Phase 17: Email Digests**

- Scheduled job configuration
- Digest generation workers
- Timezone-aware scheduling
- Depends on: Phase 15

**Phase 18: Stripe Billing**

- Subscription management
- Usage metering (sensors, readings)
- Customer Portal integration
- Webhook handling

**Phase 19: Backend API Migration - Foundation**

- tRPC infrastructure setup
- Pilot migration (organizations domain)
- Feature flag system
- Enables: AUTH-02 completion

**Phase 20: Backend API Migration - Core**

- Sites, units, readings migration
- Alerts migration
- Parallel run validation
- Depends on: Phase 19

**Phase 21: Backend API Migration - Completion**

- Settings, admin features migration
- Supabase client removal (AUTH-02)
- Cleanup and verification
- Depends on: Phase 20

**Phase 22: AWS ECS Deployment (Optional)**

- ECS/Fargate infrastructure
- Multi-region support
- Depends on: Phases 14-21 complete

### Phase Ordering Rationale

1. **Real-time first** — Enables live dashboard updates, most visible user value
2. **Background jobs second** — Infrastructure needed for SMS/email features
3. **SMS before email** — Alerts are time-critical, digests can wait
4. **Billing parallel-capable** — Independent of real-time/jobs, can overlap
5. **API migration late** — Least user-visible, highest effort, lowest risk when stable

### Research Flags for Phases

- **Phase 14:** Standard patterns, unlikely to need more research
- **Phase 15:** Standard patterns, BullMQ well-documented
- **Phase 16:** May need Telnyx-specific research for rate limiting
- **Phase 18:** Likely needs phase-specific research on usage metering edge cases
- **Phase 19:** Research complete, tRPC patterns clear
- **Phase 22:** Likely needs deeper research on AWS ECS configuration

## Technology Stack Additions

| Technology               | Version | Purpose                      |
| ------------------------ | ------- | ---------------------------- |
| socket.io                | 4.x     | Real-time communication      |
| @socket.io/redis-adapter | 8.x     | Socket.io horizontal scaling |
| fastify-socket.io        | 2.x     | Fastify integration          |
| bullmq                   | 5.16+   | Job queue                    |
| @trpc/server             | 11.x    | Type-safe API layer          |
| @trpc/client             | 11.x    | Frontend client              |
| @trpc/react-query        | 11.x    | TanStack Query integration   |
| stripe                   | 19.x    | Billing SDK                  |

## Gaps to Address

1. **Telnyx rate limiting specifics** — Need to validate during Phase 16 planning
2. **Usage meter billing cycle edge cases** — Research during Phase 18 planning
3. **AWS ECS configuration** — Research when Phase 22 starts

## Confidence Assessment

| Area                 | Confidence | Notes                                      |
| -------------------- | ---------- | ------------------------------------------ |
| Real-Time            | HIGH       | Context7 + official docs verified          |
| Background Jobs      | HIGH       | Official BullMQ docs + production patterns |
| Billing              | HIGH       | Context7 Stripe docs verified              |
| API Migration        | HIGH       | tRPC patterns well-established             |
| Overall Architecture | HIGH       | All components integrate cleanly           |

---

_Research completed: 2026-01-24_
_Ready for requirements definition and roadmap creation_
