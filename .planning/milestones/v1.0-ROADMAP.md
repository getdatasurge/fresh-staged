# Milestone v1.0: Self-Hosted MVP

**Status:** SHIPPED 2026-01-23
**Phases:** 1-7
**Total Plans:** 47

## Overview

Migration from Supabase to self-hosted stack in 7 phases. Each phase produced a working increment. Strategy: Freeze+Backfill cutover (not dual-write).

## Phases

### Phase 1: Local Development Environment

**Goal**: Developers can run all infrastructure services locally with a single command.
**Depends on**: None
**Plans**: 5 plans

Plans:

- [x] 01-01-PLAN.md — Backend project setup (package.json, tsconfig, drizzle config)
- [x] 01-02-PLAN.md — Foundation schemas (enums, tenancy, users, hierarchy)
- [x] 01-03-PLAN.md — Device and telemetry schemas
- [x] 01-04-PLAN.md — Alerts, notifications, and audit schemas
- [x] 01-05-PLAN.md — Schema index update and migration verification

**Details:**

- Backend TypeScript project with pnpm package manager
- Drizzle ORM configuration with PostgreSQL connection
- 14 PostgreSQL enum definitions for all domain entities
- 22 database tables across 9 schema modules
- Docker Compose with PostgreSQL, Redis, MinIO

**Requirements Covered:**

- INFRA-01: Docker Compose with PostgreSQL, Redis, MinIO
- INFRA-02: Development scripts (up.sh, down.sh, reset.sh)
- INFRA-03: Environment template documented
- DB-01 through DB-05: All database requirements

---

### Phase 2: Authentication & RBAC

**Goal**: Users can authenticate via Stack Auth and access is controlled by role.
**Depends on**: Phase 1
**Plans**: 5 plans

Plans:

- [x] 02-01-PLAN.md — Auth foundation (types, JWT verification utility)
- [x] 02-02-PLAN.md — Auth plugin and requireAuth middleware
- [x] 02-03-PLAN.md — RBAC middleware with role hierarchy
- [x] 02-04-PLAN.md — Organization context and user service
- [x] 02-05-PLAN.md — Integration tests for auth flows

**Details:**

- JWT verification utility using jose library with JWKS caching
- requireAuth middleware validates JWT tokens from Authorization header
- Role hierarchy constants with 5 levels (viewer=1 through owner=5)
- Organization context middleware validates user's org membership
- 10 passing tests (4 auth + 6 RBAC)

**Requirements Covered:**

- AUTH-01 through AUTH-06: All authentication requirements
- RBAC-01 through RBAC-05: All RBAC requirements

---

### Phase 3: Core API Endpoints

**Goal**: CRUD operations for organizations, sites, areas, and units are available.
**Depends on**: Phase 2
**Plans**: 6 plans

Plans:

- [x] 03-01-PLAN.md — Zod validation setup and common schemas
- [x] 03-02-PLAN.md — Organization routes and service
- [x] 03-03-PLAN.md — Sites CRUD routes and service
- [x] 03-04-PLAN.md — Areas CRUD with hierarchy validation
- [x] 03-05-PLAN.md — Units CRUD with full hierarchy validation
- [x] 03-06-PLAN.md — Integration tests for all endpoints

**Details:**

- Zod validation with Fastify type provider
- Service layer pattern separating business logic from routes
- Hierarchy validation preventing BOLA attacks
- Soft delete pattern with isActive flag
- 81 new tests (91 total for backend)

**Requirements Covered:**

- API-01 through API-06: All core API requirements

---

### Phase 4: Sensor Data & Alert System

**Goal**: Readings can be ingested and alerts are triggered on threshold violations.
**Depends on**: Phase 3
**Plans**: 5 plans

Plans:

- [x] 04-01-PLAN.md — API key auth middleware and readings service foundation
- [x] 04-02-PLAN.md — Alert evaluator service with state machine
- [x] 04-03-PLAN.md — Readings routes with alert evaluation integration
- [x] 04-04-PLAN.md — Alert service and routes (acknowledge, resolve)
- [x] 04-05-PLAN.md — Integration tests for readings and alerts

**Details:**

- API key authentication with constant-time comparison (timing attack prevention)
- Readings service with 500-record batching and atomic transactions
- Alert evaluator state machine: ok → excursion → alarm_active → restoring → ok
- Rule hierarchy resolution: unit > site > org precedence
- Alert deduplication via status-based idempotency

**Requirements Covered:**

- SENS-01 through SENS-04: All sensor data requirements
- ALRT-01 through ALRT-06: All alert system requirements

---

### Phase 5: Frontend Migration

**Goal**: React app uses new API instead of Supabase client.
**Depends on**: Phase 4
**Plans**: 14 plans

Plans:

- [x] 05-01-PLAN.md — API client infrastructure (Ky, types, error handling)
- [x] 05-02-PLAN.md — Entity API modules (organizations, sites, areas, units)
- [x] 05-03-PLAN.md — Readings and alerts API modules
- [x] 05-04-PLAN.md — Auth/me endpoint and identity hooks
- [x] 05-05-PLAN.md — Navigation hooks (useNavTree, useBranding, useSoftDelete)
- [x] 05-06-PLAN.md — Alert hooks (useAlertRules, useUnitAlerts, useUnitStatus)
- [x] 05-07-PLAN.md — Site location and notification hooks
- [x] 05-08-PLAN.md — TTN config hooks (useTTNSettings, useTTNApiKey, useTTNWebhook)
- [x] 05-09-PLAN.md — Utility hooks (useAccountDeletion, useAuditedWrite, useBatteryForecast)
- [x] 05-10-PLAN.md — Permission hook and environment configuration
- [x] 05-11-PLAN.md — Unit tests for API client and hooks
- [x] 05-12-PLAN.md — Integration verification (human checkpoint)
- [x] 05-13-PLAN.md — Device hooks (useLoraSensors, useGateways, useSetPrimarySensor)
- [x] 05-14-PLAN.md — TTN provisioning hooks (useTTNSetupWizard, useTTNDeprovision)

**Details:**

- Ky HTTP client with 30s timeout, 3-attempt retry, exponential backoff
- 27+ hooks migrated from Supabase to Stack Auth
- Stack Auth React SDK integrated for identity management
- API modules for all backend endpoints
- 45 unit tests for API client and hooks

**Requirements Covered:**

- FE-01: Typed API client
- FE-02: Stack Auth token management
- FE-03: All hooks migrated (PARTIAL - ~30 hooks retain Supabase auth calls)
- FE-04: React Query caching preserved
- FE-05: Tests pass

---

### Phase 6: Data Migration Scripts

**Goal**: Scripts can export Supabase data and import it to new database.
**Depends on**: Phase 5
**Plans**: 6 plans

Plans:

- [x] 06-01-PLAN.md — Migration infrastructure (logger, DB clients, table metadata)
- [x] 06-02-PLAN.md — Export script (stream tables to JSON)
- [x] 06-03-PLAN.md — User migration (Stack Auth users, ID mapping)
- [x] 06-04-PLAN.md — Import script (load JSON with user ID mapping)
- [x] 06-05-PLAN.md — Verification script (row counts, checksums)
- [x] 06-06-PLAN.md — Migration runbook documentation

**Details:**

- Pino logger with dual console/file output
- Streaming export for large tables (pg-query-stream)
- Stack Auth user migration with 90-day mapping retention
- Import with 500-row batch inserts and FK constraint control
- MD5 checksum verification excluding mapped user ID columns
- 342-line migration runbook

**Requirements Covered:**

- MIG-01 through MIG-07: All data migration requirements

---

### Phase 7: Production Deployment & Cutover

**Goal**: System deployed to production and serving live traffic.
**Depends on**: Phase 6
**Plans**: 6 plans

Plans:

- [x] 07-01-PLAN.md — Production infrastructure foundation (Dockerfile, compose.production.yaml)
- [x] 07-02-PLAN.md — Caddy reverse proxy and health check endpoint
- [x] 07-03-PLAN.md — Observability stack (Prometheus, Loki, Grafana)
- [x] 07-04-PLAN.md — Deployment and rollback scripts
- [x] 07-05-PLAN.md — Status page (Uptime Kuma) and documentation
- [x] 07-06-PLAN.md — Staging rehearsal and production cutover (checkpoints)

**Details:**

- Docker multi-stage build with production target
- Caddy with automatic HTTPS and security headers
- Prometheus + Grafana + Loki + Promtail observability stack
- Pre-flight health check script, deploy.sh, rollback.sh
- Uptime Kuma status page
- 10 issues discovered and fixed during staging rehearsal

**Requirements Covered:**

- PROD-01 through PROD-04: Infrastructure requirements complete
- PROD-05: Cutover procedure documented (PARTIAL - data migration pending)

---

## Milestone Summary

**Key Decisions:**

- Fastify over Express: Better TypeScript support, schema validation, plugin system
- Drizzle ORM over Prisma: Type-safe, SQL-like API, better migration control
- Stack Auth hosted service: Reduces auth complexity
- Freeze+Backfill over Dual-Write: Simpler, lower risk, acceptable downtime
- Ky over Axios: Lightweight (157KB), built-in retry

**Issues Resolved:**

- PgBouncer image unavailable (disabled, using direct connections)
- drizzle-kit ESM loading issues (glob pattern solution)
- Fastify mock serialization in tests (deferred to integration suite)
- Multiple staging configuration issues fixed during rehearsal

**Issues Deferred:**

- FE-03: ~30 hooks still use Supabase auth (marked TODO Phase 6/v1.1)
- PROD-05: Data migration execution (pending Supabase access)
- Alert rules CRUD endpoints (returning defaults)
- Integration test suite for alert lifecycle

**Technical Debt Incurred:**

- Frontend hooks using Supabase auth mixed with Stack Auth identity
- verify.ts checksum comparison not tested against production data
- Some edge functions still validate Supabase session

---

_Archived: 2026-01-23_
_For current project status, see .planning/ROADMAP.md (created for next milestone)_
