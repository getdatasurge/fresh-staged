# Milestone v2.7: tRPC Client Fix

**Status:** SHIPPED 2026-01-30
**Phases:** 46-48
**Total Plans:** 5

## Overview

Fix the tRPC runtime crash that prevents React from mounting in production. The deployment infrastructure works (14 containers, API healthy, SSL) but the SPA never renders due to incompatible tRPC proxy calls.

**Root Cause:** `TypeError: e[i] is not a function` — 30+ call sites use `.mutate()`/`.query()` on `useTRPC()` proxy, which only supports `.mutationOptions()`/`.queryOptions()` in `@trpc/tanstack-react-query` v11.

**Contributing Factors:**
1. Phantom `@trpc/react-query` dependency bundled (not imported)
2. tRPC version mismatch (server 11.9.0, client 11.8.1)
3. Zod major version mismatch (frontend v3, backend v4)

## Phases

### Phase 46: Dependency Cleanup

**Goal**: Remove phantom dependency, pin tRPC versions, align Zod
**Depends on**: Nothing (foundation for proxy fixes)
**Requirements**: DEP-01, DEP-02, DEP-03
**Plans**: 1 plan

Plans:
- [x] 46-01: Remove phantom dep, pin tRPC versions, upgrade Zod

**Success Criteria:**
1. `@trpc/react-query` removed from package.json (no longer bundled)
2. All tRPC packages pinned to exact version 11.9.0
3. Frontend Zod upgraded to v4 matching backend
4. `pnpm install` succeeds with no peer dependency warnings for tRPC
5. `pnpm run build` succeeds

---

### Phase 47: tRPC Proxy Call Migration

**Goal**: Fix all `.mutate()` and `.query()` calls on `useTRPC()` proxy to use correct v11 API
**Depends on**: Phase 46 (clean dependencies required first)
**Requirements**: TRPC-01, TRPC-02, TRPC-03, TRPC-04
**Plans**: 3 plans

Plans:
- [x] 47-01: Fix .mutate()/.query() calls in hooks (useAlertRules, useAlertRulesHistory, useWidgetHealthMetrics, useSiteLocationMutation)
- [x] 47-02: Fix .mutate()/.query() calls in features (useEntityLayoutStorage, BillingTab)
- [x] 47-03: Fix .mutate()/.query() calls in pages/widgets (Inspector, PilotSetup, SiteAlertsSummaryWidget, AlertHistoryWidget) + full codebase verification

**Success Criteria:**
1. Zero `.mutate()` calls remain on `useTRPC()` proxy — all use `useTRPCClient()` instead
2. Zero `.query()` calls remain on `useTRPC()` proxy — all use `useTRPCClient()` instead
3. React mounts successfully (`#root` has children)
4. All existing frontend tests pass
5. `pnpm run build` produces working bundle

---

### Phase 48: Production Redeploy & Verification

**Goal**: Rebuild and redeploy frontend to production, verify app renders
**Depends on**: Phase 47 (all proxy calls fixed)
**Requirements**: PROD-01, PROD-02, PROD-03
**Plans**: 1 plan

Plans:
- [x] 48-01: Rebuild frontend, redeploy to VM, run Playwright verification

**Success Criteria:**
1. Frontend rebuilt with fixed tRPC calls
2. Frontend container redeployed on 192.168.4.181
3. App renders in browser (React mounts, page content visible)
4. Playwright smoke tests pass with React rendering confirmed
5. No `TypeError: e[i] is not a function` in browser console

---

## Dependency Graph

```
Phase 46 (Dependency Cleanup)
    |
    v
Phase 47 (tRPC Proxy Call Migration)
    |
    v
Phase 48 (Production Redeploy & Verification)
```

All phases sequential — each depends on the previous.

## Milestone Summary

**Key Decisions:**
- Fix pattern: `.mutate()`/`.query()` → `useTRPCClient()` (vanilla client supports these methods)
- Keep `useTRPC()` alongside `useTRPCClient()` in files that use both `.queryOptions()` and imperative calls
- Replace `useTRPC()` entirely with `useTRPCClient()` in files that only use imperative calls
- Production URL: relative URLs (empty string fallback) behind Caddy reverse proxy
- Caddy uses port-based matching (`:443`/`:80`) for IP deployments
- Self-signed SSL certs for IP 192.168.4.181 (no domain)

**Issues Resolved:**
- `TypeError: e[i] is not a function` — eliminated by migrating all 30+ proxy misuse sites
- Frontend calling `localhost:3000` in production — fixed by using `import.meta.env.DEV` ternary
- Missing Caddy routes for `/trpc/*` and `/socket.io/*` — added reverse proxy routes
- Caddy hostname matching failure on IP — changed to port-based matching

**Issues Deferred:**
- ServiceWorker registration fails due to self-signed cert (non-blocking)
- `useSuperAdmin` context error (pre-existing, not v2.7 related)

**Technical Debt Incurred:**
- None — this milestone was purely a fix milestone

---

*Archived: 2026-01-30 as part of v2.7 milestone completion*
*For current project status, see .planning/ROADMAP.md*
