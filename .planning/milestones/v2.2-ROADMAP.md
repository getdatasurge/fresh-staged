# Milestone v2.2: Technical Debt & Stabilization

**Status:** ✅ SHIPPED 2026-01-29
**Phases:** 27-33 (Phase 29 skipped)
**Total Plans:** 27

## Overview

Milestone goal was to eliminate Supabase dependency and stabilize TTN integration for long-term maintainability. All edge function calls migrated to tRPC (except intentional sensor-simulator placeholder). Error handling integrated throughout UI. tRPC pattern standardized across 165+ call sites.

## Phases

### Phase 27: TTN SDK Integration

**Goal**: Eliminate Supabase Edge Functions for TTN integration by porting logic to Backend Services
**Depends on**: Phase 21 (tRPC infrastructure)
**Plans**: 5 plans

Plans:

- [x] 27-01: Port TTN settings read to tRPC
- [x] 27-02: Port TTN connection test to tRPC
- [x] 27-03: Port API key validation to tRPC
- [x] 27-04: Port webhook updates to tRPC
- [x] 27-05: Clean up edge function references

**Status**: ✓ PASSED - Backend owns entire TTN lifecycle

---

### Phase 28: Supabase Removal

**Goal**: Complete migration of all frontend pages to tRPC and eliminate Supabase dependency
**Depends on**: Phase 27
**Plans**: 7 plans (7 waves)

Plans:

- [x] 28-01: Wave 1 - Audit & Event Logging
- [x] 28-02: Wave 2 - Site & Alert Settings
- [x] 28-03: Wave 3 - Alert Rules & History
- [x] 28-04: Wave 4 - System Pages & Sync
- [x] 28-05: Wave 5 - Core Entity Dashboards
- [x] 28-06: Wave 6 - Detail Views & Maintenance
- [x] 28-07: Wave 7 - Platform Admin & Remaining Cleanup

**Status**: ~ PARTIAL - Original gaps addressed by Phases 31, 32, 33

---

### Phase 29: Production Data Migration

**Goal**: Migrate data from Supabase production to self-hosted PostgreSQL
**Depends on**: Phase 28
**Plans**: 0 (skipped)

**Status**: ⊘ SKIPPED - No access to Supabase production database

---

### Phase 30: System Hardening

**Goal**: Final security audit and performance tuning
**Depends on**: Phase 28
**Plans**: 4 plans

Plans:

- [x] 30-01: Backend security headers (@fastify/helmet), body limits, request timeout
- [x] 30-02: Dependency vulnerability audit (npm audit fix)
- [x] 30-03: Enhanced supabase-placeholder error handling
- [x] 30-04: Integration verification

**Status**: ✓ PASSED - 13/13 must-haves verified

---

### Phase 31: TTN Provisioning UI Migration (GAP CLOSURE)

**Goal**: Wire TTN provisioning UI to Phase 27 tRPC endpoints
**Closes**: Integration gap (TTN UI → tRPC), Flow gap (TTN Organization Provisioning)
**Plans**: 3 plans

Plans:

- [x] 31-01: Add missing tRPC procedures for TTN provisioning
- [x] 31-02: Migrate TTNCredentialsPanel to tRPC
- [x] 31-03: Add integration tests and verify UI

**Status**: ✓ PASSED - 6/6 must-haves verified

---

### Phase 32: Remaining Edge Function Migration (GAP CLOSURE)

**Goal**: Migrate remaining supabase.functions.invoke calls to tRPC
**Closes**: 15 remaining edge function calls in 12 files
**Plans**: 6 plans

Plans:

- [x] 32-01: Migrate TTN domain (EmulatorTTNRoutingCard, Onboarding)
- [x] 32-02: Create reports router + migrate 3 export files
- [x] 32-03: Create telnyx router + migrate 4 Telnyx files
- [x] 32-04: Add ttnDevices.diagnose + cleanup dead code
- [x] 32-05: Gap closure: Implement reports.export with real database queries
- [x] 32-06: Gap closure: Implement Telnyx API integration (verification + webhook)

**Status**: ✓ PASSED - 13/13 must-haves verified

---

### Phase 33: Error Handling UI Integration (GAP CLOSURE)

**Goal**: Wire SupabaseMigrationError to UI error boundaries for user-friendly error messages
**Closes**: Integration gap (SupabaseMigrationError → UI consumers)
**Plans**: 3 plans

Plans:

- [x] 33-01: Extend errorHandler.ts + create MigrationErrorBoundary components
- [x] 33-02: Wire UI components + visual verification
- [x] 33-03: Gap closure: Integrate MigrationErrorBoundary into DashboardLayout + tRPC pattern fix

**Status**: ✓ PASSED - 7/7 must-haves verified

---

## Milestone Summary

**Gap Closure Phases:**

- Phase 31: TTN Provisioning UI Migration (closed TTN provisioning flow gap)
- Phase 32: Remaining Edge Function Migration (closed 15 edge function calls)
- Phase 33: Error Handling UI Integration (closed error boundary integration gap)

**Key Decisions:**

| Phase | Decision                                         | Rationale                                             |
| ----- | ------------------------------------------------ | ----------------------------------------------------- |
| 30-01 | CSP allows 'unsafe-inline' for scripts/styles    | Required for React SPA hydration                      |
| 30-01 | HSTS disabled at app level                       | Handled by reverse proxy in production                |
| 31-01 | Use Drizzle schema extension for ttn_connections | Type-safe access to provisioning fields               |
| 31-01 | SafeDecrypt pattern returns { value, status }    | Track empty vs decrypted vs failed states             |
| 32-02 | Shared export mutation across all 3 components   | Single tRPC procedure replaces 3 edge function calls  |
| 32-06 | Map Telnyx statuses to simplified enum           | UI needs simple categories, not all Telnyx variations |
| 33-03 | Use createTRPCContext (queryOptions pattern)     | ~80 files use this pattern vs ~20 using direct hooks  |
| 33-03 | MigrationErrorBoundary wraps children only       | Preserve header/sidebar on page errors                |

**Issues Resolved:**

- TTN provisioning UI now wired to tRPC backend (was calling non-existent edge functions)
- Reports export returns real data (was returning placeholder content)
- Telnyx integration uses real API calls (was returning hardcoded values)
- tRPC pattern crash fixed (createTRPCContext vs createTRPCReact mismatch)
- Error boundaries integrated into render tree (was orphaned component)

**Issues Deferred:**

- 53 test failures need mock updates (38 frontend, 15 backend pre-existing)
- SensorSimulatorPanel edge function call kept (admin testing tool)

**Technical Debt Incurred:**

- supabase-placeholder.ts remains (intentional - provides graceful degradation)
- Test mocks need updating for tRPC pattern changes

---

_For current project status, see .planning/ROADMAP.md_

---

_Archived: 2026-01-29 as part of v2.2 milestone completion_
