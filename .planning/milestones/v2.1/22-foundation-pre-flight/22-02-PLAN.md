---
phase: 22-foundation-pre-flight
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/preflight-lib.sh
autonomous: true

must_haves:
  truths:
    - "Running script on under-resourced VM shows clear error explaining minimum RAM requirement"
    - "Running script on under-resourced VM shows clear error explaining minimum disk requirement"
    - "Running script on unsupported OS shows clear error with supported OS list"
    - "Running script without network connectivity shows error explaining what URLs must be reachable"
  artifacts:
    - path: "scripts/lib/preflight-lib.sh"
      provides: "System validation functions for RAM, disk, CPU, OS, network"
      exports: ["validate_ram", "validate_disk", "validate_cpu", "validate_os", "validate_network"]
      contains: ["MemAvailable", "/etc/os-release", "registry-1.docker.io"]
  key_links:
    - from: "scripts/lib/preflight-lib.sh"
      to: "/proc/meminfo"
      via: "grep MemAvailable"
      pattern: "grep.*MemAvailable.*/proc/meminfo"
    - from: "scripts/lib/preflight-lib.sh"
      to: "/etc/os-release"
      via: "source file"
      pattern: "source.*/etc/os-release"
---

<objective>
Add system validation functions to preflight-lib.sh for resource and environment checks.

Purpose: Enable pre-flight validation of system resources (RAM, disk, CPU), OS compatibility, and network connectivity before any deployment modifications.

Output: Five validation functions added to `scripts/lib/preflight-lib.sh` that can run independently of error handling setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-foundation-pre-flight/22-RESEARCH.md
@scripts/health-check.sh (for check counter pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RAM, disk, and CPU validation functions</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Add the following validation functions to `scripts/lib/preflight-lib.sh` BEFORE the self-test block:

**1. validate_ram function:**
```bash
# PREFLIGHT-01: Validate minimum RAM available
# Args: $1 = minimum MB required (default: 2048 for FreshTrack)
# Returns: 0 if sufficient, 1 if insufficient
validate_ram() {
    local min_mb="${1:-2048}"

    if [[ ! -f /proc/meminfo ]]; then
        error "Cannot read /proc/meminfo - is this Linux?"
        return 1
    fi

    local available_kb
    available_kb=$(grep MemAvailable /proc/meminfo | awk '{print $2}')

    if [[ -z "$available_kb" ]]; then
        # Fallback for older kernels without MemAvailable
        local free_kb buffers_kb cached_kb
        free_kb=$(grep "^MemFree:" /proc/meminfo | awk '{print $2}')
        buffers_kb=$(grep "^Buffers:" /proc/meminfo | awk '{print $2}')
        cached_kb=$(grep "^Cached:" /proc/meminfo | awk '{print $2}')
        available_kb=$((free_kb + buffers_kb + cached_kb))
    fi

    local available_mb=$((available_kb / 1024))

    if [[ $available_mb -lt $min_mb ]]; then
        error "Insufficient RAM"
        echo "  Required:  ${min_mb}MB"
        echo "  Available: ${available_mb}MB"
        echo ""
        echo "FreshTrack requires at least 2GB RAM for Docker services:"
        echo "  - PostgreSQL: ~256MB"
        echo "  - Redis: ~128MB"
        echo "  - Backend API: ~512MB"
        echo "  - Frontend: ~256MB"
        echo "  - Monitoring stack: ~512MB"
        return 1
    fi

    success "RAM: ${available_mb}MB available (minimum: ${min_mb}MB)"
    return 0
}
```

**2. validate_disk function:**
```bash
# PREFLIGHT-02: Validate minimum disk space available
# Args: $1 = minimum GB required (default: 10 for Docker images + data)
#       $2 = mount point to check (default: /)
# Returns: 0 if sufficient, 1 if insufficient
validate_disk() {
    local min_gb="${1:-10}"
    local mount_point="${2:-/}"

    local available_gb
    available_gb=$(df -BG "$mount_point" 2>/dev/null | awk 'NR==2 {gsub("G",""); print $4}')

    if [[ -z "$available_gb" ]]; then
        error "Cannot determine disk space for $mount_point"
        return 1
    fi

    if [[ $available_gb -lt $min_gb ]]; then
        error "Insufficient disk space"
        echo "  Required:  ${min_gb}GB"
        echo "  Available: ${available_gb}GB on $mount_point"
        echo ""
        echo "FreshTrack requires at least 10GB for:"
        echo "  - Docker images: ~4GB"
        echo "  - PostgreSQL data: ~2GB"
        echo "  - Monitoring data: ~2GB"
        echo "  - Application logs: ~1GB"
        echo "  - Buffer: ~1GB"
        echo ""
        echo "Free up space with: docker system prune -af"
        return 1
    fi

    success "Disk: ${available_gb}GB available on $mount_point (minimum: ${min_gb}GB)"
    return 0
}
```

**3. validate_cpu function:**
```bash
# PREFLIGHT-03: Validate CPU cores (warning only, not blocking)
# Args: $1 = recommended cores (default: 2)
# Returns: 0 always (warning only)
validate_cpu() {
    local recommended="${1:-2}"

    local cores
    cores=$(nproc 2>/dev/null || grep -c ^processor /proc/cpuinfo 2>/dev/null || echo "1")

    if [[ $cores -lt $recommended ]]; then
        warning "Low CPU count"
        echo "  Recommended: ${recommended}+ cores"
        echo "  Available:   ${cores} cores"
        echo ""
        echo "Deployment will continue but may be slow."
        echo "Consider upgrading to a larger VM for production use."
    else
        success "CPU: ${cores} cores (recommended: ${recommended}+)"
    fi

    return 0
}
```
  </action>
  <verify>
Test each function:
```bash
source scripts/lib/preflight-lib.sh
validate_ram 1  # Should pass with low threshold
validate_disk 1  # Should pass with low threshold
validate_cpu 1  # Should pass
```
  </verify>
  <done>
- validate_ram reads /proc/meminfo MemAvailable
- validate_disk reads df -BG output
- validate_cpu uses nproc with fallback
- All functions use success/error/warning helpers
- Clear error messages explain requirements
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OS and network validation functions</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Add OS and network validation functions to `scripts/lib/preflight-lib.sh`:

**4. validate_os function:**
```bash
# PREFLIGHT-04: Validate OS version (Ubuntu 20.04+ or Debian 11+)
# Returns: 0 if supported, 1 if unsupported
validate_os() {
    if [[ ! -f /etc/os-release ]]; then
        error "Cannot detect OS version"
        echo "  /etc/os-release not found"
        echo ""
        echo "Supported operating systems:"
        echo "  - Ubuntu 20.04 LTS (Focal) or newer"
        echo "  - Ubuntu 22.04 LTS (Jammy) or newer"
        echo "  - Ubuntu 24.04 LTS (Noble) or newer"
        echo "  - Debian 11 (Bullseye) or newer"
        echo "  - Debian 12 (Bookworm) or newer"
        return 1
    fi

    # shellcheck source=/dev/null
    source /etc/os-release

    local supported=false
    local min_version=""

    case "$ID" in
        ubuntu)
            min_version="20.04"
            if [[ "${VERSION_ID%%.*}" -ge 20 ]]; then
                supported=true
            fi
            ;;
        debian)
            min_version="11"
            if [[ "${VERSION_ID%%.*}" -ge 11 ]]; then
                supported=true
            fi
            ;;
        *)
            # Unsupported OS
            ;;
    esac

    if [[ "$supported" != "true" ]]; then
        error "Unsupported operating system"
        echo "  Detected: $PRETTY_NAME"
        echo ""
        echo "Supported operating systems:"
        echo "  - Ubuntu 20.04 LTS (Focal) or newer"
        echo "  - Ubuntu 22.04 LTS (Jammy) or newer"
        echo "  - Ubuntu 24.04 LTS (Noble) or newer"
        echo "  - Debian 11 (Bullseye) or newer"
        echo "  - Debian 12 (Bookworm) or newer"
        echo ""
        echo "CentOS, RHEL, Fedora, Alpine, and Windows are not supported."
        return 1
    fi

    success "OS: $PRETTY_NAME (minimum: $ID $min_version)"
    return 0
}
```

**5. validate_network function:**
```bash
# PREFLIGHT-05: Validate network connectivity to required URLs
# Returns: 0 if all reachable, 1 if any unreachable
validate_network() {
    local urls=(
        "https://registry-1.docker.io/v2/"
        "https://github.com"
        "https://get.docker.com"
    )

    local failed=0
    local timeout=10

    for url in "${urls[@]}"; do
        local http_code
        http_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout "$timeout" --max-time 15 "$url" 2>/dev/null || echo "000")

        if [[ "$http_code" == "000" ]]; then
            error "Cannot reach: $url"
            failed=1
        elif [[ "$http_code" -ge 400 && "$http_code" != "401" ]]; then
            # 401 is expected for Docker registry (requires auth for pulls)
            warning "$url returned HTTP $http_code"
        else
            success "Reachable: $url (HTTP $http_code)"
        fi
    done

    if [[ $failed -eq 1 ]]; then
        echo ""
        echo "Required URLs that must be reachable:"
        echo "  - registry-1.docker.io (Docker Hub for images)"
        echo "  - github.com (Source code repository)"
        echo "  - get.docker.com (Docker installer script)"
        echo ""
        echo "Check your network connectivity and firewall rules."
        echo "Ensure outbound HTTPS (port 443) is allowed."
        return 1
    fi

    return 0
}
```

**6. Add run_preflight_checks orchestrator:**
```bash
# Run all pre-flight validation checks
# Args: none
# Returns: 0 if all pass, 1 if any critical check fails
run_preflight_checks() {
    echo "========================================"
    echo "Pre-Flight System Validation"
    echo "========================================"
    echo ""

    local failed=0

    step "Checking RAM..."
    if ! validate_ram 2048; then
        failed=1
    fi
    echo ""

    step "Checking disk space..."
    if ! validate_disk 10; then
        failed=1
    fi
    echo ""

    step "Checking CPU..."
    validate_cpu 2  # Warning only, doesn't fail
    echo ""

    step "Checking OS..."
    if ! validate_os; then
        failed=1
    fi
    echo ""

    step "Checking network connectivity..."
    if ! validate_network; then
        failed=1
    fi
    echo ""

    echo "========================================"
    if [[ $failed -eq 1 ]]; then
        error "Pre-flight checks FAILED"
        echo "Resolve the issues above before proceeding."
        echo ""
        return 1
    fi

    success "All pre-flight checks PASSED"
    echo ""
    return 0
}
```
  </action>
  <verify>
Test each function:
```bash
source scripts/lib/preflight-lib.sh
validate_os  # Should pass on Ubuntu/Debian
validate_network  # Should pass with internet
```

Test run_preflight_checks orchestrator:
```bash
source scripts/lib/preflight-lib.sh
run_preflight_checks
```
  </verify>
  <done>
- validate_os reads /etc/os-release and checks Ubuntu 20.04+ or Debian 11+
- validate_os shows clear unsupported OS list including CentOS, Windows
- validate_network checks Docker Hub, GitHub, get.docker.com
- validate_network explains what URLs must be reachable on failure
- run_preflight_checks runs all validations in sequence
  </done>
</task>

<task type="auto">
  <name>Task 3: Update self-tests to cover validation functions</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Update the self-test block at the end of preflight-lib.sh to include validation function tests:

```bash
# Self-test when run directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Testing preflight-lib.sh..."
    echo ""

    # Test sanitize_output
    echo "1. Testing credential sanitization..."
    test_cmd='curl -u user:password=secret123 https://api.example.com --header "Authorization: Bearer token=abc123"'
    sanitized=$(echo "$test_cmd" | sanitize_output)

    if echo "$sanitized" | grep -q "secret123"; then
        echo "FAIL: password not redacted"
        exit 1
    fi
    if echo "$sanitized" | grep -q "abc123"; then
        echo "FAIL: token not redacted"
        exit 1
    fi
    echo "PASS: Credential sanitization working"
    echo ""

    # Test categorize_error
    echo "2. Testing error categorization..."
    if [[ "$(categorize_error 28)" != "transient:network" ]]; then
        echo "FAIL: Exit code 28 should be transient:network"
        exit 1
    fi
    if [[ "$(categorize_error 127)" != "recoverable:permission" ]]; then
        echo "FAIL: Exit code 127 should be recoverable:permission"
        exit 1
    fi
    if [[ "$(categorize_error 137)" != "recoverable:resource" ]]; then
        echo "FAIL: Exit code 137 should be recoverable:resource"
        exit 1
    fi
    if [[ "$(categorize_error 130)" != "fatal:signal" ]]; then
        echo "FAIL: Exit code 130 should be fatal:signal"
        exit 1
    fi
    echo "PASS: Error categorization working"
    echo ""

    # Test validation functions (with low thresholds to ensure pass)
    echo "3. Testing validation functions..."

    # RAM validation with very low threshold
    if ! validate_ram 1 >/dev/null 2>&1; then
        echo "FAIL: validate_ram should pass with 1MB threshold"
        exit 1
    fi
    echo "PASS: validate_ram function working"

    # Disk validation with very low threshold
    if ! validate_disk 1 >/dev/null 2>&1; then
        echo "FAIL: validate_disk should pass with 1GB threshold"
        exit 1
    fi
    echo "PASS: validate_disk function working"

    # CPU validation (always returns 0)
    if ! validate_cpu 1 >/dev/null 2>&1; then
        echo "FAIL: validate_cpu should always return 0"
        exit 1
    fi
    echo "PASS: validate_cpu function working"

    # OS validation (should pass on Ubuntu/Debian CI)
    # Skip if not on supported OS (for development on macOS)
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        if [[ "$ID" == "ubuntu" || "$ID" == "debian" ]]; then
            if ! validate_os >/dev/null 2>&1; then
                echo "FAIL: validate_os should pass on Ubuntu/Debian"
                exit 1
            fi
            echo "PASS: validate_os function working"
        else
            echo "SKIP: validate_os (not on Ubuntu/Debian)"
        fi
    else
        echo "SKIP: validate_os (no /etc/os-release)"
    fi

    echo ""
    echo "========================================"
    echo "All tests passed!"
    echo "========================================"
fi
```
  </action>
  <verify>
Run the updated self-tests:
```bash
bash scripts/lib/preflight-lib.sh
```

All tests should pass with output showing:
- PASS: Credential sanitization working
- PASS: Error categorization working
- PASS: validate_ram function working
- PASS: validate_disk function working
- PASS: validate_cpu function working
- PASS/SKIP: validate_os function working
- All tests passed!
  </verify>
  <done>
- Self-test block updated with validation function tests
- Tests use low thresholds to ensure pass in CI
- OS validation test skips gracefully on non-Linux
- All tests pass when run directly
  </done>
</task>

</tasks>

<verification>
1. Functions exist: `source scripts/lib/preflight-lib.sh && type validate_ram validate_disk validate_cpu validate_os validate_network run_preflight_checks`
2. Shellcheck passes: `shellcheck scripts/lib/preflight-lib.sh`
3. Self-tests pass: `bash scripts/lib/preflight-lib.sh`
4. RAM error message: `bash -c 'source scripts/lib/preflight-lib.sh; validate_ram 999999' 2>&1 | grep -q "Insufficient RAM"`
5. OS error message: Run on unsupported OS should show "Ubuntu 20.04+" in output
6. Network error message: Block network should show "registry-1.docker.io" in output
</verification>

<success_criteria>
- PREFLIGHT-01: validate_ram checks MemAvailable (2GB minimum)
- PREFLIGHT-02: validate_disk checks available space (10GB minimum)
- PREFLIGHT-03: validate_cpu warns on <2 cores (non-blocking)
- PREFLIGHT-04: validate_os accepts Ubuntu 20.04+, Debian 11+, rejects others with clear list
- PREFLIGHT-05: validate_network checks Docker Hub, GitHub, get.docker.com connectivity
</success_criteria>

<output>
After completion, create `.planning/phases/22-foundation-pre-flight/22-02-SUMMARY.md`
</output>
