---
phase: 22-foundation-pre-flight
plan: 04
type: execute
wave: 2
depends_on: ['22-01', '22-02']
files_modified:
  - scripts/lib/preflight-lib.sh
autonomous: true

must_haves:
  truths:
    - "Script validates DNS resolution for user's domain points to server IP"
    - "DNS validation shows clear guidance when domain doesn't resolve"
    - 'DNS validation shows A record configuration instructions'
  artifacts:
    - path: 'scripts/lib/preflight-lib.sh'
      provides: 'DNS resolution validation function'
      exports: ['validate_dns']
      contains: ['dig +short', 'ifconfig.me']
  key_links:
    - from: 'scripts/lib/preflight-lib.sh'
      to: 'external DNS'
      via: 'dig command'
      pattern: "dig.*\\+short"
---

<objective>
Add DNS resolution validation to preflight-lib.sh for domain verification.

Purpose: Enable deployment scripts to verify that the user's domain correctly resolves to the server's public IP before attempting SSL certificate provisioning.

Output: validate_dns function added to `scripts/lib/preflight-lib.sh` and integrated into run_preflight_checks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-foundation-pre-flight/22-RESEARCH.md
@.planning/phases/22-foundation-pre-flight/22-02-SUMMARY.md
@scripts/deploy-selfhosted.sh (lines 172-229 for existing DNS check pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validate_dns function</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Add the validate_dns function to `scripts/lib/preflight-lib.sh` after validate_network:

```bash
# PREFLIGHT-06: Validate DNS resolution for domain points to server IP
# Args: $1 = domain name to validate
# Returns: 0 if DNS matches server IP, 1 if not
# Note: This check is optional during preflight (domain may not be configured yet)
#       Use this when ready to deploy (before SSL provisioning)
validate_dns() {
    local domain="$1"

    if [[ -z "$domain" ]]; then
        error "validate_dns requires domain argument"
        return 1
    fi

    # Check if dig is available
    if ! command -v dig &>/dev/null; then
        warning "dig command not found, attempting to install dnsutils..."
        if command -v apt-get &>/dev/null; then
            apt-get update -qq && apt-get install -y dnsutils >/dev/null 2>&1 || {
                error "Could not install dnsutils"
                echo "Install manually: sudo apt-get install dnsutils"
                return 1
            }
        else
            error "Cannot install dig - apt-get not available"
            return 1
        fi
    fi

    # Get server's public IP
    step "Detecting server public IP..."
    local server_ip
    server_ip=$(curl -s --max-time 10 ifconfig.me 2>/dev/null || \
                curl -s --max-time 10 icanhazip.com 2>/dev/null || \
                curl -s --max-time 10 ipinfo.io/ip 2>/dev/null)

    if [[ -z "$server_ip" ]]; then
        error "Could not determine server public IP"
        echo "  Check internet connectivity"
        return 1
    fi

    echo "  Server IP: $server_ip"

    # Resolve domain
    step "Resolving DNS for $domain..."
    local resolved_ip
    resolved_ip=$(dig +short "$domain" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

    if [[ -z "$resolved_ip" ]]; then
        error "DNS lookup failed for $domain"
        echo "  No A record found."
        echo ""
        echo "Configure DNS at your domain registrar:"
        echo ""
        echo "  Record Type: A"
        echo "  Name:        $domain (or @ for root domain)"
        echo "  Value:       $server_ip"
        echo "  TTL:         300 (5 minutes)"
        echo ""
        echo "Wait for DNS propagation (typically 5-60 minutes) before retrying."
        echo ""
        echo "Verify with: dig $domain"
        return 1
    fi

    echo "  Domain resolves to: $resolved_ip"

    # Compare IPs
    if [[ "$resolved_ip" != "$server_ip" ]]; then
        error "DNS mismatch for $domain"
        echo "  Domain resolves to: $resolved_ip"
        echo "  Server IP is:       $server_ip"
        echo ""
        echo "Update your DNS A record to point to $server_ip"
        echo ""
        echo "If you recently updated DNS, wait for propagation (5-60 minutes)."
        echo "Check propagation status: dig $domain +trace"
        return 1
    fi

    success "DNS: $domain correctly resolves to $server_ip"
    return 0
}
```

  </action>
  <verify>
Test validate_dns function (use a known-resolving domain for positive test):
```bash
source scripts/lib/preflight-lib.sh

# Test with a domain that exists (should resolve, but won't match server IP)

# This tests the resolution logic but expects a mismatch

validate_dns "google.com" 2>&1 | grep -q "DNS mismatch" && echo "PASS: DNS resolution works"

# Test with invalid domain (should fail lookup)

validate_dns "this-domain-does-not-exist-12345.invalid" 2>&1 | grep -q "No A record" && echo "PASS: Invalid domain handled"

````
  </verify>
  <done>
- validate_dns accepts domain argument
- Detects server public IP using multiple fallback services
- Uses dig +short to resolve domain
- Shows clear error with A record configuration instructions
- Shows DNS propagation guidance
- Returns 0 only when domain resolves to server IP
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optional DNS check to run_preflight_checks</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Update the `run_preflight_checks` function to accept an optional domain parameter for DNS validation:

Find the run_preflight_checks function and update it:

```bash
# Run all pre-flight validation checks
# Args: $1 = domain (optional, for DNS validation)
# Returns: 0 if all pass, 1 if any critical check fails
run_preflight_checks() {
    local domain="${1:-}"

    echo "========================================"
    echo "Pre-Flight System Validation"
    echo "========================================"
    echo ""

    local failed=0

    step "Checking RAM..."
    if ! validate_ram 2048; then
        failed=1
    fi
    echo ""

    step "Checking disk space..."
    if ! validate_disk 10; then
        failed=1
    fi
    echo ""

    step "Checking CPU..."
    validate_cpu 2  # Warning only, doesn't fail
    echo ""

    step "Checking OS..."
    if ! validate_os; then
        failed=1
    fi
    echo ""

    step "Checking network connectivity..."
    if ! validate_network; then
        failed=1
    fi
    echo ""

    # DNS validation is optional (only if domain provided)
    if [[ -n "$domain" ]]; then
        step "Checking DNS resolution for $domain..."
        if ! validate_dns "$domain"; then
            failed=1
        fi
        echo ""
    else
        echo "[INFO] DNS validation skipped (no domain provided)"
        echo "       Run with domain argument for full validation:"
        echo "       run_preflight_checks \"yourdomain.com\""
        echo ""
    fi

    echo "========================================"
    if [[ $failed -eq 1 ]]; then
        error "Pre-flight checks FAILED"
        echo "Resolve the issues above before proceeding."
        echo ""
        return 1
    fi

    success "All pre-flight checks PASSED"
    echo ""
    return 0
}
````

Also add a convenience function for DNS-only validation:

```bash
# Run DNS validation only (useful for checking after DNS changes)
# Args: $1 = domain name
run_dns_check() {
    local domain="$1"

    if [[ -z "$domain" ]]; then
        error "Usage: run_dns_check <domain>"
        return 1
    fi

    echo "========================================"
    echo "DNS Validation"
    echo "========================================"
    echo ""

    if validate_dns "$domain"; then
        echo ""
        success "DNS is correctly configured!"
        echo "You can proceed with deployment."
        return 0
    else
        echo ""
        error "DNS validation failed"
        echo "Fix the DNS configuration before proceeding."
        return 1
    fi
}
```

  </action>
  <verify>
Test updated run_preflight_checks:
```bash
source scripts/lib/preflight-lib.sh

# Test without domain (should skip DNS check)

run_preflight_checks 2>&1 | grep -q "DNS validation skipped" && echo "PASS: Skips DNS when no domain"

# Test with domain (will likely fail DNS mismatch but shows it runs)

run_preflight_checks "example.com" 2>&1 | grep -q "DNS" && echo "PASS: Runs DNS check with domain"

````

Test run_dns_check:
```bash
source scripts/lib/preflight-lib.sh

# Test usage error
run_dns_check 2>&1 | grep -q "Usage:" && echo "PASS: Shows usage without argument"
````

  </verify>
  <done>
- run_preflight_checks accepts optional domain parameter
- DNS validation skipped with info message when no domain provided
- DNS validation runs when domain provided
- run_dns_check function for standalone DNS testing
- Clear instructions for how to run with domain
  </done>
</task>

<task type="auto">
  <name>Task 3: Add DNS validation to self-tests</name>
  <files>scripts/lib/preflight-lib.sh</files>
  <action>
Add DNS validation tests to the self-test block:

After the error state tests, add:

```bash
    # Test DNS validation function
    echo "6. Testing DNS validation..."

    # Test with missing argument (should fail)
    if validate_dns "" 2>/dev/null; then
        echo "FAIL: validate_dns should fail with empty domain"
        exit 1
    fi
    echo "PASS: validate_dns rejects empty domain"

    # Test with invalid domain (should fail with "No A record")
    local dns_output
    dns_output=$(validate_dns "this-domain-absolutely-does-not-exist-xyz123.invalid" 2>&1) || true
    if ! echo "$dns_output" | grep -q "No A record\|DNS lookup failed"; then
        echo "FAIL: validate_dns should report 'No A record' for invalid domain"
        echo "Output was: $dns_output"
        exit 1
    fi
    echo "PASS: validate_dns handles non-existent domains"

    # Test with valid domain (will fail DNS mismatch but proves resolution works)
    # Skip if dig is not available
    if command -v dig &>/dev/null; then
        dns_output=$(validate_dns "google.com" 2>&1) || true
        if echo "$dns_output" | grep -q "Could not determine server public IP\|DNS lookup failed"; then
            echo "SKIP: DNS test needs network (offline mode)"
        elif echo "$dns_output" | grep -q "DNS mismatch\|correctly resolves"; then
            echo "PASS: validate_dns resolves real domains"
        else
            echo "WARN: Unexpected DNS output: $dns_output"
        fi
    else
        echo "SKIP: DNS test (dig not available)"
    fi

    echo ""
```

  </action>
  <verify>
Run self-tests:
```bash
bash scripts/lib/preflight-lib.sh
```

Should show additional tests:

- PASS: validate_dns rejects empty domain
- PASS: validate_dns handles non-existent domains
- PASS/SKIP: validate_dns resolves real domains
  </verify>
  <done>
- Self-test validates empty domain rejection
- Self-test validates non-existent domain handling
- Self-test validates real domain resolution (with network)
- Tests handle offline gracefully with SKIP
  </done>
  </task>

</tasks>

<verification>
1. Functions exist: `source scripts/lib/preflight-lib.sh && type validate_dns run_dns_check`
2. Shellcheck passes: `shellcheck scripts/lib/preflight-lib.sh`
3. Self-tests pass: `bash scripts/lib/preflight-lib.sh`
4. DNS error shows A record instructions: `source scripts/lib/preflight-lib.sh && validate_dns "nonexistent.invalid" 2>&1 | grep -q "Record Type: A"`
5. run_preflight_checks without domain skips DNS: `source scripts/lib/preflight-lib.sh && run_preflight_checks 2>&1 | grep -q "skipped"`
</verification>

<success_criteria>

- PREFLIGHT-06: validate_dns checks domain resolves to server's public IP
- DNS validation shows clear A record configuration guidance
- DNS validation shows propagation timing guidance
- run_preflight_checks integrates DNS validation when domain provided
- Graceful handling when DNS check is not yet applicable
  </success_criteria>

<output>
After completion, create `.planning/phases/22-foundation-pre-flight/22-04-SUMMARY.md`
</output>
