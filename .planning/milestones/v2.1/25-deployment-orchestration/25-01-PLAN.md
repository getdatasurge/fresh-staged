---
phase: 25-deployment-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/deploy-automated.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - 'Script sources all three library files successfully'
    - 'Script calls existing deploy.sh without duplicating logic'
    - 'Script creates checkpoint markers for each major step'
    - 'Script can resume from last successful checkpoint after failure'
  artifacts:
    - path: 'scripts/deploy-automated.sh'
      provides: 'Thin deployment orchestrator'
      min_lines: 100
      exports: ['main']
  key_links:
    - from: 'scripts/deploy-automated.sh'
      to: 'scripts/lib/preflight-lib.sh'
      via: 'source statement'
      pattern: "source.*preflight-lib\\.sh"
    - from: 'scripts/deploy-automated.sh'
      to: 'scripts/lib/prereq-lib.sh'
      via: 'source statement'
      pattern: "source.*prereq-lib\\.sh"
    - from: 'scripts/deploy-automated.sh'
      to: 'scripts/lib/config-lib.sh'
      via: 'source statement'
      pattern: "source.*config-lib\\.sh"
    - from: 'scripts/deploy-automated.sh'
      to: 'scripts/deploy.sh'
      via: 'subprocess execution'
      pattern: "deploy\\.sh"
---

<objective>
Create the thin deployment orchestrator script that coordinates existing infrastructure.

Purpose: Satisfy DEPLOY-01 (no code duplication) by creating a script that CALLS existing deploy.sh rather than copying its logic. The orchestrator sources all library files and wraps each major deployment phase with checkpoint tracking via run_step().

Output: `scripts/deploy-automated.sh` - executable orchestrator (~100-150 lines)
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-deployment-orchestration/25-RESEARCH.md
@scripts/lib/preflight-lib.sh
@scripts/lib/prereq-lib.sh
@scripts/lib/config-lib.sh
@scripts/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy-automated.sh orchestrator script</name>
  <files>scripts/deploy-automated.sh</files>
  <action>
Create the thin deployment orchestrator script with the following structure:

1. **Header and strict mode**:
   - Shebang: `#!/usr/bin/env bash`
   - Comment block explaining purpose and usage
   - Usage: `./scripts/deploy-automated.sh [--reset] [--skip-prereqs] [--help]`
   - Strict mode: `set -o errexit`, `set -o errtrace`, `set -o nounset`, `set -o pipefail`

2. **Script configuration**:
   - SCRIPT_DIR detection using BASH_SOURCE pattern
   - PROJECT_ROOT as parent of SCRIPT_DIR

3. **Source libraries in correct order**:
   - Source preflight-lib.sh FIRST (provides error_handler, run_step, checkpoint functions)
   - Source prereq-lib.sh SECOND (depends on preflight-lib)
   - Source config-lib.sh THIRD (depends on preflight-lib)

4. **Command line argument parsing**:
   - `--reset`: Clear all checkpoints before starting (calls checkpoint_clear_all)
   - `--skip-prereqs`: Skip prerequisites step (for re-runs where prereqs done)
   - `--help`: Display usage information
   - Error on unknown options

5. **Wrapper functions for each deployment phase**:
   - `do_preflight()`: Calls run_preflight_checks (without domain - domain not known yet)
   - `do_prerequisites()`: Calls install_all_prerequisites (or skips if --skip-prereqs)
   - `do_configuration()`: Calls run_interactive_configuration
   - `do_deployment()`: Changes to PROJECT_ROOT, then executes deploy.sh as subprocess

6. **Main orchestration function**:
   - Display banner with "FreshTrack Pro Automated Deployment"
   - Show start timestamp
   - Handle --reset if requested
   - Call run_step() for each phase in order:
     - run_step "preflight" do_preflight
     - run_step "prerequisites" do_prerequisites
     - run_step "configuration" do_configuration
     - run_step "deployment" do_deployment
   - Show completion banner with end timestamp

7. **Entry point**:
   - Call main function with all arguments

**CRITICAL - What NOT to include**:

- NO Docker Compose commands (deploy.sh has them)
- NO health check loops (deploy.sh has them)
- NO image pulling (deploy.sh has it)
- NO migration running (deploy.sh has it)
- This script should be ~100-150 lines, not 200+

**Checkpoint naming convention**: Use descriptive names that won't collide:

- "deploy-preflight"
- "deploy-prerequisites"
- "deploy-configuration"
- "deploy-deployment"
  </action>
  <verify>

1. File exists and is executable: `ls -la scripts/deploy-automated.sh`
2. Script syntax check: `bash -n scripts/deploy-automated.sh`
3. Source statements present: `grep -E "source.*lib\\.sh" scripts/deploy-automated.sh`
4. No Docker Compose duplication: `! grep -q "docker compose" scripts/deploy-automated.sh`
5. Calls deploy.sh: `grep "deploy.sh" scripts/deploy-automated.sh`
6. Uses run_step: `grep "run_step" scripts/deploy-automated.sh | wc -l` (should be 4)
7. Line count check: `wc -l scripts/deploy-automated.sh` (should be 100-180)
   </verify>
   <done>
   Script exists at scripts/deploy-automated.sh, is executable, passes syntax check, sources all three library files, uses run_step for 4 deployment phases, calls deploy.sh for actual deployment, and contains no duplicated Docker Compose commands.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Add help text and usage documentation</name>
  <files>scripts/deploy-automated.sh</files>
  <action>
Ensure the script has comprehensive help output when run with --help:

1. **show_usage() function** that displays:
   - Script name and purpose
   - Usage syntax: `./scripts/deploy-automated.sh [OPTIONS]`
   - Available options:
     - `--reset`: Clear all deployment checkpoints and start fresh
     - `--skip-prereqs`: Skip prerequisites installation (use if already installed)
     - `--help`: Show this help message
   - Deployment phases explained:
     1. Pre-flight checks (system requirements)
     2. Prerequisites (Docker, firewall, fail2ban)
     3. Configuration (domain, email, secrets)
     4. Deployment (calls existing deploy.sh)
   - Resume capability note: "Script automatically resumes from last successful step"
   - Examples:
     - Fresh install: `./scripts/deploy-automated.sh`
     - Resume after failure: `./scripts/deploy-automated.sh`
     - Complete reset: `./scripts/deploy-automated.sh --reset`

2. **Integrate into argument parsing**:
   - `--help|-h)` case that calls show_usage and exits 0
     </action>
     <verify>
3. Help flag works: `./scripts/deploy-automated.sh --help`
4. Short help works: `./scripts/deploy-automated.sh -h`
5. Help shows all options: `./scripts/deploy-automated.sh --help | grep -E "\-\-reset|\-\-skip-prereqs|\-\-help"`
6. Help shows phases: `./scripts/deploy-automated.sh --help | grep -E "Pre-flight|Prerequisites|Configuration|Deployment"`
   </verify>
   <done>
   Running `./scripts/deploy-automated.sh --help` displays comprehensive usage information including all available options, deployment phases, resume capability, and usage examples.
   </done>
   </task>

</tasks>

<verification>
After completing both tasks:

1. **Script structure verification**:

   ```bash
   # Check file exists and is executable
   ls -la scripts/deploy-automated.sh

   # Syntax validation
   bash -n scripts/deploy-automated.sh

   # Help output
   ./scripts/deploy-automated.sh --help
   ```

2. **Code pattern verification**:

   ```bash
   # All three libraries sourced
   grep -c "source.*lib\.sh" scripts/deploy-automated.sh  # Should be 3

   # Uses run_step for checkpointing
   grep -c "run_step" scripts/deploy-automated.sh  # Should be 4

   # Calls deploy.sh (DEPLOY-01 compliance)
   grep "deploy.sh" scripts/deploy-automated.sh

   # NO Docker Compose duplication
   ! grep -q "docker compose" scripts/deploy-automated.sh && echo "PASS: No docker compose duplication"
   ```

3. **DEPLOY requirement verification**:
   - DEPLOY-01 (no duplication): Script calls deploy.sh, doesn't copy its logic
   - DEPLOY-02 (checkpoints): Script uses run_step() which creates checkpoints
   - DEPLOY-03 (resume): run_step() automatically skips completed checkpoints
     </verification>

<success_criteria>

1. scripts/deploy-automated.sh exists and is executable (chmod +x)
2. Script passes bash -n syntax check
3. Script sources preflight-lib.sh, prereq-lib.sh, and config-lib.sh
4. Script uses run_step() for 4 deployment phases
5. Script calls deploy.sh for actual deployment (no Docker Compose duplication)
6. Script is ~100-150 lines (thin orchestrator, not a rewrite)
7. --help displays comprehensive usage information
8. --reset flag clears checkpoints
9. --skip-prereqs flag skips prerequisites step
   </success_criteria>

<output>
After completion, create `.planning/phases/25-deployment-orchestration/25-01-SUMMARY.md`
</output>
