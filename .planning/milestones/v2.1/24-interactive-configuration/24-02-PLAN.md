---
phase: 24-interactive-configuration
plan: 02
type: execute
wave: 2
depends_on: ['24-01']
files_modified:
  - scripts/lib/config-lib.sh
autonomous: true

must_haves:
  truths:
    - 'Script auto-generates secure passwords and secrets'
    - 'User never types passwords'
    - 'Secrets are written to files with restrictive permissions (600)'
    - '.env.production is generated with correct variable substitution'
    - 'Existing .env.production is backed up before overwrite'
  artifacts:
    - path: 'scripts/lib/config-lib.sh'
      provides: 'Secret generation and env file creation'
      exports: ['generate_secret', 'generate_secrets_files', 'generate_env_file']
  key_links:
    - from: 'scripts/lib/config-lib.sh'
      to: 'secrets/*.txt'
      via: 'echo -n > file'
      pattern: 'echo.*secrets/'
    - from: 'scripts/lib/config-lib.sh'
      to: '.env.production'
      via: 'heredoc'
      pattern: 'cat.*EOF'
---

<objective>
Add secret generation and .env.production file creation to config-lib.sh.

Purpose: Auto-generate all required secrets and create the production environment file, satisfying CONFIG-03 (secure passwords), CONFIG-05 (env file creation), and CONFIG-06 (auto-generation).

Output: Functions for cryptographically secure secret generation and .env.production file creation.
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-interactive-configuration/24-RESEARCH.md
@.env.production.example
@scripts/lib/config-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add secret generation functions</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Add secret generation functions to config-lib.sh:

1. Implement `generate_secret()`:
   - Args: $1 = desired length (default: 32)
   - Use `openssl rand -base64` with extra bytes to account for character removal
   - Pipe through `tr -d '/+=\n'` to remove special chars
   - Use `head -c "$length"` to truncate to exact length
   - Echo the result (no newline)

2. Implement `generate_secrets_files()`:
   - Args: $1 = secrets directory (default: "secrets")
   - Create secrets directory with `mkdir -p` and `chmod 700`
   - Generate secrets if not already set (allow override for testing):
     - POSTGRES_PASSWORD (32 chars)
     - JWT_SECRET (48 chars for extra entropy)
     - GRAFANA_PASSWORD (32 chars)
     - MINIO_PASSWORD (32 chars)
     - MINIO_USER="freshtrack-minio-admin"
   - Write each secret to its file using `echo -n`:
     - secrets/postgres_password.txt
     - secrets/jwt_secret.txt
     - secrets/grafana_password.txt
     - secrets/minio_password.txt
     - secrets/minio_user.txt
   - If STACK_AUTH_SECRET_KEY is set, write to secrets/stack_auth_secret.txt
   - Set permissions: `chmod 600` on all txt files
   - Display success message with file list (do NOT show actual secret values)

3. Add self-test for secret generation:
   - Test generate_secret produces correct length
   - Test generate_secret output contains only alphanumeric chars
   - Test generate_secrets_files creates expected files (use temp dir)
     </action>
     <verify>
     Run: `bash scripts/lib/config-lib.sh`
     Expect: Secret generation tests pass, files created with correct permissions
     </verify>
     <done>

- generate_secret produces alphanumeric strings of specified length
- generate_secrets_files creates all required secret files
- Secret files have 600 permissions
- Actual secret values are never echoed to console
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add .env.production generation</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Add .env.production file generation to config-lib.sh:

1. Implement `generate_env_file()`:
   - Args: $1 = output file path (default: ".env.production")
   - If file exists:
     - Create backup with timestamp: `${output_file}.backup.$(date +%Y%m%d-%H%M%S)`
     - Show warning with backup path
   - Generate file using heredoc with these sections:
     - Header comment with generation timestamp and warning not to edit manually
     - Application: NODE_ENV=production, LOG_LEVEL=info, PORT=3000, HOST=0.0.0.0
     - Domain Configuration: Use $DOMAIN variable for all URLs
       - DOMAIN=$DOMAIN
       - ADMIN_EMAIL=$ADMIN_EMAIL
       - FRONTEND_URL=https://$DOMAIN
       - API_URL=https://$DOMAIN/api
       - APP_URL=https://$DOMAIN
       - MONITORING_URL=https://monitoring.$DOMAIN
       - STATUS_URL=https://status.$DOMAIN
       - CORS_ORIGINS=https://$DOMAIN
     - Database: DATABASE_URL with variable reference (not interpolated password)
     - Redis: REDIS_URL=redis://redis:6379
     - MinIO: Basic config for self-hosted
     - Stack Auth: Project ID and Publishable Key from variables
     - Feature Flags: All enabled by default
     - Security: Rate limiting, session config with domain
   - Set permissions: `chmod 600` on generated file
   - Display success message

2. Implement `create_configuration()` master function that:
   - Calls generate_secrets_files() (returns 1 on failure)
   - Calls generate_env_file() (returns 1 on failure)
   - Displays summary of what was created
   - Returns 0 on success

3. Add self-test for env file generation:
   - Test with temp directory
   - Verify file contains expected variables (DOMAIN, ADMIN_EMAIL)
   - Verify backup is created on second run
   - Verify file has 600 permissions
     </action>
     <verify>
     Run: `bash scripts/lib/config-lib.sh`
     Expect: All tests pass including env file generation with backup handling
     </verify>
     <done>

- .env.production generated with all required variables
- Existing files are backed up with timestamp
- File has restrictive 600 permissions
- Password values use variable references, not interpolated secrets
- CONFIG-03 (secure passwords) satisfied via auto-generation
- CONFIG-05 (env file creation) satisfied
- CONFIG-06 (auto-generated credentials) satisfied
  </done>
  </task>

</tasks>

<verification>
Run self-test: `bash scripts/lib/config-lib.sh`

Manual verification:

```bash
# Test secret generation
source scripts/lib/config-lib.sh
secret=$(generate_secret 32)
echo "Length: ${#secret}"  # Should be 32
echo "$secret" | grep -qE '^[A-Za-z0-9]+$' && echo "PASS: alphanumeric only"

# Test env file generation (with temp dir)
export DOMAIN="test.example.com"
export ADMIN_EMAIL="admin@test.com"
export STACK_AUTH_PROJECT_ID="test-project"
export STACK_AUTH_PUBLISHABLE_KEY="pk_test_123"
tmpdir=$(mktemp -d)
generate_secrets_files "$tmpdir/secrets"
generate_env_file "$tmpdir/.env.production"
cat "$tmpdir/.env.production"
ls -la "$tmpdir/secrets/"
rm -rf "$tmpdir"
```

</verification>

<success_criteria>

- generate_secret produces cryptographically secure alphanumeric strings
- generate_secrets_files creates all required secret files with 600 permissions
- generate_env_file creates .env.production with correct variable substitution
- Existing .env.production is backed up before overwrite
- Secrets are never echoed to console
- Self-tests pass when script is run directly
  </success_criteria>

<output>
After completion, create `.planning/phases/24-interactive-configuration/24-02-SUMMARY.md`
</output>
