---
phase: 24-interactive-configuration
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - scripts/lib/config-lib.sh
autonomous: true

must_haves:
  truths:
    - "Script displays configuration summary for user review"
    - "Script validates DNS resolves to server IP before proceeding"
    - "User can cancel configuration after reviewing summary"
    - "DNS validation provides clear guidance when it fails"
  artifacts:
    - path: "scripts/lib/config-lib.sh"
      provides: "Summary display and DNS pre-deployment check"
      exports: ["display_configuration_summary", "validate_dns_before_deploy"]
  key_links:
    - from: "scripts/lib/config-lib.sh"
      to: "scripts/lib/preflight-lib.sh"
      via: "validate_dns"
      pattern: "validate_dns"
---

<objective>
Add configuration summary display and DNS validation check to config-lib.sh.

Purpose: Allow users to review their configuration before deployment begins and validate DNS is correctly configured, satisfying CONFIG-04 (DNS validation) and CONFIG-07 (configuration summary).

Output: Functions for displaying configuration summary and validating DNS resolution.
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-interactive-configuration/24-RESEARCH.md
@scripts/lib/preflight-lib.sh
@scripts/lib/config-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configuration summary display</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Add configuration summary display to config-lib.sh:

1. Implement `display_configuration_summary()`:
   - Print header banner: "Configuration Summary"
   - Display Domain Configuration section:
     - Main Domain: https://${DOMAIN}
     - API Endpoint: https://${DOMAIN}/api
     - Monitoring: https://monitoring.${DOMAIN}
     - Status Page: https://status.${DOMAIN}
     - Admin Email: ${ADMIN_EMAIL}
   - Display Generated Secrets section (show file names, NOT values):
     - PostgreSQL: [GENERATED - 32 chars]
     - JWT Secret: [GENERATED - 48 chars]
     - Grafana Admin: [GENERATED - 32 chars]
     - MinIO Password: [GENERATED - 32 chars]
   - Display Stack Auth section (show truncated values for confirmation):
     - Project ID: ${STACK_AUTH_PROJECT_ID:0:20}...
     - Publishable Key: ${STACK_AUTH_PUBLISHABLE_KEY:0:20}...
     - Secret Key: [PROVIDED - hidden]
   - Display .env.production location
   - Display secrets directory location
   - Print footer banner
   - Prompt user: "Proceed with this configuration? [Y/n]:"
   - Return 1 if user enters "n" or "N"
   - Return 0 if user confirms (Enter or Y/y)

2. Add color formatting to summary:
   - Use BLUE for section headers
   - Use GREEN for URLs
   - Use YELLOW for warnings about generated secrets

3. Add self-test to verify function exists and can be called (with mock data)
  </action>
  <verify>
Run: `bash scripts/lib/config-lib.sh`
Expect: Function existence test passes
  </verify>
  <done>
- Configuration summary displays all user-provided values
- Generated secrets show placeholder text, never actual values
- User can confirm or cancel configuration
- Summary is formatted with clear section headers
- CONFIG-07 (configuration summary) satisfied
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DNS validation before deployment</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Add DNS validation function to config-lib.sh:

1. Implement `validate_dns_before_deploy()`:
   - Requires DOMAIN to be set (return 1 if empty)
   - Call validate_dns() from preflight-lib.sh
   - If DNS validation fails:
     - The validate_dns function already provides detailed guidance
     - Return 1 to signal deployment should not proceed
   - If DNS validation succeeds:
     - Display success message
     - Return 0

2. Implement `run_interactive_configuration()` master orchestration function:
   - Print header: "FreshTrack Pro Interactive Configuration"
   - Call collect_configuration() (prompts for domain, email, Stack Auth)
     - Return 1 on failure
   - Call create_configuration() (generates secrets, writes .env.production)
     - Return 1 on failure
   - Call display_configuration_summary()
     - Return 1 if user cancels
   - Call validate_dns_before_deploy()
     - Return 1 if DNS validation fails
   - Display final success message: "Configuration complete! Ready for deployment."
   - Return 0

3. Add entry point for standalone execution:
   - When script is run directly (not sourced), offer to run self-test or interactive mode
   - `./config-lib.sh test` runs self-tests
   - `./config-lib.sh` without args shows usage or runs interactive config

4. Add self-test to verify:
   - validate_dns_before_deploy function exists
   - run_interactive_configuration function exists
  </action>
  <verify>
Run: `bash scripts/lib/config-lib.sh test`
Expect: All self-tests pass
  </verify>
  <done>
- validate_dns_before_deploy calls preflight-lib.sh validate_dns
- DNS validation provides actionable guidance on failure
- run_interactive_configuration orchestrates entire flow
- Script can be run standalone for testing
- CONFIG-04 (DNS validation) satisfied
  </done>
</task>

<task type="auto">
  <name>Task 3: Final integration and documentation</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Finalize config-lib.sh with documentation and integration:

1. Update file header documentation:
   - List all exported functions with one-line descriptions
   - Document required environment variables
   - Document sourcing pattern

2. Add function documentation comments:
   - Each function should have a comment block with:
     - Brief description
     - Args (if any)
     - Returns
     - Sets (global variables modified)

3. Ensure consistent error handling:
   - All functions that can fail return 1 on failure
   - Error messages use error() helper from preflight-lib.sh
   - Success messages use success() helper

4. Add comprehensive self-test section that tests:
   - All validation functions with positive and negative cases
   - Secret generation length and character set
   - File permissions on generated files
   - Function existence for all exported functions

5. Make script executable: chmod +x (if not already)
  </action>
  <verify>
Run: `bash scripts/lib/config-lib.sh test`
Expect: All tests pass with clear PASS/FAIL output

Verify documentation: `head -50 scripts/lib/config-lib.sh`
Expect: Clear usage documentation in header
  </verify>
  <done>
- All functions documented with purpose, args, returns
- Self-test covers all exported functionality
- Script header documents usage and function list
- Error handling is consistent throughout
- Script is executable
  </done>
</task>

</tasks>

<verification>
Run full self-test: `bash scripts/lib/config-lib.sh test`

Manual verification of summary display:
```bash
source scripts/lib/config-lib.sh
export DOMAIN="test.example.com"
export ADMIN_EMAIL="admin@test.com"
export STACK_AUTH_PROJECT_ID="proj_abc123xyz"
export STACK_AUTH_PUBLISHABLE_KEY="pk_live_abcdefghijklmnop"
export STACK_AUTH_SECRET_KEY="sk_live_secretkey123"
display_configuration_summary
# Verify: Shows all values, secrets are masked, prompts for confirmation
```

Verify function exports:
```bash
source scripts/lib/config-lib.sh
for func in validate_fqdn validate_email prompt_domain prompt_email prompt_stack_auth \
            generate_secret generate_secrets_files generate_env_file \
            display_configuration_summary validate_dns_before_deploy \
            collect_configuration create_configuration run_interactive_configuration; do
  type -t "$func" &>/dev/null && echo "OK: $func" || echo "MISSING: $func"
done
```
</verification>

<success_criteria>
- display_configuration_summary shows complete config with masked secrets
- User can confirm or cancel after reviewing summary
- validate_dns_before_deploy checks DNS resolution using preflight-lib.sh
- DNS failures provide clear guidance for configuring A records
- run_interactive_configuration orchestrates complete flow
- All functions are documented in file header
- Self-test passes with all functions verified
- CONFIG-04 (DNS validation) satisfied
- CONFIG-07 (configuration summary) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/24-interactive-configuration/24-03-SUMMARY.md`
</output>
