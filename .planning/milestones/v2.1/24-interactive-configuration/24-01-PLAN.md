---
phase: 24-interactive-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/config-lib.sh
autonomous: true

must_haves:
  truths:
    - 'Script prompts for domain and validates FQDN format'
    - 'Script prompts for admin email and validates format'
    - 'Invalid inputs are rejected with clear error messages'
    - 'User has limited retry attempts (prevents infinite loops)'
  artifacts:
    - path: 'scripts/lib/config-lib.sh'
      provides: 'Input validation and prompt functions'
      exports: ['validate_fqdn', 'validate_email', 'prompt_domain', 'prompt_email']
      min_lines: 100
  key_links:
    - from: 'scripts/lib/config-lib.sh'
      to: 'scripts/lib/preflight-lib.sh'
      via: 'source'
      pattern: 'source.*preflight-lib.sh'
---

<objective>
Create the input collection and validation functions for interactive deployment configuration.

Purpose: Enable users to configure their FreshTrack deployment through guided prompts with proper validation, satisfying CONFIG-01 (domain prompt) and CONFIG-02 (admin email prompt).

Output: `scripts/lib/config-lib.sh` with FQDN and email validation functions plus interactive prompts.
</objective>

<execution_context>
@/home/skynet/.claude/get-shit-done/workflows/execute-plan.md
@/home/skynet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-interactive-configuration/24-RESEARCH.md
@scripts/lib/preflight-lib.sh
@scripts/lib/prereq-lib.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config-lib.sh with validation functions</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Create `scripts/lib/config-lib.sh` following the pattern from prereq-lib.sh:

1. Add standard header with usage documentation
2. Source preflight-lib.sh for error handling and output helpers
3. Set LIB_VERSION="1.0.0"

4. Implement `validate_fqdn()`:
   - Empty check returns 1
   - Must contain at least one dot
   - Max length 253 chars
   - Use regex: `^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$`
   - Return 0 if valid, 1 if invalid

5. Implement `validate_email()`:
   - Empty check returns 1
   - Use regex: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`
   - Return 0 if valid, 1 if invalid

6. Add configurable MAX_INPUT_ATTEMPTS (default: 5)

7. Implement `prompt_domain()`:
   - Display explanation of what domain is used for (main app, monitoring, status)
   - Use `read -rp` for input
   - Call validate_fqdn in loop
   - Show specific error message on failure explaining FQDN requirements
   - Show attempt count on retry
   - Return 1 after max attempts exceeded
   - Set global DOMAIN variable on success

8. Implement `prompt_email()`:
   - Display explanation (SSL certs, alerts)
   - Use `read -rp` for input
   - Call validate_email in loop
   - Show specific error on failure
   - Set global ADMIN_EMAIL variable on success

9. Add self-test section (when run directly) testing:
   - validate_fqdn with valid domains (app.example.com, sub.domain.co.uk)
   - validate_fqdn with invalid domains (localhost, no-dot, .leading-dot)
   - validate_email with valid emails (test@example.com)
   - validate_email with invalid emails (notanemail, missing@tld)
     </action>
     <verify>
     Run: `bash scripts/lib/config-lib.sh`
     Expect: All self-tests pass with "PASS" messages, exits 0
     </verify>
     <done>

- validate_fqdn rejects "localhost", accepts "app.example.com"
- validate_email rejects "notanemail", accepts "admin@example.com"
- Self-test passes when run directly
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add Stack Auth credential prompts</name>
  <files>scripts/lib/config-lib.sh</files>
  <action>
Add Stack Auth credential collection to config-lib.sh:

1. Implement `prompt_stack_auth()`:
   - Display explanation of Stack Auth and link to https://app.stack-auth.com/projects
   - Prompt for Project ID with `read -rp`
   - Validate Project ID is non-empty
   - Prompt for Publishable Key with `read -rp`
   - Validate Publishable Key is non-empty
   - Prompt for Secret Key with `read -rsp` (hidden input)
   - Print newline after hidden input
   - Validate Secret Key is non-empty
   - Set global variables: STACK_AUTH_PROJECT_ID, STACK_AUTH_PUBLISHABLE_KEY, STACK_AUTH_SECRET_KEY
   - Return 1 if any required field is empty

2. Add master `collect_configuration()` function that:
   - Calls prompt_domain (return 1 on failure)
   - Calls prompt_email (return 1 on failure)
   - Calls prompt_stack_auth (return 1 on failure)
   - Returns 0 when all inputs collected successfully

3. Extend self-test to verify:
   - prompt_stack_auth function exists
   - collect_configuration function exists
     </action>
     <verify>
     Run: `bash scripts/lib/config-lib.sh`
     Expect: All self-tests pass including new function existence checks
     </verify>
     <done>

- prompt_stack_auth uses hidden input for Secret Key
- collect_configuration orchestrates all prompts in order
- Self-test verifies all functions exist
  </done>
  </task>

</tasks>

<verification>
Run self-test: `bash scripts/lib/config-lib.sh`

Manual validation test (interactive):

```bash
source scripts/lib/config-lib.sh
validate_fqdn "app.example.com" && echo "PASS: valid FQDN"
validate_fqdn "localhost" || echo "PASS: invalid FQDN rejected"
validate_email "admin@example.com" && echo "PASS: valid email"
validate_email "not-an-email" || echo "PASS: invalid email rejected"
```

</verification>

<success_criteria>

- scripts/lib/config-lib.sh exists and is executable
- validate_fqdn correctly validates RFC 1123 FQDNs
- validate_email correctly validates email format
- prompt_domain collects and validates domain input
- prompt_email collects and validates email input
- prompt_stack_auth collects Stack Auth credentials with hidden secret
- Self-tests pass when script is run directly
- CONFIG-01 (domain prompt) satisfied
- CONFIG-02 (email prompt) satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/24-interactive-configuration/24-01-SUMMARY.md`
</output>
