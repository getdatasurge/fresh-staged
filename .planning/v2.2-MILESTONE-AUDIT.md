---
milestone: v2.2
audited: 2026-01-28T20:15:00Z
status: gaps_found
scores:
  requirements: N/A (no v2.2 requirements in REQUIREMENTS.md)
  phases: 2/3 passed
  integration: 4/6 connections working
  flows: 2/3 E2E flows complete
gaps:
  requirements: []
  integration:
    - "TTN provisioning UI not wired to Phase 27 tRPC endpoints"
    - "SupabaseMigrationError class created but no UI consumers"
  flows:
    - "TTN Organization Provisioning: breaks at TTNCredentialsPanel.tsx calling non-existent edge functions"
tech_debt:
  - phase: 28-supabase-removal
    items:
      - "25 supabase.functions.invoke calls remain in 9 files"
      - "39 files import supabase-placeholder but none handle SupabaseMigrationError"
      - "TTNCredentialsPanel.tsx has 6 edge function calls not migrated to tRPC"
      - "EmulatorTTNRoutingCard.tsx has 2 edge function calls"
      - "SensorManager.tsx has 1 edge function call"
      - "useTTNSetupWizard.ts references deleted edge functions"
      - "Hook documentation says BLOCKED but code uses working tRPC (useTTNApiKey.ts)"
  - phase: 30-system-hardening
    items:
      - "15 pre-existing test failures in ttn-devices.test.ts (not Phase 30 related)"
---

# Milestone v2.2: Technical Debt & Stabilization - Audit Report

**Audited:** 2026-01-28T20:15:00Z
**Status:** GAPS_FOUND
**Milestone Goal:** Eliminate Supabase dependency and stabilize TTN integration for long-term maintainability

## Executive Summary

Milestone v2.2 is **partially complete** with critical gaps in Phase 28 (Supabase Removal). While Phase 27 (TTN SDK) and Phase 30 (System Hardening) are fully integrated and verified, Phase 28's incomplete migration leaves 25 edge function references that break user flows.

## Phase Status

| Phase | Name | Status | Score |
|-------|------|--------|-------|
| 27 | TTN SDK Integration | ✓ PASSED | 5/5 truths verified |
| 28 | Supabase Removal | ✗ GAPS_FOUND | 1/4 truths verified |
| 29 | Production Data Migration | ⊘ SKIPPED | N/A (no Supabase access) |
| 30 | System Hardening | ✓ PASSED | 13/13 truths verified |

## Integration Analysis

### Connected (Working)

1. **TTN Settings Read/Write** - Frontend hooks → tRPC → Backend services ✓
2. **Dashboard Data Loading** - Dashboard.tsx → tRPC → Units/Orgs routers ✓
3. **Security Headers** - Fastify → Helmet → All HTTP responses ✓
4. **Sensor → Alert Pipeline** - TTN webhook → Readings → Alert evaluation ✓

### Missing Connections (Broken)

1. **TTN Provisioning UI → Phase 27 Backend**
   - TTNCredentialsPanel.tsx still calls `supabase.functions.invoke("ttn-provision-org")`
   - Should call `trpc.ttnSettings.saveAndConfigure.mutate()`
   - Backend endpoint EXISTS but frontend not wired to it

2. **Error Handling UI → SupabaseMigrationError**
   - Phase 30 created `SupabaseMigrationError` class and `isSupabaseMigrationError` helper
   - No UI components use these to show user-friendly messages
   - Users see generic errors instead of migration-specific guidance

## E2E Flow Verification

| Flow | Status | Breaking Point |
|------|--------|----------------|
| Sensor → Storage → Alert | ✓ COMPLETE | N/A |
| Dashboard Data Loading | ✓ COMPLETE | N/A |
| TTN Organization Provisioning | ✗ BROKEN | TTNCredentialsPanel.tsx line 238 |

### TTN Provisioning Flow Detail

```
User → TTNCredentialsPanel
     → supabase.functions.invoke("ttn-provision-org")  ← BREAKS HERE
     → (edge function doesn't exist)
     → SupabaseMigrationError returned
     → (no UI handler for error)
     → Generic error shown to user
```

**Should be:**
```
User → TTNCredentialsPanel
     → trpc.ttnSettings.saveAndConfigure.mutate()
     → ttnSettingsRouter.saveAndConfigure procedure
     → TtnProvisioningService.provisionOrganization()
     → Success/Error response
```

## Gap Details

### Phase 28: Supabase Removal Gaps

**VERIFICATION.md Status:** gaps_found (1/4 truths verified)

| Truth | Status | Issue |
|-------|--------|-------|
| Frontend pages fetch via tRPC (no Supabase) | ✗ FAILED | Multiple pages still use supabase.from(...) |
| Edge function calls removed | ✗ FAILED | 25 references remain in 9 files |
| No supabase-placeholder imports remain | ✗ FAILED | 39 files import placeholder |
| Supabase package removed from dependencies | ✓ VERIFIED | No @supabase/supabase-js in package.json |

**Files with Edge Function Calls:**
- `src/components/settings/TTNCredentialsPanel.tsx` (6 calls)
- `src/components/admin/EmulatorTTNRoutingCard.tsx` (2 calls)
- `src/components/settings/SensorManager.tsx` (1 call)
- `src/hooks/useTTNSetupWizard.ts` (multiple references)
- `src/pages/Onboarding.tsx` (references wizard)
- 4 other files

## Tech Debt Summary

### Critical (Blocks User Flows)

| Item | Phase | Impact |
|------|-------|--------|
| TTNCredentialsPanel edge function calls | 28 | Cannot provision TTN organizations |
| SensorManager edge function calls | 28 | Cannot provision sensors |
| useTTNSetupWizard edge function refs | 28 | Onboarding wizard broken |

### Important (Affects UX)

| Item | Phase | Impact |
|------|-------|--------|
| No SupabaseMigrationError handling | 28/30 | Users see generic errors |
| Outdated hook documentation | 28 | Developer confusion |

### Minor

| Item | Phase | Impact |
|------|-------|--------|
| EdgeFunctionDiagnostics component | 28 | Dead code |
| 15 pre-existing test failures | 30 | Test suite incomplete |

## Requirements Coverage

No v2.2 requirements were mapped in REQUIREMENTS.md. Milestone goal was defined in ROADMAP.md:
> Eliminate Supabase dependency and stabilize TTN integration for long-term maintainability

**Assessment:**
- ✗ Supabase dependency NOT fully eliminated (edge function calls remain)
- ✓ TTN integration stabilized (Phase 27 backend working)
- ⚡ Partial success - infrastructure built but not fully connected

## Recommendations

### To Close Gaps (Complete v2.2)

1. **Migrate TTNCredentialsPanel.tsx** - Replace 6 edge function calls with tRPC
2. **Migrate remaining 8 files** - Replace all supabase.functions.invoke calls
3. **Add error handling** - Use isSupabaseMigrationError in UI components
4. **Update documentation** - Fix hook comments that say BLOCKED

**Estimated effort:** 6-10 hours of migration work

### To Accept Tech Debt (Proceed Anyway)

If completing milestone with known gaps:
- Document that TTN provisioning UI is temporarily unavailable
- Track remaining edge function migration as v2.3 work
- Accept that some user flows will show generic errors

## Verdict

**GAPS_FOUND** - Milestone v2.2 cannot be marked complete as-is.

The backend infrastructure (Phase 27 TTN services, Phase 30 hardening) is solid, but Phase 28's incomplete frontend migration means the milestone goal of "eliminate Supabase dependency" is not achieved. 25 edge function references remain that break user flows.

---

*Audit completed: 2026-01-28T20:15:00Z*
*Auditor: Claude (gsd-integration-checker + orchestrator)*
