# FreshTrack Pro Self-Hosted Deployment Overlay
# Usage: docker compose -f docker-compose.yml -f compose.prod.yaml -f compose.selfhosted.yaml up -d
#
# Self-hosted specific settings:
# - Localhost-only bindings for internal services
# - Secrets from Infisical file mounts
# - All services run locally (no managed services)

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    ports:
      - '127.0.0.1:5432:5432'
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password

  # ===========================================
  # PgBouncer Connection Pooler
  # ===========================================
  pgbouncer:
    ports:
      - '127.0.0.1:6432:6432'
    environment:
      POSTGRESQL_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password

  # ===========================================
  # Redis (Cache, Jobs, PubSub)
  # ===========================================
  redis:
    ports:
      - '127.0.0.1:6379:6379'

  # ===========================================
  # MinIO (S3-Compatible Object Storage)
  # ===========================================
  minio:
    ports:
      - '127.0.0.1:9000:9000' # S3 API
      - '127.0.0.1:9001:9001' # MinIO Console

  # ===========================================
  # Caddy (Reverse Proxy)
  # ===========================================
  # Only Caddy should be externally accessible.
  # All other services are bound to localhost above.
  # Caddy base definition is in compose.prod.yaml.
  caddy:
    ports:
      - '0.0.0.0:80:80'
      - '0.0.0.0:443:443'

  # ===========================================
  # Backend API
  # ===========================================
  # Uncomment when backend service is defined in base compose:
  # backend:
  #   environment:
  #     DATABASE_URL_FILE: /run/secrets/database_url
  #     STACK_AUTH_SECRET_KEY_FILE: /run/secrets/stack_auth_secret
  #   secrets:
  #     - database_url
  #     - stack_auth_secret

# ===========================================
# Secrets Configuration
# ===========================================
# Secrets are provided by Infisical Agent which exports them to /var/infisical/secrets/
# See Phase 11 deployment documentation for Infisical setup
secrets:
  postgres_password:
    file: /var/infisical/secrets/postgres_password
  database_url:
    file: /var/infisical/secrets/database_url
  stack_auth_secret:
    file: /var/infisical/secrets/stack_auth_secret

# Volumes are defined in compose.prod.yaml (caddy_data, caddy_config, caddy_logs)
