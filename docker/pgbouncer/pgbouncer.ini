;; FreshTrack Pro PgBouncer Configuration
;; This configuration enables transaction-mode pooling with ORM compatibility

[databases]
;; Database connection format: dbname = host=hostname port=port dbname=database
frostguard = host=postgres port=5432 dbname=frostguard

;; PgBouncer administrative database
pgbouncer = host=pgbouncer port=6432 dbname=pgbouncer

[pgbouncer]

;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Connection settings
;;;

;; Listen on all interfaces for Docker networking
listen_addr = 0.0.0.0
listen_port = 6432

;; Authentication
auth_type = md5
auth_file = /bitnami/pgbouncer/conf/userlist.txt

;; Admin access for metrics exporter
admin_users = pgbouncer_exporter
stats_users = pgbouncer_exporter

;;;
;;; Pooling mode and size
;;;

;; Transaction mode: each transaction gets a connection from pool
;; Compatible with ORMs and prepared statements
pool_mode = transaction

;; Connection pool sizing
default_pool_size = 20
min_pool_size = 10
reserve_pool_size = 5

;; Client connection limits
max_client_conn = 100
max_db_connections = 20

;;;
;;; Connection lifetime
;;;

;; Server connection lifetime (1 hour)
server_lifetime = 3600

;; Server idle timeout (10 minutes)
server_idle_timeout = 600

;;;
;;; ORM Compatibility
;;;

;; Allow prepared statements (required for Drizzle ORM)
max_prepared_statements = 200

;; Ignore parameters that pgbouncer_exporter may set
ignore_startup_parameters = extra_float_digits

;;;
;;; Logging
;;;

;; Log connection events for debugging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; Verbose logging for troubleshooting (disable in production if needed)
verbose = 0

;;;
;;; Timeouts
;;;

;; Query timeout (30 seconds)
query_timeout = 30

;; Query wait timeout (120 seconds)
query_wait_timeout = 120

;; Client idle timeout (0 = disabled)
client_idle_timeout = 0

;; DNS lookup timeout
dns_max_ttl = 15
dns_nxdomain_ttl = 15
