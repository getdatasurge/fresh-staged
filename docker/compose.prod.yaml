# FreshTrack Pro Production Configuration Overlay
# Usage: docker compose -f docker-compose.yml -f compose.prod.yaml up -d
#
# This overlay adds:
# - Resource limits (memory, CPU) for all services
# - Restart policies for auto-recovery
# - Loki logging driver for centralized logs
# - Production-specific settings
#
# Combine with deployment-specific overlay:
# docker compose -f docker-compose.yml -f compose.prod.yaml -f compose.selfhosted.yaml up -d

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2048M
        reservations:
          cpus: '1.0'
          memory: 1024M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # PgBouncer Connection Pooler
  # ===========================================
  pgbouncer:
    volumes:
      - ./pgbouncer/pgbouncer.ini:/bitnami/pgbouncer/conf/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/bitnami/pgbouncer/conf/userlist.txt:ro
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # PgBouncer Metrics Exporter
  # ===========================================
  pgbouncer_exporter:
    image: prometheuscommunity/pgbouncer-exporter:latest
    container_name: freshtrack-pgbouncer-exporter
    environment:
      PGBOUNCER_EXPORTER_CONNECTION_STRING: 'postgres://pgbouncer_exporter:exporter_password@pgbouncer:6432/pgbouncer?sslmode=disable'
    ports:
      - '9127:9127'
    depends_on:
      pgbouncer:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:9127/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # Redis (Cache, Jobs, PubSub)
  # ===========================================
  redis:
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # MinIO (S3-Compatible Object Storage)
  # ===========================================
  minio:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2048M
        reservations:
          cpus: '0.5'
          memory: 1024M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # Prometheus (Metrics Collection)
  # ===========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: freshtrack-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts:/etc/prometheus/alerts:ro
    ports:
      - '9090:9090'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:9090/-/healthy']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # Grafana (Observability Dashboard)
  # ===========================================
  grafana:
    image: grafana/grafana:latest
    container_name: freshtrack-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3000}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - '3000:3000'
    depends_on:
      - prometheus
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # Loki (Log Aggregation)
  # ===========================================
  loki:
    image: grafana/loki:latest
    container_name: freshtrack-loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
    ports:
      - '3100:3100'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:3100/ready']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

  # ===========================================
  # Promtail (Log Collector - Optional)
  # ===========================================
  promtail:
    image: grafana/promtail:latest
    container_name: freshtrack-promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail/promtail-config.yaml:/etc/promtail/config.yml:ro
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

  # ===========================================
  # Blackbox Exporter (SSL/HTTP Probing)
  # ===========================================
  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: freshtrack-blackbox
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    ports:
      - '9115:9115'
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:9115/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # Caddy (Reverse Proxy / TLS Termination)
  # ===========================================
  # Terminates TLS and proxies to backend + frontend services.
  # Uses the Caddyfile at ./caddy/Caddyfile for routing rules.
  #
  # For IP-based deployments (no domain), generate self-signed certs:
  #   ./caddy/generate-self-signed-certs.sh
  #
  # For domain-based deployments with wildcard certs:
  #   cp ./caddy/Caddyfile.wildcard.example ./caddy/Caddyfile
  #   Set DOMAIN, ADMIN_EMAIL, and DNS provider env vars
  caddy:
    image: caddy:2-alpine
    container_name: freshtrack-caddy
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/certs:/etc/caddy/certs:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    environment:
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@freshtrackpro.com}
      DEFAULT_SNI: ${DEFAULT_SNI:-localhost}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:2019/config/']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'

  # ===========================================
  # PostgreSQL Backup Service
  # ===========================================
  postgres_backup:
    image: postgres:15-alpine
    container_name: freshtrack-postgres-backup
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: '5432'
      POSTGRES_DB: ${POSTGRES_DB:-freshtrack}
      POSTGRES_USER: ${POSTGRES_USER:-freshtrack_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: postgres-backups
      RETENTION_DAYS: '30'
      WEBHOOK_URL: ${BACKUP_WEBHOOK_URL:-}
    volumes:
      - ./scripts/backup-postgres.sh:/usr/local/bin/backup-postgres.sh:ro
      - backup_logs:/var/log
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: loki
      options:
        loki-url: 'http://loki:3100/loki/api/v1/push'
        loki-batch-size: '400'
        loki-retries: '3'
        loki-external-labels: 'service={{.Name}},environment=production'
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Install MinIO client and curl
        apk add --no-cache curl jq
        wget -q https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc
        chmod +x /usr/local/bin/mc

        # Create cron job for daily backup at 2 AM UTC
        echo "0 2 * * * /usr/local/bin/backup-postgres.sh >> /var/log/backup.log 2>&1" > /etc/crontabs/root

        # Run backup immediately on startup (for testing)
        /usr/local/bin/backup-postgres.sh

        # Start cron daemon (foreground mode to keep container running)
        echo "Starting cron daemon for scheduled backups at 2 AM UTC..."
        crond -f -l 2

volumes:
  caddy_data:
    name: freshtrack_caddy_data
  caddy_config:
    name: freshtrack_caddy_config
  caddy_logs:
    name: freshtrack_caddy_logs
  prometheus_data:
    name: freshtrack_prometheus_data
  grafana_data:
    name: freshtrack_grafana_data
  loki_data:
    name: freshtrack_loki_data
  backup_logs:
    name: freshtrack_backup_logs
