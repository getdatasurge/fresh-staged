{{!--
  FrostGuard (FreshTrack Pro) Custom Prompt Template
  ==================================================

  This template is designed for:
  - Comprehensive code review tasks
  - Deployment preparation for self-hosted VMs / DigitalOcean VPS
  - Cross-iteration progress tracking with learnings preservation

  Variables used:
  - taskId, taskTitle, taskDescription, acceptanceCriteria
  - recentProgress, codebasePatterns (cross-iteration context)
  - prdName, prdContent, prdCompletedCount, prdTotalCount (PRD context)
  - currentDate, currentTimestamp
--}}

# FrostGuard Project Task: {{taskTitle}}

**Task ID:** {{taskId}}
**Date:** {{currentDate}}
**PRD Progress:** {{prdCompletedCount}}/{{prdTotalCount}} tasks complete

---

## Project Context

You are working on **FrostGuard** (also known as FreshTrack Pro), a refrigeration monitoring and food safety compliance platform. This is a production-ready application with:

### Technology Stack
- **Frontend:** React 18 + TypeScript + Vite + TanStack Query + Tailwind CSS + shadcn/ui
- **Backend:** Fastify + TypeScript + Drizzle ORM + BullMQ
- **Database:** PostgreSQL 15 + Redis 7
- **Storage:** MinIO (S3-compatible)
- **Auth:** Stack Auth
- **IoT:** The Things Network (TTN) LoRaWAN integration
- **Infrastructure:** Docker Compose + Caddy (auto HTTPS) + Prometheus + Grafana + Loki

### Project Structure
```
/home/user/fresh-staged/
├── src/                    # React Frontend
├── backend/                # Fastify Backend API
├── docker/                 # Docker service configs (caddy, prometheus, grafana, loki)
├── docs/                   # Documentation (deployment guides, architecture)
├── scripts/                # Build and deployment scripts
├── docker-compose.yml      # Local development stack
├── compose.production.yaml # Production overrides
└── .env.production.example # Production environment template
```

---

{{#if codebasePatterns}}
## Codebase Patterns & Learnings (STUDY FIRST)

These patterns were discovered during previous iterations. Follow them to maintain consistency:

{{codebasePatterns}}

---
{{/if}}

{{#if recentProgress}}
## Recent Progress (Cross-Iteration Context)

The following work was completed in previous iterations. Build upon this progress:

{{recentProgress}}

---
{{/if}}

## Current Task

### Description
{{taskDescription}}

### Acceptance Criteria
{{acceptanceCriteria}}

{{#if dependsOn}}
### Dependencies
This task depends on: {{dependsOn}}
Ensure these are completed before proceeding.
{{/if}}

{{#if notes}}
### Additional Notes
{{notes}}
{{/if}}

---

## Code Review Guidelines

When performing code review tasks, follow these comprehensive guidelines:

### 1. Security Review
- [ ] Check for OWASP Top 10 vulnerabilities (XSS, SQL injection, CSRF, etc.)
- [ ] Verify authentication/authorization patterns are correct
- [ ] Ensure secrets are not hardcoded (use `.env` files or Docker secrets)
- [ ] Review CORS configuration in `backend/src/middleware/`
- [ ] Check rate limiting implementation
- [ ] Verify input validation using Zod schemas in `backend/src/schemas/`

### 2. Code Quality Review
- [ ] Run `npm run lint` in both root and `backend/` directories
- [ ] Run `npm run typecheck` for TypeScript validation
- [ ] Check for unused imports and dead code
- [ ] Verify consistent coding patterns with existing codebase
- [ ] Review error handling patterns (use custom error classes)
- [ ] Check for proper async/await usage (no unhandled promises)

### 3. Testing Review
- [ ] Run `npm run test` in root (frontend) and `backend/` directories
- [ ] Verify test coverage for new features
- [ ] Check for meaningful test assertions (not just snapshots)
- [ ] Review mock implementations for external services

### 4. Database Review
- [ ] Review Drizzle schema changes in `backend/drizzle/`
- [ ] Check for proper indexes on frequently queried columns
- [ ] Verify foreign key relationships
- [ ] Review migration files for reversibility

### 5. API Review
- [ ] Check route definitions in `backend/src/routes/`
- [ ] Verify request/response schemas match frontend expectations
- [ ] Review pagination implementation for list endpoints
- [ ] Check WebSocket handlers in `backend/src/plugins/`

### 6. Frontend Review
- [ ] Verify React hooks follow rules of hooks
- [ ] Check for proper loading/error states in components
- [ ] Review accessibility (aria labels, keyboard navigation)
- [ ] Verify responsive design for mobile viewports

---

## Deployment Strategy: Self-Hosted VM / DigitalOcean VPS

When preparing for deployment, ensure all these requirements are met:

### Pre-Deployment Checklist

#### Server Requirements
- **Minimum Specs:** 4 vCPU, 8GB RAM, 100GB SSD
- **OS:** Ubuntu 22.04 LTS recommended
- **Ports:** 22 (SSH), 80 (HTTP), 443 (HTTPS)
- **DigitalOcean:** Droplet s-4vcpu-8gb (~$48/month)

#### Environment Configuration
1. **Copy and configure environment files:**
   ```bash
   cp .env.production.example .env.production
   ```

2. **Generate secrets in `/opt/freshtrack-pro/secrets/`:**
   ```bash
   openssl rand -base64 32 > secrets/postgres_password.txt
   openssl rand -base64 32 > secrets/jwt_secret.txt
   openssl rand -base64 32 > secrets/minio_password.txt
   ```

3. **Configure Caddy for your domain in `docker/caddy/Caddyfile`**

4. **Update DNS records:**
   - A record: `app.yourdomain.com` → Server IP
   - A record: `api.yourdomain.com` → Server IP (or use wildcard)

#### External Services Setup
- [ ] **Stack Auth:** Project ID, Publishable Key, Secret Key
- [ ] **Telnyx (optional):** API Key, Messaging Profile ID, Phone Number
- [ ] **TTN (optional):** Application ID, API Key, Webhook URL

### Deployment Commands

```bash
# SSH to server
ssh freshtrack@your-server-ip

# Clone repository
git clone https://github.com/your-org/freshtrack-pro.git /opt/freshtrack-pro
cd /opt/freshtrack-pro

# Build and start services
docker compose -f docker-compose.yml -f compose.production.yaml up -d --build

# Run database migrations
docker compose exec backend npm run db:migrate

# Verify services
docker compose ps
curl -f http://localhost:3000/health
```

### Post-Deployment Verification

1. **Health Checks:**
   - Frontend loads at `https://app.yourdomain.com`
   - API responds at `https://api.yourdomain.com/health`
   - WebSocket connects successfully

2. **Monitoring Setup:**
   - Grafana dashboards at `https://monitoring.yourdomain.com`
   - Uptime Kuma status at `https://status.yourdomain.com`
   - Log aggregation in Loki

3. **Security Verification:**
   - HTTPS certificates issued (Caddy auto-renews)
   - Firewall rules active (UFW)
   - Fail2Ban protecting SSH

---

## Available Skills

When working on tasks, utilize these bundled skills as appropriate:

- `/ralph-tui-prd` - Create or update Product Requirements Documents
- `/ralph-tui-create-json` - Generate structured JSON task files
- `/ralph-tui-create-beads` - Create beads tracker entries

### Project-Specific Commands

```bash
# Frontend
npm run dev          # Start frontend dev server
npm run build        # Production build
npm run test         # Run frontend tests
npm run lint         # Lint frontend code
npm run typecheck    # TypeScript validation

# Backend (run from /backend directory)
npm run dev          # Start backend dev server
npm run build        # Compile TypeScript
npm run test         # Run backend tests
npm run db:migrate   # Run database migrations
npm run db:studio    # Open Drizzle Studio

# Docker (full stack)
docker compose up -d                                        # Start all services
docker compose --profile admin up -d                        # Include admin tools
docker compose -f docker-compose.yml -f compose.production.yaml up -d  # Production
```

---

## Quality Gates

Before marking this task as complete, ensure:

1. **All tests pass:** `npm run test` (frontend and backend)
2. **No lint errors:** `npm run lint` (frontend and backend)
3. **Type check passes:** `npm run typecheck`
4. **Documentation updated** if API or configuration changed
5. **No console errors** in browser dev tools
6. **Deployment readiness** verified if deployment-related task

---

## Progress Tracking Instructions

**IMPORTANT:** After completing work on this task, update the cross-iteration progress:

1. Document key findings, patterns discovered, or blockers encountered
2. Note any architectural decisions made
3. Record configuration changes for deployment reference
4. List files modified for future context

This information will be preserved in `.ralph-tui/progress.md` for the next iteration.

---

## Task Completion

When all acceptance criteria are met and quality gates pass, signal completion:

<promise>COMPLETE</promise>
